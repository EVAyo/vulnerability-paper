<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/2PBgJzKRt4DaL2uAQX50GA)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
==============

在日常的渗透测试、红队项目、攻防比赛中，sql 注入仍是广泛存在的一种漏洞，只要花时间仔细找，注入漏洞总会有的。**sqlmap 是目前最常用的注入工具，但是 sqlmap 也不是万能的，也有不足之处**。

**1.**  对于 SQL Server 注入，sqlmap 没法自动枚举网站目录，读取文件和执行命令功能方法单一，不够完善，不能通过 **opendatasource** 和 **openrowset** 函数快速出数据等。

**2.**  对于 Oracle 注入，提权功能与执行命令功能都有欠缺；对于 Access 注入，不支持爆路径及特殊情况下的命令执行。

但是相反有很多古老的注入工具，整体功能虽然不如 sqlmap 强大，但是却很好的实现了上述功能，**但是毕竟是古老工具了，由于各种原因，不适合当前的网站环境了，必须加以改造**，有什么方法实现对这些注入工具的改造呢，接下来听我慢慢讲。

 **Part2 古老的注入工具介绍** 
---------------------

为了照顾一些新手，先介绍几款上古时代强大的注入工具，那时候的很多工具还是比较经典的。

*   **Data Thief 注入工具**
    

Data Thief V1.0 这款国外的注入工具距今 19 年了。专门针对 SQLServer 注入漏洞，通过 **opendatasource** 或者 **openrowset** 函数来实现快速出数据。需要事先在外网准备一个 sqlserver 数据库，配置之后可以实现对于一些盲注点快速获取结果。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xAVWSke9pYG5qvicrejqqibXu5micN35qTgw6USOib0ps6xWWSDAia0NyrOQ/640?wx_fmt=png)

*   **CADT v1.0 注入工具**
    

这款工具是黑哥和 xiaolu 写的，18 年前的工具了，功能与 Data Thief 差不多，可以实现执行命令、列目录等功能。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xoxY6g0Bec2oaNS8UGWBFH7oI9fo0bt7PeT9VPbhlTRkOkkIGGR1S8A/640?wx_fmt=png)

*   **管中窥豹 Liqidis 注入工具**
    

这款商业版的注入工具距今有 10 几年了吧，细化了很多注入漏洞利用功能，对于 SQLServer 可以实现执行命令、列目录、上传二进制文件等等。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xiaWmG2ZYPANXaNnL4p2smN1PkQN4ztQ1gAW4843uQiarHAefeNM6icGlw/640?wx_fmt=png)

*   **Safe3 的注入工具**
    

经常可以应对一些奇葩的注入点，也增加了很多执行目录、列目录等辅助功能。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xiaLVLSupu7icrdnyF5tiaIaYHGa9PLqZzibqhXrDWgII6SEVsJUuLurbzg/640?wx_fmt=png)

*   **古老工具无法使用的原因**
    ---------------
    

遗憾的是，这些 10 几年前的工具放到现在几乎都用不了了，不适用于现在的网站环境了，原因大致有以下几点：

 **1**   在 10 几年前，注入点的利用方式都集中在 GET 型上，对于 Post 型注入和 Cookie 注入支持的都不是太好。

 **2**   对于 Json 数据包中的注入、XML 包的注入等等都不支持，也没法对 Header 头进行设置，比如说设置一个 content-type:application/json 等，导致一些网站不能正常使用。

 **3**   对于一些复杂的数据包，无法像 Sqlmap 那样指定一个 * 星号去使用，极大限制了这些工具的发挥。

 **4**   如果遇到了 waf，这些古老的注入工具没法进行绕 waf 规则替换。

 **Part3 技术研究过程** 
------------------

那有没有一种方法，一劳永逸解决这些问题，让这些古老的工具继续发挥作用呢？

*   **注入中转生成器**
    

为此我踩了很多坑，我想到了一个 15 年前的工具，**“寂寞的刺猬”用 VB 写的 “注入中转生成器” 工具**，这个工具巧妙地把 POST 型注入、Cookie 型注入中转到了 url 上面，变成了 GET 型注入。但是这个工具放到现在，适用范围很窄了，因为它依赖于 asp 代码编写，asp 代码实现一些功能是非常麻烦的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xtXbHvMCJWgiceLicaXNYeYdaViazBIs9Zw59kPtqs1ne2qjhicKGUQwM3Q/640?wx_fmt=png)

点击 “生成 ASP” 后，这个工具会生成一个 asp 文件，大致原理如下：**工具在本地启动了一个 http 服务器**，asp 代码承担了把注入工具的发来的 GET 请求转为网站能用的 POST 型请求或者 Cookie 型请求。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xibyfr72DI34rDictvC5PnLM6Q4IqDA5qKibvDWbKfB6CiaBU1RFvSndbZA/640?wx_fmt=png)

*   **Go 语言的 HandleFunc 函数**
    ------------------------
    

后续经过一系列探索，**发现了 go 语言的这个 HandleFunc 函数比较适合做这个 “注入中转” 功能**。该方法接收两个参数，一个是路由匹配的字符串，另外一个是 **func(ResponseWriter, *Request)** 类型的函数：

如下图所示，这段代码先利用 http.HandleFunc 在根路由 / 上注册了一个 httpFunction, 然后利用 http.ListenAndServe 启动服务器并监听本地的 8888 端口。当有请求过来时，则根据路由执行对应的 handler 函数。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xYujuMicqUG5hvdmXu5Jpn8FRqVQz6sibx3PJPtlQUjvKbCX4MUw1oYng/640?wx_fmt=png)

httpFunction 代码实现如下：**如果有绕 waf 需求，还可以在这里面进行关键字替换**，比如把 = 替换成 like，把空格替换成 TAB 或者 **/***?id=1***/** 等。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xAUAg2Jaqq0nyfUj6ETEGjHGLj2HgZ2jWPPEUP0ug6EwTcoqpPN8wKA/640?wx_fmt=png)

Go 语言的强大，使得实现 “注入中转” 功能非常简单，不用多少行代码就可以搞定。启动程序之后，访问如下 url：**http://127.0.0.1:8888/?sql=1**，发现可以正常返回原有网站页面。证明功能没问题，接下来就可以让那些古老工具成功注入了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xgvFGjydP1E8y0jTppedewpJmibBKMGfUNMqJLpN0zTnmOuolxYQfdiaw/640?wx_fmt=png)

*   **实战测试**
    

来看一下 Safe3 的注入工具，成功以 GET 请求方法对这个 POST 型注入点利用，并且成功枚举当前目录。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xianIPiaH7mKlYrzugl6Im4OhSX8pOyP0R6ic0icJynxg6U8rDRFHyUS29A/640?wx_fmt=png)

再看一下管中窥豹 LiQiDiS 工具，以 GET 请求方法，对 POST 型注入点成功利用，并且可以直接一键列出目录。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xLspoAvRaXEl1ibicRIOv95MLhCtPX6eVEAvAe4EKA3zvdicmaxfzsUryg/640?wx_fmt=png)

执行命令也是没问题的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3xleibuILRTpicfpkWNJHaUPS33JZhfDslx2Ddxy5A0k8jkc4DHXojHuiaw/640?wx_fmt=png)

BSQLHacker 支持深盲注入的工具，也是可以成功的。  

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ApxXZat2H01qhHibMBy7m3x2PdXialOkU37D8NhSX7iaYFO1LLp7SC52OX9cWy5UPyFr0MtlN7JicokA/640?wx_fmt=png)

至此，通过 go 语言的一个函数 HandleFunc 使用，完美解决了这一问题，**这个 HandleFunc 函数还有很多妙用，后续我们再举例分享**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队攻防、蓝队分析、渗透测试、代码审计等

每周一篇，99% 原创，敬请关注