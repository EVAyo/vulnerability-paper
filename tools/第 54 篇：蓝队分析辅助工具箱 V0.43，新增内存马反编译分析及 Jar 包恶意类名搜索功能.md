<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/xEEZJvcthufTPnutj7UABA)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcaA8wBFW4icTiaL7ELd8ia04Olh40TBx7CquHZyCicicl4eYJno2y0oZ0H4A/640?wx_fmt=png)

 **Part1 前言** 
--------------

**大家好，我是 ABC_123**。年前写了这么一款蓝队分析辅助工具箱，看到很多朋友都在使用，于是我也抽出时间把很多功能进行了优化和更新。“蓝队分析辅助工具箱” 就是把我平时写的蓝队小工具集合起来形成的，重点解决蓝队分析工作中的一些痛点问题。

**欢迎关注我的公众号 "ABC123 安全研究实验室"，ABC_123 坚持 99% 原创，不抄袭文章，不发水文，不发广告**。

 **Part2 使用说明及功能介绍** 
---------------------

*   **端口连接添加 ip 归属地址**
    ------------------
    

假设甲方客户的内网主机中了恶意病毒，蓝队人员通常会执行 netstat -an 命令去查看每个端口或者进程连接国外 ip 地址情况。将 **netstat -an** 结果贴到工具中，点击 “**查询 ip 对应物理地址**” 按钮，程序就会在每一行结果后面，添加上每个 ip 地址对应的国家、城市、经纬度、国外大学等物理地址，方便蓝队人员快速定位出存疑的 ip、端口、进程，而且**此功能无需联网使用，断网情况下仍然可以用**。本次更新优化了查询速度，基本上秒出结果。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHY5icy4BWhKB31uAfCDpzIIJbgepUiaCBsF4CaqJY1P0y7EUXibgOXvpV1A/640?wx_fmt=png)

*   **冰蝎及哥斯拉流量解密功能**
    ----------------
    

编写这个功能耗费了我很大的精力，对于冰蝎 webshell，从流量中找到秘钥即可解密。对于哥斯拉 webshell，目前只支持 java 型 webshell 流量解密，其它功能后续再加上。由于哥斯拉低版本的 1.x-2.x 与 3.x-4.x 版本的流量加密过程稍微有点不一样，因此解密功能分开写了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYICy8mPdExWDvHI7OpWpuEoCvxmdmyK1ePez39pgEEYnJwnEslrIe2A/640?wx_fmt=png)

如下图所示，可以清晰看到攻击者具体进行了哪些操作，方便大家在编写蓝队分析报告，**直观地将危害性反馈给甲方客户**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYMHZwS5QibMtbDH9bJ0BFncXrC6mr6ibzCGydtR9TJeW5EyM2bf21vwGw/640?wx_fmt=png)

如下图所示，可以清楚看到，攻击者使用哥斯拉 webshell 获取了服务器的当前环境变量等信息。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYs1wNpYmREJceKvgLPxIbvnkZkMJwsGvl7EnxnicJKpcd3tM5mgJjSZA/640?wx_fmt=png)

*   **新增 5 种 Java 内存马 class 文件反编译功能**
    ---------------------------------
    

通过调用 Intellij Idea、CFR、Procyon、JD-Core、JDK 等 5 种反编译工具接口，分别对 Base64 加密的 class 文件、转成 Byte 数组的 class 文件、BECL 编码的 class 文件、Base64 编码 + Gzip 编码的 class 文件、原版 class 文件反编译成 java 代码，方便蓝队人员分析异常流量中的内存马代码。

当然，**此功能对于红队人员也特别方便**，方便大家编写 tomcat、springboot、weblogic 内存马时进行 class 文件反编译对比分析。

 **1** 如下图示所示，程序对 Base64 加密的内存马 class 文件进行反编译分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYGkJhXODbSel7H2QnbY6HK78KuHNHHicCw4NDEndSF8PeRAfiamlfkn3A/640?wx_fmt=png)

 **2** 如下图示所示，程序对 Byte 数组的内存马 class 文件进行反编译分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYLiaaz02yT0YCaeFKHvgyhazq3K1y4awTDd7mzXiaibYz0XeFoO6lvbkgA/640?wx_fmt=png)

 **3** 如下图示所示，程序对 BECL 编码加密的内存马 class 文件进行分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYhn8hUzwwuJ3PmqOoyhXDoXURE23B6XK0RQHkZUkkp7b7tV1umUAiakw/640?wx_fmt=png)

 **4** 如下图示所示，程序对 Base64+Gzip 压缩的内存马 class 文件进行反编译分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYZEiacrFFMdMyd2jmuneeJC3tyQTAk5DU9x9uyL3obvWHmTp6RAicffAA/640?wx_fmt=png)

 **5** 如下图示所示，程序对 class 文件进行反编译分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHY0NvuwcRiaxO9IjFjIUXIhdO961G4avjQT8vGbNPPEI3f5Hmmg8icy0Iw/640?wx_fmt=png)

*   **Jar 包搜索指定类名**
    ---------------
    

对于蓝队人员，此功能可以在指定的 jar 包目录中筛选出含有恶意类名的 jar 包文件，**现在很多红队人员制作的不死内存马，会将 jar 包中的 class 文件修改掉**，关机重启后内存马仍然可用，那么这个分析功能会非常有用。

对于红队人员，在编写调试 0day 或者 Nday 的 POC 时，比如说 weblogic 中间件，它所包含的依赖 jar 包可能有上千个，**查找存在漏洞的类究竟依赖于哪个 jar 包是非常头痛的一件事**，这个工具可以帮您解决这个问题。在编写调试 weblogic 的 poc 时，ABC_123 就是使用这个功能查找指定 jar 包依赖的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYvI1nyeDcuUA22Hd6o1JVsianMibGpxF07v8ic6qvgDe6XDCTqdMnRpCjw/640?wx_fmt=png)

*   **解密 Shiro 数据包 / CAS 数据包 / Log4j2 数据包功能**
    -----------------------------------------
    

对于设备告警的 Shiro 反序列化攻击行为，部分蓝队分析人员，对 Shiro 反序列化攻击做不了研判工作，**难以辨别是否是攻击行为**，还是正常的业务行为，还是设备误报。于是我在解密数据包的同时，加入了数据包分析功能，可以快速研判是否有反序列化攻击行为。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYmHrj84zA9lneuEZgQsNUna6UYvrdRicnzb4Eibtz4ygwVpSluNHjXuoQ/640?wx_fmt=png)

如下图所示，该功能可以手工指定 key 对 shiro 数据包进行分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYpliaN2tJdOGx54h6lzianyB0K4Puw33KClreh8ZP8fjAXV1ldNZ2k0TQ/640?wx_fmt=png)

该功能可以**解密日常遇到的攻击者用于绕过 waf 的加密混淆的 log4j2 的 payload**，通过此功能，蓝队分析人员可以得到攻击者的一个外网 ip 地址。如果遇到解不了的 payload，记得公众号给我留言。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYbRCKnSNA9etNWdtZ1nKGM3iaibA09IKXib7JyUOn2zJGibDibkJStlEOKIQ/640?wx_fmt=png)

部分设备遇到 CAS 数据包就会告警，蓝队人员又无法确定是否是误报，本功能就是为了解决这个问题而写的，**使用 CAS 默认秘钥对数据包进行解密**，解密后就可以判断出是否是反序列化攻击了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYc1uNFYKOsoVuXAAGf7ZiaX4UILnJxcjDse4tw56RZgzL1icjCDAkS6QQ/640?wx_fmt=png)

*   **编码 / 解码工具**
    

在蓝队分析工作中，不少朋友反映没有一款好用的编码 / 解码工具，不是功能有 bug，就是功能不全。比如说最简单的 URL 编码、16 进制的 Hex 编码、Base64 编码，**很多工具就没有考虑到中文字符的 GB2312、UTF-8 编码问题**，导致解密结果不正确或者是乱码。于是我仔细研读了网上的关于编码 / 解码的文章，对常用的编码 / 解码功能进行调试，写成了如下功能。看后续大家反馈，如果好用的话，我可以把 “编码 / 解码” 功能单独拎出来写一个工具，主要功能如下。

 **1**   更改软件界面，加入 GB2312、UTF-8、GBK、BIG5、ISO-8859-1、GB18030 等编码库，解决中文汉字在编码解码过程中产生的乱码问题。

 **2**   将 “becl 编码文件功能” 中的 becl 编码类更换为 “回忆飘如雪” 师傅编写的 Java 类，解决部分 JDK 由于缺失相应的 class 文件而无法 Becl 编码的问题。

 **3**   新增 “Hex 编码二进制文件” 功能，可以将二进制文件编码成 16 进制格式。

 **4**   将 Base64 编码功能统一更换为第三方 jar 包，使其通用性更强。

 **5**   支持将二进制文件转为 byte 数组格式。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYH1CvcBag5wLrEZYDibpqdT0ezQP5Q005FibShcRDQvNwiba84gee6oJGw/640?wx_fmt=png)

同时还可以对二进制文件进行 base64 编码、hex16 进制编码、BECL 编码、转为 byte 数组等操作。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ArWA0g6q36PG1MsxKzwbHYP5wl8XiaqD9wib0fvzRHmIXA022GgcgZAsibHPZH3QtPMqCM8iaAEDPN5w/640?wx_fmt=png)

**关注 “ABC123 安全研究实验室” 公众号后，回复数字“0318”，即可得到此蓝队工具 V4.3 的下载地址**。

 **Part3 总结** 

**1.**  后续还会继续更新这个工具，有好的建议可以在公众号后台给我留言。

**2.**  冰蝎、哥斯拉数据包解密功能，后续有时间会更新。

****3.**  关注公众号回复 “2****022”，即可得到 “2022 年 ABC123 公众号年刊” 的 PDF 电子书下载地址**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**