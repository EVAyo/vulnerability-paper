<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=Mzk0NjYyNDI0Ng==&mid=2247483828&idx=1&sn=5735814837f8e58376187668714e4605&chksm=c302022df4758b3ba5e4368c3f8be2ac5183ebbebc247e318380b9e14ae341d717e59102e448&scene=21#wechat_redirect)

赛博大作战中的技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他！！

1

基本介绍  

**SqlmapXPlus 基于 Sqlmap**，对经典的数据库漏洞利用工具进行二开，参照各种解决方法，增加 MSSQL 数据库注入的利用方式。

目前已完成部分二开，**包括** **ole、xpcmdshell 两种文件上传、内存马上传、clr 安装功能，能够实现 mssql 注入场景下的自动化注入内存马、自动化提权、自动化添加后门用户、自动化远程文件下载、自动化 shellcode 加载功能。**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcWpleojStTIjGjc5iaclR1L453yZkJ2NJibvIoFv0Wc6y0DT9S9MQv8vg/640?wx_fmt=png&from=appmsg)

先说场景，在众多的地区性攻防演练中，SQL Server 数据库堆叠注入仍有较高的爆洞频率，但因为一些常见的演练场景限制，如不出网、低权限、站库分离、终端防护、上线困难、权限维持繁琐等，公开的漏洞利用工具难满足我们的需求。

场景举例：默认的 --os-shell 依赖于 xp_cmdshell 的存储过程，执行命令的权限默认为数据库的权限

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDiczkoyJ3ow5cAy5E3dTYdiar4rEgCUS27I42k5NE4GWxXwm6HsGdpM5oBw/640?wx_fmt=png&from=appmsg&random=0.5379967167756297)

权限低受不了？试试 system 权限！  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDicz8ibezRUb7IuceIy8C3K0v04kialRpEBhTtKQYrXEF0xkRZwkLc9n7x8A/640?wx_fmt=png&from=appmsg&random=0.7055381608959082)

以及 mssql 站库不分离，找路径、for 循环写 webshell？curl 上线 cs？其实都可以，怎么好用怎么来，或者试试这个

https://github.com/co01cat/SqlmapXPlus

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLXoRO4wYjXpdmI4ExrD4o3CE59kx7rdQcqlcHJ2M8lKg8VvXPUzag8mMsIjBVpoiakQCnMzkMYtNGQ/640?wx_fmt=png&from=appmsg)

新增功能介绍：

```
#  开启 clr 功能
--enable-clr
#  关闭 clr 功能
--disable-clr
# 通过 xp_cmdshell 实现的文件上传功能 ，作用为将本地文件上传到远程服务器
--xp-upload localfile --file-dest remotefile
# 通过 ole 实现的文件上传功能 ，作用为将本地文件上传到远程服务器，默认将文件上传至c:\windows\tasks\目录下
--ole-upload
#  通过 xp_cmdshell 实现的clr安装方式
--install-clr1
#  通过 ole 实现的clr安装方式
--install-clr2
#  进入clr-shell命令交互模式
--clr-shell
#  通过 xp_cmdshell 实现的HttpListener内存马上传方式
--sharpshell-upload1
#  通过 ole 实现的HttpListener内存马上传方式
--sharpshell-upload

```

2

安装 CLR 和上传内存马

**1. 关于 clr 利用功能和内存马的功能实现：**clr 由当前目录下的 clrdatabase.dll 实现，内存马由当前目录下的 listen.tmp.txt 实现，如果需要使用自己实现的 clr 和 listen 内存马可以通过替换该目录下的两个文件实现  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDiczj7yAfHnalQ12Q666ywzaGAzR1B87iagR4SpKF5ysa05jB8kcXkOia2Tg/640?wx_fmt=png&from=appmsg&random=0.7293646966931724)

**2. 安装 clr：**进入 clr-shell 模式前必须先安装 clr 的存储过程，提供了两种安装的方式

**--install-clr1** 适合在 xp_cmdshell 没有被拦截的情况下使用，即使用 --os-shell 可以成功执行命令并获取回显。  

**--install-clr2** 适合在 xp_cmdshell 被拦截的情况下使用，即使用 --os-shell 无法执行命令。

完整命令：python sqlmap.py -u/-r xxxx **--install-clr1** 或 **--install-clr2** 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDiczFr4SfpVaBlvlXYhJN5gukdlMChY19S43G8P2bMsfP2Jn3ywqbZKSwA/640?wx_fmt=png&from=appmsg&random=0.9169978969327692)

无论采用哪种方式，在安装流程结束后都会显示 Install clr successful!

**3. 上传 HttpListener 内存马：**如果需要使用内存马注入功能，就必须先上传内存马文件到目标机器

**--sharpshell-upload1** 适合在 xp_cmdshell 没有被拦截的情况下使用，即使用 --os-shell 可以成功执行命令并获取回显。  

**--sharpshell-upload2** 适合在 xp_cmdshell 被拦截的情况下使用，即使用 --os-shell 无法执行命令。

完整命令：python sqlmap.py -u/-r xxxx **--sharpshell-upload1** 或 **--sharpshell-upload2**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDiczKkMwaTb9N0L2j7TIiaWLKwNZcPFq9Zw1t4UXvNf9cBwt693qicM4ZCLA/640?wx_fmt=png&from=appmsg&random=0.7560629511608417)

内存马的上传流程结束后会显示 Uploaded successfully! 的字样。

3

关于 **clr-shell 的命令执行模式**

在前面步骤都完成的情况下，输入 python sqlmap.py -u/-r xxxx **--clr-shell** 进入 clr 命令执行模式

clr-shell 模式下的内置功能介绍：  

```
clr_rdp # 开启RDP
clr_adduser # 添加系统用户
clr_exec # 命令执行
clr_efspotato # 提权模块
clr_memshell # 内存马
clr_download # 远程文件下载
clr_rm # 指定文件删除
clr_cd # 切换目录
clr_ping # ping
clr_scloader # 直接shellcode加载
clr_scloader1 # 落地的shellcode加载
clr_scloader2 # 落地的shellcode加载

```

**1. 命令执行目前仅 clr_exec 和 clr_efspotato 执行是有回显的：**需要注意的是，因为获取命令执行后回显的权限问题，在进入 clr-shell 模式 后 应该先执行 clr_exec whoami 获取回显，再执行其他命令，否则可能导致回显无法正常获取

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDiczUic2qLZZfPwGDE4GAYVfsYicoTxYWiawjFKHa1GuF52cvDwC21bKrKDUg/640?wx_fmt=png&from=appmsg&random=0.575024218886222)

**2. 内存马注入：**内存马注入需要 system 权限，利用 efspotato 的方式注入，如果执行 clr_efspotato whoami 可以回显 system 权限就不会有问题

在 clr-shell 的命令执行模式中，输入 **clr_memshell** 即可实现注入！

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDiczia6OPvWILxQQcywPxltdrk7Sk2zsV6304Wb0VUwnmynXMYKhB99YT9w/640?wx_fmt=png&from=appmsg&random=0.8806208017229762)

此时尝试访问 url，内存马默认上在对应服务器 80 端口，f12 会存在 inject success 的字样

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDiczCicS6xAgFNJYaNyfp2TIG4M9esbJ5TOmBWic9qLZglKqib9CEVdicEPntA/640?wx_fmt=png&from=appmsg&random=0.3996402354455941)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDicze4H51zWzdfCd7Nf7o2vqD1njf8fWvQltWmKV6CibZ3XCSia718cGlOOA/640?wx_fmt=png&from=appmsg&random=0.03547186319044782)

https://github.com/AntSwordProject/antSword/tree/v2.2.x 使用该版本的蚁剑来进行连接内存马路径  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDiczgyTZCkoHrialBqsOVNGfsRDJ3zULFotYDuia2LpPLp75OIUk0tn7dslw/640?wx_fmt=png&from=appmsg&random=0.6156499324159899)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLViboCdKaGhU6ACEphekIDiczoYtqnQLKIMUibvib0IuyAouYPDHA3L9wpuH9nlZS1RvQw55CibGncLXZw/640?wx_fmt=png&from=appmsg&random=0.09494859574138204)

我们成功获取了一个 webshell！

**3. 远程文件下载**：clr_download 远程路径 目标本地路径

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcjtm9Iy41j7XjQdtahgZQr2ibvTpxaLRo1n0RNWhQWv0SEBibhBN6EUlA/640?wx_fmt=png&from=appmsg&random=0.4238664998401287)

**4.shellcode 加载功能说明：**  

首先，使用 cobaltstrike 生成 payload.bin 文件  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcOdJu67qAic0KKUWgZ14EwDZO7icsgQd7Ff0b1H0CP3icYibBrfpVoIDJXg/640?wx_fmt=png&from=appmsg&random=0.9432209160783722)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcgexIbQg6w8soicgrWMyykicvzDSZ1cWqhNicGpfwLhWkXY7MRiaaqs96ug/640?wx_fmt=png&from=appmsg&random=0.5616314495913757)

然后使用 Encrypt.py 文件对 payload.bin 进行处理，-f 指定 cs 生成的 payload.bin，-k 自定义的密钥

最终会输出一个 base64 的 payload，我们可以将这个 payload 写在一个 txt 文件中，存储在 sqlmap 的目录下如 123.txt

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcMF2ySiabWO97R3w2eko5r1icCBUD2p7VdcKxr97iads3WAj1fuX8UWsdQ/640?wx_fmt=png&from=appmsg&random=0.3343560896639275)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcagOKquD0QKkTH8ibVOXUT2VfMML3Sz31IfXo5NlvOBLrlMBgdvuImRw/640?wx_fmt=png&from=appmsg&random=0.7488757846467102)

**上线方式一**，适合 POST 请求情况下的堆叠注入：**clr_scloader base64 的 payload 自定义密钥**  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcTb7nHqj2PwcvJf17QwBGxiacXHG6Q7MYhicO7BSfCNw8UTZ5ibLj8jCHQ/640?wx_fmt=png&from=appmsg&random=0.49476177456164216)

直接加载，成功上线 CS  

**上线方式二**，加载落地的任意后缀 payload 文件上线，适合 POST、GET 情况下的注入：**clr_scloader1 目标机器上 payload 文件路径 自定义密钥**

先将 payload 上传到目标机器

**![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcRjr54jMrZZ7YgVR3j6aiazRnx5TSxaawkicu5Yb3j0CteH54gV3LxdpQ/640?wx_fmt=png&from=appmsg&random=0.921607275931728)**

运行加载命令，成功上线 CS

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcvYvhEibvzeM1SyPFribmmV7MPqZuutfNcpxnUZQsQorj1yVjn1bRchgw/640?wx_fmt=png&from=appmsg&random=0.3641129473399647)

**上线方式三**，加载落地的原始 payload.bin 文件上线，适合 POST、GET 情况下的注入：**clr_scloader2 目标机器上 payload 文件路径**

先将 payload 上传到目标机器

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHc3ic58n60zPRR73rnTtjqWE3sIgZLK8SaCVXTicXHLy6X5mfq5mVjuMyA/640?wx_fmt=png&from=appmsg&random=0.6036401001338652)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcABm6wW1jLa5XDgqDNUDGTHDhnhhemS9vjyVjBKlMQXSlpnjMTcgsLA/640?wx_fmt=png&from=appmsg&random=0.13944338450578164)

运行加载命令，成功上线 CS！  

3  

最后

趁着假期前的小空闲改写的工具，如果有好的建议欢迎加入交流群大家一起交流技术，2024 年，希望是个好年，希望大家都能过得更好！

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PEicib4sr4bLVJUbicIRfpSicPKlI8R7UjHcqUFokunOWO06EqbHkGSCP1h19I6rVBTOnkicHcEFOP80GDQrOwpicS4w/640?wx_fmt=png&from=appmsg)

**主要参考内容：**                           https://github.com/sqlmapproject/sqlmap https://github.com/uknowsec/SharpSQLTools  https://github.com/Anion3r/MSSQLProxy  https://mp.weixin.qq.com/s/X0cI85DdB17Wve2qzCRDbg   https://yzddmr6.com/posts/asp-net-memory-shell-httplistener/  ......