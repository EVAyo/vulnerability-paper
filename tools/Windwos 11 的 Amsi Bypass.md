<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/8iwuQ7NEI45iA_ZX6pvcRg)

2023 年 Windows 11 上的 Amsi 绕过
============================

Attack_AmsiOpenSession.ps1
--------------------------

```
HRESULT AmsiOpenSession(
[in] HAMSICONTEXT amsiContext,
[out] HAMSISESSION *amsiSession
);

```

此 powershell 脚本可用于通过修补 AmsiOpenSession 来绕过 AMSI。根据汇编代码，如果满足以下任一条件，函数将`E_INVALIDARG`错误退出。

1.  RCX 为 0
    
2.  黑索金为 0
    
3.  HAMSICONTEXT 结构的第 2 个 QWORD 为 0
    
4.  HAMSICONTEXT 结构的第 3 个 QWORD 为 0
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0HlywncJbB2uoonUZbZWl2Tu7IjBuwF8sn6HbX6yvor1UZJK3JoN2DQnrzy139RG65PHzjcul1vLRmFkaqpudQ/640?wx_fmt=png&from=appmsg)

此脚本通过将 RCX 设置为 0 来修补 AmsiOpenSession。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0HlywncJbB2uoonUZbZWl2Tu7IjBuwF8nZIGiboibnZLyv3fDkZiaG2QWNek3GyFfU3CIZKTI5mTmeVbACMWnxQow/640?wx_fmt=png&from=appmsg)

修补 AmsiOpenSession 无法绕过 Assembly.Load() 的 AMSI

Attack_AmsiScanBuffer.ps1
-------------------------

```
HRESULT AmsiScanBuffer(
[in] HAMSICONTEXT amsiContext,
[in] PVOID buffer,
[in] ULONG length,
[in] LPCWSTR contentName,
[in, optional] HAMSISESSION amsiSession,
[out] AMSI_RESULT *result
);

```

此 powershell 脚本可用于通过修补 AmsiScanBuffer 来绕过 AMSI。该脚本通过将 RAX 设置为错误值来修补 AmsiScanBuffer`E_INVALIDARG`并立即返回。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0HlywncJbB2uoonUZbZWl2Tu7IjBuwF8SUnSmCStdCW358d7zU9STNSKO1pvVzlHfDIibUmtIic1cGTqc9rubECg/640?wx_fmt=png&from=appmsg)

项目地址：

https://github.com/senzee1984/Amsi_Bypass_In_2023