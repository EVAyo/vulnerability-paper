<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Q-dkWy6A26u-aQxvaB-52w)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
==============

前一阵子写了这么一款蓝队分析辅助工具箱，没想到下载量还挺大。于是就抽出时间修复了一些 bug，还新增了很多功能。“蓝队分析辅助工具箱” 就是把我平时写的蓝队小工具集合起来形成的，重点解决蓝队分析工作中的一些痛点，比如说让大家头疼的**冰蝎、哥斯拉加密数据包解密问题、netstat -an 返回结果中 ip 无对应的物理地址问题、各种编码 / 解码问题、内存马解码及 Becl 反编译问题等**，未来会持续更新（文末有此工具的下载地址）。

 **Part2 使用说明及功能介绍** 
=====================

*   **新增 Java 字节码反编译功能**
    --------------------
    

在流量分析或者日志分析过程中，很多的攻击 Payload 是经过 Base64 编码、BECL 编码的 Java 字节码，这些编码中可能会包含内存马写入或者 Java 回显功能等关键信息，但是处理起来特别麻烦。于是 ABC_123 编写了如下字节码反编译功能，**调用主流的 Idea、cfr、Procyon、jd-gui 等反编译工具**，方便蓝队人员在反编译过程中进行对比。

如下图所示，可以直接对 BECL 编码的 class 文件进行反编译，并且对反编译后的 java 代码结果进行高亮显示。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWsJ3qVtA7kyS4Tic5j79ia2fkyjcybr0TicavCathHv1UwtcOiagk9wvnVTw/640?wx_fmt=png)

如下图所示，可以直接对 Base64 编码的 class 文件进行解码，并且反编译。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWsWm7GJm2en2crPjBjyB2pVibbljZOFxcNYPY9rT0EyMBeUCNtE57DjwA/640?wx_fmt=png)

如下图所示，可以直接对单个 class 文件进行反编译。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWsKZuHVibeibGibCvR1NzC21Gz8r7rMhPWibpodBF2SibXH8kF3AHXzFibBp7Q/640?wx_fmt=png)

*   **更新编码 / 解码功能**
    ---------------
    

在蓝队分析工作中，不少朋友反映没有一款好用的编码 / 解码工具，不是功能有 bug，就是功能不全。比如说最简单的 URL 编码、16 进制的 Hex 编码、Base64 编码，**很多工具就没有考虑到中文字符的 GB2312、UTF-8 编码问题，导致解密结果不正确或者是乱码**。于是我仔细研读了网上的关于编码 / 解码的文章，对常用的编码 / 解码功能进行调试，写成了如下功能。看后续大家反馈，如果好用的话，我可以把 “编码 / 解码” 功能单独拎出来写一个工具，主要功能如下。

 ****1****   更改软件界面，加入 GB2312、UTF-8、GBK、BIG5、ISO-8859-1、GB18030 等编码库，解决中文汉字在编码解码过程中产生的乱码问题。

 ****2****  将 “becl 编码文件功能”中的 becl 编码类更换为 “回忆飘如雪” 师傅编写的 Java 类，解决部分 JDK 由于缺失相应的 class 文件而无法 Becl 编码的问题。

 ****3****   新增 “Hex 编码二进制文件” 功能，可以将二进制文件编码成 16 进制格式。

 **4**   将 Base64 编码功能统一更换为第三方 jar 包，使其通用性更强。

 **5**   支持将二进制文件转为 byte 数组格式。

如下图所示，将选择的文件转换成 becl 编码。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWsra2eXQhBuxyDJI6E4YibeZ8sZKpUdkSSW9fjG8XlL1OKYu8Q3jkP3Bw/640?wx_fmt=png)

如下图所示，将选择的文件转为 Byte 数组形式。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWsrfKt0QG4H8JicFIAZgFNuGbSDHAKZPiagSN0d59pRcjZkF0tzT2C3zbA/640?wx_fmt=png)

*   **冰蝎及哥斯拉流量解密功能**
    ----------------
    

对于冰蝎和哥斯拉的数据包解密，我逆向分析了冰蝎和哥斯拉的代码，参考了网上的各种解密工具，编写了这个解密功能。对于解密冰蝎，基本上拿到秘钥都可以正确解密。对于哥斯拉，目前只支持解密 JSP、JSPX 型的 webshell，支持哥斯拉 3.x 及 4.x 版本，同时也支持哥斯拉 1.x 及 2.x 版本。**哥斯拉低版本的 1.x-2.x 与 3.x-4.x 版本的流量加密过程稍微有点不一样，因此解密功能分开写了**。

后续有时间再更新这个功能吧，因为逆向分析不同版本、不同脚本的冰蝎及哥斯拉 webshell，实在是太费精力了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWsdzXmWr4DyAJN0TZWwYiamLSf0OalpmtNOH7Ue2xGFWT1C1uMu7JUstg/640?wx_fmt=png)

如下图所示，可以解密冰蝎流量。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWszhFqCW1iaJSlic8svuMta7pWMbb0ayPd8hzjiaRg0kQNpBZx5L5HZSZKg/640?wx_fmt=png)

*   **端口连接解析 ip 的物理地址**
    -------------------
    

解决上一个版本查询速度太慢的问题，**更换 ip 地址库，优化查询速度，查询秒出结果**。重要的是，解析出每个外网 ip 对应的国家、城市地址，方便一眼定位出存疑的 ip、端口、进程。

将 netstat -an 结果贴到工具中，点击 “查询 ip 对应物理地址”，程序会在每一个结果后面，**加上****每个外网 ip 地址所解析出来的国家城市的物理地址**，方便大家做蓝队分析工作。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWsj2Yu0Odvb9FvoHmhFcP6KYMeoWnnTRMP8XE3ccib3KO4IvDlYq46bdA/640?wx_fmt=png)

*   **解密 CAS 功能**
    -------------
    

CAS 反序列漏洞的数据包也是加密的，这导致即使监控设备告警，蓝队人员也半信半疑，无法判断到底是不是误报。本功能就是为了解决这个问题而写的，**使用 CAS 默认秘钥对数据包进行解密，解密后就可以判断出是否是反序列化攻击了**。当然，对于新版本的 CAS 数据包是解密不了的，因为秘钥变成随机生成的了。攻击者只有在拿到网站源代码或者是找到网站的配置文件，才能得知 CAS 新版本的秘钥。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWsw4D7Zgoia49dLVW1qxTqTib8kKxguDIia370PG0bw2hcqyRApzEo017wQ/640?wx_fmt=png)

*   **Log4j2 反序列化解密功能**
    -------------------
    

用于解密日常遇到的攻击者用于绕过 waf 的加密混淆的 log4j2 的 payload。如果遇到解不了的 payload，记得公众号给我留言。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWsWhW4EwEG7RzqWEeiaCt4x80Rz97TDjpDM7LzibW9GK56FvTOib1kZuDvA/640?wx_fmt=png)

*   **Shiro 反序列化数据包解密及分析功能**
    ------------------------
    

每天监控设备都会告警各种各样的 Shiro 反序列化攻击，由于数据包是加密的，所以蓝队人员遇到了也会头疼，而且部分蓝队分析人员，对 Shiro 反序列化攻击做不了研判工作，难以辨别是否是攻击行为，还是正常的业务行为。于是我在解密数据包的同时，加入了数据包分析功能，**可以研判是否有反序列化攻击行为**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATYfIJgrSOXnE0SgAfZSWsYh6LxoTyYH0AHjcPRvEbLB2PZgibtuiadC8O8DmyExd3oxG0lb6EuxRA/640?wx_fmt=png)

**关注 “网络安全 abc123” 公众号后，回复数字“1116”，即可得到此蓝队工具 V3.6 的下载地址**。后期我会继续维护这个蓝队小工具，大家有什么好的建议或者想法，可以给我留言。

 **Part3 总结** 

1.  后续还会继续更新这个工具，有好的建议可以在公众号后台给我留言。

2.  冰蝎、哥斯拉数据包解密功能，后续有时间会更新。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队、蓝队、日常渗透测试、安全体系建设等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)