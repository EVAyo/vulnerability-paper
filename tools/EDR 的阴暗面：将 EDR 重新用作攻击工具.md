> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/J7_cl5IvlTdU7-wM1YOaFw)

端点检测和响应 (EDR) 解决方案已成为许多企业端点安全策略的关键组成部分，预计到 2030 年其市场价值将接近 170 亿美元。这在很大程度上归因于 COVID-19 疫情后远程办公的增加、由此产生的自带设备 (BYOD) 趋势（员工使用个人设备进行与工作相关的活动），以及网络威胁的不断演变。 

EDR 解决方案旨在监控最终用户设备（如笔记本电脑、台式机和服务器），以帮助组织更好地检测和应对勒索软件和恶意软件等威胁。正如 Gartner 所指出的，EDR 解决方案 “记录和存储端点系统级行为，使用各种数据分析技术来检测可疑系统行为，提供上下文信息，阻止恶意活动，并提供补救建议以恢复受影响的系统。” 为了执行这些活动，EDR 通常以最高权限运行，同时具有 “防篡改” 和持久性。  

作为一名安全研究员和前恶意软件研究员，我一直在观察 EDR 解决方案与不断演变的恶意软件之间的持续竞争——随着一种恶意软件变得越来越复杂，另一种恶意软件也变得越来越复杂。我最近的研究项目是在 Black Hat Asia 2024 上首次展示的，旨在探索如何操纵两者之间的关系，使 EDR 成为恶意攻击工具。具体来说，我想看看我是否可以创建作为 EDR 本身一部分的恶意软件（而不仅仅是能够绕过它），同时保持持久、隐秘和高权限。我把目光投向了市场上使用最广泛的解决方案之一：Palo Alto Networks Cortex 扩展检测和响应 (XDR) 平台。 

下面，我将首先概述这项研究的主要发现和要点。接下来，我将深入介绍作为 Cortex XDR 安装过程的一部分提供的内容文件的详细信息，特别是我在这些文件中发现的有关其勒索软件保护功能的功能的信息。我将提供示例和演示，说明如何使用这些信息开发多种技术来绕过 XDR。然后，我将解释我的研究过程如何确定进一步利用 XDR 行为的方法，从而使我能够开发另一种绕过方法，甚至插入我自己的恶意软件以在 XDR 的某个进程中运行。最后，我将重点介绍供应商的响应，并解释我们如何与更广泛的安全社区共享这些信息，以帮助组织保护自己。

**概述** 

**主要发现** 

作为安装过程的一部分，Cortex XDR 包含基于 Lua 的内容文件，其中包含其检测机制的底层逻辑。它利用这些文件中的信息来执行其保护功能。通过分析这些内容文件，我深入了解了 XDR 某些保护措施背后的逻辑。这使我能够设计出规避某些保护措施的方法，例如：

*   加密指定文件夹内的文件，但不影响蜜罐文件以避免被发现。
    
*   对 lsass.exe 进程进行内存转储，该进程保存用户凭据和安全令牌等敏感数据。
    

在我的整个研究过程中，我还找到了利用 Cortex XDR 行为的方法，包括：

*   绕过 Cortex 的文件防篡改保护，最终使我能够加载易受攻击的驱动程序（自带易受攻击的驱动程序 [BYOVD]）并在其中一个驱动程序中修补 Cortex XDR 的管理密码验证。这使我能够更改 Cortex 的逻辑以拒绝任何管理员密码，从而阻止管理员使用 Cortex 管理服务器上的管理员卸载密码或通过对受感染机器的物理访问来删除 XDR。我相信需要对磁盘进行完全格式化并重新安装操作系统和 Cortex XDR 才能删除恶意代码。
    
*   将恶意代码插入到它的一个进程中，授予我高权限，并允许我保持不被发现和持久的攻击状态。
    

**总结**

我们认为这项研究可能会给数百万用户带来重大的安全风险，其影响有以下几个重要启示：

*   主动研究以识别终端产品中的安全风险可能比研究操作系统 (OS) 中的安全风险更有价值。利用操作系统中的风险的攻击者仍必须与另一个守护者抗衡：EDR。但是，如果攻击者突破了最高级别的守护者（即 EDR），他们就可以不受限制地访问大量强大的功能，而无需面对任何守护者。
    
*   安全产品检测过程背后的逻辑应受到严格保护。这项研究证明，通过让攻击者通过解决方案的内容文件访问这种敏感的检测逻辑，他们更有可能设计出绕过它的方法。我们认为端点安全供应商必须确保：
    

*   内容文件在磁盘上时是加密的。虽然这些文件最终会在内存中解密，但这会使分析文件和开发绕过方法变得更加困难。 
    
*   内容文件必须经过数字签名 / 验证，并且不依赖于可能作为单点故障被绕过的外部防篡改层。 
    

*   在 “允许列表” 或“阻止列表”中添加进程或操作应基于多个参数。更具体地说，这些参数不应具有被攻击者操纵的能力。例如，仅根据进程名称将进程添加到 “允许列表” 是不够的，因为攻击者可以轻松修改该名称，或者根据命令正则表达式检测进程转储。
    

**背景**

**Cortex XDR 安装过程**

Palo Alto Cortex XDR 平台支持 Windows、Mac 操作系统 (OS) 和 Linux 环境。我决定只关注 Windows 代理，并着手首先了解它的工作原理。作为起点，我探索了在安装过程中写入磁盘的文件，并注意到 C:\ProgramData\Cyvera 文件夹下有许多其他与 XDR 相关的文件和文件夹。 

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48taepDGVgQiakHB3hsp8PKLQTKOUCDfPjeCx0OsgGTUBCRfd30ml1IAokPSvT6QCcoLv2JcdQV2ELuEg/640?wx_fmt=jpeg&from=appmsg)

在该文件夹中，我发现了另一个名为 content 的文件夹。它似乎包含策略规则以及基于文本且易于理解的 Lua 和 Python 文件。

**Cortex XDR 勒索软件防护** 

在进一步检查内容文件夹后，我注意到一个名为 ransom.lua 的文件，这让我对 Cortex 的勒索软件保护机制有了很好的了解。本质上，Cortex 将蜜罐文件隐藏在机器的各个位置，以协助检测勒索软件。如果某个进程试图修改这些文件，XDR 会将其识别为可能的勒索软件，并终止该进程。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48taepDGVgQiakHB3hsp8PKLQTKj2789x3OWlvqC5wSB7iasHI5bxnz4ibrtAVGce89MFblo2kxlibCWK3qg/640?wx_fmt=jpeg&from=appmsg)

Cortex 还希望阻止大多数合法进程查看蜜罐文件——这样做是为了防止它们意外修改诱饵文件，从而导致错误警报或进程终止。为此，Cortex： 

*   保存不应能够看到 ransom.lua 文件中的蜜罐文件的合法进程列表
    
*   使用微过滤驱动程序使蜜罐文件对这些进程不可见 
    

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48taepDGVgQiakHB3hsp8PKLQTKoMK5oK0FnLR47MzIB4WS0micia9ULeYaJvNOGqcwtHuRgwlrZ5FnHXgQ/640?wx_fmt=jpeg&from=appmsg)

**研究过程**

根据我了解到的有关 Cortex XDR 勒索软件保护如何工作的信息，我确定了我的研究目标。我想要： 

*   首先，看看我是否可以利用从阅读 ransom.lua 文件中获得的知识来绕过 XDR 的勒索软件保护。 
    
*   其次，看看我可以使用内容文件中的检测逻辑完成哪些其他恶意操作。 
    
*   第三，找到一种允许我在 XDR 内部实际运行恶意软件而不是仅仅绕过它的技术。 
    

**绕过技术**

**Cortex XDR 勒索软件防护绕过**

首先，我验证了 Cortex XDR 是否已启动并运行，并且启用了所有服务和保护。我编写了一个非常简单的勒索软件，名为 ransom.exe，它会在第一次测试中加密给定文件夹中的所有文件。我在包含重要文件的 Documents 文件夹中运行了它。正如预期的那样，Cortex 使用其勒索软件保护检测到了这一恶意行为，并且文件未被加密。

为了进行真正的测试，我选择了 ransom.lua 文件中白名单程序的名称之一——aaplayer.exe，并相应地重命名了勒索软件。我再次在 Documents 文件夹中运行它，这次成功了。我能够加密那里的所有文件，成功绕过 Cortex XDR 的勒索软件保护。 

为什么？当勒索软件在特定文件夹上执行时，它会列出文件夹中的所有文件，然后对其进行加密。通过为勒索软件赋予与白名单进程之一相同的名称，我能够阻止它查看 / 列出 Documents 文件夹中的蜜罐文件。因此，它只加密文件夹中的合法文件，蜜罐文件不受影响，并使其不被 XDR 检测到。 

要了解此过程的实际操作，请查看下面的演示。 

[视频详情](javascript:;)

**供应商回应** 

所有问题均于 2023 年报告给 Palo Alto Networks，并于 2024 年 2 月收到了以下回复：

“安全是我们最优先考虑的事情。SafeBreach 在 [10] 个月前就通知了我们其研究情况，当时我们通过自动内容更新解决了该功能绕过问题。”  

**结论** 

本研究探讨了让 EDR 解决方案的敏感检测逻辑易于访问可能带来的安全隐患。我们展示了恶意行为者如何利用这些信息来逆向工程绕过 EDR，从而给数百万用户带来重大的安全风险。为了帮助减轻本研究发现的漏洞的潜在影响，我们采取了以下措施： 

*   负责任地向 Palo Alto Networks 披露了我们的研究结果，并与他们会面，讨论针对我们发现的问题的可能解决方案。如上所述，他们发布了修复程序。我们强烈建议所有 Cortex XDR 用户确保其软件版本是最新的，以防止任何此类攻击的漏洞。我们还强烈建议其他端点安全供应商确保：
    

*   内容文件在磁盘上时是加密的。虽然这些文件最终会在内存中解密，但这会使分析文件和开发绕过方法变得更加困难。 
    
*   内容文件必须经过数字签名 / 验证，并且不依赖于可能作为单点故障被绕过的外部防篡改层。 
    

*   在我们最近的 Black Hat Asia 2024 演示中，与这里更广泛的安全社区公开分享了我们的研究成果，以提高人们对这些问题的认识。
    
*   提供了一个研究存储库，其中包含能够验证这些漏洞的工具，并作为进一步研究和开发的基础。 
    
*   在 SafeBreach 平台中添加了原始攻击内容，使我们的客户能够根据本研究中概述的漏洞验证他们的环境，从而显著降低他们的风险。