<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/5wnFoW7FDmFXm4TgJreA4w)

### 

![](https://mmbiz.qpic.cn/mmbiz_png/hCicTN92QQAcSt013ad7micLm4908x2gcVgnZ0hmES9OpZbszEzGRUNibfcWjBzNE8UMbDiaLdBOHcA3ahVcyUZOcg/640?wx_fmt=png)

### 0x00 前言

    关于 BOF 大家应该不太陌生了，由`CobaltStrike 4.1`引入的功能被大家熟知，介绍：[聊聊 Cobalt Strike 4.1 的 BOF](http://mp.weixin.qq.com/s?__biz=MzI5NzU0MTc5Mg==&mid=2247483809&idx=1&sn=c3723f82a7a383df5a03dfa9f5cf7914&chksm=ecb2c86edbc541780b2d3064dd71cffc9c0cd82289a6d16aaf69c7ace83eb4924a7eae858dca&scene=21#wechat_redirect)；  
    说白了也就是程序编译后还没有链接的中间产物，在红队行动中，一般由我们的植入体充当链接器，这样一来我们编写的 obj 文件体积又小且不落地，十分不错，也可以算是 OPSEC 的方式。

### 0x01 Visual-Studio-BOF-template 优化

    开发 BOF 可能大家会用到，https://github.com/dtmsecurity/bof_helper 这个工具

    再者就是`Trustedsec`提供的模板，https://github.com/trustedsec/CS-Situational-Awareness-BOF

    或是 https://github.com/securifybv/Visual-Studio-BOF-template

    后者的项目可以添加一个 Visual Studio 的项目模板，其中定义了一些用作 BOF 动态解析的函数，以及对这些函数结构又做了一次宏定义。

    这样的话我们预先定义好就不用再代码中将用到的 API 都按`KERNEL32$HeapAlloc`类似这样的格式编写了；最后还可以 BOF 和平常 c 的编译格式切换：

![](https://mmbiz.qpic.cn/mmbiz_png/hCicTN92QQAcSt013ad7micLm4908x2gcVhPQ2nDNojiaqjxb7yqHnhzrhibAgv1OM8l0hiaGWgEFPwCJJalpiaI99Zg/640?wx_fmt=png)  

    这样最大的好处就是调试和编译 BOF 变得十分方便，而且是在我们比较熟悉的`Visual Studio`上面。

`Visual-Studio-BOF-template`项目中提供的`bofdef.h`文件是比较旧的，于是乎我将`trustedsec`这两个项目中的`bofdef.h`文件更换到了模板中，又进行了分类，这样定义编写都比较方便明了：

按导出 DLL 名字区分文件，如果其中缺少定义还可以自己添加

![](https://mmbiz.qpic.cn/mmbiz_png/hCicTN92QQAcSt013ad7micLm4908x2gcVvEeIDRlf2M0yp8tT2lcIOw6MYibb58Kg0gzuXbYKK4fRGE05GosYGiaw/640?wx_fmt=png)  

添加函数结构定义后，回到`bofdef.h`文件添加对应的宏定义

![](https://mmbiz.qpic.cn/mmbiz_png/hCicTN92QQAcSt013ad7micLm4908x2gcVDXeOicg5iciaCSfy2Nu9uCIjsN6ZGDnYJEkpns6YOPPicGg5rSIPEQJqyQ/640?wx_fmt=png)  

    最后就可以像写 C 代码一样编写 BOF 了。

    比如 COM 添加计划任务的例子，定义好需要的结构后，不用担心任何规定语法直接像写 C 一样编写：

![](https://mmbiz.qpic.cn/mmbiz_png/hCicTN92QQAcSt013ad7micLm4908x2gcVz1o8sz8erDcxjf88FFnJZq0WVqgFyaicSjad4LXxmzFAVPfApoibDwDQ/640?wx_fmt=png)  
![](https://mmbiz.qpic.cn/mmbiz_png/hCicTN92QQAcSt013ad7micLm4908x2gcVGHKic6gLkxI3Oibiamn5lAibjxvIaR0bDibghewCia0neEeD2tnEfcwDb1kw/640?wx_fmt=png)  

### 0x03 添加模板

```
git clone https://github.com/evilashz/Visual-Studio-BOF-template


```

    模板我更改为`Visual Studio 2022` 工具集 VS143，当然如果你没有的话也不妨碍，创建项目后再属性设置工具集即可。

路径为

```
%UserProfile%\Documents\Visual Studio 2022\Templates\ProjectTemplates


```

将模板文件夹放入即可，创建项目时即可看到，

![](https://mmbiz.qpic.cn/mmbiz_png/hCicTN92QQAcSt013ad7micLm4908x2gcVqaq8ibDA81ibKcIWccybPdhiabYskTBl3SENIsiaicfuJdd0SjkB3W1tgdQ/640?wx_fmt=png)  

### 0x04 总结

    总而言之，**说白了**，我是十分推荐用这个项目去做 BOF 开发的，编译和调试非常方便，理论上定义好各类的函数，就可以做到直接将现有的 C 代码复制过来就可以编译一个 BOF。

    所以说我写这篇文章的意思就是希望大家一起使用这个项目，将平时自己编写添加的函数结构都可以集合到 bofdef 中，欢迎大家 PR。

**GitHub：https://github.com/evilashz/Visual-Studio-BOF-template**

* * *

![](https://mmbiz.qpic.cn/mmbiz_png/hCicTN92QQAdaicTpyfnN9zyCkbVIZuWhvUibeMP0qkrEODzgpgLfROkknw97mF5gBugfib5z8liaBjwpaDkyUMAUvw/640?wx_fmt=png)