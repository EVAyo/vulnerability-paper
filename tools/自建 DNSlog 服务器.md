<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/GROYfJFFBCA815YWbYkZdQ)

**前言**

网上公开提供 dnslog 服务有很多，比如知道创宇，三叶草的等等，但是这些提供的域名是固定的，现在一些比较大型的企业已经把这些域名也加入到监控范围之中了。

如果自建一个 dnslog 服务，就能很好的规避这种情况！！！

**一、DNS 基本概念**
==============

**0x1：DNS 中不同域名类型概念**
---------------------

DNS 的全称是 Domain Name System（网络名称系统），它作为将域名和 IP 地址相互映射，使人更方便地访问互联网。当用户输入某一网址如 littlehann.com，网络上的 DNS Server 会将该域名解析，并找到对应的真实 IP 如 101.37.97.51，使用户可以访问这台服务器上相应的服务。

DNSlog 就是存储在 DNS Server 上的域名访问信息，它记录着用户对域名 littlehann.com 等的访问信息，类似日志文件。

按照解析类型分类，DNS 域名有如下几种：

*   **A 记录**：A (Address) 记录是用来指定主机名（或域名）对应的 IP 地址记录。就是说：通过 A 记录，大家可以设置自己的不同域名转到不同的 IP 上去。如：
    

*   www.dns.la 转到 IP 116.255.202.1
    
*   web.dns.la 转到 IP 116.255.202.11
    
*   mail.dns.la 转到 IP 116.255.202.111
    

*   **MX 记录（Mail Exchange）**：邮件交换记录，用户可以将该域名下的邮件服务器指向到自己的 Mail Server 上，然后即可自行操作控制所有的邮箱设置。
    
*   **CNAME（Canonical Name）记录**：通常称别名解析，可以将注册的不同域名都转到一个域名记录上，由这个域名记录统一解析管理，与 A 记录不同的是，CNAME 别名记录设置的可以是一个域名的描述而不一定是 IP 地址。
    
*   **URL（Uniform Resource Locator）转发**：网址转发功能，如果您没有一台独立的服务器（也就是没有一个独立的 IP 地址）或者您还有一个域名 B，您想访问 A 域名时访问到 B 域名的内容，这时您就可以通过 URL 转发来实现。URL 转发可以转发到某一个目录下，甚至某一个文件上。而 CNAME 是不可以，这就是 URL 转发和 CNAME 的主要区别所在。
    
*   **NS（Name Server）**：NS 记录是域名服务解析记录，NS 用来指定该域名由哪个 DNS 服务器来进行解析，可以把一个域名的不同二级域名分别指向到不同的 DNS 系统来解析。
    
*   **AAAA 记录**：IPV6 解析记录，该记录是将域名解析到一个指定的 IPV6 的 IP 上。
    

**0x2：DNS 解析顺序**
----------------

当客户端对域名发起访问时，会将解析请求发送给递归解析服务器，递归服务器会代替客户端进行全球递归查询。

*   首先递归服务器会请求根域名服务器，根域名服务器根据域名后缀，告知对应的顶级域名服务器
    
*   递归服务器再向顶级服务器发起请求，顶级域名服务器告知对应的权威服务器
    
*   递归服务器向权威服务器发起请求，权威服务器告知解析结果
    
*   递归服务器将结果告知客户端，客户端完成访问
    

![](https://mmbiz.qpic.cn/mmbiz_jpg/n2rSqJSRAVyibQwYytVYNg2Cibiaut27aH47lBT3DRaBzHibq4rApDXVHkqGQo15Xn7vQYcfyaqmqictwr92Odfzanw/640?wx_fmt=other&from=appmsg)

以上是 DNS 解析的标准流程，但是由于各种 DNS 缓存的存在，导致 DNS 解析环节更为复杂。

所谓 DNS 缓存是指 DNS 返回正确的 IP 地址之后，系统会将这个结果临时储存起来，并为缓存设定一个失效时间（TTL 值），在 TTL 失效前，当再次访问这个网站，系统就会直接从 DNS 缓存中将结果返回，而不必再次委托递归服务器进行全球解析查询，加快了 DNS 解析的流程。

当然 TTL 值失效后，系统还会自动再次询问 DNS 服务器以获取最新的解析结果。

按照缓存位置的不同，DNS 缓存可以分为以下几类：

*   （1）浏览器 DNS 缓存：浏览器会根据一定频率缓存 DNS 记录
    
*   （2）本地 DNS 缓存：如果浏览器缓存中找不到解析记录，就会去询问操作系统中的缓存
    
*   （3）本地 HOSTS 文件：HOSTS 是记录域名与 IP 地址一一映射关系的本地文件，Windows 系统中位于 C:\Windows\System32\drivers\etc
    
*   （4）路由器 DNS 缓存：我们常用的路由器也带有自动缓存功能，路由器 DNS 被篡改会造成域名劫持，将访问网址定位到另外一个服务器
    
*   （5）递归服务器缓存：递归服务器在将解析结果告知客户端的同时，将记录缓存下来，当下次请求同一个域名时，直接会将记录返回，而无需再进行全球查询
    

DNS 解析顺序是 “先查缓存，再递归解析”，查询顺序为：浏览器缓存—系统缓存—路由器缓存—递归服务器缓存—递归查询。

### **参考链接：**

```
https://developer.aliyun.com/article/331012

```

**二、DNSlog 安全风险分析**
===================

**0x1：为什么需要 DNSlog 平台**
-----------------------

在某些情况下，无法利用漏洞获得回显。但是，如果目标可以发送 DNS 请求，则可以通过 DNS log 方式将想获得的数据外带出来（oob）。

DNS log 常用于以下情况：

*   SQL 盲注
    
*   无回显的命令执行
    
*   无回显的 SSRF
    

**0x2：为什么能够出现 DNSlog 平台这种技术**
-----------------------------

首先，DNS 服务是互联网核心基础设施之一，DNS query 外连端口和外连请求几乎在整个互联网上都是默认开放的，这对攻击者来说就是一个绝佳地稳定 oob 通道。

其次，因为 DNS 解析服务整体上看是一个分布式地架构，NS server 则是这个分布式架构的基础设施，同时攻击者可以很容易地创建自己的 NS server，从而给攻击者利用 DNS 递归查询流程作为 oob 信息收集提供了极大地便利。

攻击者劫持受害机器的执行流后，发起 DNS query 查询，查询的域名是攻击者自有的 A 记录域名，同时由于攻击者声明了该 A 记录的 NS 记录，该 NS 记录指向的是攻击者控制的一台域名服务器，所以根路由会将该 DNS query 查询发送到攻击者控制的域名服务器上（也就是运行了 dnslog 程序的机器上），至此完成了 oob 信道传递过程。

**0x1：前期准备**
------------

*   一台公网可访问机器：运行 DNS 解析服务程序，作为 DNS 域名服务器，接受来自 53 端口的 DNS 解析请求，并将 DNS query 继续递归查询，完成最终查询，相当于一个 DNS query proxy 的作用。
    
*   一个有效域名
    

注意，上述公网可访问机器必须开放 UDP 53 端口，以确保该机器可以接受 DNS 查询以及进行 DNS 递归查询。

**0x2：域名解析准备**
--------------

*   添加一个 A 记录，将域名 xxx 指向公网可访问机器 xx。
    
*   添加一个 NS 记录，将 NS 记录指向 A 记录。
    

通过制定 NS 记录，便指定了解析对应 A 记录的 DNS 域名服务器，以此完成了 DNS oob 的信道搭建。

**0x3：搭建充当 NS Server 的 DNSlog Server**
--------------------------------------

下载地址：

```
https://github.com/lanyi1998/DNSlog-GO/releases

```

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVyibQwYytVYNg2Cibiaut27aH4xL1ejSNgQOGGr7sOyxysJpoUDhgicynSuicH9PF2e0R3oAO01jg6iakFQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVyibQwYytVYNg2Cibiaut27aH4WMTvug9x8LWsVuGp4iaedAqd3mLQqXnEuwksGClyibvvZpd48q52IymA/640?wx_fmt=png&from=appmsg)

下载对应版本并解压，

```
wget https://github.com/lanyi1998/DNSlog-GO/releases/download/1.5.6/dnslog-linux.zip

```

编辑配置文件，

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVyibQwYytVYNg2Cibiaut27aH4eBGyXubUVH0ictsXMJfaAQHNhiauxGe0IMCSOMlCjWAoicqGXOic0BRP2Q/640?wx_fmt=png&from=appmsg)

启动服务，

```
./dnslog-linux

```

**0x4: 后台运行并加入开机自启动**
---------------------

上面的方法有两个不足

*   无法后台运行
    
*   重启后进程不复存在
    

经过一个多小时的排错和搜索资料，终于实现了开机自启动并后台运行。这里我详细地写下教程，免得大家像我一样出现很多错误耽误时间。

### **1、编写 Shell 脚本**

在 / root/DNSlog 目录下编写 run.sh，内容如下

```
cd /root/DNSlog  # 这里根据自己DNSlog的main可执行文件所在位置进行修改即可
./main &

```

之后执行 run.sh 这个脚本，此时进程虽然会输出到当前终端会话，但其实进程已经脱离了当前会话，可以安全的推出会话，进程也不会退出。

### **2、修改 rc.local**

```
vim /etc/rc.d/rc.local

```

在末尾加上这句

```
/root/DNSlog/run.sh >/dev/null 2>&1

```

![](https://mmbiz.qpic.cn/mmbiz_jpg/n2rSqJSRAVyibQwYytVYNg2Cibiaut27aH43B8NxVVNukAuuRbFNJvXu2oyqtnWEP2Ff2GRwRbTiaOdtz5hia8Gk6Sw/640?wx_fmt=other&from=appmsg)

给 rc.local 加上可执行权限

```
chmod +x /etc/rc.d/rc.local

```

### **3、修改 rc-local 服务**

```
systemctl status rc-local.service # 检查rc-local服务是否开启
systemctl start rc-local.service  # 开启rc-local服务
systemctl enable rc-local.service # 将rc-local服务加入开机自启动

```

### **4、测试**

重启 vps 后，使用 ps -ef 可以发现已经自动运行了该程序，后台进程 ID 为 1146

![](https://mmbiz.qpic.cn/mmbiz_jpg/n2rSqJSRAVyibQwYytVYNg2Cibiaut27aH4VNslXcPFdxmx7cqB0licWTO95Jl7bjklcicXemL2bzCwEoaWkbzC9b7w/640?wx_fmt=other&from=appmsg)

Web 服务也能成功访问

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVyibQwYytVYNg2Cibiaut27aH4n64qy7INh9icia7oZ9JfT041uYiat6VDTiaNkwLazF2ZFCkfIVJYiaaJ5SQ/640?wx_fmt=png&from=appmsg)

杀死进程可以使用命令 kill -9 进程 PID

### **5、最后**

到这里我们就实现了只要 VPS 处于开机状态，main 程序就自动运行，**常开随用**，我们可以方便快捷地使用 DNSlog。但**常开随用**也带来了一个问题就是，如果某个攻击者获得了我们的 Token（社工或爆破等手段），那么攻击者就可能会使用我们的 VPS 主机开启的 DNSlog 服务去进行一些非法渗透，而如果被溯源到就会很麻烦，因此我们需要提高 Token 的复杂度且避免泄露，或者不使用这节的技术，使用原始的**随开随用**方法，什么时候需要用 DNSlog 就什么时候运行 main 程序，很大程度上可以避免这个问题。

三、参考链接：
=======

```
https://github.com/aboul3la/Sublist3r  
https://blog.csdn.net/m0_51468027/article/details/125734951 
https://cloud.tencent.com/developer/article/1948254 
https://www.f12bug.com/archives/dnslog%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA 
https://github.com/lanyi1998/DNSlog-GO/releases/tag/1.5.6
https://zhuanlan.zhihu.com/p/540457671

```

![](https://mmbiz.qpic.cn/mmbiz_jpg/n2rSqJSRAVzNPDEiadhLROCQUuMQyouq2OicjCbTSbk6ZLyzR1uHhPhJZLuZTFaM31tS5jvcDB3sfVsb9novFWeQ/640?wx_fmt=jpeg)

**本文版权归作者和微信公众号平台共有，重在学习交流，不以任何盈利为目的，欢迎转载。**

**由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。**公众号**内容中部分攻防技巧等只允许在目标授权的情况下进行使用，大部分文章来自各大安全社区，个人博客，如有侵权请立即联系公众号进行删除。若不同意以上警告信息请立即退出浏览！！！**

**敲敲小黑板：《刑法》第二百八十五条　【非法侵入计算机信息系统罪；非法获取计算机信息系统数据、非法控制计算机信息系统罪】违反国家规定，侵入国家事务、国防建设、尖端科学技术领域的计算机信息系统的，处三年以下有期徒刑或者拘役。违反国家规定，侵入前款规定以外的计算机信息系统或者采用其他技术手段，获取该计算机信息系统中存储、处理或者传输的数据，或者对该计算机信息系统实施非法控制，情节严重的，处三年以下有期徒刑或者拘役，并处或者单处罚金；情节特别严重的，处三年以上七年以下有期徒刑，并处罚金。**