<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/lpVt0bPBgjlb6Daum9shyg)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
--------------

**大家好，我是 ABC_123，公众号正式更名为” 希潭实验室”，**ABC_123 坚持 99% 原创，敬请关注****。年前写了这么一款蓝队分析辅助工具箱，看到很多朋友都在使用，于是我也抽出时间把很多功能进行了优化和更新。“蓝队分析辅助工具箱” 就是把我平时写的蓝队小工具集合起来形成的，重点解决蓝队分析工作中的一些痛点问题。本次更新重点解决热心网友反馈的一些问题，**解决了长时间让 ABC_123 非常头痛的 Java Swing 软件界面美化问题**。

**注：1、软件路径不能包含中文。2、Mac 系统下复制粘贴请使用 Command+V、Ctrl+V、Alt+V 等快捷键进行尝试**。

 **Part2 使用说明及功能介绍** 
---------------------

*   **端口连接添加 ip 归属地址 | 对国外 IP 高亮显示**
    --------------------------------
    

假设甲方客户的内网主机中了恶意病毒，蓝队人员通常会执行 netstat -an 命令去查看每个端口或者进程连接国外 ip 地址情况。将 **netstat -an** 结果贴到工具中，点击 “**查询 ip 对应物理地址**” 按钮，程序就会在每一行结果后面，添加上每个 ip 地址对应的国家、城市、经纬度、国外大学等物理地址，方便蓝队人员快速定位出存疑的 ip、端口、进程，而且**此功能无需联网使用，断网情况下仍然可以用。**本次更新优化了查询速度，基本上秒出结果，**同时对国外的 IP 地址进行了标黄处理，方便查看**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCXKpI8Zxk8AqOywibPNpSIYwyIdWTW4kJGckzhHQzbDMpoqVCtB2ayJg/640?wx_fmt=png)

*   **Java 反序列化数据包分析功能**
    

此功能可以直接对 java 反序列化数据包进行解包分析，参考了 **SerializationDumper** 工具的代码。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCB3YOeayaa4lvWZCYKT1JRWrZvumDxjZs74plibLTfQBy5c7tTF7O9TQ/640?wx_fmt=png)

*   **冰蝎及哥斯拉 webshell 流量解密功能**
    --------------------------
    

编写这个功能耗费了我很大的精力，对于冰蝎 webshell，从流量中找到秘钥即可解密。对于哥斯拉 webshell，目前只支持 java 型 webshell 流量解密，其它功能后续再加上。由于哥斯拉低版本的 1.x-2.x 与 3.x-4.x 版本的流量加密过程稍微有点不一样，因此解密功能分开写了。暂不支持冰蝎 4.x 的解密，后续会加上。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCG09gCJHX3kiaZFNJRkNunaXOuiao71NpnH9OGDewZI142N4WTB0uEiaAA/640?wx_fmt=png)

如下图所示，可以清晰看到攻击者具体进行了哪些操作，方便大家在编写蓝队分析报告，直观地将危害性反馈给甲方客户。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPC9IZTapDWqRSfElp4ic13NNe0SKoGZjBvy7rnkkzzJIYdUtm1uTQ6kYg/640?wx_fmt=png)

*   **新增 5 种 Java 内存马 class 文件反编译功能**
    ---------------------------------
    

通过调用 Intellij Idea、CFR、Procyon、JD-Core、JDK 等 5 种反编译工具接口，分别对 Base64 加密的 class 文件、转成 Byte 数组的 class 文件、BECL 编码的 class 文件、Base64 编码 + Gzip 编码的 class 文件、原版 class 文件反编译成 java 代码，方便蓝队人员分析异常流量中的内存马代码。

当然，**此功能对于红队人员也特别方便**，方便大家编写 tomcat、springboot、weblogic 内存马时进行 class 文件反编译对比分析。

 **1**  如下图示所示，程序对 Base64 加密的内存马 class 文件进行反编译分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCmJIx24euH1Hx08j2Jpolrd7ODgPibH8icGOkPwmhnK5bPozTykURpuOg/640?wx_fmt=png)

 **2**  如下图示所示，程序对 Byte 数组的内存马 class 文件进行反编译分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCkff3AWCsN8tga6pGma9bia0TtQ4zkygMkkGmvtlKrhOsSqvPGOQE09g/640?wx_fmt=png)

 **3**  如下图示所示，程序对 BECL 编码加密的内存马 class 文件进行分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCB2pr378SibK5PkDPDYXxcLeNibGzfWBMOraAI6D6bTNbay3zN2iaQFViaA/640?wx_fmt=png)

 **4**  如下图示所示，程序对 Base64+Gzip 压缩的内存马 class 文件进行反编译分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCKTMU778W7PibrM1KRIia7hZmE5icltB84Pd8jllNmMGtm3wPO4J37VH6w/640?wx_fmt=png)

 **5**  如下图示所示，程序对 class 文件进行反编译分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCUibwFD8Aic8PwAgbA1ZAgiaMl5b5A59PHvSyZ6oZgP3jp2r0WCsG6icp7g/640?wx_fmt=png)

*   **在 Jar 包中搜索指定类名**
    ------------------
    

对于蓝队人员，此功能可以在指定的 jar 包目录中筛选出含有恶意类名的 jar 包文件，**现在很多红队人员制作的不死内存马，会将 jar 包中的 class 文件修改掉，关机重启后内存马仍然可用**，那么这个分析功能会非常有用。

对于红队人员，在编写调试 0day 或者 Nday 的 POC 时，比如说 weblogic 中间件，它所包含的依赖 jar 包可能有上千个，**查找存在漏洞的类究竟依赖于哪个 jar 包是非常头痛的一件事**，这个工具可以帮您解决这个问题。在编写调试 weblogic 的 poc 时，ABC_123 就是使用这个功能查找指定 jar 包依赖的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPC26J5RYFSdHp7tDyEPNybGKSX5eKlkcuYnfCxmq0FFlfZRG8YOyrpBA/640?wx_fmt=png)

*   **解密 Shiro 数据包 / CAS 数据包 / Log4j2 数据包功能**
    -----------------------------------------
    

对于设备告警的 Shiro 反序列化攻击行为，部分蓝队分析人员，对 Shiro 反序列化攻击做不了研判工作，**难以辨别是否是攻击行为**，还是正常的业务行为，还是设备误报。于是我在解密数据包的同时，加入了数据包分析功能，可以快速研判是否有反序列化攻击行为。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCo24EqLk19owib14Z5GEq36jzxjFQ54mzfSJcTvwZhUnOyWqK8Of4pCA/640?wx_fmt=png)

如下图所示，该功能可以手工指定 key 对 shiro 数据包进行分析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPC6dxxUesCxhWbsR7nSvaSxQ2GPNT7UXCdcT5PxG24MDAZv4xfLJYOicA/640?wx_fmt=png)

该功能可以**解密日常遇到的攻击者用于绕过 waf 的加密混淆的 log4j2 的 payload**，通过此功能，蓝队分析人员可以得到攻击者的一个外网 ip 地址。如果遇到解不了的 payload，记得公众号给我留言。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCy1eKSDYuHbgUav8ZE6GbQgGG72ZJbOFcl2cdheDLaF8MlxiaicSITnjA/640?wx_fmt=png)

部分设备遇到 CAS 数据包就会告警，蓝队人员又无法确定是否是误报，本功能就是为了解决这个问题而写的，**使用 CAS 默认秘钥对数据包进行解密**，解密后就可以判断出是否是反序列化攻击了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPClotxiauAHbOWKJHVkaS3gQmaibXJPdYEJreRvc585JFX0GAibP0wal29g/640?wx_fmt=png)

*   **编码 / 解码工具**
    

在蓝队分析工作中，不少朋友反映没有一款好用的编码 / 解码工具，不是功能有 bug，就是功能不全。比如说最简单的 URL 编码、16 进制的 Hex 编码、Base64 编码，**很多工具就没有考虑到中文字符的 GB2312、UTF-8 编码问题**，导致解密结果不正确或者是乱码。于是我仔细研读了网上的关于编码 / 解码的文章，对常用的编码 / 解码功能进行调试，写成了如下功能。看后续大家反馈，如果好用的话，我可以把 “编码 / 解码” 功能单独拎出来写一个工具，主要功能如下。

 **1**   更改软件界面，加入 GB2312、UTF-8、GBK、BIG5、ISO-8859-1、GB18030 等编码库，解决中文汉字在编码解码过程中产生的乱码问题。

 **2**   将 “becl 编码文件功能” 中的 becl 编码类更换为 “回忆飘如雪” 师傅编写的 Java 类，解决部分 JDK 由于缺失相应的 class 文件而无法 Becl 编码的问题。

 **3**   新增 “Hex 编码二进制文件” 功能，可以将二进制文件编码成 16 进制格式。

 **4**   将 Base64 编码功能统一更换为第三方 jar 包，使其通用性更强。

 **5**   支持将二进制文件转为 byte 数组格式。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPCgwjnGzgprKkSnL0JiaTolmNvRqjB3kPUfftdFttzHVq6c8Q1fAQYBow/640?wx_fmt=png)

同时还可以对二进制文件进行 base64 编码、hex16 进制编码、BECL 编码、转为 byte 数组等操作。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AcpiaO0gVPcbJdW4vPyMdPC1X0RgNSe3zXYMCFI07gbG9o09tOLTwfdMGyibP1Zo74icCvqZk1XTG3Q/640?wx_fmt=png)

**关注**公众号** " 希潭实验室”，回复数字 “0416”，即可得到此蓝队辅助工具箱 V0.52 的下载地址**。

 **Part3 总结** 

**1.**  后续还会继续更新这个工具，有好的建议可以在公众号后台给我留言。

**2.**  冰蝎 4.x、哥斯拉数据包解密功能，后续有时间会更新。

**3.**  后续会加入一些威胁情报检索功能，敬请关注。

**4.**  **关注公众号回复 “2022”，即可得到“2022 年 ABC123 公众号年刊” 的 PDF 电子书下载地址**。

**往期 ABC_123 原创文章回顾：**
======================

[**第 56 篇：美国安全局 NSA 入侵西北工业大学流程图梳理和分析（上篇）**](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247485629&idx=1&sn=58d689bcd8892e254a0dd4f816380bc9&chksm=c25fc7c6f5284ed06085a3ffda6bef5a3b3d4c8c6fd905366e8d328e55200fe8ba402b1e8a1e&scene=21#wechat_redirect)
==================================================================================================================================================================================================================================================================

[**第 51 篇：某运营商外网打点到内网横向渗透的全过程**](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247485030&idx=1&sn=8c0dd91d1fc54e4457ab13183e6cc39f&chksm=c25fc91df528400b194be8c1c91c60f896575dd859950bfa99f631d73d4255c418ca172ea09d&scene=21#wechat_redirect)

[**第 46 篇：伊朗 APT 组织入侵美国政府内网全过程揭秘（上篇）**](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484850&idx=1&sn=36efc90cdbe0764778c0b980bf8a003e&chksm=c25fcac9f52843df8b5e361c9fce336e3300d71566797cf0f55fa6eabc0c54946933464df694&scene=21#wechat_redirect)

[**第 19 篇：关于近期 cs 服务端被反打的原因分析**](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484349&idx=1&sn=c23223a0348336daae18acc4a4790bb8&chksm=c25fccc6f52845d03b30faae72d252256434197d1267d713e60b85810f734368f0be61e62a06&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**