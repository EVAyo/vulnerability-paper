<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/_IeXt_f0BCyQkvWTnBPvkA)

**作为蓝队成员，你是否在防守过程中常常为以下问题所困扰？**

*   尽管明确指定了防守资产，但外包人员还是频繁误封生产环境。
    
*   安全设备匹配到 DNS 服务器请求的 IOC 域名告警时，外包人员胡乱封禁 DNS，导致邮件等需要外联的生产系统崩溃。
    
*   外包人员甚至对 127.0.0.1 进行封禁，显现出严重的专业知识缺乏。  
    
*   监测人员每时每刻都需要根据安全设备告警填写封禁 IP 协同表格，封禁人员也无法实时封禁攻击 IP，效率低下。
    
*   重复性的工作需要大量人员参与，还必须进行 24 小时轮班，增加了人力成本和管理复杂度。
    
*   防守单位的防火墙等封禁设备性能低下，添加规则既繁琐又易导致系统崩溃。
    
*   误封 IP 后，解禁时需要在多个设备上反复排查搜索，耗费了大量时间和精力。
    
*   临时添加白名单 IP 后，无法有效同步给所有工作组成员。
    
*   总是重复封禁相同 IP，封禁设备的规则库又容易空间不足，无法满足封禁需求。
    
*   封禁设备陈旧，无法支持封禁一定时间后自动解除。
    
*   安全厂商自家设备只能和自家设备进行联动，无法也不给适配全部设备，限制了整体防护效果。
    

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBSMicZMRBscvn4oWnlGKaarzjKnXVLTBW8phEmIj1BtiadZ6bUz3cHmMYAYY60YLQzRGmpoaicAkDOtQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBSMicZMRBscvn4oWnlGKaarztxNTrrXuuBo3ibJh9b85tH7He5ZIEmlNeF7eCf0LwX3HwOfQzY0WbjA/640?wx_fmt=png&from=appmsg)

**解决方案**

针对以上问题，我们特此研发了全自动封禁平台（https://github.com/sec-report/SecAutoBan），从此防守不再困难，平台具备以下优势：

*   智能化防护：自动封禁威胁，减少人为错误，降低人力成本。
    
*   高效协同：封禁信息实时同步，确保所有工作组成员及时了解动态。
    
*   精确管理：支持对封禁规则进行细粒度控制，自动解除过期封禁，提升封禁设备性能。
    
*   兼容性强：能够与不同厂商的安全设备进行联动，构建全面的防护体系。
    
*   简化操作：用户友好的界面设计，简化操作流程，降低学习成本。
    

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/PUubqXlrzBSMicZMRBscvn4oWnlGKaarzvpC6vUiccwoNOY7cCoicLtX2MicYHN721YEticqia2Sy9GSq2qn3F9OcLGg/640?wx_fmt=other&from=appmsg)

服务采用分布式设计，由三大模块组成，分别为：告警日志解析处理模块、核心处理模块、IP 封禁 / 解禁模块，每个模块单独运行。

*   告警模块：负责处理所有来自安全设备的告警信息，并提取其中的 IP 地址。
    
*   核心模块：接收到告警模块传入的 IP 地址后，进行去重和过滤等处理，以确保只有有效的 IP 被处理。
    
*   封禁模块：接收来自核心模块处理后的 IP 地址，并进行相应的封禁操作。
    

具体思维导图如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/PUubqXlrzBSMicZMRBscvn4oWnlGKaarzfB0ee8ACgD3jG57ibbltibbRab2UvXIakW2aSdPZyXFhnG1Em3TJNVdg/640?wx_fmt=other&from=appmsg)

整体封禁流程如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/PUubqXlrzBQ40kPFeB786bibWy9iboJrgIQwwef4W7Cm4XUepQoBCllO3mictHV9g7EkobkzcbYAexShYA5Wjwt8Q/640?wx_fmt=other&from=appmsg)

**安装使用**

**0x01 安装核心模块**

核心模块采用 docker-compose 方案一键安装，运行脚本前请先安装 docker：

_mkdir SecAutoBan && cd SecAutoBan_

_wget https://raw.githubusercontent.com/sec-report/SecAutoBan/main/docker-compose.yml_

_wget https://raw.githubusercontent.com/sec-report/SecAutoBan/main/run.sh_

_chmod +x run.sh_

_./run.sh_

Docker 全部运行后访问 http://127.0.0.1/ 访问管理后台，初始化管理员账号。

**0x02 新建告警 / 封禁设备**

首先在管理后台添加设备：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/PUubqXlrzBSMicZMRBscvn4oWnlGKaarzF4538X22J1vuJJf9pwDVxtGibAUkDL40lnDIcQXSR4WPwKARyGVJ0GA/640?wx_fmt=other&from=appmsg)

添加设备后，复制设备连接 Key。（注意：设备连接 Key 仅显示一次，请妥善保存）

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/PUubqXlrzBSMicZMRBscvn4oWnlGKaarzmMp6StDIwjmrq610gNlKeeHlqZciaBuvEzGxXLDSsj5nlIBTaCORL4w/640?wx_fmt=other&from=appmsg)

0x03 配置并运行告警 / 封禁模块

安装加密依赖，回连平台数据包需要加密：

_pip3 install pycryptodome_

模块具体使用方法请跳转至项目文档：https://github.com/sec-report/SecAutoBan

（目前项目中只有 python 版样例，后续会上新 golang 等语言样例），根据项目文档配置好模块后，使用 python 运行即可。

运行告警分析模块：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/PUubqXlrzBQ40kPFeB786bibWy9iboJrgIfjLG7oBsFfnZx0Biau1qCiatiapxFmEzsXNwRpDeW4AGNkfLBYTrsxibfw/640?wx_fmt=other&from=appmsg)

运行封禁 / 解封模块：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/PUubqXlrzBQ40kPFeB786bibWy9iboJrgIVCia27FsOGxg1HNEia5u7ONzfjR5aUgLTovWn6ibTSmxfJWw8YGFRltZg/640?wx_fmt=other&from=appmsg)

运行成功后，平台将显示设备已连接：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/PUubqXlrzBQ40kPFeB786bibWy9iboJrgIlMe8CuyoavbokicWQjChbw07ffhtmc3ntfP16l65cZ2OSB144yeib5ZQ/640?wx_fmt=other&from=appmsg)

模块全部运行后，就会有源源不断的报警推送到核心模块中，核心模块处理后会再推送给所有连接平台的封禁模块进行处置。  

使用 Web 端实时查看封禁处置流水：

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/PUubqXlrzBSMicZMRBscvn4oWnlGKaarzk6lz5cQ0QcEOEcsLibnamsuTSYyDhNIGOYr4DHSWT3dN2NCMIDJt68A/640?wx_fmt=gif&from=appmsg)

至此整个系统就全部运行起来了，享受全自动封禁带来的高效和便捷吧～

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBSMicZMRBscvn4oWnlGKaarzjKnXVLTBW8phEmIj1BtiadZ6bUz3cHmMYAYY60YLQzRGmpoaicAkDOtQ/640?wx_fmt=png&from=appmsg)

- END -

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR8nk7RR7HefBINILy4PClwoEMzGCJovye9KIsEjCKwxlqcSFsGJSv3OtYIjmKpXzVyfzlqSicWwxQ/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)