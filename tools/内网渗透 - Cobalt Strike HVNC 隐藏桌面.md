<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/uTomlKOuyQd4YdZ4LB7zPQ)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0HlywncJbB1aK9lJWbPSdtRw5ooyl1bZI5MzM1JpV16WRhrF7r4zKXhdt0SCR5NgZP4OAQRFMDsUtK4Kx14MfQ/640?wx_fmt=png&from=appmsg)

隐藏桌面 BOF
========

隐藏桌面（通常称为 HVNC）是一种工具，允许操作员在用户不知情的情况下与远程桌面会话进行交互。没有涉及 VNC 协议，但结果是类似的体验。这个 Cobalt Strike BOF 实现是作为用 C++ 编写的 TinyNuke/forks 的替代品而创建的。

隐藏桌面有四个组件：

1.  BOF 初始化程序：负责将 HVNC 代码注入 Beacon 进程的小程序。
    
2.  HVNC shellcode：TinyNuke HVNC 的 PIC 实现。
    
3.  服务器和操作员 UI：侦听来自 HVNC shellcode 的连接的服务器以及允许操作员与远程桌面交互的 UI。目前仅支持 Windows。
    
4.  应用程序启动器 BOF：在新桌面中执行应用程序的 Beacon 对象文件集。
    

用法
--

下载最新版本或使用 自行编译`make`。在可通过团队服务器访问的 Windows 计算机上启动 HVNC 服务器。然后您可以使用以下命令执行客户端：

```
HiddenDesktop <server> <port>

```

您应该在服务器计算机上看到一个新的空白窗口。BOF 默认不执行任何应用程序。您可以使用应用程序启动器 BOF 在新桌面上执行常用程序：

```
hd-launch-edge
hd-launch-explorer
hd-launch-run
hd-launch-cmd
hd-launch-chrome

```

您还可以使用鼠标和键盘通过文件资源管理器启动程序。其他应用程序可以使用以下命令执行：

```
hd-launch <command> [args]

```

实施细节
----

1.  Aggressor 脚本生成随机管道和桌面名称。它们作为参数传递给 BOF 初始值设定项。桌面名称在执行时存储在 CS 首选项中，并由应用程序启动器 BOF 使用。HVNC 流量使用 转发回团队服务器`rportfwd`。状态更新通过命名管道发送回 Beacon。
    
2.  BOF 初始化程序首先解析所需的模块和函数。来自 Aggressor 脚本的参数已解决。指向包含参数和函数地址的结构的指针被传递给`InputHandler`HVNC shellcode 中的函数。它用于`BeaconInjectProcess`执行 shellcode，这意味着可以在 Malleable C2 配置文件或进程注入 BOF 中自定义行为。您可以修改隐藏桌面以定位远程进程，但当前不支持此操作。这样做是为了让 BOF 可以退出并且 HVNC shellcode 可以继续运行。
    
3.  `InputHandler`创建一个新的命名管道供 Beacon 连接。建立连接后，将打开 ( `OpenDesktopA`) 或创建 ( `CreateDesktopA`) 指定的桌面。`rportfwd`通过反向端口转发 ( ) 到 HVNC 服务器建立新套接字。输入处理程序为`DesktopHandler`下面描述的函数创建一个新线程。该线程将从 HVNC 服务器接收鼠标和键盘输入并将其转发到桌面。
    
4.  `DesktopHandler`通过反向端口转发建立到 HVNC 服务器的附加套接字连接。该线程将监视窗口的更改并将其转发到 HVNC 服务器。
    

兼容性
---

HiddenDesktop BOF 在以下 Windows 版本 / 体系结构上使用 example.profile 进行了测试：

*   Windows Server 2022 x64
    
*   Windows Server 2016 x64
    
*   Windows Server 2012 R2 x64
    
*   Windows Server 2008 x86
    
*   Windows 7 SP1 x64
    

项目地址

https://github.com/WKL-Sec/HiddenDesktop