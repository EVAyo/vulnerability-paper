> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/hSbqm5bBcZIByk9dY1mNqg)

#### 简介

CobaltStrike Bof 的全称是 Beacon Object Files，Bof 是一种在目标系统上执行自定义代码的机制，Bof 是用 C 编写的小型程序。

Bof 是一种通过将自定义的 C 代码编译成对象文件并通过 CobaltStrike 的 Beacon 在目标系统内存中加载和执行的机制。

#### 什么是 Bof

Bof 在 CobaltStrike 中是一种插件的基址，它允许用户在 Beacon 上指定自定义的 C 代码，Bof 文件是通过将 C 代码编译为对象文件，也就是. o 文件。

这些对象文件可以通过 CobaltStrike 的 Beacon 模块去加载和执行。

#### 构建环境

构建环境非常简单，如下 Bof 模版。

```
https://github.com/securifybv/Visual-Studio-BOF-template/releases

```

我们下载解压之后只需要将文件夹放置到 VS 的 ProjectTemplates 目录即可。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLS1VBXIVChajZUZZQjlKOOB87zDrZQCtbYUdecnXIVMekYlfIsfMYlKQ/640?wx_fmt=png&from=appmsg)

然后在你去创建项目的时候，这里就有 Beacon Object File 了。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLSXjW4npEvQia8f8HLWmo1bicf7oDvcgUcuRrBibuib8ePfWZekQ9dwmp3yA/640?wx_fmt=png&from=appmsg)

点击创建。

创建之后可能会报错找不到 Source.cpp 文件，这可能是因为下载的这个模版中没有这个文件。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLSXLjQlyzJvHn1b37tNdmq5vdNyOPex8eb4fubqFFBSyh7gMcEg93giaw/640?wx_fmt=png&from=appmsg)

我们点击确认。

然后将其 Source.cpp 文件移除掉。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLSEAxyp269WEibTVoJKABoW3aATbe03ztBp60gGPlsLepSCG2GMUK1NRQ/640?wx_fmt=png&from=appmsg)

再去重新创建一个 Source.c 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLS5zCRMsPvdXgfPymiaWUffSGI1wvRIpibueUIjACmYRhGlNK0yOZDuCGg/640?wx_fmt=png&from=appmsg)

创建之后将其下面的模版代码复制进去。

```
#include <windows.h>
#include <stdio.h>
#include "bofdefs.h"
void go(char* buff, int len) {
	BeaconPrintf(CALLBACK_OUTPUT, "Hello world");
}
void main(int argc, char* argv[]) {
}

```

紧接着点击生成 -> 批生成。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLSibHicDfKQYcAqxOpvsKBsg91tsIEwm0wicDQgyBtvMTsUoibdzFiazJMpPw/640?wx_fmt=png&from=appmsg)

在批生成中勾选 Bof。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLSQCYxiconjzfQFxe1Tw61dmKSL7CByumHUE9yIRn88KibBXMXib3ulWKIw/640?wx_fmt=png&from=appmsg)

然后在编译这里切换到 Bof 即可。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLSORhibjsLxRNBVAQdjoZtGU2fSVkjAsBxbrh0XzZ5M6I3UaWziarAwWNw/640?wx_fmt=png&from=appmsg)

最后点击生成，会生成一个. obj 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLS86lPmIjcjW0rQspGugp9NKyhnoWNuMc1A4AqynWqJTMx6CM1KibUtPw/640?wx_fmt=png&from=appmsg)

紧接着我们就可以使用 CobaltStrike 中的 inline-execute 命令来进行加载了。

```
inline-execute source.obj

```

可以看到成功执行。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLSYJumHxwHqVbD54SUXsPbcYgficsAdD3kTBmfH4zI5sLxEYzay8vfZsg/640?wx_fmt=png&from=appmsg)

#### 理解代码

那么我们接下来就来尝试去理解 Bof 代码。

首先我们要解释的是 bofdefs.h 头文件，这个头文件中包含了 CobaltStrike Bof 特定的函数和宏定义。

而 go 函数是 Bof 的入口函数，CobaltStrike 在加载和执行 Bof 的时候会去调用这个函数。

正如上图所见，我们打印出了 Hello World。

```
void go(char* buff, int len) {
	BeaconPrintf(CALLBACK_OUTPUT, "Hello world");
}

```

调用 BeaconPrintf 函数会在 Beacon 控制台中输出 Hello World 字符串，至于 CALLBACK_OUTPUT 标记表示这是一个普通的输出类型。

那么我们来详细看一下这个函数的原型，这个函数是 CobaltStrike 中提供的一个 API 函数，用于在控制台中输出信息。

如下原型:

```
void BeaconPrintf(int type, const char *fmt, ...);

```

type 参数表示的是输出信息的类型，一般的值为 CALLBACK_OUTPUT 表示普通的输出信息，而 CALLBACK_ERROR 表示错误信息。

fmt 是格式化字符串，类似于 printf 函数，后面的三个点是一个可变参数，表示输出的实际数据。

 那么如果我们想格式化输出值的话，我们只需要给定一个变量以及 %d 占位符即可。

如下代码:

```
#include <windows.h>
#include <stdio.h>
#include "bofdefs.h"
void go(char* buff, int len) {
    int number = 42;
    BeaconPrintf(CALLBACK_OUTPUT, "The number is %d", number);
}
void main(int argc, char* argv[]) {
}

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLSD9mbYibRNyeNhn4HWNG9ImIMfU4yu8enQtVtMjFos30H5Xn638HJHdQ/640?wx_fmt=png&from=appmsg)

那么我们来学习一下其他的函数。

#### 常见函数学习

##### BeaconDataParse

BeaconDataParse 函数是用于初始化数据解析器的一个函数，它会将传递给 Bof 的原始数据和解析器关联起来，以便后续的函数来提取各种类型的数据。

函数原型如下:

```
void BeaconDataParse(datap *parser, char *data, int length);

```

parser 参数指向了一个 datap 的指针，用于保存解析器的状态。

data 参数是传递给 Bof 的原始数据。

length 参数是数据的长度。

我们来看一下 datap 结构，这个结构是用于管理和解析数据的内部结构，BeaconDataParse 函数将数据和长度与 datap 结构关联了起来。

这个函数一般会和 BeaconDataInt，BeaconDataShort，等函数来配合使用。

这里我们演示的话就使用 BeaconDataint 吧。

如下代码：

```
#include <windows.h>
#include "beacon.h"
void go(char* args, int length) {
    // 初始化解析器
    datap parser;
    BeaconDataParse(&parser, args, length);
    // 提取整数值
    int value1 = BeaconDataInt(&parser);
    int value2 = BeaconDataInt(&parser);
    // 输出提取的值
    BeaconPrintf(CALLBACK_OUTPUT, "this is number: %d, %d", value1, value2);
}
void main(int argc, char* argv[]) {
}

```

其实就是在 CobaltStrike 去运行 Bof 的时候传递的值会在这里进行接收。

那么接下来这这几种方式其实也是一样的。

都是用来接收参数的。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLSibbDsXzxAS3O6EuaTomgwkTiaJUUhAy6kGeenwkvB5ylZCCyWOM1S32A/640?wx_fmt=png&from=appmsg)

##### BeaconFormatAlloc

BeaconFormatAlloc 函数用于初始化和分配一个 formatp 结构的，formatp 结构用户构建动态缓冲区，可以在 Bof 中格式化和存储数据。

函数原型如下:

```
DECLSPEC_IMPORT void __cdecl BeaconFormatAlloc(formatp *format, int maxlen);

```

format 参数指向 formatp 结构的指针，这个结构指针将被初始化和分配。

Maxlen 参数指向动态缓冲区的初始最大长度。

如下使用方式:

```
#include <windows.h>
#include <stdio.h>
#include "beacon.h"
void go(char *args, int length) {
    formatp buffer;
    BeaconFormatAlloc(&buffer, 128); // 初始化并分配一个最大长度为128的formatp结构
    BeaconFormatPrintf(&buffer, "Hello: %d", 123);
    char *output = (char *)buffer.buffer;
    BeaconPrintf(CALLBACK_OUTPUT, "%s", output);
    BeaconFormatFree(&buffer);
}
void main(int argc, char *argv[]) {
}

```

##### BeaconIsAdmin

BeaconIsAdmin 函数是用于检查当前线程是否是以管理员的权限去运行的，比如说如果我们想去添加用户，那么我们首先肯定是需要去判断当前的线程是否是以管理员去运行的。

函数原型如下:

```
DECLSPEC_IMPORT BOOL __cdecl BeaconIsAdmin();

```

如果当前线程以管理员权限运行的，那么返回 TRUE。

如果当前线程不是以管理员权限运行的，那么返回 FALSE。

如下代码:

```
#include <windows.h>
#include <stdio.h>
#include "beacon.h"
void go(char *args, int length) {
    if (BeaconIsAdmin()) {
        BeaconPrintf(CALLBACK_OUTPUT, "管理员运行的线程");
    } else {
        BeaconPrintf(CALLBACK_OUTPUT, "不是管理员运行的线程");
    }
}
void main(int argc, char *argv[]) {
}

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrqg1qPoSTz7hMUlIqPRqLSNPBsjFibUfs43a5mq2GtGOtPHH5cQpia0icHrjzmvkoxiboRFibzOz0Lkzw/640?wx_fmt=png&from=appmsg)