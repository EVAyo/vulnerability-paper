> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/hNt167nDY4pOL5vz3joWog)

### **介绍**

一个简单申请包括 iis 劫持, 无文件木马, shellcode 免杀后台的工具

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9JPpNb7icHgEaYLvsvoPuickLGp7MdajSzQgqibbQGQ9WbrovJuP8AScvpWLzNX0UicKEksXArLPE9fTpZ1qIJsahA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9JPpNb7icHgEaYLvsvoPuickLGp7MdajSzzq1sncbReNhMCAqcBWaR7cBbRNiaZVsOV6zwnzhsehT0pnD2TABpq0Q/640?wx_fmt=png&from=appmsg)

### **功能列表**

1.  HWBP hook 检测 检测线程中所有疑似被 hwbp 隐形挂钩
    
2.  内存免杀 shellcode 检测 (metasploit、Cobaltstrike 完全检测)
    
3.  可疑进程检测 (主要针对有逃避性质的进程 [如过期签名与多可执行段])
    
4.  文件名指向木马检测 (检测所有指定内存木马)
    
5.  简易 rootkit 检测 (检测证书过期 / 拦截读取 / 证书无效的驱动)
    
6.  检测异常模块，检测绝大部分如 “iis 劫持” 的后续模块
    

### **免杀木马检测原理**

所有所谓的内存免杀之后大部分基于 “VirtualAlloc” 函数申请内存之后通过各种莫名其妙的 xor 命令 aes 加密去图标 shellcode 达到 “免杀” 效果。本工具通过线程堆栈回溯方法 (StackWalkEx 函数) 遍历线程, 寻找位于 VirtualAlloc 区域的代码, 这样即使它很常见也会被误认为是程序申请 VirtualAlloc 分配内存。但大部分普通程序均不会在 VirtualAlloc 区域内执行代码。一般都是在. text 区段内执行代码。

### **无文件落地木马检测原理**

所有文件均指向一个 PE 文件，主要特征如下：

1.  内存段有 MZ 标志
    
2.  线程指向一个 NOIMAGE 内存，本工具将会通过第一种方式检测出 “无文件落地木马”
    

### **异常模块检测原理**

本工具将会为所有带签名的程序的模块并且其中检测模块的不存在则发出提示。本检测模块不存在且未被正确识别，但将会为被生成的 IIS 安全模块

### **项目地址**

https://github.com/huoji120/DuckMemoryScan