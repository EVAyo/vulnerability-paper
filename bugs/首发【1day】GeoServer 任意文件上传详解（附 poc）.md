<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/tLXlemWT1Suius0necplEw)

_**免责声明：**_

_本公众号致力于安全研究和红队攻防技术分享等内容，本文中所有涉及的内容均不针对任何厂商或个人，同时由于传播、利用本公众号所发布的技术或工具造成的任何直接或者间接的后果及损失，均由使用者本人承担。请遵守中华人民共和国相关法律法规，切勿利用本公众号发布的技术或工具从事违法犯罪活动。最后，文中提及的图文若无意间导致了侵权问题，请在公众号后台私信联系作者，进行删除操作。_

**0x01 前言**

前几天各个公众号发了一堆 GeoServer 的新漏洞威胁公告，也就是这个 CVE-2023-51444，碰巧之前 hvv 也碰到过 N 多 GeoServer 系统，但是一般都是弱口令或者其他敏感信息之类的拿 shell 的 poc 不多，google 一搜真有 poc，相信大家都搜到了，就是 github 的这个东西

https://github.com/geoserver/geoserver/security/advisories/GHSA-9v5q-2gwq-q9hq

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicCrxIZNgLqTqAvCeBly7XT8k9rwpkoGOt7Agcyic0XmlqeC8zb67nTXw/640?wx_fmt=png&from=appmsg)

本来以为当个伸手党随意复现一下得了，没想到这给的什么鬼 poc，能复现才怪。翻了半天安全厂商的复现公告，给的一张 POC 截图还打了厚码，捏马的，这我能忍吗，自己动手吧。

**0x02 环境搭建**

本身这个系统的专业性比较强属于专业的地图管理之类的，具体应用场景咱也不用搞懂，由于本次受影响的版本如下

GeoServer < 2.23.4

2.24.0 <= GeoServer < 2.24.1

随意搜了一下，官网正好有一个符合影响范围的 docker 版本 2.22.X，链接如下  

https://docs.geoserver.org/2.22.x/en/user/installation/docker.html

直接拿来用

```
docker pull docker.osgeo.org/geoserver:2.22.x
docker run --mount type=bind,src=/MY/DATADIRECTORY,target=/opt/geoserver_data -it -p8080:8080 docker.osgeo.org/geoserver:2.22.x

```

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeic7QZ1HtVDT613bHYgficNHoEm76XZ17bHu7UXgl3FLiaOoxrtRfuibqbYg/640?wx_fmt=png&from=appmsg)

**0x03 审计过程**

首先跟了一下 github 的补丁提交记录看看漏洞触发点在哪里，乍一看非常的 easy 嘛，不就是文件处理函数没有对路径进行校验和过滤嘛。  

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeic5MaLOhibDsica06H1XQ7qlAHYFviaHgZq3oYAo6v0ib9E6A3vpHcyz664A/640?wx_fmt=png&from=appmsg)

根据官方给的 poc 提示，该漏洞最后一步应该是发了一个二进制的 post 包触发的

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicdANDXxWP5AvBrCbbH9TqvARyt2d0OAZpZak3uo3To8xAXB8SDTWGSw/640?wx_fmt=png&from=appmsg)

回到代码中来，如下图，代码中的该接口与 poc 的 URL 接近

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicFNXn8LutKZshmXmS9Lbfa5KrMFmZhe74H5J7xMBhrghQ2mk5WuNpKg/640?wx_fmt=png&from=appmsg)

负责处理该接口的 controller 是下面的函数

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicwhCIjvsBxxpwhoIGiaJQdq3tVVAqBrpvUBfuPWOkq06ZXGrb5pwtDMg/640?wx_fmt=png&from=appmsg)

既然找到了接口函数，接下来直接构造一个请求即可了

```
curl -v -H"Content-Type:" -u "admin:geoserver" --data-binary @1.zip "http://localhost:8080/geoserver/rest/workspaces/xxx/coveragestores/xtest/file.a?file

```

然而并没有这么简单，碰到了第一个坑，后台日志报错，且服务器响应 405

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicYbhAUohJOrvXwVBK4PqgZKSZic5icMLaZict92taBVAZoPfF3HlaGRHXg/640?wx_fmt=png&from=appmsg)

代码中对应的异常在这里，根据上下文发现，其实提交的 workspaceName 和 storeName 他们必须能创建的是一个 StructuredGridCoverage2DReader 类型的实体。

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicMHYaCmiae64UKmujowlNOEKKBnzoCF2vJMpEXzEqX2WmVm6RxAsib0oQ/640?wx_fmt=png&from=appmsg)

好了，到了神坑的第一步了，对于这种专业系统，到底什么样的数据格式才能符合这个要求。抓耳挠腮的查阅了大半天资料，终于在官网接口找到了下面这句话。

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeic12fNfVdppPjmic2Ycylh45TPHyMZic3uS4iaeMFUedZCicaA5Kr7AF9DtA/640?wx_fmt=png&from=appmsg)

也就是说，如果想 post 成功，所谓的 “coverage store is a structured ”，注意后面的 e.g 提到了一个类型 “mosaic”，不管他是什么找一个这个类型的提交试试。在翻了半天 Demo 后，终于找到一个符合要求的。接下来碰到第二个神坑。

用下面命令发送上传请求后  

```
curl -v -XPOST -H "Content-type: multipart/form-data" -F "file=@2.jsp" -u "admin:geoserver" "http://localhost:8080/geoserver/rest/workspaces/xxx/coveragestores/xtest/file.a?filename=../../../2.jsp

```

后台报了如下错误

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeice7PERK5DNFxhfaXpibaDZwoU9smMkNvpoI2jT1xUECym3cqLWajme8w/640?wx_fmt=png&from=appmsg)

代码中原来是有跨目录路径检查的

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicTfja7UawNNPeW5dKe9DyzmicicXTrfgMnVl37rOT3Fm5Pnmv3KuubQtQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeichF6nRftVqX3asUmsJQtIXnVcbqWQpLqLykz4aOCicd3icTZ7y1wYlsicQ/640?wx_fmt=png&from=appmsg)

这一度让我认为该跨路径的 poc 不是通杀 poc，仅在部分低版本中可以使用，既然有路径检查怎么可能上传成功呢，或者是有其他绕过该路径检查的方法。

本来想偷懒不开调试模式，直接硬怼能把 poc 怼出来，但是卡在这里半天还是无奈开调试模式审查代码。本身偷懒的原因也是 docker 容器中启动 java 调试是非常麻烦的事情，这里不赘述（想学习方法的同学，我会放一个详细的过程到小密圈关于 docker 启动 java 调试）  

前置代码流程很简单，直接讲重点，其实关键点在于文件 org/geoserver/rest/util/RESTUtils.java 中对于 directory 的处理，如果 directory 最后处理完的类型是 FileSystemResource

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicOIzuQJZicCM9fMkHy6E63Zpmd662wTr9E7z9lRW0GqmzuS6d81fwKBQ/640?wx_fmt=png&from=appmsg)

那么在 handleBinUpload 函数中处理 directory.get 调用即是触发 FileSystemResource 中的 get 方法，如下图，这将直接导致会调用 Paths.valid 检查，即如果想通过../ 进行目录穿越就会失败。

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicDPn6fKprZLZLknsXBkFUiaAiauejiafvg1lfibPXmvyXX0kSasuoOWLWtg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicSq5Cz3ZEr81llxQgqOJMIyOibicU5Qjiby7BtqricPgNIAP0jiczFYbSvBw/640?wx_fmt=png&from=appmsg)

那么有没有办法绕过呢，答案当然是有的，关键在于计算上传的 root 路径函数 createUploadRoot 时，path 参数非常重要

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicqt88tLp1S38VxsaKcDaRty73m7IMYoBGvdI1YX1oicZkkmt4WrOgf5g/640?wx_fmt=png&from=appmsg)

如果 path 是一个绝对路径时，那么 return 的将不是一个 FileSystemResource 类型的 Directory，而是一个 ResourceAdaptor，而该类型的 get 函数将不再有路径检查，故可以直接跨目录上传文件。

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicHnT1HVsypXdwTYvSITUZ9Xk1kkOj4hJ1eWxxYoMhuKZMgibjfICXarA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicoAd63WPOX7f3sXbaOXPBde0ib4Oiaj5obPMYhRicaMD556wzdcLJrkvxA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicicNk5ssR4s358yicBdLZOXCwN8szS4ADCvBoJaLmgs0j2d1k8j9jZnyQ/640?wx_fmt=png&from=appmsg)

最后调用栈

```
handleBinUpload:131, RESTUtils (org.geoserver.rest.util)
handleFileUpload:70, AbstractStoreUploadController (org.geoserver.rest.catalog)
doFileUpload:457, CoverageStoreFileController (org.geoserver.rest.catalog)
coverageStorePost:120, CoverageStoreFileController (org.geoserver.rest.catalog)

```

**0x04 复现**

我知道有些伸手党肯定直接滑到这里了，介于该 poc 还没完全公开，我也不直接发 poc，有兴趣的同学看了上面的分析肯定能复现出来的。更详细的过程和 poc 发在小密圈，小白和伸手党进圈查看吧。

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeic91gVGaPPRoAYKXQlCpjwCDNicOxyBM213WkO9DupVnDqAfTLpAYMpqQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGBcHriamXMqibDrMMXYMqqeicX16jTIeJcTnMNzxsWsTerTPjwU0WEviawYNHW3MAkicU4jGwC3zsC3EQ/640?wx_fmt=png&from=appmsg)

**0x05 总结**

这种专业的系统审计还是有些费劲，因为某些代码的业务逻辑并非纯 Java 技术所能理解的，例如上述的 StructuredGridCoverage2DReader 问题，查阅了很久的资料，有一定的学习成本。然后就是本身调用栈非常简单，但是在代码阅读水平差的情况下，不开调试模式真的看不懂 trick 在哪里。最后希望复现出来的小伙伴也不要乱打哦。  

**0x06 加入我们  
**

  

后台回复 “加群” 或“小助手”，或扫描下方二维码加入我们的付费圈子，一起进步吧

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybHZicZnvXwW5LnL1bzhuJAoQ7MpUsy3BY3Cibl6curYWucSMSpxJicscm7zwWDWQaaiapo57oc6L5YH2w/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybFMdnMAXpcyiaNPdyoLppiaPO7glCdCXn1WctQuslCotWHfH709HdYlkyYRK3BcTTzIE5UCw1vS1LJQ/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)