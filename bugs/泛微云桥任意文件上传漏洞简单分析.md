<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/_XGhSWT0k_prUbhRZ5MmrQ)

**Part 1 情报来源**

  开局一张图，内容全靠编

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0CYCBibCUE9GwoFT51swzviczKmXHhrVZDom7Ruuicnp7YpDLbciagYD05Q/640?wx_fmt=png&from=appmsg)

**Part 2 配置调试环境**

    首先运行启动脚本 start.sh，然后手动关闭 tomcat 服务

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0oSuezeakQQbiax55MWicCle8bqia4Ye6HXJmnG9G32LclrgOWBhak3iaBQ/640?wx_fmt=png&from=appmsg)

 找到 tomcat/bin/startup.bat 首行写入如下

```
SET CATALINA_OPTS=-server -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0xhiaAk5fnYaVkAmvgAb3Ns1rJo9hkTg8lCs21ECibpEmOziaSD7w7sDQA/640?wx_fmt=png&from=appmsg)

第三步，IDEA 配置远程调试

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0QwicFzIQVuyCaDhXCCkupedkOZIdVich8R2exkq59LpzO5icibXicSmn6jQ/640?wx_fmt=png&from=appmsg)

第四步，测试调试环境是否正常  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0uicthJa1nKhPW7ibhn25ghMv0ItA3tsMBMgOIwu3H7TdkCjcPXQhacEQ/640?wx_fmt=png&from=appmsg)

**Part 3 漏洞分析**

使用 jar-analyzer 定位路由`xx/xx/xx/xx/xxx保命路径/ResumeController`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx06Hyrja12zhQ3W229nQQEMJEV0ucsvyPJZicgTUGXiaTBIjCvew9QOTng/640?wx_fmt=png&from=appmsg)

```
WxBaseFile wbFile = null;
// 判断Content-Type 是不是multipart/form-data开头，是就证明是文件上传的方式
if (this.getContentType().toLowerCase().startsWith("multipart/form-data")) {
   // 进入getWxBaseFile进行逻辑处理
   wbFile = this.getWxBaseFile(this.wxBaseFileService, this.getPara("fileElementId"), (String)null, 2097152, (String)null);
}

```

getWxBaseFile 代码

```
 public WxBaseFile getWxBaseFile(WxBaseFileService wxBaseFileService, String parameterName, String filePath, int fileMaxSize, String fileEncoding) throws Exception {
   //生成filePath路径
        String _filePath = StrKit.isBlank(filePath) ? FileUploadTools.getRandomFilePath() : filePath;
       // 获取文件上传最大值
         int _fileMaxSize = fileMaxSize == -1 ? FileUploadTools.getMaxSize() : fileMaxSize;
         // 文件encoding
        String _fileEncoding = StrKit.isBlank(fileEncoding) ? FileUploadTools.getEncoding() : fileEncoding;
        UploadFile uf = null;
        try {
          // 文件处理逻辑
            uf = this.getFile(parameterName, _filePath, _fileMaxSize, _fileEncoding);
        } catch (Exception var11) {
            Exception e = var11;
            throw e;
        }
        return this.parseUploadFile(wxBaseFileService, uf);
    }

```

进入 getFile 后开始文件操作的旅程，这里跳过其他的直接来到_`com.oreilly.servlet.MultipartRequest#MultipartRequest(HttpServletRequest, java.lang.String, int, java.lang.String, com.oreilly.servlet.multipart.FileRenamePolicy)`_

filePart.writeTo() 方法完成文件的写入

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0NFUPnLaDbx8w3Kt1CWhHNSVq6MEK2p4dTAunyydeJib1mS5d8mNvHTw/640?wx_fmt=png&from=appmsg)

文件也成功落地

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx00qHm6VuqtvWpGnoTSgmW2aoOQP2mNjiaibgIUMuxnHuNgscYmWRVu04A/640?wx_fmt=png&from=appmsg)

但是在`com.jfinal.upload.MultipartRequest#wrapMultipartRequest`处理的时候，对文件做了处理

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0FmWj7yOImxV9qC8P1E7GPGvrgib9vJc0szMK0epMS3ZAicdzyRumq4ww/640?wx_fmt=png&from=appmsg)

isSafeFile()，文件以. jsp 结尾则对文件进行删除

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0M4rL5uiaZ9XeeHSwFDkhR3gkGfHLheIFBeRKBISfgQbPUWHBKHpo8Aw/640?wx_fmt=png&from=appmsg)

文件都落地了，然后你给我删了？然后尝试 jspx，结果发现还是被删？这就让我百思不得骑姐了，后面用 jar-analyzer 去定位这个方法，你可太棒了！

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0fBibB40VYhvbKQ6AkGwWaxMVBrp8v9T7KcnmsGF05UMHiaDod8jVCzkQ/640?wx_fmt=png&from=appmsg)

相信大家也都能看出干了什么事情，那么该如何解决这个删文件的问题呢？

不卖关子喽～。。答案就是使用双文件上传，他会在下面代码中完成俩次文件写入

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx07Cd4T5pnjiasqLzBHzAy9eKpgJnG92FQYbiblQiacS7OBCbPMWQzGE7rg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0JS9lkyvgGNeyOUKpKyd8xdalFNSXBl27U5r4JXxlAGibcFeOpy5Yb9w/640?wx_fmt=png&from=appmsg)

以最后一个存入进去后  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0E8wDwvC9EI9C8U2xbJsov6vZxs2LWDcU4ibiaxbqz8wVgibC2DkMQb00A/640?wx_fmt=png&from=appmsg)

在走到 isSafeFile 函数的时候，进行删除，就会把 2.jsp 进行删除，留下我们的 1.jsp

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0ibhWBgcEH0EGVuicQzicqVtBS7jtG9aUIOrdtx36Ul9ucBdKglYA3ic8xg/640?wx_fmt=png&from=appmsg)

到此分析结束，连一下 webshell 助助兴  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Paq33axNlz7jDoHicarjKLrTp7Rd1vwx0jI53cFHR2V6SLrmUoQotKVSgL52JJD8yqoYlhIZNViccHGY2ALdqKRw/640?wx_fmt=png&from=appmsg)

**Part 4 总结**

*   断点调试 Step into 到了 xxx.java，发现代码和 xxx.java 的字节码 xxx.class 代码不一致
    
*   简单分析，内容浅显，不足之处恳请各位大师傅指正，感谢。