<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/IstZ4r2ljR-uZbMC211qEw)

不得了了，家人们！

就在这几天，Git 爆出了一个严重漏洞，编号`CVE-2024-32002`，一个可以远程执行代码的 RCE 漏洞！

攻击者精心准备一个 Git 项目，只要你尝试去 Clone 它，你的电脑就能执行攻击代码沦陷。

比如下面这个 GitHub 上面的项目：

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1Kiaolucq7rT2FYNajNfAC1qCntsWqVVWn7LTY6NpzRqUH7MXkbZHR2ia2RHpQ/640?wx_fmt=png&from=appmsg)

你可以执行一下下面的命令：

> git clone --recursive git@github.com:amalmurali47/git_rce.git

不出意外的话，你的电脑将会弹出计算器程序：

![](https://mmbiz.qpic.cn/mmbiz_gif/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaoluXEGwx84gvTwF3HDCVGwMbdUllvbIrQy9Q4srXrc8SVt5icdIm126qlA/640?wx_fmt=gif&from=appmsg)

能让你弹计算器，就能执行其他更危险的操作，比如给你种木马等等。

Git 是我们程序员基本离不开的工具，这波漏洞操作，属实是对程序员定向打击了。

接下来我们来理一理这个漏洞的工作原理是怎么样的。

在介绍攻击原理之前，得先来了解几个东西。

1、Git 钩子
--------

在 Git 里面有一个 HOOK 的机制，就是钩子的意思。不过这个 HOOK 不是咱们二进制安全攻击中的那个 HOOK。

Git 中的钩子是一些脚本，这些脚本在 Git 的特定事件发生时自动执行。钩子允许你在 Git 操作的不同阶段执行自定义操作，如代码格式化、测试运行、通知发送等。

Git 设计 hooks（钩子）的初衷是为了让用户能够在特定的 Git 事件发生时自动执行自定义脚本或操作。这些钩子提供了一种机制，可以在 Git 操作的各个阶段插入用户自定义的逻辑，以便实现更强大的自动化和定制化流程。

Git 钩子分为服务端和客户端钩子，在咱们程序员使用的 Git 客户端中，有下面这几个钩子：

> *   `pre-commit`：在提交之前运行。可以用来检查代码格式、运行单元测试等。
>     
> *   `prepare-commit-msg`：在提交信息编辑器打开之前运行。可以用来自动生成提交消息模板。
>     
> *   `commit-msg`：在提交信息编辑器关闭之后运行。可以用来验证提交消息的格式。
>     
> *   `post-commit`：在提交完成之后运行。可以用来发送通知或执行其他后续任务。
>     
> *   `pre-rebase`：在变基操作之前运行。可以用来检查变基前的状态。
>     
> *   `post-checkout`：在 git checkout 命令执行之后运行。可以用来设置特定文件的状态。
>     
> *   `post-merge`：在合并操作完成之后运行。可以用来重新编译项目或执行其他合并后的任务。
>     

那这些钩子脚本是存放在哪里的呢？就是在那个神秘的. git 目录下。

大家可以去看一下自己电脑上，不管是从 GitHub 克隆的项目，还是从公司的 git 服务器克隆的项目，你们的代码目录下，都有一个叫. git 的文件夹，它的目录结构大致是下面这样的：

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaoludrtvpsBp7wVvnofM3aJHUIlcicZNNN9tkfsx8ia6GDnwYjldAskwoib5Q/640?wx_fmt=png&from=appmsg)

当我们创建一个新的 Git 项目时，执行完`git init`后，git 就会为我们创建一个. git 目录。

而我们刚才说的钩子脚本，就放在. git/hooks 里面，git 默认为我们提供了一些钩子脚本的示例。

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaolucsLKhV6v0mUCfWgFxYYNy39UcCvibbEe8jFEsyibictoOstN06gDmKb4Q/640?wx_fmt=png&from=appmsg)

你可以在这里面添加一些自己的脚本程序，这样当你在执行对应的 git 命令操作时，对应的脚本程序就会得到执行。

要注意，.git 目录下的内容，是 git 程序自己在维护，不会受到 Git 项目里的内容的影响。你在上传代码的时候，.git 目录也不会被传到服务器上去。

所以，正常情况下，你从服务器克隆一个项目的时候，只是把项目拉到本地，不用担心执行恶意的 HOOK 脚本，因为. git 目录是你本地的 git 客户端程序创建的，除非你手动去把钩子脚本放到里面去，否则里面是不会有恶意钩子脚本的。

但是，我要说但是了，这一次漏洞的操作就很骚，骚在哪里呢？骚就骚在，它巧妙的利用了一个特性，把攻击脚本给写到. git 目录下面去了！

这是怎么办到的呢？这需要了解另一个 Git 的知识。

2、子模块
-----

子模块是嵌套在一个 Git 仓库中的另一个 Git 仓库，可以让你在一个项目中包含其他项目，比如某个开源项目要依赖于其他的开源项目。

在这种情况下，主项目下面会存在一个. gitmodules 文件，里面会记录该项目包含的其他 Git 项目的信息。

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1Kiaoluhh7N8Kyvs1X1icIUcYBsiaaticbVtibGVAjz7e40CQTUT3A1eNEZIic4KIg/640?wx_fmt=png&from=appmsg)

其中，path 指定子模块存放的位置，url 指定子模块的 Git 仓库地址。

我们在执行 git clone 克隆项目的时候，如果指定了一个递归的参数：`--recursive`，就会在拉取主项目之后，然后根据这个文件中的内容，递归的去拉取所依赖的其他子模块，然后放到对应的文件目录位置。

不仅主项目有一个. git 目录来记录项目相关的信息，子模块也有。你去上面这个 path 目录下去看，会发现这里也有一个. git，不过这个. git 不是一个文件夹，而是一个文件，里面记录了这个子模块对应的真正的. git 目录的位置。

这个位置一般在主项目. git 目录下的 modules 文件夹下面。

3、符号链接
------

接下来了解与这个漏洞相关的第三个知识点：符号链接。

在 Git 中，符号链接（symbolic link，简称 symlink）是指向另一个文件或目录的特殊类型的文件。符号链接本身不包含文件的内容，而是包含指向目标文件或目录的路径。当访问符号链接时，系统会自动重定向到其指向的目标。

简单理解的话，这玩意儿有点像快捷方式。

4、漏洞成因
------

好了，了解了上面这些知识背景，接下来，就要说说这个漏洞的成因了。

刚才说过，钩子脚本位于. git 目录中，而这个目录是与项目本身的内容无关的，它的内容是 git 客户端在维护，除非你手动放置脚本程序到 hooks 目录中，否则项目中的内容是不会跑到. git 目录中的。

而这次漏洞就采用了一个骚操作：

攻击者准备一个 Git 项目，在这个 Git 项目中，又依赖一个子项目。当采用`--recursive`参数的时候，递归去拉取对应的子项目，放到对应的位置。

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1Kiaoluhh7N8Kyvs1X1icIUcYBsiaaticbVtibGVAjz7e40CQTUT3A1eNEZIic4KIg/640?wx_fmt=png&from=appmsg)

就像上面这样，它指示 git，把 url 中的项目拉下来放到`A/modules/x`目录中。

然后骚操作来了：在这个项目下，有一个名字叫`a`的符号链接，并且让它指向了. git 目录。

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaoluSxqrnuadDwsyAu0mY2oHxwB4zGzONia1OuQ1HsUjia6lapjzcL7jKyqg/640?wx_fmt=png&from=appmsg)

因为 Windows 和 Mac 平台的文件和目录名称是大小写不敏感，注意这点很重要，导致在放置子模块到`A/modules/x`的时候，实际上就是放到了`.git/modules/x`目录下去了。

Git 项目内容写到. git 目录下了！事情就出在这里了！.git 目录是 git 程序的私家花园，被项目内容闯了进来！

你可能会问，一定要大小写不一样吗，我直接在. gitmodules 文件里面指定让它写到小写的`a/modules/x`路径下不行吗？

还真不行，我试过了，git 直接报错了：

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1Kiaolu8IGtRCePtsnAvZmxJ4dMApHGaKJXdEwxibcRNGmdmBHRen0V4VN5WUQ/640?wx_fmt=png&from=appmsg)

看来，git 基本的检查工作还是做了的，只是疏漏了大小写不一样的情况。

继续我们刚刚的分析，.git 目录这个 git 程序的私家花园，被人给闯进来了。

而且关键是它闯进来的位置是在`.git/modules/x`下面，前面说过，这个目录下面，是子模块所属的. git 目录，然后这个闯进来的家伙，还按照. git 目录的结构，里面放置一个 hooks 文件夹，里面放上相关的钩子脚本，等下 git clone 完成的时候，就会去执行这里的脚本程序了。

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaoluJDtN9bhk6YSAVISnqMZto2oFW3IBlSU7B2icQmib5jABhVKvcOWuonUA/640?wx_fmt=png&from=appmsg)

克隆完成之后的整个目录结构变成了这样：

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaoluFg6QHEHCxwlg47ZVeZDHB4fISCicok2Z0EXA9PgWp1LxXfNg4lSuWww/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_jpg/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaoluZJ6XhGlH6xtiaFMVJch2b8bzTsau7UuKtKr5ZMrB0ZHEnT9Hs7jwMJA/640?wx_fmt=jpeg)

我用 procmon 抓了一下执行下面这条克隆命令到弹出计算器进程中间的过程

> git clone --recursive git@github.com:amalmurali47/git_rce.git

大家从进程的父子关系树和进程的命令行参数，就能看到这条攻击链路了：

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaolusvwBrtYmuIfwicrWVcGlgfibQhrSkcn3icZswkwWubyNzn1fKns35XqEA/640?wx_fmt=png&from=appmsg)

最后总结一下：

1、攻击者精心构造了一个 Git 项目，这个项目依赖一个子项目，并且指定了这个子项目存储的路径为 A。

2、在这个 Git 项目下，有一个名为 a 的符号链接，指向了. git 目录。

3、子项目里面构造了一个 hooks 目录，攻击脚本存放在里面。

4、最后，递归克隆项目的时候，因为目录大小写不敏感的原因，子项目实际上被写到了. git 目录下。

5、相关的克隆动作，触发了`post-checkout`钩子的执行，而现在的 hooks 目录下，被写入了攻击者的恶意钩子脚本，于是就执行了这个恶意脚本。

Windows：

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaoluAiaZAOffjhRI4Oq39iadYhlCicqS4wbA3KUb4LsoY5WIf5Xo9fcicDmLiaQ/640?wx_fmt=png&from=appmsg)

Mac：

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaoluA7wZnVcd32Ig105tRToDVcydXmRXDCf0gFLfCLe5FgLjpzXdEheQnw/640?wx_fmt=png&from=appmsg)

以上就是本次漏洞的大致过程了。

本次漏洞受影响的版本有：

> *   v2.45.0
>     
> *   v2.44.0
>     
> *   <=v2.43.3
>     
> *   <=v2.42.1
>     
> *   v2.41.0
>     
> *   <=v2.40.1
>     
> *   <=v2.39.3
>     

赶紧来执行 git --version 看看你的版本有没有在上面的范围里，是的话赶紧升个级吧！

![](https://mmbiz.qpic.cn/mmbiz_png/jXQDbLkGBYV3UXdz8XD7ibvM75X1KiaoluSSeS1ISaibuOPNrVz4I7AF6hDx104QBkT9O1Ccx9K6KuiaNYEz1QKy9w/640?wx_fmt=png&from=appmsg)

温馨提示：**陌生人发来的 Git 项目链接，不要随意去克隆，小心被攻击哦~**

我是轩辕，都看到这里了，顺手点个关注再走呗~

最近公众号的推送真的一言难尽，全靠标题党吸眼球，很多干货文章都无法及时推送给大家，希望大家把公众号点个星标，轩辕先谢谢大家啦！

往期推荐
----

*   [程序员赛道太卷，逆向工程师怎么样？](https://mp.weixin.qq.com/s?__biz=MzIyNjMxOTY0NA==&mid=2247500286&idx=1&sn=394d9893064030f695ef9bc7cf2c28c1&scene=21#wechat_redirect)
    
*   [核弹级漏洞！我把 log4j 扒给你看！](https://mp.weixin.qq.com/s?__biz=MzIyNjMxOTY0NA==&mid=2247493241&idx=1&sn=25a4f5e770dabb10a8abe96f692d7391&scene=21#wechat_redirect)
    
*   [可怕！CPU 暗藏了这些未公开的指令！](https://mp.weixin.qq.com/s?__biz=MzIyNjMxOTY0NA==&mid=2247495061&idx=1&sn=692ba561fed0f7ae6865f2b8da8fbffd&scene=21#wechat_redirect)
    
*   [我是 Redis，MySQL 大哥被我害惨了！](https://mp.weixin.qq.com/s?__biz=MzIyNjMxOTY0NA==&mid=2247486528&idx=1&sn=3f7b09eb21969fdb16f5b0805ff69fed&scene=21#wechat_redirect)
    
*   [CPU 被挖矿，Redis 竟是内鬼！](https://mp.weixin.qq.com/s?__biz=MzIyNjMxOTY0NA==&mid=2247493024&idx=1&sn=8b055fdaffb7455ffea23a9915adfca8&scene=21#wechat_redirect)