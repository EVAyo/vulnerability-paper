<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/KEGP6TJ3Juc41PDkdXn5Pg)

之前发过消息。

[古河大佬发现的最新漏洞：Windows LDAP RCE 漏洞（9.8）](https://mp.weixin.qq.com/s?__biz=MzkzNDIzNDUxOQ==&mid=2247493131&idx=1&sn=53054222a61d0f4f5bb380d9a1332acb&token=590933123&lang=zh_CN&scene=21#wechat_redirect)

SafeBreach Labs 研究人员开发了一个零点击概念验证漏洞利用程序，可以通过 Windows 轻量级目录访问协议 (LDAP) 远程代码执行漏洞使未打补丁的 Windows 服务器崩溃。

在组织的计算机网络中，Active Directory 域控制器 (DC) 被视为最重要的核心资产之一。在 DC 中发现的漏洞通常比普通工作站中发现的漏洞更为严重。通过 DC 运行代码或提升用户权限的能力会严重影响网络安全态势；这将使攻击者能够完全控制该域下的所有代理和服务器。

2024 年 12 月 10 日，由`古河Yuki Chen(@guhe120)`发现的一个影响所有 DC 的远程代码执行 (RCE) 漏洞作为最新 "补丁星期二" 更新的一部分在微软安全响应中心 (MSRC) 网站上公布。这个漏洞被标记为 CVE-2024-49112，并获得了 9.8 分的 CVSS 评分。然而，目前还没有公开的漏洞利用程序或博文解释这个漏洞及其利用路径。

长话短说
====

* * *

SafeBreach Labs 为 CVE-2024-49112 开发了一个概念验证漏洞利用程序，只要受害 DC 的 DNS 服务器具有互联网连接能力，就可以使任何未打补丁的 Windows 服务器（不仅仅是 DC）崩溃，无需其他前提条件。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXpoHz9uRvbo6ULBghtkYWQKquflthjLxP21RK1Y2KiafEIZaO7m270Aw/640?wx_fmt=png&from=appmsg)

攻击流程：

1.  攻击者向受害服务器发送 DCE/RPC 请求
    
2.  受害者被触发向 SafeBreachLabs.pro 发送 DNS SRV 查询
    
3.  攻击者的 DNS 服务器响应攻击者的主机名和 LDAP 端口
    
4.  受害者发送广播 NBNS 请求以查找收到的主机名（攻击者的）的 IP 地址
    
5.  攻击者发送带有其 IP 地址的 NBNS 响应
    
6.  受害者成为 LDAP 客户端并向攻击者的机器发送 CLDAP 请求
    
7.  攻击者发送带有特定值的 CLDAP 引用响应数据包，导致 LSASS 崩溃并强制重启受害服务器
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXbqRLicK43TdFqQw2qBoyIKc6yChTqpmwZaVWYvx9PaaN3MRaKnicHSPQ/640?wx_fmt=png&from=appmsg)

我们认为我们的发现具有重要意义，原因如下。首先，我们通过证明该漏洞可以用来使多个未打补丁的 Windows 服务器崩溃，展示了该漏洞的严重性。根据微软的分类，这个漏洞可以进一步被利用导致远程代码执行。其次，我们确认微软的补丁修复了整数溢出漏洞，该漏洞利用程序无法使打了补丁的服务器崩溃。最后，我们提供了一个公开的概念验证工具，组织可以用它来测试和验证其服务器是否受到保护。更多详细信息，请参见本文末尾提到的 GitHub 仓库。

技术深入分析
======

* * *

下面，我们将解释 SafeBreach Labs 研究团队如何识别触发漏洞并使 DC（或任何 Windows 服务器）崩溃的利用路径的具体技术细节，提供逐步利用总结，并分享一个执行这些步骤的概念验证 (PoC) 工具。

### **CVE-2024-49112**

CVE-2024-49112 被命名为 "Windows 轻量级目录访问协议 (LDAP) 远程代码执行漏洞"。LDAP 是微软 Active Directory 中工作站和服务器用来访问和维护目录服务信息的协议。漏洞的标题表明漏洞可能与 LDAP 相关代码有关。在 MSRC 的 CVE 页面上，微软提供了以下背景信息：

*   " 攻击者如何利用这个漏洞？
    
*   成功利用此漏洞的远程未经身份验证的攻击者将能够**在 LDAP 服务的上下文中执行任意代码**。但是利用的成功与所针对的组件有关。
    
*   在利用域控制器作为 LDAP 服务器的情况下，攻击者必须向目标发送特制的 RPC 调用以触发对攻击者域名的查找才能成功。
    
*   在利用 LDAP 客户端应用程序的情况下，攻击者必须说服或欺骗受害者对攻击者的域名进行域控制器查找或连接到恶意 LDAP 服务器才能成功。但是，未经身份验证的 RPC 调用将不会成功。
    

基于这些信息——并假设微软的文档准确——我们做出了以下假设：

1.  攻击者不需要进行身份验证
    
2.  漏洞是一个整数溢出类型，源自实现 LDAP 客户端逻辑的可执行文件或动态链接库 (DLL)
    
3.  我们可以利用 RPC 调用来影响 DC 查询攻击者控制的 LDAP 服务器
    
4.  在 DC 的上下文中，漏洞可能存在于`lsass.exe`或它加载的 DLL 之一中，因为`lsass.exe`在 DC 上实现 LDAP 服务
    
5.  因此，具有易受攻击的 LDAP 客户端代码的 RPC 接口也位于 lsass.exe 或它加载的 DLL 之一中
    

此外，我们还在 X 上发现了 Artur Marzano(@MacmodSec) 的一个有趣见解，暗示微软对漏洞的补丁可能在`wldap32.dll`中：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXusiamDDKYiaTczdwsTzWEVxVkJk5pvOjhj21ENvInP5W6ibsS9biaTse9g/640?wx_fmt=png&from=appmsg)

这个见解与 MSRC 网站上的文档完全吻合，因为`wldap32.dll`实现了 LDAP 客户端的逻辑。

### **触发远程 LDAP 请求**

我们首先证明了针对 DC 利用的第一步——影响它查询我们控制的 LDAP 服务器。我们需要找到一个源自`lsass.exe`本身或加载到`lsass.exe`中并从`wldap32.dll`导入函数的 DLL 中的 RPC 调用。使用 RpcView，我们列出了加载到`lsass.exe`中的可用 RPC 接口：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXsYQCyOdq7dObhgRb9MWeAmQCp9RmFPUibNduMicqwAAEw2DmzgwhRpZg/640?wx_fmt=png&from=appmsg)

在这些 RPC 接口中，我们只列出了那些来自依赖 wldap32.dll 并使用其导出函数的 DLL 的接口。我们在寻找不需要身份验证的 RPC 接口，因为我们假设攻击者不需要进行身份验证。我们发现了两个有趣的接口，它们提供了几个看起来与 LDAP 查询相关并可能触发查询的有趣命名的 RPC 调用，它们位于`lsasrv.dll`和`netlogon.dll`中：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXnnBngdC0DkeHFfzrBEakhe9icZibaNT4XF8uG7MKiaPTNbwmMS8WE8tug/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXiaiaBHITbhIeOWAOknE29sAYI13oChn7rwFJE6qcQAfQtOppFz3J5ic6A/640?wx_fmt=png&from=appmsg)

使用 IDA，我们自下而上搜索活跃使用从 wldap32.dll 导入的函数的 RPC 调用。经过长时间搜索，我们找到了 DsrGetDcNameEx2。根据微软的文档：

"DsrGetDcNameEx2 方法应该返回指定域和站点中域控制器 (DC) 的信息。如果 AccountName 参数不为 NULL，并且在此方法调用期间有一个匹配所请求能力（如 Flags 参数中定义）的 DC 响应，那么该 DC 将已验证 DC 账户数据库中包含指定 AccountName 的账户。

NET_API_STATUS DsrGetDcNameEx2(

[in, unique, string] LOGONSRV_HANDLE ComputerName,

[in, unique, string] wchar_t* AccountName,

[in] ULONG AllowableAccountControlBits,

[in, unique, string] wchar_t* DomainName,

[in, unique] GUID* DomainGuid,

[in, unique, string] wchar_t* SiteName,

[in] ULONG Flags,

[out] PDOMAIN_CONTROLLER_INFOW* DomainControllerInfo

);"

这个函数看起来很有希望。它主动检索域控制器的主机名，并验证特定账户是否存在于其中。域名和账户都由调用者指定。这意味着如果该函数使用 LDAP 来完成其目的，我们就有了所需的东西。

接下来，我们需要理解 DsrGetDcNameEx2 的每个参数及我们将为它们设置的值：

*   ComputerName：目标 DC 的主机名 – 这将设置为受害者的主机名（进一步研究发现这个值对函数完全没有影响）
    
*   AccountName：将在查询的攻击者域中搜索的账户名称 —可以是任何名称—我们不关心它是否存在
    
*   AllowableAccountControlBits：控制将查询关于 "AccountName" 的什么内容 – 可以是 0 – 我们并不真正关心被查询的账户
    
*   DomainName：将被查询的域 – 我们将其设置为**攻击者的域名**
    
*   SiteName：DC 必须位于的站点 – 可以设置为 NULL
    
*   Flags – 调用的额外配置 – 我们首先想要默认行为，所以设置为 0
    
*   DomainControllerInfo – 输出参数，返回的信息将放在这里
    

为了测试目的，我们在同一子网中安装了两个新的 DC，并在每个 DC 中创建了两个新的根域。一个叫做`SBRESEARCH.LAB`，另一个叫做`TESTDOMAIN.LAB`。目标是在`SBRESEARCH.LAB`的 DC 上运行（攻击者），并让`TESTDOMAIN.LAB`的 DC（受害者）查询`SBRESEARCH.LAB`的 DC 上的 LDAP 服务器。

因此在攻击者 DC 上运行时，我们在受害者 DC 上调用了 DsrGetDcNameEx2 函数。调用的参数是：

*   ComputerName – WIN-ELD41******
    
*   AccountName – blabla
    
*   AllowableAccountControlBits – 0
    
*   DomainName – SBRESEARCH.LAB
    
*   SiteName – NULL
    
*   Flags – 0
    

这还不够。在 Wireshark 中查看受害者发送和接收的数据包时，我们没有看到受害者发起任何 LDAP 请求。然而，Wireshark 确实向我们展示了一些其他非常有趣的东西。我们看到受害者向其 DNS 服务器发送了关于 SBRESEARCH.LAB 子域的 DNS 查询。DNS 查询收到了一个错误代码，说明 DNS 服务器没有找到关于该域的任何记录。然后这一切就说得通了。受害者 DC 获得这个查询的成功答复的唯一方法是如果攻击者 DC 是其 DNS 服务器。但我们不能就这样改变 DC 的 DNS 服务器；仅此一点就可能被视为一个漏洞：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXnAocUxHiccyz45O0nb0YU2mtlArKr3vTCCBWgONsZM9pos7yFgZH8nw/640?wx_fmt=png&from=appmsg)

发送的特定 DNS 查询是 SRV 类型。DNS SRV 查询指定一个域名，在响应中映射到另一个域名和端口。受害者 DC 发送的两个查询的完整域名是：

*   _ldap._tcp.Default-First-Site-Name._sites.dc._msdcs.SBRESEARCH.LAB
    
*   _ldap._tcp.dc._msdcs.SBRESEARCH.LAB
    

看起来受害者 DC 确实在寻找我们攻击者域上的 LDAP 服务器。如果我们能让这个 DNS 查询成功解析，那么受害者可能就会发起 LDAP 查询。但如果我们不能改变受害者的 DNS 服务器，我们还能做什么？

我们是否必须控制受害者的 DNS 服务器才能让查询成功解析？受害者的 DNS 服务器不知道 SBRESEARCH.LAB，但它知道其他域名。并非所有被受害者 DNS 服务器知道的域名都是手动配置的。这个 DNS 服务器当然知道 "google.com"。谷歌是如何让这个 DNS 服务器知道它的？他们在互联网上购买了一个域名，所以我们也这样做了。

我们购买了域名 "safebreachlabs.pro" 来创建两个 SRV 记录：

*   _ldap._tcp.Default-First-Site-Name._sites.dc._msdcs.safebreachlabs.pro
    
*   _ldap._tcp.dc._msdcs.safebreachlabs.pro
    

这些 SRV 记录需要返回一个域名（不支持 IP）和一个端口，受害者可能会将其作为 LDAP 服务器进行联系。乍看之下，这似乎意味着受害者必须联系一个在互联网上有公共 IP 的 LDAP 服务器，这是我们不希望有的要求，因为防火墙可能会阻止这种通信。但是，如果我们已经可以访问 DC 的子网，我们也许可以将 SRV 记录返回的域名设置为我们在子网中控制的计算机的主机名。因此，我们将这两个 SRV 记录映射到攻击者 DC 的主机名，以及端口 389（其 LDAP 服务器）。

接着，我们进行了另一次测试。在攻击者 DC 上运行时，我们再次在受害者 DC 上调用 DsrGetDcNameEx2 函数，但这次将 DomainName 参数改为 "safebreachlabs.pro" 而不是 "SBRESEARCH.LAB"，这次成功了。受害者 DC 向我们的攻击者 DC 发出了 LDAP 查询。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXw9VC0ZtaCnbhKWRNTMoSlLgoaLgjia9dnWHojaocyujGRKPal5rwz8g/640?wx_fmt=png&from=appmsg)

如上图所示，查询是以无连接 LDAP（CLDAP）的形式发送的，使用 UDP 而不是 TCP。使用 Windbg，我们能够验证即使这个请求是通过 CLDAP 进行的，它仍然是由 wldap32.dll 执行的。

### **发送恶意 LDAP 响应**

一旦我们成功让受害者 DC 查询我们的攻击者 LDAP 服务器，我们就可以继续研究该查询的响应中需要包含什么内容。这是为了让受害者执行 Artur Marzano 发现的假定易受攻击的函数 – LdapChaseReferral。

引用允许 Active Directory 树在多个 LDAP 服务器之间分区。当 LDAP 服务器无法回答请求时，它可以回复引用到其他可能提供查询答案的服务器。然后，客户端可以 "追踪" 这些引用并转而查询被引用的服务器。重要的是要注意客户端并不是必须 "追踪" 这些引用。然而，在我们的例子中它确实会追踪它们。

为了让服务器表明它没有查询的答案并将客户端引导到不同的服务器，它需要用 "referral" LDAP 结果代码（等于 10）回复。响应还必须包含有效的 LDAP URL（以 "ldap://" 或 "ldaps://" 开头）。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXuKFLbKCDAu8VeosSjGLHDfLGBBoXTYcwsS7BXuPFRvm1bMWG2enib1A/640?wx_fmt=png&from=appmsg)

回到我们的利用场景，为了触发 LdapChaseReferral 函数，我们创建了自己的自定义 LDAP UDP 服务器，允许我们发送这样的引用响应数据包。

查看补丁的逻辑，微软添加了一个条件，验证某个值不大于另一个值。根据这个逻辑旁边打印的日志，这些比较的值被命名为 "lm_referral" 和 "referral table size"。"lm_referral" 取自 "ldap_message" 结构体（可能是我们的响应消息），而 "referral table size" 取自 "ldap_connection" 结构体。该条件检查 "lm_referral" 值是否在 "referral table" 范围内。这个范围就是 "referral table size"。

在没有补丁的易受攻击版本中，这个 "lm_referral" 值确实被用来访问引用表内的某个偏移量：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauX3Rc1SnEfaJ8hmicHzONuRBp7HHaMNJjWqYYtny4BXkNo2hA3vwiar06w/640?wx_fmt=png&from=appmsg)

在我们使用 Windbg 进行的测试中，我们看到 "lm_referral" 中的值总是等于 0，而引用表的指针也等于 0。但是，决定代码是否访问 "referral table" 的条件只验证 "lm_referral" 值是否不为零。这意味着为了触发漏洞，我们必须控制 "lm_referral" 变量并使其非零。如果我们成功了，那么代码将解引用一个我们可以用 lm_referral 的值控制的指针。

搜索 "ldap_message" 结构体中 "lm_referral" 变量被填充的位置，我们在 wldap32.dll 中查找使用 "lm_referral" 在 "ldap_message" 结构体中的偏移量 (+0x3C) 的其他位置。这导致了两个函数：LdapInitialDecodeMessage 和 LdapChaseReferral：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXFNvXvRO3aZ3KQoufg5k4fYG7yM0rKccvT7QA26g0PU8oVibuFZPJStg/640?wx_fmt=png&from=appmsg)

然后我们识别出在 LdapInitialDecodeMessage 中设置 "lm_referral" 的代码：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXYBsHaYKWXDskpUicXBSmDKLDpBn9sNYC2R9oDTXScTNp4ZDhiaSGjxzQ/640?wx_fmt=png&from=appmsg)

我们看到 "msgid" 和 "lm_referral" 是从数据包的同一部分获取的。在上面的截图中，由于向右移位 25 位，"value_from_response_packet" 必须是一个 4 字节的 DWORD，才能使 "lm_referral" 成为非零 WORD。

在我们使用自定义 UDP LDAP 服务器发送的默认响应数据包中，我们可以完全控制 "value_from_response_packet" 的值（如上面截图所示），它是一个字节长。我们了解到这个值前面带有其长度。

然后我们明白了为了设置 "lm_referral" 的非零值需要做什么：

*   将表示 "value_from_response_packet"（"lm_referral" 和 "lm_msgid" 的组合）长度的字节从 1 改为 4。
    
*   现在 "value_from_response_packet" 是 4 字节长，我们可以设置其最高有效字节，这将影响 "lm_referral"。请记住，我们只能将这个字节设置为可以被 2 整除的值，否则我们会影响 "lm_msgid" 的值
    

这两个操作将代码流指向易受攻击代码的范围，并在解引用发生时创建一个访问违例：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXMvkAicgibOlGGouKWfP3KvIxZbOiaibBwbE0lgXQ1Uc2ep1gmcLOLcPVyg/640?wx_fmt=png&from=appmsg)

由于 "ref_table" 等于 NULL，而 "lm_referral" 此时是一个非零值，上图中最后一行代码将触发对一个不存在地址的解引用。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/KgxDGkACWnRK6TbyQOyFlNja6b3mkiauXPSUib3ApR9rWQPlGicIwGAgk5HQib1uTlf4lYvKMjJrib1HJGsicibgNSJpg/640?wx_fmt=png&from=appmsg)

后续步骤
====

* * *

基于这里概述的初步研究，我们将继续努力实现完整的 RCE 链。为了不崩溃，并继续利用，我们计划找到一种方法为引用表分配一个非 NULL 值，同时为 "lm_referral" 设置一个值，使代码解引用这个表之外的地址。

我们已经创建了一个研究仓库，其中包含了 LDAP Nightmare 漏洞利用的概念验证，组织可以用它来测试和验证其服务器是否受到这个漏洞的保护。

### 受影响的 Windows 服务器

* * *

虽然我们的研究集中在测试 Windows Server 2022（DC）和 Windows server 2019（非 DC），但我们相信这个利用路径和概念验证适用于补丁之前的任何 Windows Server 版本。

### 缓解措施

* * *

为了缓解这个漏洞的风险，组织应该实施微软发布的补丁，详细信息**在这里** (`https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49112`)。如上所述，SafeBreach Labs 验证了该补丁足以防止测试服务器被利用和崩溃。我们认为修补这个漏洞刻不容缓，但也理解修补 DC 和 Windows 服务器必须谨慎小心地进行。

因此，我们建议组织在可以应用补丁之前，实施检测来监控可疑的 CLDAP 引用响应（带有特定的恶意值）、可疑的 DsrGetDcNameEx2 调用和可疑的 DNS SRV 查询。

结论
==

* * *

这项研究旨在探索 LDAP CVE-2024-49112 漏洞是否可以被利用。我们的研究证明它不仅可以针对域控制器进行利用，还会影响任何未打补丁的 Windows 服务器。此外，我们提供了一个用于测试目的的漏洞利用概念验证，在上面的部分中已经提到。

### **致谢**

我们还要感谢以下才华横溢的个人的工作：

*   Yuki Chen (@guhe120) – CVE-2024-49112
    
*   Artur Marzano (@MacmodSec)
    

### **关于我们的研究人员**

*   Or Yair (@oryair1999)
    
*   Shahak Morag (@ShahakMo)
    

### 参考

*   博客原文：https://www.safebreach.com/blog/ldapnightmare-safebreach-labs-publishes-first-proof-of-concept-exploit-for-cve-2024-49112/
    
*   github 项目 exp 地址：https://github.com/SafeBreach-Labs/CVE-2024-49112