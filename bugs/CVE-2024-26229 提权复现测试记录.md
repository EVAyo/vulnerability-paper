<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-I7ymVTU_xnHKhvQTHxuFA)<table data-mpa-powered-by="yiban.io"><tbody><tr><td width="557" valign="top" height="62"><section><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

现在只对常读和星标的公众号才展示大图推送，建议大家把潇湘信安 “设为星标”，否则可能看不到了！

这篇记录文是在 @IIX Fiber 师傅帮助下完成的，同时也感谢群里 @Maytersec、@天明、@程哥、@阿柳几个师傅给提供的测试环境和帮着一起测试。

**0x01 漏洞描述**

CVE-2024-26229：Windows CSC 服务特权提升漏洞，csc.sys 驱动程序中带有 METHOD_NEITHER I/O 控制代码的 IOCTL 地址验证不正确。当 IOCTL 使用 METHOD_NEITHER 选项进行 I/O 控制时，IOCTL 有责任验证提供给它的地址，如果验证缺失或不正确，攻击者可以提供任意内存地址，从而导致代码执行或拒绝服务。

**0x02 影响版本**

从下文链接和本次测试看，应该从`Win10 ≥1809`版本之后都有受到影响，包括到 Win11 的 23H2，1809 之前的版本由于没测试环境（不太确定），目前只测试了以下 4 个版本。

```
https://www.avesnetsec.com/vulnerabilities/cve-2024-26229

```

```
Windows 10 1909（Success）
Windows 10 20H2（Success）
Windows 11 22H2（Success）
Windows 11 23H2（Success）
[...SNIP...]

```

**0x03 漏洞复现**

**一、利用条件**

这个提权漏洞的利用需要目标主机启用`csc`服务，可以使用`sc qc csc`命令查询，START_TYPE 为`DISABLED`禁用（左图），`SYSTEM_START`启用（右图）。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVialp3Jg21VncuxPb0sxCLzxfb6WfmYvYw5M964qfdgqZXOPK8VIjZYQ/640?wx_fmt=png&from=appmsg)

2008/2012 没有这服务（无法利用），2016/2019/2022 倒是有这服务，但是默认都禁用了，而且没法启动，WinObjEx64 中也没有找到`csc`，Win10 有。

```
https://github.com/hfiref0x/WinObjEx64

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVtzzNFSqJrmgjbzfiafyiaNqVl3sconEMD3tpcFjEYSyfLBoMrs2ZuyqQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVDhkV1J1ZWkP3gMKNz6gv0mWD4mN4kqCqLUricUxu7KWrFWLOP5oTiaTQ/640?wx_fmt=png&from=appmsg)

**二、利用方式**

只需将免杀木马文件名改为`cmd.exe`放在 exp 目录下即可，默认优先执行这个目录下的`cmd.exe`，如果该目录下没有 cmd.exe 才会去执行 System32 下的`cmd.exe`。

```
https://github.com/RalfHacker/CVE-2024-26229-exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVQCUrGClkyNeQkbJITkxgDWWlM26Bia1ZibOFOnklibDMam4ZNEaRI7Q1Q/640?wx_fmt=png&from=appmsg)

刚出的 CVE-2024-26229-BOF，比上边这工具利用起来更简单更好（内存执行，无需落地），使用`inline-execute`执行 BOF 文件即可将当前 Beacon 提升为 SYSTEM。

```
https://github.com/NVISOsecurity/CVE-2024-26229-BOF

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVhsyzFg2c4ZxLD6T2ojia1xnXpiaNLS7WGBlzw5gvHlezTHoc7mtSCeQA/640?wx_fmt=png&from=appmsg)

**0x04 其他问题**

**问题 1：**

默认源码编译的 CVE-2024-26229.exe 在 Win10 20H2 利用成功，但在 Win10 1909 执行时会提示找不到`vcruntime140.dll`，需手动上传这个文件。  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVDyibnAUETHXibj2dwIofpVlZauMVcodsl14beQxEEw2Nmsc0xtkekWwQ/640?wx_fmt=png&from=appmsg)

有的 exp 在执行时会遇到缺少 dll 文件的情况，我们可以尝试在 Visual Studio 将编译模式改为`MTd`，默认为`MDd`模式，不过`MTd`编译的文件要比`MDd`大不少。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVickKkhMTeYRAjlKO8ianS5MJEKGOicibuicGKLdY5mbZSg8UdiannY6Gdtcw/640?wx_fmt=png&from=appmsg)

**问题 2：**

Win10 1909 上传`vcruntime140.dll`后再执行 exp 并没有再报错，但还是之前的低权限...，这种情况可能是`Token`不对，可以用`windbg`看下偏移。

```
https://developer.microsoft.com/zh-cn/windows/downloads/windows-sdk/

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXV8tEwAA9jhLxQYiaT6MbZaibEXwxRUkicgmdwOQW6WtJhut7xuTSO0lM0g/640?wx_fmt=png&from=appmsg)

打开 windbg -> Ctrl+E -> CVE-2024-26229.exe -> 输入`dt _eprocess`命令，可以看到 Win10 1909 的`Token`偏移为`0x360`，不同 Windows 版本`Token`偏移也不同。

```
Win10 1909 token：0x360
Win10 20H2 token：0x4b8
Win11 22H2 token：0x4b8
Win11 23H2 Token：0x4b8
[...SNIP...]

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVbUZOWU3uxFvzB9XeO1iawJ2FzsyA6uVmwrb5WFrZ3Pr0Xyxgf0n5ricw/640?wx_fmt=png&from=appmsg)

**注：**通过 Google 查找相关资料，看了下各个版本的 `Token`偏移，应该是从`Win10 2004 (20H1)`这个版本开始`Token`偏移才发生的变化，之前的是`0x360`，之后的都是`0x4b8`。

```
https://keramas.github.io/2020/06/21/Windows-10-2004-EPROCESS-Structure.html

```

然后将`CVE-2024-26229-exploit`项目源码中的 Token 偏移`0x4b8`改为`0x360`，`CVE-2024-26229-BOF`项目也一样，都得改下`Token`偏移才能在 Win10 1909 中利用。

```
gcc -c CVE-2024-26229-bof.c -o CVE-2024-26229-1909.o

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVnM6gnXXXvcwg6j6dCfUgHBF58YaFdLjQiaKNTJA2ZbFcFibwN0JSh80w/640?wx_fmt=png&from=appmsg)

**Win10 1909 + CVE-2024-26229-exploit：**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVt36dzbbibOYr9csu0s7WuZM1AW44qLgADLxok5DSCibfVgO5SQuZESIw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVRn6N007RaMeHPzmLiaBAesy353YWTp3ockf362D6NVuaicqRnp4d9ztQ/640?wx_fmt=png&from=appmsg)

**Win10 1909 + CVE-2024-26229-BOF：**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXV5VxHhibdEeqzzgGzfdj2EtgKq3R1usEuiaCClMLpvYPZ09esfQN6j88A/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVWnQb8MVuPLUCF2Buq3MoMRyjzOABLfbib3BEJ3UNhjLe244Wiba33gLQ/640?wx_fmt=png&from=appmsg)

**0x05 文末总结**

我们在实战项目测试中如果遇到`Win 10/11`时可以试试用这个 exp 来提权，而且大概率能绕过一些防护的拦截，但`Win Server`估计都提不了，实在没办法时可以试试…！  

已将这个提权工具集成到`PostExpKit`插件中，支持在权限提升模块和`Beacon`命令下两种使用方式，感兴趣的师傅可在下方加入星球下载测试。

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/XOPdGZ2MYOdZ5JPhnicOpROWLXjJv3tXVNuyp7s8k0RicWU2wtYDKhpYHgersLlCWzThP0YiazPAYekQxfeW2PCog/640?wx_fmt=gif&from=appmsg)

**0x06 参考链接**

```
https://xz.aliyun.com/t/13434
https://forum.butian.net/share/2333
https://wonderkun.cc/2021/08/22/windows10内核态提权方法汇总
https://www.techthoughts.info/windows-version-numbers/

```

**关注我们**

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1) 还在等什么？赶紧点击下方名片开始学习吧！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**知 识 星 球**

  

  

仅前 1-400 名: 99¥，400-600 名: 128¥，600-800 名: 148¥，800-1000 + 名: 168¥，所剩不多了...！

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOcKGNyJ8jSPNpMahribWIY2cut8eAiakTpr6lAzlLt1xubcuUg4la0LMHmhnENia4icnjOwTsfDqq4I7A/640?wx_fmt=png&from=appmsg)

**推 荐 阅 读**

  

  

  

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe2nibXhkXA8A79MhARiaW5Q0H2aiaR0OwyR63JAI1pRGAc7FZMgIHb9kicboQziaJkTbnlAgOvkdiaHf5g/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247499188&idx=1&sn=9ce15a0e66b2595285e544aaa0c49c24&chksm=cfa559a7f8d2d0b162f00e0c1b02c85219f2668c282b32967b2530f15051b47b21ee2855a783&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe2nibXhkXA8A79MhARiaW5Q0ibIORUp7SmHhzy2uyXKsgn7YwfdjIpZDFx0vT7AJDMtqKf9l5WCzIIQ/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247496043&idx=1&sn=4daa27ade9915de6021fea1c2a21d7bc&chksm=cfa55578f8d2dc6ef887ce27215f942ec233320fa6878bc1666ce0fecb0e7f6c7f96a3ba4e2b&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf8eyzKWPF5pVok5vsp74xolhlyLt6UPab7jQddW6ywSs7ibSeMAiae8TXWjHyej0rmzO5iaZCYicSgxg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdAPjIVeN2ZahG9ibP0Y3wlfg6BO1WO7MZfo1JeW7zDWcLSTQ5Ek8zXAia5w1nMnogpbpXP6OxXXOicA/640?wx_fmt=png)