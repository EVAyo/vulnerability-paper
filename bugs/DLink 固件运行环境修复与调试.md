<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/wq7tkRoWnjxKYppeBajX2g)

> > 招新小广告运营组招收运营人员、CTF 组诚招 re、crypto、pwn、misc、合约方向的师傅, 长期招新 IOT+Car + 工控 + 样本分析多个组招人有意向的师傅请联系邮箱
> > 
> > admin@chamd5.org(带上简历和想加入的小组

在进行路由器固件分析的时候往往需要将固件模拟运行，通常 firmAE 和 FAP 等集成模拟工具是很好的选择，但是并不是所有的固件都可以模拟成功，部分固件运行依赖硬件，这就需要修复固件的运行环境，实现固件的模拟。

以 dlink dir619l 为例, 使用 firmAE 和 FAP 模拟均未成功。所以这里采用 qemu 对此固件进行模拟。

qemu user mode:

首先使用 binwalk 解包固件，将 qemu-mips-static 拷贝过来。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCTntNEVia0NNVMb78EuP4duCcI0Voe8zicrE9d2wWxWDZZzicxB2TwoBzw/640?wx_fmt=png&from=appmsg)

尝试运行程序，报 MIB 错误

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCJdibTicVAvV8wkAgoU0ODjHbXbeqKoqMuJiaa3uITjelicOEiblMQuPric3A/640?wx_fmt=png&from=appmsg)

ida 找到字符串的引用，分析这部分代码逻辑

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCMhbAtaoAoxGIf6EYfsDxowahVwN2uLcd1VLU8ibAYMZJQW5wWuialMkQ/640?wx_fmt=png&from=appmsg)

apmib_init 这个函数是从 flash 中读取 mib 值到 RAM 中，模拟环境没有 flash 硬件，所以应该会读取失败。apmib_init 读取数据失败返回 0，赋值给，然后命令对 v0 进行检测，若为 0，则回显初始化失败，报错退出。

这里采用 hook 的方式，编写动态库劫持。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETC4dKE2rqsFGTaIu3F8DPiazVITTC074YosfUK1gvpdqMkRicwOQicobpPw/640?wx_fmt=png&from=appmsg)

使用 qemu 加载动态库执行，依旧报错了

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCpX1ibVfHReN0B9cL9XicWlxvVWiaf5QDmHk0HicicR6Jkx5qs1cVJLd15eg/640?wx_fmt=png&from=appmsg)

重新断点运行，输出到这里没有崩溃

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCKFiaziaIZ7QiajUUZ141iabkctqTs16mxaAYZrjEvUntTewU4mAT5Ten9w/640?wx_fmt=png&from=appmsg)

这里会报错

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCtdyo7d4qLmy735qNCS84lDQGvr6YsHGMUOM6gGibgU3oFNGwibaUMfwg/640?wx_fmt=png&from=appmsg)

可以看到是由于 apmib_get 报错，在脚本中添加以下代码 hook 此函数

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCQX42WGh8MrdGJGvibaEHh4XZnNZUZga2jicjsvM4al6X4SJxeKfyibSMg/640?wx_fmt=png&from=appmsg)

可以看到服务成功启动

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCsGbIkkyyGRZfQGz2TKnHUh0k3iaicw8sdP6tZ63hA7x4eJQqJeNXWx1Q/640?wx_fmt=png&from=appmsg)

但是访问 web 页面又报错了

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCSE7qVtjj13dYaVrwbXvZ9hq5g5SlcSATesUTudVv7qLicy7N9NpF2DQ/640?wx_fmt=png&from=appmsg)

看一下 Wizard_Easy_LangSelect.asp，试图从硬件读取信息

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCGPsEKWMV1V4wEofU2NTjuTK9hCfGLdFSKXeWEvEvdaMEm4yzFKZbHQ/640?wx_fmt=png&from=appmsg)

查看 first.asp，应该是进入了 else 分支

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCpejns7vRx39scZFVRZE8wiaWKzaJ6Lz1Rs6Q4Q5bF2fLO6CPR5Zs1gA/640?wx_fmt=png&from=appmsg)

将逻辑改为无论如何都进入 Welcome.asp

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCsWN869icr5l6YnDzSlOMXdia3YrkFGicELzTxR3h6jdW6HaTzJE2GMesw/640?wx_fmt=png&from=appmsg)

访问成功

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETClVcAo9heZQqicFlfR5lcSRlmRSl7btTPygnpLPrgia04j6W208hVV3dA/640?wx_fmt=png&from=appmsg)

至此模拟成功，发送 poc 进行测试，但是还没有命中漏洞点就又崩溃了

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCKDH10R4vqOnScDp2HmC7tXvUkcStictRTx1I7o8PbEcb7OZsps3gJ7A/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCQTibIg2vcBB6Qe4IVZzu2g2sSZkmoZa8JibzIkMlhjKibM3NykfbMibQlQ/640?wx_fmt=png&from=appmsg)

看一下 v1 寄存器的值

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCDNTXbZAoZEddlq5YJ93ZJXPKtHLicV0icIR7c7yfNsaXvroY5ibUMia0CA/640?wx_fmt=png&from=appmsg)

可以看到 $v1 的值为 0x5b59，但是根据 sb 指令的用法此处应该是一个内存地址，所以使用 gdb 将 v1 的值改为有效内存地址或者跳过此条指令继续执行可成功控制返回地址

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCLYoI6IvgMZgfwuWE5hYKGDpkkXCTHKn9NM2Hoic8VZY1RVaoiajXI2gw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCNduygOLibK9Uajk9pqXZuHKTopnVicejbd6xFVrpb50Rhhk2yicU7mSVw/640?wx_fmt=png&from=appmsg)

qemu system mode:

由于 user mode 模拟并不能获取程序的基地址，所以真正的调试还需在 system mode 下进行

下载 qemu-system 需要的 kernel 和虚拟硬盘文件, 此设备为 mips 大端

```
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta
wget https://people.debian.org/~aurel32/qemu/mips/debian_wheezy_mips_standard.qcow2


```

安装虚拟网络设备 tun

```
sudo apt-get install uml-utilities


```

为 root 用户添加网卡 tap0

```
sudo tunctl -t tap0 -u root


```

设置 IP 地址

```
sudo ifconfig tap0 192.168.100.2/24


```

查看一下我们设置的 IP 地址

```
ifconfig


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCp2fjBNibOoDl4fh5PVk1bgcEWuwY3PwGn5aqC05ibR8xTLWucaWia6FZg/640?wx_fmt=png&from=appmsg)

使用如下命令启动

```
sudo sudo qemu-system-mips -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mips_standard.qcow2 -append "root=/dev/sda1 console=tty0" -nographic  -netdev tap,id=tapnet,ifname=tap0,script=no -device rtl8139,netdev=tapnet


```

启动成功后登录使用 root/root 登录

之后将 dir619l 的文件系统上传到 qemu 虚拟机，可以同 gdbserver 一并上传

```
scp -r squashfs-root-0/ root@192.168.100.3:/root/


```

在”squashfs-root-0/“目录运行下面脚本, 配置虚拟机网卡，启动 boa 程序

```
#!/bin/sh
echo "add ip addr ..."
ifconfig eth0 192.168.100.3/24 up
echo "hook ..."
LD_PRELOAD=/apmib-ld.so
export LD_PRELOAD
echo "run boa ..."
chroot . ./bin/boa


```

可以看到服务已经运行成功了

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCegncFLia3ict5pEE6pTl6iaQuic1WCz4zYXOkR9oe0LI9PCBvjGReb3sJg/640?wx_fmt=png&from=appmsg)

接下来就是 gdbserver 附加调试

另起一个终端 ssh 连接 qemu 虚拟机

```
ssh root@192.168.100.3


```

查看服务 pid

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCX4Cw6p4YkOoesFSsKIXu0xYobUAWkicaePBcTPFW1ooQTibyhG0IiaWeA/640?wx_fmt=png&from=appmsg)

gdbserver 附加调试

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCcsYo2xxNxGO89lz7os9Ky0aWceWlcaF7870KNX3RpVxc73ZTbxkNicw/640?wx_fmt=png&from=appmsg)

发送 poc, 发现在下图这个跳转不知为何报错了

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCcwzOfO4T81sMpIHXmvJ2kSE6fFaF3XZexXevKs0HtT4jpn55SfNnuA/640?wx_fmt=png&from=appmsg)

修改当前 pc 为下一条指令地址运行即可成功触发崩溃控制 pc 也可以查看程序的内存映射, 现在可以进行后续研究

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETC3ictET0n9b2iajAOFHibpqfE9sxEUZiaUjzSIx8ds5QI7WwH8aVVc8H6ibQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/PUubqXlrzBRNLLzZIfhOBopefnQWoETCYeHXDPNAxaRuwqrNuccbPg3Ecict0DxIlrQ6uvpxgNo0vA448vRRicBw/640?wx_fmt=png&from=appmsg)

‍

- END -

![](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBR8nk7RR7HefBINILy4PClwoEMzGCJovye9KIsEjCKwxlqcSFsGJSv3OtYIjmKpXzVyfzlqSicWwxQ/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)