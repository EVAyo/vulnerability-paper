<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/MqFfC8alcwBXMv4Qzxfzww)

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

事件起因  

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

事情发生在某省护网期间，客户的某个系统被上传了 webshell，当时没在意

我可爱的领导经过昨天一下午的努力，找到了相关系统源码，随后开始进行审计

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

**文件上传的接口**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

**flashupload.action**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

上传文件后，不会返回对应文件路径，所以只能通过白盒进行挖掘

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

**首先定位到文件上传代码**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BAby4Fk1HQa4QU17nQPbgGsvibDiabvv8Tu2oELBWibriaoliaEG4JK6CDuict736foxQMDTibqr1Hpiame8hU7yvicq7yg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

**跟进 saveFile 方法**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BAby4Fk1HQa4QU17nQPbgGsvibDiabvv8TIfnGsK8T7f8757icsvws7Uvrh17GSP3VY3U7hznJpBLWt9xM6YysTOA/640?wx_fmt=png&from=appmsg)

发现文件名路径是时间戳 + jsp，但此时间戳非彼时间戳

上传的目录是在 system.properties，由管理员自定义目录

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BAby4Fk1HQa4QU17nQPbgGsvibDiabvv8TcpAgKicdib1zHJoPvqOjv4JPlKvZHhVeBzG7fnlKbGRnNSEFjxLW5Stw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

**跳转到时间戳代码**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BAby4Fk1HQa4QU17nQPbgGsvibDiabvv8TMXDo5PzW1YmptT2FHAnYgvaa9P3icrp6CtUqnxZbB3DW56Xy7Lj9zdA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

**第⼀段代码是获取具体时间，具体到毫秒**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BAby4Fk1HQa4QU17nQPbgGsvibDiabvv8TQSS2YPBe9ZaRDP2nzDTTB8vD8LdO8ltcmxwKnNprZe8SBYqmRxnxSQ/640?wx_fmt=png&from=appmsg)

第⼆段代码是把具体时间转换为自定义格式的时间戳，而不是 unix 时间戳

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BAby4Fk1HQa4QU17nQPbgGsvibDiabvv8TxswibmTiaqpgMiaYsnvEzf8KX6IvLaVhsHtRDjwUV0OIlia95rDWO6y29Q/640?wx_fmt=png&from=appmsg)

所以 webshell url 则为如下格式：

```
http://127.0.0.1/uploads/自定义时间戳.jsp

```

因为具体到毫秒，所以要对后三位数字进行爆破

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

**burp 遍历后三位**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

20231120214217001

. . . . . .

20231120214217999

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

**那么代码层面分析完成后，开始实操**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BAby4Fk1HQa4QU17nQPbgGsvibDiabvv8TENAwibXBtoMNnwZibH6RmBd0QXbIFlEV5zomzpic6qKDlR24iaKnTwiau1Q/640?wx_fmt=png&from=appmsg)

全都是 404，这就很离谱 (印象中，老版本的 bp 是可以修改时区的，新版本没找到在哪里修改)

于是又使用 yakit 发包，发现时区也是 GMT

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

**其实，这里存在一个坑，**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

burp 中，响应包的时间并不是服务器的时间，而是 GMT 时区

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BAby4Fk1HQa4QU17nQPbgGsvibDiabvv8TeE63icKzsS1avROx99ekRt1q0t7OgaANfEXxvhlDBmXAaekho9HYIDw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgUsGxJsxn1Nw2icHp7GmYh1bhiaq07Kb0GpjUNibb8Gro9zb2BJXkuiaZgA/640?wx_fmt=gif&from=appmsg)

**代码中的时间，是北京时区**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn6DdpQ8Wpp5JNaBFvvdocbg6Z0EdxiaFib59YYEQpqT1B2x6e9uq2WXaZcnkjXrBSKk8Zhib3ic2HhJrQ/640?wx_fmt=png&from=appmsg)

```
java.util.Date d = new java.util.Date(); //获取当前系统的时间

```

所以解决办法就是，使用 python 写一个同步请求，这边发送数据，那边获取当前系统时间

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BAby4Fk1HQa4QU17nQPbgGsvibDiabvv8TOzn5nicLnqjSF2zyiaWjh6ULR4lfr85vic7f9LrRgdzbIInUsr66RQ1HA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BAby4Fk1HQa4QU17nQPbgGsvibDiabvv8TXEAj5fcsUa6fI776NDH2Zl2EU4O3rQK6mHyO0uS0JzcqE2p8n1zy5w/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWia8Gx9D3Z3Uo1SH1WAjQbNgsiccZFyCyqG3DRMQzTfUMmkobsnX4WJJG5SorRrncR0GtILL9ZKQmUQ/640?wx_fmt=gif&from=appmsg)