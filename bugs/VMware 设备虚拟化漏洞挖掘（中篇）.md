<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/7e7x2DT9WYnWarpd_0fBxA)

本文是天工实验室在 DEFCON 上发表的议题《Dragon Slaying Guide: Bug Hunting in VMware Device Virtualization》的第二部分内容。在该议题的[第一篇文章](http://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&mid=2247486062&idx=1&sn=2bdeaa0c7054de04b9577d07d396172a&chksm=c3571ce2f42095f474d57899d150b61abf23b6a0746a9cf15cef608bb828f69f270c48025266&scene=21#wechat_redirect)中，介绍了 VMware 虚拟化实现的内容。

本周将继续讲解议题第二个重要部分：**USB Device Virtualization**，通过讲解我们挖掘的漏洞，介绍主机控制器、VUsb 及模拟 USB 设备，即整个 USB 系统视角下各处可能出现的安全问题。

![](https://mmbiz.qpic.cn/mmbiz_jpg/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4cROaBh6e4ra6NEsZ043LnEqqrOjvRysYibvts48LUSmCBxwHubExk4g/640?wx_fmt=jpeg&from=appmsg)

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4EqRYmIC5bibOicg6BeuSTLdmDQv40wwoQhhcovgrFG1ib53vicnsrmRlNw/640?wx_fmt=png&from=appmsg)

  

  

  

**目**

**录**

一、前  言

二、漏洞一：CVE-2024-22255: Uninitialized Memory

三、漏洞二：CVE-2024-22252: Use-After-Free

四、漏洞三：CVE-2024-22251: Out-Of-Bound Read

五、总  结

  

**一**

  

**前  言**

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4Y9OIayRjibSdkGu0ibEGK5cUIGNxdoibbmzpWXKzGWH8MIa2EHHtZm7Ww/640?wx_fmt=png&from=appmsg)

我们对 vmm 和 vmx 以及是其他位于 Host 上的服务上进行逆向分析，并且尽可能全面的分析整个 USB 设备的模拟过程，从 USB 主机控制器的实现（UHCI, EHCI, XHCI）到具体后端 USB 设备的模拟，并在其中发现了 多个错误，接下来我们会介绍 VMware 对 USB 系统模拟的实现，以及其中一些典型错误产生的原因，以及所能它们带给我们的启示。

VMware 实现 USB 模拟的代码，大体上可以结构为三个部分，第一个部分为 USB 主机控制器模拟，这部分代码负责模拟 USB 主机控制器设备，包括 UHCI，EHCI，XHCI 三种，这部分代码负责处理整个 USB 传输中与主机控制器相关的数据传输部分，三种控制器的 mmio 处理基本都是现在 vmm 中，vmm 负责按照手册标准处理内存寄存器访问的各种实现，并通过 UserRpc 调用 vmx 配合实现具体主机控制器的数据传输过程。整个模拟最重要的部分为将 Guest 传输的数据从主机控制器表示形式转换成保存在 URB 对象的 USB Request 形式，并将 URB 对象通过 VUsb 中间层传输给后端 USB 设备。

第二个部分我称为 VUsb 中间层，这层代码负责对接主机控制器和后端 USB 设备，他在所有后端 USB 设备上形成了一层抽象，USB 主机控制器代码大多负责将 Guest 的输入重新封装成 URB 对象，VUsb 这层代码则负责管理 URB 相关的对象，他会根据后端目标设备类型的不同选择不同 URB 对象分配和释放方式，不同的后端 USB 设备还会在 VUsb 层形成一个统一表示后端设备的 VUsbDeviceObj，在传输 URB 时 VUsb 还会将 Urb 交给 VUsbDeviceObj 中目标 Endpoint 对应 VUsbPipe 对象管理。

第三个部分即 VUsb 后端设备，VMware 实现了大量不同类型 USB 设备的模拟，包括 HID，Bluetooth，CCID，他们大多采用一个回调函数处理 URB 对象，并根据 URB 对象的保存的数据进行行为模拟。其中比较特殊的时 VUsbGeneric 这类设备，这类设备在 Guest Machine 表示通用 USB 设备，一般用来直通 Host 上的物理 USB 设备，VMware 通过 Host 上的本地 usbarbitrator 服务转发 vmx 中的请求数据。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4FeccHDGNibh342EbQkaObN3QPIm7LRHbSutFic7EZlylPWwpwtqej3YA/640?wx_fmt=png&from=appmsg)

**二**

  

**漏洞一：CVE-2024-22255: Uninitialized Memory**

我们分享的第一个漏洞来自于 UHCI 控制器模拟部分。在 USB 设备的控制传输中，USB 设备使用有效载荷之一是 Standard Device Request，他以 Setup Packet 格式开始。

**Setup Packet Format**

<table width="100%"><tbody><tr><td valign="middle" align="center"><p data-pm-slice="1 1 [&quot;table&quot;,null,&quot;tr&quot;,null,&quot;th&quot;,null]"><strong>Offest</strong></p></td><td valign="middle" align="center"><p data-pm-slice="1 1 [&quot;table&quot;,null,&quot;tr&quot;,null,&quot;th&quot;,null]"><strong>Field</strong></p></td><td valign="middle" align="center"><p data-pm-slice="1 1 [&quot;table&quot;,null,&quot;tr&quot;,null,&quot;th&quot;,null]"><strong>Size</strong></p></td></tr><tr><td valign="middle" align="center">0</td><td valign="middle" align="center"><p data-pm-slice="1 1 [&quot;table&quot;,null,&quot;tr&quot;,null,&quot;td&quot;,null]">bmRequestType</p></td><td valign="middle" align="center">1</td></tr><tr><td valign="middle" align="center">1</td><td valign="middle" align="center"><p data-pm-slice="1 1 [&quot;table&quot;,null,&quot;tr&quot;,null,&quot;td&quot;,null]">bRequest</p></td><td valign="middle" align="center">1</td></tr><tr><td valign="middle" align="center">2</td><td valign="middle" align="center"><p data-pm-slice="1 1 [&quot;table&quot;,null,&quot;tr&quot;,null,&quot;td&quot;,null]">wValue</p></td><td valign="middle" align="center">2</td></tr><tr><td valign="middle" align="center">4</td><td valign="middle" align="center"><p data-pm-slice="1 1 [&quot;table&quot;,null,&quot;tr&quot;,null,&quot;td&quot;,null]">wIndex</p></td><td valign="middle" align="center">2</td></tr><tr><td valign="middle" align="center">6</td><td valign="middle" align="center"><p data-pm-slice="1 1 [&quot;table&quot;,null,&quot;tr&quot;,null,&quot;td&quot;,null]">wLength</p></td><td valign="middle" align="center">2</td></tr></tbody></table>

其中最有趣的字段在于 wLength，他将提醒 Usb 设备请求跟随的后续数据的长度。Standard Device request 是 Usb 设备的有效载荷，对于 USB 主机控制器来说它并不以此为单位传输数据，对于 UHCI，他以 Transfer Descriptor 为单位传输数据，并在 Guest 内存中以 Queue Head (QH) 类似链表的形式链接起来。VMware 的 UHCI 控制器在处理控制传输时，需要以单次 Standard Device request 为单位分配 URB 对象，他将合并位于 Queue Head 上所有与请求相关的 Transfer Descriptor (TD) 中的待传输数据。

VMware 首先获取 QH 上第一个 TD 并以此为 Setup Packet 开始解析，去除其中 wLength 字段并加上 Setup Packet 大小作为 URB 对象数据缓冲区的大小。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4DL0icPVXzoTVmlnx2lLNlxQU7XfcMhEHFJqL9qxoN19s60muCxnYTew/640?wx_fmt=png&from=appmsg)

我们可以看到 VMware 在涉及拷贝数据时已经尽可能小心，但他却忽略了如果 QH 上没有足够 wLength 长度的 TD 的情况。这种情况，他会认为整个 QH 已经处理完毕，随后便直接将 URB 对象放到表示连接到对应后端 Usb 设备端点的 VUsbPipeObject 上，并且通过 VUsb_SubmitUrb 调用对应后端设备的 URB 处理函数进行处理。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4yTAQYAGb0vpqwrAwP86D2Iv9YwAJWdHiabWjiawFnj52Yicvd2hCMkibGA/640?wx_fmt=png&from=appmsg)

URB 的分配过程取决于你要传输的目标设备是什么，不同类型的后端 Usb 设备分配出来的 URB 对象在私有结构上也会有所不同。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW45gaJyjbK6PqC3rkerrZycxnia6ibEhdXib1ppicG9kYic6vezsTKaj9SO7g/640?wx_fmt=png&from=appmsg)

考虑 HID 设备，他在分配 URB 对象时，除了 URB 通用的数据字段，没有添加额外的结构，同时它使用 Malloc 进行数据的分配。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4I8HXKTrDh0VII92zyrJbv6Vsx2S0z8fzE1yDeIyWtssWojxGIvXNOw/640?wx_fmt=png&from=appmsg)

如果我们没有提供由 wLength 字段指定长度的数据会导致 URB 保存数据的缓冲区中留下一大段未初始化的堆数据，但 URB 的有效载荷长度任然会被设置为 wLength+sizeof(Setup Packet) 大小。在后端模拟 HID 设备处理 Setup Packet 中带有 SET_CONFIGURATION 类型请求时，默认没有修改 URB 中数据缓冲区的内容，并将返回数据的大小直接设置成和原始数据一样，这使得 Guest 可以直接获取 vmx 进程堆上的未初始化内容。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4Y2aQw7Vic9sIozH00sV8HabHmOmIMqSET9T97ngKWXEAYg9anEiayUSA/640?wx_fmt=png&from=appmsg)

**三**

  

**漏洞二：CVE-2024-22252: Use-After-Free**

XHCI 会在设备侧维护 Device Slot Context 以及 Endpoint Context 来保存目标 USB 设备及设备端点的状态信息，同时还允许在 Endpoint Context 上创建多个 Transfer Ring，Transfer Ring 对象使用 TRB 传输数据，VMware 使用哈希表存储 Transfer Ring 对象。

深入逆向分析我们还会发现当 XHCI 将 Transfer Ring 上的 TRB 数据构造成 URB 对象时，URB 会有一个指针字段用于记录所有与之相关的 TRB 数据在 Transfer Ring 上的起始位置，当 XHCI 给 Guest 返回 USB 设备响应时，他需要用这个指针跟踪数据，而指针字段刚好指向对应 Transfer Ring 对象的成员。

我们发现的这个问题与 CVE-2021-22040 类似，CVE-2021-22040 的补丁非常有趣，他改动 XHCI 模拟代码中各处对 USB 端点上的 Transfer Ring 释放的调用与 Device Slot Context 的赋值的顺序。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4mIWGhfsdIwaufjRGJHl8VRkJCEibHBF2uDabTc1ru3wXvXFDoR2iaDiaQ/640?wx_fmt=png&from=appmsg)

我们想要理解问题的成因就需要清楚释放的行为构成，当 XHCI 试图释放一个 Endpoint Context 时，他会检查这个 Endpoint Context 上的 Transfer Ring 哈希表，释放与之相关的所有 Transfer Ring 对象，以及所有 Transfer Ring 活跃的传输数据，在 VUsb 中间层上这些活跃的传输数据在以 URB 对象的形式链接在对应 Endpoint 的 UsbPipeObject 对象上，所以释放一个 Transfer Ring 首先需要释放所有在 VUsbPipeObject 上与之相关的 URB 对象。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4KB14PxzRm4vzX1W8wp19YUoTuHNu2VT5j3v8SaYNMicXQJkD6KkGodg/640?wx_fmt=png&from=appmsg)

XHCI 首先根据 Endpoint Cotntext 所属的 Device Slot Context 中保存的 USB Port Number 获取 VUsbDeviceObject 对象，再根据 Endpoint ID 从 VUsbDeviceObject 中获取 VUsbPipeObject，在 CVE-2021-22040 补丁修复之前，Configure Endpoint 等 XHCI 指令可以在释放 Transfer Ring 之前就修改 Endpoint Context 的内容，Endpoint Context 中保存有 Endpoint 的类型，类型被修改成与 VUsbPipeObject 不匹配后，使得释放 Transfer Ring 时获取不到 VUsbPipeObject 的，从而导致 VUsbPipeObject 上属于 TransferRing 的 URB 对象不能被先行释放，而我们提到，URB 中保存有 Transfer Ring 对象成员的指针，这就导致 URB 中悬挂已经释放的指针进而发生 Use-After-Free 问题。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW44Dd9UbSPVun3YGmm5fsrzInoJoU4fxEkxmsiaNMUI9qbQmicqpXdD5hA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4CdLNyKZvEWkvMW4EA2UOD24S9LlLUxe2wIlDnLbhCWuJU62vZ1HfpA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4oEq6GlycOAsbfFZHL3vg8lLWO55pXp0nbUFeERxDVECLa9mZYt0yXw/640?wx_fmt=png&from=appmsg)

CVE-2021-22040 补丁提前了释放的顺序，以确保释放之前 Device Slot Context 或是 Endpoint Context 不会被提前修改，但是这并不足以修复这个问题，问题的根本是这些拥有依赖关系的数据结构，相互之间索引的方式较为松散，即便现在没有办法通过修改 Endpoint Context 内容来影响 VUsbPipeObject 的获取，仍然可以通过修改 Device Slot Context 使得获取其他 VUsbDeviceObject 虚拟 USB 设备对象，进而导致不能获取正确的 VUsbPipeObject 对象。

ADDRESS_DEVICE 指令会修改 Slot Context 以及 Control Endpoint Context 的内容，这意味着我们可以先完成一个设备的配置流程，并在其非 Control Endpoint 的 Endpoint 上创建 Transfer Ring，以及在 Transfer Ring 上传输 URB 数据。完成之后，我们再对同一个 Device Slot 上使用 ADDRESS_DEVICE 指令修改 Device Slot Context 内容，使其 Device Port Number 指向其他 USB 设备，VMware 的实现使 ADDRESS_DEVICE 并不会影响其他非 Control Endpoint Context 的状态，这使得当我们尝试释放之前传输过 URB 数据的 Endpoint 上的 Transfer Ring 对象，在查找 VUsbPipeObject 过程中，会由于查到的 VUsbDeviceObject 和本该释放 URB 所在的 VUsbPipeObject 所属的 VUsbDeviceObject 不匹配，导致释放再次失败，再次引发 Use-After-Free。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4FNhUGzWyARa2jm6tKqjicqicYDs8B3En6vwntgwVFGM7HH2oWaEsDTmQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4LjLuHiaicu16Afozu7sVeVibzLCyN7rk08BJG37FrcSwiaGaYl4KvOKpLA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4DOCJEb2OH9Fa8tlvzeXXysNDoK56qEmunEYUNkrSrxfa3py5M9K6Ww/640?wx_fmt=png&from=appmsg)

**四**

  

**漏洞三：CVE-2024-22251: Out-Of-Bound Read**

本部分介绍的最后一个漏洞来自于 VUsb 后端设备模拟过程中，并且在系统 API 中被触发。APDU (Application Protocol Data Unit) 作为 SmartCard Reader 和 SmartCard 之间交互的数据单元，而 Guest 和 VMware 所模拟的 SmartCard Reader 设备使用如下数据结构交互：

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4p9YiaMMsX4MnvGdicmqIlhibQd2jicN2NX4JgVib1hjcic86Hkx4sTPeGFDg/640?wx_fmt=png&from=appmsg)

VMware 会检查 ccid_xfrblock_msg_hdr 的字段与作为有效载荷的 APDU 的 len 长度字段是否符合，但却没检查这两个字段是否与整个 URB 缓冲区大小是否符合，而是直接使用这个字段作为了参数调用了 Windows 的 SCardTransmit API，SCardTransmit 以缓冲区指针和缓冲区大小为参数，他当然没法检查这两个参数之间的合法性，这不是他的责任，于是导致了堆数据的越界访问。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4piaz7ZFGcdBUF8qjdgfg2MptAHDWEFm1b2wDPhp8x4xRb4apibzdwDSQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4MdSdg2XtlJZM1vje5q2pKz3Yxju6wxOszwYpwZEjicyPxdQq0tiaaPJw/640?wx_fmt=png&from=appmsg)

**五**

  

**总  结**

本篇文章中分享的漏洞在 Workstation 和 Esxi 上均可被触发，这使我们意识到，在整个 USB 模拟系统中，问题不仅可能出现在接近虚拟机 Guest 操作系统的 USB 主机控制器层面，甚至 USB 后端设备模拟也可能受到恶意的用户输入影响，也有可能因为对内存对象的管理不当而给 Host 带来威胁。

整个 USB 模拟系统视角下攻击面远不止如此，VMware 为了实现物理 USB 设备与 Guest 直通，还在 Host 上安装了专用服务与 vmx 交互转发数据，相关服务也可能成为攻击者关注的目标。不仅是来自 Guest 系统的输入值得关注，而且恶意的 USB 设备响应数据也能借助虚拟化技术影响 Host 主机，USB 这样复杂系统的实现毫无疑问为我们带来极大安全挑战。

  

  

  

  

【版权说明】

本作品著作权归 **s0duku** 和 **zhz** 所有

未经作者同意，不得转载

**s0duku**

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW4WZFYdds87wwHxY7j1hfc6A4eAwvVsA8kzOEyNJibfYMEzuHLibC4pdNQ/640?wx_fmt=png&from=appmsg)

天工实验室安全研究员

GeekCon2023 选手

专注于逆向工程

二进制安全

**zhz**

![](https://mmbiz.qpic.cn/mmbiz_jpg/9EP6QFMcTmRwzyJsyn2SpPSibNgvkcXW46VHSoY4rWOlk7NBlynsMDPiaCvp1ibUfwkOulRnCX4wSFao5dMdelmwg/640?wx_fmt=jpeg&from=appmsg)

天工实验室安全研究员

GeekCon2023 选手

专注于代码审计

虚拟化安全

**往期回顾**

  

**0****1**

[Bug Hunting In VMware Device Virtualization（上篇）](http://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&mid=2247486062&idx=1&sn=2bdeaa0c7054de04b9577d07d396172a&chksm=c3571ce2f42095f474d57899d150b61abf23b6a0746a9cf15cef608bb828f69f270c48025266&scene=21#wechat_redirect)

**0****2**

[【破壳之路】从 CVE 复现到 TOTOLINK 新 0day 挖掘实践](http://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&mid=2247486006&idx=1&sn=3dd3e701263309bef425810232ceb983&chksm=c3571cbaf42095acea6d5e4b54c4dac407fd10dcee8da9a072eb9bf84d6c4022a74bc7df10d9&scene=21#wechat_redirect)

**0****3**

[深入解析 Windows VTL 机制 & IUM 进程](http://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&mid=2247485984&idx=1&sn=d63826413e04f27a789f5b5c94630543&chksm=c3571cacf42095bafa23b9d32f9751a4a46b6a758432f9b831574d98ee30871536bb7cfdaa9d&scene=21#wechat_redirect)

**0****4**

[【破壳之路】破壳平台多粒度漏洞查询实践](http://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&mid=2247485949&idx=1&sn=41469f44d3aed493739c80d4b6d134e8&chksm=c3571f71f4209667448069881f16a4868d3f4711acf8bf31b130a64160562992b714c950720c&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/oJZWTpJpiae90UpibicIKeZgQTNjebiaOwStfe6MJ5J6RC7F9JDFdX2kaEwibFz7GewNtNyDek6SdENJrXjf0KXA2kg/640?wx_fmt=png)

**每周三更新一篇技术文章  点击关注我们吧！**