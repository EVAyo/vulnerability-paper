<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/pBt3Q0VF44AD7tTXxCD7Kg)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9Lbc0INLwTJTZT1GaNutZrfDn6csvjBoS2ox0efLUEexXqPEcVbYfbLo8w/640?wx_fmt=png)

 **Part1 前言** 
--------------

前一阵子朋友让我帮忙看一套金融系统源代码的安全问题，从去年大比赛过后，我好久没审计过代码了，于是就仔细看了看。首先这套系统用的是 Springboot 框架，而且没有找到 Java 反序列化漏洞，SQL 注入漏洞被预编译写法彻底封死，也没有上传漏洞，Fastjson 用的 1.2.83 版本，Log4j2 版本也较新。最后快放弃的时候，重新检查了配置文件，发现了 thymeleaf 组件，通过 idea 在代码中各种搜索，最后发现了 4 处 thymeleaf 模板注入漏洞。

在研究 thymeleaf 模板注入漏洞的时候，**发现网上的文章非常多，但是有些地方说法不一样，部分还有错误**。这样 ABC_123 就参考网上的文章，自己写代码搭建环境，测试不同情况下的 thymeleaf 模板注入漏洞的利用方法，把测试结果分享给大家。

**建议大家把公众号 “希潭实验室” 设为星标，否则可能就看不到啦！**因为公众号现在只对常读和星标的公众号才能展示大图推送。操作方法：点击右上角的【...】，然后点击【设为星标】即可。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHdFeDURNa0QpfjclGrvg0lfANPtuLbf5Ddur3HZmdfAydibIf9zazCKQ/640?wx_fmt=png)

 **Part2 技术研究过程** 
------------------

*   **搭建环境遇到的坑**
    ------------
    

###  **1   第 1 个坑**

上手搭建环境 ABC_123 就踩了一个大坑，我发现 github 上下载的环境都没法测试成功，经过反复测试才发现，是因为其漏洞环境 pom.xml 中没有配置版本号，默认是使用最新版本 thymeleaf 组件，**而最新版本的 thymeleaf 组件是没有模板注入漏洞的，也许将来会有安全人员挖掘出新的绕过方法**。

 **2   第 2 个坑**  

较新的存在漏洞的 thymeleaf 版本，需要使用那些通过 %0A、%0D 的绕过语句才能执行。如果还是测试不成功，记得需要把 payload 中的特殊字符进行 URL 编码，如果实在是不知道该对哪些特殊字符进行 URL 编码，**那就如下图所示，把整个 payload 都 URL 编码吧**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHtgdkzXFvfVptiboFEqib4jLMXrGcZmU1AJQ2MZhWF2PEmQGWkPsibpoyw/640?wx_fmt=png)

*   **前置基础知识**
    ----------
    

Thymeleaf 模板的表达式有以下几种：变量表达式：${...}、选择变量表达式：*{...}、消息表达式：#{...}、链接 URL 表达式：@{...}、片段表达式：~{...}。**所以很多 thymeleaf 模板的注入语句 ${...} 换成 *{...} 也是可以利用成功的**。

接下再看一个基础知识点，如下图所示，图中的代码 **return “welcome”** 指的是返回视图名，thymeleaf 会为 welcome 视图名加上默认前缀 **/templates** 及后缀**.html**，即最终返回的视图名就是 **/templates/welcome.html**，然后会带上我们的数据 **model**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHJJcskMNExc04dPiaibVDY1uzdLNmeJXy57xibCttZ2wV1dezLF14X8ZOA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSH21HHKY4DCw4MN1W4pZRgDpIexu1phS48MVGAfrjmEulZxKX64Zicslg/640?wx_fmt=png)  

有了前置的基础知识，接下来再讲一下 thymeleaf 模板注入漏洞存在的三种形式。

*   **第一种情况，return 内容可控**
    ---------------------
    

这种情况最容易出现 thymeleaf 模板注入漏洞，一旦用户提交的数据可以传到 return 语句中，攻击者就可以提交恶意模板注入语句使 thymeleaf 组件进行模板解析，造成代码执行漏洞。

刚开始看这个 thymeleaf 模板注入漏洞时，我就被网上的各种不同的 java 代码写法弄得云里雾里的，最后测试来测试去，发现差别不大，**其实就是攻击者可以操控 return 中的值，就有可能造成模板注入漏洞，只是在不同情况下，漏洞利用语句会有不同**。ABC_123 总结网上各种文章、各种 github 资源，发现存在漏洞的 java 代码写法大致有以下 4 种：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHqHaJSCKb1fAgEEeIQejjaqUyCqiadfF3DibT242gG5nicG7ubU0NTg36g/640?wx_fmt=png)

经过测试，发现同样的语句，都可以弹计算器成功。  

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHJz8Afq9rBBMO704Qo3sqXZMCBuhsYj7T8h5xjTGR809ybPXJsicQj3Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHSDxQGiaWibp1fStILDDCkSg6vzTQ1bJ8SUvqy8RIwTjTx3AqmKbxAO4Q/640?wx_fmt=png)

*   **第二种情况，URL 路径可控**
    ------------------
    

这种情况比较少见，要求方法的返回类必须为 void，此时会从 URL 中获取 viewname，以 URL 路由为视图名称，调用模板视图去解析。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHuQdLYpM95SahYLop0XBtIDKaJ0Tann8dbABhzs15XV4mFtT2pa5QQA/640?wx_fmt=png)

接下来看网上的文章最常用的一种写法，很明显可以测试成功（这里为了方便展示，payload 直接贴出来了，**大家实际测试的时候，需要把 payload 进行 URL 编码**）。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHWANgibqJKMroIysjvS3pwhtpRsTq2Yltq60qaAqYrBvRg3ruwHib9Jibw/640?wx_fmt=png)

接下来看 / doc2 的情况，**这里我把 @GetMapping 换成了 @RequestMapping，发现漏洞也是可以利用成功的**，而且不只 GET 请求，貌似各种请求都可以利用成功。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHtgdkzXFvfVptiboFEqib4jLMXrGcZmU1AJQ2MZhWF2PEmQGWkPsibpoyw/640?wx_fmt=png)

甚至 PUT 请求都是可以测试成功，这点是没有想到，**看来 URL 路径可控情况下，这个漏洞也不是只有 GET 请求才能触发**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHd55yrcHGuaEsgogxEha0zcliatXPAzodgNwRIaU6wh7BjU0FZNwXEqQ/640?wx_fmt=png)

这种情况肯定是测试不成功的，**因为代码中 document 被 @RequestParam 修饰了**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHKW31fceQIvjx69C3INzOuGXCrAKCW0Qs2PSDtagBN2lFqSX8pAzOPQ/640?wx_fmt=png)

*   **第三种情况，模板内容可控**
    ----------------
    

模板内容可控这种情况太少见了，我就不展开说了。ABC_123 把自己测试成功的代码截图发出来，给大家参考一下，估计实际使用中，很少有程序员会这么去写代码，但是万一遇到了呢。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHEibdIMUpe9ib7LIRPzI8jQXyicEpHmuicmMdPJvia0Tk6vffTGAZ5I19bXQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHMDPeiblSLhstuVXL1Zj3RtU5icXKKJephhdcreSNOmKEv1icdjFlOZMQQ/640?wx_fmt=png)

*   **不存在漏洞的情况及修复建议**
    -----------------
    

 **1   使用 @ResponseBody 或 @RestController 修饰**

@ResponseBody 是一个 Spring 框架中的注解，它用于指示该方法的返回值应该直接写入 HTTP 响应正文 ResponseBody 中，**而不是通过视图解析器进行渲染**。使用 @ResponseBody 注解可以将方法返回值以 JSON、XML 等格式直接写入 HTTP 响应体中，常用于返回 RESTful API 接口的响应数据。

@RestController 是 Spring 框架中的一个注解，它结合了 @Controller 和 @ResponseBody 注解的功能，用于简化 RESTful Web 服务开发。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHtqCjISEicQT48CPzFgkPbgkn21G3YdSLOloMRqibBkwPLutAHeV4icZdg/640?wx_fmt=png)  

 **2   使用 redirect: 或 forward: 修饰**

根据 springboot 定义，如果名称以 redirect: 开头，则不再调用 ThymeleafView 解析，调用 RedirectView 去解析 controller 的返回值。这里需要注意的是，**除了 redirect: 之外，还有 forward:，这点网上很少提到**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSH1GYeJRShwPZaZicdcQEe5Ec07clvTs4RwbJpMg8t1cMlh3ddrVwZk0Q/640?wx_fmt=png)

 **3   设置为 HttpServletResponse**

由于 controller 的参数被设置为 HttpServletResponse，Spring 认为它已经处理了 HTTP Response，因此不会发生视图名称解析，也就不会存在模板注入漏洞了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHAqq2NO6bXgUdxuODE8uOjt9xEaHFNuBf4pUibqjzTAzPLpbMTh9OQzQ/640?wx_fmt=png)

 **Part3 总结** 

**1.**  后续 ABC_123 会专门写一篇文章，总结不同版本的 thymeleaf 模板注入漏洞测试语句以及绕 waf 方法，欢迎关注我的公众号 “希潭实验室”。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。

Contact me: 0day123abc#gmail.com(replace # with @)