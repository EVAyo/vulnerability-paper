<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/EJdvxsrvzmKbWyk3pY6oYQ)

_**免责声明：**_

_本公众号致力于安全研究和红队攻防技术分享等内容，本文中所有涉及的内容均不针对任何厂商或个人，同时由于传播、利用本公众号所发布的技术或工具造成的任何直接或者间接的后果及损失，均由使用者本人承担。请遵守中华人民共和国相关法律法规，切勿利用本公众号发布的技术或工具从事违法犯罪活动。最后，文中提及的图文若无意间导致了侵权问题，请在公众号后台私信联系作者，进行删除操作。_

**0x01 通过恶意 jar 包导致的 RCE 案例**

bi 类产品由于需要使用大量数据源，这些数据源的驱动 jar 可能是任何一款数据库，也可能是用户自己的 jar，当用户能使用自己的 jar 时，我们只需要对其进行修改，就能实现夹带私货（任意代码执行）。  

以下是帆软的案例：   

         ![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGncTIWicwkB0icLvILLL2ZggZlc5oeUCFCAbZjkPArEaYjtuwYS2QAGhdXB7FCW6771BhULDjgSrVg/640?wx_fmt=png)

**0x02 如何优雅的修改 jar**

有的小伙伴会问到，代码闭源怎么办？其实修改 jar 并不一定要在项目代码上修改后重新打包，我们可以直接对单个 java 文件修改后编译替换，以下是步骤与教程。

**第一步：确认 jar 包原本使用的 jdk 版本**

将 jar 解压为 class 文件，使用 javap 命令

jar -xvf 目标 jar

javap -verbose target.class | grep major

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGncTIWicwkB0icLvILLL2ZggFUrjKLYibkV8pWnoPRz5QPH8ic1NF95icMnBE9HwahGz5ECBV7PFaoq6Q/640?wx_fmt=png)

55 版本对应 JDK11

**第二步：重写一个需要修改的 java 类使用刚刚查的版本 JDK 编译**

我这边修改了 DB2 驱动的 connect 方法    

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGncTIWicwkB0icLvILLL2ZggbEUlULPJ7QJDVkiatx0Oc1LSEjKHewcibw9KL7vwPqicCCl6XMpvyiapPA/640?wx_fmt=png)

编译的时候需要使用 - cp 将原本的 jar 包作为依赖

javac -cp 原本的 jar 目标. java    

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGncTIWicwkB0icLvILLL2ZggFUiaLd8wpEGShsn7urPQ8H7HrUIIDQCbg2Emt3iaN8ksMHzV7XWiczKSA/640?wx_fmt=png)

告警可以忽略，字节码文件已经编译出来了

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGncTIWicwkB0icLvILLL2Zgg1XwIlkVShNnauABOFks1YVJqnAH7DJPhmL9LFMTvXia1UIfc2iceZrxQ/640?wx_fmt=png)

**第三步：替换 jar 包中的 class**

命令查找 JAR 包中要替换的 class 文件的确切位置。

jar tvf xxx.jar | grep 要替换的 clas 文件名

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGncTIWicwkB0icLvILLL2ZggJlQPeUKCFmkbRW2ZMUtL0XVxI7FD6hD7DOyWQMib9q4O2SkAgxpmesA/640?wx_fmt=png)

构造同样的目录结构将 class 文件放置在内

jar uvf xxx.jar com/xxx/xxx/xxx.class

这个命令会将 class 替换掉原来 jar 包中的 class

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGncTIWicwkB0icLvILLL2Zgg9hLo7xKcgG5Kg9RFWKBt6Q0fbSHwe4IEukf0utjpABdVGu4DlbFNVw/640?wx_fmt=png)    

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybGncTIWicwkB0icLvILLL2ZggjdozbvrRyLs8wIkXd4AqZhUhcfo3E6VwaA2xfBLo6ExdSovnkENqXw/640?wx_fmt=png)

**0x03 后记**

当我们构造好 jar 包，在连接 db2 数据库时使用了我们自己的驱动时就会触发我们写的代码，Bi 类的系统很多都支持包括阿里的 chat2DB，这个姿势还能用于留后门，毕竟谁会想到去检查 jdbc 的 jar 包。

**0x04 加入我们  
**

  

后台回复 “加群” 或“小助手”，或扫描下方二维码加入我们的付费圈子，一起进步吧

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybHZicZnvXwW5LnL1bzhuJAoQ7MpUsy3BY3Cibl6curYWucSMSpxJicscm7zwWDWQaaiapo57oc6L5YH2w/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

![](https://mmbiz.qpic.cn/mmbiz_png/rz9smmdjybFMdnMAXpcyiaNPdyoLppiaPO7glCdCXn1WctQuslCotWHfH709HdYlkyYRK3BcTTzIE5UCw1vS1LJQ/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)