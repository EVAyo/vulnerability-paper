<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/v4NHQ2hTIts2Jmo4EeJMAw)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

免责声明

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者及本公众号不为此承担任何责任。

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

WMI 查询

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

经过前两章的铺垫，我们本章终于可以了解一些 WMI 实际的利用。本章将介绍 WMI 查询。WMI 查询功能是通过 WQL 语言实现的。  

有三种类别的 WQL 查询:

*   实例查询 —— 用于查询 WMI 类的实例；
    
*   事件查询 —— 用于一个 WMI 事件注册机制，例如 WMI 对象的创建、 删除或修改；
    
*   元查询 —— 用于查询 WMI 类架构
    
      
    

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

实例查询

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

实例查询是最常见的获取 WMI 对象实例的 WQL 查询形式。实例查询的格式为：

```
SELECT [Class property name|*] FROM [CLASS NAME]

```

举个例子：  

```
SELECT * FROM Win32_Process WHERE Name LIKE "%chrome%"

```

这个查询将返回所有正在运行的进程的可执行文件名称中包含 "Chrome" 的结果。具体地说，此查询将返回 Win32_Process 类的每个实例的所有属性的名称字段中包含字符串 "Chrome" 的结果。

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

事件查询

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

事件查询提供了报警机制，触发事件的类。事件查询格式如下:

```
SELECT [Class property name|*] FROM [INTRINSIC CLASS NAME] WITHIN [POLLING INTERVAL]

```

```
SELECT [Class property name|*] FROM [EXTRINSIC CLASS NAME]

```

举个例子：  

```
SELECT * FROM __InstanceCreationEvent WITHIN 1 WHERE TargetInstance ISA 'Win32_Process'

```

这个命令会查询 1 秒内新建的所有进程。

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

元查询

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

元查询提供一个 WMI 类架构发现和检查机制。格式如下:

```
SELECT [Class property name|*] FROM [Meta_Class<WHERE [CONSTRAINT]>

```

举个例子：  

```
SELECT * FROM Meta_Class WHERE __Class LIKE "Win32%"

```

以下查询将列出所有以字符串 "Win32" 开头的 WMI 类：

当执行任何 WMI 查询时，除非显式提供命名空间，否则将隐式使用默认的命名空间 ROOT\CIMV2。

## 使用命令行查询  

在命令行进行 WMI 查询，可以使用 Windows 包含的一个命令行工具 "WMIC"。这是一个功能强大的工具，可以进行大多数的 WMI 查询操作。

我们可以输入以下命令获取所有在运行的进程：  

```
wmic process list

```

它等价于这个 WQL 查询：  

```
SELECT * FROM Win32_Process

```

还可以再细化一下查询，比如我想知道所有进程名包含 "explore" 的名字、PID 和文件路径：  

```
wmic process where  get Caption,ProcessId,ExecutablePath

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9AiaNKGfaUnB77BwdialibtMxPjeLRDobKPeFs0aW5Eiavh2N2b7WjVU3akXDayAtH2rrNL6tH7MaDbVw/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

总结

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

本文介绍了 WMI 的三种查询格式，以及如何使用 WMIC 完成示例查询。实际上 WMI 可以与 Powershell、C 等配合完成一系列复杂的操作。下一章我们将介绍 WMIC 如何与 Powershell 进行交互完成一系列强大的操作。