<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/aVFQ7ThOzKri8Y94k8DMYQ)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

免责声明

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者及本公众号不为此承担任何责任。

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

PowerShell 交互

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

PowerShell 作为一个强大的脚本语言，自然提供了很多指令用来与 WMI 进行交互。以下都是与 WMI 交互的 PowerShell 指令：  

```
Get-WmiObject
Get-CimAssociatedInstance
Get-CimClass
Get-CimInstance
Get-CimSession
Set-WmiInstance
Set-CimInstance
Invoke-WmiMethod
Invoke-CimMethod
New-CimInstance
New-CimSession
New-CimSessionOption
Register-CimIndicationEvent
Register-WmiEvent
Remove-CimInstance
Remove-WmiObject
Remove-CimSession

```

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

WMI 基本信息收集

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

上一章中我们讲到，可以使用 WQL 语言去查询 Wimdows 系统中的很多信息。而对于网络入侵和防御，以下信息最有可能被收集：  

*   主机 / 操作系统信息: Win32_OperatingSystem, Win32_ComputerSystem
    
*   文件 / 目录列举: CIM_DataFile
    
*   磁盘卷列举: Win32_Volume
    
*   注册表操作: StdRegProv
    
*   运行进程: Win32_Process
    
*   服务列举: Win32_Service
    
*   事件日志: Win32_NtLogEvent
    
*   登录账户: Win32_LoggedOnUser
    
*   共享: Win32_Share
    
*   已安装补丁: Win32_QuickFixEngineering
    

我们可以先使用单条命令尝试使用 PowerShell 获得这些信息：

1. 收集主机 / 操作系统信息：  

```
Get-WmiObject -Class Win32_OperatingSystem

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9CmPQ2Npo96RP2rwEl0cQmPQtpUwyzZxyCiamtvUF208ibje2bISvH7wrS2mSwXg3hyFL5EOvZ4zsYA/640?wx_fmt=png)

```
Get-WmiObject -Class Win32_ComputerSystem

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9CmPQ2Npo96RP2rwEl0cQmPIM3oy7tplsl5pcvCzhdfRaXvsXaubkdbBBCSjP7O9dgxuW65f8J8cw/640?wx_fmt=png)

2. 列举关键路径的目录和文件：

```
Get-WmiObject -Query "select * from CIM_DataFile where Path = '\\Windows\\'"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9CmPQ2Npo96RP2rwEl0cQmPCe7jU23kVKSJLoge9shPVicWkdpiamLmNtzvLGibPZ5UTVf0nWbb3gPAA/640?wx_fmt=png)

3. 列举已安装补丁：  

```
Get-WmiObject -Class Win32_QuickFixEngineering

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9CmPQ2Npo96RP2rwEl0cQmPFkAAxfyBic9ub31F7GFhrYiaZCFAMaIVgJKcLzQRKRuQXQs0JgMNVVFQ/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

反病毒与虚拟机检测

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

1. 杀毒引擎检测： 已安装的 AV 产品通常会将自己注册在 WMI 中的 AntiVirusProductclass 类中的 root\SecurityCenter 或者是 root\SecurityCenter2 命名空间中，具体是哪一个命名空间则取决于操作系统的版本。可以通过 AntiVirusProduct 类来查看机器上有哪些杀毒引擎：

```
Get-WmiObject -Namespace root\SecurityCenter2 -Class AntiVirusProduct

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9CmPQ2Npo96RP2rwEl0cQmPw8KZzMxNaBz68UBvZLPKCVX5iaFSwhyicPU1dkuGTXGIQWAFl3Jiadnhg/640?wx_fmt=png)

2. 通用的虚拟机 / 沙盒检测

恶意软件可以使用 WMI 对通用的虚拟机和沙盒环境进行检测。例如，如果物理内存小于 2 GB 或者是单核 CPU ，那么很可能操作系统是在虚拟机中运行的：

```
Get-WmiObject -Query "SELECT * FROM Win32_ComputerSystem WHERE TotalPhysicalMemory < 2147483648"

```

```
Get-WmiObject -Query "SELECT * FROM Win32_ComputerSystem WHERE NumberOfLogicalProcessors < 2"

```

3. VMware 虚拟机检测

下面的查询示例试图查找 VMware 字符串是否出现在某些 WMI 对象中并且检查 VMware tools 的守护进程是否正在运行：

*   查询网络适配器制造商名字包含 "VMware" 的项：
    

```
Get-WmiObject -Query "SELECT * FROM Win32_NetworkAdapter WHERE Manufacturer LIKE '%VMware%'"

```

*   查询 BIOS 序列号包含 "VMware" 的项：
    

```
Get-WmiObject -Query "SELECT * FROM Win32_BIOS WHERE SerialNumber LIKE '%VMware%'"

```

*   查询名字为 "vmtoolsd.exe" 的进程：
    

```
Get-WmiObject -Query "SELECT * FROM Win32_Process WHERE 

```

*   查询网络适配器名称包含 "VMware" 的项：
    

```
Get-WmiObject -Query "SELECT * FROM Win32_NetworkAdapter WHERE Name LIKE '%VMware%'"

```

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

总结

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

本文讲述了 WMI 如何与 PowerShell 交互实现主机信息收集与防病毒检测，下一章我们将探讨 WMI 在命令执行和横向移动的可能性。