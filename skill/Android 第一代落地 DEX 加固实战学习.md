<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/igKsZJTxeMOQLUbWLKrKKw)

第一代 dex 落地壳加固是 Android 加固的基础，近日学习加固相关知识，记录一下自己踩过的坑和总结自己对落地壳的理解。  

  
下面的代码或多或少参考了大佬们的代码，主要是加上自己的理解和注释，经过折腾最终在最新版雷电模拟器 9（Android9）实现了加固和自解密运行。参考项目和文章放在文末。

```
一





理论知识

```

关于 DEX 文件的组成，可以自行搜索详细学习。

在 Android 的 DEX 加固中，主要和 DEX 头部三个字段有关，分别是：

1.checksum  
文件校验码，使用 alder32 算法校验文件除去 maigc，checksum 外余下的所有文件区域。

2.signature  
使用 SHA-1 算法 hash 除去 magic、checksum 和 signature 外余下的所有文件区域。

3.file_size  
dex 文件的大小。

DEX 加固主要就是一个拼接。  
成品 = 待加固 app（会经过加密） + 解密 dex  
经过拼接之后，会影响上面说的 3 个字段，所以需要我们手动去修改更正。

这里借用 Jack_Jia 大佬的图：  

  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EyFPj5ftBqTR8qDMicR6C65SfocZIrr717ib56yRLwx8Z29rsMnuVfYxIwdwd1sKFDuPtnhyJJ6n9Q/640?wx_fmt=other)  

我们一般把加密后的 apk 放在解密 dex 的末尾，并且最后 4 个字节填充为源 apk 的大小，方便我们解密然后运行该 app。

主要的过程总结如下：

加密源 app：
--------

1、加密源 app  
2、把加密后的源 app 放在壳 (classes.dex) 后面（最后面 4 个字节填充源 app 大小）  
3、修改壳的 checksum、signature 和 file_size

解壳 apk
------

1、主动读取 classes.dex 末端的加密数据  
2、调用本 apk 的解密方法进行解密  
3、动态加载解密之后的 apk

主要的过程很好理解，但是有一些细节需要我们去注意。

如何加载且正常运行解密之后的 apk？
-------------------

我们使用 dexclassloader 来加载我们的 apk，为了让加载的 apk 有自己的启动流程和生命周期，将我们的 dexclassloader 替换 LoadedApk 中的 mClassLoader 这个字段。

  
mClassLoader 用于加载 APK，动态运行我们解密之后的 apk。

  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EyFPj5ftBqTR8qDMicR6C65Vn4HcATIia6FBXAfC04gzWic37nfYxkiaPEibCybJicuukmayJCViaEQhK0Q/640?wx_fmt=other)

```
RefInvoke.setFieldOjbect("android.app.LoadedApk","mClassLoader",weakReference.get(),DexClassLoader);


```

```
二





加密和组装

```

使用 java 语言来完成加密源 app 这一目的，粘太多代码不太好。

  
这里先解释一下 System.arraycopy 方法。`System.arraycopy`方法的原型如下：

```
public static void arraycopy(Object src, int srcPos, Object dest, int destPos, int length)


```

这个方法用于将一个数组中的元素复制到另一个数组中，可以用于复制基本数据类型数组和对象数组。参数的含义如下：

◆`src`: 源数组，从这个数组中复制元素。

◆`srcPos`: 源数组中开始复制的位置（索引）。

◆`dest`: 目标数组，将元素复制到这个数组中。

◆`destPos`: 目标数组中开始粘贴的位置（索引）。

◆`length`: 要复制的元素数量。

首先我们先获取原 apk 和壳 dex，然后进行修改 3 个字段，最后保存即可。

```
public static void main(String[] args) {
   
    try {
    //目录自定义
        File payloadSrcFile = new File("F:\AndroidUnidbg\untitled\src\orgin.apk");//原apk目录
        File unShellDexFile = new File("F:\AndroidUnidbg\untitled\src\shell.dex");//具有加固功能的dex文件
        byte[] payloadArray = encrpt(readFileBytes(payloadSrcFile),0x66);//对apk进行加密，这里可以自定义，我采用了异或加密

        byte[] unShellDexArray = readFileBytes(unShellDexFile);//readFileBytes函数：将文件内容转换为bytes类型

        int payloadLen = payloadArray.length;
        int unShellDexLen = unShellDexArray.length;
        int totalLen = payloadLen + unShellDexLen +4;//可以看到最终的长度是增加了4，最后4个字节用于填充源app文件的大小
        byte[] newdex = new byte[totalLen]; 

        //添加解壳代码
        System.arraycopy(unShellDexArray, 0, newdex, 0, unShellDexLen);
        //添加加密后的解壳数据
        System.arraycopy(payloadArray, 0, newdex, unShellDexLen, payloadLen);
        //添加解壳数据长度
        System.arraycopy(intToByte(payloadLen), 0, newdex, totalLen-4, 4);
        //修改DEX file size文件头
        fixFileSizeHeader(newdex);
        //修改DEX SHA1 文件头
        fixSHA1Header(newdex);
        //修改DEX CheckSum文件头
        fixCheckSumHeader(newdex);


        String str = "F:\AndroidUnidbg\untitled\src\classes.dex";
        File file = new File(str);
        if (!file.exists()) {
            file.createNewFile();
        }

        FileOutputStream localFileOutputStream = new FileOutputStream(str); //保存加密之后的dex
        localFileOutputStream.write(newdex);
        localFileOutputStream.flush();
        localFileOutputStream.close();


    } catch (Exception e) {
       
        e.printStackTrace();
    }
}


```

```
三





解密apk

```

这一步可能会难住许多朋友，因为有一些小细节需要我们去注意。小细节导致我们加固实验不能正常进行。

  
这里记录一下自己踩得坑，详细的加固代码在 github 会有很多。

1、解壳 app 其实不需要有启动界面的，我们可以直接在 androidmanifest.xml

  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EyFPj5ftBqTR8qDMicR6C659c9B898AzIU4jORd88rQyutaQALjacmCGTiaGuRTv3DN6gQScfichEGg/640?wx_fmt=other)  
  

这里是解壳 APP 的 androidmanifest.xml，可以看到主启动 activity 为我们待加固 app 的入口。

  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EyFPj5ftBqTR8qDMicR6C65v6Nz5ghTeytBtnp2ia7worNkDDQT3ZTapyGz1Z58psiaR7SrpU5KTRww/640?wx_fmt=other)  
  

因为壳 apk 不需要进入 UI 界面交互，需要在壳 apk 运行起来，对源 app 进行解密然后运行。这里我们直接替换，后面也不需要进行修改了。

2、解壳 app 的 androidmanifest.xml 增加一个描述信息，用于在动态运行的时候，将壳的 application 替换为源 app 的 application，完成 app 的正常启动。

```
        <meta-data
            android:
            android:value="com.android.sourceapp.XApplication"/>


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EyFPj5ftBqTR8qDMicR6C65N5O5e9veC8eLgpCd8ZxYJ3F7RLc2MnIic23CiaQOvQeDwIObKoicZlG1Q/640?wx_fmt=other)  
  

这其实导致了我失败很多次，我一直都没搞明白，这个 com.android.sourceapp.XApplication 指的是源 app 的 Activity 还是壳的 Activity，经过修改总是失败，最后在大佬的帮助下才明白，这个是源 app 的一个类。

  
他的定义如下：  
甚至不需要做什么操作，只是作为源 app 加载的入口（如果这里写成 MainActivity，经过实验发现失败）。

```
package com.android.sourceapp;

import android.app.Application;

public class XApplication extends Application {
    @Override
    public void onCreate() {
        super.onCreate();
    }
}


```

3、我们将这些做完之后，使用壳程序进行加密，生成加密之后的 dex，直接替换原 app，不用签名安装。

  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EyFPj5ftBqTR8qDMicR6C65rNT1cwT3LyBfXHVwHfO57TDR0nZKoia7LC8w9uo94MoojlZMyOmkFww/640?wx_fmt=other)  
  

但是有的师傅需要签名安装才可以成功，好奇怪啊，我签名再次安装就失败。

  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EyFPj5ftBqTR8qDMicR6C650yLKDr2jFSt9gaxbHNn4G6eeWdWzQmZVTekMINKByjGBQbtLvpodeg/640?wx_fmt=other)

```
四





实战运行结果

```

打开壳 apk：

  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EyFPj5ftBqTR8qDMicR6C65bSnz4N54IUJVykHcBxqrMKmrgRbZj5uiaiaFuAicKbVnQy5z88ia1M4YIw/640?wx_fmt=other)

稍等 1 秒后（第一次运行会进行解密，第二次就直接运行解密之后的 apk 了，因此叫落地加载）：

  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EyFPj5ftBqTR8qDMicR6C65mjWIvO9f5iaTWKf3SppjiarZ9t0p64AHaKibuwmHn9NbUiaoDzqQExPojg/640?wx_fmt=other)

参考
==

Jack_Jia ：Android APK 加壳技术方案【1】【2】

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8EyFPj5ftBqTR8qDMicR6C65GVkjalLlWHrQveFYU4MDFhZZcmk3xVWeLrgFzrFyqQiby7YjUvOrobg/640?wx_fmt=jpeg)

  

**看雪 ID：NYSECbao**

https://bbs.kanxue.com/user-home-971547.htm

* 本文为看雪论坛优秀文章，由 NYSECbao 原创，转载请注明来自看雪社区

[![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8F83b421Xm6wQsrFRVtSE1uuHL9W6iawicMj2IMhfCVH2aeCJibKfAyfxiahyeiaK98AsslObjgxjxIwaw/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458525905&idx=1&sn=04888c8d1ad83b2e3ea0b25df5455cab&chksm=b18d105b86fa994d220369d7d52a90e644ce815f4a53b41d7bb00f5ad623e118315f767c5257&scene=21#wechat_redirect)

**#** **往期推荐**

1、[IOFILE exploit 入门](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458520921&idx=1&sn=f09294c96a021a3e69880a1b822bcf55&chksm=b18d3dd386fab4c5fa3e48909d9b80c69758dbeeceef254b366198d0ed0841b6b2161372a26c&scene=21#wechat_redirect)

2、[入门编译原理之前端体验](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458520920&idx=2&sn=c8a1a9b482273e1c4bf6cc0bc67ab279&chksm=b18d3dd286fab4c43189c7006b599764b71df1d8a4c8ea1cf52b658f08ad4901f1a0268911df&scene=21#wechat_redirect)

3、[如何用纯猜的方式逆向喜马拉雅 xm 文件加密 (wasm 部分)](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458520903&idx=2&sn=e6e0bce3e2e7eda7d02c5612d42c0e32&chksm=b18d3dcd86fab4dbf5e0349d4569df9289c0fc2208dd9cd1857a27b911d56b4540bdbb33f6b5&scene=21#wechat_redirect)

4、[反恶意软件扫描接口 (AMSI) 如何帮助您防御恶意软件](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458520791&idx=2&sn=8ac9d6992651e1f934ef2a4f5b51bbae&chksm=b18d3c5d86fab54bc1aa6d98fd5c9a3fe71b07248ee7299c8b639570d103a69cf0520824c65d&scene=21#wechat_redirect)

5、[sRDI — Shellcode 反射式 DLL 注入技术](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458520789&idx=2&sn=b659748cafb83cbe4f2def3f5e303f2a&chksm=b18d3c5f86fab549c96b5fd60236e40bdf4ea3b9a974f2c50736ead02fe45d79ecea8fb258e5&scene=21#wechat_redirect)

6、[对 APP 的检测以及参数计算分析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458520741&idx=1&sn=e7585bf06e15ffeabd42f49338870170&chksm=b18d3c2f86fab5390560ffb75002d93eed3a6c29c47fc76831aed2e61e2e5415d439f2a060e3&scene=21#wechat_redirect)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif)

**球分享**

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif)

**球点赞**

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif)

**球在看**