<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/9JbK3VEfJGCiOAubCL-xdw)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

免责声明

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者及本公众号不为此承担任何责任。

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

CVE-2019-10744

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

漏洞 **CVE-2019-10744** 指出，JS 库 lodash 中 lodash.mergeWith、lodash.merge、lodash.set 等方法存在原型链污染的问题，我们以 lodash.set 为例，研究一下在实际情况下原型链污染是怎么发生的。

写一个函数测试的脚本：

```
var lodash = require('lodash');
var result = lodash.set({}, "__proto__.evil", "evil!!!!");
console.log({}.evil);

```

运行代码，可以看到原型链已经遭到污染，任何一个对象都有了 evil 属性：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9BT4pcxlnjkgY2o0s0Ov56frAYvnv6ohzJU7fzhFLtAUJOuiafib0Z9PAzhHLCeMxxaydqFUVwq3TWA/640?wx_fmt=png)

我们跟踪 set() 函数，看看漏洞如何发生：

1.   进入 set 函数，随后进入 baseSet
    

```
function set(object, path, value) {
      return object == null ? object : baseSet(object, path, value);
}

```

2. 进入 baseSet，关键在这一行 assignValue(nested, key, newValue);, 其中, nested 就是我们输入的 object，key 就是我们输入的 key 路径中的每一条路径，newValue 就是我们输入的 value。在我们构造了 payload:"__proto__.evil", "evil!!!!" 后，path = castPath(path, object); 会把我们的 key 变为 [’__proto__’,’evil’] 的 Array，然后遍历这个 Array，分别对__proto__和 evil 执行两次 assignValue，当没有遍历到数组最后一个值，也就是 evil 时，会直接复制为 object 原本的值。

```
function baseSet(object, path, value, customizer) {
  if (!isObject(object)) {
    return object;
  }
  path = castPath(path, object);
  var index = -1,
      length = path.length,
      lastIndex = length - 1,
      nested = object;
  while (nested != null && ++index < length) {
    var key = toKey(path[index]),
        newValue = value;
    if (index != lastIndex) {
      var objValue = nested[key];
      newValue = customizer ? customizer(objValue, key, nested) : undefined;
      if (newValue === undefined) {
        newValue = isObject(objValue)
          ? objValue
          : (isIndex(path[index + 1]) ? [] : {});
      }
    }
    assignValue(nested, key, newValue);
    nested = nested[key];
  }
  return object;
}

```

3. 进入 assignValue，随后进入 baseAssignValue

```
function assignValue(object, key, value) {
  var objValue = object[key];
  if (!(hasOwnProperty.call(object, key) && eq(objValue, value)) ||
      (value === undefined && !(key in object))) {
    baseAssignValue(object, key, value);
  }
}

```

4. 进入最关键的函数 baseAssignValue，注意看代码 object[key] = value;, 是不是就是文章开头给出的 obj[a][b] = value; 样式？只是在 baseSet 中，把 obj[a][b] = value 分解了: obj[a] = obj[a]，obj[a][b] = value 两次执行

```
function baseAssignValue(object, key, value) {
  if (key == '__proto__' && defineProperty) {
    defineProperty(object, key, {
      'configurable': true,
      'enumerable': true,
      'value': value,
      'writable': true
    });
  } else {
    object[key] = value;
  }
}

```

5. 因此，在我们构造了 payload:"__proto__.evil", "evil!!!!" 后，会执行两次 baseAssignValue，第一次是 baseAssignValue(object, __proto__, object.__proto__)，第二次是 baseAssignValue(object, __proto__.evil, evil!!!)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

总结

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

本文介绍了 JavaScript 原型链污染中有名的漏洞 CVE-2019-10744，让我们对 JavaScript 原型链污染有了直观的认识。下一章我们将介绍如何自己写代码批量刷原型链污染漏洞，自动化刷洞的方法已经放在 Github，点击原文链接可以直达。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9B7vZdL5TFiaHdDq5o1RLL1ja6dE33eaySFgeGz1d7As5DibPIUNnwgx7eKPcVEz8FwFTB1ygqOdgbg/640?wx_fmt=png&from=appmsg)