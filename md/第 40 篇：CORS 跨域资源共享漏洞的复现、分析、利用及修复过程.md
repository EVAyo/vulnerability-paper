<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/PSU8T-IO3mAz4MEVvAeUug)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
--------------

CORS 跨域资源共享漏洞与 JSONP 劫持漏洞类似，都是程序员在解决跨域问题中进行了错误的配置。攻击者可以利用 Web 应用对用户请求数据包的 Origin 头校验不严格，诱骗受害者访问攻击者制作好的恶意网站，**从而跨域获取受害者的敏感数据，包括转账记录、交易记录、个人身份证号信息、订单信息等等**。

近几年在很多的渗透测试报告中，CORS 跨域资源共享漏洞越来越多了。有的朋友实在挖不出漏洞，偶尔就会写上一个 CORS 跨域资源共享漏洞出一份报告，但是细究起来以下几个问题，却都模棱两可，搞不明白。

**1.** 什么是 CORS 漏洞？

**2.** 哪些情况下的 CORS 漏洞是高危漏洞？哪些情况下 CORS 漏洞是没有危害的？

**3.** CORS 漏洞的怎么利用？

**4.** CORS 漏洞的修补建议？

很多朋友**以为 Web 应用返回 Access-Control-Allow-Origin: * 就是存在漏洞，其实这个判断是不完善的**。本期 ABC_123 自己写了一个 Java 的测试环境，给大家演示一下 CORS 漏洞的复现过程及利用过程，相信大家一看就明白了。

 **Part2 CORS 漏洞测试结果** 
-----------------------

首先给出 ABC_123 的测试结果，以下结论是我自己写 Java 代码搭建环境进行测试给出的结论，欢迎大家批评指正。首先使用 burpsuite 抓包对 http 请求添加 **Origin: http://www.attacker.com** 进行测试：

 **1**  如果返回头是以下情况，那么就是高危漏洞，这种情况下漏洞最好利用：

Access-Control-Allow-Origin: https://www.attacker.com

Access-Control-Allow-Credentials: true

 **2**  如果返回头是以下情况，那么也可以认为是高危漏洞，只是利用起来麻烦一些：

Access-Control-Allow-Origin: null

Access-Control-Allow-Credentials: true

 **3**  如果返回以下，则不存在漏洞，因为 Null 必须是小写才存在漏洞：

Access-Control-Allow-Origin: Null

Access-Control-Allow-Credentials: true

 **4**  如果返回以下，可认为不存在漏洞，因为 CORS 安全机制阻止了这种情况下的漏洞利用，也可以写上低危的 CORS 配置错误问题。

Access-Control-Allow-Origin: *

Access-Control-Allow-Credentials: true

 **5**  如果返回以下，可认为不存在漏洞，也可以写上低危的 CORS 配置错误问题。

Access-Control-Allow-Origin: *

 **Part3 CORS 跨域漏洞复现** 

*   **一般 CORS 漏洞的测试过程**
    -------------------
    

首先复习一下常规的 CORS 漏洞测试过程：抓取一个能够返回个人敏感数据的 HTTP 请求包，添加 Origin: http://www.xxx.com，查看返回头中是否包含 “Access-Control-Allow-Origin: *”、“Access-Control-Allow-Credentials: true”，这里说明一点，如果返回包中这两个头同时存在，那么它其实是不存在 CORS 漏洞的。接下来依据 Access-Control-Allow-Origin、Access-Control-Allow-Credentials 的不同返回值的各种情况，分别写 Java 代码测试一下，是否能够获取敏感数据，大家就明白了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeyebdlt6t5oSHHZW5KOq9uII1jmoG1hzlswbETWIiaGl2wNGm7dW7DHAuQ/640?wx_fmt=png)

*   **编写 Java 代码测试**
    ----------------
    

接下来我用 Java 编写了两个 Servlet 代码模拟一个 Web 购物网站，用 JS 前端代码模拟攻击者构造的 CORS 漏洞利用 html 页面。

如下所示，首先是登录界面的 servlet 代码如下。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeyeDOcuUUicFMkzwkNicqvTjo4PCqN3SzjLqr2PTkmgWUIQvzib2UL6OZDKg/640?wx_fmt=png)

代码效果如下，用户输入用户名密码后，购物网站提示登录成功，这时候后台代码已经生成 Cookie。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeye7wmIUwrJFoejZKeu5LFdmwOia0vLQGcsFUicjRdM4WQ2hgk4icSkOJUCw/640?wx_fmt=png)

接下来用户访问 PersonInfo 页面，http://192.168.237.1:9999/Servlet/PersonInfo 会显示交易密码是 123456。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeyens5VFu2SicJyehU48j2qic4TaG4OzNbA9X2ZhBxAXPFqzAKusV8CY20A/640?wx_fmt=png)

此页面对应的 PersonInfo 的 Sevlet 代码如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeyeBDF2tiarxrgQOiagGvJpqLlib6NxicgicxNY8qAoV4B0oZSMyPMJDyGRtTQ/640?wx_fmt=png)

接下来攻击者为了获取该购物网站用户的交易密码，精心构造了如下的 attack.html 页面放到 Web 服务器上，此时攻击 URL 是 **http://www.attacker111.com/attack.html**。攻击者将此 URL 发给受害者浏览，受害者的交易密码将会被获取到。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeye82mwMHquThzacm1mTFcNxtYyk5wrv9DfD64gyBNlaBAxE9C9RwhOug/640?wx_fmt=png)

*   **第 1 种情况：**
    ------------
    

首先看第 1 种情况，服务器返回如下消息头，这种情况下，非常好利用，所以漏洞定级是高危：

**Access-Control-Allow-Origin: https://www.attacker.com**

**Access-Control-Allow-Credentials: true**

这两个返回头表示应用程序允许来自任何 Origin 的任何脚本向应用程序发出 CORS 请求，这时候程序员的代码是这样写的：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeyeoHhDDYGLwJ3UYuFnibAHoYjgwaTrlYSNPqG5DlEaBCta49UzX6Hzu1Q/640?wx_fmt=png)

受害者访问攻击者构造好的 URL 之后，成功获取用户的敏感数据。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeye1pW9nkicX1hVslMWApaYibQOg2r3KPIhdKEupeE3f8IryK7SZCibRNUAw/640?wx_fmt=png)

F12 查看浏览器发出的请求，发现其带上了 Cookie，成功绕过跨域的同源限制。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeyehqrgVh2MOC1XawfOib0scOLWfWibyfBRUX5FOn4gIV6iaObuq56ca23Tg/640?wx_fmt=png)

*   **第 2 种情况：**
    ------------
    

服务器返回如下消息头，这种情况下，利用起来稍有困难，这里的 null 必须全部都是小写，漏洞仍然是高危。

**Access-Control-Allow-Origin: null**

**Access-Control-Allow-Credentials: true**

在这种情况下，应用程序 HTTP 响应头 Access-Control-Allow-Origin 的值始终为 null。当用户指定 null 以外的任何值时，应用程序不会处理。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeyez9IIDmDEHicDvem60z0btdddZPEVrfkeVLZUnQ6jB0yLwTOPuVoB03A/640?wx_fmt=png)

这时候访问 http://192.168.237.199/attack.html，发现浏览器提示 CORS 策略错误。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeyeXwjypYkRalCPTnN2JmpAZd37nzxkZY5GdsBrZbSjeOKBHhIlCibFnUw/640?wx_fmt=png)

因为这时候的 Origin 不等于 null

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeyeRo6dUUpKRq0gwiaoiaicia5fWHDLEZ3qibuvhMiaPOwXY1ibpfiaom29jZzavw/640?wx_fmt=png)

这里需要想办法让 Origin 等于 null，于是攻击者构造如下 js 代码：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeye5wIiayYKsBhQiaQNtFPZ4IHNkHuOcOta80KWvXWCCcFvJPD4dia7bAVQQ/640?wx_fmt=png)

此时发现仍然可以成功获取用户的敏感数据。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeye4ycyuU6V5Zawrl8ubZDM6XTmBia6zjNt9nSCV3GMBtM4gLCAR1yw3uA/640?wx_fmt=png)

*   **第 3 种情况：**
    ------------
    

服务器返回如下消息头，这种情况下，其实是不存在漏洞的，如果非要牵强地说存在漏洞，可以协商 CORS 配置错误，毕竟设置为 * 本身就有问题。

**Access-Control-Allow-Origin: ***

**Access-Control-Allow-Credentials: true**

对应着 java 代码如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeyeiayMPzrfcKE05qLfIFpJvGgL5WpyJdthGYoMk9s2jdP4PhVbzEcOeYg/640?wx_fmt=png)

访问 http://www.attacker111.com/attack.html 发现，浏览器直接报错，看来这种情况根本不被安全策略所允许。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeye9I6bHNzHURpCoR9PdvvGNBaelVau3U8bbA2OUCuaafXd8HFTJuHatg/640?wx_fmt=png)

*   **第 4 种情况：**
    ------------
    

服务器返回如下消息头，这个就不演示了，只能说明 CORS 配置存在问题，但是没法获取敏感数据，漏洞评级应为中危或者低危。

**Access-Control-Allow-Origin：***

*   **Chrome 浏览器测试结果**
    ------------------
    

接下来换谷歌 Chrome 浏览器最新版本下测试，发现确实成功绕过了同源策略，发起了跨域请求，但是 Chrome 浏览器却没有为请求带上 Cookie，所以漏洞利用有限。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AwUUvFfXxsRyLtiaCaxIeye8utHYOibkPGKqYKJibywJHBjibMnTqUSNib8qjpuaxcDYgCpneu538CkfQ/640?wx_fmt=png)

 **Part4 修补建议** 
----------------

**1.** Access-Control-Allow-Origin 中指定的来源只能是受信任的站点，避免使用 Access-Control-Allow-Origin: *，避免使用 Access-Control-Allow-Origin: null，否则攻击者可以伪造来源请求实现跨域资源窃取。

**2.** 严格校验 “Origin” 值，校验的正则表达式一定要编写完善，避免出现绕过的情况。

**3.** 减少 “Access-Control-Allow-Methods” 所允许的请求方法。

**4.** 除了正确配置 CORS 之外，Web 服务器还应继续对敏感数据进行保护，例如身份验证和会话管理等。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**专注于网络安全技术分享，包括红队攻防、蓝队分析、渗透测试、代码审计等。每周一篇，99% 原创，敬请关注**

Contact me: 0day123abc#gmail.com(replace # with @)

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)