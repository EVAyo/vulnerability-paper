<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/YVthE8_jCQGRz23C0pa4oQ)

最近有个需求，查了些资料发现，Telegram 有语音通话功能，也可以类似 QQ 一样通过语音通话的连接获取对方的 IP 地址， Denis Simonov （原文为俄语）发表过一篇文章，演示了如何通过 Telegram 语音呼叫获取目标人员的 IP 地址，只需 5 秒的呼叫时间就能拿到 IP。原文在这：https://n0a.pw/telegram-get-remote-ip/，我尝试复现了下

获取 IP 复现
--------

Telegram 使用了 STUN 协议流量。STUN（NAT 会话遍历）是一种标准化协议，旨在帮助 NAT（网络地址转换）后面的设备确定其外部 IP 地址以及其网关上使用的 NAT 类型。该协议的本质是使设备能够了解其公共 IP 地址并确定哪些端口可用于传出连接。

STUN 消息中携带的关键属性之一是 XOR-MAPPED-ADDRESS。该属性包含消息发送者的公共 IP 地址。数据包的方向准确地确定了此属性中包含谁的 IP 地址：如果该帧定向到我，XOR-MAPPED-ADDRESS 将显示我的 IP，如果它是从我发送的，则显示我的对话者的 IP。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ESFRPeynAv7R4ulXyts0OicDZibdE8CpEmicBGXfE0jeh0f7uvXWdApMbNpTOPCqJNmzVKJ0VE9rX7xJTzFQNEhZQ/640?wx_fmt=png)

1. 启动 wireshark  
2. 语音呼叫目标  
3. 一旦被接听，只需等待大约 5 或 10 秒后我们应该有足够的数据包来找出目标的 IP  
4. 在 Wireshark 中我们通过 stun 进行过滤

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/ESFRPeynAv7R4ulXyts0OicDZibdE8CpEmusFqmXwz7I1ZkBK9bzkic5Eyghy84OicmkwgsfoTNTTXlqdwsKIkzxJg/640?wx_fmt=jpeg)

5. 目标的 IP 地址，是携带 XOR-XXXXX-ADDRESS 数据包，所以我们可以过滤: 'stun 或 stun.att. 用户名 或 stun.att.ipv4-xord 或 stun.att.ipv4'

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ESFRPeynAv7R4ulXyts0OicDZibdE8CpEmIFJ2JId692IMLMoISVBTUhPfrfibrWichhI86fSCXSiam79ITRIkeVfPg/640?wx_fmt=png)

6. 通过查看每个数据包的 IP 地址来检查数据包。这可以通过检查数据包并在属性部分中查找 XOR-XXXX-ADDRESS 或通过查看数据包的目标地址来查看。数据包。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ESFRPeynAv7R4ulXyts0OicDZibdE8CpEmHdGNt3ugB53wuSfchAMtoUpsgq1Ixia90KuiciazPCYMUto23dOO5kXFQ/640?wx_fmt=png)

7. 以下 IP 可以排除：  
a) 私有 IP，例如 192.168.XX、10.XXX 等。  
b) 我们的公共 IP 地址。  
c) 属于 Telegram 的地址：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ESFRPeynAv7R4ulXyts0OicDZibdE8CpEm83fJCTaeGlCK88Vf7WubQRTf17ugwn4kbJdpn4xfQQa6OpGmzhKBGg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ESFRPeynAv7R4ulXyts0OicDZibdE8CpEmC8Q6cOZSnOGqV2nhnY3jQf7jpzWyMvGgibibUuPicyaVDqst3iby7PZTOA/640?wx_fmt=png)

有个方便的技巧，使用 wireshark 获取已通过 stun 协议查询的所有地址，而无需手动查看数据包： 在工具栏中我们点击 Statistics -> Endpoints，选择限制显示过滤器勾选（使用 wireshark 中的 stun 过滤器），只显示与 stun 通信期间使用的 IP，就可以方便的筛查。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ESFRPeynAv7R4ulXyts0OicDZibdE8CpEmbDFFalLBaBcTKtzOugbwTBETXN88iccqOX4iasRs9ErCu5l5j5zF14uQ/640?wx_fmt=png)

自动化脚本
-----

原帖作者 (Denis Simonov) 在他的 GitHub 上发布了一个脚本以方便利用：https://github.com/n0a/telegram-get-remote-ip

1.  安装适用于 Linux 或 Mac 的 Telegram 桌面。
    
2.  安装 tshark（sudo apt install tshark 或下载适用于 macOS 的 Wireshark。包含 tshark）。
    
3.  运行脚本
    
4.  语音呼叫要获取的 IP 地址的人
    
5.  收获结果 IP
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ESFRPeynAv7R4ulXyts0OicDZibdE8CpEmbdGERXdsejh0b0DLjk909JUicOusHNHpapD04xje2fku1aRM2XuMU5g/640?wx_fmt=png)

以 Ubuntu 20 为例安装和启动
-------------------

```
$ sudo apt update
$ sudo apt install -y python3-pip python3-venv tshark
$ git clone https://github.com/n0a/telegram-get-remote-ip
$ cd telegram-get-remote-ip
$ python3 -m venv venv
$ source ./venv/bin/activate
$ sudo pip3 install -r requirements.txt
$ sudo python3 tg_get_ip.py

```

遇到的小坑：_为了保护 Telegram 用户的隐私，默认情况下，仅针对 “我的联系人” 激活 Telegram 通话中的点对点 (P2P) 选项。Telegram 设置 > 隐私和安全 > 通话，可以选择是否对所有人、联系人使用 P2P。_