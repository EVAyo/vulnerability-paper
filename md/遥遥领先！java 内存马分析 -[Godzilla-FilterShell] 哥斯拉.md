<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/JJVzhpZufweM6K4ELu8yRA)

考虑到很多小伙伴还不懂 java 内存马，所以我打算新开一个系列，完善分享体系

为了方便演示，我们通过 Godzilla 写入 webshell，地址为: http://localhost:8080/jiaju_mall/webshell.jsp

加密模式为：**AES_BASE64**

**一、什么是 Filter**

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ3gfwI49ZkvepFDIbplGVGocmrI9B7I446t9pU4kjkwgicWoGqF3H8uVw/640?wx_fmt=png)

**Filter** 作为 **servler-api** 的三大件之一，顾名思义就是起到过滤作用: 对 web 服务器管理的所有 web 资源, 例如 **Jsp**, **Servlet**, 静态图片文件或静态 **html** 文件等进行拦截，实现一些特殊的功能。例如权限访问控制、过滤敏感字符 (例如 sql 注入、RCE 会出现的危险字符串)

在内存马技术中，Filter 类型也被广泛使用，优先级通常比较高，且实现的拦截路径比较特殊, 例如: /favicon.ico

当然，实现的拦截路径和优先级，可以根据不同环境自定义设置

**二、Arthas**
============

排查的思路，通过 Java Agent 遍历加载到内存中的 class，进行分析

这篇文章使用 **Arthas** ，实战环境也经常用到

安装 & 使用：https://arthas.aliyun.com/doc/install-detail.html

命令文档：https://arthas.aliyun.com/doc/commands.html

需要注意，在使用 **Arthas** 的时候，要和 **web** 程序权限相同

**三、哥斯拉 FilterShell 型分析**

废话不多说，环境搭建：Tomcat，一个支持 jsp 的 web 站点

FilterShell 上传前，获取所有的 Filter，这个站点中，只存在初始化用的 WebSocket

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ3pibSMOBbrDDJAhAeRT6nYolKPHLeRwJaJcthz1oVJ3o3M25Y0xxzDZA/640?wx_fmt=png)

点击：addFilterShell 再次获取，得到：ValueInstantiators1697030134135

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ3jibnHq0qaLUGibZeiaVx5IZFMr7bPN7sNmDm1Zovq2O2f20gicasqL9KqA/640?wx_fmt=png)

Arthas 查看存在的 Filter : mbean | grep "j2eeType=Filter"

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ3LHw0ia8G5akMxIOFa37pfs1SAgfJgibEVZOT4U6RRiaCIOSaorCS0bjGA/640?wx_fmt=png)

可以发现：Godzilla 的 FilterShell 存在非常明显的特征 ⇒ 尾部时间戳   **1697030134135**   →    2023-10-11 21:15:34

接着，根据得到的 Filter 名称继续分析:

`sc *.Filter | grep "ValueInstantiators"` ⇒ 得到类全路径

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ3oTVuIviaqZXQH0PSDNkdia1nYmszwKpc0pVXpmVDsxVRECRFJRBJIicwQ/640?wx_fmt=png)

再接着分析 sc -d org.apache.coyote.deser.ValueInstantiators

看到这里就非常清晰了，**classloader** 暴露了它为恶意对象

该类被 **webshell.jsp** 进行加载，**webshell.jsp** 再由 **JasperLoader** 进行加载

```
+-org.apache.jsp.webshell_jsp$X@17915e77
+-org.apache.jasper.servlet.JasperLoader@4c9262a3

```

‍

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ3wLplVKpE32jfRtpUXQlt63ricbd3w5gOYuGZxbXQy34vaxIaFeS6AibA/640?wx_fmt=png)

[  jsp 的本质是一个 Servlet， Servlet-api 一般是由 **WebappClassLoader** 进行加载 ，若其 classloader 不是 **WebappClassLoader**，则可能为恶意

**JasperLoader** 会被用于热加载更新文件，类似文件上传的 webshell，classloader 便会是 **JasperLoader** ]

为了进一步确定我们的猜想，对类 dump 到本地反编译:

dump -d D:/webshell-dump org.apache.coyote.deser.ValueInstantiators

也可通过下述命令，在窗口查看

jad org.apache.coyote.deser.ValueInstantiators

拖拽 class 文件进 jd-gui 进行反编译:

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ3biaCDTmMoUoPBYkVnia5LkhPhTTlxG6lYHsOQ0F2Hhn4uO1sHlGjgJEA/640?wx_fmt=png)

Filter 存在 doFilter 方法，为拦截器的核心方法之一，而执行 doFilter() 的时候，调用了 _jspService()  

义眼丁真鉴定为:Vulnerablity

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ31uu4wHphTqpy6RW7BaqlyYWtQRh5kUQYICetfJK6YVWjL0qCVqygLQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ3V3SbFls6fxruuMSIe03556WFfxiahQxR9CSqNUgWHibmNlvuiaWLHao9A/640?wx_fmt=png)

也存在自写的加密方法等  

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ3M2ngxbywz0TbteePHOKvW813dSqyiaWx46NMn9gibslD6TV4JbOpcSiaQ/640?wx_fmt=png)

顺便说一句,FilterShell 的名字在 addFilter() 方法时候进行了指定  

![](https://mmbiz.qpic.cn/mmbiz_png/drOLIiakV5uoaZN0CHf3IjEfqIE6P9sJ3RLK7CvqibBcVYqJk60s77S4nSzu2GFednjnJnpRN7K50U1Ke8F1GD4Q/640?wx_fmt=png)

**四、整体的排查思路**

1.  **filter 名字很特别**
    
    内存马的 Filter 名一般比较特别，有`shell`或者随机数等关键字。这个特征稍弱，因为这取决于内存马的构造者的习惯，构造完全可以设置一个看起来很正常的名字。
    
2.  **filter 优先级是第一位**
    
    为了确保内存马在各种环境下都可以访问，往往需要把 filter 匹配优先级调至最高，这在 shiro 反序列化中是刚需。但其他场景下就非必须，只能做一个可疑点。
    
3.  **对比 web.xml 中没有 filter 配置**
    
    内存马的 Filter 是动态注册的，所以在 web.xml 中肯定没有配置，这也是个可以的特征。但 servlet 3.0 引入了`@WebFilter`标签方便开发这动态注册 Filter。这种情况也存在没有在 web.xml 中显式声明，这个特征可以作为较强的特征。
    
4.  **特殊 classloader 加载**
    
    我们都知道 Filter 也是 class，也是必定有特定的 classloader 加载。一般来说，正常的 Filter 都是由中间件的 WebappClassLoader 加载的。反序列化漏洞喜欢利用 TemplatesImpl 和 bcel 执行任意代码。所以这些 class 往往就是以下这两个：
    
    这个特征是一个特别可疑的点了。当然了，有的内存马还是比较狡猾的，它会注入 class 到当前线程中，然后实例化注入内存马。这个时候内存马就有可能不是上面两个 classloader。
    

*   com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader
    
*   com.sun.org.apache.bcel.internal.util.ClassLoader
    

6.  **Filter 的 doFilter 方法中有恶意代码**
    
    我们可以把内存中所有的 Filter 的 class dump 出来，使用`gui`等反编译工具分析看看，是否存在恶意代码，比如调用了如下可疑的方法：
    

*   java.lang.Runtime.getRuntime
    
*   defineClass
    
*   invoke
    

**★  
**

**付费圈子  
**

  

  

**欢 迎 加 入 星 球 ！**

**代码审计 + 免杀 + 渗透学习资源 + 各种资料文档 + 各种工具 + 付费会员**

![](https://mmbiz.qpic.cn/mmbiz_gif/pLGTianTzSu7XRhTMZOBAqXehvREhD5ThABGJdRialUx3dQWwO7fclsicyiajicKfvXV4kHs38nkwFxUSckVF2nYlibA/640?wx_fmt=gif&random=0.4447566002908574&tp=wxpic&wxfrom=5&wx_lazy=1)

  

****进成员内部群****

![](https://mmbiz.qpic.cn/mmbiz_jpg/pPVXCo8Wd8AQHAyOTgM5sLrvP6qiboXljGWG0uOdvcNR8Qw5QJLxSVrbFds2j7MxExOz1ozb9ZoYwR68leoLdAg/640?wx_fmt=jpeg&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

![](https://mmbiz.qpic.cn/mmbiz_gif/pLGTianTzSu7XRhTMZOBAqXehvREhD5ThABGJdRialUx3dQWwO7fclsicyiajicKfvXV4kHs38nkwFxUSckVF2nYlibA/640?wx_fmt=gif&random=0.09738205945672873&tp=wxpic&wxfrom=5&wx_lazy=1)

  

****星球的最近主题和星球内部工具一些展示****

![](https://mmbiz.qpic.cn/mmbiz_jpg/pPVXCo8Wd8Doq0iczyRiaBfhTQyfzqSGuia4lfHfazabEKr2EDe7sGVoxUhLrNRA4FbI1yef6IkWdmzxvZrTiaJncg/640?wx_fmt=jpeg&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8BmE6FAA8Bq7H9GZIRt1xYZpmYNWxrrzolt71FtX5HyM03H0cxkiaYelv7ZSajLtibEdBXUpCibdItXw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8ADSxxicsBmvhX9yBIPibyJTWnDpqropKaIKtZQE3B9ZpgttJuibibCht1jXkNY7tUhLxJRdU6gibnrn0w/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DKZcqe8mOKY1OQN5yfOaD5MpGk0JkyWcDKZvqqTWL0YKO6fmC56kSpcKicxEjK0cCu8fG3mLFLeEg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8CKksEIzZyEb3tEFGzGYSXfribrG4jKOkRKGKYb7zk7MTNZPT6Wp3bLd2BPhuFHddIL6sqrg1d2qHQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8D0bS8ibc3XhFcDYkVusFvc3c6onthQpPGZn4v32rpOp7CeFiamGdeC7JBk0mGVsiciazLp3z0SIJAtnQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8B96heXWOIseicx7lYZcN8KRN8xTiaOibRiaHVP4weL4mxd0gyaWSuTIVJhBRdBmWXjibmcfes6qR1w49w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DKZcqe8mOKY1OQN5yfOaD5MpGk0JkyWcDKZvqqTWL0YKO6fmC56kSpcKicxEjK0cCu8fG3mLFLeEg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8AqNwoQuOBy9yePOpO5Kr6aHIxj7d0ibfAuPx9fAempAoH9JfIgX4nKzCwDyhQzPrRIx4upyw5yT4Q/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8CzYcn7C4DHT0vibm3SyRASB2Rz5WYRNLKHragHRliaADVFCc97licvVdY0lfRDeIK9MibelOPMiapTT3w/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)**

![](https://mmbiz.qpic.cn/mmbiz_gif/pLGTianTzSu7XRhTMZOBAqXehvREhD5ThABGJdRialUx3dQWwO7fclsicyiajicKfvXV4kHs38nkwFxUSckVF2nYlibA/640?wx_fmt=gif&random=0.4447566002908574&tp=wxpic&wxfrom=5&wx_lazy=1)

  

**加入安全交流群**

 [![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DungicHdGVdJpoQp8uIUIs1rP8lb21yu5ndpdotiaGqicq8x5IFcKNpE8WsmrPDpohlNfTf2pf2GJUg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247489372&idx=1&sn=5e14ba5fa59059fb1ee405e56ef90d40&chksm=c175eaf3f60263e5ef5415a8a9fc134f0890fdb9c25ab956116d17109baf98b3bd6bed572a2d&scene=21#wechat_redirect)                

**关 注 有 礼**

  

  

关注下方公众号回复 “666” 可以领取一套领取黑客成长秘籍

![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic) 还在等什么？赶紧点击下方名片关注学习吧！![](https://mmbiz.qpic.cn/mmbiz_png/XOPdGZ2MYOeSsicAgIUNHtMib9a69NOWXw1A7mgRqqiat1SycQ0b6e5mBqC0pVJ3oicrQnCTh4gqMGiaKUPicTsUc4Tw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

![](https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)  

**推荐阅读**

[****干货｜史上最全一句话木马****](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247489259&idx=1&sn=b268701409ad4e8785cd5ebc23176fc8&chksm=c175eb44f60262527120100bd353b3316948928bd7f44cf9b6a49f89d5ffafad88c6f1522226&scene=21#wechat_redirect)

[**干货 | CS 绕过 vultr 特征检测修改算法**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486980&idx=1&sn=6d65ae57f03bd32fddb37d7055e5ac8e&chksm=c175f3abf6027abdad06009b2fe964e79f2ca60701ae806b451c18845c656c12b9948670dcbc&scene=21#wechat_redirect)  

[**实战 | 用中国人写的红队服务器搞一次内网穿透练习**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247488628&idx=1&sn=ff2c617cccc00fe262ed9610c790fe0e&chksm=c175e9dbf60260cd0e67439304c822d28d510f1e332867e78a07d631ab27143309d14e27e53f&scene=21#wechat_redirect)  

[**实战 | 渗透某培训平台经历**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247488613&idx=1&sn=12884f3d196ac4f5c262a587590d516d&chksm=c175e9caf60260dcc0d5d81a560025d548c61fda975d02237d344fd79adc77ac592e7e562939&scene=21#wechat_redirect)  

[**实战 | 一次曲折的钓鱼溯源反制**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247489278&idx=1&sn=5347fdbf7bbeb3fd37865e191163763f&chksm=c175eb51f602624777fb84e7928bb4fa45c30f35e27f3d66fc563ed97fa3c16ff06d172b868c&scene=21#wechat_redirect)

**免责声明**

由于传播、利用本公众号渗透安全团队所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号渗透安全团队及作者不为**此**承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！

好文分享收藏赞一下最美点在看哦