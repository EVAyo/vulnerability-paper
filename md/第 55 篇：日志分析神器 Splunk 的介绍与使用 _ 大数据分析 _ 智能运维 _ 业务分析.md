<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/IA2iy5MPxGyt9W2QGNTykQ)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcaA8wBFW4icTiaL7ELd8ia04Olh40TBx7CquHZyCicicl4eYJno2y0oZ0H4A/640?wx_fmt=png)

 **Part1 前言** 

**大家好，我是 ABC_123**。我曾经花费时间搭建各种 Web 服务器、数据库环境去研究分析日志，使用的工具从使用系统自带命令去分析日志，到自动化的 360 星图，再到后期的 Logparser、ELK（ElastiSearch、Kibana、Logstash）等等。到最后我发现还是 Splunk 这款商业版工具用起来更顺手一些，**我个人认为这款软件比 ELK 要好用得多，只不过 ELK 免费开源可以包装成产品，所以受到大家追捧，反之 Splunk 价格昂贵，推广就很受限制**。把 Splunk 用好了足以应付现有的各种日志分析场景，堪称一款神器。

Splunk 这款商业工具是美国人写的（ELK 也是美国人做的），于 2004 年开始研发更新，可以将设备和软件产生的日志数据、性能数据、网络数据包等数据进行采集，然后进行索引、调查、监控、可视化等，当然也可以使用它辅助蓝队日志分析工作，很多用户也用它来做产品营销分析，新版的 Splunk 还可以结合先前的数据对未来一段时间内的客户访问量进行预测。

**欢迎关注我的公众号 "ABC123 安全研究实验室"，99% 原创，不发水文，不发广告**。

 **Part2 Splunk 使用介绍** 

*   **Splunk 的搜索语法**
    ----------------
    

接下来简单介绍一下 Splunk 的搜索语法：

支持布尔运算符（**AND/OR/NOT**），必须是大写

**status=200 NOT action=purchase**

**status=200 action!=purchase**

**500 select** 查找包含 "500" 和 "select" 字样的所有事件

**500 sel*** 查找包含 "500" 和 "sel" 开头单词的所有事件

**status=500** 使用 = 返回准确结果

**head n**   // 返回前 n 个  
**tail n**   // 返回后 n 个  
**top**   // 显示字段最常见 / 出现次数最多的值  
**rare** // 显示字段出现次数最少的值  
**limit** // 限制查询，如：limit 5，限制结果的前 5 条  
**rename xx as zz** // 为 xx 字段设置别名为 zz, 多个之间用 ，隔开  
**fields** // 保留或删除搜索结果中的字段。fiels – xx 删除 xx 字段，保留则不需要 – 符号  

**stats count()**   括号中可以插入字段，主要对事件进行计数  
**stats dc()** distinct count，去重之后对唯一值进行统计  
**stats values()**  去重复后列出括号中的字段内容  
**stats avg()**  求平均值

如下图所示，这张图是从很老的一个 ppt 中改的，可以很直观看到 Splunk 的界面及使用方法。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wmMDo9vl0esOM7r8FE5r5HbemNrVsXJnHJYl050W4JwQngRic6X9eWBw/640?wx_fmt=png)

以下是 Splunk 的仪表板界面的示例，在这个界面中，**蓝队分析人员可以将各种日志分析的分析图表汇总在一起，展示出来非常直观漂亮**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wfreufuRZxIl5wia2g3EqEJAuicbfLyek8e9DibSQ0VBeKom4AzwTcndoA/640?wx_fmt=png)

*   **导入日志文件**
    ----------
    

Splunk 导入日志文件的方法有很多，我比较习惯用以下方式导入日志，具体操作如下：**设置 --> 数据输入 --> 文件和目录 --> 新本地文件和目录**

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wEiaB36g6jMH5Z5EpTOgc92SeTGLZgSfA9TPmDNXDMW6ibrBjW3doW8tw/640?wx_fmt=png)

然后点击 “**文件或目录**” 旁边的 “**浏览**” 按钮，选择一个本机的一个文件夹，比如说 **c:\log111**

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wlib8icqyickic8zD5t3siawBAlibKnGiaEdQYJfKku1hB2J8Dic8ibxhMW5EGxg/640?wx_fmt=png)

后续只要把需要分析的日志文件，放到此文件夹中，Splunk 会自动进行导入。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wAbeibqKUlMSl0RibAJmGgJJ4I3InDq2RWaVw1mU6J56XBObwhwNiaUlBw/640?wx_fmt=png)

在上述文件夹中放置好日志文件之后，打开 Splunk 的主界面，中间有一排绿色的柱状图，显示了每个时间段的 Web 访问次数，**这里需要重点关注的是柱状图中突然出现的很高的柱状部分，极有可能是攻击者进行频繁操作的时间段**。

如果需要对指定的日志文件进行日志分析，则只需要输入以下命令即可：**source="C:\\log1111\\45_secure.txt"**

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2whXpaY3nefwH4515Xa5fMta7g5lviayW11KMAFad9YUI7ukahIy3Ddpw/640?wx_fmt=png)

*   **分析 SQL 注入脱数据行为**
    ------------------
    

使用如下语句，可以快速检索 SQL 注入攻击行为，为了减少误报，可以配合使用 AND 语句拼接 **IISCode!=404**，排除响应码为 404 的搜索结果。如下图所示，结合柱状图可以知道，SQL 注入攻击主要集中在柱状图所示的一个小时左右的时间段内，推测攻击者发现了 sql 注入漏洞，并实施了攻击。**这里仅用了一个 select 关键字，因为攻击者想要使用 sql 注入漏洞去脱数据的话，select 关键字几乎是必用的**。

**index=_* OR index=* sourcetype="SQL_Injectionex" select AND iisCode!=404**

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wHL2qCjI604fpc5vhWtQ9um2UDSgib7zhrd0aDmCpjMV6ycxPtpGoziaA/640?wx_fmt=png)

*   **分析 XSS 攻击行为**
    ---------------
    

使用如下语句，可以快速分析 XSS 攻击行为，通过逻辑运算符 AND 筛选响应码为 200 的日志结果，Splunk 可以支持 **<****、****>** 等标签字符的分析，**使用的时候需要把关键词加上双引号**。

**index=_* OR index=* sourcetype="SQL_Injectionex" "<script>" OR "alert" OR "confirm" AND iisCode=200**

结合 Splunk 的柱状图可以知道，XSS 攻击行为集中在如柱状图所示的 1 个小时时间段内。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wkZ3QjiclicqGTiaonricJZc19POS83GbjViajib06HSfw10zZH2Tdh0VP02A/640?wx_fmt=png)

*   **网站缓慢响应原因分析**
    --------------
    

客户当时发现内网的一个 Web 服务器每到下午 13 点开始就访问特别卡，通过 Splunk 的日志分析结果发现，大约有一个小时左右的峰值访问（如图示中的 1 hour），而且访问的 url 几乎都是 **/shop/rexsearch.asp** 路径，猜想是频繁访问搜索功能，造成了服务器负载过重。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wtmOCuV7PufMa7ib6wIAfS0cAcQNtP4qUj0zJ2VksoFvO84yxfq7HH1g/640?wx_fmt=png)

接下来对 **/shop/rexsearchp.asp** 访问次数进行统计，发现是 2 万 2418 次 POST 请求，只有 2 次 GET 请求。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wiceo4emticrnKWvSpJ7yXtXgaosH5FUjZT4OWJaxCxxgeOCILBM7O8Iw/640?wx_fmt=png)

这个案例后续有时间再给大家详细讲一讲，最后发现是内网的一个漏洞扫描器造成的，每到下午 13 点，就会自动对此 Web 服务器进行漏洞扫描，**扫描器对 s****earch 页面的频繁探测，造成了服务器负载过重**。

*   **分析 SSH 密码爆破事件**
    -----------------
    

如下图所示，为了分析 SSH 口令枚举事件，直接在搜索框中填入 “**authentication**” 关键字，Splunk 分析完毕后给出了一个柱状图，每个柱状图代表 1 分钟内的 SSH 口令攻击次数。根据 Splunk 的柱状图并适当调整时间轴长度，可以直观看到，该日志中暴力破解 SSH 密码行为主要集中在 **12 点 21 分**到 **12 点 22 分**这一分钟内，攻击者进行了总共 5 万 1158 次密码枚举操作。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wF4MuK0G3bVibFyAl0ia6XOrxOEiaWysBHUhomu2xVPqiamFNeCYfciaYNVA/640?wx_fmt=png)

*   **table 表格展示命令**
    ----------------
    

通过 **table** 命令，可以将 Splunk 的检索结果整理成表格格式，而且可以自定义表格每一列字段的标题，**更可贵的是 Splunk 的搜索语句支持中文，可以设置中文标题**。

**source="C:\\log1111\\45_secure.txt" authentication|rename rhost as 攻击源 IP | stats count as "源 IP 攻击次数" by 攻击源 IP | table 攻击源 IP 源 IP 攻击次数 | sort - 源 IP 攻击次数**

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2w0iaVxd5hzlBla8bVJg6pnXrF9H34bg8ewwlvAZB11oFpnhUNIZh3DlA/640?wx_fmt=png)

如下图所示，可以直接对搜索结果进行保存，也可以把恶意 IP 直接导出来，非常方便。  

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2w4t8l9XPQxv1JQgiaGO8bvL8TDHNTkIfgtwkicyXWmLPibTv4WY1LtDxlg/640?wx_fmt=png)

*   **提取 ip 地址字段**
    --------------
    

接下来我们需要统计一下攻击者使用了哪些源 IP 地址，因此我们要从日志中把源 IP 地址作为一个字段提取出来，Splunk 很方便地给我们提供了提取字段的功能，看接下来的操作：

首先点击 “**提取新字段**” 按钮，选中一行日志作为样本进行字段的分析与提取。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wBRsNIODs878q1AAjhnaNWibmtESniafr8lNH2rxcBVOAia951upI0gRXg/640?wx_fmt=png)

接下来点击 “**下一步**”，选中 “**正则表达式**” 按钮。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2ww6Pp3cRERFXedLEBMGgmqgHqj7NxM1OP3cGzt9JxKiatGNemcictqUiaw/640?wx_fmt=png)

接下来来到 “**选择字段**” 功能下，用鼠标左边拖拉选中一个 ip 地址，Splunk 会为我们自动生成正则表达式，这里给该字段起名字叫做 **secureIP**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wswSa2PHerPXoqs5fDDa62g4Vjjb8rf6ZwLRibzhfN9pic9m7mOHdpXwg/640?wx_fmt=png)

添加完成之后，发现 Splunk 自动给我们做好了正则表达式语句，可以根据需要进行修改。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wwOGashiayjUm8xt2BVibnNMUibdpaibH3ZQc0V6yZtGOjyZxMiauRUyxIaw/640?wx_fmt=png)

接下来输入查询语句 **"authentication"| top secureRhost | sort - secureRhost**，可以直观看到哪些 ip 地址爆破次数最高。这里需要注意管道字符 | 的用法，左侧输出，右侧输入。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wm7DAicYo3QibePendFa7ia8gQGxpQemtK4icHibpHf2lKAw50Y2QYnbVvnw/640?wx_fmt=png)

接下来以图表形式展示 ip 地址的分布，输入命令 **"authentication"| iplocation secureRhost | geostats count by secureRhost globallimit=0** ，可以看到，**攻击者很有可能动用了僵尸网络或者是代理池在一分钟左右的时间里，进行了 6 万多次的账号枚举操作**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wvjQr4nhiaUuLHlWNOR94IXZO9j3KMTAhC5rfq06ZarE9fJK7mT4QjyA/640?wx_fmt=png)

*   **iplocation 命令的使用**
    --------------------
    

输入该命令可以自动增加 **City、Country、Region、lat、lon** 等字段，将日志中的 IP 地址对应的国家、地区、经纬度等信息进行展示，非常方便。

**source="C:\\log1111\\45_secure.txt" authentication |stats count by rhost | iplocation rhost | search Country!="China"**

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2wkZW27dR6aHcAwDWH1hyFCYUSibjJIyTcNMGxXj4lWYLcicF99D4bj6QQ/640?wx_fmt=png)

*   **仪表板的图示展示功能**
    --------------
    

通过 Splunk 可以将各种分析图表汇总到 “**仪表板**” 上进行展示，以下是我做的一个展示，将 3 个分析图表汇总到一个界面中，具体使用方法后续再讲。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cs9icrPwFwJV3FYogZkXw2w20b47iaEFctDgfnHmgZJnfzgQfyJJaczMB2l4hJ99GBH1hkxL0fqDrA/640?wx_fmt=png)

 **Part3 总结** 

**1.**  Splunk 功能非常繁杂，一篇文章很难把 Splunk 讲清楚，后续 ABC_123 还会继续分享 Splunk 这款日志分析神器的使用方法，也会出一个视频教程，敬请期待。

****2.**** **关注公众号回复 “2****022”，即可得到 “2022 年 ABC123 公众号年刊” 的 PDF 电子书下载地址**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**