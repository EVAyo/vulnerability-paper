<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/10648)

> 先知社区，先知安全技术社区

最近学了一下 codeql，刚好拿这个来练一下手。简单记录一下，有疑问的师傅可以一起探讨。大佬们都还沉浸在 log4j 的世界里，可是俺还在卷 grafana。写的比较简单，适合有基础的师傅。

先从 lgtm 把数据库下下来，发现洞已经被修。  
[https://lgtm.com/projects/g/grafana/grafana/ci/#ql](https://lgtm.com/projects/g/grafana/grafana/ci/#ql)

￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210173352-49947906-599c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210173352-49947906-599c-1.png)

￼

既然如此，只能自己编译了。

```
codeql database create /Users/safe6/codeql/database/gf --language="go" --source-root=/Users/safe6/Desktop/grafana-8.2.6 --overwrite


```

编译好的库，我已经放在最后了, 需要的师傅自取。

各位大佬已经把 sink 分析好了，我们直接来找 os.open 的全部引用即可。  
￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210173453-6dc05692-599c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210173453-6dc05692-599c-1.png)

￼

居然有 50 多个, 我们先不管。也不知道能不能挖出新的洞 。

接来下开始找 source。

进到关键类，可以看到有很多种方法，可以用了注册各种类型的路由。

￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174125-57c709e8-599d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174125-57c709e8-599d-1.png)

￼

把这当 source，简单的查一下，查出来 300 多个 api 接口

￼￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174204-6eeca664-599d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174204-6eeca664-599d-1.png)

随便点一个进去，发现符合预期  
￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174307-94688cfa-599d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174307-94688cfa-599d-1.png)

下面开始尝试污点跟踪

定义 source  
￼￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174325-9f4e92cc-599d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174325-9f4e92cc-599d-1.png)

定义 Sink

￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174341-a866d608-599d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174341-a866d608-599d-1.png)

￼

定义 isAdditionalTaintStep  
￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174354-b035586e-599d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174354-b035586e-599d-1.png)

￼

尝试跑了一下并没有结果

￼￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174449-d0e2a2ba-599d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174449-d0e2a2ba-599d-1.png)

再各种尝试之后，还是无法解决。于是找了三梦师傅，请教一下。

热心的三梦师傅，直接开撸。

￼￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174519-e2ddfb86-599d-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174519-e2ddfb86-599d-1.png)

经过三梦师傅，指点后，改造了一下 source。

￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174611-02446938-599e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174611-02446938-599e-1.png)

￼

再次查询，这次有了结果。可是我们想要的并没有在里面

￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174628-0c384216-599e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174628-0c384216-599e-1.png)

￼

回过头看看，发现这个 api 的路由用到了 *，然后在具体方法里面用 Params 进行获取参数  
￼  
￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174710-24e636a6-599e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174710-24e636a6-599e-1.png)

￼￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174729-305150ca-599e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174729-305150ca-599e-1.png)

那么我们需要继续加个 isAdditionalTaintStep，把在这里断掉的数据流接上。

经过各种查资料发现赋值语句可以满足需求，赋值语句具体的 Examples 如下

￼￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174907-6b331dcc-599e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174907-6b331dcc-599e-1.png)

最后写出来的 isAdditionalTaintStep 如下  
￼￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174919-722c3a32-599e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174919-722c3a32-599e-1.png)

再来看看结果，成功了！！！！！  
￼  
￼  
[![](https://xzfile.aliyuncs.com/media/upload/picture/20211210174930-789dbfd0-599e-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20211210174930-789dbfd0-599e-1.png)

Codeql 资料真挺少的，全靠官方文档续命。

最后还是要感谢三梦师傅，在我学习 codeql 给到的帮助。

代码放在：[https://github.com/safe6Sec/codeql-grafana](https://github.com/safe6Sec/codeql-grafana)  
正在整理的一点笔记 [https://github.com/safe6Sec/CodeqlNote](https://github.com/safe6Sec/CodeqlNote)