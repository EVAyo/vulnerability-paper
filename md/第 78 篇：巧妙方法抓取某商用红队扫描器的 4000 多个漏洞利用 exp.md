<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ONBxCroirsEYS9ycTAjhdA)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
--------------

**大家好，我是 ABC_123**，本期分享一个真实案例。大约在两年前，有机会接触到一台红队扫描器设备（也可以理解为渗透测试机器人），我抱着好奇的心态去那里做了一下测试，感觉还不错。里面大概有 4000 多个漏洞利用 exp，当然大部分都是 nday 漏洞，有一些未公开的 1day 漏洞，也有一些可能是 0day 漏洞，其中部分漏洞利用 exp 做了各种变形用来绕过 waf，这些还是引起了我的兴趣。也是研究了两天，用了一个巧妙办法，欺骗这个扫描器发包，我在后台将所有的漏洞利用 payload 抓取到，整理成标准格式，放到了自己写的工具里面。

**注：为了规避风险，文章中给出的扫描器截图不是原图，都是我手工画出来的，不太美观，burpsuite 的数据包也经过处理，所以大家在看文章时很多地方可能会对应不上，懂得思路即可。**

 **Part2 技术研究过程** 
------------------

*   **扫描器概述**
    

首先，使用这台设备的账号登录 web 界面，直接可以看到一个漂亮的前端界面，“插件管理” 界面上面的统计数字显示内置了 4000 多个漏洞测试 payload。进一步点开界面，可以看到每个漏洞测试 payload 的漏洞标题和漏洞详情介绍。当然在主界面中，也可以把一个 url 列表导入进去，进行批量漏洞扫描及批量漏洞利用。

原图不方便贴出来，我画了一个效果图，供展示所用，大致如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B22dMzJVkXa53tA6M1ceZuxibXgscatRMS7gOxEibMaEZgl5DViapt8csgEpjWzMJnMWFwto2XXYwRw/640?wx_fmt=png)

*   ### **漏洞插件 id 遍历问题**
    

每个漏洞扫描插件的编号都是有规律逐步递增的，第 1 个漏洞插件 id=1，第 4000 个漏洞插件对应着 id=4000。每个漏洞插件都有单独的操作框，可以填入 URL 进行检测与利用，个别的可以进行 getshell 操作。**于是马上找到了一个 id 遍历的问题，这样我可以使用 burpsuite 遍历每个插件的 id**，在请求数据包中填入测试 url，就可以使这台扫描器依次对相应的 URL 发送漏洞测试 payload，此时在测试网站服务器上安装一个抓包程序，就可以抓取所有 HTTP 请求数据包，也就获取了所有的漏洞 payload。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B22dMzJVkXa53tA6M1ceZudKqjvIABDOvd338Fibz30AibKPKMbRCRkqNfYT4QRlQjFTMbibQVlI2lw/640?wx_fmt=png)

*   ### **搭建测试环境实操**
    

接着在 vps 上安装了一个 phpstudy，web 目录放置了一个存在漏洞的 php 页面，后台安装了一个抓包工具，开始了初步的测试过程。**结果发现远远没有那么简单，存在以下几个问题**：

 **1**  该扫描器对一个 url 不会直接发送漏洞利用 payload，它首先会有一个判断过程。对于一些 CMS 漏洞，扫描器会首先提交一个漏洞 exp 的 urlpath 路径（如 / inc/config.php.bak），如果该 urlpath 页面存在，响应码是 200 或 403 或 500，那么扫描器接下来才会发送真正的漏洞利用 payload。

 **2**  对于一些 cms 的 sql 注入漏洞或者文件读取漏洞，那么扫描器会使用在后面加单引号的报错方法或者各种报错方法，查看当前页面是否包含 sql 注入漏洞的错误关键字 MySQL error、Unclosed quotation、error '80040e14'、supplied argument is not a valid MySQL result 等，以此决定是否进一步发送测试 payload。

 **3**  服务器上的抓包工具，抓到了上千个数据包，但是不知道每个数据包具体对应哪个漏洞名称，不知道 http 请求数据包具体是哪种 Web 系统的哪种漏洞，所以抓到的数据包没法使用。

 **4**  其它问题，如 phpstudy 的问题、http 返回头的问题等等，这里不一一列举了。

*   ### **欺骗扫描器发送可用的 exp**
    

为了解决这个问题，ABC_123 想到了一个办法，我用 Springboot 编写了一个 java 测试页面，无论该扫描器提交什么 url 路径，一概返回 200 或 403 或 500 响应码，然后在返回页面中，始终返回一些 sql 注入关键字 MySQL error、Unclosed quotation、error '80040e14'、supplied argument is not a valid MySQL result 等，**欺骗扫描器在第一阶段的判断过程中，找到了这些错误关键字而误以为是存在漏洞的**，从而在第 2 次发包中，发送真正的漏洞测试 payload。

然后我在 springboot 中加入了日志记录代码，一旦有请求过来，那么把当前完整的 http 请求数据包输出到一个 log 文件中，后期再做处理。

*   ### **解决数据包与漏洞名称对应问题**
    

为了解决这个问题，大伤脑筋，后来想到了一个绝妙的方法。还记得前面的 “插件管理” 的 id 遍历问题吗？首先用 burpsuite 把每个 id 对应的名称给提取出来，这样就得到了 id 值与漏洞名称的对应关系列表。

然后使用 burpsuite 遍历 id 发送漏洞测试 payload 的时候，测试 URL 按照如下格式提交，id = 后面的数字可以用 burpsuite 插入一个从 1 到 5000 的字典。经过反复测试，发现按照如下形式构造漏洞测试 url 效果比较好，**扫描器识别到 URL 以 / 结尾，会误以为是目录，从而在目录后面加上一些 urlpath 进行 cms 漏洞尝试；扫描器以? 判断时，会误以为 4111__dict__/ 是参数值，从而进行 SQL 注入漏洞尝试**。

http://xxx.com/?id=4111__dict__/，

http://xxx.com/?id=4115__dict__/，

字符串__dict__是为了后期进行文本处理的时候，方便我们切割文本和替换文本，然后还可以作为区分以 GET 形式提交的漏洞测试 payload。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B22dMzJVkXa53tA6M1ceZuUHeJeKkQoHFAicibSNduPGujlabqSgSibRFIoYkxMtfrwNq4ibbXurPRrw/640?wx_fmt=png)

这样后台的 springboot 应用就能获取到 id 传来的值，编写 java 代码遇到 id=1，程序首先查询 id=1 的漏洞名称是什么，假设漏洞名称是 "XXXOA 系统的 SQL 注入漏洞"，那么输出的日志名称就是 "1_XXXOA 系统的 SQL 注入漏洞. txt"，如果遇到 id=3001，漏洞名称假设是 "Weblogic 系统的 2019-2725(JDK1.8) 漏洞"，那么输出的日志名称就是 "3001_Weblogic 系统的 2019-2725(JDK1.8) 漏洞. txt"。

burpsuite 设置好线程，很快遍历完成 4000 多个 id，也就意味着扫描器对我们的测试页面发送了 4000 多个漏洞的 payload，然后编写程序对生成的 log 文件进行处理，处理成我们想要的数据包格式，上述工作就完成了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B22dMzJVkXa53tA6M1ceZuq9x8VSwrDHCjsOZQVh7vES6j2aOod9Vo5qY89ibtfcXXw6zRIX6ByYQ/640?wx_fmt=png)

###  **Part3 总结** 

**1.**  在本次测试过程中，扫描器的一个低危的 id 遍历漏洞成为了抓取所有漏洞利用 payload 的入口，所以一个漏洞低危还是高危，还是看它的利用场景，有些低危漏洞还是会造成很大安全风险，还是需要修复的。

**2.** 本篇文章没法将原有的实战情况复现，因为不能贴原图，所以只靠打字说不明白，但是关键步骤都写出来了，后续会继续分享其它抓取 payload 的思路。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**