<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/GckEFXWYcIiZZ1-BKwB6yA)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 

Shiro 反序列化漏洞虽然出现很多年了，但是在平时的攻防比赛与红队评估项目中还是能遇到。主站也许遇不到 Shiro 漏洞，但是主站边缘域名、全资子公司的子域名、边缘资产、微信公众号、微信小程序啥的，总能找到。现在遇到的 shiro 反序列化漏洞也是越来越难了，好多都是别人搞不定的。搞不定的原因要么是 key 比较偏门，要么是过不了 waf 防护，要么就是找不到可用的利用链，导致没办法拿权限。

我记得最早在前年测试 weblogic 反序列化漏洞的时候，突然想到了，**如果使用了 shiro 组件的网站是部署在 weblogic 中间件下，完全可以利用 weblogic 中间件的 coherence 组件的利用链来打**。Weblogic 反序列化漏洞大致是通过 T3、IIOP 协议发送一个序列化数据包，相关类只要不在 weblogic 黑名单中，服务器就反序列化恶意代码执行攻击语句。同样，这个序列化数据包用 shiro 组件来处理，只要中间件是 weblogic，也应该能反序列化成功。而且通过构造的反序列化数据包不通过 T3、IIOP 流程，也许还不受 Weblogic 黑名单的限制。于是在本机搭建的一堆 weblogic 各种版本的虚拟机环境中，测试发现是可行的，但是中间也是踩了一大堆坑，实属不易。

 **Part2 技术研究过程** 

*   **环境搭建**
    

首先需要搭建一个在 weblogic 下的 shiro 网站应用，于是从 github 上搜索了一个 samples-web-1.2.42.war 包，上传到 weblogic 中间件中进行部署。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CQKFiaUfeVeecpXA9UTUiaj2fw6LP1kYM1OqmZOukyJzNS7GqGzTumOM09R1zk8AQNnPudICe7HdJg/640?wx_fmt=png)

接下来一路点击下一步，点击 “激活更改”，有的新手到这一步就停了，导致环境搭建不成功。记得在“控制” 选项卡下边，点击“为所有请求提供服务”，至此环境就搭建成功了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CQKFiaUfeVeecpXA9UTUiaj26dNXQ4EHvbdhuwygMzV2xbQucjpw55oolw7ZlYVLmM6WdLkEjDzoRw/640?wx_fmt=png)

如下图所示，搭建成功了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CQKFiaUfeVeecpXA9UTUiaj25294V6iczAt1vQph6RgqrqlrxFoGbFDG5IEe4Na1JpgemeHCygG6ynQ/640?wx_fmt=png)

*   **反序列化利用链的选择**
    

Weblogic 的 Coherence 组件反序列化漏洞的 POC 有好几个，主要包括 CVE-2020-2555、CVE-2020-2883、CVE-2020-14756、CVE-2021-2135 等等，**每个反序列化 exp 其实就对应着 Weblogic 中间件下的一条反序列化利用链**，选择也是很有技巧的，因为每个 EXP 都各有优缺点。比如说，CVE-2020-2555 的 exp 用到了 BadAttributeValueExpException 这个类，这个类只在 JDK1.8 下才能用，适用范围就窄了；CVE-2021-2394 与 CVE-2022-21350 只能发起 jndi 请求，因此只有在出网的情况下才能利用。后续有人把 CVE-2020-2883 的 POC 中的 BadAttributeValueExpException 这个类换掉，使 POC 更加通用。最终经过一系列对比筛选，**CVE-2020-2883、CVE-2020-14756、CVE-2021-2135** 这三个 POC 看起来比较通用，而且这三个 POC 可以接 Javascript 引擎，执行任意 Java 代码，为后续通过 shiro 打 weblogic 内存马打下基础。于是就拿来测试了一下。

POC 大致如下格式：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CQKFiaUfeVeecpXA9UTUiaj2bQ1lEd84iaAMfOf0jhLOtvLZyUKUBDg9onl4FviaTYLpXSlibcibIf8licQ/640?wx_fmt=png)

*   **Coherence 组件的 SUID 不同问题**
    ---------------------------
    

接下来需要做的事情是将不同 Weblogic 版本的 Coherence 利用链整合进 ysoserial 工具包中，这样可以直接调用 ysoserial 工具来生成 shiro 反序列化的 poc。这里就遇到了一个非常大的麻烦，Weblogic 有不同版本如 12.2.130、12.2.140、14.1.100 等等，**每个细微版本的 Coherence 库的 SUID 都不一样**，在反序列化漏洞利用过程中，SUID 对不上，是没法反序列化成功的。网上有文章对 Weblogic 下的 Coherence 组件的不同 SUID 做了总结，但是我本地反复测试的结果，好像与网上的文章给的结果不太一样。为了解决这一问题，我也不纠结了，综合考虑时间与成本，选用了**最简单的 URLClassLoader 类加载不同版本的 Coherence 的 jar 包的方法**，将不同 weblogic 版本的 coherence POC 融合进 ysoserial 工具包中。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CQKFiaUfeVeecpXA9UTUiaj2nAYibKOH61nQfVeYia4WctUmefWcpUj9SrVh8xibDicjzfwWVty3E9CG4A/640?wx_fmt=png)

接下来按照 shiro 组件的加密方式，生成反序列化数据包

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CQKFiaUfeVeecpXA9UTUiaj2yASqGoL3ibyzJKNnBMkPYRWjDJm2tvYZROuRHqNUWZxsEmmGvJ6OTyA/640?wx_fmt=png)

使用 burpsuite 发包之后，Weblogic 服务器成功弹出计算器，证明这种思路是可行的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CQKFiaUfeVeecpXA9UTUiaj2wiaWfhyIjcGKDFEKz2jVXGpFBtpHI2gaZZmIHMhnNIWibI8icl0YgHkpg/640?wx_fmt=png)

*   **内存马问题**
    

这里我就不过多叙述了，可以选用网上靠谱的代码拿来直接用。建议大家看看先知社区 feihong 的文章 https://xz.aliyun.com/t/9343，讲的非常详细。最终把 feihong 的代码进行整合，最终发现打内存马是成功的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CQKFiaUfeVeecpXA9UTUiaj2cOSUwUx3TPUGsYcqrS74BVyRfrXvreLMsndAryH0OMiaEPxnNBE1NVA/640?wx_fmt=png)

如下图所示，内存马是成功的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CQKFiaUfeVeecpXA9UTUiaj2awE3u1FzpgVp8Tp5Biaibo1vKibwYGohpq5v6pZZ8z8JSVfticD3tQzuiag/640?wx_fmt=png)

 **Part3 总结**   

**1.**  实现 weblogic 回显的反序列化代码会非常大，导致生成的 rememberMe 的 cookie 值很长，记得把内存马的代码放在 post body 中，减少 cookie 的大小。

**2.**  如果使用 weblogic 利用链打不成功，那可能是目标 weblogic 更新了补丁，需要换一个较新的 POC，实在不行，如果服务器的 JDK 版本低于 1.8.191，可以用 jndi 出网的方法反弹 shell。

**3.**  上述回显方法引用了 Templates 模板类，这个类用来打 shiro 反序列化没问题，但是用来打 T3、IIOP 应该是不能成功的，**因为这个类被加入了 weblogic 的黑名单中**。

**4.**  10.3.6.0 版本的 weblogic 用 coherence 打不成功，因为默认没开启。这种情况下最好用 JDK-7u21、jre-8u20、CCK1、CCK3 的利用链来打，其实也就与 weblogic 无关了。

**5.**  近期 ABC_123 写的几款工具被公布到网上了，有很多网友后台回复我，希望提供工具的官方哈希值。由于微信公众号文章发布之后，仅能修改 20 个字，所以为了防止工具被人恶意加入后门，ABC_123 借此文章发布工具的 md5 哈希值如下：

（声明：ABC_123 研发的工具都是内部使用的，用来打攻防比赛或者做日常渗透测试，禁止非法使用，从来不对外公开下载。工具泄露非本人自愿，本人无意愿让工具传播。也请大家不要再跟我要工具了，谢谢了。）

**Struts2_19.02 **版本 哈希值如下：****

MD5: 66B588FA4BC1969F3CDD9FCB3EB151CC

SHA1: FBDB7FF43A2DA8CCFFF7346C6BAD8E0619248E76

**Struts2 全版本漏洞检测工具 19.06 版本 ****哈希值****如下：**

MD5: 667CA10E430E2FE65AC239384F208C7F

SHA1: 39DD5FE1307E644051BCF9A7270F90D23CC0B586

**Weblogic T3/IIOP 反序列化工具 V0.3 ** **哈希值****如下：**

MD5: 91513512BBB42CB6080C36B4D06472EF  

SHA1: FDD694DEBBFCC14BE7BE90EED2610AF4831FFAB0

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队、蓝队、日常渗透测试、安全体系建设等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)

**往期精彩回顾**

[第 16 篇：Weblogic 2019-2729 反序列化漏洞绕防护拿权限的实战过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484303&idx=1&sn=58cbb4d7f63b9276bb89eeac286d174c&chksm=c25fccf4f52845e241256c2f425003b73b6061b3d1964dcd4a184a2cda1b4d8761098227e6de&scene=21#wechat_redirect)

[第 15 篇：内网横向中 windows 各端口远程登录哈希传递的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484255&idx=1&sn=e233aa07fdf9de0c8a1bf56fb0954766&chksm=c25fcc24f5284532c5aa27c002d15aa6380c456e2a84299c77b8d43a41892517087258bf867d&scene=21#wechat_redirect)

[第 14 篇：Struts2 框架下 Log4j2 漏洞检测方法分析与总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484207&idx=1&sn=285b54a79e48db9a05816cab2e6afc27&chksm=c25fcc54f5284542c1b9abe870e0caa9f958f4da90723bd83292deed215c63c705b7b0bbfaff&scene=21#wechat_redirect)  

[第 13 篇：coldfusion 反序列化过 waf 改 exp 拿靶标的艰难过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484191&idx=1&sn=cce12f62b3cf457bc73753b77a083695&chksm=c25fcc64f528457250b11ef6804ee6138c37ed87ab988874cc84d09d04fa6ac1fd36b5e8aa4a&scene=21#wechat_redirect)  

[第 12 篇：给任意 java 程序挂 Socks5 代理方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484173&idx=1&sn=e2d454d2447d119bf771a0a511fba994&chksm=c25fcc76f5284560d00355590da0147aca7b7ae2275c095424034245ef32b3d0b28e49c2dbc9&scene=21#wechat_redirect)  

[第 11 篇：盲猜包体对上传漏洞的艰难利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484162&idx=1&sn=870596fcd1120a6d3ee9688c38aace00&chksm=c25fcc79f528456f9dc0a3b9d9cf54422696a1cd6ffd737ae2c6e33941a25c33d4f6d32fc663&scene=21#wechat_redirect)  

[第 10 篇：IIS 短文件名猜解在拿权限中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484145&idx=1&sn=7635430b9b759a2cacdd2c57ba330833&chksm=c25fcd8af528449c1f5c6c703e3668cf6a8dae875ee82ffa67caed66722a0751e3d80d8a6bee&scene=21#wechat_redirect)  

[第 9 篇：Shiro 反序列化数据包解密及蓝队分析工具，提供下载](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484123&idx=1&sn=cb9c039ef92311e56e7742c7c38f6e8a&chksm=c25fcda0f52844b6088b39b769a63b2f6e7a29e8b3ab710961918218d7569089ee4e00072ad9&scene=21#wechat_redirect)  

[第 8 篇：Oracle 注入漏洞绕 waf 的新语句](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484115&idx=1&sn=10c73343ec23f522696692293cd38852&chksm=c25fcda8f52844be2165aa6151c7ad018a4add748673d56523631529e903277633dc44d0abba&scene=21#wechat_redirect)  

[第 7 篇：MS12-020 蓝屏漏洞在实战中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484105&idx=1&sn=3aeafa9c172588aaaade47ccacb69370&chksm=c25fcdb2f52844a4a783fceec590c9e12eb06f62dabd7fbffb37e8da23053953a7eae296048d&scene=21#wechat_redirect)  

[第 6 篇：Weblogic 反序列化攻击不依赖日志溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484094&idx=1&sn=527236759dc4fd228461195197492507&chksm=c25fcdc5f52844d36bffb96979116d6d3a9ae4fb1a0f320436c7275aea271588c702cea60e5c&scene=21#wechat_redirect)  

[第 5 篇：Shiro Padding Oracle 无 key 的艰难实战利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484091&idx=1&sn=4dcce59a842f17035d0018bf650671ae&chksm=c25fcdc0f52844d608b6b87d85082b74d5e15888e76001127ff40cc407a46e5e5de446b1365e&scene=21#wechat_redirect)  

[第 4 篇：jsp 型 webshell 被删情况下如何溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484004&idx=1&sn=50013b50e48542d156700d76ccbd2f33&chksm=c25fcd1ff528440906bb9089a807c16b747ab5a72cc0279a3c0d18a265cd76cc796df570d594&scene=21#wechat_redirect)  

[第 3 篇：银行 Java 站 SSRF"组合洞" 打法造成的严重危害](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483984&idx=1&sn=1a018fcefe10124c1726e51a2be05ca7&chksm=c25fcd2bf528443d944a8495ca5c72d8c028fef67de217efe47a8d18b077ae24556842687407&scene=21#wechat_redirect)  

[第 2 篇：区分 Spring 与 Struts2 框架的几种新方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483951&idx=1&sn=fbc1d04ef73a449238a5979a439b1f35&chksm=c25fcd54f528444219f20c2ab14c5970c243fbb10ba04b5bccc0fb0b7cc6d3f542e26f7870bf&scene=21#wechat_redirect)  

[第 1 篇：weblogic9.x 在 JDK1.5 下 T3 反序列化漏洞利用方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483867&idx=1&sn=e0fcaa9f1b58c8085ccd9dc6f74ed336&chksm=c25fcea0f52847b6aeec0409e3290e023b890d603361f103315b39637f89a10dd6fe051dc724&scene=21#wechat_redirect)