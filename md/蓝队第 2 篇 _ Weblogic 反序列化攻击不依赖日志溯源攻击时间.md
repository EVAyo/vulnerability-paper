<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/lL5No-xy_iqxyjIU9o5-Mg)

 **Part1 前言** 

WebLogic 是美国 Oracle 公司出品一款中间件产品，在国内使用也比较广泛。从 2015 年开始至今，接连爆出过 10 几个可直接利用的 Java 反序列化漏洞，相关漏洞的原理也越来越复杂。每次应急响应过程中，遇到 Oracle 公司的产品都会特别头疼，因为其日志结构太过繁杂，相关介绍文档也很少，想弄明白是需要下一番功夫的。

在日常的应急响应过程中，为了解决这个问题，我曾经反复搭建环境，反编译各种 Weblogic 攻击工具，跟踪其源代码，研究可以不依赖日志分析去快速解决 Weblogic 中间件应急响应的方法，流量监控设备通常会有各种报警，混杂在一起的时候，也很难确定准确的攻击时间。**对于早期 Weblogic 反序列化攻击，我做应急响应的时候，ls -lah 看一下 Weblogic 几个目录下新增的文件及文件时间属性，就能判断出攻击者用的是哪一款 Weblogic 漏洞利用工具，而且还可以确定准确的攻击时间，根本就不用去看日志。**下面分享一下这个技巧，后续也会花很大篇幅讲讲 Weblogic 的日志结构及各种漏洞的应急溯源技巧，因为牵扯到 Oracle 公司的产品，都会很复杂。花很大精力：

 **Part2 具体研究过程** 

*   **虚拟机下测试**
    

本地搭建 Weblogic 的环境如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTs4IJrgSnUEQY2aEBw8kbIOg2IicIUXB3Yeib5tuN8eRUxQl699SqKKEFA/640?wx_fmt=png)

使用 Weblogic 反序列化工具进行攻击，查看服务器的 / temp / 目录，会生成一个. tmp 格式的临时文件，然后查看此文件属性，得知攻击者执行命令的准确时间。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTsasgMAvW74c00buAHosLtaoughNLonxptQ8X3yz64eGibibwc2PDOe1rw/640?wx_fmt=png)

将此 tmp 文件拷贝出来，改扩展名为. jar，使用 jadx-gui 工具反编译，即可看到攻击代码，证明此文件确实是攻击者遗留下来的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTsJe7UNk104I0qic5FTx5V0MZXZ8uPmk7ThibXkG7M1L2ibPOZIiaukeDNicw/640?wx_fmt=png)

很多 weblogic 反序列化利用工具为了能通过 T3 协议回显命令执行结果，都有类似的文件落地，也有的 weblogic 反序列化利用工具为了实现无文件落地回显，是通过 defineClass 方法，从 byte[] 字节码中还原一个 Class 对象，实现无文件落地注入构造回显，这种应急方法不再适用。

*   **Weblogic 回显的实现原理：**
    

应急方法讲完之后，接下来看一下相关工具为什么会向 / temp / 目录写文件，首先要大体讲一下 T3 反序列化回显的原理：

Weblogic 对外提供 Web 服务，会开放 7001 等端口，这个端口是 Web 协议、T3 协议、IIOP 协议并存的，而 T3 协议允许客户端远程调用 Weblogic 服务端的类，然后把执行结果再传输给客户端。因此攻击者会在本地事先编译好一个具有执行命令、上传文件等功能的 java 类，**接着将编译好的文件上传至服务器上**，通过 URLClassLoader 加载这个编译文件，在服务端绑定一个实例，进而实现 T3 下的 Weblogic 反序列化回显，其实有点类似于 RMI 远程方法调用的过程。 

这里要指出，有的 Weblogic 利用工具向服务器写入临时文件时，并没有关闭文件句柄，导致文件会一直存在服务器上。 

*   **常见 Weblogic 利用工具特征** 
    

 **1**   首先看第一款实现 Weblogic 反序列化回显的利用工具，是由冰蝎作者 rebeyond 大牛编写的。我记得大概是 15 年年底时，冰蝎作者 rebeyond 第一个公布出 Weblogic T3 反序列化回显方法，而且给出了相关的代码。后续的研究者的回显方法基本上与 rebeyond 的差不多，通过加载字节码方式实现无文件落地回显。  

我们反编译一下 rebeyond 的工具，看看代码的具体实现过程：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTsWyOErj9sE3OKgmO39nfl85M0e1icKTeI345pEAEVPz0Em6NM7tCqBuA/640?wx_fmt=png)

通过 Connect 按钮事件跟进，一直跟到 GenPayload 类的 Gen 方法，很明显可以看到，这款工具会向服务器的临时目录写入 1vBLBK.tmp 临时文件：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTsRYh8rnicSTEiaLVaUkQukk5GSyEKVe7ZEX96dsmEWPKOO939ibpAb6K6Q/640?wx_fmt=png)

之后再通过 URLClassLoader 类加载这个 tmp 文件，在服务端绑定一个实例，进而实现 T3 回显。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTsb4x9aRp9v76HUsdzjmUmsiaUhMf55rSAawns7rb8uDcjZibGcQxM041A/640?wx_fmt=png)

 **2**  接下来看另一款 Weblogic 反序列化利用工具：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTsykXm0HCYVL1RL1acI5hibHWqXrbHia2jXib1MAjy7Nvw7Liapq3MmwE9Iw/640?wx_fmt=png)

利用成功后，会在服务器上生成 H3y5ec.tmp 临时文件。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTsYSibhbshJ3OqZPtenOt9AgEOu5vGIRrzETibcUficCSao0aMgLicSNWsqA/640?wx_fmt=png)

之后同样使用 URLClassLoader 类加载，实现 T3 回显。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTsMs8pEczxDx0qQRGkfv79ZntZxAXgNK6lH8ia020ybnKjcR0Za3IBFZQ/640?wx_fmt=png)

 **3**  接下来看第 3 款 Weblogic 反序列化利用工具：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTspw2gxE9Auib9nec88xsAib7CBTl9XvLtwcpbIicZo8I47ianAJCibyhgibAg/640?wx_fmt=png)

可以看到，也会向服务器写一个临时文件

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTsYVZE3V1LpWic7hKj93P1Fthca6lBicXq62uOibeuQt3ibF7jPS8edsYLSA/640?wx_fmt=png)

同样是使用 URLClassLoader 类加载，实现 T3 回显：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cd93BDn8urwOjTX8MazCTsye0ChA6YkmmiasyYRia4zXTZtaia1DDaGdicaVXIdRTfVrN1FVmHGMtsYw/640?wx_fmt=png)

 **Part3 总结** 

**1.** 早期的 Weblogic 反序列化利用工具，为了实现 T3 协议回显，都会向服务器上写入一个临时文件。近几年随着无文件落地的流行，Weblogic 的回显基本上都是找一个实现了 defineClass 方法的类，通过还原字节码方式实现回显，这种应急方法不再适用。

**2.** 应急溯源过程中，日志量通常浩如烟海，而且容易被攻击者删掉。在此情况，研究一下攻击者常用工具的原理，总结一些小技巧，在日常应急溯源工作中，会事半功倍，省去很大的工作量。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于红队、蓝队技术分享  

每周一篇，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)