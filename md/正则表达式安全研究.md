<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/1JdHr38OrMV3cE4ouETSPw)

**目**

**录**

一、前  言

二、ReDoS 拒绝服务

三、侧信道问题

四、权限绕过问题

五、数据校验问题

六、回溯限制问题

七、正则执行问题

八、总  结

  

**一**

  

**前  言**

当探讨计算机科学中的模式匹配技术时，正则表达式（Regular Expressions，通常简称 regexp）无疑是一项强大的工具。它广泛应用于文本处理的各个方面，如搜索、编辑或者操控字符串。正则表达式允许用户通过定义特定的字符组合来查找、替换以及操作文本，其应用范围从简单的数据校验到复杂的系统日志分析等不一而足。正则表达式使用广泛，如果使用不当，会带来一些安全问题。

本文主要讨论正则表达式引起的 ReDoS 拒绝服务，侧信道泄露，权限绕过，数据校验，回溯限制以及正则执行问题。

**二**

  

**ReDoS 拒绝服务**

正则表达式底层通常会使用 NFA 非确定性有限自动机来实现，将正则匹配转换为路径匹配。举几个例子：

表达式一`a`：消耗 1 个字符 a，可以从`起始0`到达`终态1`实现`match`

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJsiaxqW5vo43NsxhhfeEndjea4pjc7ZGcKkEclKmE9liaorw8wJib4VcToQ/640?wx_fmt=png&from=appmsg)

表达式二`a*`：消耗 0 个或多个字符 a，可以从`起始0`到达`终态1`实现`match`，图中ε表示空串

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJs73FGsVUR1RBHnFFJKiadtmEFW5ryuwV25UjpQHEgyMyiaBWyvgNXYib9w/640?wx_fmt=png&from=appmsg)

`空字符串`可以直接从`0->1`找到一条访问路径, `aa`形式的字符串可以`0->2->3->4->2->3->4->1`的方式找到一条访问路径实现`match`

到此时似乎一切都没什么问题？看接下来的一个表达式

表达式三`(a*)*b`：其 NFA 图如下：

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJsP1aia6O7VibEdbn1sp3ibiaBEEH5ueHQG3UHXsokTMia25hkYjGYT9utAibw/640?wx_fmt=png&from=appmsg)

可以看到现在的`6-..>7`之间的所有路径本质和`表达式二`一致，如果把它当作一个整体并从更高层次看`0->4`之间的所有路径像是一个更大的`表达式二`，`11->12`路径形式则与`表达式一`等同。即`表达式三`由两个`表达式二`的图以 "父图和子图" 的方式嵌套并添加一个表达式一构成。

现在考虑如下输入及测试：

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJsib0b9PEuQjCcQ3GVhT8oF6DMPXlFWTUhUAMvhzL795LmwzyiblyE0svA/640?wx_fmt=png&from=appmsg)

可以看到输入每增加一个 a 字符，那么正则表达式消耗时间约增加一倍。

**回溯问题**：正则表达式匹配的时候，先按照贪婪匹配所有的 a，之后尝试匹配`b`的时候发现匹配失败，说明当前路径不匹配，那么会进行路径回退，然后尝试另一条路径，由于 "表达式二" 的重复嵌套，会造成回退的路径非常多，计算量非常大，最终造成了`ReDoS`拒绝服务。

对于满足如下几条性质的正则表达式，会存在指数回溯问题 【时间负载度为`O(2^n)`，n 是字符的个数】

> ReDos 是一种算法复杂度攻击，通过提供最坏情况输入来利用算法的攻击。
> 
> 1.  将 +/* 应用到一个子正则表达式 A
>     
> 2.  子正则表达式 A 可以多种方式重复匹配相同的输入，比如 a|a / a+ / a|aa 等就能重复匹配输入
>     
> 3.  在重复的表达式之后要存在一个无法与输入匹配的表达式 B 【以便让匹配失败，从而路径回退】
>     

因此之前的测试`search("(a*)*b","a"*25)`就满足上面的 3 个性质，下面看一些其它例子：

**01**

**情形一：邮件格式匹配**

  

正则表达式：

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJsDVKkib6z5vbD2h5UdickNnVn1z4CRkXwlJpp2KibkezgZhMeR5oAg0OhA/640?wx_fmt=png&from=appmsg)

分析：表达式中片段`(([\-.]|[_]+)?([a-zA-Z0-9]+))*` ， 其中的`+`满足条件 1，`*`满足条件 2，条件 3 只要构造特定输入数据就能满足。

测试：

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJsbg58YUicicQI79mc8CpPhLNUia6GU1aZofByibZueiaWgHibBp8Rz1YLO4zQ/640?wx_fmt=png&from=appmsg)

**02**

**情形二：Java 类名匹配**

  

正则表达式：

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJsZ19RGBu7naZM4z1iaVBsOScsN6mACcSU8EERbmqnVEAnjic7xGIsefLg/640?wx_fmt=png&from=appmsg)

分析：表达式片段`(([a-z])+.)+`   ，第一个`+`满足条件 1，第二个`+`满足条件 2，条件 3 只要构造特定输入数据就能满足。

测试：

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJszQWkricD6vt1Ntcic1R6xmkPJsnFfhvcALgEOIy0h6moHfT8ibcMv3jkw/640?wx_fmt=png&from=appmsg)

**三**

  

**侧信道问题**

时间延迟通常可以作为一种侧信道技术来泄露目标信息，SQL 时间盲注就是一种典型的场景。

之前介绍的 ReDoS 拒绝服务就存在时间延迟，那在某种程度上 ReDoS 能否作为侧信道来使用呢？

考虑下面场景，允许用户控制正则表达式，且来匹配一个固定的字符串。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJskMABF23ic6DCk4d7MqVEOGasx9NXTLibN0Xhfl23YrqT5KNUJaMicyibPw/640?wx_fmt=png&from=appmsg)

通过上面的例子，可以看到在允许用户控制正则表达式的情况下，ReDoS 反而变成了一种基于时间的侧信道泄露。当然这里只是一个理想中的情况，但思想上比较有意思分享一下。

**四**

  

**权限绕过问题**

Apache Shiro 是一个安全框架，提供了认证、授权、加密、会话管理等一系列安全功能，可以简化应用程序中的身份验证和授权操作。

Shiro 有两种表达式可以匹配路径，一种是`AntPathMatcher`，另一种是`RegExPatternMatcher`，其中`RegExPatternMatcher`用于路径的正则匹配。

这里以 CVE-2022-32532 为例，在 Shiro<1.9.1 前，若使用`RegExPatternMatcher`，且需权限检查的路由类似`/user/.*`时（存在`.*`），会造成权限绕过。

上述问题产生的源码：

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJs1BfSOq8V9XIssh5DCibLb93mxDAhHwyUEB1jrOWLGJJFUXzv690YeTQ/640?wx_fmt=png&from=appmsg)

JAVA 默认的`Pattern.compile(pattern)` 模式中. 默认不匹配换行，除非启用了 DOTALL 模式。

因此当用户使用`/user/%0d`或者`/user/%0a`类似的 url 请求时，`%0d`和`%0a`会被解码为`\r\n`，`/user/%0d`或者`/user/%0a`因而不会匹配`/user/.*`，也就不需要进行权限检查，可以直接访问类似如下的路由：

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJsWiae9lN7ciaQsEfUD3dnP630ofGxaX0icJatlFREalpRqrODVnGBEgyFQ/640?wx_fmt=png&from=appmsg)

**五**

  

**数据校验问题**

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJsicicpp1TicvntSQd8YhCS4ymltYgDJWTiblB23Yaqkmy2UfRtxZSVAwbhQ/640?wx_fmt=png&from=appmsg)

在 PHP 中，由于`DOT .`不匹配换行，所以只要构造`seq-3212412\ncustom_data` 就可以绕过这里的检测，`$matches[1]`将会是`3212412`。若`$idata`被后续直接用于 SQL 拼接（认为检查通过），则通过`custom_data`造成 SQL 注入。

`/^seq-(.*)/s`这种方式`DOT .`才会匹配换行。

**六**

  

**回溯限制问题**

之前说过正则表达式存在 ReDoS 问题，但各语言也提供各种方法去缓解这个问题，比如超时设置，比如回溯次数限制，php 就提供了`pcre.backtrack_limit`默认 "100000" 的限制，超过了就停止回溯。通过下面几个测试用例来理解回溯限制：

**01**

**情形一：回溯次数不超过最大限制，且不匹配**

  

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJswQu6sQYk8uKS19UbN7kLETdLUIk565iaSKiaUdYatfYaKPzf6bYHL4Sw/640?wx_fmt=png&from=appmsg)

可以看到最大回溯限制为 1000000，且不匹配返回值为 0。

**02**

**情形二：回溯次数不超过最大限制，且匹配**

  

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJsCibmBSa7WQLEUUKuQYRekSKgNh0GZoRDibQTMbXam32BwIia3p7jbbxxw/640?wx_fmt=png&from=appmsg)

可以看到最大回溯限制为 1000000，且匹配返回值为 1。

**03**

**情形三：回溯次数超过最大限制，且匹配**

  

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJsYJeZjG55Hutz5MMicZphic1FzMbfLzQvEq2GcGgdrOovTtCtEPxjQKmA/640?wx_fmt=png&from=appmsg)

可以看到最大回溯限制为 1000000，原始数据理论上是匹配的，但**当超过回溯限制 1000000 次时，可以看到匹配返回值为 bool(false)**。如果`/.*(-).*/is`意图本身是黑名单检测，那么这种场景就会造成黑名单的绕过。

**七**

  

**正则执行问题**

正则替换函数`preg_replace`配合`/e`可产生代码执行，是 PHP 专有参数。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmTkl5OUdteMrzr5d5pu9jJs9cC1Tw8cayTia7FuTeua6vB5IKqGcrpbaib5x2DKMiaI75ztIpu4yr0bA/640?wx_fmt=png&from=appmsg)

`preg_replace() - /e modifier is deprecated since PHP 5.5 and removed since PHP 7.0`

注意：这里的`/e`从 php7.0 开始被移除。

**八**

  

**总  结**

综上所述，正则表达式作为文本处理的重要工具，在提高工作效率的同时，也要求使用者具备一定的安全意识与实践技巧。通过合理设计与应用正则表达式，不仅可以增强数据处理的准确性和效率，还能有效避免潜在的安全问题。

**九**

  

**参考链接**

1.  Regular expression Denial of Service - ReDoS

2.  A Rough Idea of Blind Regular Expression Injection Attack

  

  

  

  

  

  

**奇安信天工实验室**

  

奇安信天工实验室，专注于漏洞攻防领域技术研究，面向互联网基础设施，以操作系统平台、基础软件应用、网络通信协议、关键网络设备为目标，研究漏洞挖掘、利用、检测等关键技术。漏洞研究成果连续在 GeekPwn、天府杯等漏洞破解赛事中斩获奖项，漏洞挖掘方法发表于 DEFCON、BlackHat、HITB、CCS、Usenix、EuroS&P、RAID 等国际重量级会议。团队研发的破壳平台（poc.qianxin.com），提供基于查询、面向团队协作的漏洞辅助分析能力。

![](https://mmbiz.qpic.cn/mmbiz_png/oJZWTpJpiae90UpibicIKeZgQTNjebiaOwStfe6MJ5J6RC7F9JDFdX2kaEwibFz7GewNtNyDek6SdENJrXjf0KXA2kg/640?wx_fmt=png)

**每周三更新一篇技术文章  点击关注我们吧！**