<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/rlCyPlvmxt1HOyVdu7kNjQ)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
--------------

大家好，我是 ABC_123。春节前 weblogic 爆出了一个新的漏洞 CVE-2023-21839，据说有攻击队曾用这个在野 0day 打穿了某银行目标。通过官方的漏洞描述来看，应该还是借助 jndi 来实现反序列化漏洞利用，所以此漏洞成功条件是目标一定要出网，而且 T3 或 IIOP 协议开放。**与 T3 协议或 IIOP 协议相关的 weblogic 的 0day 漏洞近几年还会不断地公布出来，要想彻底解决这个漏洞，在不影响业务的前提下，最好还是禁用或者是屏蔽 T3 协议及 IIOP 协议**。

网上很多文章给出了禁用 T3 协议及 IIOP 协议的方法，但大多数不详细，而且部分修复方法有错误，经过 ABC_123 的验证，给出的详细步骤如下。

 **Part2 漏洞修复** 
----------------

*   **基本步骤**
    --------
    

首先给出一个常规的禁用 T3 协议、IIOP 协议的基本步骤，给大家作为参考，文章后续会根据不同的 weblogic 版本给出相应的详细修复漏洞过程，让大家少走弯路少踩坑。
--------------------------------------------------------------------------------------

 **1**  **禁用 T3 协议过程**

进入 weblogic 的后台之后，选择 “安全”—“筛选器”，在“连接筛选器规则” 输入

**weblogic.security.net.ConnectionFilterImpl**

连接筛选器规则中输入:

**127.0.0.1 * * allow t3 t3s**

**0.0.0.0/0 * * deny t3 t3s**

最后重启 weblogic 项目。

**经过 ABC_123 测试，10.x 版本的 weblogic 禁用 T3 需要重启，否则不会生效。12.x 版本不需要重启，点击 “保存” 就可以立即生效**。

 **2**  **禁用 IIOP 协议过程**

进入 weblogic 的后台之后，选择 “base_domain”—“环境”—“服务器”，然后在对应服务器设置中选择 “协议”—“IIOP” 选项卡，取消 “**启用 IIOP**” 前面的勾选，然后重启 weblogic 项目。

**经过 ABC_123 测试，几乎所有版本的 weblogic，彻底禁用 IIOP 协议都需要重启，否则即使点击了 “保存”，也不会生效。**

*   **禁用 T3 协议（9.x-10.x-11g 版本）**
    -----------------------------
    

经过测试，weblogic9.x、weblogic 10.x（11g）版本禁用 T3 协议方法详细步骤如下：

首先需要点击 “锁定并编辑”，否则“连接筛选器” 是灰色界面，无法进行编辑。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtu8icicjQCCicahQx8PhUTU7yJpa0L1FCC1EWzBAYCBiaJ4iaJ0jzg6zribYvg/640?wx_fmt=png)

之后选择 “安全”—“筛选器”，然后参考文章开头给出的文本进行填写，然后点击 “保存”。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtu21xlbNDFmtW0YWevUeVTU0SwDJibnDpAUn58v7q8Gc960rSulsRibia4A/640?wx_fmt=png)

如果是 weblogic 9.x 版本，操作方法如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtutGoXFYpRnq5Uj71EYU2VSCic8gc8NkaB0RGWjawuuRX9LKKuhUqsickw/640?wx_fmt=png)

点击 “保存” 之后，需要再点击“激活更改”。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtudt0yTZRuK0Sic0fTAr8PFfgibU6dyGlkQw3sO6FJArV82sLpAsOGdxdA/640?wx_fmt=png)

最后发现 weblogic 后台给出了提示 “**已激活所有更改。但是, 要使这些更改生效, 必须重新启动这 1 个项目。**”

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtuWIJCiaKhOG1tR3COxBoYy2JbkwMd8rLub5avUBibzHQQnentvsj6plTw/640?wx_fmt=png)

最后需要重启 weblogic 项目。

*   **禁用 T3 协议（12.2.1.3.0-12c 版本）**
    -------------------------------
    

经过测试，weblogic 12.1.3.0.0、weblogic 12.2.1.3.0（12c）、weblogic14.x（14c） 版本禁用 T3 协议详细步骤如下：

登录后台后，直接就可以进行编辑，点击 “安全”—“筛选器”，在“连接筛选器” 中按照文章前面给出的文本进行填写。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtupkxjV5YZBgq3RuolVtXJcO7KrRyfzEAuV6pAicaHRPzpXggc2SNTM9g/640?wx_fmt=png)

然后点击 “保存”，立即生效，不需要重启。如果担心不会生效，那就重启一下 weblogic 项目，那也是可以的。

*   **禁用 IIOP 协议（9.x-10.x-11g 版本）**
    -------------------------------
    

经过测试，weblogic9.x、weblogic 10.x（11g）版本禁用 IIOP 协议详细步骤如下：

进入 weblogic 后台之后，首先点击 “锁定并编辑”，在“base_domain”—“环境”—“服务器”，点击“AdminSever（管理）” 项目。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujturV6T5JT4xGmlria2SP7FPgaET39XYicSFMAXfrqR7Tql4Rvo5JBEiax7A/640?wx_fmt=png)

接下来在 “协议”—“IIOP” 中，取消 “启用 IIOP” 的勾选，点击“保存”。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtucJV4JOuuSqphia7sPko1AZguyaCCSMDdGiaeTJwdpOAfW3ZZBLAOMbeQ/640?wx_fmt=png)

如果是 weblogic9.x 版本，操作方法大同小异，按照下图方法进行设置。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtuMtpYaqhSfBKfIibrdWjm2s9ODQSwteSVoDics17GeC620SBvTY8RPjpQ/640?wx_fmt=png)

之后点击 “激活更改”。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtuhulYH1pXspeMibibuYhTeqSyJQwQCxogmnCicYbBiaGVkvqkmib0auo1WXQ/640?wx_fmt=png)

之后 weblogic 后台会给出如下提示，看也来是需要重启 weblogic 项目的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtuXppozFX3jouHqkTmDB6LOL0icA4SJWGUS1oKLo8gwOMdqGcCnFDs4Sw/640?wx_fmt=png)

*   **禁用 IIOP 协议（12.1.3.0.0-12c 版本）**
    ---------------------------------
    

经过测试，weblogic 12.1.3.0.0、weblogic 12.2.1.3.0（12c）、weblogic14.x（14c） 版本禁用 IIOP 协议的详细步骤如下：

登录 weblogic 后台之后，点开 “域结构”—“wl_server”—环境—服务器—“AdminServer（管理）”

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtuvoZuEIF1OoNtmXNnTQKA6ImzZbiaahsq3icxwyhDQLo6D2UqkAroTBCw/640?wx_fmt=png)

接下来取消 “**启用 IIOP**” 的选中，然后点击 “保存”，最后提示 “**已激活所有更改。但是, 要使这些更改生效, 必须重新启动这 1 个项目**”，说明需要重启 weblogic 项目。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtuTtn31sWPEJL2x4VTtfhM4Rsic2TZw1h4mv0MJhgoHjPtL6ZKfvicRg7Q/640?wx_fmt=png)

*   **其它修复方法**
    ----------
    

目前很多 IPS 设备、WAF 设备等都可以对恶意的 Java 反序列化数据包进行阻断，也可以配置防火墙策略，屏蔽 T3 及 IIOP 协议。

也可以在 weblogic 前面放置一个 Nginx，只对 HTTP 协议进行转发，对 T3 协议及 IIOP 协议不进行转发，但是这种方法只能杜绝外网攻击，无法杜绝内网横向中对于 weblogic 反序列化漏洞的攻击。

经过测试，禁用 T3 及 IIOP 协议之后，weblogic 10.x 返回信息如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtu1VOhyiaxLe5E7QtjTJYSUjoNiaJjulNCqumRHFmYcw7Ed7XOVhUzXEzw/640?wx_fmt=png)

经过测试，禁用 T3 及 IIOP 协议之后，weblogic 12.x 返回信息如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CI7tNl3ZPKkVw33TGkujtuiblTyiaNXNzrPiazS6VOg1WNCWKUFE9E3tNrviczrfWn99XiaopiaSIH8nicA/640?wx_fmt=png)

 **Part3 总结** 

**1.**  大家如果有什么好的建议或者疑问，可以在公众号后台给我发消息，欢迎批评指正。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 实战分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**