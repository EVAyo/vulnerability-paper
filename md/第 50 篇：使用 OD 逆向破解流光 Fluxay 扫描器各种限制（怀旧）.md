<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/I2tu02-SaKFYyb6w4W07bQ)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
--------------

大家好，我是 ABC_123，最近在整理之前用过的工具，发现了大学时期曾经用过的小榕写的扫描器 “流光 Fluxay”，一晃 15 年过去了，这个工具当年在国外的名气也是响当当的，想起来了那时候研究技术的单纯和快乐。

我收集了好几个流光扫描器的版本，**发现有几个 1999 年和 2000 年的流光版本有各种限制，导致软件打不开了，可我还想再用一下**。在年前把王爽老师的《汇编语言》重新看了一遍，又看了一些都快忘干净的逆向破解教程，于是就使用 OllyDbg 尝试解除了该软件的各种限制，正好练练手。

接下来就讲一讲具体的破解过程，我尽可能讲得详细些，适合新手入门。总共需要破解 3 处限制：1、软件启动时的 “用户调查表”；2、数字签名校验；3、多处软件过期校验。

 **Part2 破解过程** 
----------------

*   **去掉 “用户调查表” 界面**
    -----------------
    

软件打开后会有一个 “用户调查表” 界面，刚开始这个界面就把我给难住了，找关键字、找 API 函数、查找堆栈的窗口函数都不行，一通下断点一直走下去就走进类似于“**PeekMessageW**” 的消息队列死循环。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaeBAia7FfITWTt2HjtaQDBFEorLweZhlGZzOGesvv0DHMJ9ZUiaYKpAyQ/640?wx_fmt=png)

最后想了个方法，出现 “用户调查表” 界面后，在 OllyDbg 上点击“**暂停**” 按钮，然后按 “**Alt+F9**”，从系统领空返回到程序的领空，很快找到关键跳转，然后在 **00407D19** 处下断点调试。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaJnwAhkgtcN76L5028K5fZawpibibLnicibVibPAXzJGDTBkYFrohnPZMk1A/640?wx_fmt=png)

接下来将 **00407D19** 处的窗口给 NOP 掉，OD 重新载入发现，第一个 “用户调查表” 窗口已经被去掉了。

*   **软件过期限制解除**
    ------------
    

将去掉 “用户调查表” 的程序保存为另一个 exe 文件，双击运行，直接提示“软件过期”，接下来就是去掉这个限制。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaeZ7ZPPvx7NSyUYwU3sqCYmia7vb9ze8h0sNXKD2Liave7oqwmPNsRYyA/640?wx_fmt=png)

各种搜索关键字发现找不到，怎么办呢？经过思考，出现 “流光 2001 已经到期” 之后，程序会退出，那可以先将 “程序退出” 的功能给去掉，OllyDbg 一直跟到 **004060B3** 处，发现了 **msvcrt.exit** 标记，发现了退出功能代码，在此给 nop 掉。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaU3rbm3Cu7JuX5sDWNDYiaxq2ltiaA2qjNticSsG4Y8WJZffwvSjQS7aGg/640?wx_fmt=png)

此时发现，软件仍然提示过期，但是不会退出了，说明修改成功。接下来猜想，退出代码上面必然是各种关键跳或者关键 call，**所以退出指令之前的几个 jmp 跳转指令全部打上断点**，重新动态调试。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaGMvzCIDzQ2Txf9JJTL6LlbnRLE8uHk3HMYBGtEWbBY7UMcMhjnpD2A/640?wx_fmt=png)

最终发现在 **0040606B** 处，将 jle 有条件跳转改为 jmp 无条件跳转，即可成功解除 “软件过期” 提示。

*   **数字验证解除**
    ----------
    

接下来继续运行流光 2000，这时候, 会提示 “**数字验证失败**”，说明作者怕软件被捆绑后门，进行了校验。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaDZdFIxDPGbqfiapVDL8BDiav5revcclwa6gqZ6tib2XHYl9KHVe65D1fA/640?wx_fmt=png)

为了解除这个 “数字验证”，首先点击“确定” 按钮，然后一路单步 F8 跟到“**msvcrt.ext**” 退出提示，然后使用 OD 查看之前的汇编指令，发现了关键跳转所在的位置，同样将附近的 4、5 个跳转全部下断点，重新用 OllyDbg 动态调试。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRia7eUsic6DRZTCe0I1ZH2kibCbNTCJKsgzLeVotlgsbicrJ8uLQUWuK8fBg/640?wx_fmt=png)

最终经过反复测试，发现将 **00406875** 处的跳转改成 jmp 无条件跳转，即可绕过 “数字验证”。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiafydQ57zdncwOfcnjsSxqQK0c4kqEhLI5zQS1RjnNyN2XjOm0uGnuDA/640?wx_fmt=png)

至此，已经将流光 2000 的所有限制全部解除（这里发现有时候还是会提示软件过期，但是在 win10 操作系统下不会提示，我也就不再花费时间去解除这些限制了）。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaNyUU5GkJXuIsaFxV1kSviaqdtxd7jU0b09iaRShX7qqYpibnyeo4Vn9AA/640?wx_fmt=png)

重新看一下这个流光老版本的界面吧，怀旧一下。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaTVtXJq0fgypp31CjdSTjAER3bYIJDFxkTkiaN4lrUurm6bWVoDPHEdQ/640?wx_fmt=png)

*   **流光 1999 年版本的限制解除**
    --------------------
    

接下来破解一个网上能搜索到的最老的 1999 年版本的流光。有了前面的参考，破解起来会容易很多，**毕竟一个软件研发者的写代码的习惯都是一致的，因而我们的破解思路也应该是一致的**。

同样出现了一个 “**流光 II 用户调查表**”，但是这个界面和前面的不一样，前面的破解方法失效。这里我猜想一个软件开发人员，研发习惯都是一样的，所以我重新看了一下前面刚刚讲过的流光 2001 的破解启动界面的关键 call 附近有啥重要标记，发现有一处 “**Software\Banyet\FluXay**” 字符串，所以我们直接在流光 1999 软件中搜索这个字符串吧，猜想流光 1999 的关键 call 也在这个字符串附近。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRia7DMzYo2memic5NapLhwgiaSS1sw9rhzvrtIuIjsXH0ibU83lKUtYibexCQ/640?wx_fmt=png)

接下来搜索 “**Software\Banyet\FluXay**”，果然不出所料，存在这个字符串，接下来打上断点。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiax5Y9WDiaa9wCCDEia0hEyaS3elUnIblrmEqNRS172ibF8iatgIT8dQZdtg/640?wx_fmt=png)

在当前断点之后很容易就找到了关键 call，在 **004047D5** 处，将此处的 call 给 nop 掉。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiadPWLv2P6iczKlNIIbzz3Vvqjkj7yedKmuDxgF2eVQsZTjOgDNOjoTKw/640?wx_fmt=png)

第一个启动界面就被去掉了，接下来熟悉的界面出现了，好怀旧的界面啊。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRia6DZAiaVbegtFN4UTJ3Fw3icYKbxT2pTRG9mkWb3dDpxhEOIbgG5MDHcA/640?wx_fmt=png)

点击 “我同意” 按钮之后，熟悉的 “数字验证失败” 又出现了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaZ9TNroiaiaPJ70l0JVx9icMcthgmFBpmOBunPbTL9pB2nwoMbLzcKJp1g/640?wx_fmt=png)

这个界面使用前面的破解方法就不行了，猜想后面的功能实现不一样，接下来使用 OD 按下 **Ctrl+F8** 自动单步走，发现最后会陷入 **PeekMessageA** 消息队列的死循环。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaY2vWRqXCMia5yjzS3kg2t6t3z95baWR8z9L4OfuKPPm2oIYwAFae3fg/640?wx_fmt=png)

接下来怎么办呢，我想了各种办法，**最终用了一个废力但是效果不错的方法，我找了几个参考关键字，在关键字附近的关键跳都打上断点，然后 F8 单步走，凭感觉和经验在遇到的关键跳附近都打上断点，总共打了 10 几个断点，反复动态调试**，终于有一个关键断点被找到了，于是将 **0043784C** 处改成 jmp 无条件跳转。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiaLf7houFRoB4AibuaMqrCs7nq7Gbfibxq7culmwLDVRaPGDwPP0YXk5Mw/640?wx_fmt=png)

至此流光 1999 年的这个版本限制完全解除，看一下当年小榕大神的作品。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRiak38GbVicDvRPLsFzxCGyeK3Gjgtl4qibUQFibp6vz8vwExXS7ZHL4KczA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CjRx0Ia2Y1HQIZHiaZO3FRialjgHPmBQWEvPM3o7jGWyicyqiczavc4LF7W3ZoBFd3aMPKmoQUNnbQsg/640?wx_fmt=png)

 **Part3 总结** 
--------------

**1.**   无意中发现找到 msvcrt.exit 退出指令，向上找关键跳和关键 call，这种方法效果不错。

**2.**   逆向破解方面如果有软件编写经验会更好，上述我的破解过程，完全是按照研发人员写代码的流程来思考和破解的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 实战分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**