<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/e7f6MGfcXwlwaettGkpyVQ)

 **Part1 前言** 

大家好，上期分享了一个 IIS 短文件名猜解在实战中拿权限的利用，本期将会分享一个特殊的上传漏洞的利用案例。很多时候遇到一个存在漏洞的点，只要有一线希望，就不愿意轻言放弃。对一个网站进行测试前，扫描目录和扫描敏感文件是经常使用的方法，有时候会扫描出上传功能的后端页面，这时候不知道包体是怎么构造的，也不知道上传漏洞需要提交哪些参数，所以就需盲猜包体了。类似的案例我成功过好几次，接下来详细说一下具体方法及详细过程。

 **Part2 技术研究过程** 

*   **扫描目录**
    

首先，目标网站就是一个空白页面，对于这种网站，只能对 URL 进行目录扫描了，最后一层层扫目录得到类似于如下 URL 地址（以下是虚拟机环境的截图）：

http://www.xxx.com/Temp/servlet/UploadFile，打开页面如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHt7SiaMkVvWicAhOV96zbWVCFCDFDXWxLthMhIUMSe2Y4LN8dTyhRns5g/640?wx_fmt=png)

做过 Javaweb 的朋友一眼就能看出这是 Java 站点的常见提示，通过 URL 的路由地址 UploadFile 猜测，这可能是一个上传功能的后端页面。由于没有前端的用户交互页面，就无法得到具体需要提交哪些参数。接下来讲讲如何对这个功能页面进行利用。

*   **本地搭建环境**
    

首先拿一个本地搭建的网站举例说明一下，我们平常见到的可能存在上传漏洞的页面是如下所示的一个前端页面：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHnJXxkZFPicnicIgXPacYfOnJZqo3fsHplWYyPTd2QWBAs6ETicpjqjraQ/640?wx_fmt=png)

查看浏览器源码，可以得知，真正处理用户上传数据的 URL 实际上是以下这个地址：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHM4ZT9r8TpJtGrDjYVjlSbiaYmzKaW384zDSqfY5nR3WIRexhd6JYewg/640?wx_fmt=png)

直接浏览器打开，页面如下，很多都是一个空白页面：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHKLexukQicrM5WfMXDBoNW4eSGDibT1BfNzYheFfWh8792ichTYiaV3lEGg/640?wx_fmt=png)

上传一个文件，使用 burpsuite 抓包，得到如下数据包，发现 filepath 和 FileName 是常见的用户提交给上传功能后端页面去处理的参数。其中，filepath 是 Web 应用保存上传文件的地址，FileName 是文件名称。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHBMMHvoS4pyxtZib0ibTRpmwkxnxRW3wEknB9x0Qk6fo5xl6WcPJGELUw/640?wx_fmt=png)

接下来我就想了，可不可以盲猜一下上传功能的包体呢？上传功能的 POST 包体常用的参数就是那几个。万一猜对了，就可以直接上传 webshell 了。

*   **盲猜包体过程**
    

于是使用 burpsuite 手工尝试 filename、FileName、fileName、name、Name、FilePath、filePath 等参数名，不断地构造上传包体，不断地进行变换构造，当构造出如下包体时，提示 “文件上传成功”，这同时也说明这是一个存在未授权访问功能的上传页面。这个案例是好多年前的了，当时具体是哪几个参数我也不记得了，大致与以下截图类似。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHFw19BicXmxCv9p3WQicjQNK8iaEiaeoUqIZsHLbhnTf8RQotUCaFqloJJw/640?wx_fmt=png)

当构造出如上图包体时，该页面提示 “文件上传成功！”。上述包体的那个 name 字段应该是没起什么作用，但是不影响上传功能的正常使用。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHCPMvB9OEhpBOa8DKoBI4ibjTulUsg5qTb3oDKhatBXiaw0hLEziatpY7A/640?wx_fmt=png)

*   **寻找 Webshell 路径**
    

接下来难点就来了，Web 应用虽然提示 “文件上传成功”，但是没给出文件上传的路径，那这个 webshell 传到哪里去了呢？接下来又得猜解目录及文件地址了。

假设扫描到了如下敏感目录（以下虚拟机环境的截图，项目图就不放出来了），/images/、/files / 显得尤为重要。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHkHQicQl4sBtnKCkC7oDCWoVvUH5oeBY6UCbedoWpEQiaohRtnC7Mqzfw/640?wx_fmt=png)

于是打开网站访问 / images/test123.txt，/files/test123.txt 等等，发现均提示 404，页面不存在，这就麻烦了。Webshell 究竟传到哪里去了呢？

*   **按照研发人员的思维渗透**
    

后来思路转变了一下，既然是 Java 站点，而且目录中又有一个 / temp / 目录，程序员估计会以时间戳去重命名文件名做测试用。

于是打开 IDE，找了一篇 Java 生成时间戳的文章，照着写了几行代码，生成了一个时间戳：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHhELKEmPHOfxo3pNtOOzza2mRiboU09F2ecAiaN1lnA2JjDMT98zs6Ahg/640?wx_fmt=png)

如下图所示，本地生成了一个时间戳：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHTeW0cicgNLGxwa5UlS3sJt49GYNK5H2uPboBESK07fQgCW5rpx1hiaTQ/640?wx_fmt=png)

由于本地操作时间与服务器文件落地的时间肯定不能完全一致，一定是有差别的，所以需要以当前时间戳为基准，前后取一定的时间差，生成一个几万行的字典，用 burpsuite 枚举一下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcH4MV8BX5uLcXbicEEmYhmG3UDiaLg0U7FdBsnh7qBmVkmNkiaPlI9RDXXQ/640?wx_fmt=png)

结果没有那么简单，发现均是 404 响应码，没有找到响应码 200 的记录，也就是说没有找到 webshell 的地址。原因可能是时间戳不对，也可能是存放上传文件的目录没有找到，也可能是服务器压根就没有以此时间戳命名的文件。后来重新理了一下思路，我本地先生成了一个时间戳字典，然后使用 burpsuite 发上传数据包，再用 burpsuite 枚举时间戳文件名，中间大概有个几秒钟甚至是 10 秒钟的间隔，可别小看这个时间间隔，做个涵盖这个时间间隔的字典，也得上百万行、上千万行字典了。

后续为了加快扫描速度，也为了减少服务器的压力，我将 GET 请求转换成了 HEAD 请求，然后经过几百万行字典的爆破，成功找到了 webshell 地址，最终 getshell 成功。

*   **寻找准确时间戳的新思路**
    

后续经过 **Magic_Zero** 的提醒，他给出了一个更好用的思路，可以先查看服务器返回的 Date 响应头的时间，然后做成时间戳字典地址，这样准确度更高。这个思路真的没想到，感谢提供。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CPdxPRxTffX262cysu9JcHwSQnwq5LzvH9tUke2eomPJ7VV06t9iaxhnWL2DH5nI1hlh0dV9swqbA/640?wx_fmt=png)

 **Part3 总结** 

**1.** 理解一个技术问题要理解它的实质。

**2.** 按照程序员、研发人员的思维去搞站，事半功倍。

**3.** 大批量扫目录、扫文件时，记得把 GET 请求换为 HEAD 请求，有些网站可能不支持 HEAD 请求，需要提前手工判断一下。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于红队、蓝队技术分享

每周一篇，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)