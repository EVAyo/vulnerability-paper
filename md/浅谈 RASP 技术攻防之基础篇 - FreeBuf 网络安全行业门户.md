<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.freebuf.com](https://www.freebuf.com/articles/web/197823.html)

> 本文就笔者研究 RASP 的过程进行了一些概述，技术干货略少，偏向于普及 RASP 技术。可以让大家更好的了解一些关于 web 应用程序安全防护的技术。

引言
--

**本文就笔者研究 RASP 的过程进行了一些概述，技术干货略少，偏向于普及 RASP 技术。中间对 java 如何实现 rasp 技术进行了简单的举例，想对大家起到抛砖引玉的作用，可以让大家更好的了解一些关于 web 应用程序安全防护的技术。文笔不好，大家轻拍。**

一 、什么是 RASP？
------------

在 2014 年的时候，Gartner 引入了 “Runtime application self-protection” 一词，简称为 RASP。它是一种新型应用安全保护技术，它将保护程序像疫苗一样注入到应用程序中，应用程序融为一体，能实时检测和阻断安全攻击，使应用程序具备自我保护能力，当应用程序遭受到实际攻击伤害，就可以自动对其进行防御，而不需要进行人工干预。

RASP 技术可以快速的将安全防御功能整合到正在运行的应用程序中，它拦截从应用程序到系统的所有调用，确保它们是安全的，并直接在应用程序内验证数据请求。Web 和非 Web 应用程序都可以通过 RASP 进行保护。该技术不会影响应用程序的设计，因为 RASP 的检测和保护功能是在应用程序运行的系统上运行的。

二、RASP vs WAF
-------------

很多时候大家在攻击中遇到的都是基于流量规则的 waf 防御，waf 往往误报率高，绕过率高，市面上也有很多针对不同 waf 的绕过方式，而 RASP 技术防御是根据请求上下文进行拦截的，和 WAF 对比非常明显，比如说：

攻击者对 url 为 [http://http.com/index.do?id=1](http://http.com/index.do?id=1) 进行测试，一般情况下，扫描器或者人工测试 sql 注入都会进行一些 sql 语句的拼接，来验证是否有注入，会对该 url 进行大量的发包，发的包可能如下：

```
http://xxx.com/index.do?id=1' and 1=2--

```

但是应用程序本身已经在程序内做了完整的注入参数过滤以及编码或者其他去危险操作，实际上访问该链接以后在数据库中执行的 sql 语句为：

```
select id,name,age from home where id='1 \' and 1=2--'

```

可以看到这个 sql 语句中已经将单引号进行了转义，导致无法进行，但是 WAF 大部分是基于规则去拦截的（也有小部分 WAF 是带参数净化功能的），也就是说，如果你的请求参数在他的规则中存在，那么 waf 都会对其进行拦截（上面只是一个例子，当然 waf 规则肯定不会这么简单，大家不要钻牛角尖。），这样会导致误报率大幅提升，但是 RASP 技术可以做到程序底层拼接的 sql 语句到数据库之前进行拦截。也就是说，在应用程序将 sql 语句预编译的时候，RASP 可以在其发送之前将其拦截下来进行检测，如果 sql 语句没有危险操作，则正常放行，不会影响程序本身的功能。如果存在恶意攻击，则直接将恶意攻击的请求进行拦截或净化参数。

三、国外的 RASP
----------

我搜集到国外 RASP 的产品有的下面几个，可能列表不足，欢迎补充: P

<table><colgroup><col width="26%"> <col width="58%"> </colgroup><thead><tr><th>公司名称</th><th>产品官网</th></tr></thead><tbody><tr><td>Micro Focus<br></td><td><a href="https://www.microfocus.com/en-us/products/application-defender/features">https://www.microfocus.com/en-us/products/application-defender/features</a><br></td></tr><tr><td>Prevoty<br></td><td><a href="https://www.prevoty.com/">https://www.prevoty.com/</a><br></td></tr><tr><td>waratek<br></td><td><a href="https://www.waratek.com/application-security-platform/">https://www.waratek.com/application-security-platform/</a><br></td></tr><tr><td>OWASP AppSensor<br></td><td><a href="http://appsensor.org/">http://appsensor.org/</a><br></td></tr><tr><td>Shadowd<br></td><td><a href="https://shadowd.zecure.org/overview/introduction/">https://shadowd.zecure.org/overview/introduction/</a><br></td></tr><tr><td>immun<br></td><td><a href="https://www.immun.io/features">https://www.immun.io/features</a><br></td></tr><tr><td>Contrast Security<br></td><td><a href="https://www.contrastsecurity.com/runtime-application-self-protection-rasp">https://www.contrastsecurity.com/runtime-application-self-protection-rasp</a><br></td></tr><tr><td>Signal Sciences<br></td><td><a href="https://www.signalsciences.com/rasp-runtime-application-self-protection/">https://www.signalsciences.com/rasp-runtime-application-self-protection/</a><br></td></tr><tr><td>BrixBits<br></td><td><a href="http://www.brixbits.com/security-analyzer.html">http://www.brixbits.com/security-analyzer.html</a><br></td></tr></tbody></table>

笔者只列举了部分国外产品，关于更多这些产品的介绍请大家自行咨询。

根据上述收集到的国外 RASP 技术产品，发现大家都各有千秋，甚至还有根据 RASP 技术衍生出来的一些其他技术名词以及解决方案。

并且大家对数据可视化越来越注重，让使用者可以一目了然的看清楚入侵点以及攻击链，以此来对特定的点进行代码整改或者 RASP 技术层面的攻击拦截。

四、国内 RASP 技术实现进度以及状态
--------------------

国内目前做 RASP 技术的厂家不多，我收集的只有以下几家。如有不足，欢迎补充。  

<table><colgroup><col width="13%"> <col width="28%"> <col width="58%"> </colgroup><thead><tr><th>产品名称<br></th><th>产品官网<br></th><th>概述<br></th></tr></thead><tbody><tr><td>灵蜥<br></td><td><a href="http://www.anbai.com/lxPlatform/">http://www.anbai.com/lxPlatform/</a><br></td><td>灵蜥是北京安百科技研发的一款 RASP 防御产品，而 RASP 安全研究团队的核心是之前乌云核心成员，据我了解，乌云在 2012 年后半年左右的时候就对 RASP 技术开始进行研究了。目前灵蜥 RASP 安全防御技术以及升级到了 2.0 版本，对灵蜥 1.0 版本的架构以及防御点进行了大版本的升级，应该是目前防御比较完善的一家了。<br></td></tr><tr><td>OneRasp<br></td><td><a href="https://www.oneapm.com/">https://www.oneapm.com/</a><br></td><td>然后蓝海讯通研究的 OneRasp 也出现在市场，后面不知什么原因，蓝海讯通好像放弃了对 oneRasp 的研究以及售卖，现在 oneRasp 官网以及下线。<br></td></tr><tr><td>OpenRasp<br></td><td><a href="https://rasp.baidu.com/">https://rasp.baidu.com/</a><br></td><td>在随后可能就是大家都听过或者用过百度开源的 OpenRasp，百度开源的 rasp 产品让更多的企业以及安全研究者接触和认识到了 rasp 技术。该项目目前社区活跃度挺高，插件开发也很简单，大大降低了使用门槛。<br></td></tr><tr><td>云锁<br></td><td><a href="https://www.yunsuo.com.cn/">https://www.yunsuo.com.cn</a><br></td><td>云锁我是在 18 年的 360 安全大会上了解到的，官网将 RASP 技术列入了一个小功能，主打是的微隔离技术，关于微隔离技术，在这边我们不做探讨。有兴趣的可以搜索一下相关的技术文章。<br></td></tr><tr><td>安数云<br></td><td><a href="http://www.datacloudsec.com/#/product-4">http://www.datacloudsec.com/#/product-4</a><br></td><td>安数云 WEB 应用实时防护系统 RASP 是在我写这篇文章的时候，发现他们也开发了一款 RASP 产品才知道的。不过没有找到其技术白皮书等可参考的文章。<br></td></tr></tbody></table>

五、各种语言 RASP 技术实现方式
------------------

### 1.JAVA

Java 是通过 Java Agent 方式进行实现（Agent 本质是 java 中的一个动态库，利用 JVMTI 暴露的一些接口实现的），具体是使用 ASM(` 或者其他字节码修改框架 `) 技术实现 RASP 技术。Java Agent 有三种机制，分别是 Agent_OnLoad、Agent_OnAttach、Agent_OnUnload，大部分时候使用的都是 Agent_OnLoad 技术和 Agent_OnAttach 技术，Agent_OnUnload 技术很少使用。具体关于 Java Agent 的机制大家可以看一下下面这些文章：

[JVMTM Tool Interface](https://docs.oracle.com/javase/8/docs/platform/jvmti/jvmti.html#startup)  [javaagent 加载机制分析](https://nijiaben.iteye.com/blog/1847212)  [JVM 源码分析之 javaagent 原理完全解读](https://www.infoq.cn/article/javaagent-illustratedhttps://www.infoq.cn/article/javaagent-illustrated)

### 2.PHP

PHP 是通过开发第 php 扩展库来进行实现。

### 3..NET

.NET 是通过 IHostingStartup（承载启动）实现，具体的大家可以下面这篇文章：

[在 ASP.NET Core 中使用承载启动程序集](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/host/platform-specific-configuration?view=aspnetcore-2.2)

### 4.other

RASP 技术其实主要就是对编程语言的危险底层函数进行 hook，毕竟在怎么编码转换以及调用，最后肯定会去执行最底层的某个方法然后对系统进行调用。由此可以反推出其 hook 点，然后使用不同的编程语言中不同的技术对其进行实现。

六、举 “栗子”
--------

### 1. 如何在 Java 中实现 RASP 技术

目前笔者我参与研究 & 研发了 JAVA 版本的 RASP 技术，下面给大家简单的进行讲解。

在 jdk1.5 之后，java 提供一个名为 Instrumentation 的 API 接口，Instrumentation 的最大作用，就是类定义动态改变和操作。开发者可以在一个普通 Java 程序（带有 main 函数的 Java 类）运行时，通过 – javaagent 参数指定一个特定的 jar 文件（包含 Instrumentation 代理）来启动 Instrumentation 的代理程序。

关于 premain 的介绍，大家可以去我博客看一下：[java Agent 简单学习](https://www.03sec.com/3232.shtml)。

关于 ASM 的介绍以及使用，大家可以看一下下面的介绍：[ASM 官方操作手册](https://asm.ow2.io/asm4-guide.pdf)，[AOP 的利器：ASM3.0 介绍](https://www.ibm.com/developerworks/cn/java/j-lo-asm30/index.html)关于 ASM 的时序图，我这边引用一下 IBM 上的一张图： 

![](https://image.3001.net/images/20190311/1552284115_5c85f9d3cb36c.jpg!small)

**正文开始**

首先编写一个 premain 函数，然后在 premain 中添加一个我们自定义的 Transformer。 

![](https://image.3001.net/images/20190311/1552284142_5c85f9eeb7828.jpg!small)

我们的 Transformer 需要实现 ClassFileTransformer 接口中的 transform 方法，我这边就简单的先进行一个打印包名的操作。 

![](https://image.3001.net/images/20190311/1552284157_5c85f9fd7ba30.jpg!small)

在编译以后，运行结果如下： 

![](https://image.3001.net/images/20190311/1552284169_5c85fa0998bc7.jpg!small)

由此可见我们的 transform 已经生效了。 我们来简单的类比一下加入 agent 以及未加入 agent 的过程。 

![](https://image.3001.net/images/20190311/1552284184_5c85fa186e8f7.jpg!small)

由此可见，在使用了 transform 以后，可以对 jvm 中的未加载的类进行重写。已经加载过的类可以使用 retransform 去进行重写。 在 java 中有个比较方便的字节码操作库，ASM（ASM 是一个比较方便的字节码操作框架，可以借助 ASM 对字节码进行修改，这样就可以实现动态修改字节码的操作了。[ASM 介绍](https://www.ibm.com/developerworks/cn/java/j-lo-asm30/index.html)）

ClassVisitor 接口，定义了一系列的 visit 方法，而这些 visit 方法。

下面这段代码是对方法进行重写的一个过程。

首先定义一个 ClassVisitor，重写 visitMethod 方法。 

![](https://image.3001.net/images/20190311/1552284198_5c85fa2648875.jpg!small)

可以看到该方法返回的对象为 MethodVisitor(后面简称 mv)，我们如果要修改其中的逻辑过程，需要对 mv 进行操作，下面展示一个简单的修改代码的过程。 

![](https://image.3001.net/images/20190311/1552284218_5c85fa3a3f5bc.jpg!small)

上面 visitCode 中代码的大概意思为，插入一个调用 TestInsert 类中的 hello 方法，并且将一个数字 8 压入进去。 TestInsert 类的代码如下：

![](https://image.3001.net/images/20190311/1552284235_5c85fa4b9dfcd.jpg!small)

如果不出意外，运行 jar 包以后将输出类似下面这样的信息：

![](https://image.3001.net/images/20190311/1552284252_5c85fa5c5028a.jpg!small)

可以看一下加入 agent 运行以后的类有什么变化。

源代码：

![](https://image.3001.net/images/20190311/1552284265_5c85fa699b9ee.jpg!small)

加入 Agent 运行以后的源代码：

![](https://image.3001.net/images/20190311/1552284280_5c85fa7852b39.jpg!small)

可以看到代码：

```
System.out.println(TestInsert.hello(8));

```

成功在：

```
System.out.println("Hello,This is TestAgent Program!");

```

之前运行，而调用 TestInsert.hello 这个方法在源代码中原来是没有的，我们是通过 java 的 agent 配合 asm 对运行的字节码进行了修改，这样就达到了埋点 hook 的目的。

在了解了上面的技术以后，就可以其他对关键的点进行 hook 了，hook 的方法大同小异，这里仅仅是抛砖引玉，大家自行发挥。可以给大家推荐一个园长师傅写的一个简单例子： [javaweb-codereview](https://github.com/anbai-inc/javaweb-codereview)

笔者展示的该例子项目地址为：[javaagent](https://gitlab.com/iiusky/javaagent)

### 2. 如何在 PHP 中实现 RASP 技术

关于 php 中的 rasp 技术实现，笔者我还没有进行深入研究，大家可以参考以下两个开源的扩展进行研究，笔者接下来也准备研究 php 方面的 rasp 技术实现，欢迎大家一起讨论。

> （1）[xmark](https://github.com/fate0/xmark)
> 
> （2）[taint](https://github.com/laruence/taint)

七、RASP 技术的其他方面应用场景
------------------

在 RASP 技术实现的过程中，我横向了遐想一些其他的用法以及参考了一下其他 rasp 产品的功能点，比如：

### **代码审计**

对于 rasp 中运用到的技术，换一种思维方式，可以不进行拦截，而进行记录，对所有记录的日志结合上下文进行代码审计。

### **0day 防御**

对已经 hook 的关键点进行告警通知并且要拦截攻击行为，然后在公网部署多种不同 cms 的 web 蜜罐。如若已经触发到了告警通知，那么已经证明攻击已经成功。且拦截到的漏洞可能为 0day。

### **攻击溯源**

对所有攻击 ip 以及攻击的文件进行聚合，用时间轴进行展示。这样就可以定位到黑客是从上面时候开始进行攻击的，攻击中访问了哪些文件，触发了哪些攻击拦截。然后对所有大致相同的 ip 进行归类，可以引出来一个专业用于攻击溯源的产品。

### **DevOps**

对所有事件详细信息提供完整的执行路径，包括代码行，应用程序中使用的完整上下文查询以及丰富的属性详细信息。

### **其他方面**

当然 Rasp 技术的应用场景肯定不止这么多，还有其他很多方面的一些应用场景，大家可以发散思维去想。本文章仅用于抛砖引玉。

八、RASP 技术有什么缺陷
--------------

● 不同的编程语言可能编译语言和应用程序的版本不一致都导致 RASP 产品无法通用，甚至导致网站挂掉；

● 如果 RASP 技术中对底层拦截点不熟悉，可能导致漏掉重要 hook 点，导致绕过；

● 对于 csrf、ssrf、sql 语句解析等问题目前还是基于部分正则进行防护 (对于 sql 语句的解析问题可以使用 AST 语法树进行解析)。

……

九、总结
----

目前 RASP 还处于一个发展的阶段，尚未像防火墙等常见的安全产品一样有非常明确的功能边界 (scope)，此文仅抛砖引玉，更多由 RASP 防御技术的用法可以发挥想象，比如日志监控、管理会话、安全过滤、请求管理等。 在研究 RASP 技术的时候，我发现 RASP 与 APM 有着部分相同的技术，APM 本意是用于监控应用程序的，反转思路，在 APM 中监控应用程序的时候加入漏洞防护功能，即可形成了一个简单的 RASP demo。在 APM 这方面，大家参考的对象可就很多了，比如：[skywalking](http://skywalking.apache.org/)、[newrelic](https://www.newrelic.com/) 等，skywalking 是开源产品，在 github 上就可以直接查看其源代码，而且是 Apache 的项目，而 newrelic 的所有 agent 都没有进行任何代码混淆，官方安装文档也很丰富，这些都是可以进行参考的。 由此可见，有时候技术换个平台、换个想法，就是一个完全不一样的东西了。所以对于任何技术都可以发散性的去想象一下其他的应用场景，万一恰到好处呢？ 不论研究的技术是什么样的，可能大家实现的方式不一样，使用的技术不一样，使用的名称不一样，不过最终的目的就是为了保护应用程序安全，防止攻击者入侵成功。

十、参考
----

[https://searchsecurity.techtarget.com/opinion/McGraw-on-why-DAST-and-RASP-arent-enterprise-scale](https://searchsecurity.techtarget.com/opinion/McGraw-on-why-DAST-and-RASP-arent-enterprise-scale)

[http://www.cnblogs.com/kingreatwill/p/9756222.html](http://www.cnblogs.com/kingreatwill/p/9756222.html)

[https://techbeacon.com/security/it-time-take-rasp-seriously](https://techbeacon.com/security/it-time-take-rasp-seriously)

[https://www.gartner.com/doc/2856020/maverick-research-stop-protecting-apps](https://www.gartner.com/doc/2856020/maverick-research-stop-protecting-apps)

[https://github.com/anbai-inc/javaweb-codereview/tree/master/javaweb-codereview-agent](https://github.com/anbai-inc/javaweb-codereview/tree/master/javaweb-codereview-agent)

[https://www.03sec.com/3232.shtml](https://www.03sec.com/3232.shtml)

*** 本文作者：安百科技，转载请注明来自 FreeBuf.COM**