<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/j1nDnb0Ub5bk2-Tq5tt2pg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTH9evFcNH31Pjh0f83GEqsibSQsGS8uUrBPLU6VJbjw8CTibOgsYYOhqqKpaQHb9BicrJcCOYhZG0tYOg/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)

**免责声明  
**

  

![](https://mmbiz.qpic.cn/mmbiz_gif/bL2iaicTYdZn6mG6TyJornrhz9JticBo3Nx4zhzUFXcggEDw1lkfzMI0KuLp7dW4dDCvbfgAKlLSX3yGmYg0gtXcw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

```
本公众号“猎洞时刻”旨在分享网络安全领域的相关知识，仅限于学习和研究之用。本公众号并不鼓励或支持任何非法活动。
本公众号中提供的所有内容都是基于作者的经验和知识，并仅代表作者个人的观点和意见。这些观点和意见仅供参考，不构成任何形式的承诺或保证。
本公众号不对任何人因使用或依赖本公众号提供的信息、工具或技术所造成的任何损失或伤害负责。
本公众号提供的技术和工具仅限于学习和研究之用，不得用于非法活动。任何非法活动均与本公众号的立场和政策相违背，并将依法承担法律责任。
本公众号不对使用本公众号提供的工具和技术所造成的任何直接或间接损失负责。使用者必须自行承担使用风险，同时对自己的行为负全部责任。
本公众号保留随时修改或补充免责声明的权利，而不需事先通知

```

基于 Docker 的 CVE-2016-4437 进行的漏洞复现

Apache Shiro 框架提供了记住我的功能（RememberMe），用户登陆成功后会生成经过加密并编码的 cookie。cookie 的 key 为 RememberMe，cookie 的值是经过对相关信息进行序列化，然后使用 aes 加密，最后在使用 base64 编码处理形成的。

Shiro 记住用户会话功能的逻辑如下：

获取 RememberMe 的值 —> **Base64 解密 —> ASE 解密 –> 反序列化** 在服务端接收 cookie 值时，按照如下步骤来解析处理：1、检索 RememberMe cookie 的值 2、Base 64 解码 3、使用 AES 解密 (加密密钥硬编码) 4、进行反序列化操作（未作过滤处理） 在调用反序列化时未进行任何过滤，导致可以触发远程代码执行漏洞。

**一、手工登录查看流量特征**

**1.1 登录失败的流量特征**  

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTianWXdBRcrZZdrMRPWGnZfbXBLXURyPVd5Vpg0ILSGSlbD82tZpU3Hg/640?wx_fmt=png&from=appmsg)

如果登录失败，返回包就会返回 Set-Cookie:remember=deleteMe

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YT4NlRG5SIlIia8cMSosbq0xu4Jrq120V4fJH8c6ibYQ2uBWaJwFicyPhPw/640?wx_fmt=png&from=appmsg)

**1.2 登陆成功的流量特征**
-----------------

如果登录成功，就会出现正确的那个 set-Cookie：remember = 正确值，然后就是非常长的一串子，最后下面还提示登录成功。

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTCoQt4ZqicQzHSGD9LcNt26ZmIQTgsRXJAR98Vr5zXjfwJn8YaroetSg/640?wx_fmt=png&from=appmsg)

**二、工具爆破 shiro 的流量特征**
======================

**2.1 检测是否为 shiro 框架的流量**
=========================

工具的第一步肯定是去判断该网站是否使用了 shiro 框架。

直接设置一个 Cookie: rememberMe=yes，看看返回包是不是返回 Set-Cookie: rememberMe=deleteMe（也就是登录失败）判断是不是存在 shiro 框架。

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTR1NLpGwDLvLcf4dITWAy4gnCldj4vsBmpU9Pusd7YkNdTg70prcuOQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTpOw9MX3aEMdbQ5KwZCXct9aVBWk14wZfviarm41PfSSQzaZicicyHIkiaA/640?wx_fmt=png&from=appmsg)

可以看到这里直接设置了一个 Cookie：remember=yes 来进行探测。

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YT0pUlpYFoLUECkudKmb8S18m90RnKlJXqCKQmrAw30BickDzRZgbvVng/640?wx_fmt=png&from=appmsg)

网站返回 Set-Cookie: remember=deleteMe 证明网站存在 shiro 框架。

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YT5JFS0AOHrnibtxteNkN8WdeXD06J8ugbZsXx3Njva5YGpCCtJhroqdA/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTudezmu2EGYLU8Wsia2YY5rzYS4ShpvJZiagZS58ng8KaO0qbVibp69qew/640?wx_fmt=png&from=appmsg)

**2.2 爆破秘钥成功流量**
================

直接设置一个 Cookie: rememberMe=yes，看看返回包是不是返回 Set-Cookie: rememberMe=deleteMe（也就是登录失败）判断是不是存在 shiro 组件。

然后再设置一个通过秘钥进行加密的序列化字符串，然后通过返回包来判断是不是爆破成功，如果返回包没有返回 Set-Cookie: rememberMe=deleteMe，那就是爆破成功。

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTYIko4B8b3ib6C1CmOKsM4Wn17UkyG8HlxDic67vFiaSFCicbqPJwr1Sv0g/640?wx_fmt=png&from=appmsg)

下面这种就是秘钥爆破成功！因为返回包不再出现 remember=deleteMe

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTYPZicXR1aliatUoWXhCmB2tdTl1uH21xqv8rdK8xibJSdSictc08JfmXBQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YT9dYN4DqFP7ibEanDRxR6bTRV3mZh2lO7yLWbm3OWAyEMoDVD15M0uiaQ/640?wx_fmt=png&from=appmsg)

然后再 cookie 那里瞎添加一个字母，就会出现 Set-Cookie: rememberMe=deleteMe，也就是秘钥爆破失败。![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTYFyexm7fOeLY0DTemHVxvscwbfMx0o2SoUPO9ibM9XnOPAoRzlwLWTA/640?wx_fmt=png&from=appmsg)

**2.3 利用链爆破流量**
===============

如果在秘钥正确的情况下，进行利用链爆破，就会出现，cookie 非常长的情况。如果在研判中发现 cookie 非常长，并且返回包状态码为 200，那就要考虑网站是否被入侵了！

利用成功的情況下
--------

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTsuKZjia91IQ2Is72xh0ArcKfFc2qDFNt1c0Zyq0djDU4axtLv2FnZ9Q/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTM94MQPrlrzdf2C8P6XA5pGDZ7EKb2813eB9KeMFvVVChZ2pJJ0HkibA/640?wx_fmt=png&from=appmsg)

利用失败的情况下
--------

就会出现 Set-Cookie: rememberMe=deleteMe;

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTM5ia23ibBJZLyobKbpptHKIY0Vk6C2MrhE92ictdSFjsadMfeFFM9Mkbw/640?wx_fmt=png&from=appmsg)

**2.4 执行命令的流量**
===============

执行命令时候的流量特征就是，rememberme 非常长，并且返回值是加密的，但是开头和结尾都带三个 $

执行命令 whoami

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTMwuoj7Q6YfwrFWPNKNufzbA6u2XsgLtPW4yHxGn61icSIg0AX5orK4g/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YT3XEWNJpoicTJMdvGSY9uLicccbJegHPoOeP9ic9dl5cc9YZs8q1lnwRUg/640?wx_fmt=png&from=appmsg)

执行命令 ls -a

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTp2jWDTkx4W1HcA0PxZ4iaIdKkqzCEVNRCUtnW6aVhA1icVmfduzLvXoA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTfZKNfDpvM5k2mMn5POUAvm5yee5Dw1ynNa1iaIhDzYns8nw86UrHuAA/640?wx_fmt=png&from=appmsg)

**2.5 注入内存马时候的流量**
==================

进行注入内存马，然后抓包查看流量的特征。  

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTXibYPzeDIh9tRef52DIibxH38tLfH4DsVy9ClUlUXz6qXpWczGSaGUCQ/640?wx_fmt=png&from=appmsg)

可以看到，注入内存马的时候，cookie 值非常长，并且数据包体 pass 参数非常长，也都是加密的数值。  

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTMxDAQHVmEdibiavsyPsq7Q82MqyIXTYFcTTf4N1hY2WYQWiaNicBur69Yw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibmFaTVk5vwkh0uyXPb67YTRchuWb0iaNvE7y0yWaUcekw5qS9ywMJ7Goo9SECW5M8dud6duAcRXeA/640?wx_fmt=png&from=appmsg)

**三、如何防御 shiro 漏洞**

1.  升级 shiro 版本  
    
2.  限制 cookie 长度
    
3.  不要使用硬编码的 key  
    

欢迎加入猎洞内部圈子
==========

    ****如果师傅您感觉自己挖掘漏洞很困难，但是又觉得报课程太贵，不如尝试限时 79 元加入我们圈子，圈主经常更新企业 src 赏金报告，众测赏金报告，CNVD/Edu 漏洞报告和挖洞思路，助您快速获得赏金！****

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibhEufjGqPhU3FqpibxFqII6SUQ40QMvjibhfKgdnd1IZIkictNdQTgy25omicBER8zHnMia6yaJ2yT1oA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHic0YK5aN4k18agGViaApiaQJThM7iaW4iaibgYhE6DaSfcuPcobicCtRSjaVzxfuWwXsJKkc29l1ylzaRvw/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibhEufjGqPhU3FqpibxFqII6SmKV0FhrpWs4dCcdibhTcrrXpeHicFWHbHrW0PUsbD0AFrywQ1ibSe90Q/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibhEufjGqPhU3FqpibxFqII6Gr1pNsQkfUNmu3n3ibhIS6EZichj5jPR6yOkywQibQsdAAXTCLWDibWOpA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHic0YK5aN4k18agGViaApiaQJT3eRZv9URx0AEq0T9TU2QNUdOZnZaiaNQOHt52Cg9icia9kCmUXGssgdNA/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTH8via4bsEibTpjEj06T4Lll6LJyc2eBeqJE0WDR7fibLoEaLVicJmImOBzxan3Shibeb2GUMZnoFXDhUibg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHic0YK5aN4k18agGViaApiaQJT9FvnEDzlZjqibgGqL4icoESrM4ib597puZf3wALOicEmuNC79Vod9HNP1A/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHic0YK5aN4k18agGViaApiaQJTI5NibGb2PtsU1z7dPSKvBLmY8ib1GxNFcYWSAOcHxovetCL7GlicqD2ibw/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTH8via4bsEibTpjEj06T4Lll6LfFg6IgbNDH91KhvgYIBL62UFqmsiaicY82RbGMjIwubH9UyBn1icSsGmg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTH8via4bsEibTpjEj06T4Lll6L7Cx44iaic9icNNfUH7tnUjKan6YiaZonVccPcibKTnN5eZ0FdsJcAXZ3L1A/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibhEufjGqPhU3FqpibxFqII6kZO9508171gsSicYJYzxAlxaibzLXhqGoBeBSxoibib8lGw5lZJGSe6YGw/640?wx_fmt=png&from=appmsg)

_**想进入交流群的师傅，请扫码下方二维码加我微信，备注 “加群”。**_

![](https://mmbiz.qpic.cn/mmbiz_png/d6JIQYCSTHibFyKL0pAnqJhjWnODDg40m2hExuNhPPVySVSdJmrCI0stNz5Yomg4lPWNMcxmBqSg6jUvp849GJA/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)