<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/mPIjc7MnqrzFiKCWoJhsNA)

b 站刷到一位老师分享了 hook pc 端微信信息撤回功能的视频，跟着动手操作了一遍之后，尝试了一下 hook Android 端的微信，下面分享一下学习过程。  

```
一





PC端

```

PC 端那位老师已经演示的很清楚了，我就简单的复述一遍，感兴趣的可以看一下视频（见原文链接）。

微信的核心功能都是在 WeChatwin.dll（windows 下）里实现的，信息撤回也不例外。

  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5eIic1Kra2JOI73CT9O80FuoHVoL4U39AZ4wnIhIkP0v5xducqE6jNdA/640?wx_fmt=jpeg&from=appmsg)

我们使用 ida 分析，通过字符串进行定位，试试相关的字符，如：撤回、revoke、withdrawn 等关键字。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5wDenicibfzMyASVmZKRIrDmC157vEhlKbxibPUKrXCux7k6wib2E9TfbxQ/640?wx_fmt=jpeg&from=appmsg)

我们逐一 hook 使用到这些字符串的函数，然后点击微信的撤回，如果有 log 输出，就代表是关键函数。

测试脚本如下，首先我们获取了 dll 的加载地址，然后通过 ida 查看到函数的偏移地址，将 dll 地址加上该偏移地址，即可得到内存中该函数的地址，那么如何确定哪一个才是撤回相关函数？就是靠试，使用到 msg 相关字符串的函数我们都 hook 一遍，然后触发撤回功能，如果打印出来 revokeMsg 就说明 hook 成功。

```
import frida,sys

# 创建脚本
jsCode="""

//写入js脚本 就和之前一样
//下面的代码获取dll的加载地址
const baseAddr=Module.findBaseAddress('WeChatWin.dll');
console.log("baseAddr:"+baseAddr);

//每次需要修改的只有这里
const revokeMsgFunAddr=getRealAddr('0x1823CD710');
console.log("function addr:",revokeMsgFunAddr);

//根据地址进行frida注入
Interceptor.attach(revokeMsgFunAddr,{\
//一旦进入hook的函数，该回调函数就会被调用
     onEnter(args){
      console.log("-----revokeMsg------")
     }
});

//dll地址加上偏移地址，定位到这个函数
function getRealAddr(addr){
  //基地址
  const idaBase=ptr('0x180000000');
  const offset=ptr(addr).sub(idaBase);
  const result=ptr(baseAddr).add(offset);
  return result;
}

"""

#使用任务管理器查看微信的PID然后填入
session = frida.attach(7876)

# 运行脚本
script = session.create_script(jsCode)

script.load()
print("Successfully attached!!!!")


# 防止运行完进程直接退出
sys.stdin.read()


```

运行测设脚本

当我们测试到字符串 SyncMgr::ProcessRevokeMsg 所在的函数时，有了 revokeMsg 的回显。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5mVYnDCvhz8vwj2lB4txI1IRnKLFibTozK4eqEbicbwyo336OYqs7yiaJw/640?wx_fmt=jpeg&from=appmsg)

函数逻辑比较复杂，hook 点也是比较难找。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5umXWic8RJqBMk6MlNP4qSxj4HkZLQso6hZZxHStgvmbqv616uph4TWw/640?wx_fmt=jpeg&from=appmsg)

但是我们知道每次撤回信息，这个函数都要被调用，我们直接查看他的交叉引用，发现这个函数在一个 switch 语句里被调用。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5y7h5ZWAsPNN9vsJyz81DtWD4pglZiaM6D1GicggtJzg5eQdVqmz8HRvQ/640?wx_fmt=jpeg&from=appmsg)

我们只需要让这个不为 4，这里就不会被执行。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5w2crd0KbkB0jqfiahG6icwLKeibd1KdQNCtIJ1NqIXc9kdf9nho5rmv8A/640?wx_fmt=jpeg&from=appmsg)

edi 为 4 的时候就会执行撤回相关的函数，修改思路就是当程序运行到这里时修改 edi 寄存器的值。

```
Interceptor.attach(revokeMsgFunAddr,{
//一旦进入hook的函数，该回调函数就会被调用
     onEnter(args){
      console.log("-----revokeMsg------")
      console.log(this.context.rdi);
      this.context.rdi=0;
     }
});


```

最终实现的效果：

PC 端显示

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq57eEHuEA1iak1zapYoiadcKhiaIPrBj3kb8ibyAQluscLJqkDlOoRacicThg/640?wx_fmt=jpeg&from=appmsg)

移动端 消息 1 已经被撤回

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5IQMFE2feRwrtvesYpPicDtNHvegHVFhTZ92edcVsnjrSMicK2ZDib38bQ/640?wx_fmt=jpeg&from=appmsg)

```
二





Android端

```

大致思路也是向 PC 端演示的那样，但是因为没有参考的教程，所以走了不少弯路。

还是直接搜索字符串进行定位，考虑到 PC 端那里时 revoke 关键字，所以也是直接搜索 revoke。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5mKf5pwFfNO5S8tOw11j0kKY7B5xSO3z4yWXRPTRrKCVM491a95N5pg/640?wx_fmt=jpeg&from=appmsg)

其实也不用逐个尝试，因为有几个特别明显的，hook 这几个特别明显的方法测试就行。

直接右键方法名选择复制为 frida 片段即可，最终是定位到了这个 RevokeMsgEvent 方法，每当我们撤回信息，都会打印 RevokeMsgEvent.$init is called。

```
Java.perform(function(){
    console.log("==========begain==========")
    let RevokeMsgEvent = Java.use("com.tencent.mm.autogen.events.RevokeMsgEvent");
    RevokeMsgEvent["$init"].implementation = function () {
        console.log(`RevokeMsgEvent.$init is called`);
        this["$init"]();
    }; 
});


```

这个方法其实没啥有价值的东西，尝试了直接置空这个方法，也就是将上面的`this["$init"]();`直接删除，并没有起到什么效果。

然后就是查看了这个方法的交叉引用。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq57qJIofuM0THmvOk3AtB3SueUmL3lEo8ugNobleLUJWe1Fibicryia3lzg/640?wx_fmt=jpeg&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5ibrcichgwicoBmea5rlZJSZBKmpLUweA6wSrvjz1g1gM44rlL8sxjRYxQ/640?wx_fmt=jpeg&from=appmsg)

整个程序只有这一出引用，微信应该做了一些混淆，名字都奇奇怪怪的，可读性很差，一时见不知从何下手。首先尝试了修改 RevokeMsgEvent 的赋值，它将 变量赋值为 false`this.f153351e = false;`，我尝试了一下将该变量赋值为 true，注意没有 f153351e，这是 jadx 帮它命名的，实际的变量名是 e。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5bA3qLcqjozO1CTNAPtc8gnPxuYIeAIZFDKI2OjHoWhYsl8e2ntIKlQ/640?wx_fmt=jpeg&from=appmsg)

```
 
Java.choose("com.tencent.mm.autogen.events.RevokeMsgEvent",{//遍历内存中的所有对象
        onMatch:function(obj){  
            obj.e.value=true;
            console.log("value  : ",obj.e.value);
        },onComplete:function(){   
            console.log("内存对象搜索完毕")
        }
    })


```

修改成功，但是信息还是被撤回。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5kgabI3VWa0Jz4DPMMic0YuBP3y57Espje1Rib5yyBZOjKZvat4wsNLxg/640?wx_fmt=jpeg&from=appmsg)

这条路行不通就考虑另外的方案，hook 掉调用这个方法的方法，和 pc 端相同的操作。

该方法是被 s 类下的 h 方法所调用的，复制 h 方法的 frida 片段进行 hook。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5wEOFZAurG9payaFWTDVys8UgCORV0xqfs9GpnziaQcnK2xZOqxBYj0A/640?wx_fmt=jpeg&from=appmsg)

```
let s = Java.use("tj0.s");
s["h"].implementation = function (str, j15, n0Var, str2, str3, str4) {
    console.log(`s.h is called: str=${str}, j15=${j15}, n0Var=${n0Var}, str2=${str2}, str3=${str3}, str4=${str4}`);
    this["h"](str, j15, n0Var, str2, str3, str4);
};


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5gUYJtogLR0YbYhx6vrJvNxHvria32OibCUmacNicPfPDpLtCE82ENTNLA/640?wx_fmt=jpeg&from=appmsg)

报错，提示没有找到 tj0.s 这个类，于是我想这个类可能不是被默认的类加载器所加载的，遍历一下所有的类加载器然后再 hook。

```
function main() {
    Java.perform(function () {
        Java.enumerateClassLoaders({
            onMatch: function (loader) {
                try {
                    var factory = Java.ClassFactory.get(loader);
                    var s = factory.use("tj0.s");
                    s["h"].implementation = function (str, j15, n0Var, str2, str3, str4) {
                    console.log(`s.h is called: str=${str}, j15=${j15}, n0Var=${n0Var}, str2=${str2}, str3=${str3}, str4=${str4}`);
                    this["h"](str, j15, n0Var, str2, str3, str4);
                   };
                    
                    
                } catch (e) {
                    console.log("Error accessing class or method: " + e);
                    
                }
            },
            
            onComplete: function () {}
            
        });
    });
}


```

结果遍历了所有的类加载器也没有这个类。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5v7Aib7bBeP71A5QZQyB5CPxR1wMwAw2hOu6WoKic5q9QCZCBSZd11q0Q/640?wx_fmt=jpeg&from=appmsg)

而且我使用 objection 打印加载的类也没有这个 tj0.s。

最后想到了打印方法的调用堆栈。

```
Java.perform(function(){
    console.log("==========begain==========")
    let RevokeMsgEvent = Java.use("com.tencent.mm.autogen.events.RevokeMsgEvent");
    
    //hook构造方法
    RevokeMsgEvent["$init"].implementation = function () {
        console.log(`RevokeMsgEvent.$init is called`);
        showStacks();
        this["$init"]();
    };


    function showStacks(){
        console.log(
            Java.use("android.util.Log")    //首先找到log类
            .getStackTraceString(              //调用log类的该方法
                Java.use("java.lang.Throwable").$new()      //new一个对象
            )
        )
    }

});


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5OJdj9OwevOQJE4DSdd0Bquiagp9vDic83F6lmGzv5UPstUiaznZ9J2kCw/640?wx_fmt=jpeg&from=appmsg)

通过函数的调用堆栈，发现 RevokeMsgEvent 是被 ij0.s.i 方法调用的，我们直接将这个方法置空。

```
 
var sClass=Java.use("ij0.s");
    sClass.i.implementation=function(){
         console.log("======================");
    };


```

最终实现的效果，左边是 pc 显示的，右边是手机显示的。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5iaeFjic7lJexeaZUIiaibCfK47CVmWmOMKtTiagMwYbCcB6uiboN4Yylllnw/640?wx_fmt=jpeg&from=appmsg)

```
三





Xposed实现hook的持久化

```

使用 xposed 将上面的代码重写一下即可，frida 逻辑如下：

```
Java.perform(function(){

    var sClass=Java.use("ij0.s");
    sClass.i.implementation=function(){
         console.log("======================");
    };

});


```

xposed 代码

```
package com.example.xposeddemo;

import android.util.Log;

import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.util.ArrayList;
import java.util.Map;
import java.util.Objects;

import de.robv.android.xposed.IXposedHookLoadPackage;
import de.robv.android.xposed.XC_MethodHook;
import de.robv.android.xposed.XC_MethodReplacement;
import de.robv.android.xposed.XposedBridge;
import de.robv.android.xposed.XposedHelpers;
import de.robv.android.xposed.callbacks.XC_LoadPackage;

public class Hook implements IXposedHookLoadPackage {
    @Override
    public void handleLoadPackage(XC_LoadPackage.LoadPackageParam loadPackageParam) throws Throwable {

        if(!loadPackageParam.packageName.equals("com.tencent.mm")) return;

        Class<?> clazz=XposedHelpers.findClass("ij0.s",loadPackageParam.classLoader);
        Log.d("mxy", clazz.toString());


        XposedHelpers.findAndHookMethod(clazz, "i", new XC_MethodReplacement() {
            @Override
            protected Object replaceHookedMethod(MethodHookParam methodHookParam) throws Throwable {
                Log.d("mxy", "hook successfully");
                return null;
            }
        });



    }
}


```

这个 xposed 等价的应该是没什么问题的，但是就是 hook 不上这个 i 方法，也尝试了使用算法助手，都是以失败告终。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5ibibVNf0ZFwOHOYKDpXb5oLkXxicJoPf5Sf47uWmDhPiaWFPLZS5kESWxA/640?wx_fmt=jpeg&from=appmsg)

后续如果找到解决方案我会进行更新。  
大哥们如果知道什么问题的话麻烦在评论区指点指点。

小结：

写 hook 代码很简单，难的是分析的过程，如果定位到了关键代码，只需要短短几行代码就能成功 hook。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5Sj61DwNYMQQuyNibnnibY1U3WmUHE8mcwEZDkaHgbeR9EffqqlG3XpAg/640?wx_fmt=png&from=appmsg)

  

**看雪 ID：马先越**

https://bbs.kanxue.com/user-home-984774.htm

* 本文为看雪论坛优秀文章，由 马先越 原创，转载请注明来自看雪社区

[![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8Gl15aAvd3fpy14s2HpmiaWkVBW9mlS4XibXhocBkInNmhCHJ9GQw2UGJ5KT7OtmqExrcaFp58g2QAw/640?wx_fmt=jpeg&from=appmsg)](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458553456&idx=3&sn=11b55ee464d5aecd37fb4c5bc4dab5da&chksm=b18dbcfa86fa35ecef07864a534f85924153d8b32a403a57e2f3f2d5c266ce199c02bbcb9434&scene=21#wechat_redirect)

**# 往期推荐**

1、[Windows 主机入侵检测与防御内核技术深入解析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458555047&idx=1&sn=b7632036b11bc28f1e89204e8856079d&chksm=b18da22d86fa2b3bdd31bb0aaea1817551ba8b9cc1f10dd36dead922533bcf6d6552b6e09788&scene=21#wechat_redirect)

2、[BFS Ekoparty 2022 Linux Kernel Exploitation Challenge](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458554994&idx=1&sn=816559a8984c0ab9a1ab518c41660dcb&chksm=b18da2f886fa2bee97e29087abdc65fe2d4b725c29752b7bbf93f3555222d973c10075127d4b&scene=21#wechat_redirect)

3、[银狐样本分析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458554906&idx=1&sn=271d52cc31bff5aadaba023dd2db8fe3&chksm=b18da29086fa2b861941c8eac1e53923a283cf1994b2814f0b8af5475d7e705df3c9d44c860b&scene=21#wechat_redirect)

4、[使用 pysqlcipher3 操作 Windows 微信数据库](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458554736&idx=1&sn=5a5cb13286a428dde51b17cfffd83312&chksm=b18da1fa86fa28ec7b7b4637e502485e2d6ed36b15e4a175313a5ee5614cda46a142b12419bd&scene=21#wechat_redirect)

5、[XYCTF 两道 Unity IL2CPP 题的出题思路与题解](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458554671&idx=2&sn=5ef35adeb8c4c890e2763e1630c7d20c&chksm=b18da1a586fa28b38f6a6fa1aa064d0c4dbc9d884039aef8510f6c9c53627a4554f155f3c6f9&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GJubmq65v9uBFmEJuoJD78321RiaLpp3FAylJv0nbibloCFmXdVe4wvW4ibgnCc6srNI8sGBkX14MpQ/640?wx_fmt=gif&from=appmsg)

**球分享**

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GJubmq65v9uBFmEJuoJD78321RiaLpp3FAylJv0nbibloCFmXdVe4wvW4ibgnCc6srNI8sGBkX14MpQ/640?wx_fmt=gif&from=appmsg)

**球点赞**

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GJubmq65v9uBFmEJuoJD78321RiaLpp3FAylJv0nbibloCFmXdVe4wvW4ibgnCc6srNI8sGBkX14MpQ/640?wx_fmt=gif&from=appmsg)

**球在看**

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GJubmq65v9uBFmEJuoJD78txPhfvI9WpuGSCawCN8NJCgzD16Y0IwdUkaI33Qr3DpwRRuvibgRQOg/640?wx_fmt=gif&from=appmsg)

点击阅读原文查看更多