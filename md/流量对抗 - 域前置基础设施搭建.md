<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/DGNclAX8aXg8h6jYBlmC-A)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/Tp9VOk1IaycpsK4AXvozeaMLYk7OBLQau8mDrsWslNiajkybyodE8HbkJ9ibPO7IofWw3S4sE38LyCWYSxSZMjkQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

**免责声明**

由于传播、利用本公众号听风安全所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号听风安全及作者不为**此**承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！

公众号现在只对常读和星标的公众号才展示大图推送，

建议大家把听风安全设为**星标**，否则可能就看不到啦！

----------------------------------------------------------------------

前言
--

在看这篇文章前，建议具备 CDN 转发原理的相关知识储备，这样读起来可能会更轻松一些。  

域前置的核心关键点是**可信域名配合 CDN 节点转发流量**，且在流量层面无法被检测。

如果没有可信域名那么域前置可能就只剩下防溯源这一项，当然如果 CS-Profile 编写的好也是可以维持一段时间的。

相比于**云函数与 OSS**，他们本质上也是域前置，只不过通讯的域名已经被各大厂商标记，一旦客户端与服务端进行通信从而命中`IOC`，则会迅速告警。

本篇搭建的域前置主要分为两大类别，分别为 **HTTPS 和 HTTP 通信**。  
    1、以 HTTPS 协议通讯的域前置基本在流量侧无任何特征且流量经过 TLS 加密无法分析。  
    2、以 HTTP 协议通讯的域前置在流量是可读没有加密的，需要通过编写`Profile`来进行流量伪造，且同样会把我们的`Host`暴露给审查者。

文章将重点介绍域前置的搭建过程，相关理论不做赘述，相关 HTTPS 域前置图文介绍：![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhricwcpGbelaC2W5D8OWBo1SxtIXSuF7q54pmI1Wf8HK6QcftSVPavp8Q/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrzm3EdWZPSLm5IzJDKzovdwIIdsnuK1cCK1b9ah0zAu7q6bia6iaeodUQ/640?wx_fmt=png&from=appmsg)

> 在处理 HTTPS 请求时，CDN 会首先将它解密，并根据 HTTP Host 的值做请求转发。  
>   
> 如果客户端想要访问一个非法网站 forbidden.com，它可以使用一个 CDN 上的合法的域名 allow.com 作为 SNI, 然后使用 forbidden.com 作为 HTTP Host 与 CDN 进行 HTTPS 通信。之后，CDN 会将 HTTP 请求重新封装，并发往 forbidden.com 的源服务器。  
>   
> 这种情况下，客户端实际通信的对象是 forbidden.com，但在流量监控设备看来，客户端是在与 allow.com 通信，即客户端将流量成功伪装成了与 allow.com 通信的流量。  
>   
> Domain Fronting 也有一些局限性。  
> Domain Fronting 流量的一个显著特点是 SNI 和 Host 不相等。企业的防守方可以部署 HTTPS 流量解密设备，并对比流量中的 SNI 和 Host 是否相等，如果不相等则说明是该流量是 Domain Fronting 流量。这也是 MITRE ATT&CK 中建议的检测方式。  
>   
> 并且，随着该技术不断在真实网络攻击中被使用，云厂商也逐渐意识到了 Domain Fronting 的危害，目前 Cloudflare、AWS CloudFront、Google Cloud CDN 等厂商也都纷纷禁用了这种隐蔽通信方法。

前置条件
----

在开始前，你需要具备以下条件：

*   一个域名（可有可无）
    
*   一台 VPS（作为 C2）
    

### 先讲有域名的情况

首先去互联网找几家 CDN 服务商，阿里云，腾讯云都可以，我这里使用华为云做演示。

#### 1、绑定域名

在华为云 CDN 控制台页面添加自己的域名，节点选择 “中国大陆境外”，若域名已经备案可以选择中国大陆，这样的可信域名的质量就会更高。业务类型选择 “全站加速”。

首次添加会提示要求进行验证，DNS 解析验证或文件验证都可，这里我的域名以 xxx.work 进行演示，**实战中最好注册一个无需实名的域名**![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrEM8dicibQakww1axibvN5gtFqMEAY3y72xvBWicX9dX8mKw1Q8OgboLYpQ/640?wx_fmt=png&from=appmsg)

将回源方式选择为 **“协议跟随”**，将回源地址选为 **“源站 IP”**，将自己 C2 的 HTTP 和 HTTPS 的 listener 监听的端口分别填写在 **“源站地址”** 和 **“回源端口”** 上。![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrMZ2E2l2VyD1QSzMSRdPrJlXVRTRNjW0UCLAXRtHEnOYNKTlGXOZd1w/640?wx_fmt=png&from=appmsg)

绑定好之后会分配一个`CNAME地址`![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrewW1Zib0qaXibW3GZDUU5seCUGq7L9MxXMThkZROAfjq6l01VvQwgPaA/640?wx_fmt=png&from=appmsg)

#### 2、配置缓存

将缓存时间修改为 **0 秒**，也就是对页面数据不进行缓存，方便我们对受害者机器下发命令。若心疼自己的钱包，可以对某些目录进行缓存，具体请看官方文档。![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhr1lIGW23kKhVbP5iawFTz3xqfnvaXNicamqDY437lxDLu4JVTRbQLQkww/640?wx_fmt=png&from=appmsg)

### 3、流量过滤

访问控制里的`User-Agent`白名单可以对我们指定的 UA 进行通信，防止蓝队进行反制或进一步分析。![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrfZGkXHmFZJxRgPyZOqdbw7hicckZZtnwBG0KjjsxK1bfmjKBP2UtgsA/640?wx_fmt=png&from=appmsg)

#### 4、可信域名选择

配置好之后稍等 3-5 分钟等待 CDN 生效。之后复制 CNAME，去 ping 一下会得到一个 IP![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrWl7RNLuNMagr9yL5NXyceoYI5hiaa8NHopo49ibEgicBYnq5f3hdys7Tw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhr9RCeUQXib1q3BZbuo46KBxQyiaQHiaRz72Shptc1HXPWmr0GtSorOBngw/640?wx_fmt=png&from=appmsg)

对这个 CNAME 全国 PING，会得到很多 CDN 节点的 IP，随便找一个去反查 这里我以`219.76.20.204`举例![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrMCz2Ml2NAlnYayH6icv9pGANrpRn9CjtJzOTJ085MSHTyCwwXiaSYMVA/640?wx_fmt=png&from=appmsg)

通过反查的域名尽量去找一些**高可信的域名**，比如这里我选用 **“X 港 ZF 网”** 作为域前置的域名，**这里要注意如果采用 HTTPS 加密，请确保域前置的站点 HTTPS 是合法的****。**

若当前 IP 下没有高可信域名则去更换下 IP 继续重复此次步骤。若所有 CDN 节点下都没有可信域名，那么就换家 CDN 提供商。

#### 5、添加监听器（Listener）

添加 **HTTPS 监听器**，这里要注意`HTTPS Port(C2)`与`HTTPS Port(Bind)`是映射的关系，配置如下

```
HTTPS Hosts = 可信域名
HTTPS Host(Stager) = 可信域名
HTTPS Port(C2) = 443 （CDN端口）
HTTPS Port(Bind) = 43904（回源端口）
HTTPS Host Header = xxx.work(添加的域名)


```

![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhribvxsqbQyPM2RUnuX2hFOlsD8tGLV8KBNYagxicqGUoZYAMQxnbTgMBA/640?wx_fmt=png&from=appmsg)

#### 6、测试 CDN 连通性

打开 CS 的 Web Log 测试 CDN 是否能将流量转发成功，执行命令

```
curl "https://cloudvideo.news.gov.hk/test" -H "Host: xxx.work" -v -k


```

可以看到已经收到 CDN 转发来的请求

![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrbBcxqMXCNN8ecIibsScedU6Fe0GaFoQzBgfuXqibC9ZwwXb93X5CJtzQ/640?wx_fmt=png&from=appmsg)

#### 7、流量分析

这里我们生成`stagless的载荷`模拟上线，一定要是 stagless，或者提取出 shellcode 进行分离加载也是可以![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrH3qRibIlxniasSG5HjwAntMIHib3tpzeN1wn56BhcBBwLAfYDf3Ht08lQ/640?wx_fmt=png&from=appmsg)

上线后 wireshark 抓包查看通信建立过程，可以看到全是`TLSv1.2`套件加密，并且`SNI`为可信域名

![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhr6COtnPLPhCExba0h75kSV0oH6icQ9KX4l2TOZMT7GrYqkbIiaHYVhyCg/640?wx_fmt=png&from=appmsg)

  
执行命令进行抓包![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrrEw2E0ibRoOcR1ouSiaLKp8lia8pc1CUQkxHscsVNmaunELHPiarKHn9tA/640?wx_fmt=png&from=appmsg)

下发命令通信也是加密状态![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrEueLQ1LXxYAhEfR6hYdZBtHUBvDN4cJQ51SvBIDmh1YRwlujqzTWqA/640?wx_fmt=png&from=appmsg)

查看 DNS 也是对可信域名进行请求![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrMZIoKAGhOgbWPGXtKECbw3dL0HrkuaBuTicpQdUWDnyxB86XwL7yBWg/640?wx_fmt=png&from=appmsg)

上传到微步沙箱查看通信域名是我们的可信域名，通信地址为华为云的 CDN 节点，完美隐藏我们的 Host 以及真实的 C2 服务器地址。![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrmKuw0DtibELEtIcY8H3ndwkEf35AFP9389pL5cpTAWlueBhEb4kccHA/640?wx_fmt=png&from=appmsg)

至此，HTTPS 域前置配置结束。  
  
最终通信的流程为：  
**受害者机器**请求**可信域名**，**可信域名**解析到 **CDN 厂商分配的 CNAME** ，**CNAME 解析**到 **CDN 节点服务器**，**CDN 节点服务器**根据我们**配置**的 Host 进行寻源，最后根据我们的回源策略将流量转发到我们的 **C2 服务器**。

整个通信过程暴露给审查者的只有可信域名和 CDN 节点，且流量无法进行分析。  

### 二、下面讲下没有域名的情况 (HTTP)

没有域名的情况下必须要去寻找不需要验证域名解析权的 CDN 提供商，一些香港或者境外的厂商可能不会去验证，还有就是一些国内小型的 CDN 提供商。

找到之后添加我们想要伪造的域名，这里我以`api.sisimanhua.com`为例，之所以选择这个域名是因为`www.sisimanhua.com`同样绑定在这家 CDN 提供商，且我同时绑定 api 这个子域，则可以利用 www.sisimanhua.com 作为**域前置**，api.sisimanhua.com 作为 **Host 回源**。![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrcRaL5XxgFFWe7b2iaLGjXkiaBibKtgYJ5YCZ8qibHrFEE2IaMUD7dDYBag/640?wx_fmt=png&from=appmsg)

因为这次演示以 **HTTP 协议通信**，流量是**明文**的，所以我们尽量让充当**域前置的域名和 Host 头的域名保持一致**，或者是他的子域，这样可以大大增加可信程度，让审查者误以为我们和正常域名进行通信。

CS 创建 HTTP 监听器如下![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrtcGBqc40M65pPCZTKjkM4kbce1fcCL2ibmkY4RMtHMcbFGecIUZpfHQ/640?wx_fmt=png&from=appmsg)

模拟上线后对通讯流量进行抓包可以看到请求域名为`www.sisimanhua.com`，解析 IP 为 CDN 节点![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrTRQfe3Glfds6t3WumHCiaZn6YNnZuFIZyIAOwlp9dWmf4e9jLJDzuSw/640?wx_fmt=png&from=appmsg)

通信流量 Host 为`api.sisimanhua.com`，整个通信也是明文，同时这里我们使用 profile 对流量进行了一定的伪造![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhryKbcS4iaia1hVOptDkbGpU9dqRNYN4hlZmF7ynOqek6h9qick0iaRQS80g/640?wx_fmt=png&from=appmsg)

上传到微步沙箱进行分析，可以看到我们的通讯域名甚至是白名单，请求的 url 是 api 的子域![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrs7Z571aBXceGicGsLiaCd5uMTapcgxPZs9lQo9NTq3lQNicvCtSNYTKjA/640?wx_fmt=png&from=appmsg)

通信流程和 HTTP 的域前置是一样的，但通信过程会暴露给审查者可信域名、Host 和 CDN 节点，会增加一定被发现的风险。

同时如果攻击者对 api 子域进行溯源，其实也是溯源不到的，因为这个域名没有 DNS 解析记录，但如果配置 Host 绑定是可以访问到的。![](https://mmbiz.qpic.cn/mmbiz_png/vqGv1p3HpTnphKIO9XWNy8vicQN2KnHhrCdotxPzhhZg6umic59WbrPjDyYRzQ4IraYm3C6NhG1j6QG5iclrpHvDw/640?wx_fmt=png&from=appmsg)

结语
--

此篇文章的促成首先要感谢`@风起`对域前置这方面的指导。

此文也算是冷饭热炒，关于域前置其实还有很多改进的地方，例如默认我们使用的 HTTPS 证书其实是不可信的，我们可以去**伪造证书**或者**申请合法证书**的方式进行加密。

关于域前置不懂的地方可以随时在后台进行私信或留言。

Reference
---------

1、https://mp.weixin.qq.com/s/D9jA1a8oFdrvbOXerRat1g  
2、https://mp.weixin.qq.com/s/8GBoKP3QWb0NpdllIi_YCg  
3、https://mp.weixin.qq.com/s/GpFT8bnOeyFCTtyS0yR3JA  
4、https://mp.weixin.qq.com/s/39yJNEbu7Ya4VdlmjGVbRA  
5、https://mp.weixin.qq.com/s/LGs_gf5CIOaMJMQcIiQCOA  
6、https://mp.weixin.qq.com/s/6WJUTKPgg9OgtKVkUbPucg  
7、https://xlab.tencent.com/cn/2021/05/14/domain-borrowing/

  

不可错过的往期推荐哦  

```
成熟后门身披商业外衣，对抗杀软实现远控


一次有趣的RCEbypass


国H零失分防守经验：蜜罐环绕靶标的围点打援策略


几次护网小结之红队打点及小技巧


某裸聊诈骗站点渗透实战


你存在，在我们的攻击画像里


记一次攻防从SQL注入到拿下域控


警惕GitHub恶意病毒项目，持续活跃释放远控木马


AWD离线-Jar文件冷补丁

```

点击下方名片，关注我们

  

觉得内容不错，就点下 “**赞**” 和 “**在看**”

  

如果不想错过新的内容推送可以设为**星标**![](https://mmbiz.qpic.cn/mmbiz_png/Yv6ic9zgr5hTYyCkc91euAiaGULJSbiaHricFHs2dd2sib20WTJKwHYD90Jia9HCKxnmJUwnkicGU7rVP3EYCVh3dMnng/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)