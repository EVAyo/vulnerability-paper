<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/i8eBT8O2IwCotf7wqnveEw)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 

最近几天，不少朋友的 cs 服务端被反打了，相信很多网友都知道了，大家也都在讨论，各种各样说法都有。具体事件描述如下：**部分网友的 cs 服务端被不明攻击者拿下权限，之后攻击者将 cs 上的 shell 全部通过云函数的方式反弹到自己的 cs 上，之后将原有 cs 端的 shell 权限清空，在 cs 控制台留下一句话 “CS RCE 全版本通杀 Please v Me 获取详情” 等之类的信息。由于攻击者是通过云函数方式反弹的权限，暂时很难溯源到攻击者**。（以下图片来源于网络）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bat0KKOGLBePYcgxZTn5P333ZibiaWoXnm9tBLZiau6M51vmicjQdxSz0ibibpzoicHegsncZpStvibBAHbw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bat0KKOGLBePYcgxZTn5P3devPe9xoXc78rGJ7eMfgMNI2q1q3ZiapZPU5DSLuVGicu2jddJDrdltA/640?wx_fmt=png)

随后 cs 被打的消息就小范围流传开了，大家都在讨论 cs 被反打的原因。我听到了好几个版本，大致如下：**1.** 某某云被搞了；**2.** 某云函数出问题了；**3.** 某供应链出问题了；**4.** CS 出现了远程代码执行漏洞；**5.** 前期下载的 CS 马被捆绑了后门。**6.** 收集汇总各家设备报警的 ip，对这些 ip 全端口扫描，爆破出 cs 密码；**7.** 踩了蜜罐，利用了 mysql 任意文件读取，读取测试人员电脑的配置文件。**8.** 通过 fafo 检索出 cs 服务端的 ip，然后批量猜解 cs 密码。等等。。接下来做一下简单的分析。

 **Part2 技术研究过程** 

*   **简单分析各种猜测**  
    

 **1** **某某云被搞、某云函数被搞、某供应链被搞等等说法**，我一开始听到这个推论就觉得不太可能，先不从技术角度上分析，且从逻辑上就讲不通：首先他们是有 src 漏洞提交平台的，挖这么一个漏洞是费很多心力的，为啥不去交 src，用来批量打一圈 cs 实在是有点大材小用，况且去定位哪些 ip 是 cs 的服务端，也是一个麻烦事（这里我说的很隐晦，大家自己体会），实在是讲不通。

 **2** **前期下载的 cs 马被捆绑了后门**，这个也不太可能，因为我问过一个 cs 被打的小孩，它的 cs 是自己魔改的，不存在捆绑后门的可能性，但是也被打了。所以这个原因暂且排除。

 **3** **爆破 cs 的服务端密码**，这个就更不可能了。因为我问过几个 cs 被打的朋友，密码设置的足够长、足够复杂，而且 cs 的服务端端口设置的很偏门，但凡有些经验的测试人员，都会把默认端口改掉。所以不存在暴力破解的可能性。

 **4**  **cs** **出现了远程代码执行漏洞**，这个可能性是有，但是与此次攻击事件关联不大。我相信有大牛肯定可以挖到这样的漏洞，但是存在这样的漏洞且与此次事件相关的话，那应该大部分人的 cs 都被打才对，所以技术上行得通，但是逻辑上还是讲不通。

 **5** **踩了 mysql 蜜罐，然后蜜罐通过 mysql 本地文件读取漏洞读取了测试人员电脑的 cs 客户端的配置文件**，从而获取到了 cs 的 ip 地址、端口、用户名密码。**这是我到目前为止听到的一个最能让我接受的 cs 被反打的原因**，因为 cs 本地的配置文件是明文存储密码的，对此我之前去逆向 cs 源码时发现过这个问题，对应的安全问题也就是配置文件中的关键信息是明文存储的。  

*   **Mysql 蜜罐读取电脑配置文件**
    

关于 Mysql 蜜罐的具体技术细节，网上文章介绍的太多了，大家可以自己从网上搜索文章，我写一个简介吧：mysql 中有一个 load data local infile 函数能够读取本地文件到 mysql 数据库中。当攻击者用爆破 mysql 密码的扫描器扫描到我们的 mysql 并连接上的时候（**注，这里我纠正一下，只要连接一下蜜罐 mysql，就可以被蜜罐读取到本地配置文件，不需要提供正确的用户名密码**），客户端（攻击者）会自动发起一个查询，我们（服务端）会给与一个回应，我们在回应的数据包中加入 load data local infile 读取攻击者的本地文件到我们数据库中，达到反制的目的。（以下图片来源于网络搜索）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bat0KKOGLBePYcgxZTn5P3rOlwojeyIwkb2ok5yf1IkOxyDtbTF15B0Tb9JmouojsURCzMeSVSHQ/640?wx_fmt=png)

*   ### **cs 的配置文件明文存储密码**
    

只要是使用 cs 客户端连接过 cs 服务端的电脑，cs 客户端都会在固定的文件夹下生成一个. aggressor.prop 配置文件。如果是 Windows 系统，那么文件位置是：C:\Users\Administrator\**.aggressor.prop**，这个配置文件里面就包含了 cs 远控的 ip 地址、端口、用户名及密码，而且都是明文的！如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bat0KKOGLBePYcgxZTn5P3G5lzd8NiaunudzgZclj04Hw2Vl322ByXExptiaqrvbrES71IzSc9s95A/640?wx_fmt=png)

每次打开 cs 都会显示出曾经登录后的 ip 地址、端口、用户名、密码等信息，这些信息都是存储在本地. aggressor.prop 文件中的，大致内容如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bat0KKOGLBePYcgxZTn5P3jpIEjl2aFRicCMew3hdA31pBTSRUpMLpAZn9vJyZaAP2xxZ4IsibXssQ/640?wx_fmt=png)

因此我们得到结论，**搭建一个 mysql 蜜罐，一旦攻击者连接这个蜜罐，那么这个蜜罐利用 msyql 本地文件读取漏洞去自动读取 C:\Users\Administrator\.aggressor.prop 这个文件内容，蜜罐就可以成功得到攻击者的 cs 服务端 ip 地址、端口、用户名密码**。

*   ### **搭建环境实验成功**
    

为了验证一下上述猜测，还是要实战测试一下的，从 github 上找到一个 python 写的 mysql 蜜罐脚本，本地简单修改一下，将文件读取的路径改为 C:\Users\Administrator\.aggressor.prop，将脚本运行起来。如下图所示，一个监听本地端口 3306 的 mysql 蜜罐就搭建好了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bat0KKOGLBePYcgxZTn5P3icnD0Z2qMIVkcrFvYe1L2WubNFSEeWgxL7OvMTBcHXemVBicaW6NKC8w/640?wx_fmt=png)

为了模拟红队人员连接 mysql 的行为，使用 navicat 远程连接一下这个蜜罐的 ip 地址。（**再次强调一下，无需知道 mysql 的用户名密码即可，输入一个错误的用户名密码，mysql 蜜罐同样可以读取本地文件**）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bat0KKOGLBePYcgxZTn5P3icJhjd4u3ePdZFsVOl2A38fo6uDlVUAh6xcfAWbuTehlvbZ6q6LXGCA/640?wx_fmt=png)

如下图所示，mysql 蜜罐在当前目录的日志文件中给出 base64 加密后的 cs 配置文件内容。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bat0KKOGLBePYcgxZTn5P3Bsic52aXiadh9GIMz3yDl5zA9Hib02Omgtd3omocjeewWXvrnkBibX47gQ/640?wx_fmt=png)

Base64 解密之后结果如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bat0KKOGLBePYcgxZTn5P3UWSSkughe0Q2cruPahf17O0qNdyTrlyIQ1QDSe4Qj3GUy0l1wudR0w/640?wx_fmt=png)

成功使用蜜罐获取到的 ip 地址、端口、用户名及密码连上 cs 服务端（以下图片来源于网络）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DeourJNib4X0aibxdzwxmEWaicYk333BIIr2Pa8Fcs1cT0Yukay41tnnyyib3TAbicNxbUJSWxib4kq8Pg/640?wx_fmt=png)

 **Part3 总结** 

**1.**  尽量在虚拟机下连接或者爆破 mysql 密码，避免踩到 mysql 蜜罐，避免被读取到电脑的各种明文密码配置文件。

**2.**  反编译魔改 cobaltstrike，将. aggressor.prop 配置文件去掉，更改为其它方式加载。

**3.**  配置文件明文密码存储、绝对路径泄露等等，这些不受重视的漏洞还是会造成很大安全隐患的，**本公众号反复提到过，大家还是要注意这些低危漏洞，及时修复掉**。本次事件就是一个教训。

**4.**  mysql 蜜罐还可以读取**微信 id 号、qq 号、手机号**等等信息，大家在日常的测试工作中，一定要注意不要随便连接 mysql 数据库，以免个人信息被获取到。

**5.**  本篇文章只是提供一个分析思路，一个可行思路，不一定就是最终的标准答案，抛砖引玉，期待大牛们的文章。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队、蓝队、日常渗透测试、安全体系建设等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)

**往期精彩回顾**

**[第 18 篇：fastjson 反序列化漏洞区分版本号的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484332&idx=1&sn=c787dd0985156d856aad03d56a945be4&chksm=c25fccd7f52845c1e172b864dfc219dcecc9f226fb5abc64ef31178914ad9f58b7868bf6917a&scene=21#wechat_redirect)  
**

[第 17 篇：Shiro 反序列化在 Weblogic 下无利用链的拿权限方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484319&idx=1&sn=9da36674830837aa9bcacb3fb6268fd1&chksm=c25fcce4f52845f2ac3cebaf17fd3839fdba74f536ad3da20d1b1126d8ba0e1835853990516c&scene=21#wechat_redirect)**[](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484319&idx=1&sn=9da36674830837aa9bcacb3fb6268fd1&chksm=c25fcce4f52845f2ac3cebaf17fd3839fdba74f536ad3da20d1b1126d8ba0e1835853990516c&scene=21#wechat_redirect)  
**

[第 16 篇：Weblogic 2019-2729 反序列化漏洞绕防护拿权限的实战过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484303&idx=1&sn=58cbb4d7f63b9276bb89eeac286d174c&chksm=c25fccf4f52845e241256c2f425003b73b6061b3d1964dcd4a184a2cda1b4d8761098227e6de&scene=21#wechat_redirect)

[第 15 篇：内网横向中 windows 各端口远程登录哈希传递的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484255&idx=1&sn=e233aa07fdf9de0c8a1bf56fb0954766&chksm=c25fcc24f5284532c5aa27c002d15aa6380c456e2a84299c77b8d43a41892517087258bf867d&scene=21#wechat_redirect)

[第 14 篇：Struts2 框架下 Log4j2 漏洞检测方法分析与总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484207&idx=1&sn=285b54a79e48db9a05816cab2e6afc27&chksm=c25fcc54f5284542c1b9abe870e0caa9f958f4da90723bd83292deed215c63c705b7b0bbfaff&scene=21#wechat_redirect)  

[第 13 篇：coldfusion 反序列化过 waf 改 exp 拿靶标的艰难过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484191&idx=1&sn=cce12f62b3cf457bc73753b77a083695&chksm=c25fcc64f528457250b11ef6804ee6138c37ed87ab988874cc84d09d04fa6ac1fd36b5e8aa4a&scene=21#wechat_redirect)  

[第 12 篇：给任意 java 程序挂 Socks5 代理方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484173&idx=1&sn=e2d454d2447d119bf771a0a511fba994&chksm=c25fcc76f5284560d00355590da0147aca7b7ae2275c095424034245ef32b3d0b28e49c2dbc9&scene=21#wechat_redirect)  

[第 11 篇：盲猜包体对上传漏洞的艰难利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484162&idx=1&sn=870596fcd1120a6d3ee9688c38aace00&chksm=c25fcc79f528456f9dc0a3b9d9cf54422696a1cd6ffd737ae2c6e33941a25c33d4f6d32fc663&scene=21#wechat_redirect)  

[第 10 篇：IIS 短文件名猜解在拿权限中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484145&idx=1&sn=7635430b9b759a2cacdd2c57ba330833&chksm=c25fcd8af528449c1f5c6c703e3668cf6a8dae875ee82ffa67caed66722a0751e3d80d8a6bee&scene=21#wechat_redirect)  

[第 9 篇：Shiro 反序列化数据包解密及蓝队分析工具，提供下载](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484123&idx=1&sn=cb9c039ef92311e56e7742c7c38f6e8a&chksm=c25fcda0f52844b6088b39b769a63b2f6e7a29e8b3ab710961918218d7569089ee4e00072ad9&scene=21#wechat_redirect)  

[第 8 篇：Oracle 注入漏洞绕 waf 的新语句](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484115&idx=1&sn=10c73343ec23f522696692293cd38852&chksm=c25fcda8f52844be2165aa6151c7ad018a4add748673d56523631529e903277633dc44d0abba&scene=21#wechat_redirect)  

[第 7 篇：MS12-020 蓝屏漏洞在实战中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484105&idx=1&sn=3aeafa9c172588aaaade47ccacb69370&chksm=c25fcdb2f52844a4a783fceec590c9e12eb06f62dabd7fbffb37e8da23053953a7eae296048d&scene=21#wechat_redirect)  

[第 6 篇：Weblogic 反序列化攻击不依赖日志溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484094&idx=1&sn=527236759dc4fd228461195197492507&chksm=c25fcdc5f52844d36bffb96979116d6d3a9ae4fb1a0f320436c7275aea271588c702cea60e5c&scene=21#wechat_redirect)  

[第 5 篇：Shiro Padding Oracle 无 key 的艰难实战利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484091&idx=1&sn=4dcce59a842f17035d0018bf650671ae&chksm=c25fcdc0f52844d608b6b87d85082b74d5e15888e76001127ff40cc407a46e5e5de446b1365e&scene=21#wechat_redirect)  

[第 4 篇：jsp 型 webshell 被删情况下如何溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484004&idx=1&sn=50013b50e48542d156700d76ccbd2f33&chksm=c25fcd1ff528440906bb9089a807c16b747ab5a72cc0279a3c0d18a265cd76cc796df570d594&scene=21#wechat_redirect)  

[第 3 篇：银行 Java 站 SSRF"组合洞" 打法造成的严重危害](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483984&idx=1&sn=1a018fcefe10124c1726e51a2be05ca7&chksm=c25fcd2bf528443d944a8495ca5c72d8c028fef67de217efe47a8d18b077ae24556842687407&scene=21#wechat_redirect)  

[第 2 篇：区分 Spring 与 Struts2 框架的几种新方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483951&idx=1&sn=fbc1d04ef73a449238a5979a439b1f35&chksm=c25fcd54f528444219f20c2ab14c5970c243fbb10ba04b5bccc0fb0b7cc6d3f542e26f7870bf&scene=21#wechat_redirect)  

[第 1 篇：weblogic9.x 在 JDK1.5 下 T3 反序列化漏洞利用方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483867&idx=1&sn=e0fcaa9f1b58c8085ccd9dc6f74ed336&chksm=c25fcea0f52847b6aeec0409e3290e023b890d603361f103315b39637f89a10dd6fe051dc724&scene=21#wechat_redirect)