<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/AtcYFnXGI1dpWwWfqMw0QA)

Part1 前言

年前在一次攻防比赛过程中，遇到了一个 9.x 版本的 weblogic 中间件，是非常老版本的 Weblogic 了，现有的各种漏洞利用工具都没能拿下权限，考虑到之前也曾经遇到过好几次了，于是研究了一整天，总算解决了这个遗留的技术问题。

Part2 解决问题过程
============

1 安装 weblogic 9.x 版本
--------------------

首先安装 weblogic9.x 版本，这个过程就不叙述了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BE8BmhetEE7aX88gpicxgExdaJVTPbYFrfbY92cuFfpp0MFh1peynND5bBHNQYt0g4a9icPJ4vQwoA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BE8BmhetEE7aX88gpicxgEx36Dnx10w98cS9PdXY062HjJLgCSs7VsKbGibcs19DAY8n00nV0pdCtg/640?wx_fmt=png)

使用 T3 协议发包后，返回 weblogic 版本号是 9.2.0.0

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BE8BmhetEE7aX88gpicxgExZT6sI0542bAMHdWumQI13w1egj0aK02XR1SuBYUMP8PucurfcIQE6Q/640?wx_fmt=png)

接下来看一下 weblogic 目录自带的 jdk 版本，发现是 1.5（几乎是 20 年前的老版本了）。至此初步判断工具利用失败的原因是：反序列化利用工具的 exp 在 JDK1.6 以上版本编译，从而不支持 jdk 1.5 环境，后续发现原因没这么简单。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450BE8BmhetEE7aX88gpicxgExQuJpW8Rh7EdKcQ1vHLGeibpxmSjQMYfNLv2uicibiaApMbPPV5Ku6OmQEw/640?wx_fmt=jpeg)

接下来看一下 weblogic 目录下，存在哪些具有反序列化漏洞的 jar 包:

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BE8BmhetEE7aX88gpicxgExHoUoPg33iaDDj9iavJ6W7FXyTJ88xJ9M2IoeO4UTTRI5IIOfjQAZL0vQ/640?wx_fmt=png)

接下来改造一下老外的 ysoserial 代码，使其在 JDK1.5 环境下编译，结果遇到了好几个坑。

### 第一个坑，idea 在 jdk1.5 支持问题

使用 Intellij Idea 加载 ysoserial 的代码，将 JDK 版本更改为 1.5，发现 idea 新版本不支持 jdk1.5 环境，没法调试代码。

没办法，从 idea 的官网一顿搜索，找到了一个老版本的 idea 11，总算是能支持 jdk1.5 环境了。

idea11 以 jdk1.5 导入 ysoserial 后，报一大堆错误，于是将几个必备的依赖 jar 包替换成较低版本的，以备可以兼容 jdk1.5 环境。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BE8BmhetEE7aX88gpicxgExJIWPDdOjoa53BhV7zibBatku7uwzFkgJzicyHdm09dxykEZibibxBibmbjw/640?wx_fmt=png)

### 第 2 个坑，permit-reflect 组件 JDK1.5 兼容问题

按照前面的步骤替换完低版本 jar 包后，permit-reflect 组件遇到了麻烦，我下载了 0.1 到 0.4 版本都不支持 JDK1.5。。。

后来找到了解决办法：下载 permit-reflect 的源码，以 JDK1.5 环境导入，把报错的代码都给注释掉，然后进行小规模代码修复，将修复好的代码直接放到 ysoserial 工程里面，这下不报错了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BE8BmhetEE7aX88gpicxgExRFR0qLRkaxsXoltQeJGjJ5IVeMUicFgicz2ibzq6cOGYEKibl2dicx1QuYA/640?wx_fmt=png)

### 第 3 个坑 CC 链不适用于 JDK1.5

weblogic 低版本应该是存在 CC 链的反序列化漏洞的，本地尝试了各种 CC 链，发现在 JDK1.5 下是没法弹计算器的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BE8BmhetEE7aX88gpicxgExxQBE6gAcFu4rx5pPzGH8tWvFMUq1AXqNqtO5ZoKDYYVyQwMURfVOmA/640?wx_fmt=png)

### Jdk7u21 最终解决问题

于是把目光放在 Jdk7u21 这个链上 (先前以为 Jdk7u21 是不支持 JDK1.5 的)，以 JDK1.5 环境导入，本地反序列化环境测试，发现是可以弹出计算器的！

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BE8BmhetEE7aX88gpicxgExqWLI9LiaXIuq4lCic7hvMbqf2UicXkYWwg96vib1Pwf0puh4XW6HfETu0g/640?wx_fmt=png)

接下来使用了之前从 github 上下载的 T3 协议发包代码，将上述生成的数据文件发包出去。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BE8BmhetEE7aX88gpicxgExwz0TIQ0YlJibwYny8iaCicibyde4udSwJLjfAsnKT6EichCXgTTA0WqNfkQ/640?wx_fmt=png)

发现 weblogic9.x 成功弹出计算器

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BE8BmhetEE7aX88gpicxgExm550V7IwdhUJt44LXJVgsANNMah1WnJsIBVicmhPkqggY26TLYkAvZQ/640?wx_fmt=png)

  

Part3 总结
========

1.  Jdk7u21 利用链可用于 JDK1.5，但是必须以 JDK1.5 环境编译。
    
2.  Weblogic9.x 默认依赖于 JDK1.5。
    
3.  CC 链貌似不能用于 JDK1.5。
    
4.  permit-reflect 组件改源码，然后导入 ysoserial 中，因为官网的 jar 包版本不支持 JDK1.5。
    
5.  ysoserial 依赖包尽量选用最低版本的 jar 包，否则 JDK1.5 不支持。
    

* * *

网络安全 abc123

专注于红队、蓝队技术分享，每周一篇![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450BE8BmhetEE7aX88gpicxgExlmzReehkFu5TPOTCNJExvLtPdyVviaqc3zSJZE0qqrM42NfgsQxUZsA/640?wx_fmt=jpeg)