<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/8UyGvvq7ahdpKPmrGZDMDQ)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9Lbc0INLwTJTZT1GaNutZrfDn6csvjBoS2ox0efLUEexXqPEcVbYfbLo8w/640?wx_fmt=png)

 **Part1 前言** 
--------------

在最近的一次渗透测试项目中，遇到了一个奇葩的 SQL 延时注入漏洞，sqlmap 无法识别出来。但是客户非让在测试环境跑出数据进行验证，否则不认可这个漏洞的危害性。编写一个多线程的延时注入脚本是很麻烦的，于是 ABC_123 经过了一系列操作，**最终成功让 sqlmap 识别这个注入点并成功枚举出数据**，相信也能给大家很多的启示。

**注：**在读研那会儿，我曾经把 sqlmap 手册打印出来，从头到尾看了好多遍，多读读 sqlmap 手册，可以加深对 sqlmap 的理解。  

 **Part2 技术研究过程** 
------------------

*   **注入漏洞判断过程**
    ------------
    

经过测试，发现这个注入点只能用 **uid=sleep(5)** 这种形式的 payload 才能发生延时，由于 web 应用对用户提交的数据进行了严格判断，所以 **sleep(5)** 函数左右不能有任何的**单引号、双引号、and、or** 等等。尝试用 sqlmap 注入，结果发现 sqlmap 无论怎么配置参数，都是识别不出来这个注入点的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DUfvchyhyZVRiaeria12VbcHnt4N5U0WiaLXmacrqS0WoB9xHsXeGVcLn0ZMQnSbNMxPmicgbzkN6tOA/640?wx_fmt=png)

*   **Sqlmap 无法注入的原因分析**
    

 **1**   有 waf 或者 Web 应用程序本身对用户提交的数据进行了严格的过滤。这个可以结合 sqlmap 的 tamper 脚本来绕过。

 **2**   函数 **sleep(5)** 左右无法接逻辑连接字符 **and or ||** 等，导致 sqlmap 无法在合适的地方插入自己的注入语句。

 **3**   只要 **sleep(1**) 函数设置了延时时间，哪怕只设置了 1 秒，那么它也会一直延迟下去，直至超时，这种情况也是造成 sqlmap 无法识别的重要原因。

*   **Sqlmap 设置第 1 步，构造 if 函数**
    ---------------------------
    

接下来怎么才能让 sqlmap 识别这个注入点呢，我想到了给注入语句加上一个 **if 函数**，利用插入 ***** 号的方法使 sqlmap 识别这个注入。

**uid=if(1=1 and 1=1,sleep(5),1)**  延时

**uid=if(1=1 and 1=2,sleep(5),1)**  不延时，证明语句可用。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DUfvchyhyZVRiaeria12VbcHgwhNup9jO0yRkneGROXF7030wd1GFvtEPJos8zGNo1sFiawP4WicGORw/640?wx_fmt=png)

接下来在 if 语句中插入 *****，构造以下数据包，导出 txt 文本，用 **sqlmap -r c:\zhuru111.txt** 这样载入 sqlmap 中。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DUfvchyhyZVRiaeria12VbcHxmagzlG0YiagjofCMYQ9YUoYzlGFnRRhaGBOvHCBCiaHCDK3Qia0uEk2Q/640?wx_fmt=png)

*   **Sqlmap 设置第 2 步，绕过 waf 过滤**
    ----------------------------
    

经过一系列手工判断，发现程序过滤了**空格、< >** ，还过滤了其它的字符，但是幸亏没干掉 **select**，使得这个注入点跑出数据问题不大。解决这个过滤问题，可以使用 sqlmap 的绕 waf 脚本 **space2comment.py，between.py。**

**space2comment.py** 脚本代码如下，可以将空格替换为 **/**/** 注释符：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DUfvchyhyZVRiaeria12VbcHOpOa5Uv6co5m0ibNrUdiaGQTERSQibABWFQ7ZnITNQgPr9DVdmIR6HicBw/640?wx_fmt=png)

**between.py** 脚本代码如下，将 **< >** 替换为 **between 0 and 98** 形式的注入语句：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DUfvchyhyZVRiaeria12VbcHHw049DIibLJicL9IlCfBW5toQTnTblL3HahPB2yrdZRPt18kicOfcxXmQ/640?wx_fmt=png)

*   **Sqlmap 设置第 3 步，优化延时参数**
    -------------------------
    

经过上面两个步骤设置，sqlmap 还是识别不出这个注入点的。接下来怎么办呢？经过一系列尝试，将 **sleep(5)** 值设置大一些，设置为延迟 33 秒，变成 **if(1=1*,sleep(33),1)**，然后添加延时参数 **--time-sec=5**，最后加上 **--risk=3、--level=3**，终于可以注入跑出数据了，最终的 sqlmap 的语句如下：

**sqlmap.py -r c:\sql111.txt --force-ssl --proxy="http://127.0.0.1:8080/" --tamper=space2comment.py,between.py --batch --dbms=Mysql --technique BT --risk 3 --level 3 --time-sec 5 --current-db --threads 10**

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DUfvchyhyZVRiaeria12VbcHBVYZ2LFdG9ltpwAg7v7soJQ0fZj0aQB7LnA0Xviazia3vM9762uXicIcA/640?wx_fmt=png)

*   **Sqlmap 设置第 4 步，快速枚举表及字段**
    ---------------------------
    

使用 sqlmap 猜解出了数据库名，但是猜解表名是一个麻烦事，因为延时注入是一个字符一个字符的猜解，速度太慢了。但是我们可以挂一个字典让 sqlmap 来枚举表及字段，而不用一个字符一个字符地猜解，这样对于延时注入来说，速度更快。

命令如下 **--common-table --common-columns**

很快猜解出了 user 表，然后很快猜解出了 email，name，pwd 等字段，接下来就是猜解数据了，最终我们构造出一个很复杂的 sqlmap 语句。

**sqlmap.py -r c:\sql111.txt --force-ssl --proxy="http://127.0.0.1:8080/" --tamper=space2comment.py,between.py --batch --dbms=Mysql --technique BT --risk 3 --level 3 --time-sec 5 -T 数据库名 -C 表名 -C user,email,pwd --dump --threads 10**

 **Part3 总结** 

**1.**  把 sqlmap 的手册多看看，多了解一下 sqlmap 的各种参数的使用说明，在日常渗透测试工作中会事半功倍。

**2.** 提前构造一个 **if(1=1,1,2)** 或者 **case when** 语句，可以使 sqlmap 可以识别一些奇葩的 sql 注入点。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队攻防、蓝队分析、渗透测试、代码审计等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)