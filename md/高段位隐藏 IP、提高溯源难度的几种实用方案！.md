<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/km-4_29Td0ol0yG0Ni9qcQ)

为什么会有此文：

原因一：保护个人隐私是是第一出发点；科技进步飞快，网络也渗透入生活中的方方面面，近几年的隐私泄露事故时有发生，我们该如何保护个人隐私？

原因二：得到了大佬的帮助和指点，希望把对我的指点内容记录一下，也能为其他人提供一点点帮助！

本文转自 freebuf 的 ddq，其整理归纳了几种有效的隐藏源 IP 提高溯源难度的几种方案，篇幅略长，但内容很全及其实用!  

原地址：https://www.freebuf.com/sectool/270669.html

**本文目标读者是对网络攻防技术、网络安全技术感兴趣的相关读者，可以将本篇文章作为一个思路上的启发科普文章。**

**切记遵纪守法，交流技术！网络不是法外之地**

测试方式：

通过 CS4.2 生成测试程序，测试回连 C2 服务器时能否达到隐藏服务器的 IP

公网服务器真实 IP：1.2.3.4

Cobalt Strike 版本：4.2

所有需要注册帐号的步骤，都建议使用自己安全的邮箱！

**一、使用隧道转发进行代理**
----------------

一句话核心原理：

利用内网穿透，将 C2 回连端口映射到其他公网地址 64.x.x.x，以达到测试程序通过其他公网地址进行回连，隐藏 C2 真实 ip；

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsWLe1NVV2Q1spjY6vfLmqfg0LPBol10hzpTnEUvvKZgnSyJPS5WByAg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

### **方案分析：**  

**适合用户：**这种隐藏 ip 的方案适合于没有公网服务器，使用自己本地电脑进行测试的用户；或者有公网服务器，通过本方案隐藏服务器真实 ip 的用户；

  
**优点****：**免费使用他人提供的隧道服务，可以快速的用来测试，0 成本；

  
**缺点：**使用了他人提供的隧道服务 (增加了风险)；且注册账号时还需要完成微信绑定 (增加了风险)；国内平台 (增加了风险)；

### **使用流程：**

1. 打开网站

https://www.ngrok.cc/ 注册 ngrok 账号  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsaaXWIrGvAib9zlwMXGgUWJcAUeGricEw8qDoZ0ue7Br3Jf7Yxpw3efMA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**2. 登录后配置 ngrok 代理**  

2.1 购买一个免费通道

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsMdB0DrQKYbNjpYc7Q4tOOvfvroUoopAZ1YsmwkicZ1iaebxB6x8ovnibw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**2.2 配置通道**

隧道类型分为 http、https、tcp

我们本次测试 tcp 通道，http、https 各位有兴趣的自己尝试；

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsoD7G38S4pytsgsmDHMuGPJ9NRZ2xTIwtmEapUDOIPcEfWc0ErgE6Iw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

因为映射到公网的远程端口有限，所以我们需要多次查询可用的远程端口

例如：查询到 10001 端口可用，那就选择 tcp 端口映射 公网服务器的 10001 端口 <----- 映射 ----> 本地 127.0.0.1:8080 端口  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMseNzXQicqL5NXyloUqSRFXNCWXvtgK4tJml2P3gk5Qaphm7zLYcqAnvQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

最终配置如下，其中隧道 ID 就是我们后面要用到的；

隧道域名就是对外部公网提供访问时的公网域名；  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMs5UVbgiaMiaY8C9SIfxdmjYro3hMHgPOcwHjsPZ8XRJjKnAe7nibxd4vEw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**3. 穿透工具使用说明** 

https://www.ngrok.cc/_book/  

3.1 下载可执行程序

https://www.ngrok.cc/download.html  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsibScI8vRrMyB3AgCDqLn4BDia1DyPv4NQUUws7fPUqbciaickOQ6M6mkdg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

3.2 运行隧道穿透  

```
#./sunny clientid 45e3634aAAAAAAAAAA #隧道id


```

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMs8HiakBxOHTThRqX2FZ7aUHbDo7JmDiaSx4fn25ZteNJpIcMTotHvOCLg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

运行成功后，所有访问 xxx.xxxxxgye.com:10001 会和本地 8080 端口打通透明传输；  

**4. 配置 listener**

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMszanTC55bzgcjCticdbX7TicRM2dukYiaBmmDRcw4iaiaaTBET6OOER1qfLg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**5. 生成 payload，运行测试**  

5.1 运行 payload，主机可以成功上线；  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsRqN3fw92pG1o4zRzgHpTPVGu2sIa4NFJ1o97hAiavDqFeV3lsp2Dm1w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

5.2 查看本地回接 C2 服务器的 ip 地址为 xxx.xxxxxgye.com:10001(67.x.x.x:1001)；

而不是我们自己服务器的真实 ip!  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsN3DY0XKVrNjyllTwblHB74Gulz1HEuBnksNYU51SASyiaPuPawNXtnQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

上面的 64.X.X.X 就是 ngrok 的公网 ip  

搞定！

**二、使用 CDN**
------------

一句话核心原理：使用 CDN 内容分发网络的多节点分布式技术，通过 “加速、代理、缓存” 隐藏在后面的静态文件或服务；

最终实现对外暴露的是 CDN 多节点的公网域名 IP，很难甚至无法溯源真实后端服务器的域名或 IP！

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsavXABCxX6CE9AzqXCia3lNxcECz23ISBxkmewjzmFWDb0tp0nIWQXDg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

### **方案分析：**  

**适合用户：**这种隐藏 ip 的方案适合于有公网服务器，通过本方案 CDN 进行 “加速、代理、缓存” 实现隐藏服务器真实 ip 或域名的用户；

使用国内 CDN 服务商的产品的域名必须完成 ICP 实名备案；

  
**优点：**利用 CDN 分布式技术，不同区域的主机就近连接到 CDN 服务，优化了访问质量，隐藏了真实服务器的 ip；

且 CDN 分布式技术可以在一定程度抵抗 DDOS 大流量攻击；

使用国内 CDN 适合用于做红蓝对抗技术比拼等合法目的;

  
**缺点：**受控主机还是通过我们自己的域名进行回连，对外还是能看到连接域名；

且如果使用国内 CDN 的服务 (增加了风险)，域名就必须完成 ICP 备案 (增加了风险)；

而且还有一些方法可能溯源到真实 IP(请一定要按照下面的参考文章 1、2，进行子查一下！)；

### **使用流程：**

(匿名注册新域名且无需备案 + 使用国外免费 CDN 服务)

**1. 匿名注册新域名：**

https://www.freenom.com/zh/index.html?lang=zh

  
1.1 完成账号注册登录 (注册可以先不做，继续选域名后面会有一步骤让我们注册账号)；

1.2 搜索域名：

> **小坑提醒：**
> 
> 这里有一个坑，搜索 wikisoft, 会显示所有域名不可用；
> 
> 但是搜索 wikisoft.tk 就可以；
> 
> 所以一定要搜索域名全称！

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsvuxyOM0x5YxojpWCfM9CyyyabyrQicEVUNVYFt1ibtvhgAulpVWlzjpw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

1.3 下单确认：  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsecoasTOxC4NsHu4fuTzQjnAMC8rIic87suqhGQvpyMKIU5paXADvY1A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

如果之前没有注册过域名，点击 “继续” 按钮，会让我们进行注册账号，或者验证邮箱；然后进行登录再进行选购域名；

(这里如果注册失败，可以用 gmail 注册。)  

1.4 配置域名的 NameServer 域名解析服务

(这样做，后面再解释为什么；现在不修改，默认配置，也可以后面再修改)

1.4.1 进入我的域名：

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsbFp8AU1m9uII7rmTRkpQ03umutsb6nlJiaa8FnnJicLgKib5icibrRJWX3g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

1.4.2 选择域名管理：  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsD9X63AORORC7AibynquYibLGibDeNp7aqSWOpiajxPaw3pE8qk7ReTJkuw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

1.4.3 选择域名解析服务进行修改  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsJl3iauMRu3wiaIhnu7uibyB6gKhgsnRlWjibOYbQic7zwRkcL4RaUA6VwoA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMstvNmh2XoF341vwIK1aSwE8KeibdbKffWXhFEZN9FmQbcoS6Vs0Fpoqg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

```
ASPEN.NS.CLOUDFLARE.COM COLEMAN.NS.CLOUDFLARE.COM


```

匿名域名注册及配置完毕！

**2. 匿名注册免费 CDN 服务 Cloudflare**

2.1 登录注册账号 https://www.cloudflare.com/zh-cn/

2.2 配置域名使用 CDN

2.2.1 添加站点  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsGZUsINeOsXhlUhmarUT2PBMyll1WLEBib8dQRbdhdScsBPJY9gIUfwQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

2.2.3 选择免费计划  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsW14rNvuMbBIiabYicnsic6I8LsviaCPg5YFdpIdgH7ZnWIhPib9bgMDNU6g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

2.2.4 直接配置使用 CDN 代理模式进行域名解析提供服务  

上面 1.4，配置 NameServer 更换解析服务器的原因就是将 wikisoft.tk 域名的所有解析功能都托管在 Cloudflare，这样 Cloudflare 可以提供 CDN 的解析功能！

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsstKaf7ARbUb01ibuPyU19XWTHtrdO9bUJnTQCgQx5XLbaRmSCCDOflQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

2.2.5 自动配置全部选择关闭  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsFe131lBV0tKC0ZzgqSAr23bKGXo5C4Dj047ibENxapulQ6ukf5XxQJw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

2.2.6 配置 SSL/TLS 加密方式

(默认不加密，有兴趣的自己尝试其他加密的区别)  

![](https://mmbiz.qpic.cn/mmbiz_png/XYnjkohc3g8icD8rUo3yxq8kjNBzx2VLxJNMDjHXcwwKL39UwbfxHLq3tlHPrHt7LoibpWgC7WNkWxHE6FVaTcGA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**注意：**Cloudflare 的 CDNhttp、https 代理模式有个特点，如果用其他端口的话，是监听不到的！  

因为我是使用的国内云主机，且 zh.wikisoft.tk 没有进行备案，所以没有办法使用 80、8080、443、8443 端口提供服务；

所以我真实云主机的回连端口使用的是 http--2095！

如果你用的是国外云主机，那就直接用 80！

```
Cloudflare支持的HTTP端口是：80,8080,8880,2052,2082,2086,2095 Cloudflare支持的HTTPs端口是：443,2053,2083,2087,2096,8443


```

到此域名 + CDN 全部搞定！开始测试！

**3. 配置 listener**

HTTP Host Header，必须填写你的域名！

这是 CDN 技术的原理要求；

在下面的 “域名前置方” 案中我们再解释

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsF1JbIGjicicXiaP47u8o64LKS1YGiaOSq9JMhZYVxonfOPEN8Vvz0eDt3g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**4. 生成 payload，运行测试**  

4.1 运行 payload，主机可以成功上线；

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsVN4icfC8wEEwGkHIiaFuZV0nYkMf1tA7fSqs7DbicsOIRo9zU4EHqG2Gg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

4.2 查看受控主机本地回接 C2 服务器的 ip 地址为 172.67.159.243:2095（CDN 节点 ip）；

而不是我们自己服务器的真实 ip  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsmt3NY0Wl03N5ClKJvzkzOfVcvuT2PVfwDUgMjj6CE6CVXwguD67e5w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

4.3 再来说一下这个 ip 是啥：

这个 ip 就是我们使用的 Cloudflare 的最近 CDN 节点的公网 ip  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMs3z8zvodtumC4SJDu9Xo5DTWZIY2bHOjBFftfuTaO2fQtSSJTacZ5tg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

搞定！  

**三、使用域名前置 (Domain Fronting)**
------------------------------

一句话核心原理：底层技术还是上面的 CDN，但是我们使用了其他正规可靠的域名进行连接 (比如：www.baidu.com)

通过设置 HOST=zh.wikisoft.tk 修改 host 头的原理，让 CDN 将连接指向我们期望的 C2 服务器；

最终实现受控主机通过回连！

如果使用 https 的话，除非逆向程序获取 host 头信息，否则无法获取到真实连接域名！

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsdnWx70gb1gcXhzhNmUdLfyPh2iaWJuJricuyUcGIQ4tZspeJcEDorf9w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

### **方案分****析：**  

**适合用户：**这种隐藏域名及 ip 的方案适合于有公网服务器

**优点：**本方案使用高信誉域名进行连接，通常安全设备很难检测，也很难封堵；

  
**缺点：**配置和准备条件较多步骤比较复杂；如果能利用好上面的域名 + CDN 也挺好。

### **使用流程：**

**小坑提醒：**我尝试使用 http 域名前置进行原理演示，因为 Cloudflare 免费版 CDN 不支持上传自定义 ssl 网站证书，只能升级成企业版才可以实现 https！

(如果你是企业版，就是通过修改上面的 “2.2.6 配置 SSL/TLS 加密方式” 这一节就能完成 https 通的联通及域名前置！

可需要申请域名的 https 证书，现在各种云平台都有一年免费证书可用，方法 “参考文章 4、5”。)

**1. 完成上面域名 + CDN 的所有配置**

**2. 获取其他也托管在 Cloudflare 并使用 CDN 的合法域名** (比如：commonlit.app)

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsqzVQ9okIlGicJxxgTktuR9zBbOnM4C2Ass8PwI0zFqI4g64sqaeCdsw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**3. 配置 listener**  

HTTP Host Header，必须填写你的域名 zh.wikisoft.tk, 这是 CDN 技术的原理要求；CDN 的 ip 都一样，如何判断用户访问的时候 baidu 还是 qq 呢？

实际上就是通过 http 头里面的 host 字段进行判断的！详细内容学习 “参考文章 6、7、8”

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsXarSAHWibeA7QIXHDuTZ6RtaZNQGpJfwTX3ZxKjInQWHB24xNc5BTKg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**4. 生成 payload，运行测试**  

4.1 运行 payload，主机可以成功上线；

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsIIHk27EPBaerUUqdWu4qO00pnGPwx08xM8qwGLeU2Xgh7NETmEhlcQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

4.2 查看受控主机本地回接 C2 服务器的 ip 地址为 104.21.41.43:2095（CDN 节点 ip）；

而不是我们自己服务器的真实 ip  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMshYF658DsTw3pCCylfsibS7D0ABMasdNY7pP2CqPKFgfMSVzlWgsjbCg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

4.2.1 查看 DNS 数据包，可以确认连接过程是查询 commonlit.app:2095 这个地址，进行连接的；  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsbfcuXZoALWbPE9qhwqVL9mFNKuyBCia3PDpYWYv1ibIvnjjQD355UxUA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

4.2.2 查看连接数据包，http 方式还是可以看到 host 信息的；  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsbzeKpnvYYLsfef0NPmzxpY4IqBicB5f3jB2DRXopkrCEIVlWbuIgonA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

4.3 再来说一下这个 ip 是啥：这个 ip 就是我们使用的 Cloudflare 的最近 CDN 节点的公网 ip  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMs69C86KW4oialnQyp6ZJ54rzLLqb0cAVDyL4b4bT15KLAeOBjahTknuQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**备注：**

使用 https 的方式进行域名前置，除非逆向程序获取 shellcode 里面的 host 内容，否则无法获取真实域名 zh.wikisoft.tk, 也无法溯源真实后端服务器的 IP！

使用了 https 域名前置，就是在上面的 CDN 直接使用 zh.wikisoft.tk 域名的基础上又增加了一层安全保障！如何逆向二进制，也有教程文档 “参考文章 9”  

搞定！

**四、使用云服务 API 网关 /** **云函数**
----------------------------

一句话核心原理：

api 网关透明转发代理后端服务！(了解一 kong 网关，原理一样)；

云函数底层使用的就是 api 网关，只是云函数的功能更高级一点，当 client 调用网关接口时，通过编程进行修改输入参数；

同理 api 网关接受到代理的后台服务返回的内容是可以再次修改返回内容，最终将信息返回给 client;

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsGW3xvfYgPkkMwPjY7UcviaSetSblIV6W8MfuFIkkrwib9FCw4dx1hY4A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

### **方案分析：**  

**适合用户**：这种隐藏域名及 ip 的方案适合于有公网服务器，注册了云服务商网关或者云函数产品；

  
优点：本方案使用高信誉域名进行连接，通常安全设备很难检测，也很难封堵；

  
缺点：配置和准备条件较多步骤比较复杂；如果能利用好上面的域名 + CDN 也挺好。

### **使用流程：**

**备注：**这一方案，只是原理学习，没有考虑到安全性；

所以直接用了国内的云服务产品！！！

各位可以自己寻找 “安全” 的云服务！

云函数的学习 “参考文章 10、11”，

下面只说明底层的 api 网关内容

**1. 注册 Q 云，完成相关认证**

**2. 配置 API 网关透明传输**

2.1 新建 service

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMstKibCgfiaF0QQGGuw8DzO3gYLNfbfItONPCNWLn3brt9g7y6YCowHKMQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

2.2 新建 API 代理并完成透明代理配置

  
**小坑提示**：前端、后端代理的超时时间都设置的长一点！以免超时！

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMszpG8CniaI9ibR1tMsKCyyQWMFBQ2pIwXGxUkuVMZvMlVaj8jyDF5tQcw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsJR1LxhJs4nB5DK5FOMXVSeMrKvu0L7O8t5TtCj0tAkl8JN9kSsicSuQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

后端域名：如果是 80 端口，就直接填写域名

如果是其他端口，就写成 域名: 端口  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMswABicoJI2nGemf1iaPCvIxdU45d5lmlE1txEDIHhiaiarfrzzlqf4N42tg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMszVI9RDY5FAJ0SlFOknDgQmv6jYTwLThQia4FMhCg1ZyMFlkd04UJRzw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

2.3 查看公网接口调用地址  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsuN2TYdOywcXaoTEoicMENnyzUp4C4jP0L5pBLdpwxsgE3qO4kwWfT6w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**3. 配置 listener**  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMs27wHib9oM003iaL4k01Om6ZMfibAzTiaFplcl9IsuiaHg3Fic9B0VEsOBWRA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**4. 生成 payload，运行测试**  

4.1 运行 payload，主机可以成功上线；  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsARzewNpzIib6NmvW7GPYcHq5zuqefsiaZq5W1icViciaWDhiasicYQvvOcSrQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

4.2 查看受控主机本地回接 C2 服务器的 ip 地址为 152.136.8.215:80（Q 网关节点 ip）；

而不是我们自己服务器的真实 ip  

![](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSEy9l9ceiccJYBQLh3TF1hMsc18ZWsP5e1Pd4RsIA73XAWX7Q196ns7vNg3BeiagTfGVFfkicGs6ItQw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

搞定！！  

**五、再说点其他的**
------------

**1. 域名直接使用 CDN 解析删除其他解析 (安全分数 + 1)：**

既然注册了匿名免费的域名，使用目的狠命聊！

那就别添加太多解析，越多维护越麻烦，泄露信息风险越大！

而且，这个域名后面的所有测试过程都不要不适用代理的模式解析到 ip 或者 CNAME 到其他域名！

任何历史操作都是泄露你个人信息的风险点！  

**2. 服务器访问 IP 源限制 (安全分数 + 1)：**

既然使用了 CDN 服务，为了更安全，就将真实服务器防火墙 + 安全组的访问源 ip 做网段限制！

设置成仅允许 Cloudflare 网段进行访问！防止其他小伙伴扫描 hack 你的 c2 服务！

**3. 域名前置一定要用 https(安全分数 + 2)：**

使用 http 的方式玩域名前置是没意义的，抓包就能看到 http 里面的 host 信息；

而使用 https 的域名前置方式，除非二进制逆向获取 shellcode 里面的 host 信息！(这一点，我可能说错了，https 也能看到 host 信息~~)

**4.C2 服务器安全加固 (安全分数 + 1)：**

C2 服务器的客户端连接的 50050 端口，做好安全防护！

(配置好证书确认登录指纹信息！修改其他端口避免其他网络扫描！

不用的时候就防火墙安全组都 deny 或者限制登录 ip 范围！)

如有侵权，请联系删除

扫码加微信进群

微信号：stone1048

师傅们加好友备注：hw

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/9JPpNb7icHgHmBTTvCxZxr1Hdp0ukNRC5Nb2ZxOQQgnULCx6LJdVmbmtxtJOQicdtdFlEH42UYK8YicibPbyc5ial8Q/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)