<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/6KpetYrKnS6bqsU-GOIe7w)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9Lbc0INLwTJTZT1GaNutZrfDn6csvjBoS2ox0efLUEexXqPEcVbYfbLo8w/640?wx_fmt=png)

 **Part1 前言** 
--------------

大家好，我是 ABC_123，本期分享一个应急响应分析案例。有一家公司自从进行网络改造之后，把所有员工的个人电脑都加入到域环境之中，但是频繁出现部分用户电脑开机速度缓慢问题，而有的用户电脑开机却一直是正常的，一时不知道问题出在哪里。

经过仔细询问，发现出故障的个人电脑大多都是笔记本电脑，开机后会一直卡在如下页面（以下截图来源我的虚拟机环境截图），提示 “正在应用计算机设置”，这个提示会持续一分钟左右。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BnFWIRfm5BmyYU6r60czyW2swtM6bXtqn9LQG1MlibVD9htJj60j8nYVDncYHNHhPwkjYU1aRPMvQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BnFWIRfm5BmyYU6r60czyWzVQF05SwoC7iasGdK8oyoxAlia9lN5a6T5SxWBG0oK6aEqDQ4XDrJjvg/640?wx_fmt=png)

 **Part2 分析过程** 
----------------

部分朋友可能有点懵，不知道该如何下手，其实我们稍微梳理一下在开机过程中客户机电脑登录域环境的流程，这个故障的原因就可以分析出来了。

**用户电脑在接入域环境网络时，首先会根据本机设置的 DNS 去找到域环境的 DNS 服务器，这个 DNS 服务器一般和域控服务器是在一台机子上，然后查找 DNS 服务器的 SRV 记录，域内计算机就是依靠 SRV 记录去定位域控服务器的，由此可以找到域控制器的 ip 地址，然后完成登录****操作。如果此时网络出故障，连不上域控，由于本地计算机的注册表中会有域缓存信息，使用域账号仍然可以登录成功。**

如下图所示，在域环境中，SRV 记录存放在 DNS 服务器数据库中，用于记录每台计算机提供了什么服务，比如说 ldap._tcp.tttttt.com 600 IN SRV 0 100 389 NS.tttttt.com。ldap 表示服务，tttttt.com 是所在的域，600 是生存时间 600s，389 是服务使用的端口，NS.tttttt.com 是提供此服务的主机。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BnFWIRfm5BmyYU6r60czyWfsUGWInkhMGtSpf6S8v8vnibNUGWEuaroAymazxxy2EsibScTGjOTLjw/640?wx_fmt=png)

**故障的原因：**部门员工下班后会将笔记本带回家去，会使用杀软或者优化软件扫描，将本地 DNS 设置为常用的 114.114.114.114，或者是由于其它原因，自己手工设置了 DNS，造成了之前电脑配置的域环境的 DNS 记录被删除了，在第 2 天这些员工带着笔记本上班接入域环境之后，由于找不到 test111.com 域记录，无法找到域控制器进行账号密码验证，会导致开机一直卡死。

 **Part3 解决方法** 
----------------

后续我本地搭建虚拟机域环境成功复现了上述开机缓慢现象。由此也给出了解决方案，那就是把本机的 “**首选 DNS 服务器地址**” 设置为域环境的 DNS 服务器地址，比如 192.168.0.201，将 “**备用 DNS 服务器**” 地址设置为 8.8.8.8 或者 114.114.114.114。这样可以同时保证在公司可以接入域环境，回到家里后，也可以正常上网。

如下图所示，将一台 windows 主机加入域 test111.com 中，然后重启该电脑。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BnFWIRfm5BmyYU6r60czyWKO1MQbTNPIuAz1m3u2icr5gUCaia303e8tLvcN8KsFmQmiameGgVFPcow/640?wx_fmt=png)

重启后将这台电脑的本地 DNS 记录按照如下图所示填写，这里假定域控服务器及域环境 DNS 服务器的 ip 地址是 192.168.237.201，外网 DNS 服务器设置为 8.8.8.8。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BnFWIRfm5BmyYU6r60czyWTibyWWKdyu3r35x074l3yyQSaMI77elqyibW6wMgxCC5see7AdQKB0Lg/640?wx_fmt=png)

 **Part4 总结** 
--------------

**1.**  在处理应急响应事件和分析溯源事件中，很多难以解决的问题，都与 DNS 协议相关，所以弄懂 DNS 挺重要的。

**2.**  可以参考我之前的 DNS 协议的几篇文章，链接如下：

[**第 32 篇：某运营商链路劫持 (被挂博彩页) 溯源异常路由节点(上篇)**](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484584&idx=1&sn=d0d3b9daf503b10500ee963e4f909369&chksm=c25fcbd3f52842c55c99703e90a0fa3df0eb7935e1ac8136c582cacfa9f6594a6a9bb9023dec&scene=21#wechat_redirect)

[**第 33 篇：DNS 劫持攻击原理讲解及溯源分析的常规步骤**](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484596&idx=1&sn=ccdc206de0fa5a2373f315b41703236b&chksm=c25fcbcff52842d90156035c4d81bf5f4c7cc874831aa598490693cb93fe4686d3a65e66a8a6&scene=21#wechat_redirect)
==========================================================================================================================================================================================================================================================

[**第 35 篇：某区宽带用户路由器 DNS 被篡改事件分析（DNS 重绑定攻击）**](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484622&idx=1&sn=f5ae95131593e869920ca08e0daf28f8&chksm=c25fcbb5f52842a3fa051ce454d4dd29ee23698c55c80dde7a53c83388c8d03572cff24efb4c&scene=21#wechat_redirect)
====================================================================================================================================================================================================================================================================

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 实战分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**