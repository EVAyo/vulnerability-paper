<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/PT597N3QceA_rKx7EmB5dg)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
==============

**由于先前文章存在部分错误，原文 ABC_123 已删除，上周末把文章修正，重新发布。**

**大家好，我是 ABC_123**。之前写了一篇《史上最严重的 APT 供应链攻击事件，借助 Solarwinds 攻击欧美的流程图梳理和分析（上篇）》反响还不错。**由于该 APT 供应链攻击事件极其复杂，所以大约需要写 5 至 6 篇文章**。本期继续分享第 2 篇，讲述其中用到的 Sunburst 后门的设计思路，以及它如何实现绕过流量检测的。

ABC_123 对网上大量的分析文章进行总结，排除掉多数人看不懂的二进制分析内容，争取用最通俗易懂的语言，让大家明白这款顶级后门的设计思路，给大家的攻防带来启示。相信大家看了文章之后，会直观地体验到顶级 APT 组织设计的后门有多么强悍。

**建议大家把公众号 “希潭实验室” 设为星标，否则可能就看不到啦！**因为公众号现在只对常读和星标的公众号才能展示大图推送。操作方法：点击右上角的【...】，然后点击【设为星标】即可。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHdFeDURNa0QpfjclGrvg0lfANPtuLbf5Ddur3HZmdfAydibIf9zazCKQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **Part2 Sunburst 后门综述** 
=========================

*   **Sunburst 设计思路及工作流程图**
    -----------------------
    

按照惯例，首先放出一张 ABC_123 绘制的关于 Solarwinds 供应链攻击事件中 Sunburst 后门的设计思路及流程图，是从大量的 Sunburst 后门样本分析文章中归纳整理出来的，接下来依据此图，详细讲解整个后门工作过程。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Cc6PtArxqPm4mGaj9AoIpcDnmdERXhF7sMJHiceiavFaV2FeKKk0UAPNxr3019ahhxcPR8uSOqAYhw/640?wx_fmt=png)

Sunburst 后门是如何被编译进 Orion 软件中的，**上一篇文章有详细介绍，这里就不叙述了**。Sunburst 携带了合法的 Solarwinds 合法数字签名，这种方式自带白名单效果，完美绕过各种防护措施。最终该 dll 文件被打包在 Orion 网管软件的更新补丁中，一旦受害者安装此补丁就会导致 Sunburst 后门触发，但是它不是立即运行的，会经过一系列复杂的初始化条件判断，比如是否在真实的受害者的计算机环境中运行，以及是否有杀软防护，父进程是否合理等。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTTbnZ1iajodVDjsc4qGO8uXMFEkmdKicSbNkbZWtyaAAeic2Euqiavtibiczw/640?wx_fmt=png)

*   **Sunburst 后门的三种状态**
    --------------------
    

Sunburst 后门将会从 Solarwinds 公司的 Orion 软件中的 XML 配置文件中读取 ReportWatcherRetry 的值，借此判断是否继续运行，只有其值不为 3 的时候才会继续运行。

该 XML 配置文件的 ReportWatcherRetry 值**会返回 3、4、5 三种值，分别对应了 Truncate、New、Append 三种持久化状态**，默认值为 4(New）。4(New) 表示后门第一次运行，5(Append) 表示告诉后门先前已在系统上运行，但因存在预定条件（如主动防病毒软件）而退出，3(Truncate) 意味着该后门应当立即停止运行。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTl2tiamyKHgM0UO1jWKkfzlzpFlFn9wRibKiaDI3plBUWiadOWIVa8dF3Ng/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTycH4FIasNYwsQfiaqCkXdcqeUibNYXRKibuF3Nv6xa3LXKib374Vqdv30g/640?wx_fmt=png)

 **Part3 后门触发的 8 个必要条件** 

**注：**Sunburst 后门在执行条件判断阶段，会频繁使用 **OrionImprovementBusinessLayer.DelayMin()** 方法随机休眠 / 延迟 30-120 分钟，延迟代码执行速度，这样可以降低被自动化分析防护软件发现的概率。

 **1** **判断唯一实例执行**
-------------------

通过 C# 代码中的 isAlive 方法进行判断。
--------------------------

 **2   判断父进程**

通过计算父进程名的 hash 值，判断运行进程是否为 SolarWinds.BusinessLayerHost.exe 或 SolarWinds.BusinessLayerHostx64.exe，而且 hash 算法是自定义的。这一步是规避沙箱检测或者调试工具，避免沙箱自动化检测或者安全人员分析。

 **3   等待 10 几天后运行**

随机设置后门激活时间，会随机等待 12 天到 14 天逐步触发恶意代码。这样做的目的是让全球 1 万 8 千多家 Orion 软件用户的被控服务器逐步上线，**避免集中上线被流量监控设备发现并告警**，导致计划败露。很多单位会在 7 后清除日志，所以足够的等待时长也可以减少日志记录。

 **4** **创建命名管道防止多实例运行**

后门创建名为 583da945-62af-10e8-4902-a8f205c72b2e 的命名管道，放置多示例运行。

 **5   检查配置文件状态参数**

检查 XML 配置项 ReportWatcherRetry 的值，判断当前 Sunburst 后门所处的状态，如果是 New 或者 Append 状态的话继续运行。

 **6   本地域名黑名单检查**

**1.** 获取 AD 域并通过 Hash 和正则判断是不是黑名单中的值，如 swdev.local，swdev.dmz、saas.swi 等，其中 swi 对应着 "SolarWInds Internal"，swdev 对应着 "SolarWinds Develop"。**2.**  不能包含 solarwinds 关键字。**3.** 该域名不得与正则表达式 (?i)([^a-z]|^)(test)([^a-z]|$) 匹配，简单来说，它不能看起来像是一个测试环境域名。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTfLzvtlXbwW2l9W8lvc2umFNDjxibUTeGap42VQ3KvDphFb2I0yHOoPA/640?wx_fmt=png)

 **7   检测是否存在杀软进程、服务、驱动**

**1. 进程黑名单检查**

通过 SearchAssemblies 方法检查是否有进程黑名单，查看是否有 Windbg、Winhex、Autoruns、Wireshark、dnSpy、apimonitor-x64、fiddler、idaq64、ollydbg、procdump64、x64dbg 等进程存在。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTfSSmLDZ0XuHdbYPVicMDNPtkGOhIzmNUMndnaIBFv6DbOSzDKks22MQ/640?wx_fmt=png)

**2. 服务黑名单检查**

通过 SearchServices 方法检测是否有黑名单服务名，例如 Windows Defender、Carbon Black、Crowdstrike Falcon、FireEye - EDR 等。如果遇到黑名单服务，Sunburst 会通过修改注册表，将服务禁用掉。

**3. 安全软件驱动黑名单检查**

通过 SearchConfigurations 方法调用 WMI 查询，Select * From Win32_SystemDriver 检测是否有驱动黑名单，比如 groundling32.sys 等。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTvkLlVyBicUWzoNr0ZX1XJBbBomFRySSajnO9ZyKQNoFT6NXpkGAic2qA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTeJNaGVSUXcia8MM2famjccNP7uc1cHFHI4srGARlicL3yzQNd90XuXtA/640?wx_fmt=png)

 **8   确认网络连通性**

通过 CheckServerConnection 方法解析 api.solarwinds.com 域名，做网络联通性检测，只有通过检测才会进一步执行，否则就会退出，等待下次执行。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTUpLkWz8MxKOsVhjvAtgbJoQVAdurHgtsEZ0QsJFLyDiavsT54HyEJ3Q/640?wx_fmt=png)

 **Part4 后门 DGA 域名通信阶段** 
=========================

*   **dga 域名通信阶段前置知识**
    ------------------
    

 **1   dga 域名通信阶段概述**

在以上环境检测都通过之后，Sunburst 后门会进入使用 dga 域名的 DNS 通信阶段。**DGA 域名通信包括两个阶段：**第一个阶段主要向攻击者 C2 反馈计算机域名信息，便于攻击者根据这些信息筛选目标；第二阶段主要反馈安全防护软件的状态信息，便于攻击者了解目标杀软、edr 等部署情况。这些信息加密隐藏在 DGA 域名的第一个分段中，Sunburst 后门攻击者根据 Sunburst 后门收集的计算机域名信息及安全防护软件信息，挑选了大约 100 家有价值的目标进行内网横向。

 **2   唯一标识符 userid**

部分受害者计算机基础信息过大（比如说计算机域名过长），需要发送多次 DGA 域名请求才能完整地把计算机域名信息传输完毕。为了能够区分不同计算机的 dga 域名请求，把来自于同一计算机的 dga 域名的分段信息解密后组合到一起，Sunburst 对于每台计算机都会计算一个唯一的标识符 userid。

对于每台受感染的计算机，**userid 由受害者的 MAC 地址、windows 域名，windows 计算机唯一标志符 GUID**（即 Windows 安装时随机生成并存储在 HKLM\SOFTWARE\Microsoft\Cryptography\MachineGuid 的注册表值）这 3 个值经过自定义的加密算法，计算得到的唯一的 userid。

 **3   后门 DGA 域名生成格式**

Sunburst 使用的 dga 域名做了非常巧妙的处理，大致格式如下：

***.appsync-api.eu-west-1.avsvmcloud.com（* 代表 DGA 的子域名）**

***.appsync-api.us-west-2.avsvmcloud.com（* 代表 DGA 的子域名）**

***.appsync-api.us-east-1.avsvmcloud.com（* 代表 DGA 的子域名）**

***.appsync-api.us-east-2.avsvmcloud.com（* 代表 DGA 的子域名）**

其中，每个 DGA 域名右边三个分段，来自于后门程序中硬编码的字符串，而 dga 域名的第一分段的星号部分是根据受害者服务器中的计算机域名等信息动态生成的，以下是一个 DGA 阶段域名生成算法的示例。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450CBBQ7uAg6tjpCmSCllZrDg4wHjBKibKrWrubfjohDoPsgHe9CLAB6aic1br6fdBCsI9YpKU4y7Tcicg/640?wx_fmt=jpeg)

*   **后门的 dga 域名通信阶段**
    ------------------
    

 **1   第 1 阶段 DGA 域名通信**

在这个阶段，Sunburst 主要任务是把受害者计算机域名，经过几层加密放在 DGA 域名中，然后回传给 C2。如果有的计算机域名过长，那么 Sunburst 后门会对信息进行分割，每次发送 14 个字符，发送多次 DNS 请求完成信息传送。**攻击者如果对此计算机域名感兴趣，会进入第 2 阶段 DGA 域名通信**，随后 Sunburst 后门将被激活，变为 "Append" 状态。

如下图所示，这些是从流量中抓到的 Sunburst 在第一阶段的 dga 域名通信的 dga 域名的流量样本。第二列是解密出来的 Sunburst 收集的受害者域名，**攻击者就是从这些解密出来的域名信息，判断目标受害者单位是否有价值的**。通过对这些域名进行解码分析我们发现，疑似包括思科、Intel 在内的多家科技公司以及美国多所大学、政府机构均疑似本次攻击的受害者。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTGL42Dm4QzWLR0PF01UsheJeKrGAiaRPmotbO5icWCDnZJBibvrNMHaiagg/640?wx_fmt=png)

 **2   第 2 阶段 DGA 域名通信**

在这一阶段，Sunburst 后门主要完成将受害者计算机的杀软防护状态信息回传给 C2 服务端。当 Sunburst 后门状态为 Append（激活状态）时，即开始第 2 阶段 dga 域名，生成的 DGA 域名将包括计算机唯一标志符、**内置服务黑名单的安全产品测状态信息**（包括是否存在、是否还在运行、是否被关闭等信息）和与上一次 DNS C2 阶段中通信是否成功的信息。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTNsszQwPibIcLMDHlzSyVZEym3QcuoSP42kXoTL6p9kRhRDibzHKcZ7icA/640?wx_fmt=png)

 **3   IP 地址作为命令触发器绕过流量监控**  

------------------------------

我们通常在查询 DNS 的时候，比如访问 google.com 域名会转换为 142.250.*.*，IP 地址保存在 A 记录中。Sunburst 后门也会解析 C2 域名获取 IP 地址，**但是 Sunburst 的目的不是使用这些 IP 地址通信，而且根据 C2 域名解析出来的不同 IP 段内的 IP 地址，来触发不同的恶意操作**，这是非常巧妙且非常隐蔽的命令控制形式，流量监控设备难以发现。

攻击者控制 C2 域名的解析 IP 地址范围属于 Google、Amazon 和 Microsoft 段的 IP 地址，而不是随机选择 IP 地址来触发不同的行为，这是为了降低被检测的机率。再次强调，恶意软件不会与这些 IP 地址进行通信联系。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTzl5jUALyDHpl2Uo41LEmQyeic8zIgkRDpeQCyTQSRmumcIfuvhEwhsQ/640?wx_fmt=png)

如上图所示，Sunburst 开发者将 IP 地址定义在一个 AddressFamilyEx 结构中，**Sunburst 将会根据 DNS 解析返回的不同 IP 地址触发不同的恶意行为**。通过阅读 Sunburst 后门的 C# 代码发现，根据 C2 将域名解析到不同类别的 ip 地址，Sunburst 后门将执行大约 5 大类型的操作：

**1.** 继续发送未传输完毕的域名片段信息；**2.** 发送目标计算机的安全防护产品的状态信息；**3.** 执行第 2 阶段的 C2 通道；**4.** 清理并退出；**5.** 重置成初始状态，就像第一次执行一样。

最后给出一张总的图：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTIyDdeSARicfMeZTfiaUiasfg2Pib8YLtJdtVAhBtia9MnvgtsArycOvyr3Q/640?wx_fmt=png)

 **4   C2 控制域名解析 ip 间接控制 Sunburst 流程图**

接下来 ABC_123 制作了一张流程图，演示了实战过程中 C2 端如何通过控制 DGA 域名解析到不同 IP 来控制 Sunburst 后门行为的全过程。**由于该通信过程非常复杂，后续 ABC_123 会专门写一篇文章详细讲解全过程**。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450CBBQ7uAg6tjpCmSCllZrDgYw1qQGNf1hJU5QlWfU0WNUtVPTSRNj41O9tEObjtN6W2OCvucYuZBQ/640?wx_fmt=jpeg)

 **Part5 HTTP C2 通信阶段（获取攻击指令并执行）**
----------------------------------

通过前面 2 个阶段的 DGA 域名通信，攻击者筛选出了有价值的目标，Sunburst 后门进入下一个阶段：HTTP C2 通信阶段。**在这个阶段 DNS 的返回数据中会有 CNAME 记录，Sunburt 后门会将此域名用来做 HTTP C2 通信**。

在这个阶段，Sunburst 将会启动一个新的线程执行 HttpHelper.Initialize 方法，以便去处理 HTTP C2 通信阶段请求，接收攻击者发送的指令并且执行，然后将指令执行结果经过加密后，混淆在正常的流量包中反馈给攻击者的 C2 服务端。**研发 Sunburst 后门的攻击者，为了过流量监控，在这个阶段设计了极为巧妙的流量加密方法**，接下来 ABC_123 给大家具体说一下，让大家开开眼界。

首先贴出在 HTTP C2 通信阶段 Sunburst 后门的 3 种不同的 URL 访问形式，分别对应着 3 种情况：

**1.** Sunburst 会不断访问. xml 网址，主动获取 C2 端的指令，URL 形式如下：

**hxxps://3mu76044hgf7shjf.appsync-api.eu-west-1.avsvmcloud.com/swip/upd/Orion.Wireless.xml**

**2.** Sunburst 将指令执行结果返回 C2 端，数据大于 10,000 时，URL 形式如下：

**hxxps://3mu76044hgf7shjf.appsync-ap.us-east-2.avsvmcloud.com/pki/crl/492-ca.crl**

**3.** Sunburst 将指令执行结果返回 C2 端，数据小于等于 10,000 时，URL 形式如下：

**hxxps://3mu76044hgf7shjf.appsync-api.us-east-1.avsvmcloud.com/fonts/woff/6047-freefont-ExtraBold.woff2**

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTwv2AaO67gO8jL7EqgGBF2B7uzEl0ul6JUGUl9txj7AkcpcibjkRT2xg/640?wx_fmt=png)

接下来讲解一下 Sunburst 后门获取 C2 指令并执行，然后将执行结果回传给 C2 端的 3 个过程。

 **1** **Sunburst 访问. xml 网址接收指令**

为了获取攻击者发送的指令，Sunburst 后门会不断发起 http GET 请求访问 C2 端的. xml 结尾的 URL 地址，而且在每次请求之后，都会通过 setTime 设置的时间进行休眠。这些 XML 文件会伪装成一个与. NET 程序集相关的正常的 XML 文件，**攻击者下发的指令就通过各种隐写技术隐藏在其中**。Sunburst 会读取 C2 端返回的 XML 文件内容，并使用特有的解密算法从 XML 文件中提取攻击者发送的指令并执行。

Sunburst 发起 GET 请求的 URL 路径是随机的，按照一定的算法进行随机构造，**这样做也是为了对抗 IOCs 检测**。对于以下 URL:

hxxps://3mu76044hgf7shjf.appsync-api.eu-west-1.avsvmcloud.com/**swip/upd/Orion.Wireless.xml**

Sunburst 后门对于 URL 请求的变换主要在于标黄的部分：/swip/upd/<random components>.xml。<random components> 的取值算法比较复杂，每一小段设置了不同的比例被随机选取到。值得注意的是，error code 的最后一位数字不是随机字符，取值为 0 或者 1，表示上一步执行命令请求的是否成功。其中通常 0 表示成功，1 或其它值表示错误，最后加上. xml 后缀。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450CBBQ7uAg6tjpCmSCllZrDgs49NxbiaVjtfKkjckrcF6JweFscvL97Q3Frf7rD5JFmgtc80yic2QwibA/640?wx_fmt=jpeg)

最终会 Sunburst 根据算法随机构造出以下 URL 去访问 C2 端，获取下发的指令：

**https[:]//infinitysoftwares.com/swip/upd/SolarWinds.CortexPlugin.Nodes-5.2.1.xml**

**https[:]//infinitysoftwares.com/swip/upd/Orion.Wireless.UI-3.1.0.xml**

**https[:]//infinitysoftwares.com/swip/upd/Nodes-1.2.0.xml**

对于前 16 个请求，每次都使用不同的随机生成 URL 路径，但之后它可能会重复之前使用的随机生成的 URL 路径。在这个阶段会有一个固定的 **If-None-Match** 自定义请求头，这里含有经过加密处理的先前的 userId。

如下图所示，这是在 Sunbrust 访问. xml 结尾的 URL 的 GET 请求之后，攻击者 C2 服务端返回的 XML 格式内容，里面就加密存储了攻击者下发指令：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTCqKOtkT9jicae622wIeTLpiaL02iaIppMRE7Pq5GI3knWwjjSJibnmrQxg/640?wx_fmt=png)

 **2** **Sunburst 解析指令并执行**
---------------------------

Sunburst 后门从 xml 返回文本中解密提取攻击者下发的指令，并通过 ExecuteEngine 方法执行对应指令，**通过 JobEngine 中的值作为条件，运行由命令行参数组成的命令**。由这些指令可以看出，Sunburst 后门执行的操作非常有限，这意味着攻击者如果想进一步扩大战果，必然要借助于其它工具进行更复杂的操作，也就是第三阶段的 CobaltStrike 后门。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTw9CNcx6Dzz9dQWbDVQzQHPbibko3icUEPLr5nibyqAAI3gjCjAgFfubEA/640?wx_fmt=png)

**1.**  当指令被解析为 JobEngine.SetTime 时，设置每次请求的延迟时间。

**2.** Job.CollectSystemDescription 时，将会收集信息，包括计算机域名，Administrator SID、本地主机名，用户名，操作系统版本信息，系统路径，网络适配器情况、注册用户的公司名、注册用户名、系统版本号、系统目录等。

**3.**  JobEngine.UploadSystemDescription 时，构造 HTTP 请求，将请求结果发给 C2 服务器。

**4.**  JobEngine.RunTask 时，根据给定的文件路径和参数启动一个新的进程。

**5.**  JobEngine.GetProcessByDescription 时，获取进程列表，根据进程参数获取进程信息，包含进程 ID，进程名，父进程 ID，进程对应用户名。

**6.**  JobEngine.GetFileSystemEntries 时，根据参数中的正则表达式列出文件和目录信息。

**7.**  JobEngine.KillTask 时，Sunburst 将会杀死指定 PID 的进程。

**8.**  JobEngine.SetTime 时，设置延迟秒数，第二次触发时，如果第一次设置的时间小于 300 秒则会进行一次加倍延时

**9.**  JobEngine.FileExists 时，判断指定路径是否存在。

**10.**  JobEngine.DeleteFile 时，删除指定路径。

**11.**  JobEngine.ReadRegistryValue 时，读取注册表项的值。

**12.**  JobEngine.SetRegistryValue 时，设置注册表项的名称、类型、路径

**13.**  JobEngine.DeleteRegistryValue 时，删除注册表项

**14.**  JobEngine.GetRegistrySubKeyAndValueNames 时，获取所有指定项名称和数据

**15.**  JobEngine.WriteFile 时，解密传入的 base64 字符串并写入文件，写入后会触发延时函数保证，可见攻击者对于文件处理流程很是小心。

**16.**  JobEngine.Reboot 时，重启目标计算机。

**17.**  JobEngine.Exit 时，退出当前线程，等待下次被加载执行。

**18.**  还会根据指令投递第三阶段后门程序，TEARDROP、RAINDROP，用来加载 CobaltStrike 后门。

 **3** **Sunburst 将命令执行结果回传给 C2**

一旦 Sunburst 后门从 XML 文件中解密出攻击者下发的指令之后，Sunburst 后门会按照指令进行执行，并将返回结果回传给 C2 服务端。Sunburst 后门在数据回传阶段，不会发送 GET 请求，而是**依据回传数据结果的大小，选择通过 POST 请求或者 PUT 请求将命令执行的结果回传给 C2 服务端**。Sunburst 会把请求伪装成合法的 Solarwinds 请求链接或者静态资源迷惑安全人员，误将 Sunburst 发送的 http 请求初步评估为合法的流量。

**1、当回传的数据大于 10,000 字节时**。Sunburst 通过 POST 请求发送。POST 请求会设置 Content-type 字段，application/octet-stream。这种情况下，URL 格式如下：

**hxxps://3mu76044hgf7shjf.appsync-api.us-east-2.avsvmcloud.com/pki/crl/492-ca.crl**

请求 URI 路径格式为 **/pki/crl/{第 2 分段}{第 3 分段}{第 4 分段}.crl**，其中 {第 2 分段} 是 100 到 10000 的随机数；{第 3 分段}是一个内置的字符串列表，从中随机选择一个进行拼接；{第 4 分段}表示上次请求的错误码，某些情况下此值为空；最后在 URL 结尾拼接上. crl 后缀。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450CBBQ7uAg6tjpCmSCllZrDg3wFGFXLqHEBDtNFUOmuqib6VACqLiaBJIRlAd339sIrePCDTKKqAicZJw/640?wx_fmt=jpeg)

**2、当回传的数据小于等于 10000 字节时**。Sunburst 将通过 PUT 请求将执行命令的结果回传给 C2 服务端。PUT 请求回传的数据会被转换成类似于 Solarwinds 合法使用的 Orion 改进计划（OIP）消息的 JSON 文档，其中 json 数据中的 Message 是待发送的数据，在发送 http 请求时，会设置请求头 **Content-type: application/json**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaT3LicF9CS1FicKriaksPxV0L593L8cugCHz4icPtK8mOTPgicxXcB9YfVVdg/640?wx_fmt=png)

在这个阶段，访问的 URL 格式如下：

**hxxps://3mu76044hgf7shjf.appsync-api.us-east-1.avsvmcloud.com/fonts/woff/6047-freefont-ExtraBold.woff2**

其中，URL 格式分为两种情况：

**1. /fonts/woff/{第 2 分段}-{第 3 分段}-{第 4 分段}-webfont{第 6 分段}.woff2**

{第 2 分段} 是 100 到 10,000 之间的随机数；{第 3 分段} 内置列表字符串列表随机选一个；{第 4 分段} 内置列表字符串列表随机选一个；{第 6 分段} 表示上次请求操作的错误码。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450CBBQ7uAg6tjpCmSCllZrDg5w2zF7gLHleZIXz7ZLbwKSsHRwU4o5SmMmvicKibHCwYUXk73MXBjsfQ/640?wx_fmt=jpeg)

**2. /fonts/woff/{第 2 分段}-{第 3 分段}-{第 4 分段}{第 5 分段}.woff2**

其中 {第 2 分段} 是 100 到 10,000 之间的随机数；{第 3 分段} 内置列表字符串列表随机选一个；{第 4 分段} 内置列表字符串列表随机选一个；{第 5 分段} 表示上次请求的错误码。

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450CBBQ7uAg6tjpCmSCllZrDgmB4duoECosxd93RkicraJ8qYibAgH1ORzqeaprV5DLic6ro5YEicuzAIwg/640?wx_fmt=jpeg)

Sunburst 将指令执行结果隐藏在以下 JSON 格式的 POST 请求数据包中，然后回传给 C2 服务端。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CBBQ7uAg6tjpCmSCllZrDgvsF48ONZicSVzP80jiaGibQKXXXYNfE0R9PK56Kdy152oXOHoiaNSdibMag/640?wx_fmt=png)

 **4** **Sunburst 投放第三阶段武器**
----------------------------

最后 Sunburst 将会进入第三阶段。首先下载一个 vbs 脚本及 Loader 加载器程序，放在 C:\Windows \ 目录下伪装成合法文件。接着 Sunburst 使用映像劫持技术，通过修改注册表，将 dllhost.exe 与 wscript.exe C:\Windows\[folder]\[trigger].vbs 命令进行绑定，dllhost.exe 是 windows 下随机启动的程序，接下来攻击者会静静等待 dllhost.exe 执行，以便进一步执行 vbs 脚本。**至此 Sunburst 后门已经完成了它的使命，后续的操作将与 Sunburst 无关**。
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

接下来 vbs 脚本会执行以下操作，运行 rundll32.exe，加载前一步的恶意 dll 文件，清理 dllhost.exe 的映像劫持注册表，清理痕迹，最后运行 Loader 程序，加载 CobaltStrike 后门，开始内网横向操作。**关于第三阶段的详细操作，后续 ABC_123 会专门再写一篇文章给大家讲解，敬请期待**。  

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AvbLzAsR16vuffdEsFBqaTfw7GAiccjFwSIZHu8rMHN60zvWBNBvGuwD1ZwE5XtElzERiaNaTvMqMQ/640?wx_fmt=png)

 **Part6 总结** 
==============

**1.**  Sunburst 后门必须在满足攻击者的要求，安全防护软件在攻击者预想的情况下才会继续执行，否则就会终止或者重试之前的修改防护软件状态的操作，这方面是 APT 攻击者与普通犯罪人员之间的关键区别之一。

**2.**  为了对抗 IOCs 检测，Sunburst 后门作者设计了巧妙的 dga 域名生成算法和 URL 路径随机生成算法，而且两个 dga 域名请求间隔时间可能长达一整天，攻击过程非常隐蔽。

**3.**  Sunburst 在 HTTP C2 通信阶段，回传受害者电脑敏感信息时，把这些信息加密存储在 XML 程序集文档中或者 JSON 文档中，有时候还特意模仿 Solarwinds 专用协议的通信流量，这种方式在流量审计中难以发现。

**4.**  该 APT 组织通过将 C2 域名解析到不同的 IP 地址段，间接控制 Sunburst 后门的操作，这个攻击行为在流量审计中难以发现。

**5.**  攻击者向 Orion 软件的 XML 配置文件中写入不同的数字 3、4、5，表示 Sunburst 后门所处的不同状态，Sunburst 后门会读取这些值进行不同操作，这个过程同样非常隐蔽。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**