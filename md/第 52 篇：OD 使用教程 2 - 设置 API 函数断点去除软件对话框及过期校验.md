<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/rvoB2qiTIjlRvqHxfKZ7_A)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcaA8wBFW4icTiaL7ELd8ia04Olh40TBx7CquHZyCicicl4eYJno2y0oZ0H4A/640?wx_fmt=png)

 **Part1 前言** 
--------------

大家好，我是 ABC_123。之前分享过一篇 Ollydbg 逆向分析入门教程《**第 50 篇：使用 OD 逆向破解流光 Fluxay 扫描器各种限制**》，这篇文章主要讲解了在使用 OD 逆向分析时，如何按照编程人员的思维去解除软件的各种限制。方法有点麻烦，而且还有一处软件过期校验没有完美去除掉。

**本期除了介绍通过段首关键 call 解除软件过期的方法以外，还会介绍一种通过查找 API 函数下断点的方法**。假设软件是 c++ 写的，程序读取文件一般就会调用到 ReadFile 函数，程序退出一般就会调用到 ExitProcess 函数，那么我们完全可以在这些函数附近下断点，快速定位到关键跳及关键 call，从而解除软件限制。

 **Part2 逆向分析过程** 
------------------

*   **去除软件的过期校验**
    -------------
    

首先看一下流光 2000 的这个 “**软件过期**” 窗口，在软件运行时，有时候就会弹出来这个界面，进度条走到头软件就会自动退出。上期我们通过改关键跳和 nop 的方法解除限制，但是不完美，偶尔还会提示软件到期，这次我们尝试完美解除这个限制。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQt9M8W5uX8CvMKrDYxRlVMicQSaDvA5iamatJEnsYYg1pia6hgJI9xsiaKRQ/640?wx_fmt=png)

首先我们用 “**智能搜索**” 插件试试查找字符串 “**到期**”。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtRhVW8z8Qax4ye578Sj0ibSGUYQeJB4WeDa4hnjfclsJnaUic2nVWFibHw/640?wx_fmt=png)

然后把找到的结果都下断点。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtnF6TBQeP0yFbbjjzQfS0V5wQbn0ddR0mGRMRhpWSKzZD4upFiaibUlYg/640?wx_fmt=png)

使用 OD 重新载入软件，很快定位到了弹出 “软件过期窗口” 的关键代码，但是在此代码附近反复下断点调试，各种修改关键跳，各种 nop 都行不通。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtDSX1uN60Iugv8KJgmBRxuK4N2cN0u46iclKAOzhm3cmODxEIV0eP1iag/640?wx_fmt=png)

那接下来怎么办呢？**不妨在这段汇编代码的段首处下断点，重新跟一下汇编代码**。如下图所示，标红的 00470810 是段首位置，从这里开始分析汇编代码，我们发现了 “**GET / HTTP/1.1\r\n**” 字样，Host 头被设置为 **www.sina.com.cn**，推测作者是请求新浪网址的返回时间与系统时间来做对比进行软件过期校验的。

F8 单步走执行到 004708A9 位置（如下图箭头所示），这里有一个关键 call，**执行速度非常慢，推测这是发起 http 请求的代码**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtiamAuNMtS1PsVKbCZibW8LZbib3coz9PmHnibRygENVblZvExBOuFhB0rw/640?wx_fmt=png)

这里遇到了最关键的代码 **test eax,eax**，经过分析发现，call 00484100 处代码逻辑是这样的，**软件过期则 eax **寄存器**等于 00000000，软件不过期则 eax **寄存器**等于 00000001**，因此这里是关键 call 的位置。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtfASrOicREPdCql8Tl2LHhEeUCIxyRLFvaxoicNp3WVAJNvPWkB7Fu3lw/640?wx_fmt=png)

接下来怎么办呢？我直接把 call 00484100 对应的函数代码给改掉，**直接将函数的代码改为 mov eax,0x1; retn 0x8;** 用 retn 0x8 后，该函数中后面的代码就都不执行了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtVlLmFJr5ibo3pNgBBt4W6icJY8CVib9FEcdu9Ezzeic02G4ss7RSuOiaErg/640?wx_fmt=png)

把关键 call 改掉之后，继续运行软件，发现流光 2000 的时间校验完美绕过。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQt1k5SxwdViaDiaR7gv3eUH3qIwVAPnWWESLa0tcN5zahiahOXib0a69QMvg/640?wx_fmt=png)

*   **用户调查表断点定位**
    -------------
    

首先使用 PEID 查一下，发现是 VC++6.0 写的，因此我们可以查找 VC++ 的对话框函数来下断点。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtX3S5rCpMvlYVaicZUfbDOUlxOWEHdxXZDrs72U9Ftk7g26c775PYMbg/640?wx_fmt=png)

为了定位这个用户调查表，需要先讲一下有关 VC++ 对话框的 API 函数基础知识。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtEwWzw8hEWVx1E8ic6icVbuHNKPBx5ibmDZePzBFTC946HxQfullm6ekYA/640?wx_fmt=png)

**对话框分为两类：模态对话框和非模态对话框**。区别是模态对话框不允许在不同窗口之间切换，非模态对话框可以；创建模态对话框是由调用 DialogBoxParam 函数实现的，创建非模态对话框是由调用 CreateDialogParam 函数实现。相同点是这两个函数的第一个参数都是 hInstance，也就是对话框的实例句柄。

**DialogBoxParam**( HINSTANCE **hInstance**, LPCTSTR lpTemplateName, HWND hWndParent, DLGPROC lpDialogFunc, LPARAM dwInitParam);

**CreateDialogParam**( HINSTANCE **hInstonce**, LPCTSTA IpTemplateName, HWND hWndParent, OLGPAOC lpDialogFunc, LPARAM dwlniParam);

**试想一下，在 call 一个函数前，汇编代码肯定会这样写：push 0x 地址 ，意思是把 0x 地址的值入栈，这里 0x 地址对应的值就是对话框的实例句柄 hInstonce 的值**。  

这时候使用工具 eXeScope 打开软件的主程序 FluXay2.exe，挨个点击找到标题为 “**流光 II 用户调查表**” 对话框，记下对应的数值 251，这个 10 进制数值就是这个对话框的实例句柄。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtxiabMwdI4W54na8lFxa9gISv5FqGibfdxib9l4rEZzVD8kzfnNFrAc9HQ/640?wx_fmt=png)

10 进制 251 对应的 16 进制数是 0Xfb，打开 OD 重新载入程序，查找所有命令 **push 0xfb** 下断点

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtpzPDcBERfpUuFE5s52M7L8NIeqayCcfKibYQ60IH3JsBjDmBfL8iaYtQ/640?wx_fmt=png)

经过查找发现 push 0xFB 的位置在 00407380，在此下断点，然后在段首 00407360 处也下断点。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtgl1eJP1HQlwvr7coJ5ml2rVNqTE0Xd16OdyqiaKPyZGl6QpiawRJuiczA/640?wx_fmt=png)

右键点击 “**反汇编窗口中跟随**”，**这一步是为了查找到关键 call，也就是查找到哪一个 call 调用了此对话框**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtYv4EtZCQZW43YXQmZCdHTSIdvFFeDKcQduBp3sStExqXMcbXibDUj1g/640?wx_fmt=png)

在返回的地址附近的两个 call 都下上断点。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQt5d036YwibBriboE9ooXJJLUwAruL8reZZXYJNxhbNoeqmibybNqcC88Mw/640?wx_fmt=png)

经过动态调试分析，把 0043BF92 处的代码给 nop 掉，即可去掉该软件的用户调查对话框。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQtCKJd1TQvibdrTKMJB60mEY4ibJPuGERgNlA6NF9eR9qI2uyKmCTZkXCA/640?wx_fmt=png)

软件打开后，不再提示用户调查对话框了。  

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BRygp52gfKdTKwJvWWHQQt1k5SxwdViaDiaR7gv3eUH3qIwVAPnWWESLa0tcN5zahiahOXib0a69QMvg/640?wx_fmt=png)

 **Part3 总结** 

**1.**   当断点附近代码的关键跳、关键 call 都不奏效时，可以尝试从段首开始分析，把关键 call 改掉，这样的逆向修改一劳永逸解除限制。  

**2.**   解除软件限制有各种方法，在不同的软件中，各有优缺点，需要灵活使用。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**