<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/p9MI_XJj-52OcD2RmIJ9Xw)

**0x01 前言**

有时候在对 APP 抓包的时候，经常会遇到参数加密，app 也不像 web 端一样，可以直接打断点进行调试，找到加密方法， 在 app 没有加壳的情况下，我们可以反编译找加密点，或者是动态调试，这里使用反编译的方法。

****0x02 正文****

在登陆处点击登录，然后抓包，具体环境配置教程以及抓包教程可以看前两篇文章，可以看到账号密码被加密了，这时候如果 apk 没有加壳的话，我们可以使用 JADX 进行反编译

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVKKXicFwrjezAqOFF6CZjfjibqecOp73xXicyKw0ae1StOJ3RqkWQt3icD6w/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVKAuB8V5S2KAptgCYpk9MWa7gWky2GF9RbL03QrqQRJpCuULhIheLSZw/640?wx_fmt=png&from=appmsg)

因为抓包的时候，路由是 / user/login，我们反编译 apk 后，直接搜索这个

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVKXIuGNr6WDWh5S7EtsGttWIawd6KERwnmWWRx2gCpYHa2NfuAoEdliaA/640?wx_fmt=png&from=appmsg)

基本可以确定就是从这里发起网络请求  
跟进 addRequestMap 方法分析

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVKiaicNWeJDBr56tlQ7HoRdz7OZxt9asaibPLpG8STym0AAZzOXeJYpKOXg/640?wx_fmt=png&from=appmsg)

这一看逻辑就清晰了  
先添加一个时间戳，在对 sign 进行加密后在调用 encodeDesMap 进行加密  
最后 put 到请求中  
在分析 encodeDesMap

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVKrCrnLM8Xib7nuFTKW5Ov3REeqggpqXlx20YuibsQ71z7icGk7uw9FH4ZQ/640?wx_fmt=png&from=appmsg)

有 KEY 和 IV，不是 AES 就是 DES 加密  
encrypt64

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVK5feibd9GQOhCpcPEnaJmkpfpj9icq8ub0GHBns5MmEbAI4MPknVAhLtQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVKyJnQCVABtSNc9PNt99GHK9w7t6RAAN3PqEMdvaq0YQEjJTUT260YYQ/640?wx_fmt=png&from=appmsg)

DES 加密后在 Base64 加密  
那么 data 就是明文了，hook 这个方法取到参数

*   1
    
*   2
    
*   3
    
*   4
    
*   5
    
*   6
    
*   7
    
*   8
    

```
let RequestUtil = Java.use("com.xxx.xxx.http.RequestUtil");
        RequestUtil["encodeDesMap"].overload('java.lang.String', 'java.lang.String', 'java.lang.String').implementation = function (data, desKey, desIV) {
            console.log("**********获取DES明文**********");
            console.log(`参数明文----> ${data}, desKey= ${desKey}, desIV= ${desIV}`);
            let result = this["encodeDesMap"](data, desKey, desIV);
            console.log(`参数加密结果----> ${result}`);
            return result;
        };


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVKQWVNM7EAZuyesiaefSM03aJMoYklpkroYWn9TQaNkgW4ibxiafqhdaSQQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVK1UVNGKgFVSjsubbvt3LfjelIk3yjMckicicfUJRfibvzB2XEkPVIGQtWg/640?wx_fmt=png&from=appmsg)

与抓包结果一样，这样明文就拿到了。  
sign 分析，回到刚刚那个传递 sign 参数的那个函数

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVKUmat0zDlDONf2omddAKNm28MiagwkMGTvGtlh89fo1NfnUrYaYVBwjA/640?wx_fmt=png&from=appmsg)

字符串最后拼接了一个 key 后在进行 md5 加密，  
hook 一下 md5 这个函数

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVKEII25icwAc0KJOVsDsolfPVISGNAFiaMkxpJmKaUuaENPjMhCSWu0gcw/640?wx_fmt=png&from=appmsg)

很明显，拼接除了 sign 参数其余全部在添加一个 key=sdlkjsdljf0j2fsjk 的最终字符串在进行 md5 加密。  
这样 sign 与参数加密都分析完了。  
再使用 java 模拟加密过程，反写解密就 OK 了。

```
package APP;//import android.util.Base64;  
import java.net.URLEncoder;  
import java.nio.charset.StandardCharsets;  
import java.security.MessageDigest;  
import java.util.*;  
import java.util.stream.Collectors;  
import javax.crypto.Cipher;  
import javax.crypto.SecretKey;  
import javax.crypto.SecretKeyFactory;  
import javax.crypto.spec.DESKeySpec;  
import javax.crypto.spec.IvParameterSpec;  
/* loaded from: classes.dex */  
public class DuDu {  
    Cipher deCipher;  
    Cipher enCipher;  
    public DuDu(String key, String iv) throws Exception {  
        if (key == null) {  
            throw new NullPointerException("Parameter is null!");  
        }  
        InitCipher(key.getBytes(), iv.getBytes());  
    }  
    private void InitCipher(byte[] secKey, byte[] secIv) throws Exception {  
        MessageDigest md = MessageDigest.getInstance("MD5");  
        md.update(secKey);  
        DESKeySpec dsk = new DESKeySpec(md.digest());  
        SecretKeyFactory keyFactory = SecretKeyFactory.getInstance("DES");  
        SecretKey key = keyFactory.generateSecret(dsk);  
        IvParameterSpec iv = new IvParameterSpec(secIv);  
        this.enCipher = Cipher.getInstance("DES/CBC/PKCS5Padding");  
        this.deCipher = Cipher.getInstance("DES/CBC/PKCS5Padding");  
        this.enCipher.init(1, key, iv);  
        this.deCipher.init(2, key, iv);  
    }  
    public String encrypt64(byte[] data) throws Exception {  
        byte[] encryptedBytes = this.enCipher.doFinal(data);  
        return Base64.getEncoder().encodeToString(encryptedBytes);  
    }  
    public byte[] decrypt64(String data) throws Exception {  
        return this.deCipher.doFinal(Base64.getDecoder().decode(data));  
    }  
    public String sign(String data) throws Exception {  
        String append = "sdlkjsdljf0j2fsjk";  
        // 将 JSON 字符串转换为 Map        Map<String, String> paramMap = Arrays.stream(data.replace("{", "").replace("}", "").split(","))  
                .map(pair -> pair.split(":"))  
                .collect(Collectors.toMap(  
                        kv -> kv[0].trim().replace("\"", ""),  
                        kv -> kv[1].trim().replace("\"", "")  
                ));  
        // 对 Map 中的键进行排序  
        List<String> keys = new ArrayList<>(paramMap.keySet());  
        Collections.sort(keys);  
        // 拼接参数字符串  
        String paramStr = keys.stream()  
                .filter(key -> !"sign".equals(key))  
                .map(key -> {  
                    return key + "=" + URLEncoder.encode(paramMap.get(key), StandardCharsets.UTF_8);  
                })  
                .collect(Collectors.joining("&")) + "&key=" + URLEncoder.encode(append, StandardCharsets.UTF_8);  
        System.out.println("sign明文：" + paramStr);  
        // 对拼接后的参数字符串进行 MD5 加密  
        MessageDigest md = MessageDigest.getInstance("MD5");  
        byte[] digest = md.digest(paramStr.getBytes(StandardCharsets.UTF_8));  
        StringBuilder hexString = new StringBuilder();  
        for (byte b : digest) {  
            String hex = Integer.toHexString(0xFF & b);  
            if (hex.length() == 1) {  
                hexString.append('0');  
            }  
            hexString.append(hex);  
        }  
        return hexString.toString().toUpperCase();  
    }  
    public static void main(String[] args) throws Exception {  
        DuDu du = new DuDu("65102933","32028092");  
        String enc = "";  
        String decryptedString = new String(du.decrypt64(enc));  
        System.out.println("明文：" + decryptedString);  
        System.out.println("sign密文:" + du.sign(decryptedString));  
    }  
}

```

Frida hook 脚本

```
function duduhook() {
    Java.perform(function () {
        let RequestUtil = Java.use("com.xxx.xxx.http.RequestUtil");
        RequestUtil["encodeDesMap"].overload('java.lang.String', 'java.lang.String', 'java.lang.String').implementation = function (data, desKey, desIV) {
            console.log("**********获取DES明文**********");
            console.log(`参数明文----> ${data}, desKey= ${desKey}, desIV= ${desIV}`);
            let result = this["encodeDesMap"](data, desKey, desIV);
            console.log(`参数加密结果----> ${result}`);
            return result;
        };
        let Utils = Java.use("com.xxx.xxx.util.Utils");
        Utils["md5"].implementation = function (string) {
            console.log("**********获取SIGN明文**********");
            console.log(`SIGN明文----> ${string}`);
            let result = this["md5"](string);
            console.log(`MD5加密结果----> ${result}`);
            return result;
        };
        let RequestUtil1 = Java.use("com.xxx.xxx.http.RequestUtil");
        RequestUtil1["paraMap"].overload('java.util.Map', 'java.lang.String', 'java.lang.String').implementation = function (addMap, append, sign) {
            console.log(`RequestUtil.paraMap is called: addMap=${addMap}, append=${append}, sign=${sign}`);
            let result = this["paraMap"](addMap, append, sign);
            console.log(`RequestUtil.paraMap result=${result}`);
            return result;
        };
    });
}
setImmediate(duduhook);

```

效果如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSoIyjxQgSibdZGcer1X1UVKzL3HbHsnvNJOJ8dictnVcBsJl3icyQmtXUibnhtf9eLUPzIAODJKgUlyA/640?wx_fmt=png&from=appmsg)

**0x03 文末**

**工具下载**

本文所涉及的工具，均打包网盘，扫描二维码即可下载。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSuc5JmCYJTKJbOvlCZ0FpngD4mUnZpLF0cKAbcXnIibkt4nMcWIy60Zgcrm92lGfPzQEtuQtSc1PA/640?wx_fmt=png&from=appmsg)

**交流群**  

添加机器人好友，回复**进群**，获取进群链接，群内会不定时发各种资源情报。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/OiaZBsiciaGvkSuc5JmCYJTKJbOvlCZ0FpnaqkCRHuP8zDxibF0HT03KdSOXSV4tQLXps69yPgoibIJPJoXIeMKRJGg/640?wx_fmt=jpeg&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/OiaZBsiciaGvkSuc5JmCYJTKJbOvlCZ0Fpnhm4nRdTkTsPoVQQfY0PbSrmNUGwiaBn7ibjImaFW0iaEwicWBibROn9OCYg/640?wx_fmt=png&from=appmsg)