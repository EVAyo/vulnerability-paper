<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/pHva2h1gff1cVKjoNhqnnA) ![](https://mmbiz.qpic.cn/sz_mmbiz_gif/Tp9VOk1IaycpsK4AXvozeaMLYk7OBLQau8mDrsWslNiajkybyodE8HbkJ9ibPO7IofWw3S4sE38LyCWYSxSZMjkQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

**免责声明**

由于传播、利用本公众号听风安全所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号听风安全及作者不为**此**承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！

公众号现在只对常读和星标的公众号才展示大图推送，

建议大家把听风安全设为**星标**，否则可能就看不到啦！

----------------------------------------------------------------------

**本文为白名单授权转发**

近期，火绒安全实验室收到用户反馈称自己下载的 Telegram 汉化文件安装后造成系统异常，火绒安全工程师第一时间为用户提供技术支持，提取样本进行分析。分析过程中发现该程序在对 Telegram 程序进行汉化的同时还 “悄悄” 释放恶意后门文件，执行远控操作，危害极大。目前，火绒安全产品可对上述病毒进行拦截查杀，请广大用户及时更新病毒库以提高防御能力。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkAC62ddZqjBHkRAekLhS3icovl1W8QhXhO76b3ZaT7fBZRM6wTbiaMiaKHFA/640?wx_fmt=png&from=appmsg)

火绒 6.0 查杀图

样本执行流程图如下所示：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACeCiauTyczjK92253NZ6gu4ZpbY60Q5sibJuXrlcOOQwPrCia1HcOfIjmg/640?wx_fmt=png&from=appmsg)

执行流程图

在此，火绒工程师建议大家在下载软件时，尽量选择官方网站或正规可信的应用商店，同时安装可靠的安全软件保护设备免受恶意软件和病毒的侵害。目前，火绒 6.0 已上线公测，在沿袭核心功能的基础上，专注终端安全，精细化查杀，多重技术深入布局，安全防护再次升级；欢迎大家前往火绒官方网站下载体验。

**一、样本分析**
==========

起始汉化安装包是一个捆绑了恶意文件的 exe 程序，附带 vmp 壳干扰分析：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACiceMD41Lqd7mgzc54shI677g8Z6pFX9TWRGPZfaHtVyglI1fF5eqrYg/640?wx_fmt=png&from=appmsg)

vmp 加壳

双击运行程序时，其会先执行正常的 telegram 汉化操作，链接到正常 telegram 程序并改变界面语言：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACIC9blldJBqCEsrzfRTvpUq2AVQHlflvt3mpmxKicNzg9pKysrcKutCQ/640?wx_fmt=png&from=appmsg)

链接到 telegram

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACYicib81LTIibJgc39LiaOHf6gIKjEcJhQYDb5J1rODyTyblToMJOjAwcMg/640?wx_fmt=png&from=appmsg)

汉化

但在执行正常操作的同时，会在内存中解密出第一阶段 payload ，其为一个恶意 dll，用于在内存中加载执行：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACxntM2Qocrhk40nq2ewvm8KVjmCIfjyicANuErTYGD6YmWHKvqSPibfUw/640?wx_fmt=png&from=appmsg)

内存解密 dll

**Payload1：加载通用. dll**
----------------------

从内存中 dump 出 dll 进行分析，其名称为 "加载通用. dll"。有一个 Hello 的导出函数，但不执行任何操作，所有操作都在 DllMain 中进行：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACNp9icKsSo0PshRqMXWmCtEuDM6ISbLC7BaVA1gpSXKZ8XwLUJVq8GFA/640?wx_fmt=png&from=appmsg)

dll 概览

该 dll 以易语言编写并由黑月编译器编译，特征字符串如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACxdnp5WA2dtZChvj0E9etdMXoialj67IKatECpbNOH2kJwKZpEN7U2Dg/640?wx_fmt=png&from=appmsg)

黑月编译器特征字符串

在执行过程中会先进行一些检测操作，通过判断 SxIn.dll 是否存在来检测 360 的虚拟沙盒。检查 SystemTray_Main 的窗口属性是为了避免重复操作，因为在后面的操作中会有将该窗口属性设置为隐藏的代码：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkAC2sxXUibZD2OC1QqOx1wBmlaQXKf8zjh1f5Ol5Ziba4nm9Wy47wWnTaYA/640?wx_fmt=png&from=appmsg)

检测代码

随后开始初始 URL 部分，计算文件自身 MD5 并获取前 16 字节部分作为 URL 路径进行拼接，并生成 FPTOKEN 用于后续 http 通讯：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACq3J9ZgybeiaXO9u9oREibb9wJYIzmFNuKyDcepFONYiboicolkAaxO6ZiaQ/640?wx_fmt=png&from=appmsg)

拼接 URL

通信相关的函数是通过 WinHTTP 的 COM 对象接口来调的，数据传输时使用的域名是 taobc.tv ，利用前面生成的 URL 路径及 FPTOKEN 以验证请求的有效性：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACjlHbkuFJ9vl7GIKicJGWugGuB9UZkOVBoVgIwA5XMYic6CDicmr2pyGOw/640?wx_fmt=png&from=appmsg)

外联操作

接收到的数据为加密数据，如下图所示：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACfQnsV4JIOW1rpjibGmDy1v2ZH4icp8c60QafnhUkt2YO7sEQmsLMTib4Q/640?wx_fmt=png&from=appmsg)

通信流量截图

在接收到回传的通信数据后，dll 会获取多个系统特定位置路径，作为后续投放第二阶段 Payload 使用：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACphJM0EIt0VePpZujZMEOqVGkiaf4vMU2pD64FniaQMulicfsCpdJE1HyA/640?wx_fmt=png&from=appmsg)

获取系统关键路径

随后通过 ResponseBody 字段来提取加密部分数据，并解密出新的 PE 文件：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkAC97xTnYmaMlW273fOcvTt6h7mRbuTibCK32wxrsR7OmfdxMWiafC4hayQ/640?wx_fmt=png&from=appmsg)

调用解密函数

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACrDQpNMdufjOV98b1mcmq9ltM3icPmhjIJf4JQ5DYwjfSbUBHhBNdvuw/640?wx_fmt=png&from=appmsg)

解密数据截图

第二阶段 payload 下发的路径选在 Videos 目录，dll 会创建 VSTELEM 文件夹，并继续创建随机文件夹用以投放第二阶段载荷：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACjM5X2NibX4iaxbTrHsFqKING5JoCiavUvqayeydugkxCW9UF9OwJFg70Q/640?wx_fmt=png&from=appmsg)

payload 投放位置

通过在循环中读取并定位解密数据中的 PE 文件，陆续投放 rzrue.exe（随机文件名，与文件夹同名）、Language.dll、update.dll 到前面指定的目录中：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACEibJA6V7HNaEzEDfhA0701IxwZbYPySYMPZjWZpicTzAIjqqNzYgSz0w/640?wx_fmt=png&from=appmsg)

释放文件代码

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACEAu3X9YrT56CicmTBLzTZoobtaMb10TRns1JebPhbFYd4zSDiax5uBLA/640?wx_fmt=png&from=appmsg)

文件展示图

其中，如果检测到文件不存在的话，就会连接第二个 C2 进行告知：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACKz89FjJ5SMeHO24ticUDVm4PFIC4Yic71Y1iaVicKmS05Wibh4FwWtnr6vw/640?wx_fmt=png&from=appmsg)

发送数据

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACacnaS44E910SibcKzp94GqoY5EickKz3RuPicFwG1icwTITwVUvMbWpzOw/640?wx_fmt=png&from=appmsg)

通信截图

完成前面的文件投放后，dll 还会接着以 SYSTEM_START.lnk 快捷键的方式投放到开机启动目录中实现持久化：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACnib9CjSutaLqf4BEB6rvRNzuIibibLkgBNaKYjDI3rxAmzMQgftFW9Pug/640?wx_fmt=png&from=appmsg)

释放 SYSTEM_START.lnk 文件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACZgiabsd6YsUhpD7QASLKHfPspFLKWqe4KevPFdFlWNTg2sCGmTLQvTQ/640?wx_fmt=png&from=appmsg)

相关文件属性

随后创建进程，执行下落的 rzrue.exe 文件并等待线程执行，如果进程执行正常，就会更改前面提到的 SystemTray_Main 窗口属性，用以避免重复操作：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACgRB9bzGKjKY3sLlJMmTnFc82H4J2k2Hfq3RNkicbxGicXAnSh88aSmjA/640?wx_fmt=png&from=appmsg)

创建进程并设置窗口属性

如果 WaitForSingleObject 返回 WAIT_TIMEOUT 超时，同样会连接新的 C2 进行告知：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkAC8iaBM0KU6S4ZNJnYxQwUo09BIbcqQuMSuoY3lHg3cXkCexG6HGsla5w/640?wx_fmt=png&from=appmsg)

通信截图

**payload2**
------------

释放的文件中 rzrue.exe 是白文件，用于加载同目录下的 Language.dll 并调用其中导出函数 LangDLLMain 和 SetRegPath，但实际上并没有 SetRegPath 导出函数，关键操作都在 DllMain 中：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACwCRmLYFGIQB4P0ibYTxv22qiaK05QZ9PIfPABeDW6f4aXibBZrcqUIOJg/640?wx_fmt=png&from=appmsg)

加载 Language.dll

被加载的 Language.dll 同样由 vmp 加密来干扰分析：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACbfKOuSToib5SMezLzUrMyHONzQzBdmVqfeUh5Aatic2gQcdevF0rjo4Q/640?wx_fmt=png&from=appmsg)

vmp 加壳

Language.dll 被加载后会读取同目录下的 Update.log，Update.log 是一个加密的字节码文件，其最终会被解密成 dll 并在内存中加载执行：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACkS7XXqSrwib1u0kDxWcknQTt8iaGkIWNLYusNw0mbFwAZNCJoa1aEFGQ/640?wx_fmt=png&from=appmsg)

读取 Update.log 并解密

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACGwticvlSpg6MsPIyntiaxiaEIichrhDcNXIvHzuxWiaPMxUpPWUScYHrogA/640?wx_fmt=png&from=appmsg)

Update.log 字节码展示

### **XTFG110.dll**

由 Update.log 解密出来的 dll 名为 XTFG110.dll，只有一个导出函数 "Fuck"。其中 DllMain 函数主要负责初始化操作，Fuck 导出函数主要负责通信操作：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACTH4YkkzDhO9k6deZDe0qlO6Vd5fS8EbSicSiaLDpFicjfFaT2ESEghICA/640?wx_fmt=png&from=appmsg)

DLL 相关信息

XTFG110.dll 同样是易语言编写：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACa61iaW0TsDVmzPeXia4bzukH9gLibcEBujZBht6xWm4knAqx0aoaBibGsg/640?wx_fmt=png&from=appmsg)

易语言程序入口点

在 DllMain 中，先初始化要连接的 C2 及端口等数据：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACPTJ4gy5ria0YR2wNCWDrdP2KR2ac4ibicp9HAI4hpC5HAqnsQhRo9yHdg/640?wx_fmt=png&from=appmsg)

初始化 C2

随后在 C:\ProgramData 目录下创建 Lexicon 目录，并在其中创建相关文件夹，猜测是用于后续控制过程中的配置写入以及起到标识操作已完成的作用：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACqV3buZkuSLpdibyAqY6ZEF3Clc2HbgMiaaY7emFTXAVgtFvGNOLEoAeg/640?wx_fmt=png&from=appmsg)

相关文件创建

将执行目录设置为当前路径，方便后续操作：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACiaSRbl4YVWSePthI9ux0ns5wv0PW2IOl0BdMNFxmdCicLZsEtCqyibQibw/640?wx_fmt=png&from=appmsg)

设置当前路径

接着该 dll 会根据预设的标志执行指定的操作，这些操作包括休眠，文件创建，进程注入等：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACOBHZgUtSg0pciayD9nSp6t61qHW80A8p4oGzXv6mh2cEaG0VFibicckrQ/640?wx_fmt=png&from=appmsg)

可选操作

其中进程注入操作依旧是将 Update.log 解密后（该 dll 自身）写入到其它进程内存中继续执行：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACIZwNMokj16qchT72EeJRBjouOldnFav5m3Wy6aumLoGf6ibUS2NkYcQ/640?wx_fmt=png&from=appmsg)

进程注入

最后挂钩键盘事件，监听键盘记录：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACkj8y6xjkzicAompNCRxzGiaxywicbnydd1tcibowsGkWB9OqEY70x7YPUg/640?wx_fmt=png&from=appmsg)

监听键盘事件

#### _导出函数执行_

导数函数 Fuck 是指定执行的，在前面 DllMain 初始化的文件和域名基础上，主要执行通信部分的操作，获取系统信息进行传输并接收 C2 的下一步指令：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkAC7kke2pwYeK3367icASib5gZY3ibENHB00koJZibd3uxjCaQIeHbEcC7ctQ/640?wx_fmt=png&from=appmsg)

函数代码展示

**系统信息收集：**

在接收数据前，该函数会先收集系统信息进行传输，包括设备名称，频率等：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACRHgicCqiaAlJYBqGAibbhvRu69NlJx0QTMmtrvP0mhKUH3BzE54IRIjibw/640?wx_fmt=png&from=appmsg)

获取设备信息

并且函数还会检查上一阶段文件存在情况，做好记录：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACOVfnQu0sQbqyDUcyMgG97VO36lfl2pnZicyrfU67eMJn1N5mFjGlGhQ/640?wx_fmt=png&from=appmsg)

查看文件

最后函数会收集系统相关注册表及计划任务的存在情况：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkAC2yiakR88diaIu7DNw66PpHPkTt268aINT5wclFHpsB2ZmJ2DaHgJWmeA/640?wx_fmt=png&from=appmsg)

收集相关信息

对于收集到的信息，进行整理后会以加密的形式进行发送：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACr14TwiaJod1c8matgy02vibSx6PhMI84rdmBaMedHRPCo2ONAwB8aiadg/640?wx_fmt=png&from=appmsg)

数据加密

传输数据如下图所示：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkAC3Fv5VsxxRh4cotGEDwHzRMVmU6bmH8PRasOzS69wNmMVpbfPsriaFiaQ/640?wx_fmt=png&from=appmsg)

流量截图

**数据接收：**

SH 在前面将收集到的系统数据发送后，函数进入新的循环中开始接受 C2 数据。接收数据具体实现如下：第一次获取数据时，其会先定位回传数据的第 7 个字节（从 0 开始算），以此作为新缓冲区的长度进行第二次数据获取：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACJfc3saMU7NX0JDbVuQS0Kh4fmce9mSWLDMDiayibE1ugv9HRsibWbnO1g/640?wx_fmt=png&from=appmsg)

循环监听

对于接收的所有数据同样需要解密后才能进行操作，解密逻辑同前面加密一样：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACShQiatll3icjDwMb8ibte9xYJ4MRTrfHNiaibolLeN54FdX4SaZHBtrjMrQ/640?wx_fmt=png&from=appmsg)

解密函数

然后进入数据处理函数中，其中第二次获取数据的第一字节会作为判断值来决定分发情况。根据不同的值，跳转到不同的执行分支中，其中包括系统信息获取、进程注入、下发插件等等，以此实现对受害者主机的完全控制，这里不再一一分析：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACYEW20LdibibrP0JSf6rYUjexgT27tEl2XKQ3naHKHemxO8GYutXOQOZQ/640?wx_fmt=png&from=appmsg)

可选择的执行分支

**二、附录**
========

**C&C：**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACEEVSEgZiaQEQaPaWbMvlIibpk1TUWsU6Kd64ubjErPb8JDelEZo1CQIA/640?wx_fmt=png&from=appmsg)

**HASH：**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/0icdicRft8tz4b8YiaExs0JaANZvC9EzkACmciaGfbamUF6XHK2LXrCjly8uJiagv6Cy6ibVZe58YCfy4GXr6MtYCcfg/640?wx_fmt=png&from=appmsg)

不可错过的往期推荐哦  

```
这年头，木马也会用连环计

一次通过信息搜集打点

RCE 遇到受限 shell 的突破

挖矿病毒持续活跃，通过 ssh "强行" 登录

实战攻防-不一样的shiro

聊一聊红队打点那些事

记一次不经意间的Getshell

记一次通杀的0day审计之路

网络空间指纹：新型网络犯罪研判的关键路径

```

点击下方名片，关注我们

  

觉得内容不错，就点下 “**赞**” 和 “**在看**”

  

如果不想错过新的内容推送可以设为**星标**![](https://mmbiz.qpic.cn/mmbiz_png/Yv6ic9zgr5hTYyCkc91euAiaGULJSbiaHricFHs2dd2sib20WTJKwHYD90Jia9HCKxnmJUwnkicGU7rVP3EYCVh3dMnng/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)