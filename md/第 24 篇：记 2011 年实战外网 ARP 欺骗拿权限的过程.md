<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/eUQqHNYTOYy-MFnB6oGY-Q)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcaA8wBFW4icTiaL7ELd8ia04Olh40TBx7CquHZyCicicl4eYJno2y0oZ0H4A/640?wx_fmt=png)

 **Part1 前言** 

这是我在读研时期的一次真实的在外网进行 ARP 欺骗嗅探的实战案例，费时一周，一晃已经 11 年前了。技术难度不大，但是实战操作的技巧性大。笔者在实战过程中踩了一大堆的坑，**如果对 ARP 欺骗的原理不清楚，一个错误操作都会造成目标网站的瘫痪，没有十足把握不要在生产环境中尝试！**毕竟 ARP 欺骗嗅探在实战环境中和在虚拟机环境测试中是不一样的，会遇到各种各样想不到的问题。现在的 ARP 欺骗嗅探在外网环境基本上是极少遇到了，在内网环境中还会发挥作用。

**这里要注意的是，在几乎所有的红队评估、攻防比赛项目中，ARP 欺骗都是禁止使用的**，但是把这个案例分享给大家的，让大家能够明白，渗透测试实战与在虚拟机环境下做实验，是完全不一样的。

 **Part2 技术研究过程** 

*   **Cain 工具介绍**
    

Cain 工具的全名是 cain & abel，是一款 “老牌” 渗透工具，曾被评为“全球 100 款最佳安全工具”。它可以通过网络嗅探很容易的恢复多种口令，同时**也是一款实施 ARP 欺骗攻击比较稳定的工具**，也可以使用字典破解加密的口令，暴力口令破解，录音 VOIP（IP 电话）谈话内容，解码编码化的口令，获取无线网络密钥，恢复缓存的口令，分析路由协议等。（以下图片来源于网络）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BGmjTamyDGRtJLuDwwtCvXiawUc9WfTffq7dCjKMIL5GSKpqCIRexNiadO9Yvfc5zl3wE2IbhgZAug/640?wx_fmt=png)

*   **对目标进行漏洞挖掘**
    

目标网站是一个 discuz 论坛（假设 IP 地址是 211.99.99.111），首先对这个 IP 进行了各种层面的漏洞挖掘，具体如下：

**1、**寻找 discuz 已公开的各种漏洞；

**2、**扫描目录，扫描备份文件，发现可利用的只有一个 admin.php 后台；

**3、**爆破 discuz 论坛后台的账号密码；

**4、**只有一个 80 的 web 端口和服务器的 3389 端口，基本上无从下手。

**5、**对 IP 地址进行全端口扫描，发现只有 80、3389 端口开放。最终发现，没有可利用的漏洞。

**6、**记得当时还试过了同 IP 旁注，可惜此 IP 只绑定了 2 个域名，均没有什么可以突破的 web 漏洞。

此时按照 10 几年前那个年代的搞站思路，这时候通常会在 C 段（假设是 211.99.99.1/24）内拿到一台服务器权限，**在此服务器上安装工具实施 ARP 欺骗**，使 IP:211.99.99.111 的流量经过这台服务器，从而嗅探到管理员或者普通用户的账号密码，然后做进一步深入。

*   **ARP 欺骗过程**
    

如下图所示：在 211.99.99.81 这台服务器上进行 ARP 双向欺骗之后，用户访问 discuz 论坛的数据包流向先经过 211.99.99.1/24 的网关 211.99.99.1 服务器，然后再经过攻击者获取的服务器权限 211.99.99.81，然后数据包才到达 211.99.99.111 的 discuz 论坛。这样攻击者就可以在 211.99.99.81 这台服务器上，嗅探到目标 discuz 论坛的账号密码了（**具体的 ARP 欺骗过程可以查一下网上的资料，下面这张图没有体现 MAC 地址，不要被我画的图误导了**）。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BGmjTamyDGRtJLuDwwtCvXlVrVCiaKYsf0ic5iabYgqfQvf16p9sqLXtoJnpXGTyIKVxUwapv5NQMsQ/640?wx_fmt=png)

*   **IIS PUT 漏洞获取权限，但无法实施 ARP 攻击**
    

接下来对 C 段（211.99.99.1/24）进行批量的漏洞扫描，很快通过 IIS PUT 写权限漏洞获取一个 Webshell，紧接着获取 IP:211.99.99.20 这台服务器权限。在 10 年前 IIS PUT 这个漏洞在外网是广泛存在的，记得当时用的是桂林老兵的工具，现在的内网渗透中，有时候还能用到这个工具。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BGmjTamyDGRtJLuDwwtCvXKIwuYOib08QIIqJ9G0wptFSbgLploabWnMgaCYticr6y4qDr0tWbXdJA/640?wx_fmt=png)

接下来就是在服务器上安装一个 cain 工具了，但是 cain 附带需要安装一个 WinPcap 驱动程序，在虚拟机里测试的话，可以随便安装。但是在真实环境中安装这个驱动怕出问题，影响服务器的网络。为了保险起见，**当时从网上下载了一个绿色版的 cain**，双击即可使用。

设置好 cain 之后，开始实施 ARP 欺骗攻击。结果发现，刚过几秒钟，cain 的丢包率就接近 100% 了。吓得我赶紧把 cain 给停止掉，因为丢包率一旦达到 100%，服务器就挂了。丢包率为什么这么高呢？

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BGmjTamyDGRtJLuDwwtCvXWQ93bfPg8GS9lYJRcibdBDtQW72O2XSwqTc2pPY0Ebn0XtnQasdrHicw/640?wx_fmt=png)

简单分析一下，目标 discuz 论坛是一个有几万用户的流量很高的论坛，而这个 IIS 服务器是一个注册用户 10 几个人的小站。这也就引出了一个问题，也许这台 IIS 服务器的性能不行，承受不住并且处理不了来自 discuz 论坛的这么大的访问流量，导致 IIS 这台服务器上的 cain 丢包严重。

接下来怎么解决这个问题呢？后来经过一系列搜索，询问朋友，也试过各种方法，**发现这个问题几乎是无解的**，最终只能放弃这台机器，搞一个性能好的服务器权限去实施 ARP 欺骗攻击。

*   **Dvbbs 动网漏洞拿下权限**
    

接下来对 C 段（211.99.99.1/24）在此进行批量的漏洞扫描，很快找到了一个 dvbbs 动网论坛（假设 IP:211.99.99.81），这个 IP 看起来性能不错。通过上传漏洞，很快拿到了一个 webshell，通过提权获取了 3389 服务器权限。10 几年前 dvbbs 动网论坛还是比较流行的，那时候的动网论坛大致像这样子：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BGmjTamyDGRtJLuDwwtCvXdSnoSjELUBJUGRSrSuxV8GR5WmTmuyibZQtichakGrmP1AIzO5nWXQwA/640?wx_fmt=png)

最终使用这台服务器实施 ARP 欺骗攻击，效果发现还是可以的，至少不会立即丢包。这时候又发现一个问题，使用 cain 进行 ARP 欺骗之后，**大约每过 5 分钟，丢包率就会逐步的递增，由 10% 逐步递增至 100%**，接下来无论我怎么去调整 cain 的各种参数配置，始终无法解决这问题。哎，真是太难了。由此朋友们也可以发现了，实战 ARP 欺骗与虚拟机环境是完全不一样的，虚拟机下无论怎么测试，都不会有丢包现象。所以大家要多多实战操作，积累经验！

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BGmjTamyDGRtJLuDwwtCvXWQ93bfPg8GS9lYJRcibdBDtQW72O2XSwqTc2pPY0Ebn0XtnQasdrHicw/640?wx_fmt=png)

*   **土方法解决丢包问题**
    

但是慢慢地我发现，cain 至少在 5 分钟内不会丢包，丢包率太高的话，只要重启一下 cain，重新实施 ARP 欺骗即可。这样我就想到了一个简单的方法去解决这个问题。用易语言写了一个小程序，**每隔 5 分钟就关闭一下 cain（把 cain 的进程关掉即可）**，接着停留 100s，然后重启 cain，这样周而复始，循环执行。以下是当时用易语言写的一个小工具，换到现在，我一定会改成命令行的，不要图形界面。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BGmjTamyDGRtJLuDwwtCvX1tC2sRqJia7hqgsWXozZTQE3YLIgILOMSicKMLIyxxriciar2UEiaXr1H7A/640?wx_fmt=png)

在实施 ARP 欺骗过程中，基本上没敢离开电脑，就怕目标网站崩溃掉。期间一直查看目标 discuz 论坛，看丢包率达到多少了，以备出现意外状况，手工结束掉 cain，最终经过漫长的断断续续的 2 天等待，高权限的账号密码还是被嗅探到了。

*   **绕过 ARP 防火墙方法**
    

到后期，各种 ARP 防火墙的出现，导致 cain 基本上就不能用了。但是安全专家们，很快找到了各种绕过 ARP 防火墙的方法，而且写了各种绕过 ARP 防火墙的工具：

**NetFuke 与 Arp EMP 这两个工具可以进行单向 ARP 欺骗**，由于单向 ARP 欺骗流量没有经过 ARP 防火墙，所以可以绕过早期的 ARP 防火墙。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BGmjTamyDGRtJLuDwwtCvXMgbDH8iaB9LuEcJyfw7n4Aby8Qde2WgaUkLPd39sa4taGUZkrOnYF4g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BGmjTamyDGRtJLuDwwtCvXTMxI5xaNmbAV6d7zoqOtb7cUlzNdcbUx9QBlY0YhT8Uyo4fYqp4O2g/640?wx_fmt=png)

以下这个工具可以也绕过 ARP 防火墙，由于部分 ARP 防火墙就是不停地向网关发 ARP 包刷新 arp 表，**但是这个工具发包的速度比 arp 防火墙的速度快**，造成 ARP 欺骗可以继续。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BGmjTamyDGRtJLuDwwtCvXE1hx1TQUx9R0yQa0vbHfzibdfkClfx0nZuAfCYORA7V37l7uB6iavLTw/640?wx_fmt=png)

到后期静态地址绑定，基本上彻底修复了 ARP 欺骗这个漏洞，ARP 欺骗攻击这个曾经常用的攻击手段至少在外网环境中就极少遇到了，在内网还可以遇到。

 **Part3 总结** 

**1.**  实战的渗透测试与虚拟机环境是完全不一样的，一定要多动手实操。对于 ARP 欺骗更是如此，实战中总是会遇到各种各样虚拟机里无法遇到的情况。

**2.**  在此强调，如果对 ARP 欺骗不是有十分的把握，不要在实战中使用，一个误操作，可能造成整个局域网瘫痪。

**3.**  网上有各种各样的 ARP 欺骗工具，好用的却不多，这里不过多评论。

**4.**  不同版本的 cain 等 ARP 嗅探工具，一定要装好对应版本的 winpcap 程序。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队、蓝队、日常渗透测试、安全体系建设等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)

**往期精彩回顾**

[第 23 篇：XSS 绕过防护盲打某 SRC 官网后台](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484434&idx=1&sn=3d4d9da4b098e41b9aec7687822d2f6e&chksm=c25fcb69f528427f7f73aa9cdcaf7a333608bd99cf4cc0e9682ef02b7596767ca8b18de7c155&scene=21#wechat_redirect)  

[第 22 篇：一次艰难的 PostgreSQL 不出网提权过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484407&idx=1&sn=3cedc709c508c5994a141dc395c46090&chksm=c25fcc8cf528459ab1f11e8ab08723811bf9a1c8f4f223678efbd4ff35cccb78b11dd990296d&scene=21#wechat_redirect)

[第 21 篇：判断 Weblogic 详细版本号的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484386&idx=1&sn=9104bd3fad09c607c0ce4b02e483957d&chksm=c25fcc99f528458f8f29d93f9fb7c961255bb64351061e0d6b0eb0c3fc08f2b660e53d45459d&scene=21#wechat_redirect)  

[第 20 篇：改造冰蝎客户端适配 JNDIExploit 的内存马](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484370&idx=1&sn=41144e2b24cf223753b1f631b7a7269b&chksm=c25fcca9f52845bfec4aceb55bbc2e35b95605873193a0a499b9505957039619598ae458b045&scene=21#wechat_redirect)

[第 19 篇：关于近期 cs 服务端被反打的原因分析](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484349&idx=1&sn=c23223a0348336daae18acc4a4790bb8&chksm=c25fccc6f52845d03b30faae72d252256434197d1267d713e60b85810f734368f0be61e62a06&scene=21#wechat_redirect)

[第 18 篇：fastjson 反序列化漏洞区分版本号的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484332&idx=1&sn=c787dd0985156d856aad03d56a945be4&chksm=c25fccd7f52845c1e172b864dfc219dcecc9f226fb5abc64ef31178914ad9f58b7868bf6917a&scene=21#wechat_redirect)

[第 17 篇：Shiro 反序列化在 Weblogic 下无利用链的拿权限方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484319&idx=1&sn=9da36674830837aa9bcacb3fb6268fd1&chksm=c25fcce4f52845f2ac3cebaf17fd3839fdba74f536ad3da20d1b1126d8ba0e1835853990516c&scene=21#wechat_redirect)

[第 16 篇：Weblogic 2019-2729 反序列化漏洞绕防护拿权限的实战过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484303&idx=1&sn=58cbb4d7f63b9276bb89eeac286d174c&chksm=c25fccf4f52845e241256c2f425003b73b6061b3d1964dcd4a184a2cda1b4d8761098227e6de&scene=21#wechat_redirect)

[第 15 篇：内网横向中 windows 各端口远程登录哈希传递的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484255&idx=1&sn=e233aa07fdf9de0c8a1bf56fb0954766&chksm=c25fcc24f5284532c5aa27c002d15aa6380c456e2a84299c77b8d43a41892517087258bf867d&scene=21#wechat_redirect)

[第 14 篇：Struts2 框架下 Log4j2 漏洞检测方法分析与总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484207&idx=1&sn=285b54a79e48db9a05816cab2e6afc27&chksm=c25fcc54f5284542c1b9abe870e0caa9f958f4da90723bd83292deed215c63c705b7b0bbfaff&scene=21#wechat_redirect)  

[第 13 篇：coldfusion 反序列化过 waf 改 exp 拿靶标的艰难过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484191&idx=1&sn=cce12f62b3cf457bc73753b77a083695&chksm=c25fcc64f528457250b11ef6804ee6138c37ed87ab988874cc84d09d04fa6ac1fd36b5e8aa4a&scene=21#wechat_redirect)  

[第 12 篇：给任意 java 程序挂 Socks5 代理方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484173&idx=1&sn=e2d454d2447d119bf771a0a511fba994&chksm=c25fcc76f5284560d00355590da0147aca7b7ae2275c095424034245ef32b3d0b28e49c2dbc9&scene=21#wechat_redirect)  

[第 11 篇：盲猜包体对上传漏洞的艰难利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484162&idx=1&sn=870596fcd1120a6d3ee9688c38aace00&chksm=c25fcc79f528456f9dc0a3b9d9cf54422696a1cd6ffd737ae2c6e33941a25c33d4f6d32fc663&scene=21#wechat_redirect)  

[第 10 篇：IIS 短文件名猜解在拿权限中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484145&idx=1&sn=7635430b9b759a2cacdd2c57ba330833&chksm=c25fcd8af528449c1f5c6c703e3668cf6a8dae875ee82ffa67caed66722a0751e3d80d8a6bee&scene=21#wechat_redirect)  

[第 9 篇：Shiro 反序列化数据包解密及蓝队分析工具，提供下载](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484123&idx=1&sn=cb9c039ef92311e56e7742c7c38f6e8a&chksm=c25fcda0f52844b6088b39b769a63b2f6e7a29e8b3ab710961918218d7569089ee4e00072ad9&scene=21#wechat_redirect)  

[第 8 篇：Oracle 注入漏洞绕 waf 的新语句](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484115&idx=1&sn=10c73343ec23f522696692293cd38852&chksm=c25fcda8f52844be2165aa6151c7ad018a4add748673d56523631529e903277633dc44d0abba&scene=21#wechat_redirect)  

[第 7 篇：MS12-020 蓝屏漏洞在实战中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484105&idx=1&sn=3aeafa9c172588aaaade47ccacb69370&chksm=c25fcdb2f52844a4a783fceec590c9e12eb06f62dabd7fbffb37e8da23053953a7eae296048d&scene=21#wechat_redirect)  

[第 6 篇：Weblogic 反序列化攻击不依赖日志溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484094&idx=1&sn=527236759dc4fd228461195197492507&chksm=c25fcdc5f52844d36bffb96979116d6d3a9ae4fb1a0f320436c7275aea271588c702cea60e5c&scene=21#wechat_redirect)  

[第 5 篇：Shiro Padding Oracle 无 key 的艰难实战利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484091&idx=1&sn=4dcce59a842f17035d0018bf650671ae&chksm=c25fcdc0f52844d608b6b87d85082b74d5e15888e76001127ff40cc407a46e5e5de446b1365e&scene=21#wechat_redirect)  

[第 4 篇：jsp 型 webshell 被删情况下如何溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484004&idx=1&sn=50013b50e48542d156700d76ccbd2f33&chksm=c25fcd1ff528440906bb9089a807c16b747ab5a72cc0279a3c0d18a265cd76cc796df570d594&scene=21#wechat_redirect)  

[第 3 篇：银行 Java 站 SSRF"组合洞" 打法造成的严重危害](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483984&idx=1&sn=1a018fcefe10124c1726e51a2be05ca7&chksm=c25fcd2bf528443d944a8495ca5c72d8c028fef67de217efe47a8d18b077ae24556842687407&scene=21#wechat_redirect)  

[第 2 篇：区分 Spring 与 Struts2 框架的几种新方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483951&idx=1&sn=fbc1d04ef73a449238a5979a439b1f35&chksm=c25fcd54f528444219f20c2ab14c5970c243fbb10ba04b5bccc0fb0b7cc6d3f542e26f7870bf&scene=21#wechat_redirect)  

[第 1 篇：weblogic9.x 在 JDK1.5 下 T3 反序列化漏洞利用方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483867&idx=1&sn=e0fcaa9f1b58c8085ccd9dc6f74ed336&chksm=c25fcea0f52847b6aeec0409e3290e023b890d603361f103315b39637f89a10dd6fe051dc724&scene=21#wechat_redirect)