<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/C9nxc-Q-Y2AFK6xifgeYaQ)

![](https://mmbiz.qpic.cn/mmbiz_gif/3xxicXNlTXLicwgPqvK8QgwnCr09iaSllrsXJLMkThiaHibEntZKkJiaicEd4ibWQxyn3gtAWbyGqtHVb0qqsHFC9jW3oQ/640?wx_fmt=gif)

**项目简介**

@veo 师傅研究的一个全链路内存马系列（ebpf 内核马、nginx 内存马、WebSocket 内存马）。

本项目不含有完整的利用工具，仅提供无害化测试程序、防御加固方案，以及研究思路讨论。  

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/79gZQNibQ6uc1rbIvZib7DMp3wPtL3Qojibm53Wu2KMGpSsxS9AlWRkSTzyYn8qHAzybOykaaAwjY6ex1sa7O8Jpw/640?wx_fmt=jpeg&from=appmsg&wxfrom=13)

**技术原理**

**ebpf 内核马：**通过 ebpf hook 入 / 出口流量，筛选出特定的恶意命令，再通过 hook execve 等函数，将其他进程正常执行的命令替换为恶意命令，达到 WebShell 的效果。

**技术特点**

```
无进程、无端口、无文件（注入后文件可删除）
执行命令不会新建shell进程，无法通过常规行为检测
将WebShell注入内核，无法通过常规内存检测
可改造内核马，适配HTTP协议以外的所有协议

```

**技术缺点**

```
内核版本需要大于4.15.0，即 Ubuntu 16、CentOS 8
命令不是直接执行，需要等待其他进程执行命令
无回显

```

**使用方式**

下载测试程序 releases 并运行  

```
POST veo=/bin/touch /tmp/pwn

```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/79gZQNibQ6uc1rbIvZib7DMp3wPtL3QojibIBEvfBVZ1zBE7qKz2b6sInlxhc7usorXyftC0UZp4TPicvf4YK92AicQ/640?wx_fmt=jpeg&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/79gZQNibQ6uc1rbIvZib7DMp3wPtL3QojibV8rnZIFOc6ceoh9a1miaxtMicibkjxtDb7hic2ey8Dg6ic20COxwicqSWbug/640?wx_fmt=jpeg&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)

**研究中遇到的问题**

#### **1. 为什么不通过 ebpf 直接执行命令**

根据 ebpf 的编写规则，ebpf 自己是不能执行命令的，它只能 hook 各种函数。所以有两种方法可以间接达到执行命令的效果  

```
自己开一个进程，ebpf通过ebpf map传输命令参数到这个进程，通过这个进程执行命令
监听其他进程执行的命令，将其修改为恶意命令参数

```

#### **2. 怎么通过 ebpf 识别 HTTP 报文**

XDP 是读不到报文内容的，所以最底层用 TC 格式化 HTTP 报文就可以，你需要算 IP header、TCP header 的长度等定位包体内容。另外 ebpf 有循环次数限制，所以最好 payload 是放在包体的开头或结尾

#### **3. 怎么让 ebpf 脱离加载器在内核中持续运行，即使加载器程序退出**

详细了解 eBPF 程序的生命周期，可参考 

```
https://eunomia.dev/zh/tutorials/28-detach/

```

**防御加固方案**

```
通过bpftool可以检测出是否有ebpf恶意程序
权限收敛，收敛SYS_ADMIN、CAP_BPF等权限
确认 /proc/sys/kernel/unprivileged_bpf_disabled 为 1

```

下载地址

https://github.com/veo/ebpf_shell

> **文章来源：潇湘信安**

黑白之道发布、转载的文章中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途及盈利等目的，否则后果自行承担！

如侵权请私聊我们删文  

**END**