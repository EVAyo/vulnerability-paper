<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/s_W37IM7jmnOSdArE-OW1Q)

Part1 前言
========

在日常的蓝队溯源工作、感染加密勒索病毒后的应急排查工作中，查找攻击者遗留的 webshell 是一种常规手段，一旦 webshell 文件被找到后，可以反推出很多信息，最重要的是能确定攻击者攻击时间，以此攻击时间为轴心开展溯源工作会事半功倍。但攻击者经常会把 webshell 文件删除，并且清理掉所有的访问日志，这种情况下应该怎么溯源确定上传 webshell 的攻击时间呢？其实对于 jsp 型或 jspx 型 webshell 来说，还是有办法的，因为 java 的 webshell 在编译过程中会生成很多临时文件，一直留存在服务器中。

Part2 技术研究过程
============

首先本地搭建一个 tomcat，模拟攻击者行为，上传一个 jsp 的 webshell

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BcEttic2LpXeytDdy5xptKPxGdE9TrtmwWW33Oo96fQ1JVVqNNKAo1eso0rGDezGic6YyWE2C6zOjg/640?wx_fmt=png)

接下来模拟攻击者行为，把 log111.jsp 文件删除掉，那么怎么找到这个 shell 遗留的蛛丝马迹呢？  

查看 tomcat 中间件的 \ work\Catalina\localhost_\org\apache\jsp 目录，仍然是可以发现这个 shell 的编译过程中产生的几个文件的，这 3 个文件攻击者一般不会删除，也不会更改文件的时间属性。所以，这些 jsp 型 webshell 文件在编译过程中生成的 class 文件的时间属性，往往是比较准确的，而 jsp 文件的时间属性，很多攻击者会改成与 web 应用部署一样的时间，去迷惑蓝队工作人员。

原理：客户端访问某个 jsp 、jspx 文件时，Tomcat 容器或者 Weblogic 容器会将 jsp 文件编译成 java 文件和 class 文件，这两份文件均会存储在容器的某个目录中。  

如下图所示，可以确定攻击者的攻击时间了：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BcEttic2LpXeytDdy5xptKPGYTQMd9kbjwsThLdtlG1YMvYVHmNtvmk7ApPTQqV6he2zvs4vSqFeQ/640?wx_fmt=png)

如果需要进一步验证此文件是正常文件还是 webshell 文件，就需要使用 jadx-gui 工具对此 class 文件进行反编译了。如下图所示，很清楚看到了冰蝎 webshell 的代码特征。  

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BcEttic2LpXeytDdy5xptKPmH5pNIZFUJ9tzDhCYOcLl9dCa2GFNWHFHjrzuJ8uI3OHLgCYJ61CzA/640?wx_fmt=png)

注：虚拟机环境证明，tomcat 中间件即使重启后，这些编译产生的临时文件也是会一直存在的。  

接下来在 weblogic 中间件上进行同样的操作，制作一个 war 包上传到 weblogic 环境中：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BcEttic2LpXeytDdy5xptKP2IUtn4hWQ6NnK9wNHzAbJ6V60CZ8oajJWB9H1y3cTjN5lPDeyCGoicw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BcEttic2LpXeytDdy5xptKPZZA9vmzySG7uUCRiat6c7ewHdianJQA0oa2cOUd9qvqZJIWUqHVdTDMg/640?wx_fmt=png)

接下来将 log.jsp 删除后，试着查看在 weblogic 中间件下还有什么蛛丝马迹可以查询，发现在 / jsp_servlet / 目录下，还是有几个 webshell 编译生成的文件，这里与 tomcat 中间件不同的是，路径中的 / hwr7e2 / 是随机生成的一个目录，需要根据经验具体问题具体分析：  

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BcEttic2LpXeytDdy5xptKPIoYwfOxwpOXBh0CKwnWKPkibaHQPgOlpzujUOo27Y1UcGRUPUq0YDkQ/640?wx_fmt=png)

除此之外，还可以找到上传的 war 包，一样可以确定攻击时间，一般在这个目录下边：\user_projects\domains\base_domain\servers\AdminServer\upload，即使删掉 jsp 文件，重启 weblogic 后，这个 war 包文件也会一直存在。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450BcEttic2LpXeytDdy5xptKPOQPzVN8uvzl3mgoV595tiaBIfTqJKrY8HLLbm5bFaTc3icBMUZRbM8PA/640?wx_fmt=png)

Part3 总结  

===========

1.  jsp、jspx 型 webshell 文件被删除后，可以通过查找编译生成的 class 文件的方式去确定攻击时间。如果攻击者将 webshell 时间属性改掉，也可以通过此方法获取真实的攻击时间。
    
2.  对于 tomcat、weblogic 中间件，除非攻击者删除编译生成的文件，否则重启后这些文件也会一直留存在 Web 服务器中，成为溯源攻击者的一个重要证据。
    
3.  即使攻击者非常细心，把这些 class 文件全部删干净了，那么借助一些取证工具或者专业设备，还是可以溯源出来的，这个将来会专门写一篇文章讲解。
    

* * *

网络安全 abc123

专注于红队、蓝队技术分享，每周一篇

后续会继续分享蓝队应急溯源技巧，同时也会分享关于 weblogic 日志分析的案例，欢迎大家交流分享，并提出宝贵意见！

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450BcEttic2LpXeytDdy5xptKPlqMCTKEBaJrWm7Tic8TMDuTTatYPI5pJjLrtW8PicibXaIRIiaWmoICPLQ/640?wx_fmt=jpeg)