<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/PVbFHrJzy-qwD28s2EUXQA)

**前    言** 

  

本文主要介绍了使用调试器对 Windows 操作系统的内核层和 Hypervisor 层进行双机调试的几种常见和不常见的方法。本文中使用的 windbg 调试器和其附带的实用调试工具都可以在 windows sdk 安装包中选择安装，windows sdk 安装包官方的下载地址是: https://developer.microsoft.com/en-us/windows/downloads/windows-sdk。有需要的读者可以自行下载并安装。

下文中 DCI 工具包的下载百度网盘地址是：https://pan.baidu.com/s/1ToSB0vjRh1qSETTnS-rqQg?pwd=Ai3p 。提取码：Ai3p。

**一**

  

**串口调试**

首先我们先来介绍使用 VMware 虚拟机的情况下如何使用串口进行双机调试 Windows 内核及 Hypervisor。

在 VMware 的虚拟机设置中，添加 “串行端口” 设备后，并设置 “串行端口” 设备 “使用命名的管道”，这里命名管道的名称可以自己设定，并分别选择“该端是服务器” 和“另一端是应用程序”。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6oEC6IZDLEDj45JH0hkyGfINmLR1kDdEusLSd8wplheJcjDT54j8mpw/640?wx_fmt=png&from=appmsg)

然后我们在被调试机中设置 bcdedit 参数，这里的目的是在系统启动过程中添加 debug 参数。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6ynXuBicJLPvg26ibw4MuQXtw17Jegiczxky1vNsQuQe8DJqERiabaxibEFQ/640?wx_fmt=png&from=appmsg)

在被调试机中我们分别使用`bcdedit /dbgsettings serial debugport:1 baudrate:115200`和 `bcdedit /hypervisorsettings serial debugport:1 baudrate:115200`命令将 Windows 内核和 Hypervisor 的调试参数设置为串口调试，串口为 com1，波特率为 115200。然后再使用`bcdedit /debug on`和`bcdedit /set hypervisordebug on`命令分别开启 windows 内核和 Hypervisor 层的调试。最后设置 dbgtransport 为 kdcom.dll，这里是为了保证被调试机在系统启动过程中使用串口进行调试。

现在被调试机已经整装待发做好了被调试的准备，但调试机还需要一些配置。因为我们需要同时调试 windows 的内核和 Hypervisor，而且在被调试机的参数中使用了同一个串口 (com1) 作为调试串口，所以需要将不同层级的调试数据分发，根据不同层级将调试数据分发到不同的命名管道。我们可以使用`& 'C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\vmdemux.exe' -src pipe:pipename=com2`命令实现这一过程。

成功运行如上命令后，vmdemux 进程会自动生成两个命名管道`\\.\pipe\Vm0`和`\\.\pipe\Vm1`。分别使用`& 'C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe' -k com:port=\\.\pipe\Vm0,pipe,resets=0,reconnect`和`& 'C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe' -k com:port=\\.\pipe\Vm1,pipe,resets=0,reconnect`命令打开 windows Hypervisor 和内核的调试窗口。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6WAHkHSZ2RFcRyrKdHy0VnXJUHPAnuLRb41iacZewpFvnRaGNhPA6ibDw/640?wx_fmt=png&from=appmsg)

下面我们介绍在双实体机的情况下如何使用串口进行双机调试。

双实体机进行串口调试需要被调试机的主板上保留 9 针串口，在 10 年前的电脑主板上，串口几乎是标准配置，然而随着主板厂商的革新，主板串口也渐渐退出历史舞台。

除了需要主板中保留串口外，还需要拥有一条串口调试线：Null-modem 线，或者准备一条 2，3 交叉线。关于 Null-modem 调试线的线序如下图，感兴趣的读者可以自己手动做一条。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6yrWOLAzTBA4PjuOcjyCyUElXnIWGIymasaZictU0bMuIkJROFeFFliaw/640?wx_fmt=png&from=appmsg)

当使用串口调试线连接好调试端和被调试端，就可以使用 `& 'C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\vmdemux.exe' -src com:port=com2`命令将不同层级的数据分发到指定的层级，实现 windows 内核和 Hypervisor 调试。

**二**

  

**网络调试**

Windows 内核和 Hypervisor 调试中，可以使用网络进行调试，不需要特殊的调试线连接两台机器，网络调试大大方便了双机调试中的准备过程。

首先，配置被调试机 bcdedit 配置，这里假设我们的调试机 IP 地址为 192.168.111.1，调试 Hypervisor 的端口为 52201，调试 windows 内核的端口是 52202。运行如下图的命令，设置网络调试，最后将 dbgtransport 设置为 kdnet.dll。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6jYHCSmqggLhOCL32z6TXSaibcTmO84J6cFww7boPhzUU8ia5OHsYOiaGQ/640?wx_fmt=png&from=appmsg)

在图中可以看到，如果成功设置了网络调试后，会返回一个 key，这个 key 是用来给调试机中的 windbg 连接被调试机使用的。这里这两个 key 要先记下来。

重启被调试机后，在调试机端使用`& "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe" -k net:port=52202,key=rq644uvs2p16.3ked98d1isrrq.hr7oioflkdt2.37b29ko4f79yj`和`& "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe" -k net:port=52201,key=2mko67of9fjih.233nl9lfzytc2.13u0ikbj37np1.3im74f7f672zj`命令打开 windows 内核和 Hypervisor 调试窗口。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6f2KAoicaeDem2SJFs2PwG5qau5t2a6tHvCqRa0OHSicAtYq7HFK4njGg/640?wx_fmt=png&from=appmsg)

**三**

  

**USB 3.0 调试**

USB3.0 接口也可以用作 Windows 内核调试的解决方案，在例如一些超薄笔记本电脑没有 PCIE 网卡的情况下，USB3.0 便成了唯一的内核调试方案。

首先，需要将 windows sdk 套件中的 usbview.exe 这个程序复制到被调试机中，位置在：`C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\usbview.exe`。

在被调试机中打开 usbview.exe，并找到 USB3.0 主控器，查看主控制器的信息，如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6rWwOqqTJUuNdydSUa5x1ia2WQ58PIr2tYNEwL5iacIZjElAlkicl95Q4A/640?wx_fmt=png&from=appmsg)

如图中所示，图中选中的 USB3.0 主机控制器中的信息显示它的 Debug Port Number 不为 None，这个主控器设备所在的位置在 0.20.0 这个位置上。Debug Port Number 的信息不为 None 说明当前的 USB3.0 主控器拥有调试能力。

当确定好了主控制器位置后，还需要准备一条 USB3.0 调试线，根据 USB3.0 引脚定义可以得知，USB3.0 的引脚 1 是供电，引脚 2、3 是 USB2.0 数据传输所用引脚。

所以根据微软给出的文档：https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-usb-3-0-debug-cable-connection，只需要先购买一条 USB3.0 A/A 公对公线，然后使用透明胶带将买来的线材的 1、2、3 号引脚绝缘屏蔽后就得到了一条 USB3.0 调试线。

随后将调试线的一端插入调试机 USB3.0 接口中，另一端插入到被调试机位置在 0.20.0 主控制器所在的端口中。如果这里无法确定哪个接口是所在主控制器所在端口的话，可以找一个 U 盘挨个尝试，在 usbview.exe 中观察，直到找到正确的端口。

下面我们在被调试机中配置 bcdedit 参数。使用如下三条命令开启 USB3.0 内核调试：

*   `bcdedit /debug on`
    
*   `bcdedit /dbgsettings usb targetname:ikun`
    
*   `bcdedit /set "{dbgsettings}" busparams 0.20.0`
    

这里的 targetname 可以取一个任意的名字；busparams 要填入刚才找到的拥有 USB3.0 调试能力的 USB3.0 主控制器设备的位置。

重启被调试机后，使用如下命令打开 Windows 内核调试窗口：

`& "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe" -k usb:targetname=ikun`

读到这里有人肯定发现了这里的 USB3.0 调试好像并没有配置 Hypervisor 层的调试，这个原因是因为微软只实现了 Windows 内核的 USB3.0 调试，Windows Hypervisor 层并不支持 USB3.0 调试。

**四**

  

**VMware + IDA 调试**

VMware 虚拟化软件也拥有强大的调试能力，我们可以借用 VMware 和 IDA 调试任意操作系统。

首先，在配置及安装完虚拟机后，打开虚拟机的配置文件，例如：Windows10_x64_hyperv.vmx。打开 vmx 文件后，在文件的末尾添加如下配置：

*   `debugStub.listen.guest64 = "TRUE"`
    
*   `debugStub.hideBreakpoints = "TRUE"`
    
*   `debugStub.listen.guest64.remote = "TRUE"`
    
*   `monitor.debugOnStartGuest64 = "TRUE“`
    

这四句配置是启用 VMware 的调试能力。

如果想在虚拟机中安装 Hyper-V 的话，还需要使用如下配置 “欺骗”Windows 系统让其觉得在一个可以安装 Hyper-V 的环境：

*   `hypervisor.cpuid.v0 = "FALSE"`
    
*   `mce.enable = "TRUE"`
    
*   `vhv.enable = "TRUE"`
    

修改完虚拟机配置后，启动虚拟机，此时的虚拟机会直接黑屏。这时打开 IDA，在菜单中选择 Debugger->Attach->Remote GDB Debugger，连接本地调试器，端口号为 8864，如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6LNoTwaxjTnChWiaeUFib1lJJukNwEL5iaUicBgJdJFQFIZZxSTr8GxKNQA/640?wx_fmt=png&from=appmsg)

随后选择 attach 到目标进程选项后，会弹出 IDA 的调试窗口，此时 IDA 调试窗口显示当前 RIP 所在的位置，如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6iaiaWibNR6Isyb165AfibSkPdQqARAKc9vuKOSZPnr5KO8TiawHlPUycRpw/640?wx_fmt=png&from=appmsg)

从图中可以看出，当前 RIP 的显示还是有问题，所以还需要添加内存的地址范围。打开菜单 -> Debugger→Manual memory regions，在 Manual memory regions 窗口中按下 insert 键，添加一个 0~0xffffffffffffff00 的地址范围。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6IGhlclcp4FD37KG0LE08hGe7J6SPibklwWvKFsr9jXnGQ0Xf7uEg46g/640?wx_fmt=png&from=appmsg)

此时按 F9 可以继续虚拟机的运行，如果需要调试就按下 suspend 进行调试。

IDA 调试的优点是无需操作系统支持调试，而且虚拟机中无法检测调试器的存在，但是缺点是需要手动加载符号，调试时也不如 windbg 那样方便。

**五**

  

**USB3.0 DCI 调试**

USB3.0 DCI 调试听起来相对比较陌生，那么 DCI 是什么呢？DCI 的全称是 Direct Connect Interface，是 Intel 平台中提供的调试方法，这个技术主要实现了可以直接通过使用 USB3.0 端口来调试目标系统。说白了其实就是这个技术实现了直接通过一根 USB3.0 调试线调试被调试机，而且这种办法是 JTAG 调试，调试器会暂停 CPU 的运行，是一种硬件级别的调试。

但 Intel 平台的调试支持并不是一个新技术，在过去 Intel 平台的硬件调试器是一个被大家叫做蓝盒子的调试器。这个调试器官方叫它 Intel ITP(In Target Probe)，ITP 要求在被调试机的主板制造时预留并安装 ITP/XDP 接口，并且如果你使用 ITP 进行调试必须要购买 Intel 的硬件调试器，也就是 “蓝盒子”，官方购买的话大概要几千美元。所以在过去，Intel 平台的硬件调试几乎是给 Intel 的合作伙伴使用的，用作硬 / 软件的开发和调试。

不过现在好日子来了，DCI 在 Intel Skylake 系列之后的产品中，硬件上都支持 DCI 功能。也就是说，从 Intel 6 代的 CPU 和 100 系列芯片组之后的产品都会支持 DCI 功能。

但是坏消息是市面上大多数的主板都会默认关闭 DCI 这个功能，当然这是考虑到安全性问题。所以我们如果要启用这个功能，则需要修改主板的 BIOS。那目前可以进行 BIOS 修改的主板有支持 AMI BIOS 的主板，例如华硕，微星等。

修改 BIOS 第一个办法可以使用 AMIBCP 工具修改 BIOS 镜像。例如这里通过修改 BIOS 镜像中的 Setup →PCH-IO Configuration→DCI Enable(HDCIEN) 选项，将其设置为 Enabled。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6vjdsibFFfJiaaNYjWoFBU19lXm0vAE5Ey4EKAuiaLQMr1HTmEBl2pG6hA/640?wx_fmt=png&from=appmsg)

随后保存镜像并刷 BIOS。

第二种办法是使用 UEFITOOL 和 IFRExtractor 工具将 BIOS 固件导出 IRF（UEFI Internal Form Representation）表。并在 IRF 表中寻找如下字段：

*   `Debug Interface`
    
*   `Debug Interface Lock`
    
*   `DCI enable(HDCIEN)`
    

记录下这些字段的`VarStoreInfo (VarOffset/VarName)`和`VarStore`的值，例如作者这里的信息如下图。

![](https://mmbiz.qpic.cn/mmbiz_jpg/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6uPFRIhlnCQYuOH977Ow3KHYa4pPASib0WaXwO1yGEKznFNQAZvZmV3A/640?wx_fmt=jpeg&from=appmsg)

可以看到这些字段的`VarStore`的值都是 1，此时我们翻到 IRF 表的最前头，查找`VarStoreId`为 1 的条目。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6GOPYLDoKSgIWlLqjxHxnnjzsBxcXVEB9jJWMbppe5vlMXRGoFraztw/640?wx_fmt=png&from=appmsg)

可以看到这个是 BIOS 选项里的 Setup 条目。

下面重启被调试机，使用 RU.exe 工具修改 BIOS，注意这里的 RU 工具版本可以选择旧一点的，新版的可能会有 bug，笔者这里选择的 RU 版本是 5.28.0397。

进入到 RU 的界面后，按下 ALT+= 进入 BIOS 界面，选择 Setup 条目，然后根据我们找的上文中那三个字段的 VarOffset 值来修改对应字段的配置。

这里我们需要将字段的配置修改至如下状态：

*   `Debug Interface`  →  1
    
*   `Debug Interface Lock`  →  0
    
*   `DCI enable(HDCIEN)`  →  1
    

修改 Debug Interface 字段是为了启用硬件调试功能；Debug Interface Lock 如果为 enable 会影响 CPU 的频率，如果不修改 CPU 可能会以 0.x Ghz 的频率运行；DCI enable 是开启 DCI 功能的设置。

修改完成后，被调试机的准备工作就做完了。除此之外，我们还需要一条 USB3.0 调试线，具体的制作方法前文已经介绍了。

此时我们需要配置下调试端的环境，首先安装 Intel DCI 驱动，这个驱动是将被调试机的 USB 端口识别成`Intel USB Native Debug Class`设备。运行`Setup_x64_Intel_DCI_Driver_1.10.0.0.msi`并安装驱动，安装驱动完成并且连接好调试机和被调试机后，启动被调试端，调试端的设备管理器就会显示`Intel USB Native Debug Class Devices`设备，这说明 DCI 运行良好。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL67JXsOVN1cFadf4m7zaEeZMLT9W526SfWmlAhzms6053Fh5tq0zBdIw/640?wx_fmt=png&from=appmsg)

配置好调试机环境后，使用我们提供的 DCI 调试相关的工具包，安装 python 库 ipccli。使用`ipccli.baseaccess()`连接被调试机，再使用`ipc.status()`查看被调试机 CPU 状态。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6x3DZZ0AwVfGlRQl3n7qIshZzakwQKtfAZ6hZHap5iamNhFPoKvVAiafw/640?wx_fmt=png&from=appmsg)

也可以使用另外一种办法进行调试，首先到 DCI 调试相关的工具包的位置，然后打开`%DCI工具包%\windbg-ext\iajtagserver\intel64\`路径，以管理员权限运行`regsvr32.exe ExdiIpc.dll`。这一步骤是为了注册 COM 组件，可以让后面使用 windbg exdi 调试时唤起 IntelExdiServer。

下面运行工具包中的`windbg_iajtag_console.bat`批处理连接上被调试机，并在批处理窗口中输入`windbg()`命令开始进行调试。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6sYnka6eaCbKkxq5Y5v1ehkqRloibeG2FMLhbiaGOtec3ibqB8PhYerVtQ/640?wx_fmt=png&from=appmsg)

目前的 windbg 已经连接上了被调试机，但是还没有加载上 NT 内核以及其他内核模块的符号。我们可以使用`.scriptload reload_manual.js`加载查找内核模块地址的脚本，并使用`!reloadmod`查找并加载符号。如下图。

![](https://mmbiz.qpic.cn/mmbiz_png/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6nkRmdblnw5s07vEpcAQFcu3m69HBSBDvbo0qPnXUZft1ribZL4DJjMA/640?wx_fmt=png&from=appmsg)

**六**

  

**总 结**

优缺点分析如图所示。

![](https://mmbiz.qpic.cn/mmbiz_jpg/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6laur2cw9ic9gIic17BseEaaYeLoUKBpvF75QBqMgMdSUOMARSDLk8ZVw/640?wx_fmt=jpeg&from=appmsg)

与其他的调试方式不同的是，DCI 调试可以在 ring-2 层级上工作，也就是说可以进行 SMM 的调试，也可以调试比如 Intel ME 组件。

  

  

  

  

【版权说明】

本作品著作权归 **HongZhenhao** 所有

未经作者同意，不得转载

![](https://mmbiz.qpic.cn/mmbiz_jpg/9EP6QFMcTmRmn3CglPf7lSpRWLtTMaL6QhBqicj1vGiajclEJ4pVv4mwHDNLegPgVibn283OK3ZzjKkOHAuU0ICnw/640?wx_fmt=jpeg&from=appmsg)

**HongZhenhao**

  

天工实验室安全研究员

专注于 Windows、云、虚拟化领域漏洞挖掘。

曾多次获得微软 MSRC 最高漏洞赏金，荣登 2019，2020，2022 微软 MSRC 全球最具价值安全精英榜。

连续两年 BlackHat USA 世界黑帽大会 Speaker。

**往期回顾**

  

**0****1**

[FortiGate SSLVPN CVE-2024-21762 漏洞利用分析](http://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&mid=2247484811&idx=1&sn=2e0407a32ba0c2925d6d857f4cdf7cbb&chksm=c3571307f4209a110d6b28cea9fe59ac0f0a2079c998a682e919860f397ea647fa0794933906&scene=21#wechat_redirect)

**0****2**

[Ghidra 脚本编写：从 IR 到反编译 C](http://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&mid=2247484755&idx=1&sn=32ebb9c87513cedf2c9fc4b62752b2e4&chksm=c35713dff4209ac923fc7aea8a54c60360693a303b53784219418b4a3b741593a1d00992bf6d&scene=21#wechat_redirect)

**0****3**

[关于 Linux 内核条件竞争的探讨](http://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&mid=2247484736&idx=1&sn=bb88ae3e5a727de759c2a94ab15a7e02&chksm=c35713ccf4209ada8fc511ab97ae7fdb5c54d15aee920fcaee1e650926f604ebad3a36aaa272&scene=21#wechat_redirect)

**0****4**

[WebAssembly 安全研究总结](http://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&mid=2247484679&idx=1&sn=a1b11639b79ee05aec1e74604b32ef4b&chksm=c357138bf4209a9d1e3b8fb9250a7368301e87cbdf27010ccc06d5d445cbad92e289f97cb742&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/oJZWTpJpiae90UpibicIKeZgQTNjebiaOwStfe6MJ5J6RC7F9JDFdX2kaEwibFz7GewNtNyDek6SdENJrXjf0KXA2kg/640?wx_fmt=png)

**每周三更新一篇技术文章  点击关注我们吧！**
