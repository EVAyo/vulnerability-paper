<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/z0jREmXbIyHw_16rq8rNtw)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9Lbc0INLwTJTZT1GaNutZrfDn6csvjBoS2ox0efLUEexXqPEcVbYfbLo8w/640?wx_fmt=png)

 **Part1 前言** 
==============

**大家好，我是 ABC_123**。本期继续分享 Solarwinds 供应链攻击事件的第 4 篇文章，就是美国 FireEye 火眼安全公司在遭受攻击者入侵之后，是如何一步步地将史上最严重的 Solarwinds 供应链攻击事件溯源出来的。

**注：**Mandiant 安全公司已被 FireEye 收购，但是仍然可以独立运营，严格地说的，这次攻击事件是 Mandiant 公司溯源出来的，当然也可以说 FireEye 公司溯源出来的。

**建议大家把公众号 “希潭实验室” 设为星标，否则可能就看不到啦！**因为公众号现在只对常读和星标的公众号才能展示大图推送。操作方法：点击右上角的【...】，然后点击【设为星标】即可。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHdFeDURNa0QpfjclGrvg0lfANPtuLbf5Ddur3HZmdfAydibIf9zazCKQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **Part2 部分美国单位遭到入侵** 
======================

*   **美国智库遭受入侵**
    ------------
    

2019 年底，一家美国智库内部网络遭受入侵，美国安全公司 Volexity 帮忙做应急处理，很快将攻击者踢出网络，但是攻击者技术明显高超很多，很快又出现在内部网络中。此后每周都多次往返于内部网络中，窃取特定高管、专家和 IT 员工的邮件，将邮件内容发送到外部服务器。随后安全公司又花了一周的时间将攻击者踢出网络，但是不知道为啥，**在 2020 年 6 月下旬，攻击者又卷土重来**，又从相同的账号中窃取邮件信息。

Volexity 安全公司的安全人员花了数天的时间尝试弄清楚攻击入口，最终他们将注意力集中在一台网管服务器上，上面安装了 Solarwinds 公司的网管软件 Orion。安全团队认为攻击者一定是在该服务器上留下了后门，但是经过大量调查发现，他们找不到后门，最后他们再次将攻击者踢出网络。为了安全起见，**他们建议客户将此服务器与互联网断开，禁止外网通信，至此攻击停止**。但是攻击者是如何入侵智库网络的，并没有调查清楚，还是个谜。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bve9fA75BeSMSlGEWSMyB51P8MalzcTPE7uaMuZUlFHKjV7Oe9WZFavKukzykjTiay4XPgN7R5ToQ/640?wx_fmt=png)

*   **美国司法部遭受入侵**
    -------------
    

在 2020 年 5 月下旬，美国司法部发现自己遭到了入侵，他们的网络中的 Solarwinds 软件试用版服务器出现了问题，有传输到互联网的异常流量。于是他们请了 Mandiant 安全公司（已被 FireEye 收购）帮忙调查，后来还请了微软公司参与调查，但是最终都没弄清楚攻击者是如何进入内部网络的。据消息人士称，当时调查人员怀疑攻击者可能是通过 Solarwinds 软件漏洞直接入侵了司法部的服务器，但是后来没有找到相关的证据，此事就作罢了。

这两起公布出来的事件实际上都是 Solarwinds 供应链后门入侵事件造成的，但是都没有被溯源分析到，**直到 FireEye 公司发现入侵痕迹，并且进行了深入调查，才逐步揭开该事件的真相**。

 **Part3 FireEye 公司处理过程** 
==========================

*   **FireEye 公司发现安全告警**
    --------------------
    

2020 年 11 月 10 日，FireEye 公司（收购了 Mandiant）的内部安全日志审计中，一名分析师发现了一条安全告警：一位员工注册了一个新的三星手机接收双因素认证验证码（每当员工在多重身份验证系统中注册新手机的时候，都会触发此类告警），但是分析师发现了这个三星手机有点不同寻常，在系统中没有相关联的手机号码。

分析师仔细查看了手机的活动日志，又观察到另一个奇怪的细节：该员工使用手机从佛罗里达州的一个 ip 地址登录了他的 VPN 账号，但是这名员工不在佛罗里达州，他在多重身份验证系统上旧的 iphone 手机仍然处于可用状态。**然后同一时间，该名员工使用三星手机在佛罗里达州的 ip 地址登录，同时该名员工使用 iphone 手机在自己所在的州登录了 vpn 账号**。经过询问，当事员工反馈这段时间他并没有在系统中注册新的手机号码，这是一个非常明显的网络遭到侵入的信号。

FireEye 的安全团队很快阻止了这个三星手机的访问，然后花了一周的时间去调查入侵者是如何获取员工的 vpn 账号密码的。他们很快意识到这个问题已经不是某个员工的账户失陷了，可能 FireEye 的内网已经被入侵了。通过日志分析来看，攻击者实施了 Golden SAML 攻击，这是一种用于劫持公司任意员工身份验证系统的复杂技术，他们可以夺取任意员工账户的控制权，授予这些账户更多权限，甚至可以创建具有无限访问权限的新账户。有了这种能力，攻击者可以深入访问到公司内部的任何网络和资产。

*   **FireEye 公司初步调查**
    ------------------
    

2020 年 11 月 17 日，Mandiant 公司组织了一个大约 10 人的顶级调查团队，专门负责调查此次攻击事件，由于高层担心调查不一定会发现什么重大事件，因此需要控制知情人范围，起初并没有派很多人参与调查。他们发现过去几周，攻击者利用网络中已有的网络工具实施入侵行为，这是为了避免留下自己的常用工具，然后还使用了无文件落地攻击技术，同时，他们在入侵过程中，还避免留下日志和其它痕迹。

与此同时，多个受害客户都要求 Mandiant 公司协助他们去追踪攻击者的的对外通信，他们发现，对于每个受害者，攻击者都会建立一个 C2 服务器专门与之通信，而且这几起安全事故有很多相似之处。同时 Mandiant 的安全团队由于疫情原因在家里工作，每天连接电话会议，持续了 18 个小时，**一边梳理日志和系统，一边绘制黑客走过的每一个步骤**。

*   **发现 Solarwinds 服务器异常通信**
    -------------------------
    

于是 FireEyey 公司开始组织大量人员参与调查，安全团队提出了一连串的假设，并花费数周的时间追踪每一条线索，但是最终什么也没找到。在他们几乎已经失去了希望的时候，他们在流量日志中无意中发现了一个重要的线索：**一台服务器曾经与互联网的一个系统短暂通信过，而这台服务器正在运行着 Solarwinds 的 Orion 软件**。这个 Orion 软件只应该偶尔与 SolarWinds 的网络通信以获取更新，但实际上它正在与一个未知的系统通信，很可能是黑客的 C2 控制服务器。

*   **发现 Orion 软件后门**
    -----------------
    

安全团队怀疑入侵者在 Orion 服务器上安装了后门，然后派了一名技术总监和两名安全人员来寻找后门，这个任务非常繁重，因为 Orion 软件套件由超过 18000 个文件和 14GB 的代码和数据组成。然而在 2020 年 12 月 11 日，**他们只花了 24 小时就找到了隐藏的后门**，这个后门文件是一个 dll 动态链接库文件，也是其它程序共享的代码组件。

这个 dll 文件非常大，包含约 46000 行代码，执行了 4000 多个合法的操作，它原先的主要工作是告诉 SolarWinds 公司有关客户 Orion 软件使用情况的信息。在他们分析了一个小时后，这个 dll 文件还执行了一个非法的操作。经过继续的分析发现，攻击者在此 dll 文件中嵌入了大量的恶意代码，将受害者网络数据传输到他们的 C2 服务器，而且代码的命名规范刻意模范了原有研发人员的习惯，看起来和正常的代码相差无几。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bve9fA75BeSMSlGEWSMyB5t3AMUdS2TZgjunvoXhdQmguPlrpo6M8zqLbRLnqjfM3yyZPvGOOb2Q/640?wx_fmt=png)

*   **发现 Orion 官方更新包存在后门**
    ----------------------
    

现在他们必须弄清楚入侵者是如何将它偷偷嵌入到 Orion 软件的. dll 中的，这远非易事，**因为这个 Orion 的 dll 文件是用 SolarWinds 数字证书签名的，这个数字证书验证该文件是合法的公司代码**。一个可能性是攻击者窃取了数字证书，创建了一个后门版本的 Orion 文件，签名该文件以使其看起来是正常的，然后安装了恶意的. dll 文件在 Mandiant 公司（FireEye 公司）的服务器上。第二个可能性是，他们可能已经入侵了 SolarWinds 的网络，在 SolarWinds 将代码编译为软件并签名之前，修改了合法的 Orion.dll 源代码。

Mandiant 公司的团队起初认为第二种情况不太可能，以至于在溯源分析过程没有认真对待它。直到后来，**一名调查员从 SolarWinds 网站上下载了一个 Orion 软件更新包，发现其中有相同的后门**，这才发现是攻击者在 Solarwinds 的官方 Orion 软件更新包中植入了后门。

这个发现是惊人的！Orion 软件套件在全球有大约有 33000 个客户，其中一些客户从 3 月份开始就收到了被黑客篡改过的软件更新，**这意味着一些客户可能已经被攻击者入侵了八个月**。攻击者这一举动可以感染数千台机器，甚至可能是数百万台。Mandiant 安全团队意识到自己正在处理一个，可能是有史以来影响最大的软件供应链攻击案例，攻击者对可信软件的源头进行了恶意修改，植入了后门代码。

*   **FireEye 公布 Solarwinds 后门情况**
    ------------------------------
    

2020 年 12 月 8 日，FireEye 在其官方博客发布了一篇文章，文中提到，“一个具备顶级网络攻击能力的国家” 正在针对 FireEye 进行网络攻击，**并且已经成功窃取了 FireEye 的一批安全研究工具软件**。随后，FireEye 的研究人员开始分析内部的 SolarWinds 软件服务器，但并没有发现服务器上有任何恶意软件的安装痕迹。研究团队于是决定对服务器上的 SolarWinds 软件进行逆向分析，在其中的一个模块中发现了具有 SolarWinds 公司数字签名的恶意代码。

*   **FireEye 将后门情况通报给 Solarwinds 公司**
    ----------------------------------
    

2020 年 12 月 12 日，FireEye 将相关情况通报给 SolarWinds 公司。同一天，SolarWinds 向美国证监会和公众披露了攻击事件，此次供应链攻击事件由此浮出水面。之后，新的受害者陆续被发现，其中最引人关注的是美国商务部、国土安全部、国务院、财政部、核安全委员会等联邦机构，甚至微软公司的部分源代码也被攻击者窃取。SolarWinds 公司承认，约 1.8 万名该公司客户遭到网络攻击。

*   **微软 OWA Duo MFA 绕过**
    ---------------------
    

会议中有一名微软员工，告诉大家在某些情况下，黑客正在系统地入侵微软 Office 365 电子邮件账户和 Azure 云账户，黑客还能够绕过多因素身份认证。

Volexity 的调查给出了攻击者绕过 Duo MFA 保护的 OWA 服务器的一些技术细节。从 Exchange 服务器的日志来看，攻击者使用了用户名和密码进行登录，但是没有输入 Duo 的第二认证因子，**从 Duo 服务器的日志来看，也没有发起需要使用 Duo 进行二次认证的请求**。Volexity 公司通过 OWA 服务器导出的内存，可以确定用户的会话并没被劫持，但是攻击者直接使用了合法的 Duo MFA 的 Cookie 参数 duo-sid。

这是怎么做到的呢？首先，攻击者在 OWA 服务器中获得了 Duo 集成身份认证的秘钥（akey）。然后，攻击者利用这个秘钥构造了一个计算好的 Cookie 参数 duo-sid。最后，攻击者使用用户名和密码进行登录，使用 duo-sid 来认证 Duo MFA 的检查，最终实现了登录。攻击者利用的就是 MFA 本身的机制，并不是一个漏洞，所以没有触发任何安全防护机制。

 **Part4 SolarWinds 公司处理过程** 
=============================

*   **禁止使用电子邮件沟通**
    --------------
    

接下来就是 Solarwinds 公司来处理这件事情。在最初的几天里，团队成员们被要求只能通过电话和外部账户进行沟通，直到 CrowdStrike 批准他们再次使用公司电子邮件。这个要求后续被证明是非常明智的，因为后续调查发现，攻击者已经入侵了至少 71 个 SolarWinds 的电子邮件账户，**并且一直在暗处监视 Solarwinds 公司的邮件内容**，查看是否有任何迹象表明他们被发现了。

*   **分析日志和查看入侵痕迹和分析日志**
    --------------------
    

团队的首要任务之一是收集可能揭示黑客活动的数据和日志。他们很快发现，他们需要的一些日志并不存在，SolarWinds 无法追踪所有内容，并且**一些日志已被攻击者删除或随着时间的推移被新的日志数据覆盖**。他们还想查看公司近 100 个其他产品是否受到了攻击，他们只找到了 Orion 受到攻击的证据。

*   **遗留的编译虚拟机快照成为突破口**
    -------------------
    

随后 SolarWinds 公司一直在想办法查找入侵者是如何将 Orion 的恶意 dll 文件放入编译服务器的，最终在 2021 年 1 月 5 日，一个 SolarWinds 工程师发现了一个旧的虚拟机快照留存。这个虚拟机是由名为 TeamCity 的软件构建管理工具创建的，TeamCity 会启动大约 100 个编译虚拟机来完成它的软件编译工作。通常这些虚拟机是短暂存在的，只存在于编译软件所需的时间内。但是，如果构建过程的某个部分因某种原因失败，TeamCity 会创建一个 “内存转储” 快照在发生故障的虚拟机中，该快照包含故障发生时虚拟机的所有内容。

这个快照是在 2020 年 2 月的软件构建中留下的，通常 SolarWinds 工程师会在后续的清理过程中删除这些快照，但是幸运的是，他们没有删除这个快照。所以**天网恢恢疏而不漏**，如果不是因为它的不可思议的存在，很可能最终的调查取证会一无所获。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bve9fA75BeSMSlGEWSMyB5n9H63xtUndcTJDxW4EvCPUCiaR0BGtkIWyJ5NTeN5LyHfc4WjdNue3A/640?wx_fmt=png)

*   **发现后门投递工具 Sunspot**
    --------------------
    

在这个编译虚拟机快照中，调查人员发现了一份恶意文件，调查人员称其为 “Sunspot”。这个文件有大约 3500 行代码，这些代码成为了解关于攻击者入侵行为的关键。

调查人员通过分析 Sunspot 相关的活动发现，攻击者在 2 月 19 日或 20 日将其植入了软件构建服务器，然后一直潜伏在那里。直到 3 月份，当 SolarWinds 的开发人员通过 TeamCity 开始构建 Orion 软件更新并创建了一组虚拟机时，攻击者不知道哪个虚拟机将编译 Orion .dll 代码，**因此设计了一个工具将 Sunspot 部署到每个虚拟机中**。

此时，APT 组织的攻击手段的美妙和简洁显露无遗，一旦 dll 文件出现在虚拟机上，Sunspot 就会快速自动地将此合法文件重命名，并用含有 Sunburst 后门代码的文件替换它，后续编译完成之后，会自动将原有的合法文件恢复到原有位置，并将含有后门代码的副本文件删除。构建系统随后获取了经过攻击者修改的 dll 文件并将其编译到 Orion 软件更新包中，整个操作只需要几秒钟的时间。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bve9fA75BeSMSlGEWSMyB5DZrIt0llcTHFWGgBYhFa4CldviaJyeCxGmqibicXZmlxK9F9wNLlsEibzQ/640?wx_fmt=png)

但是在 6 月 4 日，攻击者突然从构建服务器中删除了 Sunspot，并清理了许多痕迹。这个举动非常怪异，随后的调查揭示了原因，由此更让安全人员叹服此 APT 攻击组织的高超的技术和缜密的计划。

*   **发现攻击者暗处监视邮件往来**
    -----------------
    

在后来的安全讨论会上，一名男子透露，在 2020 年春季，该机构的人员发现了一些来自运行 Orion 的服务器的异常流量，并联系了 SolarWinds 公司的安全人员讨论此事。这位男子猜测，当时正在监视 SolarWinds 电子邮件账户的攻击者感受到了问题的严重性，并删除了 Sunspot 工具，因为他们担心攻击行为暴露，担心安全公司将会发现他们的入侵行为。

 **Part5 应急处置** 
================

2020 年 12 月 18 日，FireEye、微软、GoDaddy 联合接管了 Sunburst 后门通信使用的域名，并指向了受控域名，阻断了遭攻击网络中的恶意 Sunburst 后门与控制服务器之间的通信。

但是这几家公司是如何巧妙地让所有客户的 Sunburst 后门终止运行的，并没有公布。根据上一篇 ABC_123 的文章的介绍，我们可以做如此假设：若 GoDaddy 建立一个通配符的 DNS 解析方案，把所有 avsvmcloud[.]com 的子网域都解析至 20.140.0.1，再把 20.140.0.1 列入黑名单，那么 Sunburst 在 dga 域名请求过程中，就会参考如下列表中 20.140.0.1 这个 ip 对应的指令，永久终止自己的后门活动。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450Bve9fA75BeSMSlGEWSMyB5Rny5ZYibHPK7FpdjYViczwEzF3hWG4GnYibIzwawtNnNk4jv15TIlEUIA/640?wx_fmt=png)

 **Part6 总结** 
==============

**1.**  Solarwinds 公司对于日志没有进行备份留存，导致溯源 Sunburst 后门事件的时候日志缺失或者被覆盖，极大地影响了溯源工作的进展。

**2.**  早期几家安全公司处理 Solarwinds 客户的 Orion 服务器被入侵事件时，并没有深入分析，导致相继错过发现 Sunburst 后门，险些造成此次供应链攻击事件被隐藏更长时间。

**3.**  **在调查取证的初始阶段，禁止安全人员使用邮件通信来交流溯源工作进展，这个方法非常明智，值得推广**。

**4.**  在后期，FireEye、微软、GoDaddy 之间合作，通过控制 dga 域名解析 ip 的方式，使所有的 Sunburst 后门终止活动，这个应急处置方法非常及时，体现了这几家公司对于 APT 后门样本分析的能力。

**5.**  FireEye 公司对此攻击事件的不遗余力地深入追查，最终导致 Solarwinds 供应链攻击事件被揭露出来。

**6.**  天网恢恢疏而不漏，最终一个遗留的几乎是一定会被删除的编译虚拟机快照的留存，导致 SunSpot 后门投递工具被发现。**所以我们广大网络安全工作人员，一定要遵纪守法，对自己的行为负责**。

**7.**  按照标准做法，Orion 服务器应该被配置只能与 Solarwinds 通信，但是多数客户都没有这样做，直接配置为允许外网通信。为了安全考虑，但只有 20% 到 30% 的 Orion 用户将服务器配置成允许与外网通信，因此只有这些客户才会遭到入侵。**所以安全规范不是纸上谈兵，按照合规要求踏踏实实地去落实，就可以抵御这次顶级 APT 攻击**。

**8.**  做应急响应，**首先要画好时间轴，一点点补充攻击事件，这是非常有效的方法**，在本次 APT 攻击事件中，几家安全公司都采用了这一方法。

**9.**  随后的分析发现，攻击者不仅仅是想窃取数据，他们还在对抗他们最大的敌人，进行反情报活动。因为当客户遇到安全事件时，他们最经常联系的安全公司是 FireEye 公司，所以攻击者把目标指向了它，如果 FireEye 公司被攻击者彻底攻下，那后果不堪设想。**由此可见，该 APT 组织的目标，也在随着供应链攻击的成功逐步扩大**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

**公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**