<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.freebuf.com](https://www.freebuf.com/articles/web/265049.html)

> 该篇章目的是重新牢固地基，加强每日训练操作的笔记，在记录地基笔记中会有很多跳跃性思维的操作和方式方法，望大家能共同加油学到东西。

**HW 期间，为防范钓鱼，即日起 FreeBuf 将取消投稿文章的一切外部链接。给您带来的不便，敬请谅解~**

系列文章
----

> [专辑：渗透测试之地基篇](https://www.freebuf.com/column/1998)

简介
--

**渗透测试 - 地基篇**

该篇章目的是重新牢固地基，加强每日训练操作的笔记，在记录地基笔记中会有很多跳跃性思维的操作和方式方法，望大家能共同加油学到东西。

**请注意**：

> 本文仅用于技术讨论与研究，对于所有笔记中复现的这些终端或者服务器，都是自行搭建的环境进行渗透的。我将使用 Kali Linux 作为此次学习的攻击者机器。这里使用的技术仅用于学习教育目的，如果列出的技术用于其他任何目标，本站及作者概不负责。

名言：

你对这行的兴趣，决定你在这行的成就！

一、前言
----

da-yu 公司是一个中小型公司，随着公司发展日渐壮大，开了家分公司，公司越来越重视信息化建设，公司考虑到计算机用户权限集中管理及共享资源同步管理，需要架设一套 AD 域控服务器，考虑到成本和日后管理问题，计划把 AD 域控和 DNS 服务器架设在一起，安装了主域控制器之后，为避免出现单点故障，需要另外再部署一台辅域控制器备用。

公司长远考虑后，域控制器是整个域的通信枢纽，为了日益发展的将来开分公司做考虑，在搭建父域和辅域后，还需要搭建子域，在未来管理规划和安全上就能节省带宽，更好的管理资源和建立安全策略进行防范。

在搭建期间公司财务部希望使用特定的安全策略进行独立，规划后将财务部单独建立一个子域来单独管理。

模式："da-yu 公司（域森林）-> xiyou 分公司（域树）-> 部门（单独域）-> 员工" 开始进行搭建，接下来将详细的介绍该公司是如何详细搭建的！

为了后期内网渗透篇接近现实环境体现真实性，这里内网篇章最初介绍如何搭建整个环境，以利于后期各种内网渗透技术篇章能在此环境中穿透遨游！

二、环境介绍
------

### 1、拓扑图简介

![](https://image.3001.net/images/20210305/1614926007_6041d0b71e211d5f70653.png!small?1614926007469)

```
**1）父域控制器：**
计算机名：dayu1
域：dayu.com
IP：10.10.3.5
掩码：255.255.255.0
网关：10.10.3.1
DNS1：10.10.3.5
DNS2：10.10.3.7

**2）辅域控制器：**
计算机名：dayufu
域：dayu.com
IP：10.10.3.7
掩码：255.255.255.0
网关：10.10.3.1
DNS1：10.10.3.7
DNS2：10.10.3.5

**3）父域普通用户：**
计算机名：fuyong
域：dayu.com
IP：10.10.3.15
掩码：255.255.255.0
网关：10.10.3.1
DNS1：10.10.3.5
DNS2：10.10.3.7

**4）子域控制器：**
计算机名：xiyou
域：xiyou.dayu.com
IP：10.10.3.6
掩码：255.255.255.0
网关：10.10.3.1
DNS1：10.10.3.6
DNS2：10.10.3.5

**5）财务部独立子域：**
计算机名：caiwu
域：dayu.caiwu
IP：10.10.21.2
掩码：255.255.255.0
网关：10.10.21.1
DNS1：10.10.21.2

IP：172.16.5.2
掩码：255.255.255.0
网关：172.16.5.1
DNS1：172.16.5.2

**6）财务部核心用户：**
计算机名：cai-xiao
IP：172.16.5.5
掩码：255.255.255.0
网关：172.16.5.1
DNS1：172.16.5.2

**7）子域用户：web服务器**
计算机名：user1
域：xiyou.dayu.com
IP：10.10.3.100
掩码：255.255.255.0
网关：10.10.3.1
DNS1：10.10.3.6

外网web-IP：192.168.253.35
掩码：255.255.255.0

**8）黑客的VPS服务器：**
IP：192.168.253.11
掩码：255.255.255.0

**9）黑客攻击系统：**
系统：Kali-linux和Windows


```

### 2、公司网络部署

主域控制器服务器 (Windows server 2016 + AD 域 + DNS 服务器)

主域控制器服务器计算机名称：dayu1

主域控制器服务器 FQCN(完全限定的域名)：zhuyu.com

辅域控制服务器 (Windows server 2016 + AD 域 + 备用 DNS 服务器)

辅域控制服务器计算机名称：dayufu

子域控制器服务器 (Windows server 2016 + AD 域 + DNS 服务器)

主域控制器服务器计算机名称：xiyou

主域控制器服务器 FQCN(完全限定的域名)：xiyou.dayu.com

财务独立控制器服务器 (Windows server 2008 R2 + AD 域 + DNS 服务器)

主域控制器服务器计算机名称：caiwu

主域控制器服务器 FQCN(完全限定的域名)：dayu.caiwu

其余都是个域控下存在的用户群体，以及核心数据系统等。

### 3、注意事项

> 辅域控制器安装 DNS 服务不用设置；
> 
> 安装辅域控制器, 如果主域控制器 DNS 和 AD 集成，辅域控制器会在安装 AD 后自动同步 DNS 记录；
> 
> 如果确定域环境不使用 IPv6 地址，主域控和辅域控安装前可以先把 IPv6 的地址关掉，域控的 DNS 服务器会优先获取 IPv6 的 DNS，配置进行关闭即可。

三、父域搭建
------

1、手动设置主域控服务器固定 IP 地址。  
![](https://image.3001.net/images/20210305/1614926041_6041d0d98999f7b6ae278.png!small?1614926046298)

2、开始 -- 服务器管理器  
![](https://image.3001.net/images/20210305/1614926049_6041d0e120ec772984bf9.png!small?1614926050096)

3、点击添加角色和功能  
![](https://image.3001.net/images/20210305/1614926056_6041d0e8bf6e18fc273a3.png!small?1614926057540)

4、勾选 Active Directory 域服务 -- 下一步  
![](https://image.3001.net/images/20210305/1614926062_6041d0eec76564ec053ac.png!small?1614926064480)

5、选择 “将此服务器提升为域控制器”  
![](https://image.3001.net/images/20210305/1614926070_6041d0f607699aaa54ed0.png!small?1614926071907)

6、选择添加新林 -- 填写根域名：dayu.com  
建议使用公司名称缩写进行命名，域名确定之后就不能在更改。  
![](https://image.3001.net/images/20210305/1614926075_6041d0fba23fb6f05fb16.png!small?1614926076930)

7、域控制器选项

1）选择林功能级别和域功能级别为：

```
windows server 2016


```

2）指定域控制器功能选择：

勾选域系统（DNS）服务器

全局编录（GC）

**全局编录解析：**

这里对全局编录做个解释。全局编录（global Catalog，GC) 全局编录包含了各个活动目录中每一个对象的最重要的属性，是域林中所有对象的集合。在域林中，同一域林中的域控制器共享同一个活动目录，这个活动目录是分散存放在各个域的域控制器中的，每个域中的域控制器保存着该域的对象的信息（用户账号及目录数据库等）。如果一个域中的用户要访问另一个域中的资源，则要先找到另一个域中的资源。为了让用户快速的查找到另一个域内的对象，微软设计了全局编录（global Catalog，GC)。全局编录包含了各个活动目录中每一个对象的最重要的属性（即部分属性），这样，即使用户或应用程序不知道对象位于哪个域，也可以迅速找到被访问的对象。

3）填写目录服务还原模式 (DSRM) 密码  
![](https://image.3001.net/images/20210305/1614926087_6041d1072c9f046bacba6.png!small?1614926088917)

8、默认下一步  
![](https://image.3001.net/images/20210305/1614926094_6041d10e66629ee8a4714.png!small?1614926095435)

9、NetBIOS 域名

系统会自动从 0~9 往后选择域名名称，可自行修改，这里默认选择即可。  
![](https://image.3001.net/images/20210305/1614926102_6041d1160d7979480bcd4.png!small?1614926103213)

10、AD DS 数据库、日志文件和 SYSVOL 位置默认即可  
![](https://image.3001.net/images/20210305/1614926108_6041d11ceddb897f9df5e.png!small?1614926110047)

11、先决条件检查

Windows server 2012 以上的版本安装域控制器会自动判断先决条件是否符合安装域控，如果不符合会出现红色感叹号！这里点击安装即可！

![](https://image.3001.net/images/20210305/1614926116_6041d12460fef93eeeeb8.png!small?1614926120436)

12、安装完成后，会进行自动重启，默认重启即可。  
![](https://image.3001.net/images/20210305/1614926124_6041d12caa8cbd743c475.png!small?1614926126763)

13、重启系统后，重新修改 DNS 为本机 IP 地址。

因为安装完成主域控制器后系统默认会把 DNS 设置成 127.0.0.1！  
![](https://image.3001.net/images/20210305/1614926131_6041d133c63ea8e38415b.png!small?1614926135163)  
![](https://image.3001.net/images/20210305/1614926138_6041d13a81e3772035f0b.png!small?1614926139738)修改完 IP 地址后，最好重启下域服务，或者简单的办法是直接重启下电脑即可。这样就完成了公司目标 -- 域森林中父域控制器（dayu.com）的安装，那么接下来根据规划添加用户进入父域。

**14、同步域控制器 DNS：**

现在主域控制器和 DNS 集成，为了让后期搭建完辅域控制器的 DNS 同步主域控制器 DNS，需要把主域控制器的 DNS 服务器_msdcs.dayu.com 和 dayu.com 的起始授权机构 (SOA) 区域传送设置成允许。

![](https://image.3001.net/images/20210305/1614926149_6041d14569f90d294a686.png!small?1614926153798)![](https://image.3001.net/images/20210305/1614926156_6041d14c1a9086e71ea69.png!small?1614926158915)允许区域传送到所有服务器即可！

到这里域森林中的主（父）域就完成安装了。

### 父域添加用户

根据一些需求，需要把多台计算机（fuyong...）添加到父域控制器中进行管理，这里拿 Windows Server 2008 R2 添加演示。

1、修改计算机名和加入父域：dayu.com

填写父域用户名密码即可加入！  
![](https://image.3001.net/images/20210305/1614926172_6041d15cb9a24fd8ace06.png!small?1614926175304)administrator/Dayu123

2、填写完用户名等待一会成功加入：  
![](https://image.3001.net/images/20210305/1614926179_6041d163a962cf0002a80.png!small?1614926180839)![](https://image.3001.net/images/20210305/1614926185_6041d169dd37a950f6462.png!small?1614926186260)

到这就讲 fuyong 这台计算机成功加入了父域控制器 dayu.com 中了。

四、辅域搭建
------

根据公司规划，安装了主域控制器之后，为避免出现单点故障，需要再部署一台辅域控制器备用。

1、测试连接

安装辅域控制器之前先把辅控制器加入主域控 dayu.com，为了测试主域控制器是否正常，同时也为了方便安装辅域控制器:

这里和添加父域普通用户入父域同样的方法：  
![](https://image.3001.net/images/20210305/1614926193_6041d171595dc9a73b304.png!small?1614926196397)

![](https://image.3001.net/images/20210305/1614926201_6041d179242d389fb71dd.png!small?1614926201927)可看到成功可以将辅域加入父域中，那么接下来开始辅域的搭建。

2、手动设置辅域控服务器固定 IP 地址。

这里开始 DNS 首选填写父域控制器 DNS，备用 DNS 填写辅域本地 IP 地址即可。  
![](https://image.3001.net/images/20210305/1614926209_6041d18112055c5fec3f2.png!small?1614926212290)

3、选择 “将此服务器提升为域控制器”  
![](https://image.3001.net/images/20210305/1614926216_6041d188598c72888eb77.png!small?1614926217315)服务器管理器 --- 角色 --- 添加角色。

4、部署配置

选择部署操作：

将域控制器添加到现有域

域名填写父域：dayu.com

填入凭证为父域的用户名密码：

这里需要注意的是，如果辅助域控之前没有加入主域控制器，我的当前登录凭据为灰色，只能选择备用凭据进行验证！  
![](https://image.3001.net/images/20210305/1614926222_6041d18ea329bb4b2fd11.png!small?1614926224661)

5、域控制器选项

默认选择域名系统（DNS）服务器和全局编录！

填入设置新的 DSRM 密码即可。  
![](https://image.3001.net/images/20210305/1614926230_6041d19601efbb35ac6cd.png!small?1614926231726)注意：本机已安装 DNS，所有没有提示，如果未安装 DNS 请勾选上 DNS 服务器。

6、其他选项

选择任何域控制器  
![](https://image.3001.net/images/20210305/1614926237_6041d19d1cb6e4a36a295.png!small?1614926238323)

7、路径

默认路径安装  
![](https://image.3001.net/images/20210305/1614926245_6041d1a55612320a3ef6b.png!small?1614926246982)

8、查看选项

可看到最后创建辅域的信息，默认下一步即可。  
![](https://image.3001.net/images/20210305/1614926256_6041d1b0b8c249fcd453b.png!small?1614926258657)

9、先决条件检查

无红色感叹号提示直接默认安装即可。  
![](https://image.3001.net/images/20210305/1614926264_6041d1b8062c99e2009db.png!small?1614926267873)

勾选 “完成后重新启动”。（辅域控制器安装完后系统会自动重启系统，辅助域控制器安装成功）

10、修改 DNS

重启完成后，修改下辅域首选 DNS 为：10.10.3.7

备用 DNS 为：10.10.3.5（父域 DNS）

![](https://image.3001.net/images/20210305/1614926270_6041d1bee2600824cdd9c.png!small?1614926274731)

11、最后一步

辅域控服务器重启后检查 DNS 服务器是否已获取到主域控制器传输过来的 DNS 服务器配置，检查正常后需要把辅域控制器的 DNS 服务器_msdcs.dayu.com 和 dayu.com 的起始授权机构 (SOA) 区域传送设置成允许。

![](https://image.3001.net/images/20210305/1614926277_6041d1c595114bd9e1f34.png!small?1614926279774)![](https://image.3001.net/images/20210305/1614926285_6041d1cdbff672c636207.png!small?1614926288552)  
![](https://image.3001.net/images/20210305/1614926301_6041d1ddbd19939463f71.png!small?1614926304122)![](https://image.3001.net/images/20210305/1614926308_6041d1e43a31f6484bee8.png!small?1614926311087)

安装辅域控制器, 如果主域控制器 DNS 和 AD 集成，辅域控制器会在安装 AD 后自动同步 DNS 记录，到此辅域就安装完成！

五、子域搭建
------

子域控制器安装搭建前先把 DNS 指向主域控制器的 IP 地址，然后委派完 DNS 再把子域控制器 DNS 指向自己即可。

父域控制器：dayu.com  
子域控制器：xiyou.dayu.com

1、配置固定 IP  
![](https://image.3001.net/images/20210305/1614926315_6041d1eb8a0d49eed5391.png!small?1614926319278)

2、修改计算机名 xiyou  
![](https://image.3001.net/images/20210305/1614926322_6041d1f21614a3fbb2506.png!small?1614926323301)

3、部署配置

选择部署操作：将新域添加到现有林

选择域类型：子域

父域名：dayu.com

新域名：xiyou

凭据：填写父域的用户名密码即可  
![](https://image.3001.net/images/20210305/1614926329_6041d1f904237642672a0.png!small?1614926330650)

![](https://image.3001.net/images/20210305/1614926335_6041d1ff617a31e609edb.png!small?1614926336891)

4、域控制器选项

域功能级别：windows Server 2016

指定域控制器功能和站点信息：

1）域名系统（DNS）服务器

2）全局编录

填写新的 DSRM 密码即可！  
![](https://image.3001.net/images/20210305/1614926342_6041d206baca7c11c645f.png!small?1614926344470)

5、DNS 选项

默认下一步即可!  
![](https://image.3001.net/images/20210305/1614926348_6041d20cc96de65716d61.png!small?1614926350424)

6、其他选项

NetBIOS：根据系统默认填写即可！  
![](https://image.3001.net/images/20210305/1614926355_6041d2131974255de7f7e.png!small?1614926356343)

7、路径

默认下一步

![](https://image.3001.net/images/20210305/1614926361_6041d2192f69896c1c65c.png!small?1614926362795)

8、查看选项

默认下一步  
![](https://image.3001.net/images/20210305/1614926367_6041d21fa05848c751cdc.png!small?1614926370897)

9、先决条件检查

无红色感叹号即可默认下一步执行!  
![](https://image.3001.net/images/20210305/1614926373_6041d225d265615e04658.png!small?1614926377330)

10、关闭，自动重启  
![](https://image.3001.net/images/20210305/1614926379_6041d22bea7fb4aa432f2.png!small?1614926382899)

11、重启完成后，手动将 DNS 首选和备用修改：

首选 DNS 选择子域 IP

备用 DNS 选择父域 IP

![](https://image.3001.net/images/20210305/1614926387_6041d233473ca9967e113.png!small?1614926390138)

到此就完成安装子域控制器！

### 子域添加用户

子域添加用户和前面父域添加用户情况一样，我就简单的演示一遍。

1、首先设置固定的 IP 地址  
![](https://image.3001.net/images/20210305/1614926394_6041d23a8ddd615596048.png!small?1614926394989)

2、修改计算机加入子域：xiyou.dayu.com

![](https://image.3001.net/images/20210305/1614926400_6041d240c0760cd8b8411.png!small?1614926401845)

3、填入子域控制器的用户名密码加入子域  
![](https://image.3001.net/images/20210305/1614926408_6041d24815078d3d42cb8.png!small?1614926408748)

4、检查

回到子域控制器，可看到成功加入！

![](https://image.3001.net/images/20210305/1614926420_6041d2549e91e27ccce96.png!small?1614926421376)

到此子域搭建已经完成，该子域承载独立经营的子公司，对未来管理和安全上有个非常好的提升。

六、独立域（财务部）
----------

根据公司需求，在搭建期间公司财务部希望使用特定的安全策略进行独立，规划后将财务部单独建立一个子域来单独管理，接下来演示搭建单独财务域。

1、根据需求搭建双网卡建立独立域

在子域用户上按图配置即可。  
![](https://image.3001.net/images/20210305/1614926429_6041d25dca5ee22d1eb33.png!small?1614926431202)

2、开始 - 运行 - 输入 dcpromo

对于 windows server 2008 R2 以前系统都可以用 dcpromo 进行搭建域环境。

![](https://image.3001.net/images/20210305/1614926436_6041d2647eef62080741f.png!small?1614926437140)

3、域服务安装向导

默认下一步

![](https://image.3001.net/images/20210305/1614926443_6041d26bcd90bcfd0e1f0.png!small?1614926446458)

4、部署配置

选择在新林中新建域

![](https://image.3001.net/images/20210305/1614926449_6041d2713ff38c51fc0ee.png!small?1614926449970)

5、命名林根域

命名独立域为：dayu.caiwu  
![](https://image.3001.net/images/20210305/1614926455_6041d27721035da4944eb.png!small?1614926455676)

6、设置林功能级别

这里默认是 windows 2003，需要修改为对应操作系统:

Windows server 2008 R2 即可！

![](https://image.3001.net/images/20210305/1614926460_6041d27cdac97630e2589.png!small?1614926462124)

7、域控制器选项

DNS 服务器勾选！

![](https://image.3001.net/images/20210305/1614926467_6041d28327fdd2fdefdc6.png!small?1614926467990)

8、默认是即可  
![](https://image.3001.net/images/20210305/1614926473_6041d28905dfa57bed43b.png!small?1614926474928)

9、默认路径下一步  
![](https://image.3001.net/images/20210305/1614926479_6041d28f0ff13d811ce97.png!small?1614926479781)

10、域服务安装向导

创建填写新密码 - 下一步  
![](https://image.3001.net/images/20210305/1614926484_6041d294482a6da71bac0.png!small?1614926485058)

11、默认下一步

可看到基础的创建信息。  
![](https://image.3001.net/images/20210305/1614926489_6041d299f36a51d788a28.png!small?1614926490645)

12、默认完成  
![](https://image.3001.net/images/20210305/1614926495_6041d29f7341ab20322a4.png!small?1614926497620)  
立即重新启动即可  
![](https://image.3001.net/images/20210305/1614926501_6041d2a56b9159facde60.png!small?1614926501889)

13、重启配置 DNS

安装完成重新启动后，DNS 默认 127.0.0.1

修改首选 DNS 为 10.10.21.2 即可  
![](https://image.3001.net/images/20210305/1614926507_6041d2ab3a80d7479c3f3.png!small?1614926508794)

14、完成安装  
![](https://image.3001.net/images/20210305/1614926512_6041d2b0762ed3e4a5616.png!small?1614926512965)

这里根据需求，单独域财务部门就建立完成了。

### 财务部添加用户

财务部建立后，高管人员单独建立了一个服务器，专门存放公司财务方面核心数据资料，需要加入到单独的财务部域中，这里加入的方法和父域、子域加入用户方法一样，开始演示。

1、这是固定 IP

可看到该核心系统 IP 信息：

IP：172.16.5.5

DNS：单独域 IP

![](https://image.3001.net/images/20210305/1614926522_6041d2ba0887db34a7362.png!small?1614926523156)

2、修改计算机名接入域：dayu.caiwu 即可

输入单独财务域的用户名密码  
![](https://image.3001.net/images/20210305/1614926527_6041d2bf2194a5e7014ea.png!small?1614926529284)

3、成功接入单独域

![](https://image.3001.net/images/20210305/1614926532_6041d2c4f16f921809841.png!small?1614926535135)  
重启即可  
![](https://image.3001.net/images/20210305/1614926538_6041d2cadb76aec0c609d.png!small?1614926539470)

4、重启查看成功加入域：dayu.caiwu  
![](https://image.3001.net/images/20210305/1614926544_6041d2d045b1ac5975a96.png!small?1614926545910)回看单独域配置发现，已成功可控 CAI-XIAO 计算机  
![](https://image.3001.net/images/20210305/1614926551_6041d2d704cd839468bfb.png!small?1614926552374)

到这里单独域就已经建立完成，并加入核心系统进行管理。

七、总结
----

到此成功搭建了内网环境，也模拟了公司和需求进行配置用户，搭建环境对于渗透人员来说，是最基本的必要条件，不会搭建环境都不熟悉整个环境就难以进行大型内网渗透。

接下来公司内网按照需求进行完成搭建后，由于公司员工安全意识不足，安装下载了恶意程序，被黑客成功进行钓鱼，并控制了外围的电脑，接下来篇章将演示如何在 dayu 公司进行内网渗透遨游！

希望大家提高安全意识，没有网络安全就没有国家安全！

今天基础牢固就到这里，虽然基础，但是必须牢记于心。

作者：大余