<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/g7LZ9h7-c-H75-uJqhKt3g)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
==============

**大家好，我是 ABC_123，公众号正式更名为” 希潭实验室”，敬请关注**。本期分享一个堪称史上影响最大、危害最大的供应链攻击 APT 案例——Solarwinds 供应链攻击事件，SolarWinds 的旗下有数万家客户公司，包括了” 财富美国 500 强 “企业、美国所有前十大电信业者、美军所有五大部队、美国国务院、国家安全局，以及美国总统办公室，美国多家顶级网络安全公司等，最终有大约 1 万 8 千家公司安装了含有后门的 Orion 网管软件更新包，APT 组织挑选了 50 多家主要公司单位进行内网横向渗透。

注：攻击者入侵美国 Solarwinds 公司，属于**上游软件供应链攻击**范畴，而通过 Solarwinds 转而入侵美国关键基础设施 OEM 制造商，属于**产业供应链攻击**范畴，因而此 APT 攻击事件影响深远，危害巨大。

此次 APT 供应链攻击事件异常复杂，ABC_123 重新整理国内外英文报告，结合自己的网络安全实战经验，一字一句对各种分析文章反复校勘，力图还原整个入侵事件的真实全貌，给广大的网络安全从业人员提供一个参考，**更好地为祖国的网络安全事业做出贡献**。

 **Part2 前置知识介绍** 
==================

*   **APT 流程图及攻击过程简介**
    ------------------
    

首先放出一张 ABC_123 绘制的关于 Solarwinds 供应链攻击美国关键基础设施的流程图，是从大量的国内外关于此次攻击事件的报道中归纳整理出来的，接下来依据此流程图，详细讲解整个入侵流程。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnBymw2xQcs7oiaxfjDCFcsJqkVMr4AibWP12nG1zdaNbiauV4Ljme7l9Ysw/640?wx_fmt=png)

**攻击过程：**攻击者首先入侵了美国 Solarwinds 网络管理软件公司内网，接着获取了所有源码编译服务器的权限，通过编写的 Sunspot 工具（一款后门投递及源码修改工具）监视旗下 Orion 网管软件更新包的源码编译过程，从源码层面植入 Sunburst 后门程序，**编译后**自带 Solarwinds 合法数字签名 Solarwinds Worldwide，LLC****，这种方式自带白名单效果，完美绕过各种防护措施。等到 Solarwinds 官方下发软件更新包后，导致旗下数万家 Orion 客户公司内网沦陷。

*   **攻击武器及后门介绍**
    -------------
    

接下来，ABC_123 介绍一下此次 APT 供应链攻击过程中，攻击者所使用的各种攻击武器，以免大家阅读文章时，被这些工具的英文名称弄得云里雾里的。

 **1   第一阶段武器：**

**分发工具：**这个工具没有具体命名，用于将 Sunspot 攻击工具，批量投放到 100 多台编译虚拟机中。

**Sunspot：**用于监控 Orion 源码编译过程，通过一系列复杂操作，在 Orion 更新包源码中植入 Sunburst 后门代码。

**Sunburst：**这是一款极其复杂且隐蔽的后门，当用户运行 Orion 安装包之后，**这款后门会等待 12 到 14 天后触发**，然后使用 DGA 域名通信方式，将受控服务器的域名、计算机名等初始信息发送给 C2 服务端。

 **2  第二阶段武器：**

**Teardrop：**Loader 程序，由 SUNBUSRT 提供，从隐写图片中提取恶意 shellcode 并加载执行，最终上线 Cobalt Strike。

**Raindrop：**Loader 程序，与 Teardrop 不同的是，它主要用于内网横向传播，攻击者为了隐藏攻击行为，通过修改 7-zip 源码将 Raindrop 编译为 7-zip.dll 文件，用于后续加载执行自定义 CS 的 shellcode。

 **3   第三阶段武器：**

通过第二阶段的 Loader 程序，植入 **Cobaltstrike**、**GoldMax**、**SiBot**、**Goldfinder** 等适用于不同场景的后门程序。

经过国外安全公司的分析，**攻击者刻意地隔离 Sunburst 与 CobaltStrike 这两阶段后门**，是为了便于受害者在发现并应急清除 Cobalt Strike 后门之后，仍能保护 Sunburst 后门的存在，做好权限维持工作。

 **Part3 APT 供应链攻击全过程** 

*   **获取外网服务器权限**
    -------------
    

经过国外安全公司评估，组织如此庞大规模的供应链攻击行动，涉及制定方案、模拟演练、准备攻击基础设施、前期侦察、定制化开发武器和指挥控制平台、获取目标网络初始权限、后期渗透拓展等一系列工作，**需要动用超过 1000 名的工程师支持**，后期为了排查溯源此次 APT 攻击事件，**微软就动用了 500 多名安全工程师来排查**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnBjbeDdW4LWvX2icicMEEoK3iaFeUSiaAGeRg4mqBjX900Uj1QP30wTRMrfg/640?wx_fmt=png)

自 2020 年 12 月 12 日，此 APT 攻击事件被曝光之后，该 APT 组织是如何获取 solarwinds 外网权限的，一直没有一个让大家信服的调查结果，目前普遍认为有以下几种可能：

 **1  Github 密码泄露**。在 2019 年，一名安全人员在 github 上发现了泄露的服务器弱密码 solarwinds123，经过调查，Solarwinds 公司一名实习生于 2017 年在个人的 github 贴出了自己的密码 solarwinds123，使用该密码可以登录外网的 solarwinds 的更新服务器。

 **2  暴力猜解弱口令**。solarwinds123 是弱密码，攻击者也可能是通过暴力破解方法猜解成功的，而 solarwinds123 这个弱密码至少在 2017 年就已经在用了。

 **3  Office365 服务漏洞**。2019 年 2 月，发现攻击者窃取了 Solarwinds 公司员工的 Office365 账号，疑似通过微软的 Office365 服务的漏洞获取了相关权限，但是微软官方坚决否认。

*   **在 Orion 网管软件源码编译过程中植入测试后门代码**
    -------------------------------
    

在获取外网权限之后，该 APT 组织进行了非常隐蔽的内网横向渗透，花费很长时间和精力，对内网网络拓扑及源码编译服务器进行了充分的信息收集，最终获取到了 Solarwinds 源码构建服务器的全部权限。

经过长达几个月的评估和分析，该 APT 组织制定了一个疯狂的计划：**在 Solarwinds 网管软件 Orion 的源码中植入后门代码**，这样生成的更新包由于带有 Solarwinds 的正常的数字签名，可以绕过各种杀软防护，等到 Solarwinds 公司给客户下发 Orion 软件更新包时，就可以获取旗下数万家客户公司的全部权限，这就是上游供应链攻击的巨大威力。

计划听起来很炫酷，但是实施起来难度非常大，为了使这个计划能够实施成功，**该 APT 组织耗时整整一年多的时间进行准备**。接下来 ABC_123 就列举出几个关键的时间节点，让大家对 APT 组织的严密工作计划有个直观的认识。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnBI4Rke4eWImQnKib4ia7a46aJ5u5FwRfCjdFzN2My31ibq2OOIUB4APXlw/640?wx_fmt=png)  

**2019 年 1 月 30 日，**该 APT 组织登录了一个员工的 VPN 账号，猜测是寻找并分析 SVN 源码服务器。

**2019 年 1 月 31 日，**也就是第 2 天，攻击者再次登录此 VPN，下载了超过 129 套 Solarwinds 产品的源代码，并获取了大量的用户信息，推测是为了分析 Solarwinds 公司哪些客户使用了哪些产品，为后续供应链攻击做准备。之后攻击者消失了 2 个月，在这段时间内，该 APT 组织深入分析这些源代码，并且分析客户对不同 Solarwinds 软件产品的使用情况，争取最大化地利用这些源码。**最终他们发现 Solarwinds 公司旗下的 Orion 软件是实施供应链攻击最完美的选择**，因为这款软件用户群体大，在客户网络中占据了特权位置，而且与许多其他服务器连接和通信，非常便于横向渗透。

**2019 年 3 月 12 日，**攻击者重新访问了软件构建环境，然后又消失了 6 个月。Orion 软件的构建环境非常复杂，一个新招聘的程序员需要花费数月时间才能掌握。**在随后的 6 个月时间里，攻击者创建了 Orion 源码构建环境的副本**，然后编写后门代码，后门代码的编码方式及命名规则特意模仿了 Solarwinds 原公司程序员的习惯，以至于后期安全人员多次排查，都没发现是异常代码。随后不断尝试在源码编译过程中，插入后门代码，不断地测试，解决各种可能出现的意外情况，**争取生产环境中可以一次成功**。

**2019 年 9 月 04 日，**也就是在 6 个月后，攻击者再次访问了源码构建环境，此时从记录的操作日志来看，**攻击者的操作已经显示出源码方面专业的技能**，说明他们花费巨大的时间和精力对源码进行深入研究与测试。

**2019 年 9 月 12 日，**攻击者在 Orion 网管软件的源码构建中植入了无害的测试代码，推测是在进行 “无损” 测试，也就是为了测试是否能在生产环境中完成源码替换操作而不被注意，然后他们静静等待 Orion 软件更新。在这段时间里，**他们利用获取到的几十个关键高管和安全人员的邮箱账号，秘密跟踪监视 Solarwinds 公司是否发现此次入侵行动**。

**2019 年 10 月 26 日，**攻击者对 Orion 更新包源码进行了小幅度修改，添加了空类代码，但不含后门代码，测试是否可以通过 Orion 源码编译服务器，并且成功发布。终于 Solarwinds 公司发布了攻击者第一个修改的 Orion 软件版本 2019.4.5200.8890 版本，攻击者发现被自己修改的无害的 Orion 源码被成功编译，说明一切准备就绪。

**2019 年 11 月 04 日，**攻击者正式完成所有测试工作，这时候已经过去差不多一年的时间，可见攻击者的充分准备和打持久战的决心。

*   **使用 Sunspot 在生产环境植入后门**
    ------------------------
    

Sunspot 工具一旦被运行，会提升自身调试权限，通过添加计划任务，每 11 分钟执行一次，**监视 Orion 软件的编译程序 MSBuild.exe 的编译过程**，通过获取 MSBuild.exe 的命令行参数，获取 Orion 代码包中 core.sh 解决方案文件的绝对路径，进一步找到 InventoryManager.cs 源代码的路径，将此源代码文件备份为 InventoryManager.bk。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnB0X1DJCkTnnOZia6W9j9TsrOOY4kpgz8ffPF7yLLibVSlOCXH6NNkRhXQ/640?wx_fmt=png)

然后 Sunspot 从自身解密出含有 **SunBurst** 后门的经过 APT 组织修改的 InventoryManager 源码文件副本，把即将正式发布的 Orion 源码中的原始 InventoryManager.cs 代码给替换掉，**该后门代码最终会被编译在 SolarWinds.Orion.Core.BusinessLayer.dll 文件中**，而且自带 Solarwinds 数字签名，最后被打包在更新补丁安装文件 **CORE-2019.4.5220.20574-SolarWinds-Core-v2019.4.5220Hotfix5.msp** 中。

当 Orion 网管软件的用户安装补丁包时，一旦 SolarWinds.BusinessLayerHost.exe 或 SolarWinds.BusinessLayerHostx64.exe 运行，就会调用 SolarWinds.Orion.Core.BusinessLayer.dll 中的 Sunburst 后门代码，从而导致安装更新包的用户被种植后门。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnBEFibp6XDibfTwkWIoaHKjqYGcmVFWGfgibpGu4VKM3b9BprA0UsYibFd8g/640?wx_fmt=png)

*   **植入后门过程遇到难题**
    --------------
    

**2020 年 2 月 20 日，**攻击者向软件构建服务器植入了 Sunspot 工具，然后一直潜伏在软件构建服务器中。

**2020 年 3 月份，**Solarwinds 开发人员开始使用 JetBrains 公司出品的 TeamCity（TeamCity 是捷克软件开发公司提供的构建管理和持续集成服务器）构建 Orion 的软件更新包，**该编译软件启动了 100 多个编译虚拟机**，这些虚拟机是临时创建的，一旦编译工作结束就会自我销毁。此时攻击者遇到了麻烦，每台编译虚拟机各自负责编译 Orion 网管软件的不同模块的代码，他们不知道哪一台编译虚拟机会编译 SolarWinds.Orion.Core.BusinessLayer.dll 文件或者打包此 dll 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnBAE37PMaIzZM6JCPlrUtpSvDyOr64oIpJvFpJkKOU641tLg9cCqLayg/640?wx_fmt=png)

*   **批量投递 Sunspot 工具**
    -------------------
    

于是攻击者专门设计编写了一个工具，向 100 多个编译虚拟机投放 Sunspot 工具。在每一台编译虚拟机上，Sunspot 会创建计划任务，监视 MSBuild.exe 编译过程。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnBVqk12U9zUrOEk1MmW4k4FvgpStaWPV0VrUdicD1lrHKyibovVHp8R1fw/640?wx_fmt=png)

一旦发现 SolarWinds.Orion.Core.BusinessLayer.dll 出现在服务器上，立即将合法源码文件重命名，替换成含有后门 Sunburst 版本的 dll 文件，**整个过程只有几秒钟的时间，实现难度非常大**，同时也说明攻击者事先做了多么充足的准备，也间接理解了该 APT 组织为何耗时一年的时间来测试。然后 Sunspot 会将原有合法的 dll 文件恢复，从所有虚拟机中将自身删除，清理痕迹。

*   **借助 Orion 更新包入侵下游客户公司**
    ------------------------
    

Solarwinds 官网每隔一段时间，都会向旗下客户分发 Orion 软件的更新补丁安装包，自 2020 年春季以来，Solarwinds 官网已经向多达 18,000 名 Orion 客户发布了更新补丁安装包，如果这些客户的 Orion 服务器对外网开放访问，就会导致安装包内置的 Sunburst 后门程序被触发。（以下这张图来源于网络）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnB5gS8lYJmen63TbBpKFUpMkxvPDBGBoIR1vdeMHiapb9XKCG5F77h8dQ/640?wx_fmt=png)

当受害者安装该补丁包期间，会运行 SolarWinds.BusinessLayerHost.exe 或 SolarWinds.BusinessLayerHostx64.exe 程序，**接着调用 SolarWinds.Orion.Core.BusinessLayer.dll 文件**，然后隐藏在此 dll 文件中的后门 Sunburst 会被触发，从而导致客户的 Orion 网管服务器被控。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnBysDO1ibo84eZCwSsodTozDKDmaCgUBPs2haQZdRAc5IaibFkPicO153ibQ/640?wx_fmt=png)

这样的结果会导致 18,000 家客户公司被感染 Sunburst 后门，对 18,000 家公司的内网进行渗透，显然是不现实的，而且动作太大，容易暴露 APT 攻击计划，**于是该 APT 组织选了 50 个左右的重要目标进行横向攻击**，包括美国财政部、司法部、微软公司等。如上图所示，这些是被公布出来的所有被入侵的厂商列表，对于其它价值不大的入侵目标，该 APT 组织会发送终止指令，使 Sunburt 后门永久退出和自我销毁。

值得注意的是，谷歌公司也使用了 Orion 网管软件，但是由于其内部严格的安全防护措施，谷歌相关负责人很有信心地表示，谷歌没有遭受 Solarwinds 供应链攻击，后续也证明确实如此。

*   **Sunburst 后门启动**
    -----------------
    

一旦含有 Sunbrust 后门的 dll 文件被调用执行后，不会立即触发执行恶意操作，会随机等待 12 到 14 天，**这样做的目的是让全球 1 万 8 千多家 Orion 软件用户的被控服务器逐步上线**，避免集中上线被流量监控设备发现并告警，导致计划败露。

之后 Sunburst 后门会使用 DGA 域名与 C2 端通信，收集受害者主机环境及计算机信息发送给攻击者，攻击者会根据这些信息去判断该单位是否值得进行下一步的入侵。

如果目标很重要，**会进一步投放 Teardrop 工具或者 Teardrop 工具**，这两款工具是恶意代码加载器 loader，其中 Teardrop 加载器会下载 4 种图片，并且结合图片隐写技术提取出隐藏的 shellcode，然后由 Teardrop 加载执行。

如果目标不重要，攻击者会通过 C2 发出指令，使 Sunburst 退出或者永久禁用。尽管攻击者感染了成千上万台服务器，但他们只挑选了 50 个左右的重要单位进行深入渗透，这样可以集中精力搞重要目标，在搞少量且重要的目标时，也可以减少精力的分散，防止被安全防护系统捕捉到攻击行为。

*   **无意中留下后门样本**
    -------------
    

攻击者在隐藏自身及过流量检测方面做到了极致，以至于安全团队在溯源这起攻击事件时耗费时间长达数月之久。**攻击者通过监控 Solarwinds 的公司邮件**，得知受害者已经察觉了攻击行为，所以果断删除了所有虚拟机的 Sunspot 工具，那么安全人员是如何发现 APT 组织遗留的攻击武器及样本呢？

**正所谓天网恢恢，疏而不漏**，这源于一次源码编译产生的意外。在大约 2020 年 2 月左右，一台编译虚拟机在软件构建过程中出现错误，接着 TeamCity 创建了一个虚拟机快照，该快照包含故障发生时虚拟机的所有内容，方便研发工程师分析故障。正常情况下，SolarWinds 研发工程师会在后续删除这些快照，但是不知道为啥没有删除。幸运的是，这个虚拟机快照中正好保留了 Sunspot 工具，更幸运的是，软件工程师一直没有删除此快照。**这个意外成了溯源出整个 Solarwinds 供应链攻击的唯一线索**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnBtRcruicAzXncg76WoiaeiaXPtB9bE1Rlvb0icQ7I7I2hH1eqLcD09DQrkw/640?wx_fmt=png)

*   **攻击者收手，清理痕迹**
    --------------
    

**2020 年 6 月 4 日前后，**Solarwinds 的客户发现了一些来自 Orion 网管服务器的异常流量，并联系了 SolarWinds 公司讨论此事。该 APT 组织通过监视 Solarwinds 公司的部分人员的邮件往来，发现自己的攻击行为有可能暴露，于是删除了在 Orion 软件构建环境中的 Sunspot 和 Sunburst 后门样本。

**2020 年 11 月 26 日，**攻击者最后一次登录 Solarwinds 的 VPN 账号，然后持续监视 Solarwinds 高管和安全人员的邮件往来，猜测是为了得知攻击事件的溯源进展。

**2020 年 12 月 12 日，**国外安全人员首次报告 Solarwinds 供应链后门事件，在安全圈引起轩然大波。但是大家需要注意的是，该 APT 组织入侵 Solarwinds 公司已经过去了至少两年的时间，而没有被发现。

**2020 年 12 月 18 日，**FireEye、微软、GoDaddy 公司接管了 Sunburst 后门通信的 C2 域名，将相关域名的解析 ip 更换为 20.140.0.1，根据后期对后门样本的逆向分析，根据其内置规则，**当 C2 域名解析的 IP 地址为 20.140.0.0/15 时，Sunburst 后门会永久终止运行**（攻击者非常聪明，控制 C2 的域名解析到不同的 IP，然后 Sunburst 后门会根据域名解析 ip 的情况去执行不同的操作，这个过程 ABC_123 会在下一篇文章详细讲解）。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450AGCrxfmibbeibTxEdMQXpKnBZAnALEic5gtkpfpvQEiaTfzDlyDsX4gVz85y8a0sAtpKv8epN6MBCeCg/640?wx_fmt=png)

*   **APT 攻击组织判定**
    --------------
    

究竟是哪一个 APT 组织实施的，目前官方仍然没有一个定论。卡巴斯基研究人员发现，在算法上面，**SUNBURST 后门与俄罗斯 APT 组织 Turla 使用的 Kazuar 恶意软件存在许多相似之处**，因此判断与俄罗斯 APT 组织有关；国外相关知情人士认为是有俄罗斯背景的组织 APT29，但没有任何确凿证据；还有报道说是由美国政府发起的，自己人打自己人。

**个人看法：**从后门的实现功能和设计理念上看，就不像是美国国家 APT 组织实施的。美国的网络武器库中，随便挑选一种后门程序都比第三阶段的后门要实用，实在没必要使用被安全人员分析透的 CobaltStrike 远控，当然我这里指的不是第二阶段的后门 Sunburst。

综上所述，我个人更倾向于这个观点：俄罗斯 APT29 组织发起此次 Solawinds 供应链攻击。

 **Part4 攻击事件总结** 
==================

**1.**  该 APT 组织编写的 Sunspot 工具、Sunburst 后门，所使用的技术是非常高超的，对应着 APT 攻击事件的 Advanced，高级的技术。

**2.**  APT 攻击者为了实施此次 APT 供应链攻击，在搭建源码编译测试环境及编写后门代码方面，准备了长达一年的时间，对应着 APT 攻击事件的 P，持久性及绕过各种防护。

**3.**  该攻击事件影响了 1 万 8 千家 Orion 客户公司，成功入侵了美国 100 个左右的核心单位，对应着 APT 攻击事件的 T，危害性。

**4.**  如果 Oriaon 客户公司事先按照 Solarwinds 的安全操作规范，将 Orion 网管软件服务器配置为只与 SolarWinds 官网通信，或者放在防火墙后面隔离，那么 Sunburst 后门由于无法外连的原因而攻击失败，但是包括微软公司、Mandiant 安全公司在内的许多数受害者没有这样做。

**5.**  在此次攻击事件溯源的最初的几天里，团队们被要求只能通过电话和外部账户进行沟通，**防止攻击者通过监视邮件往来得知溯源工作的最新情况**。

**6.**  后续 ABC_123 会专门写文章介绍 Sunburst 后门的设计思路，如何绕过层层流量监控以及美国网络安全公司如何将此次攻击事件溯源出来的，敬请期待。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。

Contact me: 0day123abc#gmail.com(replace # with @)