<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/tncZLn-WdKA62Vnn1epKsw)

前言


------

菊哥某日给我发了一个样本, 告诉我这个冲锋马写的非常牛逼，都被提交三年了在 VT 上竟然依然是全绿，让帮忙分析一下是咋搞的。

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLddPuB0Z2WIPCL3sJVDRAyribG3aDVXjtR7kBEBwUURZSbznHO3AfBLng/640?wx_fmt=png&from=appmsg)

看了一下 VT 的提交时间是 2019 年，重新提交分析一下，竟然依然是全绿；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdK0Gic1tZqUIN6cicexkps6e8jzQ2TsDlynguP2IPMmlSUiaoagWxZl6SA/640?wx_fmt=png&from=appmsg)

我现在有点怀疑这个样本是不是真的是黑的了，然后又跟菊花哥确认了一下，就是它。不得不说杀软很无奈，你知道杀软这三年都是怎么过的么？下面开始一点一点解开它的神秘面纱。  

样本特征分析


----------

首先看一下样本图标和属性信息

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdOM491u5Y3IqYDCCLUEDGAhu7R4kym8pgjHTSaXunTCHhmsY9NXxUJw/640?wx_fmt=png&from=appmsg)

  

```
VS_VERSION_INFO.StringFileInfo.040904b0.CompanyName:Tencent
VS_VERSION_INFO.StringFileInfo.040904b0.FileDescription:QQ浏览器
VS_VERSION_INFO.StringFileInfo.040904b0.FileVersion:10.3.2816.400
VS_VERSION_INFO.StringFileInfo.040904b0.InternalName:bug_report_exe
VS_VERSION_INFO.StringFileInfo.040904b0.LegalCopyright:Copyright 2018 Tencent. All rights reserved.
VS_VERSION_INFO.StringFileInfo.040904b0.OriginalFilename:BugReport.exe
VS_VERSION_INFO.StringFileInfo.040904b0.ProductName:QQ浏览器
VS_VERSION_INFO.StringFileInfo.040904b0.ProductVersion:10.3.2816.400
VS_VERSION_INFO.StringFileInfo.040904b0.CompanyShortName:Tencent
VS_VERSION_INFO.StringFileInfo.040904b0.ProductShortName:QQ浏览器
VS_VERSION_INFO.StringFileInfo.040904b0.LastChange:713bc9f76cb50125fdd45c5a1681158adfff5709
VS_VERSION_INFO.StringFileInfo.040904b0.Official Build:1
VS_VERSION_INFO.StringFileInfo.040904b0.SpecialBuild:1023
VS_VERSION_INFO.StringFileInfo.040904b0.CipVer:10016
VS_VERSION_INFO.StringFileInfo.040904b0.UrlVer:1
VS_VERSION_INFO.VarFileInfo.Translation:04b00409


```

一看图标和伪造的版本资源信息，这个是钓鱼马无疑了，这里看到它伪造的是  QQ 浏览器的 `BugReport.exe`的 `10.3.2816.400`版本。

看一下字符串信息，还真的就是 QQ 浏览器的字符串。

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLd1q8m1PE3yocjkCwPYSQtibBJ5HTBTC2uJzLkxq5YtNw7bgQSqxxsc0g/640?wx_fmt=png&from=appmsg)

这让我怀疑它是不是直接拿 QQ 浏览器的 `BugReport.exe`直接二进制 patch 的，于是赶紧从网上找了一个对应版本的原程序进行了一下对比（原程序的 hash 在文末提供）。

先用 010editor 来对比一下：

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdjcfVnrOPB4y0fKbicadxZW1icibvuVZrKaNoDTAKLJ04HDEfvMhogAMPQ/640?wx_fmt=png&from=appmsg)

可以看到除了 .rsrc section 的大小不一样之外，其他的都是一样的，.rsrc 大小不一样也可以理解，毕竟图标被替换了。

我们知道恶意代码肯定是存在. text 中，着重比对一下 .text section 的差异，我最开始是用 ida 看了一下 winmain 函数，发现竟然一模一样。

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdG6tosDnAXQyea6sicQrnyWTNkoSbm9JiaCajXOHZSxx4f6icoq42ffE7A/640?wx_fmt=png&from=appmsg)

面对几千个函数我陷入了沉思，我怎么知道哪个函数被修改成恶意的了？

这里首先想到使用 bindiff 看一下，发现存在不少函数是不一致的，而且由于 bindiff 的算法问题，他是基于最高相似度进行函数匹配的，并不是基于相同地址进行匹配的。

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdk4HXrbl0wqJMxMCVqicIh2wjvb8zCTsPGZpskb57UiaJcaCg6gDuUpsg/640?wx_fmt=png&from=appmsg)

很多不匹配的，还有匹配错误的，也就是说这个 bindiff 也并不能帮我定位出来哪里代码被修改了。

不过我的需求也简单，只要找出来哪些地址的代码被修改了，定位出来区间，然后做一个小的容错，就可以了，下面是最终的结果：

```
[
   ('0x421dcf', '0x421e89'), ->长度：184 
   ('0x425679', '0x4264f6'), ->长度：3707
   ('0x4589f4', '0x459ac6')  ->长度：4306
]


```

可以看到，这三个区间的代码被修改过，接下里在这三个区间的起始地址都打上断点，开启一波调试分析。

调试分析
----

很快就在第一个断点断下来了；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdQuLHxfdNYuibJwTSTKQAHJGIH1pA9euibTqrIOMxnR7fFRUmd0BkHDOQ/640?wx_fmt=png&from=appmsg)

我们跟踪一下调用栈；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdmuL9TibwKIcOyeAvibDo2mSpl3MldQKLXFicTmfvQy3uzpM13V3QmEa9A/640?wx_fmt=png&from=appmsg)

是从 winmain 函数中调用过去的；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdqawzHG5AGeKBhpbMYIF4obQdCj1AaLzorD2dDib3VYjhHxF7Xw3gwibA/640?wx_fmt=png&from=appmsg)

**很明显这个恶意代码编写者是 patch 了原程序 WinMain 调用的一个函数的代码，然后从这里作为恶意代码的执行入口，后续再内存中布局其他的恶意代码，来依次调用达到隐藏的目的**

简单的看了一下这个函数的代码，发现被加入了很多垃圾代码；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdDeexsVAPicGwgbETqGjMTaAep9sRygLnzsqqtuoTeOvb455EwlY4nLw/640?wx_fmt=png&from=appmsg)

这种垃圾代码后续会不停的出现，不过是比较小儿科的垃圾代码，所有的分支都不会进入，这里直接忽略就好了，关键是下面的那个 call，跟进去之后会发现我们进入了第二段被修改的代码区间  0x425679；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdDVwcicaoz7CO8jF1C4SkulvKicpOibFOGu6Qzs5hF5aJYqLFOyn32DsbA/640?wx_fmt=png&from=appmsg)

又是一大堆的垃圾代码，跳过一大堆没有用的，可以看到这个函数一直在不停的调用函数 0x0042604E

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLd3Ft4seWr5X1YibLXfbqPAwJj9ojIibDiaiaQEiaoic2D2jKuCCCYtW944Fvw/640?wx_fmt=png&from=appmsg)

根据经验可以知道，此函数的功能是 getprocessaddr_by_hash ；随后将此函数获取的所有函数地址都标记上符号方便静态观察；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLd7ceYqLHib81OxD0vsSryPOy4ficosHfXmDCls21UiaFU9fOx1HaNiaZUYw/640?wx_fmt=png&from=appmsg)

继续调试，发现会把所有获取的地址存放在一个数组中；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdTSOvnfurNvNglIPejudQqZykSbcDE56HpRLaEFHU8pRYcXmRysl9Jg/640?wx_fmt=png&from=appmsg)

接下来还用说吗？赶紧把这些函数打上断点呀。

看到这里大头基本上已经分析的差不多，下面展示一些细节

### 反沙箱

继续分析会看到一个明显的反沙箱操作；之前历史文章中也总结过过这种方法；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdCZ1vYRJNclbjxEnFXjA7lCZvw5x4lBG6IyLKHPwzm7GeLPcwfUiaw6A/640?wx_fmt=png&from=appmsg)

创建一个线程 sleep  83s，然后使用 waitForSingleObject 等待这个线程返回，等待时间是 80s，如果没有超时说明 sleep 函数被加速了，那就是沙箱。

### 反调试

反调试还是利用 waitForSingleObject , 等待线程的返回；不过这次是等待 0s，如果没返回 v38 就加一；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdm0RTtLtQdjhBfSEfjqxGWJJVBiaJwbBnOIH2VEsJOzErC75VJnPp7IA/640?wx_fmt=png&from=appmsg)

只有等 v38 > 0x26000 的时候才会执行恶意代码；

如果是单步调试的话，v38 可能不会大于 0x26000; 同时这里也是一个对系统性能的判断，如果性能比较差也不会 > 0x26000.

### c2 地址

继续跟踪会发现 IP 地址解码函数；

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdzqezKayeWADiazaWYKWYibSVFeD39OMDsjUxaJFVXIniaIUXhEbiaicqclA/640?wx_fmt=png&from=appmsg)

继续跟踪发现使用的 User-Agent;

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLd2fx7vibaicgaL8W0ySZCicEdiaj1RppJddiaiaucW6ccuyQKibjalLmHm7CkQ/640?wx_fmt=png&from=appmsg)

最后找到请求的 url 地址：

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQVlC4fBibgnhlghU4GgyqLdhf8Vcj6ZjENGsPbAl8wib2vI16YaY8DPwXLFulh2nGvaRymuT1Xcgog/640?wx_fmt=png&from=appmsg)

https://39.xx.xx.xx:443/kumoko/wakaba.bmp

总结
--

此二进制用的技术方法；

*   直接 patch 原始二进制，保留原文件的字符串、统计特征、资源等，防止被杀软识别
    
*   时间流速反沙箱
    
*   反调试
    
*   垃圾代码、虚假控制流混淆视听
    
*   独立编写的 shellcode，防止被识别
    
*   混淆比较小儿科，分析起来比较简单
    
*   **此样本所使用的技巧在知识星球都分享过**  
    

参考
--

*   被修改的原文件：e20d0311a9e436c08ecb72c349903b22
    
*   c++ 元编程混淆: https://t.zsxq.com/18uscKY7U
    
*   时间流速反沙箱方法：https://t.zsxq.com/18OTtZlIb
    

安全的矛与盾  

=========

我们的知识星球 "安全的矛与盾" 是一个既讲攻击也讲防御，开放的、前沿的安全技术分享社区。在这里你不仅可以学习到最新的攻击方法与逃避检测的技术，也可以学到最全面的安全防御体系，了解入侵检测、攻击防护系统的原理与实践。站在攻与防不同的视角看问题，提高自己对安全的理解和深度，做到: **知攻、知守、知进退；有矛、有盾、有安全。**

**更多的干货内容，更深入的技术交流，尽在知识星球 “安全的矛与盾”，欢迎大家扫码****加入！****有问题请咨询微信** Manliness_man

![](https://mmbiz.qpic.cn/mmbiz_png/ibpscEmmu0YQKmUO8873ac1kAmc7FV2I3CxkeZibkQxvictqaicf6ZC6DBmHaH7VLPvnNAuLibMaENvmI4j8YtOGFLg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)