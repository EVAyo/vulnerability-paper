<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/byy_gahujxJIpXf9A9aJmQ)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9Lbc0INLwTJTZT1GaNutZrfDn6csvjBoS2ox0efLUEexXqPEcVbYfbLo8w/640?wx_fmt=png)

 **Part1 前言** 

此案例源于一次对金融系统的漏洞挖掘，主要漏洞点集中在 CSRF 跨站请求伪造漏洞上，印象比较深。这个系统经过各个厂商 N 轮测试了，功能点又少，漏洞挖掘的难度很大，但是最终还是挖到了几个影响较大的 CSRF 漏洞，接下来把测试过程分享给大家。

 **Part2 技术研究过程** 

*   **CSRF 漏洞测试**
    

CSRF 漏洞的测试很简单，首先使用 burpsuite 对重要操作抓取一个数据包（这里用虚拟机演示），这些操作可以是删除某件商品、下单某个商品等。如下图所示，整个数据包无 token 校验，说明可能存在 CSRF 漏洞。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DWLIHDHjEYEjdXiajtPNqX67LZz4jmyiaGniasZRqStEys4bnqQNia66JL4tcTeKZlpmia5msgLvexhmA/640?wx_fmt=png)

找到无 token 校验的操作页面之后，就需要使用工具真实判断一下是否存在 CSRF 漏洞了。

*   **Burpsuite 的 CSRF 测试功能**
    

首先推荐 burpsuite 这款工具，它自带了一个 CSRF 漏洞测试模块。在 burpsuite 界面点击右键，选择 “Generate CSRF POC” 功能，burpsuite 会自动生成一个 CSRF 的测试页面：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DWLIHDHjEYEjdXiajtPNqX65co5tRY84UwNFrBBvLLCC9dySibMn9qY9WbibIibDDwQIDde2xAUswB9Q/640?wx_fmt=png)

点击 “Test in browser” 按钮可以得到一个 URL 地址：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DWLIHDHjEYEjdXiajtPNqX6wKCKSzUkylUCerfAcgSYwjlGkRkR7Ldu0ZVAF0U1LVVOEgNlsuu29g/640?wx_fmt=png)

打开这个 url，点击 “Submit request” 按钮即可测试 CSRF 是否成功。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DWLIHDHjEYEjdXiajtPNqX6rKURSUISLR6TYq5wOKjrH4Rf1WC3qBSuQiagrxtlzmyHwZLjwfJHiaKg/640?wx_fmt=png)

*   **CSRFTester 工具的使用**
    

这是一个很老牌的工具了，是 15 年前的工具，由 OWASP 组织出品，可以自动生成各种 payload 进行 CSRF 漏洞测试，非常方便。首先浏览器设置一个代理 127.0.0.1:8008，这个代理是 CSRFTester 自带的，浏览器的所有流量都会经过 CSRFTester 这个工具并记录下来。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DWLIHDHjEYEjdXiajtPNqX6cia7nbqmZayhXBccianUEwZ6BzhLcVj9R8icicDSqjRiad9GSUicTFOD7sGQ/640?wx_fmt=png)

选择一个 payload 类型，比如 iFrame 的，这款工具会自动生成一个 html 文件，将此文件传到自己的服务器上，发给用户进行浏览，就可以进行 CSRF 漏洞验证了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DWLIHDHjEYEjdXiajtPNqX6qfc4CPZoBmop2baLBcem8Bkw8QVtouzLZoYCWu3sC1xQfBIUWOoVIA/640?wx_fmt=png)

*   **Referer 校验绕过**
    

很遗憾，经过上述两款工具的测试，CSRF 均未成功，后来**发现程序对 Referer 请求头做了判断**。接下来就需要判断，程序对 Referer 的校验是否不完善。举个例子，假设目标网站是 http://test.com.cn，攻击者的域名是 http://xxxxxx.com，可以尝试对 Referer 值进行一系列变换，如 http://xxxxxx.com/test.com.cn，http://test.com.cn.xxxxxx.com 等，但是一通测试下来发现，始终没法绕过 Referer 的校验。

最后发现**当 Http 请求没有设置 Referer 头时，CSRF 校验就可以绕过去了**。众所周知，当用户点开攻击者构造的 CSRF 页面时，用户浏览器发起的 http 请求的 Referer 值，一般都会带上攻击者的来源 url 的，那么如何将这个 Referer 置空呢？方法也有很多种，但是靠谱的方法极少。

 **1**  在 test.com.cn 子域名下面找到一个 XSS，在这个 XSS 下构造一个 CSRF 漏洞，这个方法有点牵强，而且本次案例 test.com.cn 下面没有子域名。

 **2**  利用 data: 协议

如果浏览器地址栏是 file:// 协议开头的，则此 HTML 页面向任何 http 站点提交请求的 Referer 值都是空的。可利用的协议有以下几种：ftp://,http://,https://,file://,javascript:,data:。可惜的是，这个方法本地测试成功，实战没成功。

<html>  

<body>

<iframe src="data:text/html;base64,PGZvcm0gbWV0aG9kPXBvc3QgYWN0aW9uPWh0dHA6Ly93d3cuaGV4aWUuY29tL2Q+PGlucHV0IHR5cGU9dGV4dCBuYW1lPSdpZCcgdmFsdWU9JzEyMycvPjwvZm9ybT48c2NyaXB0PmRvY3VtZW50LmZvcm1zWzBdLnN1Ym1pdCgpOzwvc2NyaXB0Pgo">

</body>

</html>

对 base64 进行解密，结果如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DWLIHDHjEYEjdXiajtPNqX6Jlhu3Ijbq7rgkvBQwbmDAx9icDYIhfxdnp3KfvP94fEkTjdc9nZ0m6w/640?wx_fmt=png)

 **3**   添加 <meta> 标签

在 html 页面中添加如下代码：<meta >，经过测试，此方法完美将 Referer 请求头置空。最终实战测试成功。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DWLIHDHjEYEjdXiajtPNqX67qV2XdSemotlkWfGTYlJFWMkSiaqjPKN1ZQNATQVt74Ficx4WlAOOcbg/640?wx_fmt=png)

 **Part3 修补 CSRF 漏洞的方法** 

 **1**  **重要操作添加验证码**

对重要的业务操作，可以加上验证码或者手机验证码二次认证，可以有效地阻止 CSRF 漏洞攻击。这样即使用户浏览器了攻击者发来的 CSRF 链接，也会因为验证码不正确导致攻击过程停止。

 **2**  **添加 Origin、Referer 头校验**

服务端会对 Referer、Origin 头信息进行校验，判断是否从信任域跳转过来的。这两个消息头的区别就是，Origin 不包含 URL 路径信息，Referer 请求头会把 URL 的完整路径暴露给第三方网站。因此，服务器的策略是优先判断 Origin，如果请求头中没有包含 Origin 属性，再根据实际情况判断是否使用 Referer 值。

 **3**  **CSRF 的 token 校验**

服务端会返回一个 token 放在前面页面上，用户点击网页，浏览器会带上前端页面中的 CSRF Token，然后服务器会验证该 Token 是否合法。如果是从攻击者伪造的站点或者第三方站点发出的请求，那么将无法获取到 前端页面的 CSRF Token 的值，所以即使发出了请求，服务器也会因为 CSRF Token 不正确而拒绝请求。

 **4**  **在 http 请求属性中 token 校验**

这里不是把 CSRF token 放在 GET 请求或者 POST 请求中，而是放在事先定义好的 http 消息头当中。这样一来，假设用户浏览了攻击者构造好的 CSRF 页面，由于浏览器不会带上 http 消息头的 CSRF Token 值，导致服务端校验不通过，攻击失败。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于网络安全技术分享，包括红队、蓝队、日常渗透测试、安全体系建设等

每周一篇，99% 原创，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)

**往期精彩回顾**

[第 26 篇：蓝队分析辅助工具箱 V0.3 发布，含 shiro 解密 | cas 解密 | log4j2 解密 | 冰蝎哥斯拉解密 | 端口连接分析等功能](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484503&idx=1&sn=43fb260c2c27f2bc00dc73a8515202ea&chksm=c25fcb2cf528423a04ef1f868943c9a74be6bbad1671a59b12cc8efe9b45e227444d904cba97&scene=21#wechat_redirect)**[](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484503&idx=1&sn=43fb260c2c27f2bc00dc73a8515202ea&chksm=c25fcb2cf528423a04ef1f868943c9a74be6bbad1671a59b12cc8efe9b45e227444d904cba97&scene=21#wechat_redirect)  
**

[第 25 篇：冰蝎 2.x 过流量检测改造的全过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484491&idx=1&sn=6aa2dbe16bf745ed403a4aa6f703d6c3&chksm=c25fcb30f5284226c08231d8cfb9878330638d366cc4971e5feb903f89eab49477260ec79466&scene=21#wechat_redirect)  

[第 24 篇：记 2011 年实战外网 ARP 欺骗拿权限的过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484450&idx=1&sn=fc220f515985f2ba0b9dc4b2bb3bbdb0&chksm=c25fcb59f528424f4cc1cbfbc899f55c164e068cb9c8d071a752c966050608c5a51071706de6&scene=21#wechat_redirect)  

[第 23 篇：XSS 绕过防护盲打某 SRC 官网后台](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484434&idx=1&sn=3d4d9da4b098e41b9aec7687822d2f6e&chksm=c25fcb69f528427f7f73aa9cdcaf7a333608bd99cf4cc0e9682ef02b7596767ca8b18de7c155&scene=21#wechat_redirect)  

[第 22 篇：一次艰难的 PostgreSQL 不出网提权过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484407&idx=1&sn=3cedc709c508c5994a141dc395c46090&chksm=c25fcc8cf528459ab1f11e8ab08723811bf9a1c8f4f223678efbd4ff35cccb78b11dd990296d&scene=21#wechat_redirect)

[第 21 篇：判断 Weblogic 详细版本号的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484386&idx=1&sn=9104bd3fad09c607c0ce4b02e483957d&chksm=c25fcc99f528458f8f29d93f9fb7c961255bb64351061e0d6b0eb0c3fc08f2b660e53d45459d&scene=21#wechat_redirect)  

[第 20 篇：改造冰蝎客户端适配 JNDIExploit 的内存马](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484370&idx=1&sn=41144e2b24cf223753b1f631b7a7269b&chksm=c25fcca9f52845bfec4aceb55bbc2e35b95605873193a0a499b9505957039619598ae458b045&scene=21#wechat_redirect)

[第 19 篇：关于近期 cs 服务端被反打的原因分析](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484349&idx=1&sn=c23223a0348336daae18acc4a4790bb8&chksm=c25fccc6f52845d03b30faae72d252256434197d1267d713e60b85810f734368f0be61e62a06&scene=21#wechat_redirect)

[第 18 篇：fastjson 反序列化漏洞区分版本号的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484332&idx=1&sn=c787dd0985156d856aad03d56a945be4&chksm=c25fccd7f52845c1e172b864dfc219dcecc9f226fb5abc64ef31178914ad9f58b7868bf6917a&scene=21#wechat_redirect)

[第 17 篇：Shiro 反序列化在 Weblogic 下无利用链的拿权限方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484319&idx=1&sn=9da36674830837aa9bcacb3fb6268fd1&chksm=c25fcce4f52845f2ac3cebaf17fd3839fdba74f536ad3da20d1b1126d8ba0e1835853990516c&scene=21#wechat_redirect)

[第 16 篇：Weblogic 2019-2729 反序列化漏洞绕防护拿权限的实战过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484303&idx=1&sn=58cbb4d7f63b9276bb89eeac286d174c&chksm=c25fccf4f52845e241256c2f425003b73b6061b3d1964dcd4a184a2cda1b4d8761098227e6de&scene=21#wechat_redirect)

[第 15 篇：内网横向中 windows 各端口远程登录哈希传递的方法总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484255&idx=1&sn=e233aa07fdf9de0c8a1bf56fb0954766&chksm=c25fcc24f5284532c5aa27c002d15aa6380c456e2a84299c77b8d43a41892517087258bf867d&scene=21#wechat_redirect)

[第 14 篇：Struts2 框架下 Log4j2 漏洞检测方法分析与总结](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484207&idx=1&sn=285b54a79e48db9a05816cab2e6afc27&chksm=c25fcc54f5284542c1b9abe870e0caa9f958f4da90723bd83292deed215c63c705b7b0bbfaff&scene=21#wechat_redirect)  

[第 13 篇：coldfusion 反序列化过 waf 改 exp 拿靶标的艰难过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484191&idx=1&sn=cce12f62b3cf457bc73753b77a083695&chksm=c25fcc64f528457250b11ef6804ee6138c37ed87ab988874cc84d09d04fa6ac1fd36b5e8aa4a&scene=21#wechat_redirect)  

[第 12 篇：给任意 java 程序挂 Socks5 代理方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484173&idx=1&sn=e2d454d2447d119bf771a0a511fba994&chksm=c25fcc76f5284560d00355590da0147aca7b7ae2275c095424034245ef32b3d0b28e49c2dbc9&scene=21#wechat_redirect)  

[第 11 篇：盲猜包体对上传漏洞的艰难利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484162&idx=1&sn=870596fcd1120a6d3ee9688c38aace00&chksm=c25fcc79f528456f9dc0a3b9d9cf54422696a1cd6ffd737ae2c6e33941a25c33d4f6d32fc663&scene=21#wechat_redirect)  

[第 10 篇：IIS 短文件名猜解在拿权限中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484145&idx=1&sn=7635430b9b759a2cacdd2c57ba330833&chksm=c25fcd8af528449c1f5c6c703e3668cf6a8dae875ee82ffa67caed66722a0751e3d80d8a6bee&scene=21#wechat_redirect)  

[第 9 篇：Shiro 反序列化数据包解密及蓝队分析工具，提供下载](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484123&idx=1&sn=cb9c039ef92311e56e7742c7c38f6e8a&chksm=c25fcda0f52844b6088b39b769a63b2f6e7a29e8b3ab710961918218d7569089ee4e00072ad9&scene=21#wechat_redirect)  

[第 8 篇：Oracle 注入漏洞绕 waf 的新语句](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484115&idx=1&sn=10c73343ec23f522696692293cd38852&chksm=c25fcda8f52844be2165aa6151c7ad018a4add748673d56523631529e903277633dc44d0abba&scene=21#wechat_redirect)  

[第 7 篇：MS12-020 蓝屏漏洞在实战中的巧用](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484105&idx=1&sn=3aeafa9c172588aaaade47ccacb69370&chksm=c25fcdb2f52844a4a783fceec590c9e12eb06f62dabd7fbffb37e8da23053953a7eae296048d&scene=21#wechat_redirect)  

[第 6 篇：Weblogic 反序列化攻击不依赖日志溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484094&idx=1&sn=527236759dc4fd228461195197492507&chksm=c25fcdc5f52844d36bffb96979116d6d3a9ae4fb1a0f320436c7275aea271588c702cea60e5c&scene=21#wechat_redirect)  

[第 5 篇：Shiro Padding Oracle 无 key 的艰难实战利用过程](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484091&idx=1&sn=4dcce59a842f17035d0018bf650671ae&chksm=c25fcdc0f52844d608b6b87d85082b74d5e15888e76001127ff40cc407a46e5e5de446b1365e&scene=21#wechat_redirect)  

[第 4 篇：jsp 型 webshell 被删情况下如何溯源攻击时间](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247484004&idx=1&sn=50013b50e48542d156700d76ccbd2f33&chksm=c25fcd1ff528440906bb9089a807c16b747ab5a72cc0279a3c0d18a265cd76cc796df570d594&scene=21#wechat_redirect)  

[第 3 篇：银行 Java 站 SSRF"组合洞" 打法造成的严重危害](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483984&idx=1&sn=1a018fcefe10124c1726e51a2be05ca7&chksm=c25fcd2bf528443d944a8495ca5c72d8c028fef67de217efe47a8d18b077ae24556842687407&scene=21#wechat_redirect)  

[第 2 篇：区分 Spring 与 Struts2 框架的几种新方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483951&idx=1&sn=fbc1d04ef73a449238a5979a439b1f35&chksm=c25fcd54f528444219f20c2ab14c5970c243fbb10ba04b5bccc0fb0b7cc6d3f542e26f7870bf&scene=21#wechat_redirect)  

[第 1 篇：weblogic9.x 在 JDK1.5 下 T3 反序列化漏洞利用方法](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247483867&idx=1&sn=e0fcaa9f1b58c8085ccd9dc6f74ed336&chksm=c25fcea0f52847b6aeec0409e3290e023b890d603361f103315b39637f89a10dd6fe051dc724&scene=21#wechat_redirect)