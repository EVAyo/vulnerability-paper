<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247540338&idx=1&sn=816e95b1057fa778f13a0993a02dc8a8&chksm=9ae11f4aad96965c0d0e97bbd283233c45cdd3311ad641481ce0de462046ed1ff7e84a8c8200&mpshare=1&scene=1&srcid=0116CZ4P8tKVACKMGSStwLEp&sharer_shareinfo=4ee00fd93df57e6d70b7effa5206a308&sharer_shareinfo_first=4ee00fd93df57e6d70b7effa5206a308#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

  

**简 介**

本文介绍了一种通过进程注入实现强制关闭部分杀软进程的方法（文中以某安全卫士和某杀毒软件为例），实现过程使用了 thread-hijacking 等技术。  

  

  

**研究初衷**

最近看到一些师傅分享的关于致盲 EDR 或使杀软失效的文章，从中学习到很多。想起去年在复现网上公开的免杀思路时，偶然发现的一种可以强制终结部分杀软进程的方法，此方法无需驱动程序，仅需管理员权限即可，近几天抽时间对方法进行了一些优化，然后通过文章和开放源代码的方式，分享给大家。方法公布以后肯定会随之失效，但希望笔者的研究过程对大家有所启发。

文中相关代码已开源在笔者的 Github（见下文网址），以防大家没有安装 Visual Studio，编译好的 EXE 也一并分享了。

```
项目开源地址：
https://github.com/1y0n/AVKiller

```

研究始于一次 dump 系统密码的学习，大概原理就是将自己编写的 dll 注入到 lsass 进程中，让其 dump 自己的内存，复现过程很顺利。但是复现完成后，笔者突然萌生了一个想法，如果注入的 dll 不是 dump 内存，而是执行 shellcode 或者进行一些其他操作，会怎么样呢？

  

**思路验证**

思路明确，代码编写也非常简单，因为要注入 DLL 到 lsass 进程中，所以我们需要编写两块代码，一个是注入器，一个是 DLL。注入器的作用是将 DLL 注入到 lsass 进程中，DLL 的作用是结束杀软相关的进程。

笔者使用的语言是 C++，但是同样的思路可以很方便地用其他语言实现，IDE 是 Visual Studio 2022，全部默认配置。建议读者在复现时使用 VS 2019 及以上版本。本文以某安全卫士和某杀毒软件为例，但是经过测试同样的方法也可以终结部分其他杀软如某擎等。

注入器的话，在网上能搜到一大堆开源的代码，所以直接 Ctrl C + V 大法，核心功能代码如下（当然，后续我们会发现没有这么简单，这里先用简单的代码做测试）：

<table><tbody><tr><td width="557" valign="top"><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJ5Tosibow1oQMdbSquWhpZSslJbHO5HeS60o9Hhb88fXSQhCibcdBaf0W0B85lcGiaNK4OMp4eNRUpg/640?wx_fmt=png&amp;from=appmsg" style="width: auto;"></p></td></tr></tbody></table>

代码很好懂，所以没写注释，这里简单说下流程：

```
获取debug权限
获取lsass的进程句柄
在lsass进程中申请内存
将我们的DLL写入到这个内存中并执行

```

接下来是 DLL 代码，结束进程的 API 是 TerminateProcess()，所以只需要调用此 API 结束掉某软件相关的几个进程即可（因仅做示范，并无针对该软件之意，此处以 XXX 代替）：

```
XXXrp.exe
XXXrps.exe
XXXsd.exe
XXXtray.exe
ZXXDXXFXXYX.exe

```

在测试中，笔者发现即使终结掉了这些进程，它们也会在一段时间后自动重启。我们加个死循环，这样无论自动重启还是手动重启都不用担心了。简单修改后，DLL 的核心代码如下：

<table><tbody><tr><td width="557" valign="top"><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJ5Tosibow1oQMdbSquWhpZS9usvUGDXQ0iaSefAd6H9Z3iaC3ecFwiaLibHBrpm3Z9jvic6tEmoNwxolqg/640?wx_fmt=png&amp;from=appmsg"></p></td></tr></tbody></table>

编译 EXE 和 DLL 文件，准备开始测试。

**注意！**

此方法可能导致操作系统无法正常关机重启，只能强制断电，且在电脑重启前，某安全卫士无法再次运行，谨慎使用自己的电脑测试。

该软件设置为关闭自动上传可疑样本（作用不大，懂的都懂），启用自我保护，启用核晶，其他保持默认：

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJ5Tosibow1oQMdbSquWhpZSmxGtQTq2U6pLEzfe6ibEuLVzD7paMgaU8Ru1L89Uc63vH8Vg7G5jb9Q/640?wx_fmt=png&from=appmsg)

可以看到相关进程目前是正常运行的状态：

<table><tbody><tr><td width="557" valign="top"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJ5Tosibow1oQMdbSquWhpZSQmr6I9lyK37k1icUL1rPibQ5uMciaeia5BEiab3OxUibg2bFIVm3zwJgZ45Q/640?wx_fmt=png&amp;from=appmsg"></td></tr></tbody></table>

使用管理员权限启动 cmd，运行注入程序，等待几秒，除了 ZXXDXXFXXYX.exe，其他几个进程都被关闭，虽然 ZXXDXXFXXYX 进程还运行着，但是测试发现不会再起到防护作用：

<table><tbody><tr><td width="557" valign="top"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJ5Tosibow1oQMdbSquWhpZSqsBeYBECCfyuvExz0Hdon09KGD68ZyZX92j6LAdXYdK3Eicc6AnkiaXg/640?wx_fmt=png&amp;from=appmsg" style="width: auto;"></td></tr></tbody></table>

此时，执行任何敏感操作都不会再受限制：

<table><tbody><tr><td width="557" valign="top"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJ5Tosibow1oQMdbSquWhpZSuWJ27cZSSsWCHtPmD6vRKPiaX2CT1kiaev4Iv6GBuTeNR7faiasiam2L2g/640?wx_fmt=png&amp;from=appmsg" style="width: auto;"></td></tr></tbody></table>

这证明我们的思路没有问题的，现在还有两个细节问题需要解决：

1. 此方法需要两个文件，一个 DLL，一个 EXE，稍显臃肿，最好改成单文件的形式；

2. 注入 lsass 进程时，安全卫士会检测到注入行为，并且弹出拦截提示。

接下来让我们分别解决这两个问题。

  

**首先是注入拦截的问题。**

推测该安全卫士 HOOK 了 NtCreateRemoteThreadEx 之类的 API，不过我们有特殊的注入姿势，对代码做一下修改，成功完成注入。

<table><tbody><tr><td width="557" valign="top"><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zJ5Tosibow1oQMdbSquWhpZSgYGcbeZPcHibKJOIcVTXVhGiaE8JLUrFCQ15AdmAfArZomgUlrxuVPdQ/640?wx_fmt=png&amp;from=appmsg" style="width: auto;"></p></td></tr></tbody></table>

**接下来是第二个问题——单文件。**

有两个思路可以实现单文件，一个是将 EXE 和 DLL 打包在一起，EXE 运行时将 DLL 释放到硬盘中，然后从硬盘中加载；另一个思路是将 DLL 转换成 shellcode，将 shellcode 注入到进程，DLL 不落地。

笔者这里选择将 DLL 转换成 shellcode，DLL 转 shellcode 可以使用 @hasherezade 的 pe_to_shellcode 工具，也可以使用 @TheWover 的 donut 工具，两个工具都可以在 Github 搜到，用法不再赘述。

DLL 转换完成后，编写代码将 shellcode 注入到 lsass 进程中，这个过程与平常制作的 shellcode loader 一模一样，所以代码只改动几行就可以。具体代码已在 Github 开源，就不再截图了。

  

**修复建议**

1. 建议 HOOK 以下 API：

 - NtCreateRemoteThreadEx

 - NtSuspendThread

 - NtResumeThread

 - NtQueueApcThreadEx

 - TerminateProcess

2. 从驱动层面保护自身进程，阻止来自 lsass.exe 对进程的访问和操作。

3. 除 NtCreateRemoteThreadEx 外，建议同时拦截 NtSuspendThread 和 NtResumeThread。

* * *

**往期回顾**

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLZcoKMJ3N2zOXQ16pyHsIaMKKicIcbvTqHeHNuvZPjk3yEvU4w9saOZxmYAnYbpKAyibezdUZXzdeA/640?wx_fmt=jpeg&from=appmsg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247540231&idx=1&sn=d8086e021a2ada7bb0e9e8023c8564fa&chksm=9ae11f3fad9696292787dcb2ac9703595915392a41aeada88512960085802cba1021f5b83085&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLQYcKTYmj0kcMluXI3ibxh0wiaW6AMfFu7PntU8KYNsEQcuFuEA1QzKeWHRDibNhPibibXnqslNKNlnwA/640?wx_fmt=jpeg&from=appmsg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247540196&idx=1&sn=67a0ccac436a1c6bfe96956192b2037b&chksm=9ae11cdcad9695ca798bebeb0ab91d6842d591ab73c6ad64a29b622ca0ca12b1e044463bfc25&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKVB50N4cjEzibJPjvc0gIYCY6W3yu05xgh2d26JEjWcFAVekYqrYfTYib7IjZsGDHN0yBic6IyiavM0A/640?wx_fmt=jpeg&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247539894&idx=1&sn=7715898a00176f861d005f503cf8efb1&chksm=9ae11d8ead9694986ee9dff792bdce831a6f8fdd092fb72d057967d3f9012bdfaa91ffc4904d&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLoETGZobhTo3FjYzLWbHaLtcYfXaeNBSLN83jCKR7AzxY9qjBpHKIwg1weJNGyt3n2iay5wD1nWkg/640?wx_fmt=jpeg&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247539457&idx=1&sn=68d05d625840d8689e5b60ca666909d3&chksm=9ae11a39ad96932f697c69d880fe024456da19689aa874b6c12d9f7d247beba24d5e98b4f16f&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIDT0MMVb2hD0Rz7ibKZAb9Qc5ibO7W0E9yOG8CUhnwzVN0YP8QFemOf2bA3DVsoxKZlHib03GN7CRsw/640?wx_fmt=jpeg&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247539446&idx=1&sn=d48318ec8d4c3e1d3f2c157527bef21f&chksm=9ae11bcead9692d8668051b5f438b782b6e9ce5e5eb426878771e9869267e32807e4081a56ef&scene=21#wechat_redirect)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/Ljib4So7yuWjVsaTygX5CCGxuYZaPeibrpfOOGAjXfTkTp3AIPeXv08iayGTH94Xcmvk4RJxs9NNSc2vzCoCiaXOSQ/640?wx_fmt=jpeg&wx_co=1&wxfrom=5&wx_lazy=1)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL31gt4m6YIRLh7wJeOSwYPOIblCvhN6OgHhV9NMJNH0TBianlpMmRbaKG1ia7iaPsWb4UX4ImgfEJ0A/640?wx_fmt=jpeg&wx_co=1&wxfrom=5&wx_lazy=1)

![图片](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)